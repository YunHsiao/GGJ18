var cc=function(){"use strict";var e=9728;var t=9729;var n=9984;var r=9985;var i=9986;var a=9987;var s=5121;var o=5123;var l=5125;var u=5126;var f=33635;var h=32819;var c=32820;var p=36193;var d=6402;var m=6406;var _=6407;var v=6408;var g=6409;var y=6410;var b=33776;var x=33777;var T=33778;var S=33779;var E=35840;var w=35841;var M=35842;var A=35843;var R=36196;var U=[[e,n,i],[t,r,a]];var D=[{format:_,internalFormat:b,pixelType:null},{format:v,internalFormat:x,pixelType:null},{format:v,internalFormat:T,pixelType:null},{format:v,internalFormat:S,pixelType:null},{format:_,internalFormat:R,pixelType:null},{format:_,internalFormat:w,pixelType:null},{format:v,internalFormat:A,pixelType:null},{format:_,internalFormat:E,pixelType:null},{format:v,internalFormat:M,pixelType:null},{format:m,internalFormat:m,pixelType:s},{format:g,internalFormat:g,pixelType:s},{format:y,internalFormat:y,pixelType:s},{format:_,internalFormat:_,pixelType:f},{format:v,internalFormat:v,pixelType:c},{format:v,internalFormat:v,pixelType:h},{format:_,internalFormat:_,pixelType:s},{format:v,internalFormat:v,pixelType:s},{format:_,internalFormat:_,pixelType:p},{format:v,internalFormat:v,pixelType:p},{format:_,internalFormat:_,pixelType:u},{format:v,internalFormat:v,pixelType:u},{format:null,internalFormat:null,pixelType:null},{format:null,internalFormat:null,pixelType:null},{format:null,internalFormat:null,pixelType:null},{format:null,internalFormat:null,pixelType:null},{format:d,internalFormat:d,pixelType:o},{format:d,internalFormat:d,pixelType:l},{format:null,internalFormat:null,pixelType:null}];var L={USAGE_STATIC:35044,USAGE_DYNAMIC:35048,USAGE_STREAM:35040,INDEX_FMT_UINT8:5121,INDEX_FMT_UINT16:5123,INDEX_FMT_UINT32:5125,ATTR_POSITION:"a_position",ATTR_NORMAL:"a_normal",ATTR_TANGENT:"a_tangent",ATTR_BITANGENT:"a_bitangent",ATTR_WEIGHTS:"a_weights",ATTR_JOINTS:"a_joints",ATTR_COLOR:"a_color",ATTR_COLOR0:"a_color0",ATTR_COLOR1:"a_color1",ATTR_UV:"a_uv",ATTR_UV0:"a_uv0",ATTR_UV1:"a_uv1",ATTR_UV2:"a_uv2",ATTR_UV3:"a_uv3",ATTR_UV4:"a_uv4",ATTR_UV5:"a_uv5",ATTR_UV6:"a_uv6",ATTR_UV7:"a_uv7",ATTR_TYPE_INT8:5120,ATTR_TYPE_UINT8:5121,ATTR_TYPE_INT16:5122,ATTR_TYPE_UINT16:5123,ATTR_TYPE_INT32:5124,ATTR_TYPE_UINT32:5125,ATTR_TYPE_FLOAT32:5126,FILTER_NEAREST:0,FILTER_LINEAR:1,WRAP_REPEAT:10497,WRAP_CLAMP:33071,WRAP_MIRROR:33648,TEXTURE_FMT_RGB_DXT1:0,TEXTURE_FMT_RGBA_DXT1:1,TEXTURE_FMT_RGBA_DXT3:2,TEXTURE_FMT_RGBA_DXT5:3,TEXTURE_FMT_RGB_ETC1:4,TEXTURE_FMT_RGB_PVRTC_2BPPV1:5,TEXTURE_FMT_RGBA_PVRTC_2BPPV1:6,TEXTURE_FMT_RGB_PVRTC_4BPPV1:7,TEXTURE_FMT_RGBA_PVRTC_4BPPV1:8,TEXTURE_FMT_A8:9,TEXTURE_FMT_L8:10,TEXTURE_FMT_L8_A8:11,TEXTURE_FMT_R5_G6_B5:12,TEXTURE_FMT_R5_G5_B5_A1:13,TEXTURE_FMT_R4_G4_B4_A4:14,TEXTURE_FMT_RGB8:15,TEXTURE_FMT_RGBA8:16,TEXTURE_FMT_RGB16F:17,TEXTURE_FMT_RGBA16F:18,TEXTURE_FMT_RGB32F:19,TEXTURE_FMT_RGBA32F:20,TEXTURE_FMT_R32F:21,TEXTURE_FMT_111110F:22,TEXTURE_FMT_SRGB:23,TEXTURE_FMT_SRGBA:24,TEXTURE_FMT_D16:25,TEXTURE_FMT_D32:26,TEXTURE_FMT_D24S8:27,DS_FUNC_NEVER:512,DS_FUNC_LESS:513,DS_FUNC_EQUAL:514,DS_FUNC_LEQUAL:515,DS_FUNC_GREATER:516,DS_FUNC_NOTEQUAL:517,DS_FUNC_GEQUAL:518,DS_FUNC_ALWAYS:519,RB_FMT_RGBA4:32854,RB_FMT_RGB5_A1:32855,RB_FMT_RGB565:36194,RB_FMT_D16:33189,RB_FMT_S8:36168,RB_FMT_D24S8:34041,BLEND_FUNC_ADD:32774,BLEND_FUNC_SUBTRACT:32778,BLEND_FUNC_REVERSE_SUBTRACT:32779,BLEND_ZERO:0,BLEND_ONE:1,BLEND_SRC_COLOR:768,BLEND_ONE_MINUS_SRC_COLOR:769,BLEND_DST_COLOR:774,BLEND_ONE_MINUS_DST_COLOR:775,BLEND_SRC_ALPHA:770,BLEND_ONE_MINUS_SRC_ALPHA:771,BLEND_DST_ALPHA:772,BLEND_ONE_MINUS_DST_ALPHA:773,BLEND_CONSTANT_COLOR:32769,BLEND_ONE_MINUS_CONSTANT_COLOR:32770,BLEND_CONSTANT_ALPHA:32771,BLEND_ONE_MINUS_CONSTANT_ALPHA:32772,BLEND_SRC_ALPHA_SATURATE:776,STENCIL_OP_KEEP:7680,STENCIL_OP_ZERO:0,STENCIL_OP_REPLACE:7681,STENCIL_OP_INCR:7682,STENCIL_OP_INCR_WRAP:34055,STENCIL_OP_DECR:7683,STENCIL_OP_DECR_WRAP:34056,STENCIL_OP_INVERT:5386,CULL_NONE:0,CULL_FRONT:1028,CULL_BACK:1029,CULL_FRONT_AND_BACK:1032,PT_POINTS:0,PT_LINES:1,PT_LINE_LOOP:2,PT_LINE_STRIP:3,PT_TRIANGLES:4,PT_TRIANGLE_STRIP:5,PT_TRIANGLE_FAN:6};function O(e){if(e===L.ATTR_TYPE_INT8){return 1}else if(e===L.ATTR_TYPE_UINT8){return 1}else if(e===L.ATTR_TYPE_INT16){return 2}else if(e===L.ATTR_TYPE_UINT16){return 2}else if(e===L.ATTR_TYPE_INT32){return 4}else if(e===L.ATTR_TYPE_UINT32){return 4}else if(e===L.ATTR_TYPE_FLOAT32){return 4}console.warn("Unknown ATTR_TYPE: "+e);return 0}function I(e,t,n){if(n===void 0)n=-1;var r=U[t][n+1];if(r===undefined){console.warn("Unknown FILTER: "+t);return n===-1?e.LINEAR:e.LINEAR_MIPMAP_LINEAR}return r}function C(e){var t=D[e];if(t===undefined){console.warn("Unknown TEXTURE_FMT: "+e);return D[L.TEXTURE_FMT_RGBA8]}return t}var P=function e(t){var n=this;this._attr2el={};this._elements=[];this._bytes=0;var r=0;for(var i=0,a=t.length;i<a;++i){var s=t[i];var o={name:s.name,offset:r,stride:0,stream:-1,type:s.type,num:s.num,normalize:s.normalize===undefined?false:s.normalize,bytes:s.num*O(s.type)};n._attr2el[o.name]=o;n._elements.push(o);n._bytes+=o.bytes;r+=o.bytes}for(var l=0,u=this._elements.length;l<u;++l){var f=n._elements[l];f.stride=n._bytes}};P.prototype.element=function e(t){return this._attr2el[t]};var B=function e(t,n,r,i,a){this._device=t;this._format=n;this._usage=r;this._numIndices=a;this._bytesPerIndex=0;if(n===L.INDEX_FMT_UINT8){this._bytesPerIndex=1}else if(n===L.INDEX_FMT_UINT16){this._bytesPerIndex=2}else if(n===L.INDEX_FMT_UINT32){this._bytesPerIndex=4}this._bytes=this._bytesPerIndex*a;this._glID=t._gl.createBuffer();this.update(0,i);t._stats.ib+=this._bytes};var F={count:{configurable:true}};B.prototype.destroy=function e(){if(this._glID===-1){console.error("The buffer already destroyed");return}var t=this._device._gl;t.deleteBuffer(this._glID);this._device._stats.ib-=this.bytes;this._glID=-1};B.prototype.update=function e(t,n){if(this._glID===-1){console.error("The buffer is destroyed");return}if(n&&n.byteLength+t>this._bytes){console.error("Failed to update data, bytes exceed.");return}var r=this._device._gl;var i=this._usage;r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,this._glID);if(!n){if(this._bytes){r.bufferData(r.ELEMENT_ARRAY_BUFFER,this._bytes,i)}else{console.warn("bufferData should not submit 0 bytes data")}}else{if(t){r.bufferSubData(r.ELEMENT_ARRAY_BUFFER,t,n)}else{r.bufferData(r.ELEMENT_ARRAY_BUFFER,n,i)}}this._device._restoreIndexBuffer()};F.count.get=function(){return this._numIndices};Object.defineProperties(B.prototype,F);var z=function e(t,n,r,i,a){this._device=t;this._format=n;this._usage=r;this._numVertices=a;this._bytes=this._format._bytes*a;this._glID=t._gl.createBuffer();this.update(0,i);t._stats.vb+=this._bytes};var k={count:{configurable:true}};z.prototype.destroy=function e(){if(this._glID===-1){console.error("The buffer already destroyed");return}var t=this._device._gl;t.deleteBuffer(this._glID);this._device._stats.vb-=this.bytes;this._glID=-1};z.prototype.update=function e(t,n){if(this._glID===-1){console.error("The buffer is destroyed");return}if(n&&n.byteLength+t>this._bytes){console.error("Failed to update data, bytes exceed.");return}var r=this._device._gl;var i=this._usage;r.bindBuffer(r.ARRAY_BUFFER,this._glID);if(!n){if(this._bytes){r.bufferData(r.ARRAY_BUFFER,this._bytes,i)}else{console.warn("bufferData should not submit 0 bytes data")}}else{if(t){r.bufferSubData(r.ARRAY_BUFFER,t,n)}else{r.bufferData(r.ARRAY_BUFFER,n,i)}}r.bindBuffer(r.ARRAY_BUFFER,null)};k.count.get=function(){return this._numVertices};Object.defineProperties(z.prototype,k);var N=0;function G(e,t,n){n.split("\n").forEach(function(n){if(n.length<5){return}var r=/^ERROR\:\s+(\d+)\:(\d+)\:\s*(.*)$/.exec(n);if(r){e.push({type:t,fileID:r[1]|0,line:r[2]|0,message:r[3].trim()})}else if(n.length>0){e.push({type:t,fileID:-1,line:0,message:n})}})}var V=function e(t,n){this._device=t;this._attributes=[];this._uniforms=[];this._samplers=[];this._errors=[];this._linked=false;this._vertSource=n.vert;this._fragSource=n.frag;this._glID=null;this._id=N++};var H={id:{configurable:true}};H.id.get=function(){return this._id};V.prototype.link=function e(){var t=this;if(this._linked){return}var n=this._device._gl;var r=W(n,n.VERTEX_SHADER,this._vertSource);var i=W(n,n.FRAGMENT_SHADER,this._fragSource);var a=n.createProgram();n.attachShader(a,r);n.attachShader(a,i);n.linkProgram(a);var s=false;var o=this._errors;if(!n.getShaderParameter(r,n.COMPILE_STATUS)){G(o,"vs",n.getShaderInfoLog(r));s=true}if(!n.getShaderParameter(i,n.COMPILE_STATUS)){G(o,"fs",n.getShaderInfoLog(i));s=true}n.deleteShader(r);n.deleteShader(i);if(s){o.forEach(function(e){console.error("Failed to compile "+e.type+" "+e.fileID+" (ln "+e.line+"): "+e.message)});return}if(!n.getProgramParameter(a,n.LINK_STATUS)){console.error("Failed to link shader program: "+n.getProgramInfoLog(a));s=true}if(s){return}this._glID=a;var l=n.getProgramParameter(a,n.ACTIVE_ATTRIBUTES);for(var u=0;u<l;++u){var f=n.getActiveAttrib(a,u);var h=n.getAttribLocation(a,f.name);t._attributes.push({name:f.name,location:h,type:f.type})}var c=n.getProgramParameter(a,n.ACTIVE_UNIFORMS);for(var p=0;p<c;++p){var d=n.getActiveUniform(a,p);var m=d.name;var _=n.getUniformLocation(a,m);var v=m.substr(m.length-3)==="[0]";if(v){m=m.substr(0,m.length-3)}t._uniforms.push({name:m,location:_,type:d.type,size:v?d.size:undefined})}this._linked=true};V.prototype.destroy=function e(){var t=this._device._gl;t.deleteProgram(this._glID);this._linked=false;this._glID=null;this._attributes=[];this._uniforms=[];this._samplers=[]};Object.defineProperties(V.prototype,H);function W(e,t,n){var r=e.createShader(t);e.shaderSource(r,n);e.compileShader(r);return r}var X=function e(t){this._device=t;this._width=4;this._height=4;this._hasMipmap=false;this._compressed=false;this._anisotropy=1;this._minFilter=L.FILTER_LINEAR;this._magFilter=L.FILTER_LINEAR;this._mipFilter=L.FILTER_LINEAR;this._wrapS=L.WRAP_REPEAT;this._wrapT=L.WRAP_REPEAT;this._format=L.TEXTURE_FMT_RGBA8;this._target=-1};X.prototype.destroy=function e(){if(this._glID===-1){console.error("The texture already destroyed");return}var t=this._device._gl;t.deleteTexture(this._glID);this._device._stats.tex-=this.bytes;this._glID=-1};function j(e){return!(e&e-1)&&!!e}var q=function(e){function t(t,n){e.call(this,t);var r=this._device._gl;this._target=r.TEXTURE_2D;this._glID=r.createTexture();n.images=n.images||[null];this.update(n)}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.update=function e(t){var n=this._device._gl;var r=this._hasMipmap;if(t){if(t.width!==undefined){this._width=t.width}if(t.height!==undefined){this._height=t.height}if(t.anisotropy!==undefined){this._anisotropy=t.anisotropy}if(t.minFilter!==undefined){this._minFilter=t.minFilter}if(t.magFilter!==undefined){this._magFilter=t.magFilter}if(t.mipFilter!==undefined){this._mipFilter=t.mipFilter}if(t.wrapS!==undefined){this._wrapS=t.wrapS}if(t.wrapT!==undefined){this._wrapT=t.wrapT}if(t.format!==undefined){this._format=t.format;this._compressed=this._format>=L.TEXTURE_FMT_RGB_DXT1&&this._format<=L.TEXTURE_FMT_RGBA_PVRTC_4BPPV1}if(t.mipmap!==undefined){this._hasMipmap=t.mipmap;r=t.mipmap}if(t.images!==undefined){if(t.images.length>1){r=false;var i=t.width>t.height?t.width:t.height;if(i>>t.images.length-1!==1){console.error("texture-2d mipmap is invalid, should have a 1x1 mipmap.")}}}}var a=j(this._width)&&j(this._height);if(!a){r=false}n.activeTexture(n.TEXTURE0);n.bindTexture(n.TEXTURE_2D,this._glID);if(t.images!==undefined&&t.images.length>0){this._setMipmap(t.images,t.flipY,t.premultiplyAlpha)}this._setTexInfo();if(r){n.hint(n.GENERATE_MIPMAP_HINT,n.NICEST);n.generateMipmap(n.TEXTURE_2D)}this._device._restoreTexture(0)};t.prototype.updateSubImage=function e(t){var n=this._device._gl;var r=C(this._format);n.activeTexture(n.TEXTURE0);n.bindTexture(n.TEXTURE_2D,this._glID);this._setSubImage(r,t);this._device._restoreTexture(0)};t.prototype.updateImage=function e(t){var n=this._device._gl;var r=C(this._format);n.activeTexture(n.TEXTURE0);n.bindTexture(n.TEXTURE_2D,this._glID);this._setImage(r,t);this._device._restoreTexture(0)};t.prototype._setSubImage=function e(t,n){var r=this._device._gl;var i=n.flipY;var a=n.premultiplyAlpha;var s=n.image;if(s instanceof HTMLCanvasElement||s instanceof HTMLImageElement||s instanceof HTMLVideoElement){if(i===undefined){r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,true)}else{r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,i)}if(a===undefined){r.pixelStorei(r.UNPACK_PREMULTIPLY_ALPHA_WEBGL,false)}else{r.pixelStorei(r.UNPACK_PREMULTIPLY_ALPHA_WEBGL,a)}r.texSubImage2D(r.TEXTURE_2D,n.level,n.x,n.y,t.format,t.pixelType,s)}else{if(i===undefined){r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,false)}else{r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,i)}if(a===undefined){r.pixelStorei(r.UNPACK_PREMULTIPLY_ALPHA_WEBGL,false)}else{r.pixelStorei(r.UNPACK_PREMULTIPLY_ALPHA_WEBGL,a)}if(this._compressed){r.compressedTexSubImage2D(r.TEXTURE_2D,n.level,n.x,n.y,n.width,n.height,t.format,s)}else{r.texSubImage2D(r.TEXTURE_2D,n.level,n.x,n.y,n.width,n.height,t.format,t.pixelType,s)}}};t.prototype._setImage=function e(t,n){var r=this._device._gl;var i=n.flipY;var a=n.premultiplyAlpha;var s=n.image;if(s instanceof HTMLCanvasElement||s instanceof HTMLImageElement||s instanceof HTMLVideoElement){if(i===undefined){r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,true)}else{r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,i)}if(a===undefined){r.pixelStorei(r.UNPACK_PREMULTIPLY_ALPHA_WEBGL,false)}else{r.pixelStorei(r.UNPACK_PREMULTIPLY_ALPHA_WEBGL,a)}r.texImage2D(r.TEXTURE_2D,n.level,t.internalFormat,t.format,t.pixelType,s)}else{if(i===undefined){r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,false)}else{r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,i)}if(a===undefined){r.pixelStorei(r.UNPACK_PREMULTIPLY_ALPHA_WEBGL,false)}else{r.pixelStorei(r.UNPACK_PREMULTIPLY_ALPHA_WEBGL,a)}if(this._compressed){r.compressedTexImage2D(r.TEXTURE_2D,n.level,t.internalFormat,n.width,n.height,0,s)}else{r.texImage2D(r.TEXTURE_2D,n.level,t.internalFormat,n.width,n.height,0,t.format,t.pixelType,s)}}};t.prototype._setMipmap=function e(t,n,r){var i=this;var a=C(this._format);var s={width:this._width,height:this._height,flipY:n,premultiplyAlpha:r,level:0,image:null};for(var o=0;o<t.length;++o){s.level=o;s.width=i._width>>o;s.height=i._height>>o;s.image=t[o];i._setImage(a,s)}};t.prototype._setTexInfo=function e(){var t=this._device._gl;var n=j(this._width)&&j(this._height);if(!n&&(this._wrapS!==L.WRAP_CLAMP||this._wrapT!==L.WRAP_CLAMP)){console.warn("WebGL1 doesn't support all wrap modes with NPOT textures");this._wrapS=L.WRAP_CLAMP;this._wrapT=L.WRAP_CLAMP}var r=this._hasMipmap?this._mipFilter:-1;if(!n&&r!==-1){console.warn("NPOT textures do not support mipmap filter");r=-1}t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,I(t,this._minFilter,r));t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,I(t,this._magFilter,-1));t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,this._wrapS);t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,this._wrapT);var i=this._device.ext("EXT_texture_filter_anisotropic");if(i){t.texParameteri(t.TEXTURE_2D,i.TEXTURE_MAX_ANISOTROPY_EXT,this._anisotropy)}};return t}(X);var Y=function(e){function t(t,n){e.call(this,t);var r=this._device._gl;this._target=r.TEXTURE_CUBE_MAP;this._glID=r.createTexture();this.update(n)}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.update=function e(t){var n=this._device._gl;var r=this._hasMipmap;if(t){if(t.width!==undefined){this._width=t.width}if(t.height!==undefined){this._height=t.height}if(t.anisotropy!==undefined){this._anisotropy=t.anisotropy}if(t.minFilter!==undefined){this._minFilter=t.minFilter}if(t.magFilter!==undefined){this._magFilter=t.magFilter}if(t.mipFilter!==undefined){this._mipFilter=t.mipFilter}if(t.wrapS!==undefined){this._wrapS=t.wrapS}if(t.wrapT!==undefined){this._wrapT=t.wrapT}if(t.format!==undefined){this._format=t.format;this._compressed=this._format>=L.TEXTURE_FMT_RGB_DXT1&&this._format<=L.TEXTURE_FMT_RGBA_PVRTC_4BPPV1}if(t.mipmap!==undefined){this._hasMipmap=t.mipmap;r=t.mipmap}if(t.images!==undefined){if(t.images.length>1){r=false;if(t.width!==t.height){console.warn("texture-cube width and height should be identical.")}if(t.width>>t.images.length-1!==1){console.error("texture-cube mipmap is invalid. please set mipmap as 1x1, 2x2, 4x4 ... nxn")}}}}var i=j(this._width)&&j(this._height);if(!i){r=false}n.activeTexture(n.TEXTURE0);n.bindTexture(n.TEXTURE_CUBE_MAP,this._glID);if(t.images!==undefined&&t.images.length>0){this._setMipmap(t.images,t.flipY,t.premultiplyAlpha)}this._setTexInfo();if(r){n.hint(n.GENERATE_MIPMAP_HINT,n.NICEST);n.generateMipmap(n.TEXTURE_CUBE_MAP)}this._device._restoreTexture(0)};t.prototype.updateSubImage=function e(t){var n=this._device._gl;var r=C(this._format);n.activeTexture(n.TEXTURE0);n.bindTexture(n.TEXTURE_CUBE_MAP,this._glID);this._setSubImage(r,t);this._device._restoreTexture(0)};t.prototype.updateImage=function e(t){var n=this._device._gl;var r=C(this._format);n.activeTexture(n.TEXTURE0);n.bindTexture(n.TEXTURE_CUBE_MAP,this._glID);this._setImage(r,t);this._device._restoreTexture(0)};t.prototype._setSubImage=function e(t,n){var r=this._device._gl;var i=n.flipY;var a=n.premultiplyAlpha;var s=n.faceIndex;var o=n.image;if(i===undefined){r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,false)}else{r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,i)}if(a===undefined){r.pixelStorei(r.UNPACK_PREMULTIPLY_ALPHA_WEBGL,false)}else{r.pixelStorei(r.UNPACK_PREMULTIPLY_ALPHA_WEBGL,a)}if(o instanceof HTMLCanvasElement||o instanceof HTMLImageElement||o instanceof HTMLVideoElement){r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+s,n.level,n.x,n.y,t.format,t.pixelType,o)}else{if(this._compressed){r.compressedTexSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+s,n.level,n.x,n.y,n.width,n.height,t.format,o)}else{r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+s,n.level,n.x,n.y,n.width,n.height,t.format,t.pixelType,o)}}};t.prototype._setImage=function e(t,n){var r=this._device._gl;var i=n.flipY;var a=n.premultiplyAlpha;var s=n.faceIndex;var o=n.image;if(i===undefined){r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,false)}else{r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,i)}if(a===undefined){r.pixelStorei(r.UNPACK_PREMULTIPLY_ALPHA_WEBGL,false)}else{r.pixelStorei(r.UNPACK_PREMULTIPLY_ALPHA_WEBGL,a)}if(o instanceof HTMLCanvasElement||o instanceof HTMLImageElement||o instanceof HTMLVideoElement){r.texImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+s,n.level,t.internalFormat,t.format,t.pixelType,o)}else{if(this._compressed){r.compressedTexImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+s,n.level,t.internalFormat,n.width,n.height,0,o)}else{r.texImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+s,n.level,t.internalFormat,n.width,n.height,0,t.format,t.pixelType,o)}}};t.prototype._setMipmap=function e(t,n,r){var i=this;var a=C(this._format);var s={width:this._width,height:this._height,faceIndex:0,flipY:n,premultiplyAlpha:r,level:0,image:null};for(var o=0;o<t.length;++o){var l=t[o];s.level=o;s.width=i._width>>o;s.height=i._height>>o;for(var u=0;u<6;++u){s.faceIndex=u;s.image=l[u];i._setImage(a,s)}}};t.prototype._setTexInfo=function e(){var t=this._device._gl;var n=j(this._width)&&j(this._height);if(!n&&(this._wrapS!==L.WRAP_CLAMP||this._wrapT!==L.WRAP_CLAMP)){console.warn("WebGL1 doesn't support all wrap modes with NPOT textures");this._wrapS=L.WRAP_CLAMP;this._wrapT=L.WRAP_CLAMP}var r=this._hasMipmap?this._mipFilter:-1;if(!n&&r!==-1){console.warn("NPOT textures do not support mipmap filter");r=-1}t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_MIN_FILTER,I(t,this._minFilter,r));t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_MAG_FILTER,I(t,this._magFilter,-1));t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_WRAP_S,this._wrapS);t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_WRAP_T,this._wrapT);var i=this._device.ext("EXT_texture_filter_anisotropic");if(i){t.texParameteri(t.TEXTURE_CUBE_MAP,i.TEXTURE_MAX_ANISOTROPY_EXT,this._anisotropy)}};return t}(X);var K=function e(t,n,r,i){this._device=t;this._format=n;this._width=r;this._height=i;var a=t._gl;this._glID=a.createRenderbuffer();a.bindRenderbuffer(a.RENDERBUFFER,this._glID);a.renderbufferStorage(a.RENDERBUFFER,n,r,i);a.bindRenderbuffer(a.RENDERBUFFER,null)};K.prototype.destroy=function e(){if(this._glID===null){console.error("The render-buffer already destroyed");return}var t=this._device._gl;t.bindRenderbuffer(t.RENDERBUFFER,null);t.deleteRenderbuffer(this._glID);this._glID=null};var Z=function e(t,n,r,i){this._device=t;this._width=n;this._height=r;this._colors=i.colors||[];this._depth=i.depth||null;this._stencil=i.stencil||null;this._depthStencil=i.depthStencil||null;this._glID=t._gl.createFramebuffer()};Z.prototype.destroy=function e(){if(this._glID===null){console.error("The frame-buffer already destroyed");return}var t=this._device._gl;t.deleteFramebuffer(this._glID);this._glID=null};var J={blend:false,blendSep:false,blendColor:4294967295,blendEq:L.BLEND_FUNC_ADD,blendAlphaEq:L.BLEND_FUNC_ADD,blendSrc:L.BLEND_ONE,blendDst:L.BLEND_ZERO,blendSrcAlpha:L.BLEND_ONE,blendDstAlpha:L.BLEND_ZERO,depthTest:false,depthWrite:false,depthFunc:L.DS_FUNC_LESS,stencilTest:false,stencilSep:false,stencilFuncFront:L.DS_FUNC_ALWAYS,stencilRefFront:0,stencilMaskFront:255,stencilFailOpFront:L.STENCIL_OP_KEEP,stencilZFailOpFront:L.STENCIL_OP_KEEP,stencilZPassOpFront:L.STENCIL_OP_KEEP,stencilWriteMaskFront:255,stencilFuncBack:L.DS_FUNC_ALWAYS,stencilRefBack:0,stencilMaskBack:255,stencilFailOpBack:L.STENCIL_OP_KEEP,stencilZFailOpBack:L.STENCIL_OP_KEEP,stencilZPassOpBack:L.STENCIL_OP_KEEP,stencilWriteMaskBack:255,cullMode:L.CULL_BACK,primitiveType:L.PT_TRIANGLES,maxStream:-1,vertexBuffers:[],vertexBufferOffsets:[],indexBuffer:null,maxTextureSlot:-1,textureUnits:[],program:null};var Q=function e(t){this.vertexBuffers=new Array(t._caps.maxVertexStreams);this.vertexBufferOffsets=new Array(t._caps.maxVertexStreams);this.textureUnits=new Array(t._caps.maxTextureUnits);this.set(J)};Q.initDefault=function e(t){J.vertexBuffers=new Array(t._caps.maxVertexStreams);J.vertexBufferOffsets=new Array(t._caps.maxVertexStreams);J.textureUnits=new Array(t._caps.maxTextureUnits)};Q.prototype.reset=function e(){this.set(J)};Q.prototype.set=function e(t){var n=this;this.blend=t.blend;this.blendSep=t.blendSep;this.blendColor=t.blendColor;this.blendEq=t.blendEq;this.blendAlphaEq=t.blendAlphaEq;this.blendSrc=t.blendSrc;this.blendDst=t.blendDst;this.blendSrcAlpha=t.blendSrcAlpha;this.blendDstAlpha=t.blendDstAlpha;this.depthTest=t.depthTest;this.depthWrite=t.depthWrite;this.depthFunc=t.depthFunc;this.stencilTest=t.stencilTest;this.stencilSep=t.stencilSep;this.stencilFuncFront=t.stencilFuncFront;this.stencilRefFront=t.stencilRefFront;this.stencilMaskFront=t.stencilMaskFront;this.stencilFailOpFront=t.stencilFailOpFront;this.stencilZFailOpFront=t.stencilZFailOpFront;this.stencilZPassOpFront=t.stencilZPassOpFront;this.stencilWriteMaskFront=t.stencilWriteMaskFront;this.stencilFuncBack=t.stencilFuncBack;this.stencilRefBack=t.stencilRefBack;this.stencilMaskBack=t.stencilMaskBack;this.stencilFailOpBack=t.stencilFailOpBack;this.stencilZFailOpBack=t.stencilZFailOpBack;this.stencilZPassOpBack=t.stencilZPassOpBack;this.stencilWriteMaskBack=t.stencilWriteMaskBack;this.cullMode=t.cullMode;this.primitiveType=t.primitiveType;this.maxStream=t.maxStream;for(var r=0;r<t.vertexBuffers.length;++r){n.vertexBuffers[r]=t.vertexBuffers[r]}for(var i=0;i<t.vertexBufferOffsets.length;++i){n.vertexBufferOffsets[i]=t.vertexBufferOffsets[i]}this.indexBuffer=t.indexBuffer;this.maxTextureSlot=t.maxTextureSlot;for(var a=0;a<t.textureUnits.length;++a){n.textureUnits[a]=t.textureUnits[a]}this.program=t.program};var $=5124;var ee=5126;var te=35664;var ne=35665;var re=35666;var ie=35667;var ae=35668;var se=35669;var oe=35670;var le=35671;var ue=35672;var fe=35673;var he=35674;var ce=35675;var pe=35676;var de=35678;var me=35680;var _e={};_e[$]=function(e,t,n){e.uniform1i(t,n)};_e[ee]=function(e,t,n){e.uniform1f(t,n)};_e[te]=function(e,t,n){e.uniform2fv(t,n)};_e[ne]=function(e,t,n){e.uniform3fv(t,n)};_e[re]=function(e,t,n){e.uniform4fv(t,n)};_e[ie]=function(e,t,n){e.uniform2iv(t,n)};_e[ae]=function(e,t,n){e.uniform3iv(t,n)};_e[se]=function(e,t,n){e.uniform4iv(t,n)};_e[oe]=function(e,t,n){e.uniform1i(t,n)};_e[le]=function(e,t,n){e.uniform2iv(t,n)};_e[ue]=function(e,t,n){e.uniform3iv(t,n)};_e[fe]=function(e,t,n){e.uniform4iv(t,n)};_e[he]=function(e,t,n){e.uniformMatrix2fv(t,false,n)};_e[ce]=function(e,t,n){e.uniformMatrix3fv(t,false,n)};_e[pe]=function(e,t,n){e.uniformMatrix4fv(t,false,n)};_e[de]=function(e,t,n){e.uniform1i(t,n)};_e[me]=function(e,t,n){e.uniform1i(t,n)};var ve={};ve[$]=function(e,t,n){e.uniform1iv(t,n)};ve[ee]=function(e,t,n){e.uniform1fv(t,n)};ve[te]=function(e,t,n){e.uniform2fv(t,n)};ve[ne]=function(e,t,n){e.uniform3fv(t,n)};ve[re]=function(e,t,n){e.uniform4fv(t,n)};ve[ie]=function(e,t,n){e.uniform2iv(t,n)};ve[ae]=function(e,t,n){e.uniform3iv(t,n)};ve[se]=function(e,t,n){e.uniform4iv(t,n)};ve[oe]=function(e,t,n){e.uniform1iv(t,n)};ve[le]=function(e,t,n){e.uniform2iv(t,n)};ve[ue]=function(e,t,n){e.uniform3iv(t,n)};ve[fe]=function(e,t,n){e.uniform4iv(t,n)};ve[he]=function(e,t,n){e.uniformMatrix2fv(t,false,n)};ve[ce]=function(e,t,n){e.uniformMatrix3fv(t,false,n)};ve[pe]=function(e,t,n){e.uniformMatrix4fv(t,false,n)};ve[de]=function(e,t,n){e.uniform1iv(t,n)};ve[me]=function(e,t,n){e.uniform1iv(t,n)};function ge(e,t,n){if(t.blend!==n.blend){if(!n.blend){e.disable(e.BLEND);return}e.enable(e.BLEND);if(n.blendSrc===L.BLEND_CONSTANT_COLOR||n.blendSrc===L.BLEND_ONE_MINUS_CONSTANT_COLOR||n.blendDst===L.BLEND_CONSTANT_COLOR||n.blendDst===L.BLEND_ONE_MINUS_CONSTANT_COLOR){e.blendColor((n.blendColor>>24)/255,(n.blendColor>>16&255)/255,(n.blendColor>>8&255)/255,(n.blendColor&255)/255)}if(n.blendSep){e.blendFuncSeparate(n.blendSrc,n.blendDst,n.blendSrcAlpha,n.blendDstAlpha);e.blendEquationSeparate(n.blendEq,n.blendAlphaEq)}else{e.blendFunc(n.blendSrc,n.blendDst);e.blendEquation(n.blendEq)}return}if(n.blend===false){return}if(t.blendColor!==n.blendColor){e.blendColor((n.blendColor>>24)/255,(n.blendColor>>16&255)/255,(n.blendColor>>8&255)/255,(n.blendColor&255)/255)}if(t.blendSep!==n.blendSep){if(n.blendSep){e.blendFuncSeparate(n.blendSrc,n.blendDst,n.blendSrcAlpha,n.blendDstAlpha);e.blendEquationSeparate(n.blendEq,n.blendAlphaEq)}else{e.blendFunc(n.blendSrc,n.blendDst);e.blendEquation(n.blendEq)}return}if(n.blendSep){if(t.blendSrc!==n.blendSrc||t.blendDst!==n.blendDst||t.blendSrcAlpha!==n.blendSrcAlpha||t.blendDstAlpha!==n.blendDstAlpha){e.blendFuncSeparate(n.blendSrc,n.blendDst,n.blendSrcAlpha,n.blendDstAlpha)}if(t.blendEq!==n.blendEq||t.blendAlphaEq!==n.blendAlphaEq){e.blendEquationSeparate(n.blendEq,n.blendAlphaEq)}}else{if(t.blendSrc!==n.blendSrc||t.blendDst!==n.blendDst){e.blendFunc(n.blendSrc,n.blendDst)}if(t.blendEq!==n.blendEq){e.blendEquation(n.blendEq)}}}function ye(e,t,n){if(t.depthTest!==n.depthTest){if(!n.depthTest){e.disable(e.DEPTH_TEST);return}e.enable(e.DEPTH_TEST);e.depthFunc(n.depthFunc);e.depthMask(n.depthWrite);return}if(t.depthWrite!==n.depthWrite){e.depthMask(n.depthWrite)}if(n.depthTest===false){if(n.depthWrite){n.depthTest=true;n.depthFunc=L.DS_FUNC_ALWAYS;e.enable(e.DEPTH_TEST);e.depthFunc(n.depthFunc)}return}if(t.depthFunc!==n.depthFunc){e.depthFunc(n.depthFunc)}}function be(e,t,n){if(n.stencilTest!==t.stencilTest){if(!n.stencilTest){e.disable(e.STENCIL_TEST);return}e.enable(e.STENCIL_TEST);if(n.stencilSep){e.stencilFuncSeparate(e.FRONT,n.stencilFuncFront,n.stencilRefFront,n.stencilMaskFront);e.stencilMaskSeparate(e.FRONT,n.stencilWriteMaskFront);e.stencilOpSeparate(e.FRONT,n.stencilFailOpFront,n.stencilZFailOpFront,n.stencilZPassOpFront);e.stencilFuncSeparate(e.BACK,n.stencilFuncBack,n.stencilRefBack,n.stencilMaskBack);e.stencilMaskSeparate(e.BACK,n.stencilWriteMaskBack);e.stencilOpSeparate(e.BACK,n.stencilFailOpBack,n.stencilZFailOpBack,n.stencilZPassOpBack)}else{e.stencilFunc(n.stencilFuncFront,n.stencilRefFront,n.stencilMaskFront);e.stencilMask(n.stencilWriteMaskFront);e.stencilOp(n.stencilFailOpFront,n.stencilZFailOpFront,n.stencilZPassOpFront)}return}if(!n.stencilTest){return}if(t.stencilSep!==n.stencilSep){if(n.stencilSep){e.stencilFuncSeparate(e.FRONT,n.stencilFuncFront,n.stencilRefFront,n.stencilMaskFront);e.stencilMaskSeparate(e.FRONT,n.stencilWriteMaskFront);e.stencilOpSeparate(e.FRONT,n.stencilFailOpFront,n.stencilZFailOpFront,n.stencilZPassOpFront);e.stencilFuncSeparate(e.BACK,n.stencilFuncBack,n.stencilRefBack,n.stencilMaskBack);e.stencilMaskSeparate(e.BACK,n.stencilWriteMaskBack);e.stencilOpSeparate(e.BACK,n.stencilFailOpBack,n.stencilZFailOpBack,n.stencilZPassOpBack)}else{e.stencilFunc(n.stencilFuncFront,n.stencilRefFront,n.stencilMaskFront);e.stencilMask(n.stencilWriteMaskFront);e.stencilOp(n.stencilFailOpFront,n.stencilZFailOpFront,n.stencilZPassOpFront)}return}if(n.stencilSep){if(t.stencilFuncFront!==n.stencilFuncFront||t.stencilRefFront!==n.stencilRefFront||t.stencilMaskFront!==n.stencilMaskFront){e.stencilFuncSeparate(e.FRONT,n.stencilFuncFront,n.stencilRefFront,n.stencilMaskFront)}if(t.stencilWriteMaskFront!==n.stencilWriteMaskFront){e.stencilMaskSeparate(e.FRONT,n.stencilWriteMaskFront)}if(t.stencilFailOpFront!==n.stencilFailOpFront||t.stencilZFailOpFront!==n.stencilZFailOpFront||t.stencilZPassOpFront!==n.stencilZPassOpFront){e.stencilOpSeparate(e.FRONT,n.stencilFailOpFront,n.stencilZFailOpFront,n.stencilZPassOpFront)}if(t.stencilFuncBack!==n.stencilFuncBack||t.stencilRefBack!==n.stencilRefBack||t.stencilMaskBack!==n.stencilMaskBack){e.stencilFuncSeparate(e.BACK,n.stencilFuncBack,n.stencilRefBack,n.stencilMaskBack)}if(t.stencilWriteMaskBack!==n.stencilWriteMaskBack){e.stencilMaskSeparate(e.BACK,n.stencilWriteMaskBack)}if(t.stencilFailOpBack!==n.stencilFailOpBack||t.stencilZFailOpBack!==n.stencilZFailOpBack||t.stencilZPassOpBack!==n.stencilZPassOpBack){e.stencilOpSeparate(e.BACK,n.stencilFailOpBack,n.stencilZFailOpBack,n.stencilZPassOpBack)}}else{if(t.stencilFuncFront!==n.stencilFuncFront||t.stencilRefFront!==n.stencilRefFront||t.stencilMaskFront!==n.stencilMaskFront){e.stencilFunc(n.stencilFuncFront,n.stencilRefFront,n.stencilMaskFront)}if(t.stencilWriteMaskFront!==n.stencilWriteMaskFront){e.stencilMask(n.stencilWriteMaskFront)}if(t.stencilFailOpFront!==n.stencilFailOpFront||t.stencilZFailOpFront!==n.stencilZFailOpFront||t.stencilZPassOpFront!==n.stencilZPassOpFront){e.stencilOp(n.stencilFailOpFront,n.stencilZFailOpFront,n.stencilZPassOpFront)}}}function xe(e,t,n){if(t.cullMode===n.cullMode){return}if(n.cullMode===L.CULL_NONE){e.disable(e.CULL_FACE);return}e.enable(e.CULL_FACE);e.cullFace(n.cullMode)}function Te(e,t,n,r){var i=false;if(r.maxStream===-1){console.warn("VertexBuffer not assigned, please call setVertexBuffer before every draw.");return}if(n.maxStream!==r.maxStream){i=true}else if(n.program!==r.program){i=true}else{for(var a=0;a<r.maxStream+1;++a){if(n.vertexBuffers[a]!==r.vertexBuffers[a]||n.vertexBufferOffsets[a]!==r.vertexBufferOffsets[a]){i=true;break}}}if(i){for(var s=0;s<e._caps.maxVertexAttribs;++s){e._newAttributes[s]=0}for(var o=0;o<r.maxStream+1;++o){var l=r.vertexBuffers[o];var u=r.vertexBufferOffsets[o];if(!l){continue}t.bindBuffer(t.ARRAY_BUFFER,l._glID);for(var f=0;f<r.program._attributes.length;++f){var h=r.program._attributes[f];var c=l._format.element(h.name);if(!c){console.warn("Can not find vertex attribute: "+h.name);continue}if(e._enabledAttributes[h.location]===0){t.enableVertexAttribArray(h.location);e._enabledAttributes[h.location]=1}e._newAttributes[h.location]=1;t.vertexAttribPointer(h.location,c.num,c.type,c.normalize,c.stride,c.offset+u*c.stride)}}for(var p=0;p<e._caps.maxVertexAttribs;++p){if(e._enabledAttributes[p]!==e._newAttributes[p]){t.disableVertexAttribArray(p);e._enabledAttributes[p]=0}}}}function Se(e,t,n){for(var r=0;r<n.maxTextureSlot+1;++r){if(t.textureUnits[r]!==n.textureUnits[r]){var i=n.textureUnits[r];if(i!==undefined&&i._glID!==-1){e.activeTexture(e.TEXTURE0+r);e.bindTexture(i._target,i._glID)}}}}function Ee(e,t,n,r){if(r===void 0)r=0;if(n instanceof q){e.framebufferTexture2D(e.FRAMEBUFFER,t,e.TEXTURE_2D,n._glID,0)}else if(n instanceof Y){e.framebufferTexture2D(e.FRAMEBUFFER,t,e.TEXTURE_CUBE_MAP_POSITIVE_X+r,n._glID,0)}else{e.framebufferRenderbuffer(e.FRAMEBUFFER,t,e.RENDERBUFFER,n._glID)}}var we=function e(t,n){var r=this;var i;n=n||{};if(n.alpha===undefined){n.alpha=false}if(n.stencil===undefined){n.stencil=true}if(n.depth===undefined){n.depth=true}if(n.antialias===undefined){n.antialias=false}if(n.preserveDrawingBuffer===undefined){n.preserveDrawingBuffer=false}try{i=t.getContext("webgl",n)}catch(e){console.error(e);return}this._gl=i;this._extensions={};this._caps={};this._stats={texture:0,vb:0,ib:0,drawcalls:0};this._initExtensions(["EXT_texture_filter_anisotropic","EXT_shader_texture_lod","OES_standard_derivatives","OES_texture_float","OES_texture_float_linear","OES_texture_half_float","OES_texture_half_float_linear","OES_vertex_array_object","WEBGL_compressed_texture_atc","WEBGL_compressed_texture_etc1","WEBGL_compressed_texture_pvrtc","WEBGL_compressed_texture_s3tc","WEBGL_depth_texture","WEBGL_draw_buffers"]);this._initCaps();this._initStates();Q.initDefault(this);this._current=new Q(this);this._next=new Q(this);this._uniforms={};this._vx=this._vy=this._vw=this._vh=0;this._sx=this._sy=this._sw=this._sh=0;this._framebuffer=null;this._enabledAttributes=new Array(this._caps.maxVertexAttribs);this._newAttributes=new Array(this._caps.maxVertexAttribs);for(var a=0;a<this._caps.maxVertexAttribs;++a){r._enabledAttributes[a]=0;r._newAttributes[a]=0}};we.prototype._initExtensions=function e(t){var n=this;var r=this._gl;for(var i=0;i<t.length;++i){var a=t[i];try{var s=r.getExtension(a);if(s){n._extensions[a]=s}}catch(e){console.error(e)}}};we.prototype._initCaps=function e(){var t=this._gl;var n=this.ext("WEBGL_draw_buffers");this._caps.maxVertexStreams=4;this._caps.maxVertexTextures=t.getParameter(t.MAX_VERTEX_TEXTURE_IMAGE_UNITS);this._caps.maxFragUniforms=t.getParameter(t.MAX_FRAGMENT_UNIFORM_VECTORS);this._caps.maxTextureUnits=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS);this._caps.maxVertexAttribs=t.getParameter(t.MAX_VERTEX_ATTRIBS);this._caps.maxDrawBuffers=n?t.getParameter(n.MAX_DRAW_BUFFERS_WEBGL):1;this._caps.maxColorAttachments=n?t.getParameter(n.MAX_COLOR_ATTACHMENTS_WEBGL):1};we.prototype._initStates=function e(){var t=this._gl;t.disable(t.BLEND);t.blendFunc(t.ONE,t.ZERO);t.blendEquation(t.FUNC_ADD);t.blendColor(1,1,1,1);t.colorMask(true,true,true,true);t.enable(t.CULL_FACE);t.cullFace(t.BACK);t.disable(t.DEPTH_TEST);t.depthFunc(t.LESS);t.depthMask(false);t.disable(t.POLYGON_OFFSET_FILL);t.depthRange(0,1);t.disable(t.STENCIL_TEST);t.stencilFunc(t.ALWAYS,0,255);t.stencilMask(255);t.stencilOp(t.KEEP,t.KEEP,t.KEEP);t.clearDepth(1);t.clearColor(0,0,0,0);t.clearStencil(0);t.disable(t.SCISSOR_TEST)};we.prototype._restoreTexture=function e(t){var n=this._gl;var r=this._current.textureUnits[t];if(r&&r._glID!==-1){n.bindTexture(r._target,r._glID)}else{n.bindTexture(n.TEXTURE_2D,null)}};we.prototype._restoreIndexBuffer=function e(){var t=this._gl;var n=this._current.indexBuffer;t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,n?n._glID:null)};we.prototype.ext=function e(t){return this._extensions[t]};we.prototype.setFrameBuffer=function e(t){var n=this;if(this._framebuffer===t){return}this._framebuffer=t;var r=this._gl;if(t===null){r.bindFramebuffer(r.FRAMEBUFFER,null);return}r.bindFramebuffer(r.FRAMEBUFFER,t._glID);var i=this._framebuffer._colors.length;for(var a=0;a<i;++a){var s=n._framebuffer._colors[a];Ee(r,r.COLOR_ATTACHMENT0+a,s)}for(var o=i;o<this._caps.maxColorAttachments;++o){r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0+o,r.TEXTURE_2D,null,0)}if(this._framebuffer._depth){Ee(r,r.DEPTH_ATTACHMENT,this._framebuffer._depth)}if(this._framebuffer._stencil){Ee(r,r.STENCIL_ATTACHMENT,t._stencil)}if(this._framebuffer._depthStencil){Ee(r,r.DEPTH_STENCIL_ATTACHMENT,t._depthStencil)}};we.prototype.setViewport=function e(t,n,r,i){if(this._vx!==t||this._vy!==n||this._vw!==r||this._vh!==i){this._gl.viewport(t,n,r,i);this._vx=t;this._vy=n;this._vw=r;this._vh=i}};we.prototype.setScissor=function e(t,n,r,i){if(this._sx!==t||this._sy!==n||this._sw!==r||this._sh!==i){this._gl.scissor(t,n,r,i);this._sx=t;this._sy=n;this._sw=r;this._sh=i}};we.prototype.clear=function e(t){var n=this._gl;var r=0;if(t.color!==undefined){r|=n.COLOR_BUFFER_BIT;n.clearColor(t.color[0],t.color[1],t.color[2],t.color[3])}if(t.depth!==undefined){r|=n.DEPTH_BUFFER_BIT;n.clearDepth(t.depth);n.enable(n.DEPTH_TEST);n.depthMask(true);n.depthFunc(n.ALWAYS)}if(t.stencil!==undefined){r|=n.STENCIL_BUFFER_BIT;n.clearStencil(t.stencil)}n.clear(r);if(t.depth!==undefined){if(this._current.depthTest===false){n.disable(n.DEPTH_TEST)}else{if(this._current.depthWrite===false){n.depthMask(false)}if(this._current.depthFunc!==L.DS_FUNC_ALWAYS){n.depthFunc(this._current.depthFunc)}}}};we.prototype.enableBlend=function e(){this._next.blend=true};we.prototype.enableDepthTest=function e(){this._next.depthTest=true};we.prototype.enableDepthWrite=function e(){this._next.depthWrite=true};we.prototype.enableStencilTest=function e(){this._next.stencilTest=true};we.prototype.setStencilFunc=function e(t,n,r){this._next.stencilSep=false;this._next.stencilFuncFront=this._next.stencilFuncBack=t;this._next.stencilRefFront=this._next.stencilRefBack=n;this._next.stencilMaskFront=this._next.stencilMaskBack=r};we.prototype.setStencilFuncFront=function e(t,n,r){this._next.stencilSep=true;this._next.stencilFuncFront=t;this._next.stencilRefFront=n;this._next.stencilMaskFront=r};we.prototype.setStencilFuncBack=function e(t,n,r){this._next.stencilSep=true;this._next.stencilFuncBack=t;this._next.stencilRefBack=n;this._next.stencilMaskBack=r};we.prototype.setStencilOp=function e(t,n,r,i){this._next.stencilFailOpFront=this._next.stencilFailOpBack=t;this._next.stencilZFailOpFront=this._next.stencilZFailOpBack=n;this._next.stencilZPassOpFront=this._next.stencilZPassOpBack=r;this._next.stencilWriteMaskFront=this._next.stencilWriteMaskBack=i};we.prototype.setStencilOpFront=function e(t,n,r,i){this._next.stencilSep=true;this._next.stencilFailOpFront=t;this._next.stencilZFailOpFront=n;this._next.stencilZPassOpFront=r;this._next.stencilWriteMaskFront=i};we.prototype.setStencilOpBack=function e(t,n,r,i){this._next.stencilSep=true;this._next.stencilFailOpBack=t;this._next.stencilZFailOpBack=n;this._next.stencilZPassOpBack=r;this._next.stencilWriteMaskBack=i};we.prototype.setDepthFunc=function e(t){this._next.depthFunc=t};we.prototype.setBlendColor32=function e(t){this._next.blendColor=t};we.prototype.setBlendColor=function e(t,n,r,i){this._next.blendColor=(t*255<<24|n*255<<16|r*255<<8|i*255)>>>0};we.prototype.setBlendFunc=function e(t,n){this._next.blendSep=false;this._next.blendSrc=t;this._next.blendDst=n};we.prototype.setBlendFuncSep=function e(t,n,r,i){this._next.blendSep=true;this._next.blendSrc=t;this._next.blendDst=n;this._next.blendSrcAlpha=r;this._next.blendDstAlpha=i};we.prototype.setBlendEq=function e(t){this._next.blendSep=false;this._next.blendEq=t};we.prototype.setBlendEqSep=function e(t,n){this._next.blendSep=true;this._next.blendEq=t;this._next.blendAlphaEq=n};we.prototype.setCullMode=function e(t){this._next.cullMode=t};we.prototype.setVertexBuffer=function e(t,n,r){if(r===void 0)r=0;this._next.vertexBuffers[t]=n;this._next.vertexBufferOffsets[t]=r;if(this._next.maxStream<t){this._next.maxStream=t}};we.prototype.setIndexBuffer=function e(t){this._next.indexBuffer=t};we.prototype.setProgram=function e(t){this._next.program=t};we.prototype.setTexture=function e(t,n,r){if(r>=this._caps.maxTextureUnits){console.warn("Can not set texture "+t+" at stage "+r+", max texture exceed: "+this._caps.maxTextureUnits);return}this._next.textureUnits[r]=n;this.setUniform(t,r);if(this._next.maxTextureSlot<r){this._next.maxTextureSlot=r}};we.prototype.setTextureArray=function e(t,n,r){var i=this;var a=n.length;if(a>=this._caps.maxTextureUnits){console.warn("Can not set "+a+" textures for "+t+", max texture exceed: "+this._caps.maxTextureUnits);return}for(var s=0;s<a;++s){var o=r[s];i._next.textureUnits[o]=n[s]}this.setUniform(t,r)};we.prototype.setUniform=function e(t,n){var r=this._uniforms[t];if(!r){r={dirty:true,value:n}}else{r.dirty=true;r.value=n}this._uniforms[t]=r};we.prototype.setPrimitiveType=function e(t){this._next.primitiveType=t};we.prototype.draw=function e(t,n){var r=this;var i=this._gl;var a=this._current;var s=this._next;ge(i,a,s);ye(i,a,s);be(i,a,s);xe(i,a,s);Te(this,i,a,s);if(a.indexBuffer!==s.indexBuffer){i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,s.indexBuffer?s.indexBuffer._glID:null)}var o=false;if(a.program!==s.program){if(s.program._linked){i.useProgram(s.program._glID)}else{console.warn("Failed to use program: has not linked yet.")}o=true}Se(i,a,s);for(var l=0;l<s.program._uniforms.length;++l){var u=s.program._uniforms[l];var f=r._uniforms[u.name];if(!f){continue}if(!o&&!f.dirty){continue}f.dirty=false;var h=u.size===undefined?_e[u.type]:ve[u.type];if(!h){console.warn("Can not find commit function for uniform "+u.name);continue}h(i,u.location,f.value)}if(s.indexBuffer){i.drawElements(this._next.primitiveType,n,s.indexBuffer._format,t*s.indexBuffer._bytesPerIndex)}else{i.drawArrays(this._next.primitiveType,t,n)}this._stats.drawcalls+=1;a.set(s);s.reset()};var Me={VertexFormat:P,IndexBuffer:B,VertexBuffer:z,Program:V,Texture:X,Texture2D:q,TextureCube:Y,RenderBuffer:K,FrameBuffer:Z,Device:we,attrTypeBytes:O,glFilter:I,glTextureFmt:C};Object.assign(Me,L);var Ae={PROJ_PERSPECTIVE:0,PROJ_ORTHO:1,LIGHT_DIRECTIONAL:0,LIGHT_POINT:1,LIGHT_SPOT:2,SHADOW_NONE:0,SHADOW_HARD:1,SHADOW_SOFT:2,PARAM_INT:0,PARAM_INT2:1,PARAM_INT3:2,PARAM_INT4:3,PARAM_FLOAT:4,PARAM_FLOAT2:5,PARAM_FLOAT3:6,PARAM_FLOAT4:7,PARAM_COLOR3:8,PARAM_COLOR4:9,PARAM_MAT2:10,PARAM_MAT3:11,PARAM_MAT4:12,PARAM_TEXTURE_2D:13,PARAM_TEXTURE_CUBE:14,CLEAR_COLOR:1,CLEAR_DEPTH:2,CLEAR_STENCIL:4,CLEAR_SKYBOX:8,BUFFER_VIEW_INT8:0,BUFFER_VIEW_UINT8:1,BUFFER_VIEW_INT16:2,BUFFER_VIEW_UINT16:3,BUFFER_VIEW_INT32:4,BUFFER_VIEW_UINT32:5,BUFFER_VIEW_FLOAT32:6};var Re=function e(t,n,r){if(r===void 0)r=Me.PT_TRIANGLES;this._vertexBuffer=t;this._indexBuffer=n;this._primitiveType=r;this._start=0;this._count=-1};var Ue={count:{configurable:true}};Ue.count.get=function(){if(this._count!==-1){return this._count}if(this._indexBuffer){return this._indexBuffer.count}return this._vertexBuffer.count};Object.defineProperties(Re.prototype,Ue);var De=function e(t){this._programName=t;this._cullMode=Me.CULL_BACK;this._blend=false;this._blendEq=Me.BLEND_FUNC_ADD;this._blendAlphaEq=Me.BLEND_FUNC_ADD;this._blendSrc=Me.BLEND_ONE;this._blendDst=Me.BLEND_ZERO;this._blendSrcAlpha=Me.BLEND_ONE;this._blendDstAlpha=Me.BLEND_ZERO;this._blendColor=4294967295;this._depthTest=false;this._depthWrite=false;this._depthFunc=Me.DS_FUNC_LESS,this._stencilTest=false;this._stencilFuncFront=Me.DS_FUNC_ALWAYS;this._stencilRefFront=0;this._stencilMaskFront=255;this._stencilFailOpFront=Me.STENCIL_OP_KEEP;this._stencilZFailOpFront=Me.STENCIL_OP_KEEP;this._stencilZPassOpFront=Me.STENCIL_OP_KEEP;this._stencilWriteMaskFront=255;this._stencilFuncBack=Me.DS_FUNC_ALWAYS;this._stencilRefBack=0;this._stencilMaskBack=255;this._stencilFailOpBack=Me.STENCIL_OP_KEEP;this._stencilZFailOpBack=Me.STENCIL_OP_KEEP;this._stencilZPassOpBack=Me.STENCIL_OP_KEEP;this._stencilWriteMaskBack=255};De.prototype.setCullMode=function e(t){this._cullMode=t};De.prototype.setBlend=function e(t,n,r,i,a,s,o){if(t===void 0)t=Me.BLEND_FUNC_ADD;if(n===void 0)n=Me.BLEND_ONE;if(r===void 0)r=Me.BLEND_ZERO;if(i===void 0)i=Me.BLEND_FUNC_ADD;if(a===void 0)a=Me.BLEND_ONE;if(s===void 0)s=Me.BLEND_ZERO;if(o===void 0)o=4294967295;this._blend=true;this._blendEq=t;this._blendSrc=n;this._blendDst=r;this._blendAlphaEq=i;this._blendSrcAlpha=a;this._blendDstAlpha=s;this._blendColor=o};De.prototype.setDepth=function e(t,n,r){if(t===void 0)t=false;if(n===void 0)n=false;if(r===void 0)r=Me.DS_FUNC_LESS;this._depthTest=t;this._depthWrite=n;this._depthFunc=r};De.prototype.setStencilFront=function e(t,n,r,i,a,s,o,l){if(t===void 0)t=false;if(n===void 0)n=Me.DS_FUNC_ALWAYS;if(r===void 0)r=0;if(i===void 0)i=255;if(a===void 0)a=Me.STENCIL_OP_KEEP;if(s===void 0)s=Me.STENCIL_OP_KEEP;if(o===void 0)o=Me.STENCIL_OP_KEEP;if(l===void 0)l=255;this._stencilTest=t;this._stencilFuncFront=n;this._stencilRefFront=r;this._stencilMaskFront=i;this._stencilFailOpFront=a;this._stencilZFailOpFront=s;this._stencilZPassOpFront=o;this._stencilWriteMaskFront=l};De.prototype.setStencilBack=function e(t,n,r,i,a,s,o,l){if(t===void 0)t=false;if(n===void 0)n=Me.DS_FUNC_ALWAYS;if(r===void 0)r=0;if(i===void 0)i=255;if(a===void 0)a=Me.STENCIL_OP_KEEP;if(s===void 0)s=Me.STENCIL_OP_KEEP;if(o===void 0)o=Me.STENCIL_OP_KEEP;if(l===void 0)l=255;this._stencilTest=t;this._stencilFuncBack=n;this._stencilRefBack=r;this._stencilMaskBack=i;this._stencilFailOpBack=a;this._stencilZFailOpBack=s;this._stencilZPassOpBack=o;this._stencilWriteMaskBack=l};var Le=0;var Oe={};var Ie={addStage:function(e){if(Oe[e]!==undefined){return}var t=1<<Le;Oe[e]=t;Le+=1},stageID:function(e){var t=Oe[e];if(t===undefined){return-1}return t},stageIDs:function(e){var t=0;for(var n=0;n<e.length;++n){var r=Oe[e[n]];if(r!==undefined){t|=r}}return t}};var Ce=0;var Pe=function e(t,n,r,i){if(i===void 0)i=0;this._id=Ce++;this._stageIDs=Ie.stageIDs(t);this._parameters=n;this._passes=r;this._layer=i};var Be={passes:{configurable:true},stageIDs:{configurable:true}};Pe.prototype.setStages=function e(t){this._stageIDs=Ie.stageIDs(t)};Be.passes.get=function(){return this._passes};Be.stageIDs.get=function(){return this._stageIDs};Object.defineProperties(Pe.prototype,Be);var Fe=function e(t,n,r,i){if(n===void 0)n={};if(r===void 0)r=[];if(i===void 0)i=[];this._techniques=t;this._properties=n;this._defines=r;this._dependencies=i};Fe.prototype.clear=function e(){this._techniques.length=0;this._properties=null;this._defines.length=0};Fe.prototype.getTechnique=function e(t){var n=this;var r=Ie.stageID(t);if(r===-1){return null}for(var i=0;i<this._techniques.length;++i){var a=n._techniques[i];if(a.stageIDs&r){return a}}return null};Fe.prototype.getProperty=function e(t){return this._properties[t]};Fe.prototype.setProperty=function e(t,n){this._properties[t]=n};Fe.prototype.getDefine=function e(t){var n=this;for(var r=0;r<this._defines.length;++r){var i=n._defines[r];if(i.name===t){return i.value}}console.warn("Failed to get define "+t+", define not found.");return null};Fe.prototype.define=function e(t,n){var r=this;for(var i=0;i<this._defines.length;++i){var a=r._defines[i];if(a.name===t){a.value=n;return}}console.warn("Failed to set define "+t+", define not found.")};Fe.prototype.extractDefines=function e(t){var n=this;if(t===void 0)t={};for(var r=0;r<this._defines.length;++r){var i=n._defines[r];t[i.name]=i.value}return t};Fe.prototype.extractDependencies=function e(t){var n=this;if(t===void 0)t={};for(var r=0;r<this._dependencies.length;++r){var i=n._dependencies[r];t[i.define]=i.extension}return t};function ze(e,t){if(!t.positions){console.error("The data must have positions field");return null}var n=[];var r=t.positions.length/3;for(var i=0;i<r;++i){n.push(t.positions[3*i],t.positions[3*i+1],t.positions[3*i+2]);if(t.normals){n.push(t.normals[3*i],t.normals[3*i+1],t.normals[3*i+2])}if(t.uvs){n.push(t.uvs[2*i],t.uvs[2*i+1])}}var a=[];a.push({name:Me.ATTR_POSITION,type:Me.ATTR_TYPE_FLOAT32,num:3});if(t.normals){a.push({name:Me.ATTR_NORMAL,type:Me.ATTR_TYPE_FLOAT32,num:3})}if(t.uvs){a.push({name:Me.ATTR_UV0,type:Me.ATTR_TYPE_FLOAT32,num:2})}var s=new Me.VertexBuffer(e,new Me.VertexFormat(a),Me.USAGE_STATIC,new Float32Array(n),r);var o=null;if(t.indices){o=new Me.IndexBuffer(e,Me.INDEX_FMT_UINT16,Me.USAGE_STATIC,new Uint16Array(t.indices),t.indices.length)}return new Re(s,o)}var ke=Math.PI/180;var Ne=180/Math.PI;var Ge=1e-6;function Ve(e,t){return Math.abs(e-t)<=Ge*Math.max(1,Math.abs(e),Math.abs(t))}function He(e,t,n){n=n||Ge;return Math.abs(e-t)<=n}function We(e,t,n){return e<t?t:e>n?n:e}function Xe(e){return e<0?0:e>1?1:e}function je(e,t,n){return e+(t-e)*n}function qe(e){return e*ke}function Ye(e){return e*Ne}var Ke=Math.random;function Ze(e,t){return Math.random()*(t-e)+e}function Je(e,t){return Math.floor(Ze(e,t))}function Qe(e){e=(e*9301+49297)%233280;return e/233280}function $e(e,t,n){return Qe(e)*(n-t)+t}function et(e,t,n){return Math.floor($e(e,t,n))}function tt(e){--e;e=e>>1|e;e=e>>2|e;e=e>>4|e;e=e>>8|e;e=e>>16|e;++e;return e}function nt(e,t){return e-Math.floor(e/t)*t}function rt(e,t){e=nt(e,t*2);e=t-Math.abs(e-t);return e}function it(e,t,n){return(n-e)/(t-e)}var at=32;var st=2147483647;var ot=-1<<at-1;function lt(e){return(e>0)-(e<0)}function ut(e){var t=e>>at-1;return(e^t)-t}function ft(e,t){return t^(e^t)&-(e<t)}function ht(e,t){return e^(e^t)&-(e<t)}function ct(e){return!(e&e-1)&&!!e}function pt(e){var t,n;t=(e>65535)<<4;e>>>=t;n=(e>255)<<3;e>>>=n;t|=n;n=(e>15)<<2;e>>>=n;t|=n;n=(e>3)<<1;e>>>=n;t|=n;return t|e>>1}function dt(e){return e>=1e9?9:e>=1e8?8:e>=1e7?7:e>=1e6?6:e>=1e5?5:e>=1e4?4:e>=1e3?3:e>=100?2:e>=10?1:0}function mt(e){e=e-(e>>>1&1431655765);e=(e&858993459)+(e>>>2&858993459);return(e+(e>>>4)&252645135)*16843009>>>24}function _t(e){var t=32;e&=-e;if(e){t--}if(e&65535){t-=16}if(e&16711935){t-=8}if(e&252645135){t-=4}if(e&858993459){t-=2}if(e&1431655765){t-=1}return t}function vt(e){e+=e===0;--e;e|=e>>>1;e|=e>>>2;e|=e>>>4;e|=e>>>8;e|=e>>>16;return e+1}function gt(e){e|=e>>>1;e|=e>>>2;e|=e>>>4;e|=e>>>8;e|=e>>>16;return e-(e>>>1)}function yt(e){e^=e>>>16;e^=e>>>8;e^=e>>>4;e&=15;return 27030>>>e&1}var bt=new Array(256);(function(e){for(var t=0;t<256;++t){var n=t,r=t,i=7;for(n>>>=1;n;n>>>=1){r<<=1;r|=n&1;--i}e[t]=r<<i&255}})(bt);function xt(e){return bt[e&255]<<24|bt[e>>>8&255]<<16|bt[e>>>16&255]<<8|bt[e>>>24&255]}function Tt(e,t){e&=65535;e=(e|e<<8)&16711935;e=(e|e<<4)&252645135;e=(e|e<<2)&858993459;e=(e|e<<1)&1431655765;t&=65535;t=(t|t<<8)&16711935;t=(t|t<<4)&252645135;t=(t|t<<2)&858993459;t=(t|t<<1)&1431655765;return e|t<<1}function St(e,t){e=e>>>t&1431655765;e=(e|e>>>1)&858993459;e=(e|e>>>2)&252645135;e=(e|e>>>4)&16711935;e=(e|e>>>16)&65535;return e<<16>>16}function Et(e,t,n){e&=1023;e=(e|e<<16)&4278190335;e=(e|e<<8)&251719695;e=(e|e<<4)&3272356035;e=(e|e<<2)&1227133513;t&=1023;t=(t|t<<16)&4278190335;t=(t|t<<8)&251719695;t=(t|t<<4)&3272356035;t=(t|t<<2)&1227133513;e|=t<<1;n&=1023;n=(n|n<<16)&4278190335;n=(n|n<<8)&251719695;n=(n|n<<4)&3272356035;n=(n|n<<2)&1227133513;return e|n<<2}function wt(e,t){e=e>>>t&1227133513;e=(e|e>>>2)&3272356035;e=(e|e>>>4)&251719695;e=(e|e>>>8)&4278190335;e=(e|e>>>16)&1023;return e<<22>>22}function Mt(e){var t=e|e-1;return t+1|(~t&-~t)-1>>>_t(e)+1}var At=Object.freeze({INT_BITS:at,INT_MAX:st,INT_MIN:ot,sign:lt,abs:ut,min:ft,max:ht,isPow2:ct,log2:pt,log10:dt,popCount:mt,countTrailingZeros:_t,nextPow2:vt,prevPow2:gt,parity:yt,reverse:xt,interleave2:Tt,deinterleave2:St,interleave3:Et,deinterleave3:wt,nextCombination:Mt});var Rt=function e(t,n){this.x=t;this.y=n};Rt.new=function e(t,n){return new Rt(t,n)};Rt.zero=function e(){return new Rt(0,0)};Rt.clone=function e(t){return new Rt(t.x,t.y)};Rt.copy=function e(t,n){t.x=n.x;t.y=n.y;return t};Rt.set=function e(t,n,r){t.x=n;t.y=r;return t};Rt.add=function e(t,n,r){t.x=n.x+r.x;t.y=n.y+r.y;return t};Rt.subtract=function e(t,n,r){t.x=n.x-r.x;t.y=n.y-r.y;return t};Rt.sub=function e(t,n,r){return Rt.subtract(t,n,r)};Rt.multiply=function e(t,n,r){t.x=n.x*r.x;t.y=n.y*r.y;return t};Rt.mul=function e(t,n,r){return Rt.multiply(t,n,r)};Rt.divide=function e(t,n,r){t.x=n.x/r.x;t.y=n.y/r.y;return t};Rt.div=function e(t,n,r){return Rt.divide(t,n,r)};Rt.ceil=function e(t,n){t.x=Math.ceil(n.x);t.y=Math.ceil(n.y);return t};Rt.floor=function e(t,n){t.x=Math.floor(n.x);t.y=Math.floor(n.y);return t};Rt.min=function e(t,n,r){t.x=Math.min(n.x,r.x);t.y=Math.min(n.y,r.y);return t};Rt.max=function e(t,n,r){t.x=Math.max(n.x,r.x);t.y=Math.max(n.y,r.y);return t};Rt.round=function e(t,n){t.x=Math.round(n.x);t.y=Math.round(n.y);return t};Rt.scale=function e(t,n,r){t.x=n.x*r;t.y=n.y*r;return t};Rt.scaleAndAdd=function e(t,n,r,i){t.x=n.x+r.x*i;t.y=n.y+r.y*i;return t};Rt.distance=function e(t,n){var r=n.x-t.x,i=n.y-t.y;return Math.sqrt(r*r+i*i)};Rt.dist=function e(t,n){return Rt.distance(t,n)};Rt.squaredDistance=function e(t,n){var r=n.x-t.x,i=n.y-t.y;return r*r+i*i};Rt.sqrDist=function e(t,n){return Rt.squaredDistance(t,n)};Rt.magnitude=function e(t){var n=t.x,r=t.y;return Math.sqrt(n*n+r*r)};Rt.mag=function e(t){return Rt.magnitude(t)};Rt.squaredMagnitude=function e(t){var n=t.x,r=t.y;return n*n+r*r};Rt.sqrMag=function e(t){return Rt.squaredMagnitude(t)};Rt.negate=function e(t,n){t.x=-n.x;t.y=-n.y;return t};Rt.inverse=function e(t,n){t.x=1/n.x;t.y=1/n.y;return t};Rt.inverseSafe=function e(t,n){var r=n.x,i=n.y;if(Math.abs(r)<Ge){t.x=0}else{t.x=1/r}if(Math.abs(i)<Ge){t.y=0}else{t.y=1/n.y}return t};Rt.normalize=function e(t,n){var r=n.x,i=n.y;var a=r*r+i*i;if(a>0){a=1/Math.sqrt(a);t.x=n.x*a;t.y=n.y*a}return t};Rt.dot=function e(t,n){return t.x*n.x+t.y*n.y};Rt.cross=function e(t,n,r){var i=n.x*r.y-n.y*r.x;t.x=t.y=0;t.z=i;return t};Rt.lerp=function e(t,n,r,i){var a=n.x,s=n.y;t.x=a+i*(r.x-a);t.y=s+i*(r.y-s);return t};Rt.random=function e(t,n){n=n||1;var r=Ke()*2*Math.PI;t.x=Math.cos(r)*n;t.y=Math.sin(r)*n;return t};Rt.transformMat2=function e(t,n,r){var i=n.x,a=n.y;t.x=r.m00*i+r.m02*a;t.y=r.m01*i+r.m03*a;return t};Rt.transformMat23=function e(t,n,r){var i=n.x,a=n.y;t.x=r.m00*i+r.m02*a+r.m04;t.y=r.m01*i+r.m03*a+r.m05;return t};Rt.transformMat3=function e(t,n,r){var i=n.x,a=n.y;t.x=r.m00*i+r.m03*a+r.m06;t.y=r.m01*i+r.m04*a+r.m07;return t};Rt.transformMat4=function e(t,n,r){var i=n.x,a=n.y;t.x=r.m00*i+r.m04*a+r.m12;t.y=r.m01*i+r.m05*a+r.m13;return t};Rt.forEach=function e(t,n,r,i,a,s){return Rt._forEach(t,n,r,i,a,s)};Rt.str=function e(t){return"vec2("+t.x+", "+t.y+")"};Rt.array=function e(t,n){t[0]=n.x;t[1]=n.y;return t};Rt.exactEquals=function e(t,n){return t.x===n.x&&t.y===n.y};Rt.equals=function e(t,n){var r=t.x,i=t.y;var a=n.x,s=n.y;return Math.abs(r-a)<=Ge*Math.max(1,Math.abs(r),Math.abs(a))&&Math.abs(i-s)<=Ge*Math.max(1,Math.abs(i),Math.abs(s))};Rt._forEach=function(){var e=Rt.zero();return function(t,n,r,i,a,s){var o,l;if(!n){n=2}if(!r){r=0}if(i){l=Math.min(i*n+r,t.length)}else{l=t.length}for(o=r;o<l;o+=n){e.x=t[o];e.y=t[o+1];a(e,e,s);t[o]=e.x;t[o+1]=e.y}return t}}();var Ut=function e(t,n,r){this.x=t;this.y=n;this.z=r};Ut.new=function e(t,n,r){return new Ut(t,n,r)};Ut.zero=function e(){return Ut.new(0,0,0)};Ut.clone=function e(t){return new Ut(t.x,t.y,t.z)};Ut.copy=function e(t,n){t.x=n.x;t.y=n.y;t.z=n.z;return t};Ut.set=function e(t,n,r,i){t.x=n;t.y=r;t.z=i;return t};Ut.add=function e(t,n,r){t.x=n.x+r.x;t.y=n.y+r.y;t.z=n.z+r.z;return t};Ut.subtract=function e(t,n,r){t.x=n.x-r.x;t.y=n.y-r.y;t.z=n.z-r.z;return t};Ut.sub=function e(t,n,r){return Ut.subtract(t,n,r)};Ut.multiply=function e(t,n,r){t.x=n.x*r.x;t.y=n.y*r.y;t.z=n.z*r.z;return t};Ut.mul=function e(t,n,r){return Ut.multiply(t,n,r)};Ut.divide=function e(t,n,r){t.x=n.x/r.x;t.y=n.y/r.y;t.z=n.z/r.z;return t};Ut.div=function e(t,n,r){return Ut.divide(t,n,r)};Ut.ceil=function e(t,n){t.x=Math.ceil(n.x);t.y=Math.ceil(n.y);t.z=Math.ceil(n.z);return t};Ut.floor=function e(t,n){t.x=Math.floor(n.x);t.y=Math.floor(n.y);t.z=Math.floor(n.z);return t};Ut.min=function e(t,n,r){t.x=Math.min(n.x,r.x);t.y=Math.min(n.y,r.y);t.z=Math.min(n.z,r.z);return t};Ut.max=function e(t,n,r){t.x=Math.max(n.x,r.x);t.y=Math.max(n.y,r.y);t.z=Math.max(n.z,r.z);return t};Ut.round=function e(t,n){t.x=Math.round(n.x);t.y=Math.round(n.y);t.z=Math.round(n.z);return t};Ut.scale=function e(t,n,r){t.x=n.x*r;t.y=n.y*r;t.z=n.z*r;return t};Ut.scaleAndAdd=function e(t,n,r,i){t.x=n.x+r.x*i;t.y=n.y+r.y*i;t.z=n.z+r.z*i;return t};Ut.distance=function e(t,n){var r=n.x-t.x,i=n.y-t.y,a=n.z-t.z;return Math.sqrt(r*r+i*i+a*a)};Ut.dist=function e(t,n){return Ut.distance(t,n)};Ut.squaredDistance=function e(t,n){var r=n.x-t.x,i=n.y-t.y,a=n.z-t.z;return r*r+i*i+a*a};Ut.sqrDist=function e(t,n){return Ut.squaredDistance(t,n)};Ut.magnitude=function e(t){var n=t.x,r=t.y,i=t.z;return Math.sqrt(n*n+r*r+i*i)};Ut.mag=function e(t){return Ut.magnitude(t)};Ut.squaredMagnitude=function e(t){var n=t.x,r=t.y,i=t.z;return n*n+r*r+i*i};Ut.sqrMag=function e(t){return Ut.squaredMagnitude(t)};Ut.negate=function e(t,n){t.x=-n.x;t.y=-n.y;t.z=-n.z;return t};Ut.inverse=function e(t,n){t.x=1/n.x;t.y=1/n.y;t.z=1/n.z;return t};Ut.inverseSafe=function e(t,n){var r=n.x,i=n.y,a=n.z;if(Math.abs(r)<Ge){t.x=0}else{t.x=1/r}if(Math.abs(i)<Ge){t.y=0}else{t.y=1/i}if(Math.abs(a)<Ge){t.z=0}else{t.z=1/a}return t};Ut.normalize=function e(t,n){var r=n.x,i=n.y,a=n.z;var s=r*r+i*i+a*a;if(s>0){s=1/Math.sqrt(s);t.x=r*s;t.y=i*s;t.z=a*s}return t};Ut.dot=function e(t,n){return t.x*n.x+t.y*n.y+t.z*n.z};Ut.cross=function e(t,n,r){var i=n.x,a=n.y,s=n.z,o=r.x,l=r.y,u=r.z;t.x=a*u-s*l;t.y=s*o-i*u;t.z=i*l-a*o;return t};Ut.lerp=function e(t,n,r,i){var a=n.x,s=n.y,o=n.z;t.x=a+i*(r.x-a);t.y=s+i*(r.y-s);t.z=o+i*(r.z-o);return t};Ut.hermite=function e(t,n,r,i,a,s){var o=s*s,l=o*(2*s-3)+1,u=o*(s-2)+s,f=o*(s-1),h=o*(3-2*s);t.x=n.x*l+r.x*u+i.x*f+a.x*h;t.y=n.y*l+r.y*u+i.y*f+a.y*h;t.z=n.z*l+r.z*u+i.z*f+a.z*h;return t};Ut.bezier=function e(t,n,r,i,a,s){var o=1-s,l=o*o,u=s*s,f=l*o,h=3*s*l,c=3*u*o,p=u*s;t.x=n.x*f+r.x*h+i.x*c+a.x*p;t.y=n.y*f+r.y*h+i.y*c+a.y*p;t.z=n.z*f+r.z*h+i.z*c+a.z*p;return t};Ut.random=function e(t,n){n=n||1;var r=Ke()*2*Math.PI;var i=Ke()*2-1;var a=Math.sqrt(1-i*i)*n;t.x=Math.cos(r)*a;t.y=Math.sin(r)*a;t.z=i*n;return t};Ut.transformMat4=function e(t,n,r){var i=n.x,a=n.y,s=n.z,o=r.m03*i+r.m07*a+r.m11*s+r.m15;o=o||1;t.x=(r.m00*i+r.m04*a+r.m08*s+r.m12)/o;t.y=(r.m01*i+r.m05*a+r.m09*s+r.m13)/o;t.z=(r.m02*i+r.m06*a+r.m10*s+r.m14)/o;return t};Ut.transformMat3=function e(t,n,r){var i=n.x,a=n.y,s=n.z;t.x=i*r.m00+a*r.m03+s*r.m06;t.y=i*r.m01+a*r.m04+s*r.m07;t.z=i*r.m02+a*r.m05+s*r.m08;return t};Ut.transformQuat=function e(t,n,r){var i=n.x,a=n.y,s=n.z;var o=r.x,l=r.y,u=r.z,f=r.w;var h=f*i+l*s-u*a;var c=f*a+u*i-o*s;var p=f*s+o*a-l*i;var d=-o*i-l*a-u*s;t.x=h*f+d*-o+c*-u-p*-l;t.y=c*f+d*-l+p*-o-h*-u;t.z=p*f+d*-u+h*-l-c*-o;return t};Ut.rotateX=function e(t,n,r,i){var a=[],s=[];a.x=n.x-r.x;a.y=n.y-r.y;a.z=n.z-r.z;s.x=a.x;s.y=a.y*Math.cos(i)-a.z*Math.sin(i);s.z=a.y*Math.sin(i)+a.z*Math.cos(i);t.x=s.x+r.x;t.y=s.y+r.y;t.z=s.z+r.z;return t};Ut.rotateY=function e(t,n,r,i){var a=[],s=[];a.x=n.x-r.x;a.y=n.y-r.y;a.z=n.z-r.z;s.x=a.z*Math.sin(i)+a.x*Math.cos(i);s.y=a.y;s.z=a.z*Math.cos(i)-a.x*Math.sin(i);t.x=s.x+r.x;t.y=s.y+r.y;t.z=s.z+r.z;return t};Ut.rotateZ=function e(t,n,r,i){var a=[],s=[];a.x=n.x-r.x;a.y=n.y-r.y;a.z=n.z-r.z;s.x=a.x*Math.cos(i)-a.y*Math.sin(i);s.y=a.x*Math.sin(i)+a.y*Math.cos(i);s.z=a.z;t.x=s.x+r.x;t.y=s.y+r.y;t.z=s.z+r.z;return t};Ut.str=function e(t){return"vec3("+t.x+", "+t.y+", "+t.z+")"};Ut.array=function e(t,n){t[0]=n.x;t[1]=n.y;t[2]=n.z;return t};Ut.exactEquals=function e(t,n){return t.x===n.x&&t.y===n.y&&t.z===n.z};Ut.equals=function e(t,n){var r=t.x,i=t.y,a=t.z;var s=n.x,o=n.y,l=n.z;return Math.abs(r-s)<=Ge*Math.max(1,Math.abs(r),Math.abs(s))&&Math.abs(i-o)<=Ge*Math.max(1,Math.abs(i),Math.abs(o))&&Math.abs(a-l)<=Ge*Math.max(1,Math.abs(a),Math.abs(l))};Ut.forEach=function e(t,n,r,i,a,s){return Ut._forEach(t,n,r,i,a,s)};Ut.angle=function e(t,n){return Ut._angle(t,n)};Ut._forEach=function(){var e=Ut.zero();return function(t,n,r,i,a,s){var o,l;if(!n){n=3}if(!r){r=0}if(i){l=Math.min(i*n+r,t.length)}else{l=t.length}for(o=r;o<l;o+=n){e.x=t[o];e.y=t[o+1];e.z=t[o+2];a(e,e,s);t[o]=e.x;t[o+1]=e.y;t[o+2]=e.z}return t}}();Ut._angle=function(){var e=Ut.zero();var t=Ut.zero();return function(n,r){Ut.copy(e,n);Ut.copy(t,r);Ut.normalize(e,e);Ut.normalize(t,t);var i=Ut.dot(e,t);if(i>1){return 0}if(i<-1){return Math.PI}return Math.acos(i)}}();var Dt=function e(t,n,r,i){this.x=t;this.y=n;this.z=r;this.w=i};Dt.new=function e(t,n,r,i){return new Dt(t,n,r,i)};Dt.zero=function e(){return Dt.new(0,0,0,0)};Dt.clone=function e(t){return new Dt(t.x,t.y,t.z,t.w)};Dt.copy=function e(t,n){t.x=n.x;t.y=n.y;t.z=n.z;t.w=n.w;return t};Dt.set=function e(t,n,r,i,a){t.x=n;t.y=r;t.z=i;t.w=a;return t};Dt.add=function e(t,n,r){t.x=n.x+r.x;t.y=n.y+r.y;t.z=n.z+r.z;t.w=n.w+r.w;return t};Dt.subtract=function e(t,n,r){t.x=n.x-r.x;t.y=n.y-r.y;t.z=n.z-r.z;t.w=n.w-r.w;return t};Dt.sub=function e(t,n,r){return Dt.subtract(t,n,r)};Dt.multiply=function e(t,n,r){t.x=n.x*r.x;t.y=n.y*r.y;t.z=n.z*r.z;t.w=n.w*r.w;return t};Dt.mul=function e(t,n,r){return Dt.multiply(t,n,r)};Dt.divide=function e(t,n,r){t.x=n.x/r.x;t.y=n.y/r.y;t.z=n.z/r.z;t.w=n.w/r.w;return t};Dt.div=function e(t,n,r){return Dt.divide(t,n,r)};Dt.ceil=function e(t,n){t.x=Math.ceil(n.x);t.y=Math.ceil(n.y);t.z=Math.ceil(n.z);t.w=Math.ceil(n.w);return t};Dt.floor=function e(t,n){t.x=Math.floor(n.x);t.y=Math.floor(n.y);t.z=Math.floor(n.z);t.w=Math.floor(n.w);return t};Dt.min=function e(t,n,r){t.x=Math.min(n.x,r.x);t.y=Math.min(n.y,r.y);t.z=Math.min(n.z,r.z);t.w=Math.min(n.w,r.w);return t};Dt.max=function e(t,n,r){t.x=Math.max(n.x,r.x);t.y=Math.max(n.y,r.y);t.z=Math.max(n.z,r.z);t.w=Math.max(n.w,r.w);return t};Dt.round=function e(t,n){t.x=Math.round(n.x);t.y=Math.round(n.y);t.z=Math.round(n.z);t.w=Math.round(n.w);return t};Dt.scale=function e(t,n,r){t.x=n.x*r;t.y=n.y*r;t.z=n.z*r;t.w=n.w*r;return t};Dt.scaleAndAdd=function e(t,n,r,i){t.x=n.x+r.x*i;t.y=n.y+r.y*i;t.z=n.z+r.z*i;t.w=n.w+r.w*i;return t};Dt.distance=function e(t,n){var r=n.x-t.x,i=n.y-t.y,a=n.z-t.z,s=n.w-t.w;return Math.sqrt(r*r+i*i+a*a+s*s)};Dt.dist=function e(t,n){return Dt.distance(t,n)};Dt.squaredDistance=function e(t,n){var r=n.x-t.x,i=n.y-t.y,a=n.z-t.z,s=n.w-t.w;return r*r+i*i+a*a+s*s};Dt.sqrDist=function e(t,n){return Dt.squaredDistance(t,n)};Dt.magnitude=function e(t){var n=t.x,r=t.y,i=t.z,a=t.w;return Math.sqrt(n*n+r*r+i*i+a*a)};Dt.mag=function e(t){return Dt.magnitude(t)};Dt.squaredMagnitude=function e(t){var n=t.x,r=t.y,i=t.z,a=t.w;return n*n+r*r+i*i+a*a};Dt.sqrMag=function e(t){return Dt.squaredMagnitude(t)};Dt.negate=function e(t,n){t.x=-n.x;t.y=-n.y;t.z=-n.z;t.w=-n.w;return t};Dt.inverse=function e(t,n){t.x=1/n.x;t.y=1/n.y;t.z=1/n.z;t.w=1/n.w;return t};Dt.inverseSafe=function e(t,n){var r=n.x,i=n.y,a=n.z,s=n.w;if(Math.abs(r)<Ge){t.x=0}else{t.x=1/r}if(Math.abs(i)<Ge){t.y=0}else{t.y=1/i}if(Math.abs(a)<Ge){t.z=0}else{t.z=1/a}if(Math.abs(s)<Ge){t.w=0}else{t.w=1/s}return t};Dt.normalize=function e(t,n){var r=n.x,i=n.y,a=n.z,s=n.w;var o=r*r+i*i+a*a+s*s;if(o>0){o=1/Math.sqrt(o);t.x=r*o;t.y=i*o;t.z=a*o;t.w=s*o}return t};Dt.dot=function e(t,n){return t.x*n.x+t.y*n.y+t.z*n.z+t.w*n.w};Dt.lerp=function e(t,n,r,i){var a=n.x,s=n.y,o=n.z,l=n.w;t.x=a+i*(r.x-a);t.y=s+i*(r.y-s);t.z=o+i*(r.z-o);t.w=l+i*(r.w-l);return t};Dt.random=function e(t,n){n=n||1;t.x=Ke();t.y=Ke();t.z=Ke();t.w=Ke();Dt.normalize(t,t);Dt.scale(t,t,n);return t};Dt.transformMat4=function e(t,n,r){var i=n.x,a=n.y,s=n.z,o=n.w;t.x=r.m00*i+r.m04*a+r.m08*s+r.m12*o;t.y=r.m01*i+r.m05*a+r.m09*s+r.m13*o;t.z=r.m02*i+r.m06*a+r.m10*s+r.m14*o;t.w=r.m03*i+r.m07*a+r.m11*s+r.m15*o;return t};Dt.transformQuat=function e(t,n,r){var i=n.x,a=n.y,s=n.z;var o=r.x,l=r.y,u=r.z,f=r.w;var h=f*i+l*s-u*a;var c=f*a+u*i-o*s;var p=f*s+o*a-l*i;var d=-o*i-l*a-u*s;t.x=h*f+d*-o+c*-u-p*-l;t.y=c*f+d*-l+p*-o-h*-u;t.z=p*f+d*-u+h*-l-c*-o;t.w=n.w;return t};Dt.str=function e(t){return"vec4("+t.x+", "+t.y+", "+t.z+", "+t.w+")"};Dt.array=function e(t,n){t[0]=n.x;t[1]=n.y;t[2]=n.z;t[3]=n.w;return t};Dt.exactEquals=function e(t,n){return t.x===n.x&&t.y===n.y&&t.z===n.z&&t.w===n.w};Dt.equals=function e(t,n){var r=t.x,i=t.y,a=t.z,s=t.w;var o=n.x,l=n.y,u=n.z,f=n.w;return Math.abs(r-o)<=Ge*Math.max(1,Math.abs(r),Math.abs(o))&&Math.abs(i-l)<=Ge*Math.max(1,Math.abs(i),Math.abs(l))&&Math.abs(a-u)<=Ge*Math.max(1,Math.abs(a),Math.abs(u))&&Math.abs(s-f)<=Ge*Math.max(1,Math.abs(s),Math.abs(f))};Dt.forEach=function e(t,n,r,i,a,s){return Dt._forEach(t,n,r,i,a,s)};Dt._forEach=function(){var e=Dt.zero();return function(t,n,r,i,a,s){var o,l;if(!n){n=4}if(!r){r=0}if(i){l=Math.min(i*n+r,t.length)}else{l=t.length}for(o=r;o<l;o+=n){e.x=t[o];e.y=t[o+1];e.z=t[o+2];e.w=t[o+3];a(e,e,s);t[o]=e.x;t[o+1]=e.y;t[o+2]=e.z;t[o+3]=e.w}return t}}();var Lt=function e(t,n,r,i,a,s,o,l,u){this.m00=t;this.m01=n;this.m02=r;this.m03=i;this.m04=a;this.m05=s;this.m06=o;this.m07=l;this.m08=u};Lt.create=function e(){return new Lt(1,0,0,0,1,0,0,0,1)};Lt.new=function e(t,n,r,i,a,s,o,l,u){return new Lt(t,n,r,i,a,s,o,l,u)};Lt.clone=function e(t){return new Lt(t.m00,t.m01,t.m02,t.m03,t.m04,t.m05,t.m06,t.m07,t.m08)};Lt.copy=function e(t,n){t.m00=n.m00;t.m01=n.m01;t.m02=n.m02;t.m03=n.m03;t.m04=n.m04;t.m05=n.m05;t.m06=n.m06;t.m07=n.m07;t.m08=n.m08;return t};Lt.set=function e(t,n,r,i,a,s,o,l,u,f){t.m00=n;t.m01=r;t.m02=i;t.m03=a;t.m04=s;t.m05=o;t.m06=l;t.m07=u;t.m08=f;return t};Lt.identity=function e(t){t.m00=1;t.m01=0;t.m02=0;t.m03=0;t.m04=1;t.m05=0;t.m06=0;t.m07=0;t.m08=1;return t};Lt.transpose=function e(t,n){if(t===n){var r=n.m01,i=n.m02,a=n.m05;t.m01=n.m03;t.m02=n.m06;t.m03=r;t.m05=n.m07;t.m06=i;t.m07=a}else{t.m00=n.m00;t.m01=n.m03;t.m02=n.m06;t.m03=n.m01;t.m04=n.m04;t.m05=n.m07;t.m06=n.m02;t.m07=n.m05;t.m08=n.m08}return t};Lt.invert=function e(t,n){var r=n.m00,i=n.m01,a=n.m02,s=n.m03,o=n.m04,l=n.m05,u=n.m06,f=n.m07,h=n.m08;var c=h*o-l*f;var p=-h*s+l*u;var d=f*s-o*u;var m=r*c+i*p+a*d;if(!m){return null}m=1/m;t.m00=c*m;t.m01=(-h*i+a*f)*m;t.m02=(l*i-a*o)*m;t.m03=p*m;t.m04=(h*r-a*u)*m;t.m05=(-l*r+a*s)*m;t.m06=d*m;t.m07=(-f*r+i*u)*m;t.m08=(o*r-i*s)*m;return t};Lt.adjoint=function e(t,n){var r=n.m00,i=n.m01,a=n.m02,s=n.m03,o=n.m04,l=n.m05,u=n.m06,f=n.m07,h=n.m08;t.m00=o*h-l*f;t.m01=a*f-i*h;t.m02=i*l-a*o;t.m03=l*u-s*h;t.m04=r*h-a*u;t.m05=a*s-r*l;t.m06=s*f-o*u;t.m07=i*u-r*f;t.m08=r*o-i*s;return t};Lt.determinant=function e(t){var n=t.m00,r=t.m01,i=t.m02,a=t.m03,s=t.m04,o=t.m05,l=t.m06,u=t.m07,f=t.m08;return n*(f*s-o*u)+r*(-f*a+o*l)+i*(u*a-s*l)};Lt.multiply=function e(t,n,r){var i=n.m00,a=n.m01,s=n.m02,o=n.m03,l=n.m04,u=n.m05,f=n.m06,h=n.m07,c=n.m08;var p=r.m00,d=r.m01,m=r.m02;var _=r.m03,v=r.m04,g=r.m05;var y=r.m06,b=r.m07,x=r.m08;t.m00=p*i+d*o+m*f;t.m01=p*a+d*l+m*h;t.m02=p*s+d*u+m*c;t.m03=_*i+v*o+g*f;t.m04=_*a+v*l+g*h;t.m05=_*s+v*u+g*c;t.m06=y*i+b*o+x*f;t.m07=y*a+b*l+x*h;t.m08=y*s+b*u+x*c;return t};Lt.mul=function e(t,n,r){return Lt.multiply(t,n,r)};Lt.translate=function e(t,n,r){var i=n.m00,a=n.m01,s=n.m02,o=n.m03,l=n.m04,u=n.m05,f=n.m06,h=n.m07,c=n.m08;var p=r.x,d=r.y;t.m00=i;t.m01=a;t.m02=s;t.m03=o;t.m04=l;t.m05=u;t.m06=p*i+d*o+f;t.m07=p*a+d*l+h;t.m08=p*s+d*u+c;return t};Lt.rotate=function e(t,n,r){var i=n.m00,a=n.m01,s=n.m02,o=n.m03,l=n.m04,u=n.m05,f=n.m06,h=n.m07,c=n.m08;var p=Math.sin(r);var d=Math.cos(r);t.m00=d*i+p*o;t.m01=d*a+p*l;t.m02=d*s+p*u;t.m03=d*o-p*i;t.m04=d*l-p*a;t.m05=d*u-p*s;t.m06=f;t.m07=h;t.m08=c;return t};Lt.scale=function e(t,n,r){var i=r.x,a=r.y;t.m00=i*n.m00;t.m01=i*n.m01;t.m02=i*n.m02;t.m03=a*n.m03;t.m04=a*n.m04;t.m05=a*n.m05;t.m06=n.m06;t.m07=n.m07;t.m08=n.m08;return t};Lt.fromMat4=function e(t,n){t.m00=n.m00;t.m01=n.m01;t.m02=n.m02;t.m03=n.m04;t.m04=n.m05;t.m05=n.m06;t.m06=n.m08;t.m07=n.m09;t.m08=n.m10;return t};Lt.fromTranslation=function e(t,n){t.m00=1;t.m01=0;t.m02=0;t.m03=0;t.m04=1;t.m05=0;t.m06=n.x;t.m07=n.y;t.m08=1;return t};Lt.fromRotation=function e(t,n){var r=Math.sin(n),i=Math.cos(n);t.m00=i;t.m01=r;t.m02=0;t.m03=-r;t.m04=i;t.m05=0;t.m06=0;t.m07=0;t.m08=1;return t};Lt.fromScaling=function e(t,n){t.m00=n.x;t.m01=0;t.m02=0;t.m03=0;t.m04=n.y;t.m05=0;t.m06=0;t.m07=0;t.m08=1;return t};Lt.fromMat2d=function e(t,n){t.m00=n.m00;t.m01=n.m01;t.m02=0;t.m03=n.m02;t.m04=n.m03;t.m05=0;t.m06=n.m04;t.m07=n.m05;t.m08=1;return t};Lt.fromQuat=function e(t,n){var r=n.x,i=n.y,a=n.z,s=n.w;var o=r+r;var l=i+i;var u=a+a;var f=r*o;var h=i*o;var c=i*l;var p=a*o;var d=a*l;var m=a*u;var _=s*o;var v=s*l;var g=s*u;t.m00=1-c-m;t.m03=h-g;t.m06=p+v;t.m01=h+g;t.m04=1-f-m;t.m07=d-_;t.m02=p-v;t.m05=d+_;t.m08=1-f-c;return t};Lt.fromViewUp=function e(t,n,r){return Lt._fromViewUp(t,n,r)};Lt.normalFromMat4=function e(t,n){var r=n.m00,i=n.m01,a=n.m02,s=n.m03,o=n.m04,l=n.m05,u=n.m06,f=n.m07,h=n.m08,c=n.m09,p=n.m10,d=n.m11,m=n.m12,_=n.m13,v=n.m14,g=n.m15;var y=r*l-i*o;var b=r*u-a*o;var x=r*f-s*o;var T=i*u-a*l;var S=i*f-s*l;var E=a*f-s*u;var w=h*_-c*m;var M=h*v-p*m;var A=h*g-d*m;var R=c*v-p*_;var U=c*g-d*_;var D=p*g-d*v;var L=y*D-b*U+x*R+T*A-S*M+E*w;if(!L){return null}L=1/L;t.m00=(l*D-u*U+f*R)*L;t.m01=(u*A-o*D-f*M)*L;t.m02=(o*U-l*A+f*w)*L;t.m03=(a*U-i*D-s*R)*L;t.m04=(r*D-a*A+s*M)*L;t.m05=(i*A-r*U-s*w)*L;t.m06=(_*E-v*S+g*T)*L;t.m07=(v*x-m*E-g*b)*L;t.m08=(m*S-_*x+g*y)*L;return t};Lt.str=function e(t){"mat3("+t.m00+", "+t.m01+", "+t.m02+", "+t.m03+", "+t.m04+", "+t.m05+", "+t.m06+", "+t.m07+", "+t.m08+")"};Lt.array=function e(t,n){t[0]=n.m00;t[1]=n.m01;t[2]=n.m02;t[3]=n.m03;t[4]=n.m04;t[5]=n.m05;t[6]=n.m06;t[7]=n.m07;t[8]=n.m08;return t};Lt.frob=function e(t){return Math.sqrt(Math.pow(t.m00,2)+Math.pow(t.m01,2)+Math.pow(t.m02,2)+Math.pow(t.m03,2)+Math.pow(t.m04,2)+Math.pow(t.m05,2)+Math.pow(t.m06,2)+Math.pow(t.m07,2)+Math.pow(t.m08,2))};Lt.add=function e(t,n,r){t.m00=n.m00+r.m00;t.m01=n.m01+r.m01;t.m02=n.m02+r.m02;t.m03=n.m03+r.m03;t.m04=n.m04+r.m04;t.m05=n.m05+r.m05;t.m06=n.m06+r.m06;t.m07=n.m07+r.m07;t.m08=n.m08+r.m08;return t};Lt.subtract=function e(t,n,r){t.m00=n.m00-r.m00;t.m01=n.m01-r.m01;t.m02=n.m02-r.m02;t.m03=n.m03-r.m03;t.m04=n.m04-r.m04;t.m05=n.m05-r.m05;t.m06=n.m06-r.m06;t.m07=n.m07-r.m07;t.m08=n.m08-r.m08;return t};Lt.sub=function e(t,n,r){return Lt.subtract(t,n,r)};Lt.multiplyScalar=function e(t,n,r){t.m00=n.m00*r;t.m01=n.m01*r;t.m02=n.m02*r;t.m03=n.m03*r;t.m04=n.m04*r;t.m05=n.m05*r;t.m06=n.m06*r;t.m07=n.m07*r;t.m08=n.m08*r;return t};Lt.multiplyScalarAndAdd=function e(t,n,r,i){t.m00=n.m00+r.m00*i;t.m01=n.m01+r.m01*i;t.m02=n.m02+r.m02*i;t.m03=n.m03+r.m03*i;t.m04=n.m04+r.m04*i;t.m05=n.m05+r.m05*i;t.m06=n.m06+r.m06*i;t.m07=n.m07+r.m07*i;t.m08=n.m08+r.m08*i;return t};Lt.exactEquals=function e(t,n){return t.m00===n.m00&&t.m01===n.m01&&t.m02===n.m02&&t.m03===n.m03&&t.m04===n.m04&&t.m05===n.m05&&t.m06===n.m06&&t.m07===n.m07&&t.m08===n.m08};Lt.equals=function e(t,n){var r=t.m00,i=t.m01,a=t.m02,s=t.m03,o=t.m04,l=t.m05,u=t.m06,f=t.m07,h=t.m08;var c=n.m00,p=n.m01,d=n.m02,m=n.m03,_=n.m04,v=n.m05,g=n.m06,y=n.m07,b=n.m08;return Math.abs(r-c)<=Ge*Math.max(1,Math.abs(r),Math.abs(c))&&Math.abs(i-p)<=Ge*Math.max(1,Math.abs(i),Math.abs(p))&&Math.abs(a-d)<=Ge*Math.max(1,Math.abs(a),Math.abs(d))&&Math.abs(s-m)<=Ge*Math.max(1,Math.abs(s),Math.abs(m))&&Math.abs(o-_)<=Ge*Math.max(1,Math.abs(o),Math.abs(_))&&Math.abs(l-v)<=Ge*Math.max(1,Math.abs(l),Math.abs(v))&&Math.abs(u-g)<=Ge*Math.max(1,Math.abs(u),Math.abs(g))&&Math.abs(f-y)<=Ge*Math.max(1,Math.abs(f),Math.abs(y))&&Math.abs(h-b)<=Ge*Math.max(1,Math.abs(h),Math.abs(b))};Lt._fromViewUp=function(){var e=Ut.new(0,1,0);var t=Ut.zero();var n=Ut.zero();return function(r,i,a){if(Ut.sqrMag(i)<Ge*Ge){Lt.identity(r);return r}a=a||e;Ut.cross(t,a,i);if(Ut.sqrMag(t)<Ge*Ge){Lt.identity(r);return r}Ut.cross(n,i,t);Lt.set(r,t.x,t.y,t.z,n.x,n.y,n.z,i.x,i.y,i.z);return r}}();var Ot=function e(t,n,r,i){this.x=t;this.y=n;this.z=r;this.w=i};Ot.new=function e(t,n,r,i){return new Ot(t,n,r,i)};Ot.create=function e(){return new Ot(0,0,0,1)};Ot.clone=function e(t){return new Ot(t.x,t.y,t.z,t.w)};Ot.copy=function e(t,n){return Dt.copy(t,n)};Ot.set=function e(t,n,r,i,a){t.x=n;t.y=r;t.z=i;t.w=a;return t};Ot.identity=function e(t){t.x=0;t.y=0;t.z=0;t.w=1;return t};Ot.rotationTo=function e(t,n,r){return Ot._rotationTo(t,n,r)};Ot.getAxisAngle=function e(t,n){var r=Math.acos(n.w)*2;var i=Math.sin(r/2);if(i!=0){t.x=n.x/i;t.y=n.y/i;t.z=n.z/i}else{t.x=1;t.y=0;t.z=0}return r};Ot.multiply=function e(t,n,r){var i=n.x,a=n.y,s=n.z,o=n.w,l=r.x,u=r.y,f=r.z,h=r.w;t.x=i*h+o*l+a*f-s*u;t.y=a*h+o*u+s*l-i*f;t.z=s*h+o*f+i*u-a*l;t.w=o*h-i*l-a*u-s*f;return t};Ot.mul=function e(t,n,r){return Ot.multiply(t,n,r)};Ot.scale=function e(t,n,r){t.x=n.x*r;t.y=n.y*r;t.z=n.z*r;t.w=n.w*r;return t};Ot.rotateX=function e(t,n,r){r*=.5;var i=n.x,a=n.y,s=n.z,o=n.w,l=Math.sin(r),u=Math.cos(r);t.x=i*u+o*l;t.y=a*u+s*l;t.z=s*u-a*l;t.w=o*u-i*l;return t};Ot.rotateY=function e(t,n,r){r*=.5;var i=n.x,a=n.y,s=n.z,o=n.w,l=Math.sin(r),u=Math.cos(r);t.x=i*u-s*l;t.y=a*u+o*l;t.z=s*u+i*l;t.w=o*u-a*l;return t};Ot.rotateZ=function e(t,n,r){r*=.5;var i=n.x,a=n.y,s=n.z,o=n.w,l=Math.sin(r),u=Math.cos(r);t.x=i*u+a*l;t.y=a*u-i*l;t.z=s*u+o*l;t.w=o*u-s*l;return t};Ot.rotateAround=function e(t,n,r,i){return Ot._rotateAround(t,n,r,i)};Ot.rotateAroundLocal=function e(t,n,r,i){return Ot._rotateAroundLocal(t,n,r,i)};Ot.calculateW=function e(t,n){var r=n.x,i=n.y,a=n.z;t.x=r;t.y=i;t.z=a;t.w=Math.sqrt(Math.abs(1-r*r-i*i-a*a));return t};Ot.dot=function e(t,n){return t.x*n.x+t.y*n.y+t.z*n.z+t.w*n.w};Ot.lerp=function e(t,n,r,i){var a=n.x,s=n.y,o=n.z,l=n.w;t.x=a+i*(r.x-a);t.y=s+i*(r.y-s);t.z=o+i*(r.z-o);t.w=l+i*(r.w-l);return t};Ot.slerp=function e(t,n,r,i){var a=n.x,s=n.y,o=n.z,l=n.w,u=r.x,f=r.y,h=r.z,c=r.w;var p,d,m,_,v;d=a*u+s*f+o*h+l*c;if(d<0){d=-d;u=-u;f=-f;h=-h;c=-c}if(1-d>1e-6){p=Math.acos(d);m=Math.sin(p);_=Math.sin((1-i)*p)/m;v=Math.sin(i*p)/m}else{_=1-i;v=i}t.x=_*a+v*u;t.y=_*s+v*f;t.z=_*o+v*h;t.w=_*l+v*c;return t};Ot.sqlerp=function e(t,n,r,i,a,s){return Ot._sqlerp(t,n,r,i,a,s)};Ot.invert=function e(t,n){var r=n.x,i=n.y,a=n.z,s=n.w;var o=r*r+i*i+a*a+s*s;var l=o?1/o:0;t.x=-r*l;t.y=-i*l;t.z=-a*l;t.w=s*l;return t};Ot.conjugate=function e(t,n){t.x=-n.x;t.y=-n.y;t.z=-n.z;t.w=n.w;return t};Ot.magnitude=function e(t){var n=t.x,r=t.y,i=t.z,a=t.w;return Math.sqrt(n*n+r*r+i*i+a*a)};Ot.mag=function e(t){return Ot.magnitude(t)};Ot.squaredMagnitude=function e(t){var n=t.x,r=t.y,i=t.z,a=t.w;return n*n+r*r+i*i+a*a};Ot.sqrMag=function e(t){return Ot.squaredMagnitude(t)};Ot.normalize=function e(t,n){var r=n.x,i=n.y,a=n.z,s=n.w;var o=r*r+i*i+a*a+s*s;if(o>0){o=1/Math.sqrt(o);t.x=r*o;t.y=i*o;t.z=a*o;t.w=s*o}return t};Ot.fromAxes=function e(t,n,r,i){return Ot._fromAxes(t,n,r,i)};Ot.fromViewUp=function e(t,n,r){return Ot._fromViewUp(t,n,r)};Ot.fromAxisAngle=function e(t,n,r){r=r*.5;var i=Math.sin(r);t.x=i*n.x;t.y=i*n.y;t.z=i*n.z;t.w=Math.cos(r);return t};Ot.fromMat3=function e(t,n){var r=n.m00,i=n.m03,a=n.m06,s=n.m01,o=n.m04,l=n.m07,u=n.m02,f=n.m05,h=n.m08;var c=r+o+h;if(c>0){var p=.5/Math.sqrt(c+1);t.w=.25/p;t.x=(f-l)*p;t.y=(a-u)*p;t.z=(s-i)*p}else if(r>o&&r>h){var d=2*Math.sqrt(1+r-o-h);t.w=(f-l)/d;t.x=.25*d;t.y=(i+s)/d;t.z=(a+u)/d}else if(o>h){var m=2*Math.sqrt(1+o-r-h);t.w=(a-u)/m;t.x=(i+s)/m;t.y=.25*m;t.z=(l+f)/m}else{var _=2*Math.sqrt(1+h-r-o);t.w=(s-i)/_;t.x=(a+u)/_;t.y=(l+f)/_;t.z=.25*_}return t};Ot.fromEuler=function e(t,n,r,i){var a=.5*Math.PI/180;n*=a;r*=a;i*=a;var s=Math.sin(n);var o=Math.cos(n);var l=Math.sin(r);var u=Math.cos(r);var f=Math.sin(i);var h=Math.cos(i);t.x=s*u*h-o*l*f;t.y=o*l*h+s*u*f;t.z=o*u*f-s*l*h;t.w=o*u*h+s*l*f;return t};Ot.str=function e(t){return"quat("+t.x+", "+t.y+", "+t.z+", "+t.w+")"};Ot.array=function e(t,n){t[0]=n.x;t[1]=n.y;t[2]=n.z;t[3]=n.w;return t};Ot.exactEquals=function e(t,n){return Dt.exactEquals(t,n)};Ot.equals=function e(t,n){return Dt.equals(t,n)};Ot._rotationTo=function(){var e=Ut.zero();var t=Ut.new(1,0,0);var n=Ut.new(0,1,0);return function(r,i,a){var s=Ut.dot(i,a);if(s<-.999999){Ut.cross(e,t,i);if(Ut.magnitude(e)<1e-6){Ut.cross(e,n,i)}Ut.normalize(e,e);Ot.fromAxisAngle(r,e,Math.PI);return r}else if(s>.999999){r.x=0;r.y=0;r.z=0;r.w=1;return r}else{Ut.cross(e,i,a);r.x=e.x;r.y=e.y;r.z=e.z;r.w=1+s;return Ot.normalize(r,r)}}}();Ot._rotateAround=function(){var e=Ut.zero();var t=Ot.create();return function(n,r,i,a){Ot.invert(t,r);Ut.transformQuat(e,i,t);Ot.fromAxisAngle(t,e,a);Ot.mul(n,r,t);return n}}();Ot._rotateAroundLocal=function(){var e=Ot.create();return function(t,n,r,i){Ot.fromAxisAngle(e,r,i);Ot.mul(t,n,e);return t}}();Ot._sqlerp=function(){var e=Ot.create();var t=Ot.create();return function(n,r,i,a,s,o){Ot.slerp(e,r,s,o);Ot.slerp(t,i,a,o);Ot.slerp(n,e,t,2*o*(1-o));return n}}();Ot._fromAxes=function(){var e=Lt.create();return function(t,n,r,i){Lt.set(e,n.x,n.y,n.z,r.x,r.y,r.z,i.x,i.y,i.z);return Ot.normalize(t,Ot.fromMat3(t,e))}}();Ot._fromViewUp=function(){var e=Lt.create();return function(t,n,r){Lt.fromViewUp(e,n,r);if(!e){return null}return Ot.normalize(t,Ot.fromMat3(t,e))}}();var It=function e(t,n,r,i){this.m00=t;this.m01=n;this.m02=r;this.m03=i};It.create=function e(){return new It(1,0,0,1)};It.new=function e(t,n,r,i){return new It(t,n,r,i)};It.clone=function e(t){return new It(t.m00,t.m01,t.m02,t.m03)};It.copy=function e(t,n){t.m00=n.m00;t.m01=n.m01;t.m02=n.m02;t.m03=n.m03;return t};It.identity=function e(t){t.m00=1;t.m01=0;t.m02=0;t.m03=1;return t};It.set=function e(t,n,r,i,a){t.m00=n;t.m01=r;t.m02=i;t.m03=a;return t};It.transpose=function e(t,n){if(t===n){var r=n.m01;t.m01=n.m02;t.m02=r}else{t.m00=n.m00;t.m01=n.m02;t.m02=n.m01;t.m03=n.m03}return t};It.invert=function e(t,n){var r=n.m00,i=n.m01,a=n.m02,s=n.m03;var o=r*s-a*i;if(!o){return null}o=1/o;t.m00=s*o;t.m01=-i*o;t.m02=-a*o;t.m03=r*o;return t};It.adjoint=function e(t,n){var r=n.m00;t.m00=n.m03;t.m01=-n.m01;t.m02=-n.m02;t.m03=r;return t};It.determinant=function e(t){return t.m00*t.m03-t.m02*t.m01};It.multiply=function e(t,n,r){var i=n.m00,a=n.m01,s=n.m02,o=n.m03;var l=r.m00,u=r.m01,f=r.m02,h=r.m03;t.m00=i*l+s*u;t.m01=a*l+o*u;t.m02=i*f+s*h;t.m03=a*f+o*h;return t};It.mul=function e(t,n,r){return It.multiply(t,n,r)};It.rotate=function e(t,n,r){var i=n.m00,a=n.m01,s=n.m02,o=n.m03,l=Math.sin(r),u=Math.cos(r);t.m00=i*u+s*l;t.m01=a*u+o*l;t.m02=i*-l+s*u;t.m03=a*-l+o*u;return t};It.scale=function e(t,n,r){var i=n.m00,a=n.m01,s=n.m02,o=n.m03,l=r.x,u=r.y;t.m00=i*l;t.m01=a*l;t.m02=s*u;t.m03=o*u;return t};It.fromRotation=function e(t,n){var r=Math.sin(n),i=Math.cos(n);t.m00=i;t.m01=r;t.m02=-r;t.m03=i;return t};It.fromScaling=function e(t,n){t.m00=n.x;t.m01=0;t.m02=0;t.m03=n.y;return t};It.str=function e(t){return"mat2("+t.m00+", "+t.m01+", "+t.m02+", "+t.m03+")"};It.array=function e(t,n){t[0]=n.m00;t[1]=n.m01;t[2]=n.m02;t[3]=n.m03;return t};It.frob=function e(t){return Math.sqrt(Math.pow(t.m00,2)+Math.pow(t.m01,2)+Math.pow(t.m02,2)+Math.pow(t.m03,2))};It.LDU=function e(t,n,r,i){t.m02=i.m02/i.m00;r.m00=i.m00;r.m01=i.m01;r.m03=i.m03-t.m02*r.m01};It.add=function e(t,n,r){t.m00=n.m00+r.m00;t.m01=n.m01+r.m01;t.m02=n.m02+r.m02;t.m03=n.m03+r.m03;return t};It.subtract=function e(t,n,r){t.m00=n.m00-r.m00;t.m01=n.m01-r.m01;t.m02=n.m02-r.m02;t.m03=n.m03-r.m03;return t};It.sub=function e(t,n,r){return It.subtract(t,n,r)};It.exactEquals=function e(t,n){return t.m00===n.m00&&t.m01===n.m01&&t.m02===n.m02&&t.m03===n.m03};It.equals=function e(t,n){var r=t.m00,i=t.m01,a=t.m02,s=t.m03;var o=n.m00,l=n.m01,u=n.m02,f=n.m03;return Math.abs(r-o)<=Ge*Math.max(1,Math.abs(r),Math.abs(o))&&Math.abs(i-l)<=Ge*Math.max(1,Math.abs(i),Math.abs(l))&&Math.abs(a-u)<=Ge*Math.max(1,Math.abs(a),Math.abs(u))&&Math.abs(s-f)<=Ge*Math.max(1,Math.abs(s),Math.abs(f))};It.multiplyScalar=function e(t,n,r){t.m00=n.m00*r;t.m01=n.m01*r;t.m02=n.m02*r;t.m03=n.m03*r;return t};It.multiplyScalarAndAdd=function e(t,n,r,i){t.m00=n.m00+r.m00*i;t.m01=n.m01+r.m01*i;t.m02=n.m02+r.m02*i;t.m03=n.m03+r.m03*i;return t};var Ct=function e(t,n,r,i,a,s){this.m00=t;this.m01=n;this.m02=r;this.m03=i;this.m04=a;this.m05=s};Ct.create=function e(){return new Ct(1,0,0,1,0,0)};Ct.new=function e(t,n,r,i,a,s){return new Ct(t,n,r,i,a,s)};Ct.clone=function e(t){return new Ct(t.m00,t.m01,t.m02,t.m03,t.m04,t.m05)};Ct.copy=function e(t,n){t.m00=n.m00;t.m01=n.m01;t.m02=n.m02;t.m03=n.m03;t.m04=n.m04;t.m05=n.m05;return t};Ct.identity=function e(t){t.m00=1;t.m01=0;t.m02=0;t.m03=1;t.m04=0;t.m05=0;return t};Ct.set=function e(t,n,r,i,a,s,o){t.m00=n;t.m01=r;t.m02=i;t.m03=a;t.m04=s;t.m05=o;return t};Ct.invert=function e(t,n){var r=n.m00,i=n.m01,a=n.m02,s=n.m03,o=n.m04,l=n.m05;var u=r*s-i*a;if(!u){return null}u=1/u;t.m00=s*u;t.m01=-i*u;t.m02=-a*u;t.m03=r*u;t.m04=(a*l-s*o)*u;t.m05=(i*o-r*l)*u;return t};Ct.determinant=function e(t){return t.m00*t.m03-t.m01*t.m02};Ct.multiply=function e(t,n,r){var i=n.m00,a=n.m01,s=n.m02,o=n.m03,l=n.m04,u=n.m05,f=r.m00,h=r.m01,c=r.m02,p=r.m03,d=r.m04,m=r.m05;t.m00=i*f+s*h;t.m01=a*f+o*h;t.m02=i*c+s*p;t.m03=a*c+o*p;t.m04=i*d+s*m+l;t.m05=a*d+o*m+u;return t};Ct.mul=function e(t,n,r){return Ct.multiply(t,n,r)};Ct.rotate=function e(t,n,r){var i=n.m00,a=n.m01,s=n.m02,o=n.m03,l=n.m04,u=n.m05,f=Math.sin(r),h=Math.cos(r);t.m00=i*h+s*f;t.m01=a*h+o*f;t.m02=i*-f+s*h;t.m03=a*-f+o*h;t.m04=l;t.m05=u;return t};Ct.scale=function e(t,n,r){var i=n.m00,a=n.m01,s=n.m02,o=n.m03,l=n.m04,u=n.m05,f=r.x,h=r.y;t.m00=i*f;t.m01=a*f;t.m02=s*h;t.m03=o*h;t.m04=l;t.m05=u;return t};Ct.translate=function e(t,n,r){var i=n.m00,a=n.m01,s=n.m02,o=n.m03,l=n.m04,u=n.m05,f=r.x,h=r.y;t.m00=i;t.m01=a;t.m02=s;t.m03=o;t.m04=i*f+s*h+l;t.m05=a*f+o*h+u;return t};Ct.fromRotation=function e(t,n){var r=Math.sin(n),i=Math.cos(n);t.m00=i;t.m01=r;t.m02=-r;t.m03=i;t.m04=0;t.m05=0;return t};Ct.fromScaling=function e(t,n){t.m00=n.m00;t.m01=0;t.m02=0;t.m03=n.m01;t.m04=0;t.m05=0;return t};Ct.fromTranslation=function e(t,n){t.m00=1;t.m01=0;t.m02=0;t.m03=1;t.m04=n.x;t.m05=n.y;return t};Ct.fromRTS=function e(t,n,r,i){var a=Math.sin(n),s=Math.cos(n);t.m00=s*i.x;t.m01=a*i.x;t.m02=-a*i.y;t.m03=s*i.y;t.m04=r.x;t.m05=r.y;return t};Ct.str=function e(t){return"mat23("+t.m00+", "+t.m01+", "+t.m02+", "+t.m03+", "+t.m04+", "+t.m05+")"};Ct.array=function e(t,n){t[0]=n.m00;t[1]=n.m01;t[2]=n.m02;t[3]=n.m03;t[4]=n.m04;t[5]=n.m05;return t};Ct.array4x4=function e(t,n){t[0]=n.m00;t[1]=n.m01;t[2]=0;t[3]=0;t[4]=n.m02;t[5]=n.m03;t[6]=0;t[7]=0;t[8]=0;t[9]=0;t[10]=1;t[11]=0;t[12]=n.m04;t[13]=n.m05;t[14]=0;t[15]=1;return t};Ct.frob=function e(t){return Math.sqrt(Math.pow(t.m00,2)+Math.pow(t.m01,2)+Math.pow(t.m02,2)+Math.pow(t.m03,2)+Math.pow(t.m04,2)+Math.pow(t.m05,2)+1)};Ct.add=function e(t,n,r){t.m00=n.m00+r.m00;t.m01=n.m01+r.m01;t.m02=n.m02+r.m02;t.m03=n.m03+r.m03;t.m04=n.m04+r.m04;t.m05=n.m05+r.m05;return t};Ct.subtract=function e(t,n,r){t.m00=n.m00-r.m00;t.m01=n.m01-r.m01;t.m02=n.m02-r.m02;t.m03=n.m03-r.m03;t.m04=n.m04-r.m04;t.m05=n.m05-r.m05;return t};Ct.sub=function e(t,n,r){return Ct.subtract(t,n,r)};Ct.multiplyScalar=function e(t,n,r){t.m00=n.m00*r;t.m01=n.m01*r;t.m02=n.m02*r;t.m03=n.m03*r;t.m04=n.m04*r;t.m05=n.m05*r;return t};Ct.multiplyScalarAndAdd=function e(t,n,r,i){t.m00=n.m00+r.m00*i;t.m01=n.m01+r.m01*i;t.m02=n.m02+r.m02*i;t.m03=n.m03+r.m03*i;t.m04=n.m04+r.m04*i;t.m05=n.m05+r.m05*i;return t};Ct.exactEquals=function e(t,n){return t.m00===n.m00&&t.m01===n.m01&&t.m02===n.m02&&t.m03===n.m03&&t.m04===n.m04&&t.m05===n.m05};Ct.equals=function e(t,n){var r=t.m00,i=t.m01,a=t.m02,s=t.m03,o=t.m04,l=t.m05;var u=n.m00,f=n.m01,h=n.m02,c=n.m03,p=n.m04,d=n.m05;return Math.abs(r-u)<=Ge*Math.max(1,Math.abs(r),Math.abs(u))&&Math.abs(i-f)<=Ge*Math.max(1,Math.abs(i),Math.abs(f))&&Math.abs(a-h)<=Ge*Math.max(1,Math.abs(a),Math.abs(h))&&Math.abs(s-c)<=Ge*Math.max(1,Math.abs(s),Math.abs(c))&&Math.abs(o-p)<=Ge*Math.max(1,Math.abs(o),Math.abs(p))&&Math.abs(l-d)<=Ge*Math.max(1,Math.abs(l),Math.abs(d))};var Pt=function e(t,n,r,i,a,s,o,l,u,f,h,c,p,d,m,_){this.m00=t;this.m01=n;this.m02=r;this.m03=i;this.m04=a;this.m05=s;this.m06=o;this.m07=l;this.m08=u;this.m09=f;this.m10=h;this.m11=c;this.m12=p;this.m13=d;this.m14=m;this.m15=_};Pt.new=function e(t,n,r,i,a,s,o,l,u,f,h,c,p,d,m,_){return new Pt(t,n,r,i,a,s,o,l,u,f,h,c,p,d,m,_)};Pt.create=function e(){return new Pt(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1)};Pt.clone=function e(t){return new Pt(t.m00,t.m01,t.m02,t.m03,t.m04,t.m05,t.m06,t.m07,t.m08,t.m09,t.m10,t.m11,t.m12,t.m13,t.m14,t.m15)};Pt.copy=function e(t,n){t.m00=n.m00;t.m01=n.m01;t.m02=n.m02;t.m03=n.m03;t.m04=n.m04;t.m05=n.m05;t.m06=n.m06;t.m07=n.m07;t.m08=n.m08;t.m09=n.m09;t.m10=n.m10;t.m11=n.m11;t.m12=n.m12;t.m13=n.m13;t.m14=n.m14;t.m15=n.m15;return t};Pt.set=function e(t,n,r,i,a,s,o,l,u,f,h,c,p,d,m,_,v){t.m00=n;t.m01=r;t.m02=i;t.m03=a;t.m04=s;t.m05=o;t.m06=l;t.m07=u;t.m08=f;t.m09=h;t.m10=c;t.m11=p;t.m12=d;t.m13=m;t.m14=_;t.m15=v;return t};Pt.identity=function e(t){t.m00=1;t.m01=0;t.m02=0;t.m03=0;t.m04=0;t.m05=1;t.m06=0;t.m07=0;t.m08=0;t.m09=0;t.m10=1;t.m11=0;t.m12=0;t.m13=0;t.m14=0;t.m15=1;return t};Pt.transpose=function e(t,n){if(t===n){var r=n.m01,i=n.m02,a=n.m03,s=n.m06,o=n.m07,l=n.m11;t.m01=n.m04;t.m02=n.m08;t.m03=n.m12;t.m04=r;t.m06=n.m09;t.m07=n.m13;t.m08=i;t.m09=s;t.m11=n.m14;t.m12=a;t.m13=o;t.m14=l}else{t.m00=n.m00;t.m01=n.m04;t.m02=n.m08;t.m03=n.m12;t.m04=n.m01;t.m05=n.m05;t.m06=n.m09;t.m07=n.m13;t.m08=n.m02;t.m09=n.m06;t.m10=n.m10;t.m11=n.m14;t.m12=n.m03;t.m13=n.m07;t.m14=n.m11;t.m15=n.m15}return t};Pt.invert=function e(t,n){var r=n.m00,i=n.m01,a=n.m02,s=n.m03,o=n.m04,l=n.m05,u=n.m06,f=n.m07,h=n.m08,c=n.m09,p=n.m10,d=n.m11,m=n.m12,_=n.m13,v=n.m14,g=n.m15;var y=r*l-i*o;var b=r*u-a*o;var x=r*f-s*o;var T=i*u-a*l;var S=i*f-s*l;var E=a*f-s*u;var w=h*_-c*m;var M=h*v-p*m;var A=h*g-d*m;var R=c*v-p*_;var U=c*g-d*_;var D=p*g-d*v;var L=y*D-b*U+x*R+T*A-S*M+E*w;if(!L){return null}L=1/L;t.m00=(l*D-u*U+f*R)*L;t.m01=(a*U-i*D-s*R)*L;t.m02=(_*E-v*S+g*T)*L;t.m03=(p*S-c*E-d*T)*L;t.m04=(u*A-o*D-f*M)*L;t.m05=(r*D-a*A+s*M)*L;t.m06=(v*x-m*E-g*b)*L;t.m07=(h*E-p*x+d*b)*L;t.m08=(o*U-l*A+f*w)*L;t.m09=(i*A-r*U-s*w)*L;t.m10=(m*S-_*x+g*y)*L;t.m11=(c*x-h*S-d*y)*L;t.m12=(l*M-o*R-u*w)*L;t.m13=(r*R-i*M+a*w)*L;t.m14=(_*b-m*T-v*y)*L;t.m15=(h*T-c*b+p*y)*L;return t};Pt.adjoint=function e(t,n){var r=n.m00,i=n.m01,a=n.m02,s=n.m03,o=n.m04,l=n.m05,u=n.m06,f=n.m07,h=n.m08,c=n.m09,p=n.m10,d=n.m11,m=n.m12,_=n.m13,v=n.m14,g=n.m15;t.m00=l*(p*g-d*v)-c*(u*g-f*v)+_*(u*d-f*p);t.m01=-(i*(p*g-d*v)-c*(a*g-s*v)+_*(a*d-s*p));t.m02=i*(u*g-f*v)-l*(a*g-s*v)+_*(a*f-s*u);t.m03=-(i*(u*d-f*p)-l*(a*d-s*p)+c*(a*f-s*u));t.m04=-(o*(p*g-d*v)-h*(u*g-f*v)+m*(u*d-f*p));t.m05=r*(p*g-d*v)-h*(a*g-s*v)+m*(a*d-s*p);t.m06=-(r*(u*g-f*v)-o*(a*g-s*v)+m*(a*f-s*u));t.m07=r*(u*d-f*p)-o*(a*d-s*p)+h*(a*f-s*u);t.m08=o*(c*g-d*_)-h*(l*g-f*_)+m*(l*d-f*c);t.m09=-(r*(c*g-d*_)-h*(i*g-s*_)+m*(i*d-s*c));t.m10=r*(l*g-f*_)-o*(i*g-s*_)+m*(i*f-s*l);t.m11=-(r*(l*d-f*c)-o*(i*d-s*c)+h*(i*f-s*l));t.m12=-(o*(c*v-p*_)-h*(l*v-u*_)+m*(l*p-u*c));t.m13=r*(c*v-p*_)-h*(i*v-a*_)+m*(i*p-a*c);t.m14=-(r*(l*v-u*_)-o*(i*v-a*_)+m*(i*u-a*l));t.m15=r*(l*p-u*c)-o*(i*p-a*c)+h*(i*u-a*l);return t};Pt.determinant=function e(t){var n=t.m00,r=t.m01,i=t.m02,a=t.m03,s=t.m04,o=t.m05,l=t.m06,u=t.m07,f=t.m08,h=t.m09,c=t.m10,p=t.m11,d=t.m12,m=t.m13,_=t.m14,v=t.m15;var g=n*o-r*s;var y=n*l-i*s;var b=n*u-a*s;var x=r*l-i*o;var T=r*u-a*o;var S=i*u-a*l;var E=f*m-h*d;var w=f*_-c*d;var M=f*v-p*d;var A=h*_-c*m;var R=h*v-p*m;var U=c*v-p*_;return g*U-y*R+b*A+x*M-T*w+S*E};Pt.multiply=function e(t,n,r){var i=n.m00,a=n.m01,s=n.m02,o=n.m03,l=n.m04,u=n.m05,f=n.m06,h=n.m07,c=n.m08,p=n.m09,d=n.m10,m=n.m11,_=n.m12,v=n.m13,g=n.m14,y=n.m15;var b=r.m00,x=r.m01,T=r.m02,S=r.m03;t.m00=b*i+x*l+T*c+S*_;t.m01=b*a+x*u+T*p+S*v;t.m02=b*s+x*f+T*d+S*g;t.m03=b*o+x*h+T*m+S*y;b=r.m04;x=r.m05;T=r.m06;S=r.m07;t.m04=b*i+x*l+T*c+S*_;t.m05=b*a+x*u+T*p+S*v;t.m06=b*s+x*f+T*d+S*g;t.m07=b*o+x*h+T*m+S*y;b=r.m08;x=r.m09;T=r.m10;S=r.m11;t.m08=b*i+x*l+T*c+S*_;t.m09=b*a+x*u+T*p+S*v;t.m10=b*s+x*f+T*d+S*g;t.m11=b*o+x*h+T*m+S*y;b=r.m12;x=r.m13;T=r.m14;S=r.m15;t.m12=b*i+x*l+T*c+S*_;t.m13=b*a+x*u+T*p+S*v;t.m14=b*s+x*f+T*d+S*g;t.m15=b*o+x*h+T*m+S*y;return t};Pt.mul=function e(t,n,r){return Pt.multiply(t,n,r)};Pt.translate=function e(t,n,r){var i=r.x,a=r.y,s=r.z,o,l,u,f,h,c,p,d,m,_,v,g;if(n===t){t.m12=n.m00*i+n.m04*a+n.m08*s+n.m12;t.m13=n.m01*i+n.m05*a+n.m09*s+n.m13;t.m14=n.m02*i+n.m06*a+n.m10*s+n.m14;t.m15=n.m03*i+n.m07*a+n.m11*s+n.m15}else{o=n.m00;l=n.m01;u=n.m02;f=n.m03;h=n.m04;c=n.m05;p=n.m06;d=n.m07;m=n.m08;_=n.m09;v=n.m10;g=n.m11;t.m00=o;t.m01=l;t.m02=u;t.m03=f;t.m04=h;t.m05=c;t.m06=p;t.m07=d;t.m08=m;t.m09=_;t.m10=v;t.m11=g;t.m12=o*i+h*a+m*s+n.m12;t.m13=l*i+c*a+_*s+n.m13;t.m14=u*i+p*a+v*s+n.m14;t.m15=f*i+d*a+g*s+n.m15}return t};Pt.scale=function e(t,n,r){var i=r.x,a=r.y,s=r.z;t.m00=n.m00*i;t.m01=n.m01*i;t.m02=n.m02*i;t.m03=n.m03*i;t.m04=n.m04*a;t.m05=n.m05*a;t.m06=n.m06*a;t.m07=n.m07*a;t.m08=n.m08*s;t.m09=n.m09*s;t.m10=n.m10*s;t.m11=n.m11*s;t.m12=n.m12;t.m13=n.m13;t.m14=n.m14;t.m15=n.m15;return t};Pt.rotate=function e(t,n,r,i){var a=i.x,s=i.y,o=i.z;var l,u,f,h,c,p,d,m,_,v,g,y,b,x,T,S,E,w,M,A,R,U,D,L;var O=Math.sqrt(a*a+s*s+o*o);if(Math.abs(O)<Ge){return null}O=1/O;a*=O;s*=O;o*=O;l=Math.sin(r);u=Math.cos(r);f=1-u;h=n.m00;c=n.m01;p=n.m02;d=n.m03;m=n.m04;_=n.m05;v=n.m06;g=n.m07;y=n.m08;b=n.m09;x=n.m10;T=n.m11;S=a*a*f+u;E=s*a*f+o*l;w=o*a*f-s*l;M=a*s*f-o*l;A=s*s*f+u;R=o*s*f+a*l;U=a*o*f+s*l;D=s*o*f-a*l;L=o*o*f+u;t.m00=h*S+m*E+y*w;t.m01=c*S+_*E+b*w;t.m02=p*S+v*E+x*w;t.m03=d*S+g*E+T*w;t.m04=h*M+m*A+y*R;t.m05=c*M+_*A+b*R;t.m06=p*M+v*A+x*R;t.m07=d*M+g*A+T*R;t.m08=h*U+m*D+y*L;t.m09=c*U+_*D+b*L;t.m10=p*U+v*D+x*L;t.m11=d*U+g*D+T*L;if(n!==t){t.m12=n.m12;t.m13=n.m13;t.m14=n.m14;t.m15=n.m15}return t};Pt.rotateX=function e(t,n,r){var i=Math.sin(r),a=Math.cos(r),s=n.m04,o=n.m05,l=n.m06,u=n.m07,f=n.m08,h=n.m09,c=n.m10,p=n.m11;if(n!==t){t.m00=n.m00;t.m01=n.m01;t.m02=n.m02;t.m03=n.m03;t.m12=n.m12;t.m13=n.m13;t.m14=n.m14;t.m15=n.m15}t.m04=s*a+f*i;t.m05=o*a+h*i;t.m06=l*a+c*i;t.m07=u*a+p*i;t.m08=f*a-s*i;t.m09=h*a-o*i;t.m10=c*a-l*i;t.m11=p*a-u*i;return t};Pt.rotateY=function e(t,n,r){var i=Math.sin(r),a=Math.cos(r),s=n.m00,o=n.m01,l=n.m02,u=n.m03,f=n.m08,h=n.m09,c=n.m10,p=n.m11;if(n!==t){t.m04=n.m04;t.m05=n.m05;t.m06=n.m06;t.m07=n.m07;t.m12=n.m12;t.m13=n.m13;t.m14=n.m14;t.m15=n.m15}t.m00=s*a-f*i;t.m01=o*a-h*i;t.m02=l*a-c*i;t.m03=u*a-p*i;t.m08=s*i+f*a;t.m09=o*i+h*a;t.m10=l*i+c*a;t.m11=u*i+p*a;return t};Pt.rotateZ=function e(t,n,r){var i=Math.sin(r),a=Math.cos(r),s=n.m00,o=n.m01,l=n.m02,u=n.m03,f=n.m04,h=n.m05,c=n.m06,p=n.m07;if(n!==t){t.m08=n.m08;t.m09=n.m09;t.m10=n.m10;t.m11=n.m11;t.m12=n.m12;t.m13=n.m13;t.m14=n.m14;t.m15=n.m15}t.m00=s*a+f*i;t.m01=o*a+h*i;t.m02=l*a+c*i;t.m03=u*a+p*i;t.m04=f*a-s*i;t.m05=h*a-o*i;t.m06=c*a-l*i;t.m07=p*a-u*i;return t};Pt.fromTranslation=function e(t,n){t.m00=1;t.m01=0;t.m02=0;t.m03=0;t.m04=0;t.m05=1;t.m06=0;t.m07=0;t.m08=0;t.m09=0;t.m10=1;t.m11=0;t.m12=n.x;t.m13=n.y;t.m14=n.z;t.m15=1;return t};Pt.fromScaling=function e(t,n){t.m00=n.x;t.m01=0;t.m02=0;t.m03=0;t.m04=0;t.m05=n.y;t.m06=0;t.m07=0;t.m08=0;t.m09=0;t.m10=n.z;t.m11=0;t.m12=0;t.m13=0;t.m14=0;t.m15=1;return t};Pt.fromRotation=function e(t,n,r){var i=r.x,a=r.y,s=r.z;var o=Math.sqrt(i*i+a*a+s*s);var l,u,f;if(Math.abs(o)<Ge){return null}o=1/o;i*=o;a*=o;s*=o;l=Math.sin(n);u=Math.cos(n);f=1-u;t.m00=i*i*f+u;t.m01=a*i*f+s*l;t.m02=s*i*f-a*l;t.m03=0;t.m04=i*a*f-s*l;t.m05=a*a*f+u;t.m06=s*a*f+i*l;t.m07=0;t.m08=i*s*f+a*l;t.m09=a*s*f-i*l;t.m10=s*s*f+u;t.m11=0;t.m12=0;t.m13=0;t.m14=0;t.m15=1;return t};Pt.fromXRotation=function e(t,n){var r=Math.sin(n),i=Math.cos(n);t.m00=1;t.m01=0;t.m02=0;t.m03=0;t.m04=0;t.m05=i;t.m06=r;t.m07=0;t.m08=0;t.m09=-r;t.m10=i;t.m11=0;t.m12=0;t.m13=0;t.m14=0;t.m15=1;return t};Pt.fromYRotation=function e(t,n){var r=Math.sin(n),i=Math.cos(n);t.m00=i;t.m01=0;t.m02=-r;t.m03=0;t.m04=0;t.m05=1;t.m06=0;t.m07=0;t.m08=r;t.m09=0;t.m10=i;t.m11=0;t.m12=0;t.m13=0;t.m14=0;t.m15=1;return t};Pt.fromZRotation=function e(t,n){var r=Math.sin(n),i=Math.cos(n);t.m00=i;t.m01=r;t.m02=0;t.m03=0;t.m04=-r;t.m05=i;t.m06=0;t.m07=0;t.m08=0;t.m09=0;t.m10=1;t.m11=0;t.m12=0;t.m13=0;t.m14=0;t.m15=1;return t};Pt.fromRT=function e(t,n,r){var i=n.x,a=n.y,s=n.z,o=n.w;var l=i+i;var u=a+a;var f=s+s;var h=i*l;var c=i*u;var p=i*f;var d=a*u;var m=a*f;var _=s*f;var v=o*l;var g=o*u;var y=o*f;t.m00=1-(d+_);t.m01=c+y;t.m02=p-g;t.m03=0;t.m04=c-y;t.m05=1-(h+_);t.m06=m+v;t.m07=0;t.m08=p+g;t.m09=m-v;t.m10=1-(h+d);t.m11=0;t.m12=r.x;t.m13=r.y;t.m14=r.z;t.m15=1;return t};Pt.getTranslation=function e(t,n){t.x=n.m12;t.y=n.m13;t.z=n.m14;return t};Pt.getScaling=function e(t,n){var r=n.m00,i=n.m01,a=n.m02,s=n.m04,o=n.m05,l=n.m06,u=n.m08,f=n.m09,h=n.m10;t.x=Math.sqrt(r*r+i*i+a*a);t.y=Math.sqrt(s*s+o*o+l*l);t.z=Math.sqrt(u*u+f*f+h*h);return t};Pt.getRotation=function e(t,n){var r=n.m00+n.m05+n.m10;var i=0;if(r>0){i=Math.sqrt(r+1)*2;t.w=.25*i;t.x=(n.m06-n.m09)/i;t.y=(n.m08-n.m02)/i;t.z=(n.m01-n.m04)/i}else if(n.m00>n.m05&n.m00>n.m10){i=Math.sqrt(1+n.m00-n.m05-n.m10)*2;t.w=(n.m06-n.m09)/i;t.x=.25*i;t.y=(n.m01+n.m04)/i;t.z=(n.m08+n.m02)/i}else if(n.m05>n.m10){i=Math.sqrt(1+n.m05-n.m00-n.m10)*2;t.w=(n.m08-n.m02)/i;t.x=(n.m01+n.m04)/i;t.y=.25*i;t.z=(n.m06+n.m09)/i}else{i=Math.sqrt(1+n.m10-n.m00-n.m05)*2;t.w=(n.m01-n.m04)/i;t.x=(n.m08+n.m02)/i;t.y=(n.m06+n.m09)/i;t.z=.25*i}return t};Pt.fromRTS=function e(t,n,r,i){var a=n.x,s=n.y,o=n.z,l=n.w;var u=a+a;var f=s+s;var h=o+o;var c=a*u;var p=a*f;var d=a*h;var m=s*f;var _=s*h;var v=o*h;var g=l*u;var y=l*f;var b=l*h;var x=i.x;var T=i.y;var S=i.z;t.m00=(1-(m+v))*x;t.m01=(p+b)*x;t.m02=(d-y)*x;t.m03=0;t.m04=(p-b)*T;t.m05=(1-(c+v))*T;t.m06=(_+g)*T;t.m07=0;t.m08=(d+y)*S;t.m09=(_-g)*S;t.m10=(1-(c+m))*S;t.m11=0;t.m12=r.x;t.m13=r.y;t.m14=r.z;t.m15=1;return t};Pt.fromRTSOrigin=function e(t,n,r,i,a){var s=n.x,o=n.y,l=n.z,u=n.w;var f=s+s;var h=o+o;var c=l+l;var p=s*f;var d=s*h;var m=s*c;var _=o*h;var v=o*c;var g=l*c;var y=u*f;var b=u*h;var x=u*c;var T=i.x;var S=i.y;var E=i.z;var w=a.x;var M=a.y;var A=a.z;t.m00=(1-(_+g))*T;t.m01=(d+x)*T;t.m02=(m-b)*T;t.m03=0;t.m04=(d-x)*S;t.m05=(1-(p+g))*S;t.m06=(v+y)*S;t.m07=0;t.m08=(m+b)*E;t.m09=(v-y)*E;t.m10=(1-(p+_))*E;t.m11=0;t.m12=r.x+w-(t.m00*w+t.m04*M+t.m08*A);t.m13=r.y+M-(t.m01*w+t.m05*M+t.m09*A);t.m14=r.z+A-(t.m02*w+t.m06*M+t.m10*A);t.m15=1;return t};Pt.fromQuat=function e(t,n){var r=n.x,i=n.y,a=n.z,s=n.w;var o=r+r;var l=i+i;var u=a+a;var f=r*o;var h=i*o;var c=i*l;var p=a*o;var d=a*l;var m=a*u;var _=s*o;var v=s*l;var g=s*u;t.m00=1-c-m;t.m01=h+g;t.m02=p-v;t.m03=0;t.m04=h-g;t.m05=1-f-m;t.m06=d+_;t.m07=0;t.m08=p+v;t.m09=d-_;t.m10=1-f-c;t.m11=0;t.m12=0;t.m13=0;t.m14=0;t.m15=1;return t};Pt.frustum=function e(t,n,r,i,a,s,o){var l=1/(r-n);var u=1/(a-i);var f=1/(s-o);t.m00=s*2*l;t.m01=0;t.m02=0;t.m03=0;t.m04=0;t.m05=s*2*u;t.m06=0;t.m07=0;t.m08=(r+n)*l;t.m09=(a+i)*u;t.m10=(o+s)*f;t.m11=-1;t.m12=0;t.m13=0;t.m14=o*s*2*f;t.m15=0;return t};Pt.perspective=function e(t,n,r,i,a){var s=1/Math.tan(n/2);var o=1/(i-a);t.m00=s/r;t.m01=0;t.m02=0;t.m03=0;t.m04=0;t.m05=s;t.m06=0;t.m07=0;t.m08=0;t.m09=0;t.m10=(a+i)*o;t.m11=-1;t.m12=0;t.m13=0;t.m14=2*a*i*o;t.m15=0;return t};Pt.perspectiveFromFieldOfView=function e(t,n,r,i){var a=Math.tan(n.upDegrees*Math.PI/180);var s=Math.tan(n.downDegrees*Math.PI/180);var o=Math.tan(n.leftDegrees*Math.PI/180);var l=Math.tan(n.rightDegrees*Math.PI/180);var u=2/(o+l);var f=2/(a+s);t.m00=u;t.m01=0;t.m02=0;t.m03=0;t.m04=0;t.m05=f;t.m06=0;t.m07=0;t.m08=-((o-l)*u*.5);t.m09=(a-s)*f*.5;t.m10=i/(r-i);t.m11=-1;t.m12=0;t.m13=0;t.m14=i*r/(r-i);t.m15=0;return t};Pt.ortho=function e(t,n,r,i,a,s,o){var l=1/(n-r);var u=1/(i-a);var f=1/(s-o);t.m00=-2*l;t.m01=0;t.m02=0;t.m03=0;t.m04=0;t.m05=-2*u;t.m06=0;t.m07=0;t.m08=0;t.m09=0;t.m10=2*f;t.m11=0;t.m12=(n+r)*l;t.m13=(a+i)*u;t.m14=(o+s)*f;t.m15=1;return t};Pt.lookAt=function e(t,n,r,i){var a,s,o,l,u,f,h,c,p,d;var m=n.x;var _=n.y;var v=n.z;var g=i.x;var y=i.y;var b=i.z;var x=r.x;var T=r.y;var S=r.z;if(Math.abs(m-x)<Ge&&Math.abs(_-T)<Ge&&Math.abs(v-S)<Ge){return Pt.identity(t)}h=m-x;c=_-T;p=v-S;d=1/Math.sqrt(h*h+c*c+p*p);h*=d;c*=d;p*=d;a=y*p-b*c;s=b*h-g*p;o=g*c-y*h;d=Math.sqrt(a*a+s*s+o*o);if(!d){a=0;s=0;o=0}else{d=1/d;a*=d;s*=d;o*=d}l=c*o-p*s;u=p*a-h*o;f=h*s-c*a;d=Math.sqrt(l*l+u*u+f*f);if(!d){l=0;u=0;f=0}else{d=1/d;l*=d;u*=d;f*=d}t.m00=a;t.m01=l;t.m02=h;t.m03=0;t.m04=s;t.m05=u;t.m06=c;t.m07=0;t.m08=o;t.m09=f;t.m10=p;t.m11=0;t.m12=-(a*m+s*_+o*v);t.m13=-(l*m+u*_+f*v);t.m14=-(h*m+c*_+p*v);t.m15=1;return t};Pt.str=function e(t){return"mat4("+t.m00+", "+t.m01+", "+t.m02+", "+t.m03+", "+t.m04+", "+t.m05+", "+t.m06+", "+t.m07+", "+t.m08+", "+t.m09+", "+t.m10+", "+t.m11+", "+t.m12+", "+t.m13+", "+t.m14+", "+t.m15+")"};Pt.array=function e(t,n){t[0]=n.m00;t[1]=n.m01;t[2]=n.m02;t[3]=n.m03;t[4]=n.m04;t[5]=n.m05;t[6]=n.m06;t[7]=n.m07;t[8]=n.m08;t[9]=n.m09;t[10]=n.m10;t[11]=n.m11;t[12]=n.m12;t[13]=n.m13;t[14]=n.m14;t[15]=n.m15;return t};Pt.frob=function e(t){return Math.sqrt(Math.pow(t.m00,2)+Math.pow(t.m01,2)+Math.pow(t.m02,2)+Math.pow(t.m03,2)+Math.pow(t.m04,2)+Math.pow(t.m05,2)+Math.pow(t.m06,2)+Math.pow(t.m07,2)+Math.pow(t.m08,2)+Math.pow(t.m09,2)+Math.pow(t.m10,2)+Math.pow(t.m11,2)+Math.pow(t.m12,2)+Math.pow(t.m13,2)+Math.pow(t.m14,2)+Math.pow(t.m15,2))};Pt.add=function e(t,n,r){t.m00=n.m00+r.m00;t.m01=n.m01+r.m01;t.m02=n.m02+r.m02;t.m03=n.m03+r.m03;t.m04=n.m04+r.m04;t.m05=n.m05+r.m05;t.m06=n.m06+r.m06;t.m07=n.m07+r.m07;t.m08=n.m08+r.m08;t.m09=n.m09+r.m09;t.m10=n.m10+r.m10;t.m11=n.m11+r.m11;t.m12=n.m12+r.m12;t.m13=n.m13+r.m13;t.m14=n.m14+r.m14;t.m15=n.m15+r.m15;return t};Pt.subtract=function e(t,n,r){t.m00=n.m00-r.m00;t.m01=n.m01-r.m01;t.m02=n.m02-r.m02;t.m03=n.m03-r.m03;t.m04=n.m04-r.m04;t.m05=n.m05-r.m05;t.m06=n.m06-r.m06;t.m07=n.m07-r.m07;t.m08=n.m08-r.m08;t.m09=n.m09-r.m09;t.m10=n.m10-r.m10;t.m11=n.m11-r.m11;t.m12=n.m12-r.m12;t.m13=n.m13-r.m13;t.m14=n.m14-r.m14;t.m15=n.m15-r.m15;return t};Pt.sub=function e(t,n,r){return Pt.subtract(t,n,r)};Pt.multiplyScalar=function e(t,n,r){t.m00=n.m00*r;t.m01=n.m01*r;t.m02=n.m02*r;t.m03=n.m03*r;t.m04=n.m04*r;t.m05=n.m05*r;t.m06=n.m06*r;t.m07=n.m07*r;t.m08=n.m08*r;t.m09=n.m09*r;t.m10=n.m10*r;t.m11=n.m11*r;t.m12=n.m12*r;t.m13=n.m13*r;t.m14=n.m14*r;t.m15=n.m15*r;return t};Pt.multiplyScalarAndAdd=function e(t,n,r,i){t.m00=n.m00+r.m00*i;t.m01=n.m01+r.m01*i;t.m02=n.m02+r.m02*i;t.m03=n.m03+r.m03*i;t.m04=n.m04+r.m04*i;t.m05=n.m05+r.m05*i;t.m06=n.m06+r.m06*i;t.m07=n.m07+r.m07*i;t.m08=n.m08+r.m08*i;t.m09=n.m09+r.m09*i;t.m10=n.m10+r.m10*i;t.m11=n.m11+r.m11*i;t.m12=n.m12+r.m12*i;t.m13=n.m13+r.m13*i;t.m14=n.m14+r.m14*i;t.m15=n.m15+r.m15*i;return t};Pt.exactEquals=function e(t,n){return t.m00===n.m00&&t.m01===n.m01&&t.m02===n.m02&&t.m03===n.m03&&t.m04===n.m04&&t.m05===n.m05&&t.m06===n.m06&&t.m07===n.m07&&t.m08===n.m08&&t.m09===n.m09&&t.m10===n.m10&&t.m11===n.m11&&t.m12===n.m12&&t.m13===n.m13&&t.m14===n.m14&&t.m15===n.m15};Pt.equals=function e(t,n){var r=t.m00,i=t.m01,a=t.m02,s=t.m03,o=t.m04,l=t.m05,u=t.m06,f=t.m07,h=t.m08,c=t.m09,p=t.m10,d=t.m11,m=t.m12,_=t.m13,v=t.m14,g=t.m15;var y=n.m00,b=n.m01,x=n.m02,T=n.m03,S=n.m04,E=n.m05,w=n.m06,M=n.m07,A=n.m08,R=n.m09,U=n.m10,D=n.m11,L=n.m12,O=n.m13,I=n.m14,C=n.m15;return Math.abs(r-y)<=Ge*Math.max(1,Math.abs(r),Math.abs(y))&&Math.abs(i-b)<=Ge*Math.max(1,Math.abs(i),Math.abs(b))&&Math.abs(a-x)<=Ge*Math.max(1,Math.abs(a),Math.abs(x))&&Math.abs(s-T)<=Ge*Math.max(1,Math.abs(s),Math.abs(T))&&Math.abs(o-S)<=Ge*Math.max(1,Math.abs(o),Math.abs(S))&&Math.abs(l-E)<=Ge*Math.max(1,Math.abs(l),Math.abs(E))&&Math.abs(u-w)<=Ge*Math.max(1,Math.abs(u),Math.abs(w))&&Math.abs(f-M)<=Ge*Math.max(1,Math.abs(f),Math.abs(M))&&Math.abs(h-A)<=Ge*Math.max(1,Math.abs(h),Math.abs(A))&&Math.abs(c-R)<=Ge*Math.max(1,Math.abs(c),Math.abs(R))&&Math.abs(p-U)<=Ge*Math.max(1,Math.abs(p),Math.abs(U))&&Math.abs(d-D)<=Ge*Math.max(1,Math.abs(d),Math.abs(D))&&Math.abs(m-L)<=Ge*Math.max(1,Math.abs(m),Math.abs(L))&&Math.abs(_-O)<=Ge*Math.max(1,Math.abs(_),Math.abs(O))&&Math.abs(v-I)<=Ge*Math.max(1,Math.abs(v),Math.abs(I))&&Math.abs(g-C)<=Ge*Math.max(1,Math.abs(g),Math.abs(C))};var Bt=function e(t,n,r){this.r=t;this.g=n;this.b=r};Bt.new=function e(t,n,r){return new Bt(t,n,r)};Bt.create=function e(){return new Bt(1,1,1)};Bt.clone=function e(t){return new Bt(t.r,t.g,t.b)};Bt.copy=function e(t,n){t.r=n.r;t.g=n.g;t.b=n.b;return t};Bt.set=function e(t,n,r,i){t.r=n;t.g=r;t.b=i;return t};Bt.fromHex=function e(t,n){var r=(n>>16)/255;var i=(n>>8&255)/255;var a=(n&255)/255;t.r=r;t.g=i;t.b=a;return t};Bt.add=function e(t,n,r){t.r=n.r+r.r;t.g=n.g+r.g;t.b=n.b+r.b;return t};Bt.subtract=function e(t,n,r){t.r=n.r-r.r;t.g=n.g-r.g;t.b=n.b-r.b;return t};Bt.sub=function e(t,n,r){return Bt.subtract(t,n,r)};Bt.multiply=function e(t,n,r){t.r=n.r*r.r;t.g=n.g*r.g;t.b=n.b*r.b;return t};Bt.mul=function e(t,n,r){return Bt.multiply(t,n,r)};Bt.divide=function e(t,n,r){t.r=n.r/r.r;t.g=n.g/r.g;t.b=n.b/r.b;return t};Bt.div=function e(t,n,r){return Bt.divide(t,n,r)};Bt.scale=function e(t,n,r){t.r=n.r*r;t.g=n.g*r;t.b=n.b*r;return t};Bt.lerp=function e(t,n,r,i){var a=n.r,s=n.g,o=n.b;t.r=a+i*(r.r-a);t.g=s+i*(r.g-s);t.b=o+i*(r.b-o);return t};Bt.str=function e(t){return"color3("+t.r+", "+t.g+", "+t.b+")"};Bt.array=function e(t,n){t[0]=n.r;t[1]=n.g;t[2]=n.b;return t};Bt.exactEquals=function e(t,n){return t.r===n.r&&t.g===n.g&&t.b===n.b};Bt.equals=function e(t,n){var r=t.r,i=t.g,a=t.b;var s=n.r,o=n.g,l=n.b;return Math.abs(r-s)<=Ge*Math.max(1,Math.abs(r),Math.abs(s))&&Math.abs(i-o)<=Ge*Math.max(1,Math.abs(i),Math.abs(o))&&Math.abs(a-l)<=Ge*Math.max(1,Math.abs(a),Math.abs(l))};Bt.hex=function e(t){return t.r*255<<16|t.g*255<<8|t.b*255};var Ft=function e(t,n,r,i){this.r=t;this.g=n;this.b=r;this.a=i};Ft.new=function e(t,n,r,i){return new Ft(t,n,r,i)};Ft.create=function e(){return new Ft(1,1,1,1)};Ft.clone=function e(t){return new Ft(t.r,t.g,t.b,t.a)};Ft.copy=function e(t,n){t.r=n.r;t.g=n.g;t.b=n.b;t.a=n.a;return t};Ft.set=function e(t,n,r,i,a){t.r=n;t.g=r;t.b=i;t.a=a;return t};Ft.fromHex=function e(t,n){var r=(n>>24)/255;var i=(n>>16&255)/255;var a=(n>>8&255)/255;var s=(n&255)/255;t.r=r;t.g=i;t.b=a;t.a=s;return t};Ft.add=function e(t,n,r){t.r=n.r+r.r;t.g=n.g+r.g;t.b=n.b+r.b;t.a=n.a+r.a;return t};Ft.subtract=function e(t,n,r){t.r=n.r-r.r;t.g=n.g-r.g;t.b=n.b-r.b;t.a=n.a-r.a;return t};Ft.sub=function e(t,n,r){return Ft.subtract(t,n,r)};Ft.multiply=function e(t,n,r){t.r=n.r*r.r;t.g=n.g*r.g;t.b=n.b*r.b;t.a=n.a*r.a;return t};Ft.mul=function e(t,n,r){return Ft.multiply(t,n,r)};Ft.divide=function e(t,n,r){t.r=n.r/r.r;t.g=n.g/r.g;t.b=n.b/r.b;t.a=n.a/r.a;return t};Ft.div=function e(t,n,r){return Ft.divide(t,n,r)};Ft.scale=function e(t,n,r){t.r=n.r*r;t.g=n.g*r;t.b=n.b*r;t.a=n.a*r;return t};Ft.lerp=function e(t,n,r,i){var a=n.r,s=n.g,o=n.b,l=n.a;t.r=a+i*(r.r-a);t.g=s+i*(r.g-s);t.b=o+i*(r.b-o);t.a=l+i*(r.a-l);return t};Ft.str=function e(t){return"color4("+t.r+", "+t.g+", "+t.b+", "+t.a+")"};Ft.array=function e(t,n){t[0]=n.r;t[1]=n.g;t[2]=n.b;t[3]=n.a;return t};Ft.exactEquals=function e(t,n){return t.r===n.r&&t.g===n.g&&t.b===n.b&&t.a===n.a};Ft.equals=function e(t,n){var r=t.r,i=t.g,a=t.b,s=t.a;var o=n.r,l=n.g,u=n.b,f=n.a;return Math.abs(r-o)<=Ge*Math.max(1,Math.abs(r),Math.abs(o))&&Math.abs(i-l)<=Ge*Math.max(1,Math.abs(i),Math.abs(l))&&Math.abs(a-u)<=Ge*Math.max(1,Math.abs(a),Math.abs(u))&&Math.abs(s-f)<=Ge*Math.max(1,Math.abs(s),Math.abs(f))};Ft.hex=function e(t){return(t.r*255<<24|t.g*255<<16|t.b*255<<8|t.a*255)>>>0};var zt=At;var kt=Object.freeze({bits:zt,vec2:Rt,vec3:Ut,vec4:Dt,quat:Ot,mat2:It,mat23:Ct,mat3:Lt,mat4:Pt,color3:Bt,color4:Ft,EPSILON:Ge,equals:Ve,approx:He,clamp:We,clamp01:Xe,lerp:je,toRadian:qe,toDegree:Ye,random:Ke,randomRange:Ze,randomRangeInt:Je,pseudoRandom:Qe,pseudoRandomRange:$e,pseudoRandomRangeInt:et,nextPow2:tt,repeat:nt,pingPong:rt,inverseLerp:it});function Nt(e,t){return Ut.dot(t.n,e)-t.d}function Gt(e,t,n){var r=Nt(t,n);return Ut.sub(e,t,Ut.scale(e,n.n,r))}var Vt={point_plane:Nt,pt_point_plane:Gt};var Ht=function(){var e=Ut.zero();return function(t,n,r){Vt.pt_point_plane(e,t.o,n);var i=Ut.dot(e,n.n)/Ut.dot(t.d,n.n);var a=i>=0;if(r&&a){Ut.scale(r,t.d,i);Ut.add(r,r,t.o)}return a}}();var Wt=function(){var e=Ut.zero();return function(t,n,r){Ut.sub(e,t.e,t.s);var i=(n.d-Ut.dot(t.s,n.n))/Ut.dot(e,n.n);var a=i>=0&&i<=1;if(r&&a){Ut.scale(r,e,i);Ut.add(r,r,t.s)}return a}}();var Xt=function(){var e=Ut.zero();var t=Ut.zero();var n=Ut.zero();var r=Ut.zero();var i=Ut.zero();return function(a,s,o){Ut.sub(e,s.b,s.a);Ut.sub(t,s.c,s.a);Ut.cross(n,a.d,t);var l=Ut.dot(e,n);if(l<=0){return false}Ut.sub(r,a.o,s.a);var u=Ut.dot(r,n);if(u<0||u>l){return false}Ut.cross(i,r,e);var f=Ut.dot(a.d,i);if(f<0||u+f>l){return false}if(o){var h=Ut.dot(t,i)/l;Ut.scaleAndAdd(o,a.o,a.d,h)}return true}}();var jt=function(){var e=Ut.zero();var t=Ut.zero();var n=Ut.zero();var r=Ut.zero();var i=Ut.zero();var a=Ut.zero();return function(s,o,l){Ut.sub(e,o.b,o.a);Ut.sub(t,o.c,o.a);Ut.sub(n,s.s,s.e);Ut.cross(i,e,t);var u=Ut.dot(n,i);if(u<=0){return false}Ut.sub(r,s.s,o.a);var f=Ut.dot(r,i);if(f<0||f>u){return false}Ut.cross(a,n,r);var h=Ut.dot(t,a);if(h<0||h>u){return false}var c=-Ut.dot(e,a);if(c<0||h+c>u){return false}if(l){var p=1/u;h*=p;c*=p;var d=1-h-c;Ut.set(l,o.a.x*d+o.b.x*h+o.c.x*c,o.a.y*d+o.b.y*h+o.c.y*c,o.a.z*d+o.b.z*h+o.c.z*c)}return true}}();var qt=function(){var e=Ut.zero();var t=Ut.zero();var n=Ut.zero();var r=Ut.zero();var i=Ut.zero();var a=Ut.zero();var s=Ut.zero();return function(o,l,u,f,h,c,p){Ut.sub(e,l,o);Ut.sub(t,u,o);Ut.sub(n,f,o);Ut.sub(r,h,o);Ut.cross(a,r,e);var d=Ut.dot(t,a);if(d>=0){var m=-Ut.dot(n,a);if(m<0){return false}var _=Ut.dot(Ut.cross(s,e,n),t);if(_<0){return false}if(p){var v=1/(m+d+_);m*=v;d*=v;_*=v;Ut.set(p,u.x*m+f.x*d+h.x*_,u.y*m+f.y*d+h.y*_,u.z*m+f.z*d+h.z*_)}}else{Ut.sub(i,c,o);var g=Ut.dot(i,a);if(g<0){return false}var y=Ut.dot(Ut.cross(s,e,t),i);if(y<0){return false}if(p){d=-d;var b=1/(g+d+y);g*=b;d*=b;y*=b;Ut.set(p,u.x*g+c.x*d+h.x*y,u.y*g+c.y*d+h.y*y,u.z*g+c.z*d+h.z*y)}}return true}}();var Yt=function(){var e=Ut.zero();var t=Ut.zero();var n=Ut.zero();var r=Ut.zero();return function(i,a,s){var o=a.r;t=a.c;n=i.o;r=i.d;Ut.sub(e,t,n);var l=Ut.magnitude(e);var u=Ut.dot(e,r)/Ut.magnitude(r);var f=Math.sqrt(a.r*a.r-(l*l-u*u));var h=u-f;if(f<0||h<0||l<a.r){return false}Ut.scale(s,e,(l-o)/l);return true}}();var Kt=function(){var e=Ut.zero();var t=Ut.zero();var n=Ut.zero();var r=Ut.zero();var i=Ut.zero();var a=Ut.zero();var s=Ut.zero();var o=Ut.zero();var l=new Array(3);var u=new Array(3);var f=new Array(3);var h=new Array(6);return function(c,p,d){l[0]=p.size.x;l[1]=p.size.y;l[2]=p.size.z;e=p.center;t=c.o;n=c.d;Ut.set(r,p.orientation.m00,p.orientation.m01,p.orientation.m02);Ut.set(i,p.orientation.m03,p.orientation.m04,p.orientation.m05);Ut.set(a,p.orientation.m06,p.orientation.m07,p.orientation.m08);Ut.sub(s,e,t);u[0]=Ut.dot(r,n);u[1]=Ut.dot(i,n);u[2]=Ut.dot(a,n);f[0]=Ut.dot(r,s);f[1]=Ut.dot(i,s);f[2]=Ut.dot(a,s);for(var m=0;m<3;++m){if(u[m]===0){if(-f[m]-l[m]>0||-f[m]+l[m]<0){return false}u[m]=1e-7}h[m*2+0]=(f[m]+l[m])/u[m];h[m*2+1]=(f[m]-l[m])/u[m]}var _=Math.max(Math.max(Math.min(h[0],h[1]),Math.min(h[2],h[3])),Math.min(h[4],h[5]));var v=Math.min(Math.min(Math.max(h[0],h[1]),Math.max(h[2],h[3])),Math.max(h[4],h[5]));if(v<0||_>v||_<0){return false}Ut.set(o,_*u[0]+t.x,_*u[1]+t.y,_*u[2]+t.z);Ut.transformMat3(d,o,p.orientation);return true}}();var Zt=function(){var e=Ut.zero(),t=Ut.zero();var n=function(e,t){return e.x<t.x&&e.y<t.y&&e.z<t.z};return function(r,i){Ut.transformMat4(e,i,r.orientation);return n(e,Ut.add(t,r.center,r.size))&&n(Ut.sub(t,r.center,r.size),e)}}();var Jt=function(){var e=function(e,t,n,r){return Math.abs(e.x*t+e.y*n+e.z*r)};return function(t,n){var r=t.size.x*e(n.n,t.orientation.m00,t.orientation.m01,t.orientation.m02)+t.size.y*e(n.n,t.orientation.m03,t.orientation.m04,t.orientation.m05)+t.size.z*e(n.n,t.orientation.m06,t.orientation.m07,t.orientation.m08);var i=Ut.dot(n.n,t.center);if(i+r<n.d){return 1}else if(i-r>n.d){return 0}return-1}}();var Qt=function(e,t){for(var n=0;n<t.planes.length;n++){if(Jt(e,t.planes[n])==1){return false}}return true};var $t=function(){var e=new Array(8),t=0,n=0,r=0;for(var i=0;i<e.length;i++){e[i]=Ut.zero()}var a=function(e,t,n,r){return e.x*t+e.y*n+e.z*r};return function(i,s){var o=0,l=false;for(var u=0;u<s.planes.length;u++){o=Jt(i,s.planes[u]);if(o==1){return false}else if(o==-1){l=true}}if(!l){return true}for(var f=0;f<s.vertices.length;f++){Ut.sub(e[f],s.vertices[f],i.center)}n=0,r=0;for(var h=0;h<s.vertices.length;h++){t=a(e[h],i.orientation.m00,i.orientation.m01,i.orientation.m02);if(t>i.size.x){n++}else if(t<-i.size.x){r++}}if(n==s.vertices.length||r==s.vertices.length){return false}n=0;r=0;for(var c=0;c<s.vertices.length;c++){t=a(e[c],i.orientation.m03,i.orientation.m04,i.orientation.m05);if(t>i.size.y){n++}else if(t<-i.size.y){r++}}if(n==s.vertices.length||r==s.vertices.length){return false}n=0;r=0;for(var p=0;p<s.vertices.length;p++){t=a(e[p],i.orientation.m06,i.orientation.m07,i.orientation.m08);if(t>i.size.z){n++}else if(t<-i.size.z){r++}}if(n==s.vertices.length||r==s.vertices.length){return false}return true}}();var en=function(){var e=new Array(15);for(var t=0;t<15;t++){e[t]=Ut.zero()}var n=new Array(8);for(var r=0;r<8;r++){n[r]=Ut.zero()}var i=Ut.zero();var a=Ut.zero();var s=Ut.zero();var o=Ut.zero();return function(t,r){Ut.set(e[0],t.orientation.m00,t.orientation.m01,t.orientation.m02);Ut.set(e[1],t.orientation.m03,t.orientation.m04,t.orientation.m05);Ut.set(e[2],t.orientation.m06,t.orientation.m07,t.orientation.m08);Ut.set(e[3],r.orientation.m00,r.orientation.m01,r.orientation.m02);Ut.set(e[4],r.orientation.m03,r.orientation.m04,r.orientation.m05);Ut.set(e[5],r.orientation.m06,r.orientation.m07,r.orientation.m08);for(var l=0;l<3;++l){Ut.cross(e[6+l*3+0],e[l],e[0]);Ut.cross(e[6+l*3+1],e[l],e[1]);Ut.cross(e[6+l*3+1],e[l],e[2])}for(var u=0;u<15;++u){if(!f(t,r,e[u])){return false}}return true;function f(e,t,n){var r=0;var i=1;var a=h(e,n);var s=h(t,n);return s[r]<=a[i]&&a[r]<=s[i]}function h(e,t){Ut.add(s,e.center,e.size);Ut.sub(o,e.center,e.size);Ut.set(i,Math.min(s.x,o.x),Math.min(s.y,o.y),Math.min(s.z,o.z));Ut.set(a,Math.max(s.x,o.x),Math.max(s.y,o.y),Math.max(s.z,o.z));Ut.set(n[0],i.x,a.y,a.z);Ut.set(n[1],i.x,a.y,i.z);Ut.set(n[2],i.x,i.y,a.z);Ut.set(n[3],i.x,i.y,i.z);Ut.set(n[4],a.x,a.y,a.z);Ut.set(n[5],a.x,a.y,i.z);Ut.set(n[6],a.x,i.y,a.z);Ut.set(n[7],a.x,i.y,i.z);var r=0;var l=0;r=l=Ut.dot(t,n[0]);for(var u=1;u<8;++u){var f=Ut.dot(t,n[u]);r=f<r?f:r;l=f>l?f:l}var h=[r,l];return h}}}();var tn=function(e,t){var n=Ut.dot(t.n,e.c);var r=e.r*Ut.magnitude(t.n);if(n+r<t.d){return 1}else if(n-r>t.d){return 0}return-1};var nn=function(e,t){for(var n=0;n<t.planes.length;n++){if(tn(e,t.planes[n])==1){return false}}return true};var rn=function(){var e=Ut.zero(),t=[1,-1,1,-1,1,-1];return function(n,r){var i=false,a=[],s=[];for(var o=0;o<r.planes.length;o++){var l=Ut.dot(r.planes[o].n,n.c);var u=Ut.magnitude(r.planes[o].n);var f=n.r*u;s.push(1/u);if(l+f<r.planes[o].d){return false}else if(l-f<r.planes[o].d){i=true;a.push(o)}}if(!i){return true}for(var h=0;h<a.length;h++){Ut.scale(e,r.planes[a[h]].n,n.r*s[a[h]]);Ut.add(e,n.c,e);for(var c=0;c<r.planes.length;c++){if(c==a[h]||c==a[h]+t[c]){continue}if(Ut.dot(r.planes[c].n,e)<r.planes[c].d){return false}}}return true}}();var an=function(){var e=Ut.zero();var t=Ut.zero();return function(n,r){var i=n.r;var a=r.r;e=n.c;t=r.c;var s=Ut.distance(e,t);if(s>i+a){return false}else{return true}}}();var sn=function(){var e=Ut.zero();var t=Ut.zero();var n=Ut.zero();var r=Ut.zero();var i=Ut.zero();var a=new Array(3);var s=new Array(3);return function(o,l){Ut.set(e,l.orientation.m00,l.orientation.m01,l.orientation.m02);Ut.set(t,l.orientation.m03,l.orientation.m04,l.orientation.m05);Ut.set(n,l.orientation.m06,l.orientation.m07,l.orientation.m08);a[0]=e;a[1]=t;a[2]=n;s[0]=l.size.x;s[1]=l.size.y;s[2]=l.size.z;Ut.sub(r,o.c,l.center);Ut.set(i,l.center.x,l.center.y,l.center.z);for(var u=0;u<3;u++){var f=Ut.dot(r,a[u]);if(f>s[u]){f=s[u]}if(f<-s[u]){f=-s[u]}i.x+=f*a[u].x;i.y+=f*a[u].y;i.z+=f*a[u].z}var h=Ut.distance(i,o.c);return h<o.r}}();var on={ray_plane:Ht,line_plane:Wt,ray_triangle:Xt,line_triangle:jt,line_quad:qt,ray_sphere:Yt,ray_box:Kt,box_point:Zt,box_plane:Jt,box_frustum:Qt,box_frustum_accurate:$t,box_box:en,sphere_plane:tn,sphere_frustum:nn,sphere_frustum_accurate:rn,sphere_sphere:an,sphere_box:sn};var ln=function e(t,n,r,i,a,s){this.s=Ut.new(t,n,r);this.e=Ut.new(i,a,s)};var un={};un.create=function(){return new ln(0,0,0,0,0,-1)};un.new=function(e,t,n,r,i,a){return new ln(e,t,n,r,i,a)};un.clone=function(e){return new ln(e.s.x,e.s.y,e.s.z,e.e.x,e.e.y,e.e.z)};un.copy=function(e,t){e.s.x=t.s.x;e.s.y=t.s.y;e.s.z=t.s.z;e.e.x=t.e.x;e.e.y=t.e.y;e.e.z=t.e.z;return e};un.set=function(e,t,n,r,i,a,s){e.s.x=t;e.s.y=n;e.s.z=r;e.e.x=i;e.e.y=a;e.e.z=s;return e};un.length=function(e){return Ut.distance(e.s,e.e)};var fn=function e(t,n,r,i){this.n=Ut.new(t,n,r);this.d=i};var hn={};hn.create=function(){return new fn(0,1,0,0)};hn.new=function(e,t,n,r){return new fn(e,t,n,r)};hn.clone=function(e){return new fn(e.n.x,e.n.y,e.n.z,e.d)};hn.copy=function(e,t){e.n.x=t.n.x;e.n.y=t.n.y;e.n.z=t.n.z;e.d=t.d;return e};hn.set=function(e,t,n,r,i){e.n.x=t;e.n.y=n;e.n.z=r;e.d=i;return e};hn.fromNormalAndPoint=function(e,t,n){Ut.copy(e.n,t);e.d=Ut.dot(t,n);return e};hn.fromPoints=function(){var e=Ut.zero();var t=Ut.zero();return function(n,r,i,a){Ut.sub(e,i,r);Ut.sub(t,a,r);Ut.normalize(n.n,Ut.cross(n.n,e,t));n.d=Ut.dot(n.n,r);return n}}();hn.normalize=function(e,t){var n=Ut.magnitude(t.n);Ut.normalize(e.n,t.n);if(n>0){e.d=t.d/n}return e};var cn=function e(t,n,r,i,a,s){this.o=Ut.new(t,n,r);this.d=Ut.new(i,a,s)};var pn={};pn.create=function(){return new cn(0,0,0,0,0,-1)};pn.new=function(e,t,n,r,i,a){return new cn(e,t,n,r,i,a)};pn.clone=function(e){return new cn(e.o.x,e.o.y,e.o.z,e.d.x,e.d.y,e.d.z)};pn.copy=function(e,t){e.o.x=t.o.x;e.o.y=t.o.y;e.o.z=t.o.z;e.d.x=t.d.x;e.d.y=t.d.y;e.d.z=t.d.z;return e};pn.set=function(e,t,n,r,i,a,s){e.o.x=t;e.o.y=n;e.o.z=r;e.d.x=i;e.d.y=a;e.d.z=s;return e};pn.fromPoints=function(e,t,n){Ut.copy(e.o,t);Ut.normalize(e.d,Ut.sub(e.d,n,t));return e};var dn=function e(t,n,r,i,a,s,o,l,u){this.a=Ut.new(t,n,r);this.b=Ut.new(i,a,s);this.c=Ut.new(o,l,u)};var mn={};mn.create=function(){return new dn(0,0,0,1,0,0,0,1,0)};mn.new=function(e,t,n,r,i,a,s,o,l){return new dn(e,t,n,r,i,a,s,o,l)};mn.clone=function(e){return new dn(e.a.x,e.a.y,e.a.z,e.b.x,e.b.y,e.b.z,e.c.x,e.c.y,e.c.z)};mn.copy=function(e,t){e.a.x=t.a.x;e.a.y=t.a.y;e.a.z=t.a.z;e.b.x=t.b.x;e.b.y=t.b.y;e.b.z=t.b.z;e.c.x=t.c.x;e.c.y=t.c.y;e.c.z=t.c.z;return e};mn.set=function(e,t,n,r,i,a,s,o,l,u){e.a.x=t;e.a.y=n;e.a.z=r;e.b.x=i;e.b.y=a;e.b.z=s;e.c.x=o;e.c.y=l;e.c.z=u;return e};var _n=function e(t,n,r,i){this.c=Ut.new(t,n,r);this.r=i};var vn={};vn.create=function(){return new _n(0,0,0,1)};vn.new=function(e,t,n,r){return new _n(e,t,n,r)};vn.clone=function(e){return new _n(e.c.x,e.c.y,e.c.z,e.r)};vn.copy=function(e,t){e.c.x=t.c.x;e.c.y=t.c.y;e.c.z=t.c.z;e.r=t.r;return e};vn.set=function(e,t,n,r,i){e.c.x=t;e.c.y=n;e.c.z=r;e.r=i;return e};var gn=function e(t,n,r,i,a,s,o,l,u,f,h,c,p,d,m){this.center=Ut.new(t,n,r);this.size=Ut.new(i,a,s);this.orientation=Lt.new(o,l,u,f,h,c,p,d,m)};var yn={};yn.create=function(){return new gn(0,0,0,0,0,0,1,0,0,0,1,0,0,0,1)};yn.new=function(e,t,n,r,i,a,s,o,l,u,f,h,c,p,d){return new gn(e,t,n,r,i,a,s,o,l,u,f,h,c,p,d)};yn.fromPoints=function(){var e=Ut.zero();var t=Ut.zero();return function(n,r){Ut.scale(e,Ut.add(e,n,r),.5);Ut.scale(t,Ut.sub(t,r,n),.5);return new gn(e.x,e.y,e.z,t.x,t.y,t.z,1,0,0,0,1,0,0,0,1)}}();yn.setTransform=function(e,t,n){if(n===void 0)n=null;Lt.fromMat4(e.orientation,t);Pt.getTranslation(e.center,t);if(n){Lt.mul(e.orientation,e.orientation,n.orientation);Ut.add(e.center,e.center,n.center)}return e};yn.clone=function(e){return new gn(e.center.x,e.center.y,e.center.z,e.size.x,e.size.y,e.size.z,e.orientation.m00,e.orientation.m01,e.orientation.m02,e.orientation.m03,e.orientation.m04,e.orientation.m05,e.orientation.m06,e.orientation.m07,e.orientation.m08)};yn.copy=function(e,t){e.center=t.center;e.size=t.size;e.orientation=t.orientation;return e};yn.set=function(e,t,n,r,i,a,s,o,l,u,f,h,c,p,d,m){Ut.set(e.center,t,n,r);Ut.set(e.size,i,a,s);Lt.set(e.orientation,o,l,u,f,h,c,p,d,m);return e};var bn=function e(){};bn.schema={time:{type:"number",default:0},value:{type:"number",default:0},inTangent:{type:"number",default:0},outTangent:{type:"number",default:0}};var xn=function e(t){this._keyFrames=t};xn.prototype.addKey=function e(t){if(this._keyFrames===null){this._keyFrames=[]}this._keyFrames.push(t)};xn.prototype.evaluate=function e(t){var n=this;var r=t;var i=t<0?this._preWrapMode:this._postWrapMode;var a=this._keyFrames[0].time;var s=this._keyFrames[this._keyFrames.length-1].time;switch(i){case"loop":r=nt(t-a,s-a)+a;break;case"pingPong":r=rt(t-a,s-a)+a;break;case"clampForever":r=We(t,a,s);break}var o=0;if(r>this._keyFrames[0].time){if(r>=this._keyFrames[this._keyFrames.length-1].time){o=this._keyFrames.length-2}else{for(var l=0;l<this._keyFrames.length-1;l++){if(r>=n._keyFrames[0].time&&r<=n._keyFrames[l+1].time){o=l;break}}}}var u=this._keyFrames[o];var f=this._keyFrames[o+1];var h=it(u.time,f.time,r);var c=f.time-u.time;var p=u.outTangent*c;var d=f.inTangent*c;var m=h*h;var _=m*h;var v=2*_-3*m+1;var g=_-2*m+h;var y=_-m;var b=-2*_+3*m;return v*u.value+g*p+y*d+b*f.value};xn.schema={keyFrames:{type:"Keyframe",default:null,array:true},preWrapMode:{type:"enums",default:"default",options:["default","once","loop","pingPong","clampForever"]},postWrapMode:{type:"enums",default:"default",options:["default","once","loop","pingPong","clampForever"]}};var Tn=Object.freeze({distance:Vt,intersect:on,line:un,plane:hn,ray:pn,triangle:mn,sphere:vn,box:yn,Keyframe:bn,AnimationCurve:xn});var Sn=Pt.create();var En=Ut.zero();var wn=0;var Mn=function e(){var t=this;this._id=wn++;this._priority=0;this._rect={x:0,y:0,w:1,h:1};this._color=Ft.new(.3,.3,.3,1);this._depth=1;this._stencil=0;this._clearFlags=Ae.CLEAR_COLOR|Ae.CLEAR_DEPTH;this._clearModel=null;this._matView=Pt.create();this._matProj=Pt.create();this._matViewProj=Pt.create();this._matInvViewProj=Pt.create();this._stages=[];this._cullingByID=false;this._framebuffer=null;this._shadowLight=null;this._frustum={};this._frustum.fullUpdate=false;this._frustum.planes=new Array(6);for(var n=0;n<6;++n){t._frustum.planes[n]=hn.create()}this._frustum.vertices=new Array(8);for(var r=0;r<8;++r){t._frustum.vertices[r]=Ut.zero()}};var An={fullUpdate:{configurable:true}};An.fullUpdate.set=function(e){this._frustum.fullUpdate=e};Mn.prototype.getForward=function e(t){return Ut.set(t,-this._matView.m02,-this._matView.m06,-this._matView.m10)};Mn.prototype.getPosition=function e(t){Pt.invert(Sn,this._matView);return Pt.getTranslation(t,Sn)};Mn.prototype.updateFrustum=function e(){var t=this._matViewProj;Ut.set(this._frustum.planes[0].n,t.m03+t.m00,t.m07+t.m04,t.m11+t.m08);this._frustum.planes[0].d=-(t.m15+t.m12);Ut.set(this._frustum.planes[1].n,t.m03-t.m00,t.m07-t.m04,t.m11-t.m08);this._frustum.planes[1].d=-(t.m15-t.m12);Ut.set(this._frustum.planes[2].n,t.m03+t.m01,t.m07+t.m05,t.m11+t.m09);this._frustum.planes[2].d=-(t.m15+t.m13);Ut.set(this._frustum.planes[3].n,t.m03-t.m01,t.m07-t.m05,t.m11-t.m09);this._frustum.planes[3].d=-(t.m15-t.m13);Ut.set(this._frustum.planes[4].n,t.m03+t.m02,t.m07+t.m06,t.m11+t.m10);this._frustum.planes[4].d=-(t.m15+t.m14);Ut.set(this._frustum.planes[5].n,t.m03-t.m02,t.m07-t.m06,t.m11-t.m10);this._frustum.planes[5].d=-(t.m15-t.m14);if(!this._frustum.fullUpdate){return}Ut.set(En,1,1,1);Ut.transformMat4(this._frustum.vertices[0],En,this._matInvViewProj);Ut.set(En,-1,1,1);Ut.transformMat4(this._frustum.vertices[1],En,this._matInvViewProj);Ut.set(En,-1,-1,1);Ut.transformMat4(this._frustum.vertices[2],En,this._matInvViewProj);Ut.set(En,1,-1,1);Ut.transformMat4(this._frustum.vertices[3],En,this._matInvViewProj);Ut.set(En,1,1,-1);Ut.transformMat4(this._frustum.vertices[4],En,this._matInvViewProj);Ut.set(En,-1,1,-1);Ut.transformMat4(this._frustum.vertices[5],En,this._matInvViewProj);Ut.set(En,-1,-1,-1);Ut.transformMat4(this._frustum.vertices[6],En,this._matInvViewProj);Ut.set(En,1,-1,-1);Ut.transformMat4(this._frustum.vertices[7],En,this._matInvViewProj)};Object.defineProperties(Mn.prototype,An);var Rn=Ut.new(0,0,-1);var Un=Pt.create();var Dn=Lt.create();var Ln=Ut.zero();function On(e,t,n){e._node.getWorldRT(t);Pt.invert(t,t);Pt.perspective(n,e._spotAngle*e._spotAngleScale,1,e._shadowMinDepth,e._shadowMaxDepth)}function In(e,t,n){e._node.getWorldRT(t);Pt.invert(t,t);var r=e._shadowFrustumSize/2;Pt.ortho(n,-r,r,-r,r,e._shadowMinDepth,e._shadowMaxDepth)}function Cn(e,t,n){e._node.getWorldRT(t);Pt.invert(t,t);Pt.perspective(n,qe(179),1,e._shadowMinDepth,e._shadowMaxDepth)}var Pn=function e(){this._poolID=-1;this._node=null;this._type=Ae.LIGHT_DIRECTIONAL;this._color=Bt.new(1,1,1);this._intensity=1;this._range=1;this._spotAngle=qe(60);this._spotExp=1;this._directionUniform=new Float32Array(3);this._positionUniform=new Float32Array(3);this._colorUniform=new Float32Array([this._color.r*this._intensity,this._color.g*this._intensity,this._color.b*this._intensity]);this._spotUniform=new Float32Array([Math.cos(this._spotAngle*.5),this._spotExp]);this._shadowType=Ae.SHADOW_NONE;this._shadowFrameBuffer=null;this._shadowMap=null;this._shadowMapDirty=false;this._shadowDepthBuffer=null;this._shadowResolution=1024;this._shadowBias=5e-4;this._shadowDarkness=1;this._shadowMinDepth=1;this._shadowMaxDepth=1e3;this._shadowDepthScale=50;this._frustumEdgeFalloff=0;this._viewProjMatrix=Pt.create();this._spotAngleScale=1;this._shadowFrustumSize=50};var Bn={color:{configurable:true},intensity:{configurable:true},type:{configurable:true},spotAngle:{configurable:true},spotExp:{configurable:true},range:{configurable:true},shadowType:{configurable:true},shadowMap:{configurable:true},viewProjMatrix:{configurable:true},shadowResolution:{configurable:true},shadowBias:{configurable:true},shadowDarkness:{configurable:true},shadowMinDepth:{configurable:true},shadowMaxDepth:{configurable:true},shadowDepthScale:{configurable:true},frustumEdgeFalloff:{configurable:true},shadowFrustumSize:{configurable:true}};Pn.prototype.setNode=function e(t){this._node=t};Pn.prototype.setColor=function e(t,n,r){Bt.set(this._color,t,n,r);this._colorUniform[0]=t*this._intensity;this._colorUniform[1]=n*this._intensity;this._colorUniform[2]=r*this._intensity};Bn.color.get=function(){return this._color};Pn.prototype.setIntensity=function e(t){this._intensity=t;this._colorUniform[0]=t*this._color.r;this._colorUniform[1]=t*this._color.g;this._colorUniform[2]=t*this._color.b};Bn.intensity.get=function(){return this._intensity};Pn.prototype.setType=function e(t){this._type=t};Bn.type.get=function(){return this._type};Pn.prototype.setSpotAngle=function e(t){this._spotAngle=t;this._spotUniform[0]=Math.cos(this._spotAngle*.5)};Bn.spotAngle.get=function(){return this._spotAngle};Pn.prototype.setSpotExp=function e(t){this._spotExp=t;this._spotUniform[1]=t};Bn.spotExp.get=function(){return this._spotExp};Pn.prototype.setRange=function e(t){this._range=t};Bn.range.get=function(){return this._range};Pn.prototype.setShadowType=function e(t){if(this._shadowType===Ae.SHADOW_NONE&&t!==Ae.SHADOW_NONE){this._shadowMapDirty=true}this._shadowType=t};Bn.shadowType.get=function(){return this._shadowType};Bn.shadowMap.get=function(){return this._shadowMap};Bn.viewProjMatrix.get=function(){return this._viewProjMatrix};Pn.prototype.setShadowResolution=function e(t){if(this._shadowResolution!==t){this._shadowMapDirty=true}this._shadowResolution=t};Bn.shadowResolution.get=function(){return this._shadowResolution};Pn.prototype.setShadowBias=function e(t){this._shadowBias=t};Bn.shadowBias.get=function(){return this._shadowBias};Pn.prototype.setShadowDarkness=function e(t){this._shadowDarkness=t};Bn.shadowDarkness.get=function(){return this._shadowDarkness};Pn.prototype.setShadowMinDepth=function e(t){this._shadowMinDepth=t};Bn.shadowMinDepth.get=function(){if(this._type===Ae.LIGHT_DIRECTIONAL){return 1}return this._shadowMinDepth};Pn.prototype.setShadowMaxDepth=function e(t){this._shadowMaxDepth=t};Bn.shadowMaxDepth.get=function(){if(this._type===Ae.LIGHT_DIRECTIONAL){return 1}return this._shadowMaxDepth};Pn.prototype.setShadowDepthScale=function e(t){this._shadowDepthScale=t};Bn.shadowDepthScale.get=function(){return this._shadowDepthScale};Pn.prototype.setFrustumEdgeFalloff=function e(t){this._frustumEdgeFalloff=t};Bn.frustumEdgeFalloff.get=function(){return this._frustumEdgeFalloff};Pn.prototype.setShadowFrustumSize=function e(t){this._shadowFrustumSize=t};Bn.shadowFrustumSize.get=function(){return this._shadowFrustumSize};Pn.prototype.extractView=function e(t,n){t._shadowLight=this;t._priority=-1;t._rect.x=0;t._rect.y=0;t._rect.w=this._shadowResolution;t._rect.h=this._shadowResolution;Ft.set(t._color,1,1,1,1);t._depth=1;t._stencil=1;t._clearFlags=Ae.CLEAR_COLOR|Ae.CLEAR_DEPTH;t._stages=n;t._framebuffer=this._shadowFrameBuffer;switch(this._type){case Ae.LIGHT_SPOT:On(this,t._matView,t._matProj);break;case Ae.LIGHT_DIRECTIONAL:In(this,t._matView,t._matProj);break;case Ae.LIGHT_POINT:Cn(this,t._matView,t._matProj);break;default:console.warn("shadow of this light type is not supported")}Pt.mul(t._matViewProj,t._matProj,t._matView);this._viewProjMatrix=t._matViewProj;Pt.invert(t._matInvViewProj,t._matViewProj);t.updateFrustum()};Pn.prototype._updateLightPositionAndDirection=function e(){this._node.getWorldMatrix(Un);Lt.fromMat4(Dn,Un);Ut.transformMat3(Ln,Rn,Dn);Ut.array(this._directionUniform,Ln);var t=this._positionUniform;t[0]=Un.m12;t[1]=Un.m13;t[2]=Un.m14};Pn.prototype._generateShadowMap=function e(t){this._shadowMap=new Me.Texture2D(t,{width:this._shadowResolution,height:this._shadowResolution,format:Me.TEXTURE_FMT_RGBA8,wrapS:Me.WRAP_CLAMP,wrapT:Me.WRAP_CLAMP});this._shadowDepthBuffer=new Me.RenderBuffer(t,Me.RB_FMT_D16,this._shadowResolution,this._shadowResolution);this._shadowFrameBuffer=new Me.FrameBuffer(t,this._shadowResolution,this._shadowResolution,{colors:[this._shadowMap],depth:this._shadowDepthBuffer})};Pn.prototype._destroyShadowMap=function e(){if(this._shadowMap){this._shadowMap.destroy();this._shadowDepthBuffer.destroy();this._shadowFrameBuffer.destroy();this._shadowMap=null;this._shadowDepthBuffer=null;this._shadowFrameBuffer=null}};Pn.prototype.update=function e(t){this._updateLightPositionAndDirection();if(this._shadowType===Ae.SHADOW_NONE){this._destroyShadowMap()}else if(this._shadowMapDirty){this._destroyShadowMap();this._generateShadowMap(t);this._shadowMapDirty=false}};Object.defineProperties(Pn.prototype,Bn);var Fn=Pt.create();var zn=Pt.create();var kn=Pt.create();var Nn=Pt.create();var Gn=Ut.zero();var Vn=Ut.zero();var Hn=Ut.zero();var Wn=function e(){this._poolID=-1;this._node=null;this._projection=Ae.PROJ_PERSPECTIVE;this._priority=0;this._color=Ft.new(.2,.3,.47,1);this._depth=1;this._stencil=0;this._clearFlags=Ae.CLEAR_COLOR|Ae.CLEAR_DEPTH;this._clearModel=null;this._stages=[];this._framebuffer=null;this._near=.01;this._far=1e3;this._fov=Math.PI/4;this._rect={x:0,y:0,w:1,h:1};this._orthoHeight=10};Wn.prototype.getNode=function e(){return this._node};Wn.prototype.setNode=function e(t){this._node=t};Wn.prototype.getType=function e(){return this._projection};Wn.prototype.setType=function e(t){this._projection=t};Wn.prototype.getPriority=function e(){return this._priority};Wn.prototype.setPriority=function e(t){this._priority=t};Wn.prototype.getOrthoHeight=function e(){return this._orthoHeight};Wn.prototype.setOrthoHeight=function e(t){this._orthoHeight=t};Wn.prototype.getFov=function e(){return this._fov};Wn.prototype.setFov=function e(t){this._fov=t};Wn.prototype.getNear=function e(){return this._near};Wn.prototype.setNear=function e(t){this._near=t};Wn.prototype.getFar=function e(){return this._far};Wn.prototype.setFar=function e(t){this._far=t};Wn.prototype.getColor=function e(t){return Ft.copy(t,this._color)};Wn.prototype.setColor=function e(t,n,r,i){Ft.set(this._color,t,n,r,i)};Wn.prototype.getDepth=function e(){return this._depth};Wn.prototype.setDepth=function e(t){this._depth=t};Wn.prototype.getStencil=function e(){return this._stencil};Wn.prototype.setStencil=function e(t){this._stencil=t};Wn.prototype.getClearFlags=function e(){return this._clearFlags};Wn.prototype.setClearFlags=function e(t){this._clearFlags=t};Wn.prototype.getRect=function e(t){t.x=this._rect.x;t.y=this._rect.y;t.w=this._rect.w;t.h=this._rect.h;return t};Wn.prototype.setRect=function e(t,n,r,i){this._rect.x=t;this._rect.y=n;this._rect.w=r;this._rect.h=i};Wn.prototype.getStages=function e(){return this._stages};Wn.prototype.setStages=function e(t){this._stages=t};Wn.prototype.getFramebuffer=function e(){return this._framebuffer};Wn.prototype.setFramebuffer=function e(t){this._framebuffer=t};Wn.prototype.extractView=function e(t,n,r){t._priority=this._priority;t._rect.x=this._rect.x*n;t._rect.y=this._rect.y*r;t._rect.w=this._rect.w*n;t._rect.h=this._rect.h*r;t._color=this._color;t._depth=this._depth;t._stencil=this._stencil;t._clearFlags=this._clearFlags;t._clearModel=this._clearModel;t._stages=this._stages;t._framebuffer=this._framebuffer;this._node.getWorldRT(t._matView);Pt.invert(t._matView,t._matView);var i=n/r;if(this._projection===Ae.PROJ_PERSPECTIVE){Pt.perspective(t._matProj,this._fov,i,this._near,this._far)}else{var a=this._orthoHeight*i;var s=this._orthoHeight;Pt.ortho(t._matProj,-a,a,-s,s,this._near,this._far)}Pt.mul(t._matViewProj,t._matProj,t._matView);Pt.invert(t._matInvViewProj,t._matViewProj);t.updateFrustum()};Wn.prototype.screenToWorld=function e(t,n,r,i){var a=r/i;var s=this._rect.x*r;var o=this._rect.y*i;var l=this._rect.w*r;var u=this._rect.h*i;this._node.getWorldRT(Fn);Pt.invert(Fn,Fn);if(this._projection===Ae.PROJ_PERSPECTIVE){Pt.perspective(zn,this._fov,a,this._near,this._far)}else{var f=this._orthoHeight*a;var h=this._orthoHeight;Pt.ortho(zn,-f,f,-h,h,this._near,this._far)}Pt.mul(kn,zn,Fn);Pt.invert(Nn,kn);if(this._projection===Ae.PROJ_PERSPECTIVE){Ut.set(t,(n.x-s)*2/l-1,(n.y-o)*2/u-1,1);Ut.transformMat4(t,t,Nn);this._node.getWorldPos(Gn);Ut.lerp(t,Gn,t,n.z/this._far)}else{var c=this._farClip-this._nearClip;Ut.set(t,(n.x-s)*2/l-1,(n.y-o)*2/u-1,(this._far-n.z)/c*2-1);Ut.transformMat4(t,t,Nn)}return t};Wn.prototype.screenPointToRay=function e(t,n,r){this._node.getWorldPos(Hn);this.screenToWorld(Vn,t,n,r);Ut.sub(Vn,Vn,Hn);return pn.new(Hn.x,Hn.y,Hn.z,Vn.x,Vn.y,Vn.z)};Wn.prototype.worldToScreen=function e(t,n,r,i){var a=r/i;var s=this._rect.x*r;var o=this._rect.y*i;var l=this._rect.w*r;var u=this._rect.h*i;this._node.getWorldRT(Fn);Pt.invert(Fn,Fn);if(this._projection===Ae.PROJ_PERSPECTIVE){Pt.perspective(zn,this._fov,a,this._near,this._far)}else{var f=this._orthoHeight*a;var h=this._orthoHeight;Pt.ortho(zn,-f,f,-h,h,this._near,this._far)}Pt.mul(kn,zn,Fn);var c=n.x*kn.m03+n.y*kn.m07+n.z*kn.m11+kn.m15;Ut.transformMat4(t,n,kn);t.x=s+(t.x/c+1)*.5*l;t.y=o+(t.y/c+1)*.5*u;return t};var Xn=function e(){this._type="default";this._poolID=-1;this._node=null;this._inputAssembler=null;this._effect=null;this._defines={};this._dependencies={};this._viewID=-1;this._cameraID=-1;this._userKey=-1;this._castShadow=false;this._boundingBox=null};Xn.prototype.setNode=function e(t){this._node=t};Xn.prototype.setInputAssembler=function e(t){this._inputAssembler=t};Xn.prototype.setEffect=function e(t){if(t){this._effect=t;this._defines=t.extractDefines(Object.create(null));this._dependencies=t.extractDependencies(Object.create(null))}else{this._effect=null;this._defines=Object.create(null);this._dependencies=Object.create(null)}};Xn.prototype.setUserKey=function e(t){this._userKey=t};Xn.prototype.extractDrawItem=function e(t){t.model=this;t.node=this._node;t.ia=this._inputAssembler;t.effect=this._effect;t.defines=this._effect.extractDefines(this._defines);t.dependencies=this._effect.extractDependencies(this._dependencies)};Xn.prototype.createBoundingBox=function e(t,n){if(t===null||t===undefined||n===null||n===undefined){return}this._bbModelSpace=yn.fromPoints(t,n);this._boundingBox=yn.clone(this._bbModelSpace)};var jn=function e(t,n){var r=this;this._cursor=0;this._data=new Array(n);for(var i=0;i<n;++i){r._data[i]=t()}};jn.prototype.request=function e(){var t=this._data[this._cursor];this._cursor=(this._cursor+1)%this._data.length;return t};var qn=32;var Yn=7;var Kn=256;var Zn=[1,10,100,1e3,1e4,1e5,1e6,1e7,1e8,1e9];function Jn(e){if(e<1e5){if(e<100){return e<10?0:1}if(e<1e4){return e<1e3?2:3}return 4}if(e<1e7){return e<1e6?5:6}if(e<1e9){return e<1e8?7:8}return 9}function Qn(e,t){if(e===t){return 0}if(~~e===e&&~~t===t){if(e===0||t===0){return e<t?-1:1}if(e<0||t<0){if(t>=0){return-1}if(e>=0){return 1}e=-e;t=-t}var n=Jn(e);var r=Jn(t);var i=0;if(n<r){e*=Zn[r-n-1];t/=10;i=-1}else if(n>r){t*=Zn[n-r-1];e/=10;i=1}if(e===t){return i}return e<t?-1:1}var a=String(e);var s=String(t);if(a===s){return 0}return a<s?-1:1}function $n(e){var t=0;while(e>=qn){t|=e&1;e>>=1}return e+t}function er(e,t,n,r){var i=t+1;if(i===n){return 1}if(r(e[i++],e[t])<0){while(i<n&&r(e[i],e[i-1])<0){i++}tr(e,t,i)}else{while(i<n&&r(e[i],e[i-1])>=0){i++}}return i-t}function tr(e,t,n){n--;while(t<n){var r=e[t];e[t++]=e[n];e[n--]=r}}function nr(e,t,n,r,i){if(r===t){r++}for(;r<n;r++){var a=e[r];var s=t;var o=r;while(s<o){var l=s+o>>>1;if(i(a,e[l])<0){o=l}else{s=l+1}}var u=r-s;switch(u){case 3:e[s+3]=e[s+2];case 2:e[s+2]=e[s+1];case 1:e[s+1]=e[s];break;default:while(u>0){e[s+u]=e[s+u-1];u--}}e[s]=a}}function rr(e,t,n,r,i,a){var s=0;var o=0;var l=1;if(a(e,t[n+i])>0){o=r-i;while(l<o&&a(e,t[n+i+l])>0){s=l;l=(l<<1)+1;if(l<=0){l=o}}if(l>o){l=o}s+=i;l+=i}else{o=i+1;while(l<o&&a(e,t[n+i-l])<=0){s=l;l=(l<<1)+1;if(l<=0){l=o}}if(l>o){l=o}var u=s;s=i-l;l=i-u}s++;while(s<l){var f=s+(l-s>>>1);if(a(e,t[n+f])>0){s=f+1}else{l=f}}return l}function ir(e,t,n,r,i,a){var s=0;var o=0;var l=1;if(a(e,t[n+i])<0){o=i+1;while(l<o&&a(e,t[n+i-l])<0){s=l;l=(l<<1)+1;if(l<=0){l=o}}if(l>o){l=o}var u=s;s=i-l;l=i-u}else{o=r-i;while(l<o&&a(e,t[n+i+l])>=0){s=l;l=(l<<1)+1;if(l<=0){l=o}}if(l>o){l=o}s+=i;l+=i}s++;while(s<l){var f=s+(l-s>>>1);if(a(e,t[n+f])<0){l=f}else{s=f+1}}return l}var ar=function e(t,n){this.array=t;this.compare=n;this.minGallop=Yn;this.length=t.length;this.tmpStorageLength=Kn;if(this.length<2*Kn){this.tmpStorageLength=this.length>>>1}this.tmp=new Array(this.tmpStorageLength);this.stackLength=this.length<120?5:this.length<1542?10:this.length<119151?19:40;this.runStart=new Array(this.stackLength);this.runLength=new Array(this.stackLength);this.stackSize=0};ar.prototype.pushRun=function e(t,n){this.runStart[this.stackSize]=t;this.runLength[this.stackSize]=n;this.stackSize+=1};ar.prototype.mergeRuns=function e(){var t=this;while(this.stackSize>1){var n=t.stackSize-2;if(n>=1&&t.runLength[n-1]<=t.runLength[n]+t.runLength[n+1]||n>=2&&t.runLength[n-2]<=t.runLength[n]+t.runLength[n-1]){if(t.runLength[n-1]<t.runLength[n+1]){n--}}else if(t.runLength[n]>t.runLength[n+1]){break}t.mergeAt(n)}};ar.prototype.forceMergeRuns=function e(){var t=this;while(this.stackSize>1){var n=t.stackSize-2;if(n>0&&t.runLength[n-1]<t.runLength[n+1]){n--}t.mergeAt(n)}};ar.prototype.mergeAt=function e(t){var n=this.compare;var r=this.array;var i=this.runStart[t];var a=this.runLength[t];var s=this.runStart[t+1];var o=this.runLength[t+1];this.runLength[t]=a+o;if(t===this.stackSize-3){this.runStart[t+1]=this.runStart[t+2];this.runLength[t+1]=this.runLength[t+2]}this.stackSize--;var l=ir(r[s],r,i,a,0,n);i+=l;a-=l;if(a===0){return}o=rr(r[i+a-1],r,s,o,o-1,n);if(o===0){return}if(a<=o){this.mergeLow(i,a,s,o)}else{this.mergeHigh(i,a,s,o)}};ar.prototype.mergeLow=function e(t,n,r,i){var a=this.compare;var s=this.array;var o=this.tmp;var l=0;for(l=0;l<n;l++){o[l]=s[t+l]}var u=0;var f=r;var h=t;s[h++]=s[f++];if(--i===0){for(l=0;l<n;l++){s[h+l]=o[u+l]}return}if(n===1){for(l=0;l<i;l++){s[h+l]=s[f+l]}s[h+i]=o[u];return}var c=this.minGallop;while(true){var p=0;var d=0;var m=false;do{if(a(s[f],o[u])<0){s[h++]=s[f++];d++;p=0;if(--i===0){m=true;break}}else{s[h++]=o[u++];p++;d=0;if(--n===1){m=true;break}}}while((p|d)<c);if(m){break}do{p=ir(s[f],o,u,n,0,a);if(p!==0){for(l=0;l<p;l++){s[h+l]=o[u+l]}h+=p;u+=p;n-=p;if(n<=1){m=true;break}}s[h++]=s[f++];if(--i===0){m=true;break}d=rr(o[u],s,f,i,0,a);if(d!==0){for(l=0;l<d;l++){s[h+l]=s[f+l]}h+=d;f+=d;i-=d;if(i===0){m=true;break}}s[h++]=o[u++];if(--n===1){m=true;break}c--}while(p>=Yn||d>=Yn);if(m){break}if(c<0){c=0}c+=2}this.minGallop=c;if(c<1){this.minGallop=1}if(n===1){for(l=0;l<i;l++){s[h+l]=s[f+l]}s[h+i]=o[u]}else if(n===0){throw new Error("mergeLow preconditions were not respected")}else{for(l=0;l<n;l++){s[h+l]=o[u+l]}}};ar.prototype.mergeHigh=function e(t,n,r,i){var a=this.compare;var s=this.array;var o=this.tmp;var l=0;for(l=0;l<i;l++){o[l]=s[r+l]}var u=t+n-1;var f=i-1;var h=r+i-1;var c=0;var p=0;s[h--]=s[u--];if(--n===0){c=h-(i-1);for(l=0;l<i;l++){s[c+l]=o[l]}return}if(i===1){h-=n;u-=n;p=h+1;c=u+1;for(l=n-1;l>=0;l--){s[p+l]=s[c+l]}s[h]=o[f];return}var d=this.minGallop;while(true){var m=0;var _=0;var v=false;do{if(a(o[f],s[u])<0){s[h--]=s[u--];m++;_=0;if(--n===0){v=true;break}}else{s[h--]=o[f--];_++;m=0;if(--i===1){v=true;break}}}while((m|_)<d);if(v){break}do{m=n-ir(o[f],s,t,n,n-1,a);if(m!==0){h-=m;u-=m;n-=m;p=h+1;c=u+1;for(l=m-1;l>=0;l--){s[p+l]=s[c+l]}if(n===0){v=true;break}}s[h--]=o[f--];if(--i===1){v=true;break}_=i-rr(s[u],o,0,i,i-1,a);if(_!==0){h-=_;f-=_;i-=_;p=h+1;c=f+1;for(l=0;l<_;l++){s[p+l]=o[c+l]}if(i<=1){v=true;break}}s[h--]=s[u--];if(--n===0){v=true;break}d--}while(m>=Yn||_>=Yn);if(v){break}if(d<0){d=0}d+=2}this.minGallop=d;if(d<1){this.minGallop=1}if(i===1){h-=n;u-=n;p=h+1;c=u+1;for(l=n-1;l>=0;l--){s[p+l]=s[c+l]}s[h]=o[f]}else if(i===0){throw new Error("mergeHigh preconditions were not respected")}else{c=h-(i-1);for(l=0;l<i;l++){s[c+l]=o[l]}}};function sr(e,t,n,r){if(!Array.isArray(e)){throw new TypeError("Can only sort arrays")}if(t===undefined){t=0}if(n===undefined){n=e.length}if(r===undefined){r=Qn}var i=n-t;if(i<2){return}var a=0;if(i<qn){a=er(e,t,n,r);nr(e,t,n,t+a,r);return}var s=new ar(e,r);var o=$n(i);do{a=er(e,t,n,r);if(a<o){var l=i;if(l>o){l=o}nr(e,t,t+l,t+a,r);a=l}s.pushRun(t,a);s.mergeRuns();i-=a;t+=a}while(i!==0);s.forceMergeRuns()}var or=function e(t){this._count=0;this._data=new Array(t)};var lr={length:{configurable:true},data:{configurable:true}};or.prototype._resize=function e(t){var n=this;if(t>this._data.length){for(var r=this._data.length;r<t;++r){n._data[r]=undefined}}};lr.length.get=function(){return this._count};lr.data.get=function(){return this._data};or.prototype.reset=function e(){var t=this;for(var n=0;n<this._count;++n){t._data[n]=undefined}this._count=0};or.prototype.push=function e(t){if(this._count>=this._data.length){this._resize(this._data.length*2)}this._data[this._count]=t;++this._count};or.prototype.pop=function e(){--this._count;if(this._count<0){this._count=0}var t=this._data[this._count];this._data[this._count]=undefined;return t};or.prototype.fastRemove=function e(t){if(t>=this._count){return}var n=this._count-1;this._data[t]=this._data[n];this._data[n]=undefined;this._count-=1};or.prototype.indexOf=function e(t){var n=this._data.indexOf(t);if(n>=this._count){return-1}return n};or.prototype.sort=function e(t){return sr(this._data,0,this._count,t)};Object.defineProperties(or.prototype,lr);var ur=function e(t,n){var r=this;this._fn=t;this._idx=n-1;this._frees=new Array(n);for(var i=0;i<n;++i){r._frees[i]=t()}};ur.prototype._expand=function e(t){var n=this;var r=this._frees;this._frees=new Array(t);var i=t-r.length;for(var a=0;a<i;++a){n._frees[a]=n._fn()}for(var s=i,o=0;s<t;++s,++o){n._frees[s]=r[o]}this._idx+=i};ur.prototype.alloc=function e(){if(this._idx<0){this._expand(Math.round(this._frees.length*1.2)+1)}var t=this._frees[this._idx];this._frees[this._idx]=null;--this._idx;return t};ur.prototype.free=function e(t){++this._idx;this._frees[this._idx]=t};var fr=function e(t,n){this._fn=t;this._count=0;this._head=null;this._tail=null;this._pool=new ur(t,n)};var hr={head:{configurable:true},tail:{configurable:true},length:{configurable:true}};hr.head.get=function(){return this._head};hr.tail.get=function(){return this._tail};hr.length.get=function(){return this._count};fr.prototype.add=function e(){var t=this._pool.alloc();if(!this._tail){this._head=t}else{this._tail._next=t;t._prev=this._tail}this._tail=t;this._count+=1;return t};fr.prototype.remove=function e(t){if(t._prev){t._prev._next=t._next}else{this._head=t._next}if(t._next){t._next._prev=t._prev}else{this._tail=t._prev}t._next=null;t._prev=null;this._pool.free(t);this._count-=1};fr.prototype.forEach=function e(t,n){var r=this;var i=this._head;if(!i){return}if(n){t=t.bind(n)}var a=0;var s=i;while(i){s=i._next;t(i,a,r);i=s;++a}};Object.defineProperties(fr.prototype,hr);var cr=function e(t,n){var r=this;this._fn=t;this._count=0;this._data=new Array(n);for(var i=0;i<n;++i){r._data[i]=t()}};var pr={length:{configurable:true},data:{configurable:true}};pr.length.get=function(){return this._count};pr.data.get=function(){return this._data};cr.prototype.reset=function e(){this._count=0};cr.prototype.resize=function e(t){var n=this;if(t>this._data.length){for(var r=this._data.length;r<t;++r){n._data[r]=n._fn()}}};cr.prototype.add=function e(){if(this._count>=this._data.length){this.resize(this._data.length*2)}return this._data[this._count++]};cr.prototype.remove=function e(t){if(t>=this._count){return}var n=this._count-1;var r=this._data[t];this._data[t]=this._data[n];this._data[n]=r;this._count-=1};cr.prototype.sort=function e(t){return sr(this._data,0,this._count,t)};Object.defineProperties(cr.prototype,pr);var dr=Array(8);for(var mr=0;mr<8;++mr){dr[mr]=[]}function _r(e){for(var t=16;t<=1<<28;t*=16){if(e<=t){return t}}return 0}function vr(e){var t,n;t=(e>65535)<<4;e>>>=t;n=(e>255)<<3;e>>>=n;t|=n;n=(e>15)<<2;e>>>=n;t|=n;n=(e>3)<<1;e>>>=n;t|=n;return t|e>>1}function gr(e){var t=_r(e);var n=dr[vr(t)>>2];if(n.length>0){return n.pop()}return new ArrayBuffer(t)}function yr(e){dr[vr(e.byteLength)>>2].push(e)}var br={alloc_int8:function e(t){var n=new Int8Array(gr(t),0,t);if(n.length!==t){return n.subarray(0,t)}return n},alloc_uint8:function e(t){var n=new Uint8Array(gr(t),0,t);if(n.length!==t){return n.subarray(0,t)}return n},alloc_int16:function e(t){var n=new Int16Array(gr(2*t),0,t);if(n.length!==t){return n.subarray(0,t)}return n},alloc_uint16:function e(t){var n=new Uint16Array(gr(2*t),0,t);if(n.length!==t){return n.subarray(0,t)}return n},alloc_int32:function e(t){var n=new Int32Array(gr(4*t),0,t);if(n.length!==t){return n.subarray(0,t)}return n},alloc_uint32:function e(t){var n=new Uint32Array(gr(4*t),0,t);if(n.length!==t){return n.subarray(0,t)}return n},alloc_float32:function e(t){var n=new Float32Array(gr(4*t),0,t);if(n.length!==t){return n.subarray(0,t)}return n},alloc_float64:function e(t){var n=new Float64Array(gr(8*t),0,t);if(n.length!==t){return n.subarray(0,t)}return n},alloc_dataview:function e(t){var n=new DataView(gr(t),0,t);if(n.length!==t){return n.subarray(0,t)}return n},free:function e(t){yr(t.buffer)},reset:function e(){var t=Array(8);for(var n=0;n<8;++n){t[n]=[]}}};var xr=Object.freeze({CircularPool:jn,FixedArray:or,LinkedArray:fr,Pool:ur,RecyclePool:cr,TypedArrayPool:br});function Tr(e){return e?(e^Math.random()*16>>e/4).toString(16):([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,Tr)}var Sr=function e(){};Sr.addLayer=function e(t){if(Sr._nextAvailable>31){return new Error("maximum layers reached.")}Sr[t]=1<<Sr._nextAvailable++;return Sr[t]};Sr.makeInclusiveMask=function e(t){var n=0;for(var r=0;r<t.length;r++){n|=t[r]}return n};Sr.makeExclusiveMask=function e(t){return~Sr.makeInclusiveMask(t)};Sr.check=function e(t,n){return(t&n)==t};Sr._nextAvailable=8;Sr.Default=1<<0;Sr.IgnoreRaycast=1<<1;Sr.RaycastMask=Sr.makeExclusiveMask([Sr.IgnoreRaycast]);var Er=Ut.zero();var wr=Ot.create();var Mr=Lt.create();var Ar=Lt.create();var Rr=Pt.create();var Ur=function e(t){this._id=Tr();this._parent=null;this._children=[];this.name=t||"";this.lpos=Ut.new(0,0,0);this.lscale=Ut.new(1,1,1);this.lrot=Ot.new(0,0,0,1);this.layer=Sr.Default};var Dr={id:{configurable:true},parent:{configurable:true},children:{configurable:true}};Ur.mixin=function e(t){Object.getOwnPropertyNames(Ur.prototype).forEach(function(e){if(t.prototype.hasOwnProperty(e)===false){Object.defineProperty(t.prototype,e,Object.getOwnPropertyDescriptor(Ur.prototype,e))}});t.prototype.__initNode=function(){this._id=Tr();this._parent=null;this._children=[];this.name="";this.lpos=Ut.new(0,0,0);this.lscale=Ut.new(1,1,1);this.lrot=Ot.new(0,0,0,1);this.layer=Sr.Default}};Dr.id.get=function(){return this._id};Dr.parent.get=function(){return this._parent};Dr.children.get=function(){return this._children};Ur.prototype.setParent=function e(t){var n=this;var r=this._parent;if(r===t){return false}var i=t;while(i){if(i===n){return false}i=i._parent}if(r){var a=r._children.length;for(var s=0;s<a;++s){if(r._children[s]===n){r._children.splice(s,1);break}}}this._parent=t;if(t){t._children.push(this)}if(this._onParentChanged){this._onParentChanged(r,t)}return true};Ur.prototype.insertAt=function e(t,n){var r=this;if(!n){return false}var i=this;while(i){if(i===n){return false}i=i._parent}var a=n._parent;var s=this._children.length;t=t<0?0:t>s?s:t;if(a){s=a._children.length;for(var o=0;o<s;++o){if(a._children[o]===n){if(a===r){if(o===t||o===t-1){return false}if(o<t-1){t=t-1}}a._children.splice(o,1);break}}}n._parent=this;this._children.splice(t,0,n);if(n._onParentChanged&&n._parent!==this){n._onParentChanged(a,this)}return true};Ur.prototype.append=function e(t){var n=this;if(!t){return false}var r=this;while(r){if(r===t){return false}r=r._parent}var i=t._parent;if(i){var a=i._children.length;for(var s=0;s<a;++s){if(i._children[s]===t){if(i===n&&s===a-1){return false}i._children.splice(s,1);break}}}t._parent=this;this._children.push(t);if(t._onParentChanged&&t._parent!==this){t._onParentChanged(i,this)}return true};Ur.prototype.remove=function e(){if(this._parent){this._parent.removeChild(this)}};Ur.prototype.removeChild=function e(t){var n=this;var r=this._children.length;for(var i=0;i<r;++i){if(n._children[i]===t){n._children.splice(i,1);t._parent=null;if(t._onParentChanged){t._onParentChanged(n,null)}return true}}return false};Ur.prototype.lookAt=function e(t,n){this.getWorldPos(Er);Ut.sub(Er,Er,t);Ut.normalize(Er,Er);Ot.fromViewUp(wr,Er,n);this.setWorldRot(wr)};Ur.prototype.getWorldPos=function e(t){Ut.copy(t,this.lpos);var n=this._parent;while(n){Ut.mul(t,t,n.lscale);Ut.transformQuat(t,t,n.lrot);Ut.add(t,t,n.lpos);n=n._parent}return t};Ur.prototype.setWorldPos=function e(t){if(this._parent){this._parent.invTransformPoint(this.lpos,t);return}Ut.copy(this.lpos,t)};Ur.prototype.getWorldRot=function e(t){Ot.copy(t,this.lrot);var n=this._parent;while(n){Ot.mul(t,n.lrot,t);n=n._parent}return t};Ur.prototype.setWorldRot=function e(t){if(this._parent){this._parent.getWorldRot(this.lrot);Ot.conjugate(this.lrot,this.lrot);Ot.mul(this.lrot,this.lrot,t);return}Ot.copy(this.lrot,t)};Ur.prototype.getWorldScale=function e(t){this.getWorldRot(wr);Ot.conjugate(wr,wr);Lt.fromQuat(t,wr);this.getWorldRS(Mr);Lt.mul(t,t,Mr);return t};Ur.prototype.invTransformPoint=function e(t,n){if(this._parent){this._parent.invTransformPoint(t,n)}else{Ut.copy(t,n)}Ut.sub(t,t,this.lpos);Ot.conjugate(wr,this.lrot);Ut.transformQuat(t,t,wr);Ut.inverseSafe(Er,this.lscale);Ut.mul(t,t,Er);return t};Ur.prototype.getLocalMatrix=function e(t){Pt.fromRTS(t,this.lrot,this.lpos,this.lscale);return t};Ur.prototype.getWorldMatrix=function e(t){this.getLocalMatrix(t);var n=this._parent;while(n){n.getLocalMatrix(Rr);Pt.mul(t,Rr,t);n=n._parent}return t};Ur.prototype.getWorldRT=function e(t){this._getWorldPosAndRot(Er,wr);Pt.fromRT(t,wr,Er);return t};Ur.prototype.getWorldRS=function e(t){Lt.set(Mr,this.lscale.x,0,0,0,this.lscale.y,0,0,0,this.lscale.z);Lt.fromQuat(Ar,this.lrot);if(this._parent){this._parent.getWorldRS(t);Lt.mul(t,t,Ar);Lt.mul(t,t,Mr)}else{Lt.mul(t,Ar,Mr)}return t};Ur.prototype._getWorldPosAndRot=function e(t,n){Ut.copy(t,this.lpos);Ot.copy(n,this.lrot);var r=this._parent;while(r){Ut.mul(t,t,r.lscale);Ut.transformQuat(t,t,r.lrot);Ut.add(t,t,r.lpos);Ot.mul(n,r.lrot,n);r=r._parent}};Object.defineProperties(Ur.prototype,Dr);function Lr(e,t,n){if(n===void 0)n=0;n+=1;var r=e.children.length;for(var i=0;i<r;++i){var a=e.children[i];var s=t(a,e,n);if(s===false){break}Lr(a,t,n)}}function Or(e,t,n,r){if(r===void 0)r=0;r+=1;var i=e.children.length;for(var a=0;a<i;++a){var s=e.children[a];var o=t(s,e,r);if(o===false){n(s,e,r);break}Or(s,t,n,r);n(s,e,r)}}function Ir(e,t,n){if(n===void 0)n=0;n+=1;var r=e.children.length;for(var i=0;i<r;++i){var a=e.children[i];var s=t(a,e,n);if(s!==false){Ir(a,t,n)}}}function Cr(e){var t=[];t.push(e);Lr(e,function(e){t.push(e)});return t}function Pr(e,t){t.remove();var n=e._parent;if(!n){return}e._parent=null;t._parent=n;var r=n._children.length;for(var i=0;i<r;++i){if(n._children[i]===e){n._children[i]=t;return}}}function Br(e,t,n){if(t===void 0)t=Ur;if(n===void 0)n=null;var r=new t;r.name=e.name;Ut.copy(r.lpos,e.lpos);Ut.copy(r.lscale,e.lscale);Ot.copy(r.lrot,e.lrot);if(n){n(r,e)}return r}function Fr(e,t,n){if(t===void 0)t=Ur;if(n===void 0)n=null;var r=Br(e,t,n);r._children=new Array(e._children.length);for(var i=0;i<e._children.length;++i){var a=e._children[i];var s=Fr(a,t,n);r._children[i]=s;s._parent=r}return r}function zr(e,t){var n=t.split("/");function r(e,t){var i=e.children.length;var a=n[t];for(var s=0;s<i;++s){var o=e.children[s];if(o.name!==a){continue}if(t===n.length-1){return o}else{return r(o,t+1)}}return null}return r(e,0)}var kr={walk:Lr,walk2:Or,walkSibling:Ir,flat:Cr,replace:Pr,clone:Br,deepClone:Fr,find:zr};var Nr=function e(){this._lights=new or(16);this._models=new or(16);this._cameras=new or(16);this._debugCamera=null;this._views=[]};Nr.prototype._add=function e(t,n){if(n._poolID!==-1){return}t.push(n);n._poolID=t.length-1};Nr.prototype._remove=function e(t,n){if(n._poolID===-1){return}t.data[t.length-1]._poolID=n._poolID;t.fastRemove(n._poolID);n._poolID=-1};Nr.prototype.reset=function e(){var t=this;for(var n=0;n<this._models.length;++n){var r=t._models.data[n];r._viewID=-1}};Nr.prototype.setDebugCamera=function e(t){this._debugCamera=t};Nr.prototype.getCameraCount=function e(){return this._cameras.length};Nr.prototype.getCamera=function e(t){return this._cameras.data[t]};Nr.prototype.addCamera=function e(t){this._add(this._cameras,t)};Nr.prototype.removeCamera=function e(t){this._remove(this._cameras,t)};Nr.prototype.getModelCount=function e(){return this._models.length};Nr.prototype.getModel=function e(t){return this._models.data[t]};Nr.prototype.addModel=function e(t){this._add(this._models,t)};Nr.prototype.removeModel=function e(t){this._remove(this._models,t)};Nr.prototype.raycast=function e(t,n,r){var i=this;if(r===void 0)r=Infinity;var a=Infinity,s=a;var o=Ut.zero();for(var l=0;l<this.getModelCount();l++){var u=i.getModel(l);if(!Sr.check(u._node.layer,Sr.RaycastMask)){continue}if(!on.ray_box(n,u._boundingBox,o)){continue}s=Ut.sqrDist(o,n.o);if(s>r*r||s>a){continue}a=s;t.entity=u._node}return a<Infinity};Nr.prototype.getLightCount=function e(){return this._lights.length};Nr.prototype.getLight=function e(t){return this._lights.data[t]};Nr.prototype.addLight=function e(t){this._add(this._lights,t)};Nr.prototype.removeLight=function e(t){this._remove(this._lights,t)};Nr.prototype.addView=function e(t){if(this._views.indexOf(t)===-1){this._views.push(t)}};Nr.prototype.removeView=function e(t){var n=this._views.indexOf(t);if(n!==-1){this._views.splice(n,1)}};var Gr=function(e){function t(){e.call(this);this._type="line-batch";this._lines=new cr(function(){return{start:Ut.zero(),end:Ut.zero(),color:Bt.create(),normal:Ut.zero()}},2e3)}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;var n={vertCount:{configurable:true},lineCount:{configurable:true}};n.vertCount.get=function(){return this._lines.length*2};n.lineCount.get=function(){return this._lines.length};t.prototype.getLine=function e(t){return this._lines.data[t]};t.prototype.addLine=function e(t,n,r,i){var a=this._lines.add();Ut.copy(a.start,t);Ut.copy(a.end,n);if(r){Bt.copy(a.color,r)}if(i){Ut.copy(a.normal,i)}return a};t.prototype.clear=function e(){this._lines.reset()};Object.defineProperties(t.prototype,n);return t}(Xn);var Vr=function(e){function t(){e.call(this);this._type="sprite-batch";this._sprites=new cr(function(){return{refPositions:null,refUVs:null,refColor:null,refIndices:null}},2e3);this._vertCount=0;this._indexCount=0}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;var n={vertCount:{configurable:true},indexCount:{configurable:true},spriteCount:{configurable:true}};n.vertCount.get=function(){return this._vertCount};n.indexCount.get=function(){return this._indexCount};n.spriteCount.get=function(){return this._sprites.length};t.prototype.getSprite=function e(t){return this._sprites.data[t]};t.prototype.addSprite=function e(t,n,r,i){var a=this._sprites.add();a.refPositions=t;a.refUVs=n;a.refColor=r;a.refIndices=i;this._vertCount+=t.length;this._indexCount+=i.length;return a};t.prototype.clear=function e(){this._sprites.reset();this._vertCount=0;this._indexCount=0};Object.defineProperties(t.prototype,n);return t}(Xn);function Hr(e){var t=new Me.VertexBuffer(e._device,new Me.VertexFormat(e._vertAttrs),Me.USAGE_DYNAMIC,null,e._capacity*4);var n=new Array(e._capacity);var r=0;for(var i=0;i<e._capacity;++i){var a=4*i;n[r++]=a;n[r++]=a+1;n[r++]=a+2;n[r++]=a+3;n[r++]=a+2;n[r++]=a+1}var s=new Me.IndexBuffer(e._device,Me.INDEX_FMT_UINT16,Me.USAGE_STATIC,new Uint16Array(n),n.length);e._ia=new Re(t,s)}var Wr=function(e){function t(t,n,r){if(r===void 0)r=[{name:Me.ATTR_POSITION,type:Me.ATTR_TYPE_FLOAT32,num:3},{name:Me.ATTR_UV,type:Me.ATTR_TYPE_FLOAT32,num:3},{name:Me.ATTR_UV0,type:Me.ATTR_TYPE_FLOAT32,num:2},{name:Me.ATTR_COLOR,type:Me.ATTR_TYPE_FLOAT32,num:4}];e.call(this);this._type="particle-batch";this._device=t;this._vertAttrs=r;this._capacity=n;Hr(this);this._vertAttrsSize=this._ia._vertexBuffer._format._bytes/4;this._vdataF32=new Float32Array(n*4*this._vertAttrsSize)}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.setVertexAttributes=function e(t){this._vertAttrs=t;Hr(this);this._vertAttrsSize=this._ia._vertexBuffer._format._bytes/4;this._vdataF32=new Float32Array(this._capacity*4*this._vertAttrsSize)};t.prototype.enableStretchedBillboard=function e(){if(this._vertAttrs.find(function(e){return e.name===Me.ATTR_COLOR0})===undefined){this._vertAttrs.push({name:Me.ATTR_COLOR0,type:Me.ATTR_TYPE_FLOAT32,num:3});this.setVertexAttributes(this._vertAttrs)}};t.prototype.disableStretchedBillboard=function e(){if(this._vertAttrs.find(function(e){return e.name===Me.ATTR_COLOR0})!==undefined){this._vertAttrs.pop();this.setVertexAttributes(this._vertAttrs)}};t.prototype.addParticleVertexData=function e(t,n){var r=this;if(n.length!==this._vertAttrs.length){console.error("particle vertex stream data not match.")}var i=t*this._vertAttrsSize;for(var a=0;a<this._vertAttrs.length;++a){var s=r._vertAttrs[a];if(s.num===1){r._vdataF32[i]=n[a];i++}else if(s.num===2){r._vdataF32[i]=n[a].x;r._vdataF32[i+1]=n[a].y;i+=2}else if(s.num===3){r._vdataF32[i]=n[a].x;r._vdataF32[i+1]=n[a].y;r._vdataF32[i+2]=n[a].z;i+=3}else if(s.num===4){r._vdataF32[i]=n[a].x;r._vdataF32[i+1]=n[a].y;r._vdataF32[i+2]=n[a].z;r._vdataF32[i+3]=n[a].w;i+=4}else{console.error("particle vertex attribute format not support")}}};t.prototype.updateIA=function e(t){this._ia._count=t;this._ia._vertexBuffer.update(0,this._vdataF32)};t.prototype.clear=function e(){this._ia._count=0};t.prototype.destroy=function e(){this._vdataF32.length=0;this._ia._vertexBuffer.destroy();this._ia._indexBuffer.destroy()};return t}(Xn);var Xr=function(e){function t(){e.call(this);this._type="skinning";this._jointsTexture=null}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.setJointsTexture=function e(t){this._jointsTexture=t};return t}(Xn);var jr={"common.frag":"\n#define PI 3.14159265359\n#define PI2 6.28318530718\n#define EPSILON 1e-6\n#define LOG2 1.442695\n#define saturate(a) clamp( a, 0.0, 1.0 )","gamma-correction.frag":"\nvec3 gammaToLinearSpaceRGB(vec3 sRGB) { \n  return sRGB * (sRGB * (sRGB * 0.305306011 + 0.682171111) + 0.012522878);\n}\nvec3 linearToGammaSpaceRGB(vec3 RGB) { \n  vec3 S1 = sqrt(RGB);\n  vec3 S2 = sqrt(S1);\n  vec3 S3 = sqrt(S2);\n  return 0.585122381 * S1 + 0.783140355 * S2 - 0.368262736 * S3;\n}\nvec4 gammaToLinearSpaceRGBA(vec4 sRGBA) {\n  return vec4(gammaToLinearSpaceRGB(sRGBA.rgb), sRGBA.a);\n}\nvec4 linearToGammaSpaceRGBA(vec4 RGBA) {\n  return vec4(linearToGammaSpaceRGB(RGBA.rgb), RGBA.a);\n}\nfloat gammaToLinearSpaceExact(float val) {\n  if (val <= 0.04045) {\n    return val / 12.92;\n  } else if (val < 1.0) {\n    return pow((val + 0.055) / 1.055, 2.4);\n  } else {\n    return pow(val, 2.2);\n  }\n}\nfloat linearToGammaSpaceExact(float val) {\n  if (val <= 0.0) {\n    return 0.0;\n  } else if (val <= 0.0031308) {\n    return 12.92 * val;\n  } else if (val < 1.0) {\n    return 1.055 * pow(val, 0.4166667) - 0.055;\n  } else {\n    return pow(val, 0.45454545);\n  }\n}","packing.frag":"\nvec4 packDepthToRGBA(float depth) {\n  vec4 ret = vec4(1.0, 255.0, 65025.0, 160581375.0) * depth;\n  ret = fract(ret);\n  ret -= ret.yzww * vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0, 0.0);\n  return ret;\n}\nfloat unpackRGBAToDepth(vec4 color) {\n  return dot(color, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n}","pbr-lighting.frag":"\nstruct LightInfo {\n  vec3 lightDir;\n  vec3 radiance;\n};\n#if NUM_DIR_LIGHTS > 0\n  #pragma for id in range(0, NUM_DIR_LIGHTS)\n    uniform vec3 dir_light{id}_direction;\n    uniform vec3 dir_light{id}_color;\n  #pragma endFor\n#endif\n#if NUM_POINT_LIGHTS > 0\n  #pragma for id in range(0, NUM_POINT_LIGHTS)\n    uniform vec3 point_light{id}_position;\n    uniform vec3 point_light{id}_color;\n    uniform float point_light{id}_range;\n  #pragma endFor\n#endif\n#if NUM_SPOT_LIGHTS > 0\n  #pragma for id in range(0, NUM_SPOT_LIGHTS)\n    uniform vec3 spot_light{id}_position;\n    uniform vec3 spot_light{id}_direction;\n    uniform vec3 spot_light{id}_color;\n    uniform vec2 spot_light{id}_spot;\n    uniform float spot_light{id}_range;\n  #pragma endFor\n#endif\nLightInfo computeDirectionalLighting(\n  vec3 lightDirection,\n  vec3 lightColor\n) {\n  LightInfo ret;\n  ret.lightDir = -normalize(lightDirection);\n  ret.radiance = lightColor;\n  return ret;\n}\nLightInfo computePointLighting(\n  vec3 lightPosition,\n  vec3 positionW,\n  vec3 lightColor,\n  float lightRange\n) {\n  LightInfo ret;\n  vec3 lightDir = lightPosition - positionW;\n  float attenuation = max(0., 1.0 - length(lightDir) / lightRange);\n  ret.lightDir = normalize(lightDir);\n  ret.radiance = lightColor * attenuation;\n  return ret;\n}\nLightInfo computeSpotLighting(\n  vec3 lightPosition,\n  vec3 positionW,\n  vec3 lightDirection,\n  vec3 lightColor,\n  vec2 lightSpot,\n  float lightRange\n) {\n  LightInfo ret;\n  vec3 lightDir = lightPosition - positionW;\n  float attenuation = max(0., 1.0 - length(lightDir) / lightRange);\n  float cosConeAngle = max(0., dot(lightDirection, -lightDir));\n  cosConeAngle = cosConeAngle < lightSpot.x ? 0.0 : cosConeAngle;\n  cosConeAngle = pow(cosConeAngle,lightSpot.y);\n  ret.lightDir = normalize(lightDir);\n  ret.radiance = lightColor * attenuation * cosConeAngle;\n  return ret;\n}","phong-lighting.frag":"\nstruct LightInfo {\n  vec3 diffuse;\n  vec3 specular;\n};\nLightInfo computeDirectionalLighting(\n  vec3 lightDirection,\n  vec3 lightColor,\n  vec3 normal,\n  vec3 viewDirection,\n  float glossiness\n) {\n  LightInfo lightingResult;\n  float ndl = 0.0;\n  float ndh = 0.0;\n  vec3 lightDir = -normalize(lightDirection);\n  ndl = max(0.0, dot(normal, lightDir));\n  lightingResult.diffuse = lightColor * ndl;\n  vec3 dirH = normalize(viewDirection + lightDir);\n  ndh = max(0.0, dot(normal, dirH));\n  ndh = (ndl == 0.0) ? 0.0: ndh;\n  ndh = pow(ndh, max(1.0, glossiness * 128.0));\n  lightingResult.specular = lightColor * ndh;\n  return lightingResult;\n}\nLightInfo computePointLighting(\n  vec3 lightPosition,\n  vec3 lightColor,\n  float lightRange,\n  vec3 normal,\n  vec3 positionW,\n  vec3 viewDirection,\n  float glossiness\n) {\n  LightInfo lightingResult;\n  float ndl = 0.0;\n  float ndh = 0.0;\n  vec3 lightDir = vec3(0, 0, 0);\n  float attenuation = 1.0;\n  lightDir = lightPosition - positionW;\n  attenuation = max(0., 1.0 - length(lightDir) / lightRange);\n  lightDir = normalize(lightDir);\n  ndl = max(0.0, dot(normal, lightDir));\n  lightingResult.diffuse = lightColor * ndl * attenuation;\n  vec3 dirH = normalize(viewDirection + lightDir);\n  ndh = max(0.0, dot(normal, dirH));\n  ndh = (ndl == 0.0) ? 0.0: ndh;\n  ndh = pow(ndh, max(1.0, glossiness * 128.0));\n  lightingResult.specular = lightColor * ndh * attenuation;\n  return lightingResult;\n}\nLightInfo computeSpotLighting(\n  vec3 lightPosition,\n  vec3 lightDirection,\n  vec3 lightColor,\n  float lightRange,\n  vec2 lightSpot,\n  vec3 normal,\n  vec3 positionW,\n  vec3 viewDirection,\n  float glossiness\n) {\n  LightInfo lightingResult;\n  float ndl = 0.0;\n  float ndh = 0.0;\n  vec3 lightDir = vec3(0, 0, 0);\n  float attenuation = 1.0;\n  float cosConeAngle = 1.0;\n  lightDir = lightPosition - positionW;\n  attenuation = max(0., 1.0 - length(lightDir) / lightRange);\n  lightDir = normalize(lightDir);\n  cosConeAngle = max(0., dot(lightDirection, -lightDir));\n  cosConeAngle = cosConeAngle < lightSpot.x ? 0.0 : cosConeAngle;\n  cosConeAngle = pow(cosConeAngle,lightSpot.y);\n  ndl = max(0.0, dot(normal, lightDir));\n  lightingResult.diffuse = lightColor * ndl * attenuation * cosConeAngle;\n  vec3 dirH = normalize(viewDirection + lightDir);\n  ndh = max(0.0, dot(normal, dirH));\n  ndh = (ndl == 0.0) ? 0.0: ndh;\n  ndh = pow(ndh, max(1.0, glossiness * 128.0));\n  lightingResult.specular = lightColor * ndh * attenuation * cosConeAngle;\n  return lightingResult;\n}\n#if NUM_DIR_LIGHTS > 0\n  #pragma for id in range(0, NUM_DIR_LIGHTS)\n    uniform vec3 dir_light{id}_direction;\n    uniform vec3 dir_light{id}_color;\n  #pragma endFor\n#endif\n#if NUM_POINT_LIGHTS > 0\n  #pragma for id in range(0, NUM_POINT_LIGHTS)\n    uniform vec3 point_light{id}_position;\n    uniform vec3 point_light{id}_color;\n    uniform float point_light{id}_range;\n  #pragma endFor\n#endif\n#if NUM_SPOT_LIGHTS > 0\n  #pragma for id in range(0, NUM_SPOT_LIGHTS)\n    uniform vec3 spot_light{id}_position;\n    uniform vec3 spot_light{id}_direction;\n    uniform vec3 spot_light{id}_color;\n    uniform float spot_light{id}_range;\n    uniform vec2 spot_light{id}_spot;\n  #pragma endFor\n#endif\nLightInfo getPhongLighting(\n  vec3 normal,\n  vec3 positionW,\n  vec3 viewDirection,\n  float glossiness\n) {\n  LightInfo result;\n  result.diffuse = vec3(0, 0, 0);\n  result.specular = vec3(0, 0, 0);\n  LightInfo dirLighting;\n  #if NUM_DIR_LIGHTS > 0\n    #pragma for id in range(0, NUM_DIR_LIGHTS)\n      dirLighting = computeDirectionalLighting(dir_light{id}_direction,dir_light{id}_color,normal, viewDirection, glossiness);\n      result.diffuse += dirLighting.diffuse;\n      result.specular += dirLighting.specular;\n    #pragma endFor\n  #endif\n  LightInfo pointLighting;\n  #if NUM_POINT_LIGHTS > 0\n    #pragma for id in range(0, NUM_POINT_LIGHTS)\n      pointLighting = computePointLighting(point_light{id}_position, point_light{id}_color, point_light{id}_range,\n                                          normal, positionW, viewDirection, glossiness);\n      result.diffuse += pointLighting.diffuse;\n      result.specular += pointLighting.specular;\n    #pragma endFor\n  #endif\n  LightInfo spotLighting;\n  #if NUM_SPOT_LIGHTS > 0\n    #pragma for id in range(0, NUM_SPOT_LIGHTS)\n      spotLighting = computeSpotLighting(spot_light{id}_position, spot_light{id}_direction, spot_light{id}_color,\n                      spot_light{id}_range, spot_light{id}_spot,normal, positionW, viewDirection, glossiness);\n      result.diffuse += spotLighting.diffuse;\n      result.specular += spotLighting.specular;\n    #pragma endFor\n  #endif\n  return result;\n}\n","shadow-mapping.frag":"\n#if NUM_SHADOW_LIGHTS > 0\n  #pragma for id in range(0, NUM_SHADOW_LIGHTS)\n    uniform sampler2D shadowMap_{id};\n    uniform float darkness_{id};\n    uniform float depthScale_{id};\n    uniform float frustumEdgeFalloff_{id};\n    uniform float bias_{id};\n    uniform vec2 texelSize_{id};\n    varying vec4 pos_lightspace_{id};\n    varying float vDepth_{id};\n  #pragma endFor\n#endif\nfloat computeShadow(sampler2D shadowMap, vec4 pos_lightspace, float bias) {\n  vec3 projCoords = pos_lightspace.xyz / pos_lightspace.w;\n  projCoords = projCoords * 0.5 + 0.5;\n  float closestDepth = unpackRGBAToDepth(texture2D(shadowMap, projCoords.xy));\n  float currentDepth = projCoords.z;\n  float shadow = (currentDepth - bias > closestDepth) ? 0.0 : 1.0;\n  return shadow;\n}\nfloat computeFallOff(float esm, vec2 coords, float frustumEdgeFalloff) {\n  float mask = smoothstep(1.0 - frustumEdgeFalloff, 1.0, clamp(dot(coords, coords), 0.0, 1.0));\n  return mix(esm, 1.0, mask);\n}\nfloat computeShadowESM(sampler2D shadowMap, vec4 pos_lightspace, float vDepth, float depthScale, float darkness, float frustumEdgeFalloff) {\n  vec2 projCoords = pos_lightspace.xy / pos_lightspace.w;\n  vec2 shadowUV = projCoords * 0.5 + vec2(0.5);\n  if (shadowUV.x < 0.0 || shadowUV.x > 1.0 || shadowUV.y < 0.0 || shadowUV.y > 1.0) {\n    return 1.0;\n  }\n  float currentDepth = clamp(vDepth, 0.0, 1.0);\n  float closestDepth = unpackRGBAToDepth(texture2D(shadowMap, shadowUV));\n  \n  float esm = clamp(exp(-depthScale * (currentDepth - closestDepth)), 1.0 - darkness, 1.0);\n  return computeFallOff(esm, projCoords, frustumEdgeFalloff);\n}\nfloat computeShadowPCF(sampler2D shadowMap, vec4 pos_lightspace, float vDepth, float darkness, vec2 texelSize, float frustumEdgeFalloff) {\n  vec2 projCoords = pos_lightspace.xy / pos_lightspace.w;\n  vec2 shadowUV = projCoords * 0.5 + vec2(0.5);\n  if (shadowUV.x < 0.0 || shadowUV.x > 1.0 || shadowUV.y < 0.0 || shadowUV.y > 1.0) {\n    return 1.0;\n  }\n  float currentDepth = clamp(vDepth, 0.0, 1.0);\n  float visibility = 1.0;\n  vec2 poissonDisk[4];\n  poissonDisk[0] = vec2(-0.94201624, -0.39906216);\n  poissonDisk[1] = vec2(0.94558609, -0.76890725);\n  poissonDisk[2] = vec2(-0.094184101, -0.92938870);\n  poissonDisk[3] = vec2(0.34495938, 0.29387760);\n  if (unpackRGBAToDepth(texture2D(shadowMap, shadowUV + poissonDisk[0] * texelSize)) < currentDepth) visibility -= 0.25;\n  if (unpackRGBAToDepth(texture2D(shadowMap, shadowUV + poissonDisk[1] * texelSize)) < currentDepth) visibility -= 0.25;\n  if (unpackRGBAToDepth(texture2D(shadowMap, shadowUV + poissonDisk[2] * texelSize)) < currentDepth) visibility -= 0.25;\n  if (unpackRGBAToDepth(texture2D(shadowMap, shadowUV + poissonDisk[3] * texelSize)) < currentDepth) visibility -= 0.25;\n  return computeFallOff(min(1.0, visibility + 1.0 - darkness), projCoords, frustumEdgeFalloff);\n}","skinning.vert":"\nattribute vec4 a_weights;\nattribute vec4 a_joints;\nuniform sampler2D u_jointsTexture;\nuniform float u_jointsTextureSize;\nmat4 getBoneMatrix(const in float i) {\n  float size = u_jointsTextureSize;\n  float j = i * 4.0;\n  float x = mod(j, size);\n  float y = floor(j / size);\n  float dx = 1.0 / size;\n  float dy = 1.0 / size;\n  y = dy * (y + 0.5);\n  vec4 v1 = texture2D(u_jointsTexture, vec2(dx * (x + 0.5), y));\n  vec4 v2 = texture2D(u_jointsTexture, vec2(dx * (x + 1.5), y));\n  vec4 v3 = texture2D(u_jointsTexture, vec2(dx * (x + 2.5), y));\n  vec4 v4 = texture2D(u_jointsTexture, vec2(dx * (x + 3.5), y));\n  return mat4(v1, v2, v3, v4);\n}\nmat4 skinMatrix() {\n  return\n    getBoneMatrix(a_joints.x) * a_weights.x +\n    getBoneMatrix(a_joints.y) * a_weights.y +\n    getBoneMatrix(a_joints.z) * a_weights.z +\n    getBoneMatrix(a_joints.w) * a_weights.w\n    ;\n}","unpack-normal.frag":"\nvec3 unpackNormal(vec4 nmap) {\n  return nmap.xyz * 2.0 - 1.0;\n}"};var qr=[{name:"gaussian-blur",vert:"\nattribute vec2 a_position;\nattribute vec2 a_uv0;\nvarying vec2 uv;\nvoid main() {\n  uv = a_uv0;\n  gl_Position = vec4(a_position.x, a_position.y, 0.0, 1.0);\n}",frag:"\nvarying vec2 uv;\nuniform sampler2D texture;\nuniform vec2 pixelSize;\n\nvec4 packDepthToRGBA(float depth) {\n  vec4 ret = vec4(1.0, 255.0, 65025.0, 160581375.0) * depth;\n  ret = fract(ret);\n  ret -= ret.yzww * vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0, 0.0);\n  return ret;\n}\nfloat unpackRGBAToDepth(vec4 color) {\n  return dot(color, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n}\nfloat kGaussianBlur[10];\nfloat log_conv(float x0, float X, float y0, float Y) {\n  return ( X + log( x0 + (y0 * exp(Y - X) ) ) );\n}\nvoid main() {\n  kGaussianBlur[0] = 0.0882357;\n  kGaussianBlur[1] = 0.0957407;\n  kGaussianBlur[2] = 0.101786;\n  kGaussianBlur[3] = 0.106026;\n  kGaussianBlur[4] = 0.108212;\n  kGaussianBlur[5] = 0.108212;\n  kGaussianBlur[6] = 0.106026;\n  kGaussianBlur[7] = 0.101786;\n  kGaussianBlur[8] = 0.0957407;\n  kGaussianBlur[9] = 0.0882357;\n  float sample[10];\n  for (int i = 0; i < 10; ++i) {\n    float offset = float(i) - 4.5;\n    vec2 texCoord = vec2( uv.x + offset * pixelSize.x, uv.y + offset * pixelSize.y);\n    sample[i] = unpackRGBAToDepth(texture2D(texture, texCoord));\n  }\n  float sum = log_conv(kGaussianBlur[0], sample[0], kGaussianBlur[1], sample[1]);\n  for (int i = 2; i < 10; ++i) {\n    sum = log_conv(1.0, sum, kGaussianBlur[i], sample[i]);\n  }\n  gl_FragColor = packDepthToRGBA(sum);\n}\n",defines:[]},{name:"grid",vert:"\nattribute vec2 a_uv0;\nattribute vec3 a_position;\nattribute vec3 a_normal;\nuniform mat4 model;\nuniform mat4 viewProj;\nvarying vec2 uv0;\nvarying vec4 pos_w;\n#if USE_WORLD_POS\n  uniform mat3 normalMatrix;\n  varying vec3 normal_w;\n#endif\nvoid main () {\n  uv0 = a_uv0;\n  pos_w = model * vec4(a_position, 1);\n  #if USE_WORLD_POS\n    normal_w = normalMatrix * a_normal;\n  #endif\n  gl_Position = viewProj * pos_w;\n}",frag:"\nvarying vec2 uv0;\nvarying vec4 pos_w;\n#if USE_WORLD_POS\n  varying vec3 normal_w;\n#endif\nuniform vec2 tiling;\nuniform vec3 baseColorWhite;\nuniform vec3 baseColorBlack;\nuniform sampler2D basePattern;\nuniform vec2 basePatternTiling;\nuniform vec2 basePatternOffset;\nuniform vec4 subPatternColor;\nuniform sampler2D subPattern;\nuniform vec2 subPatternTiling;\nuniform vec2 subPatternOffset;\nuniform vec4 subPatternColor2;\nuniform sampler2D subPattern2;\nuniform vec2 subPattern2Tiling;\nuniform vec2 subPattern2Offset;\nvoid main () {\n  vec2 uv = uv0 * tiling;\n  vec2 uvBase = uv * basePatternTiling + basePatternOffset;\n  vec2 uvSub = uv * subPatternTiling + subPatternOffset;\n  vec2 uvSub2 = uv * subPattern2Tiling + subPattern2Offset;\n  #if USE_WORLD_POS\n    vec3 dnormal_w = normalize(normal_w);\n    if (abs(dnormal_w.x)>0.5) { \n      uvBase = (pos_w.zy * tiling * basePatternTiling) + basePatternOffset;\n      uvSub = (pos_w.zy * tiling * subPatternTiling) + subPatternOffset;\n      uvSub2 = (pos_w.zy * tiling * subPattern2Tiling) + subPattern2Offset;\n    } else if (abs(dnormal_w.z)>0.5) { \n      uvBase = (pos_w.xy * tiling * basePatternTiling) + basePatternOffset;\n      uvSub = (pos_w.xy * tiling * subPatternTiling) + subPatternOffset;\n      uvSub2 = (pos_w.xy * tiling * subPattern2Tiling) + subPattern2Offset;\n    } else { \n      uvBase = (pos_w.xz * tiling * basePatternTiling) + basePatternOffset;\n      uvSub = (pos_w.xz * tiling * subPatternTiling) + subPatternOffset;\n      uvSub2 = (pos_w.xz * tiling * subPattern2Tiling) + subPattern2Offset;\n    }\n  #endif\n  vec4 texColBase = texture2D(basePattern, uvBase);\n  vec4 texColSub = texture2D(subPattern, uvSub);\n  vec4 texColSub2 = texture2D(subPattern2, uvSub2);\n  \n  \n  \n  vec4 color = vec4(baseColorWhite,1) * texColBase + vec4(baseColorBlack,1) * (1.0-texColBase);\n  color =\n    color * (1.0 - texColSub) +\n    (subPatternColor * subPatternColor.a + color * (1.0-subPatternColor.a)) * texColSub\n    ;\n  color =\n    color * (1.0 - texColSub2) +\n    (subPatternColor2 * subPatternColor2.a + color * (1.0-subPatternColor2.a)) * texColSub2\n    ;\n  \n  \n  gl_FragColor = color;\n}",defines:[{name:"USE_WORLD_POS"}]},{name:"line",vert:"\nattribute vec3 a_position;\nattribute vec3 a_color;\nuniform mat4 model;\nuniform mat4 viewProj;\nvarying vec3 color;\nvoid main () {\n  vec4 pos = viewProj * model * vec4(a_position, 1);\n  \n  \n  \n  \n  \n  \n  \n  \n  \n  \n  \n  \n  \n  \n  \n  \n  color = a_color;\n  gl_Position = pos;\n}",frag:"\nvarying vec3 color;\nvoid main () {\n  gl_FragColor = vec4(color, 1.0);\n}",defines:[]},{name:"matcap",vert:"\nattribute vec3 a_position;\nattribute vec3 a_normal;\nuniform   mat4 model;\nuniform   mat4 viewProj;\nuniform   mat3 normalMatrix;\nvarying   vec2 matcapUV;\n#if USE_MAIN_TEX\n  attribute vec2 a_uv0;\n  varying   vec2 uv0;\n#endif\n#if USE_SKINNING\n  \nattribute vec4 a_weights;\nattribute vec4 a_joints;\nuniform sampler2D u_jointsTexture;\nuniform float u_jointsTextureSize;\nmat4 getBoneMatrix(const in float i) {\n  float size = u_jointsTextureSize;\n  float j = i * 4.0;\n  float x = mod(j, size);\n  float y = floor(j / size);\n  float dx = 1.0 / size;\n  float dy = 1.0 / size;\n  y = dy * (y + 0.5);\n  vec4 v1 = texture2D(u_jointsTexture, vec2(dx * (x + 0.5), y));\n  vec4 v2 = texture2D(u_jointsTexture, vec2(dx * (x + 1.5), y));\n  vec4 v3 = texture2D(u_jointsTexture, vec2(dx * (x + 2.5), y));\n  vec4 v4 = texture2D(u_jointsTexture, vec2(dx * (x + 3.5), y));\n  return mat4(v1, v2, v3, v4);\n}\nmat4 skinMatrix() {\n  return\n    getBoneMatrix(a_joints.x) * a_weights.x +\n    getBoneMatrix(a_joints.y) * a_weights.y +\n    getBoneMatrix(a_joints.z) * a_weights.z +\n    getBoneMatrix(a_joints.w) * a_weights.w\n    ;\n}\n#endif\nvoid main(void){\n  #if USE_MAIN_TEX\n    uv0 = a_uv0;\n  #endif\n  vec4 pos = vec4(a_position, 1);\n  #if USE_SKINNING\n    mat4 skinMat = skinMatrix();\n    pos = skinMat * pos;\n  #endif\n  pos = viewProj * model * pos;\n  gl_Position = pos;\n  vec4 normal = vec4(a_normal, 0);\n  #if USE_SKINNING\n    normal = skinMat * normal;\n  #endif\n  normal = vec4(normalize(normalMatrix * normal.xyz), 0);\n  matcapUV = normal.xy;\n  matcapUV = matcapUV * 0.5 + 0.5;\n}",frag:"\nprecision mediump float;\nuniform sampler2D matcapTex;\nuniform float colorFactor;\nuniform vec4 color;\nvarying vec2 matcapUV;\n#if USE_MAIN_TEX\n  varying vec2 uv0;\n  uniform sampler2D mainTex;\n#endif\nvoid main(void){\n  vec4 col = vec4(1, 1, 1, 1);\n  col *= color;\n  #if USE_MAIN_TEX\n    col *= texture2D(mainTex, uv0);\n  #endif\n  vec4 matcapColor = texture2D(matcapTex, matcapUV);\n  gl_FragColor = col * colorFactor + matcapColor * (1.0 - colorFactor);\n}",defines:[{name:"USE_MAIN_TEX"},{name:"USE_SKINNING"}]},{name:"particle-add-multiply",vert:"\nattribute vec3 a_position; \nattribute vec3 a_uv;  \nattribute vec2 a_uv0; \nattribute vec4 a_color;\n#if USE_STRETCHED_BILLBOARD\nattribute vec3 a_color0; \n#endif\nuniform vec2 frameTile; \nuniform vec2 mainTiling;\nuniform vec2 mainOffset;\nuniform mat4 model;\nuniform mat4 viewProj;\n#if USE_BILLBOARD || USE_VERTICAL_BILLBOARD\n  uniform mat4 view;\n#endif\n#if USE_STRETCHED_BILLBOARD\n  uniform vec3 eye;\n  uniform float velocityScale;\n  uniform float lengthScale;\n#endif\nvarying vec2 uv;\nvarying vec4 color;\nvoid main () {\n  vec4 pos = vec4(a_position, 1);\n#if USE_STRETCHED_BILLBOARD\n  vec4 velocity = vec4(a_color0.xyz,0);\n#endif\n#if USE_WORLD_SPACE\n  \n#else\n  pos = model * pos;\n  #if USE_STRETCHED_BILLBOARD\n  velocity = model * velocity;\n  #endif\n#endif\n  vec2 cornerOffset = vec2((a_uv.x - 0.5) * a_uv0.x, (a_uv.y - 0.5) * a_uv0.x); \n#if USE_STRETCHED_BILLBOARD\n  \n#else\n  \n  vec2 rotatedOffset;\n  rotatedOffset.x = cos(a_uv0.y) * cornerOffset.x - sin(a_uv0.y) * cornerOffset.y;\n  rotatedOffset.y = sin(a_uv0.y) * cornerOffset.x + cos(a_uv0.y) * cornerOffset.y;\n#endif\n#if USE_BILLBOARD\n  vec3 camRight = normalize(vec3(view[0][0], view[1][0], view[2][0]));\n  vec3 camUp = normalize(vec3(view[0][1], view[1][1], view[2][1]));\n  pos.xyz += (camRight * rotatedOffset.x) + (camUp * rotatedOffset.y);\n#elif USE_STRETCHED_BILLBOARD\n  vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz));\n  vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * a_uv0.x;\n  pos.xyz += (camRight * abs(cornerOffset.x) * sign(cornerOffset.y)) - camUp * a_uv.x;\n#elif USE_HORIZONTAL_BILLBOARD\n  vec3 camRight = vec3(1, 0, 0);\n  vec3 camUp = vec3(0, 0, -1);\n  pos.xyz += (camRight * rotatedOffset.x) + (camUp * rotatedOffset.y);\n#elif USE_VERTICAL_BILLBOARD\n  vec3 camRight = normalize(vec3(view[0][0], view[1][0], view[2][0]));\n  vec3 camUp = vec3(0, 1, 0);\n  pos.xyz += (camRight * rotatedOffset.x) + (camUp * rotatedOffset.y);\n#else\n  pos.x += rotatedOffset.x;\n  pos.y += rotatedOffset.y;\n#endif\n  pos = viewProj * pos;\n  vec2 aniUV = vec2(0, floor(a_uv.z * frameTile.y));\n  aniUV.x = floor(a_uv.z * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n  aniUV.y = frameTile.y - aniUV.y - 1.0;\n  aniUV = (aniUV.xy + a_uv.xy) / vec2(frameTile.x, frameTile.y);\n  uv = aniUV * mainTiling + mainOffset;\n  color = a_color;\n  gl_Position = pos;\n}",frag:"\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvarying vec2 uv;\nvarying vec4 color;\nvoid main () {\n  \n  vec4 col;\n  vec4 texColor = texture2D(mainTexture, uv);\n  col.rgb = tintColor.rgb * texColor.rgb * color.rgb * vec3(2.0);\n  col.a = (1.0 - texColor.a) * (tintColor.a * color.a * 2.0);\n  gl_FragColor = col;\n}",defines:[{name:"USE_SOFT_PARTICLE"},{name:"USE_BILLBOARD"},{name:"USE_STRETCHED_BILLBOARD"},{name:"USE_HORIZONTAL_BILLBOARD"},{name:"USE_VERTICAL_BILLBOARD"},{name:"USE_WORLD_SPACE"}]},{name:"particle-add-smooth",vert:"\nattribute vec3 a_position; \nattribute vec3 a_uv;  \nattribute vec2 a_uv0; \nattribute vec4 a_color;\n#if USE_STRETCHED_BILLBOARD\nattribute vec3 a_color0; \n#endif\nuniform vec2 frameTile;\nuniform vec2 mainTiling;\nuniform vec2 mainOffset;\nuniform mat4 model;\nuniform mat4 viewProj;\n#if USE_BILLBOARD || USE_VERTICAL_BILLBOARD\n  uniform mat4 view;\n#endif\n#if USE_STRETCHED_BILLBOARD\n  uniform vec3 eye;\n  uniform float velocityScale;\n  uniform float lengthScale;\n#endif\nvarying vec2 uv;\nvarying vec4 color;\nvoid main () {\n  vec4 pos = vec4(a_position, 1);\n#if USE_STRETCHED_BILLBOARD\n  vec4 velocity = vec4(a_color0.xyz,0);\n#endif\n#if USE_WORLD_SPACE\n  \n#else\n  pos = model * pos;\n  #if USE_STRETCHED_BILLBOARD\n  velocity = model * velocity;\n  #endif\n#endif\n  vec2 cornerOffset = vec2((a_uv.x - 0.5) * a_uv0.x, (a_uv.y - 0.5) * a_uv0.x);\n#if USE_STRETCHED_BILLBOARD\n  \n#else\n  \n  vec2 rotatedOffset;\n  rotatedOffset.x = cos(a_uv0.y) * cornerOffset.x - sin(a_uv0.y) * cornerOffset.y;\n  rotatedOffset.y = sin(a_uv0.y) * cornerOffset.x + cos(a_uv0.y) * cornerOffset.y;\n#endif\n#if USE_BILLBOARD\n  vec3 camRight = normalize(vec3(view[0][0], view[1][0], view[2][0]));\n  vec3 camUp = normalize(vec3(view[0][1], view[1][1], view[2][1]));\n  pos.xyz += (camRight * rotatedOffset.x) + (camUp * rotatedOffset.y);\n#elif USE_STRETCHED_BILLBOARD\n  vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz));\n  vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * a_uv0.x;\n  pos.xyz += (camRight * abs(cornerOffset.x) * sign(cornerOffset.y)) - camUp * a_uv.x;\n#elif USE_HORIZONTAL_BILLBOARD\n  vec3 camRight = vec3(1, 0, 0);\n  vec3 camUp = vec3(0, 0, -1);\n  pos.xyz += (camRight * rotatedOffset.x) + (camUp * rotatedOffset.y);\n#elif USE_VERTICAL_BILLBOARD\n  vec3 camRight = normalize(vec3(view[0][0], view[1][0], view[2][0]));\n  vec3 camUp = vec3(0, 1, 0);\n  pos.xyz += (camRight * rotatedOffset.x) + (camUp * rotatedOffset.y);\n#else\n  pos.x += rotatedOffset.x;\n  pos.y += rotatedOffset.y;\n#endif\n  pos = viewProj * pos;\n  vec2 aniUV = vec2(0, floor(a_uv.z * frameTile.y));\n  aniUV.x = floor(a_uv.z * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n  aniUV.y = frameTile.y - aniUV.y - 1.0;\n  aniUV = (aniUV.xy + a_uv.xy) / vec2(frameTile.x, frameTile.y);\n  uv = aniUV * mainTiling + mainOffset;\n  color = a_color;\n  gl_Position = pos;\n}",frag:"\nuniform sampler2D mainTexture;\nvarying vec2 uv;\nvarying vec4 color;\nvoid main () {\n  \n  vec4 col = color * texture2D(mainTexture, uv);\n  col.rgb *= col.a;\n  gl_FragColor = col;\n}",defines:[{name:"USE_SOFT_PARTICLE"},{name:"USE_BILLBOARD"},{name:"USE_STRETCHED_BILLBOARD"},{name:"USE_HORIZONTAL_BILLBOARD"},{name:"USE_VERTICAL_BILLBOARD"},{name:"USE_WORLD_SPACE"}]},{name:"particle-add",vert:"\nattribute vec3 a_position; \nattribute vec3 a_uv;  \nattribute vec2 a_uv0; \nattribute vec4 a_color;\n#if USE_STRETCHED_BILLBOARD\nattribute vec3 a_color0; \n#endif\nuniform vec2 frameTile;\nuniform vec2 mainTiling;\nuniform vec2 mainOffset;\nuniform mat4 model;\nuniform mat4 viewProj;\n#if USE_BILLBOARD || USE_VERTICAL_BILLBOARD\n  uniform mat4 view;\n#endif\n#if USE_STRETCHED_BILLBOARD\n  uniform vec3 eye;\n  uniform float velocityScale;\n  uniform float lengthScale;\n#endif\nvarying vec2 uv;\nvarying vec4 color;\nvoid main () {\n  vec4 pos = vec4(a_position, 1);\n#if USE_STRETCHED_BILLBOARD\n  vec4 velocity = vec4(a_color0.xyz,0);\n#endif\n#if USE_WORLD_SPACE\n  \n#else\n  pos = model * pos;\n  #if USE_STRETCHED_BILLBOARD\n  velocity = model * velocity;\n  #endif\n#endif\n  vec2 cornerOffset = vec2((a_uv.x - 0.5) * a_uv0.x, (a_uv.y - 0.5) * a_uv0.x);\n#if USE_STRETCHED_BILLBOARD\n  \n#else\n  \n  vec2 rotatedOffset;\n  rotatedOffset.x = cos(a_uv0.y) * cornerOffset.x - sin(a_uv0.y) * cornerOffset.y;\n  rotatedOffset.y = sin(a_uv0.y) * cornerOffset.x + cos(a_uv0.y) * cornerOffset.y;\n#endif\n#if USE_BILLBOARD\n  vec3 camRight = normalize(vec3(view[0][0], view[1][0], view[2][0]));\n  vec3 camUp = normalize(vec3(view[0][1], view[1][1], view[2][1]));\n  pos.xyz += (camRight * rotatedOffset.x) + (camUp * rotatedOffset.y);\n#elif USE_STRETCHED_BILLBOARD\n  vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz));\n  vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * a_uv0.x;\n  pos.xyz += (camRight * abs(cornerOffset.x) * sign(cornerOffset.y)) - camUp * a_uv.x;\n#elif USE_HORIZONTAL_BILLBOARD\n  vec3 camRight = vec3(1, 0, 0);\n  vec3 camUp = vec3(0, 0, -1);\n  pos.xyz += (camRight * rotatedOffset.x) + (camUp * rotatedOffset.y);\n#elif USE_VERTICAL_BILLBOARD\n  vec3 camRight = normalize(vec3(view[0][0], view[1][0], view[2][0]));\n  vec3 camUp = vec3(0, 1, 0);\n  pos.xyz += (camRight * rotatedOffset.x) + (camUp * rotatedOffset.y);\n#else\n  pos.x += rotatedOffset.x;\n  pos.y += rotatedOffset.y;\n#endif\n  pos = viewProj * pos;\n  vec2 aniUV = vec2(0, floor(a_uv.z * frameTile.y));\n  aniUV.x = floor(a_uv.z * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n  aniUV.y = frameTile.y - aniUV.y - 1.0;\n  aniUV = (aniUV.xy + a_uv.xy) / vec2(frameTile.x, frameTile.y);\n  uv = aniUV * mainTiling + mainOffset;\n  color = a_color;\n  gl_Position = pos;\n}",frag:"\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvarying vec2 uv;\nvarying vec4 color;\nvoid main () {\n  \n  gl_FragColor = 2.0 * color * tintColor * texture2D(mainTexture, uv);\n}",defines:[{name:"USE_SOFT_PARTICLE"},{name:"USE_BILLBOARD"},{name:"USE_STRETCHED_BILLBOARD"},{name:"USE_HORIZONTAL_BILLBOARD"},{name:"USE_VERTICAL_BILLBOARD"},{name:"USE_WORLD_SPACE"}]},{name:"particle-alpha-blend",vert:"\nattribute vec3 a_position; \nattribute vec3 a_uv;  \nattribute vec2 a_uv0; \nattribute vec4 a_color;\n#if USE_STRETCHED_BILLBOARD\nattribute vec3 a_color0; \n#endif\nuniform vec2 frameTile;\nuniform vec2 mainTiling;\nuniform vec2 mainOffset;\nuniform mat4 model;\nuniform mat4 viewProj;\n#if USE_BILLBOARD || USE_VERTICAL_BILLBOARD\n  uniform mat4 view;\n#endif\n#if USE_STRETCHED_BILLBOARD\n  uniform vec3 eye;\n  uniform float velocityScale;\n  uniform float lengthScale;\n#endif\nvarying vec2 uv;\nvarying vec4 color;\nvoid main () {\n  vec4 pos = vec4(a_position, 1);\n#if USE_STRETCHED_BILLBOARD\n  vec4 velocity = vec4(a_color0.xyz,0);\n#endif\n#if USE_WORLD_SPACE\n  \n#else\n  pos = model * pos;\n  #if USE_STRETCHED_BILLBOARD\n  velocity = model * velocity;\n  #endif\n#endif\n  vec2 cornerOffset = vec2((a_uv.x - 0.5) * a_uv0.x, (a_uv.y - 0.5) * a_uv0.x); \n#if USE_STRETCHED_BILLBOARD\n  \n#else\n  \n  vec2 rotatedOffset;\n  rotatedOffset.x = cos(a_uv0.y) * cornerOffset.x - sin(a_uv0.y) * cornerOffset.y;\n  rotatedOffset.y = sin(a_uv0.y) * cornerOffset.x + cos(a_uv0.y) * cornerOffset.y;\n#endif\n#if USE_BILLBOARD\n  vec3 camRight = normalize(vec3(view[0][0], view[1][0], view[2][0]));\n  vec3 camUp = normalize(vec3(view[0][1], view[1][1], view[2][1]));\n  pos.xyz += (camRight * rotatedOffset.x) + (camUp * rotatedOffset.y);\n#elif USE_STRETCHED_BILLBOARD\n  vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz));\n  vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * a_uv0.x;\n  pos.xyz += (camRight * abs(cornerOffset.x) * sign(cornerOffset.y)) - camUp * a_uv.x;\n#elif USE_HORIZONTAL_BILLBOARD\n  vec3 camRight = vec3(1, 0, 0);\n  vec3 camUp = vec3(0, 0, -1);\n  pos.xyz += (camRight * rotatedOffset.x) + (camUp * rotatedOffset.y);\n#elif USE_VERTICAL_BILLBOARD\n  vec3 camRight = normalize(vec3(view[0][0], view[1][0], view[2][0]));\n  vec3 camUp = vec3(0, 1, 0);\n  pos.xyz += (camRight * rotatedOffset.x) + (camUp * rotatedOffset.y);\n#else\n  pos.x += rotatedOffset.x;\n  pos.y += rotatedOffset.y;\n#endif\n  pos = viewProj * pos;\n  vec2 aniUV = vec2(0, floor(a_uv.z * frameTile.y));\n  aniUV.x = floor(a_uv.z * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n  aniUV.y = frameTile.y - aniUV.y - 1.0;\n  aniUV = (aniUV.xy + a_uv.xy) / vec2(frameTile.x, frameTile.y);\n  uv = aniUV * mainTiling + mainOffset;\n  color = a_color;\n  gl_Position = pos;\n}",frag:"\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvarying vec2 uv;\nvarying vec4 color;\nvoid main () {\n  \n  gl_FragColor = 2.0 * color * tintColor * texture2D(mainTexture, uv);\n}",defines:[{name:"USE_SOFT_PARTICLE"},{name:"USE_BILLBOARD"},{name:"USE_STRETCHED_BILLBOARD"},{name:"USE_HORIZONTAL_BILLBOARD"},{name:"USE_VERTICAL_BILLBOARD"},{name:"USE_WORLD_SPACE"}]},{name:"particle-premultiply-blend",vert:"\nattribute vec3 a_position; \nattribute vec3 a_uv;  \nattribute vec2 a_uv0; \nattribute vec4 a_color;\n#if USE_STRETCHED_BILLBOARD\nattribute vec3 a_color0; \n#endif\nuniform vec2 frameTile;\nuniform vec2 mainTiling;\nuniform vec2 mainOffset;\nuniform mat4 model;\nuniform mat4 viewProj;\n#if USE_BILLBOARD || USE_VERTICAL_BILLBOARD\n  uniform mat4 view;\n#endif\n#if USE_STRETCHED_BILLBOARD\n  uniform vec3 eye;\n  uniform float velocityScale;\n  uniform float lengthScale;\n#endif\nvarying vec2 uv;\nvarying vec4 color;\nvoid main () {\n  vec4 pos = vec4(a_position, 1);\n#if USE_STRETCHED_BILLBOARD\n  vec4 velocity = vec4(a_color0.xyz,0);\n#endif\n#if USE_WORLD_SPACE\n  \n#else\n  pos = model * pos;\n  #if USE_STRETCHED_BILLBOARD\n  velocity = model * velocity;\n  #endif\n#endif\n  vec2 cornerOffset = vec2((a_uv.x - 0.5) * a_uv0.x, (a_uv.y - 0.5) * a_uv0.x);\n#if USE_STRETCHED_BILLBOARD\n  \n#else\n  \n  vec2 rotatedOffset;\n  rotatedOffset.x = cos(a_uv0.y) * cornerOffset.x - sin(a_uv0.y) * cornerOffset.y;\n  rotatedOffset.y = sin(a_uv0.y) * cornerOffset.x + cos(a_uv0.y) * cornerOffset.y;\n#endif\n#if USE_BILLBOARD\n  vec3 camRight = normalize(vec3(view[0][0], view[1][0], view[2][0]));\n  vec3 camUp = normalize(vec3(view[0][1], view[1][1], view[2][1]));\n  pos.xyz += (camRight * rotatedOffset.x) + (camUp * rotatedOffset.y);\n#elif USE_STRETCHED_BILLBOARD\n  vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz));\n  vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * a_uv0.x;\n  pos.xyz += (camRight * abs(cornerOffset.x) * sign(cornerOffset.y)) - camUp * a_uv.x;\n#elif USE_HORIZONTAL_BILLBOARD\n  vec3 camRight = vec3(1, 0, 0);\n  vec3 camUp = vec3(0, 0, -1);\n  pos.xyz += (camRight * rotatedOffset.x) + (camUp * rotatedOffset.y);\n#elif USE_VERTICAL_BILLBOARD\n  vec3 camRight = normalize(vec3(view[0][0], view[1][0], view[2][0]));\n  vec3 camUp = vec3(0, 1, 0);\n  pos.xyz += (camRight * rotatedOffset.x) + (camUp * rotatedOffset.y);\n#else\n  pos.x += rotatedOffset.x;\n  pos.y += rotatedOffset.y;\n#endif\n  pos = viewProj * pos;\n  vec2 aniUV = vec2(0, floor(a_uv.z * frameTile.y));\n  aniUV.x = floor(a_uv.z * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n  aniUV.y = frameTile.y - aniUV.y - 1.0;\n  aniUV = (aniUV.xy + a_uv.xy) / vec2(frameTile.x, frameTile.y);\n  uv = aniUV * mainTiling + mainOffset;\n  color = a_color;\n  gl_Position = pos;\n}",frag:"\nuniform sampler2D mainTexture;\nvarying vec2 uv;\nvarying vec4 color;\nvoid main () {\n  \n  gl_FragColor = color * texture2D(mainTexture, uv) * color.a;\n}",defines:[{name:"USE_SOFT_PARTICLE"},{name:"USE_BILLBOARD"},{name:"USE_STRETCHED_BILLBOARD"},{name:"USE_HORIZONTAL_BILLBOARD"},{name:"USE_VERTICAL_BILLBOARD"},{name:"USE_WORLD_SPACE"}]},{name:"pbr",vert:"\nattribute vec3 a_position;\nattribute vec3 a_normal;\nvarying vec3 pos_w;\nvarying vec3 normal_w;\nuniform mat4 model;\nuniform mat4 viewProj;\nuniform mat3 normalMatrix;\n#if USE_NORMAL_TEXTURE || USE_ALBEDO_TEXTURE || USE_MRA_TEXTURE || USE_METALLIC_TEXTURE || USE_ROUGHNESS_TEXTURE || USE_AO_TEXTURE || USE_EMISSIVE_TEXTURE\n  attribute vec2 a_uv0;\n  uniform vec2 mainTiling;\n  uniform vec2 mainOffset;\n  varying vec2 uv0;\n#endif\n#if USE_SKINNING\n  \nattribute vec4 a_weights;\nattribute vec4 a_joints;\nuniform sampler2D u_jointsTexture;\nuniform float u_jointsTextureSize;\nmat4 getBoneMatrix(const in float i) {\n  float size = u_jointsTextureSize;\n  float j = i * 4.0;\n  float x = mod(j, size);\n  float y = floor(j / size);\n  float dx = 1.0 / size;\n  float dy = 1.0 / size;\n  y = dy * (y + 0.5);\n  vec4 v1 = texture2D(u_jointsTexture, vec2(dx * (x + 0.5), y));\n  vec4 v2 = texture2D(u_jointsTexture, vec2(dx * (x + 1.5), y));\n  vec4 v3 = texture2D(u_jointsTexture, vec2(dx * (x + 2.5), y));\n  vec4 v4 = texture2D(u_jointsTexture, vec2(dx * (x + 3.5), y));\n  return mat4(v1, v2, v3, v4);\n}\nmat4 skinMatrix() {\n  return\n    getBoneMatrix(a_joints.x) * a_weights.x +\n    getBoneMatrix(a_joints.y) * a_weights.y +\n    getBoneMatrix(a_joints.z) * a_weights.z +\n    getBoneMatrix(a_joints.w) * a_weights.w\n    ;\n}\n#endif\n#if USE_SHADOW_MAP\n  #if NUM_SHADOW_LIGHTS > 0\n    #pragma for id in range(0, NUM_SHADOW_LIGHTS)\n      uniform mat4 lightViewProjMatrix_{id};\n      uniform float minDepth_{id};\n      uniform float maxDepth_{id};\n      varying vec4 pos_lightspace_{id};\n      varying float vDepth_{id};\n    #pragma endFor\n  #endif\n#endif\nvoid main () {\n  vec4 pos = vec4(a_position, 1);\n  #if USE_SKINNING\n    mat4 skinMat = skinMatrix();\n    pos = skinMat * pos;\n  #endif\n  pos_w = (model * pos).xyz;\n  pos = viewProj * model * pos;\n  #if USE_NORMAL_TEXTURE || USE_ALBEDO_TEXTURE || USE_MRA_TEXTURE || USE_METALLIC_TEXTURE || USE_ROUGHNESS_TEXTURE || USE_AO_TEXTURE || USE_EMISSIVE_TEXTURE\n    uv0 = a_uv0 * mainTiling + mainOffset;\n  #endif\n  vec4 normal = vec4(a_normal, 0);\n  #if USE_SKINNING\n    normal = skinMat * normal;\n  #endif\n  normal_w = normalMatrix * normal.xyz;\n  #if USE_SHADOW_MAP\n    #if NUM_SHADOW_LIGHTS > 0\n      #pragma for id in range(0, NUM_SHADOW_LIGHTS)\n        pos_lightspace_{id} = lightViewProjMatrix_{id} * vec4(pos_w, 1.0);\n        vDepth_{id} = (pos_lightspace_{id}.z + minDepth_{id}) / (minDepth_{id} + maxDepth_{id});\n      #pragma endFor\n    #endif\n  #endif\n  gl_Position = pos;\n}",frag:"\n#if USE_NORMAL_TEXTURE\n#extension GL_OES_standard_derivatives : enable\n#endif\n#if USE_TEX_LOD\n#extension GL_EXT_shader_texture_lod: enable\n#endif\n\n#define PI 3.14159265359\n#define PI2 6.28318530718\n#define EPSILON 1e-6\n#define LOG2 1.442695\n#define saturate(a) clamp( a, 0.0, 1.0 )\n\nvec3 gammaToLinearSpaceRGB(vec3 sRGB) { \n  return sRGB * (sRGB * (sRGB * 0.305306011 + 0.682171111) + 0.012522878);\n}\nvec3 linearToGammaSpaceRGB(vec3 RGB) { \n  vec3 S1 = sqrt(RGB);\n  vec3 S2 = sqrt(S1);\n  vec3 S3 = sqrt(S2);\n  return 0.585122381 * S1 + 0.783140355 * S2 - 0.368262736 * S3;\n}\nvec4 gammaToLinearSpaceRGBA(vec4 sRGBA) {\n  return vec4(gammaToLinearSpaceRGB(sRGBA.rgb), sRGBA.a);\n}\nvec4 linearToGammaSpaceRGBA(vec4 RGBA) {\n  return vec4(linearToGammaSpaceRGB(RGBA.rgb), RGBA.a);\n}\nfloat gammaToLinearSpaceExact(float val) {\n  if (val <= 0.04045) {\n    return val / 12.92;\n  } else if (val < 1.0) {\n    return pow((val + 0.055) / 1.055, 2.4);\n  } else {\n    return pow(val, 2.2);\n  }\n}\nfloat linearToGammaSpaceExact(float val) {\n  if (val <= 0.0) {\n    return 0.0;\n  } else if (val <= 0.0031308) {\n    return 12.92 * val;\n  } else if (val < 1.0) {\n    return 1.055 * pow(val, 0.4166667) - 0.055;\n  } else {\n    return pow(val, 0.45454545);\n  }\n}\n\nstruct LightInfo {\n  vec3 lightDir;\n  vec3 radiance;\n};\n#if NUM_DIR_LIGHTS > 0\n  #pragma for id in range(0, NUM_DIR_LIGHTS)\n    uniform vec3 dir_light{id}_direction;\n    uniform vec3 dir_light{id}_color;\n  #pragma endFor\n#endif\n#if NUM_POINT_LIGHTS > 0\n  #pragma for id in range(0, NUM_POINT_LIGHTS)\n    uniform vec3 point_light{id}_position;\n    uniform vec3 point_light{id}_color;\n    uniform float point_light{id}_range;\n  #pragma endFor\n#endif\n#if NUM_SPOT_LIGHTS > 0\n  #pragma for id in range(0, NUM_SPOT_LIGHTS)\n    uniform vec3 spot_light{id}_position;\n    uniform vec3 spot_light{id}_direction;\n    uniform vec3 spot_light{id}_color;\n    uniform vec2 spot_light{id}_spot;\n    uniform float spot_light{id}_range;\n  #pragma endFor\n#endif\nLightInfo computeDirectionalLighting(\n  vec3 lightDirection,\n  vec3 lightColor\n) {\n  LightInfo ret;\n  ret.lightDir = -normalize(lightDirection);\n  ret.radiance = lightColor;\n  return ret;\n}\nLightInfo computePointLighting(\n  vec3 lightPosition,\n  vec3 positionW,\n  vec3 lightColor,\n  float lightRange\n) {\n  LightInfo ret;\n  vec3 lightDir = lightPosition - positionW;\n  float attenuation = max(0., 1.0 - length(lightDir) / lightRange);\n  ret.lightDir = normalize(lightDir);\n  ret.radiance = lightColor * attenuation;\n  return ret;\n}\nLightInfo computeSpotLighting(\n  vec3 lightPosition,\n  vec3 positionW,\n  vec3 lightDirection,\n  vec3 lightColor,\n  vec2 lightSpot,\n  float lightRange\n) {\n  LightInfo ret;\n  vec3 lightDir = lightPosition - positionW;\n  float attenuation = max(0., 1.0 - length(lightDir) / lightRange);\n  float cosConeAngle = max(0., dot(lightDirection, -lightDir));\n  cosConeAngle = cosConeAngle < lightSpot.x ? 0.0 : cosConeAngle;\n  cosConeAngle = pow(cosConeAngle,lightSpot.y);\n  ret.lightDir = normalize(lightDir);\n  ret.radiance = lightColor * attenuation * cosConeAngle;\n  return ret;\n}\n#if USE_SHADOW_MAP\n  \nvec4 packDepthToRGBA(float depth) {\n  vec4 ret = vec4(1.0, 255.0, 65025.0, 160581375.0) * depth;\n  ret = fract(ret);\n  ret -= ret.yzww * vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0, 0.0);\n  return ret;\n}\nfloat unpackRGBAToDepth(vec4 color) {\n  return dot(color, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n}\n  \n#if NUM_SHADOW_LIGHTS > 0\n  #pragma for id in range(0, NUM_SHADOW_LIGHTS)\n    uniform sampler2D shadowMap_{id};\n    uniform float darkness_{id};\n    uniform float depthScale_{id};\n    uniform float frustumEdgeFalloff_{id};\n    uniform float bias_{id};\n    uniform vec2 texelSize_{id};\n    varying vec4 pos_lightspace_{id};\n    varying float vDepth_{id};\n  #pragma endFor\n#endif\nfloat computeShadow(sampler2D shadowMap, vec4 pos_lightspace, float bias) {\n  vec3 projCoords = pos_lightspace.xyz / pos_lightspace.w;\n  projCoords = projCoords * 0.5 + 0.5;\n  float closestDepth = unpackRGBAToDepth(texture2D(shadowMap, projCoords.xy));\n  float currentDepth = projCoords.z;\n  float shadow = (currentDepth - bias > closestDepth) ? 0.0 : 1.0;\n  return shadow;\n}\nfloat computeFallOff(float esm, vec2 coords, float frustumEdgeFalloff) {\n  float mask = smoothstep(1.0 - frustumEdgeFalloff, 1.0, clamp(dot(coords, coords), 0.0, 1.0));\n  return mix(esm, 1.0, mask);\n}\nfloat computeShadowESM(sampler2D shadowMap, vec4 pos_lightspace, float vDepth, float depthScale, float darkness, float frustumEdgeFalloff) {\n  vec2 projCoords = pos_lightspace.xy / pos_lightspace.w;\n  vec2 shadowUV = projCoords * 0.5 + vec2(0.5);\n  if (shadowUV.x < 0.0 || shadowUV.x > 1.0 || shadowUV.y < 0.0 || shadowUV.y > 1.0) {\n    return 1.0;\n  }\n  float currentDepth = clamp(vDepth, 0.0, 1.0);\n  float closestDepth = unpackRGBAToDepth(texture2D(shadowMap, shadowUV));\n  \n  float esm = clamp(exp(-depthScale * (currentDepth - closestDepth)), 1.0 - darkness, 1.0);\n  return computeFallOff(esm, projCoords, frustumEdgeFalloff);\n}\nfloat computeShadowPCF(sampler2D shadowMap, vec4 pos_lightspace, float vDepth, float darkness, vec2 texelSize, float frustumEdgeFalloff) {\n  vec2 projCoords = pos_lightspace.xy / pos_lightspace.w;\n  vec2 shadowUV = projCoords * 0.5 + vec2(0.5);\n  if (shadowUV.x < 0.0 || shadowUV.x > 1.0 || shadowUV.y < 0.0 || shadowUV.y > 1.0) {\n    return 1.0;\n  }\n  float currentDepth = clamp(vDepth, 0.0, 1.0);\n  float visibility = 1.0;\n  vec2 poissonDisk[4];\n  poissonDisk[0] = vec2(-0.94201624, -0.39906216);\n  poissonDisk[1] = vec2(0.94558609, -0.76890725);\n  poissonDisk[2] = vec2(-0.094184101, -0.92938870);\n  poissonDisk[3] = vec2(0.34495938, 0.29387760);\n  if (unpackRGBAToDepth(texture2D(shadowMap, shadowUV + poissonDisk[0] * texelSize)) < currentDepth) visibility -= 0.25;\n  if (unpackRGBAToDepth(texture2D(shadowMap, shadowUV + poissonDisk[1] * texelSize)) < currentDepth) visibility -= 0.25;\n  if (unpackRGBAToDepth(texture2D(shadowMap, shadowUV + poissonDisk[2] * texelSize)) < currentDepth) visibility -= 0.25;\n  if (unpackRGBAToDepth(texture2D(shadowMap, shadowUV + poissonDisk[3] * texelSize)) < currentDepth) visibility -= 0.25;\n  return computeFallOff(min(1.0, visibility + 1.0 - darkness), projCoords, frustumEdgeFalloff);\n}\n#endif\nuniform vec3 eye;\nvarying vec3 pos_w;\nvarying vec3 normal_w;\n#if USE_NORMAL_TEXTURE || USE_ALBEDO_TEXTURE || USE_MRA_TEXTURE || USE_METALLIC_TEXTURE || USE_ROUGHNESS_TEXTURE || USE_AO_TEXTURE || USE_EMISSIVE_TEXTURE\n  varying vec2 uv0;\n#endif\n#if USE_IBL\n  uniform samplerCube diffuseEnvTexture;\n  uniform samplerCube specularEnvTexture;\n  uniform sampler2D brdfLUT;\n  #if USE_TEX_LOD\n    uniform float maxReflectionLod;\n  #endif\n#endif\nuniform vec4 albedo;\n#if USE_ALBEDO_TEXTURE\n  uniform sampler2D albedo_texture;\n#endif\n#if USE_MRA_TEXTURE\n  uniform vec2 sampler2D mra_texture;\n#endif\nuniform float metallic;\n#if USE_METALLIC_TEXTURE\n  uniform sampler2D metallic_texture;\n#endif\nuniform float roughness;\n#if USE_ROUGHNESS_TEXTURE\n  uniform sampler2D roughness_texture;\n#endif\nuniform float ao;\n#if USE_AO_TEXTURE\n  uniform sampler2D ao_texture;\n#endif\n#if USE_EMISSIVE\n  uniform vec3 emissive;\n  #if USE_EMISSIVE_TEXTURE\n    uniform sampler2D emissive_texture;\n  #endif\n#endif\n#if USE_ALPHA_TEST\n  uniform float alphaTestThreshold;\n#endif\n#if USE_NORMAL_TEXTURE\n  uniform sampler2D normal_texture;\n  \n  vec3 getNormalFromTexture() {\n    vec3 tangentNormal = texture2D(normal_texture, uv0).rgb * 2.0 - 1.0;\n    vec3 q1  = dFdx(pos_w);\n    vec3 q2  = dFdy(pos_w);\n    vec2 st1 = dFdx(uv0);\n    vec2 st2 = dFdy(uv0);\n    vec3 N   = normalize(normal_w);\n    vec3 T   = normalize(q1*st2.t - q2*st1.t);\n    vec3 B   = -normalize(cross(N, T));\n    mat3 TBN = mat3(T, B, N);\n    return normalize(TBN * tangentNormal);\n  }\n#endif\nfloat distributionGGX(vec3 N, vec3 H, float roughness) {\n  float a = roughness * roughness;\n  float a2 = a * a;\n  float NdotH = max(dot(N, H), 0.0);\n  float NdotH2 = NdotH * NdotH;\n  float nom   = a2;\n  float denom = (NdotH2 * (a2 - 1.0) + 1.0);\n  denom = PI * denom * denom;\n  return nom / denom;\n}\nfloat geometrySchlickGGX(float NdotV, float roughness) {\n  float r = (roughness + 1.0);\n  float k = (r * r) / 8.0;\n  float nom   = NdotV;\n  float denom = NdotV * (1.0 - k) + k;\n  return nom / denom;\n}\nfloat geometrySmith(vec3 N, vec3 V, vec3 L, float roughness) {\n  float NdotV = max(dot(N, V), 0.0);\n  float NdotL = max(dot(N, L), 0.0);\n  float ggx2 = geometrySchlickGGX(NdotV, roughness);\n  float ggx1 = geometrySchlickGGX(NdotL, roughness);\n  return ggx1 * ggx2;\n}\nvec3 fresnelSchlick(float cosTheta, vec3 F0) {\n  float fresnel = exp2((-5.55473 * cosTheta - 6.98316) * cosTheta);\n  return F0 + (1.0 - F0) * fresnel;\n}\nvec3 fresnelSchlickRoughness(float cosTheta, vec3 F0, float roughness) {\n  float fresnel = exp2((-5.55473 * cosTheta - 6.98316) * cosTheta);\n  return F0 + (max(vec3(1.0 - roughness), F0) - F0) * fresnel;\n}\nvec3 brdf(LightInfo lightInfo, vec3 N, vec3 V, vec3 F0, vec3 albedo, float metallic, float roughness) {\n  vec3 H = normalize(V + lightInfo.lightDir);\n  float NDF = distributionGGX(N, H, roughness);\n  float G   = geometrySmith(N, V, lightInfo.lightDir, roughness);\n  vec3 F    = fresnelSchlick(max(dot(H, V), 0.0), F0);\n  vec3 nominator    = NDF * G * F;\n  float denominator = 4.0 * max(dot(N, V), 0.0) * max(dot(N, lightInfo.lightDir), 0.0) + 0.001; \n  vec3 specular = nominator / denominator;\n  \n  vec3 kS = F;\n  \n  \n  \n  vec3 kD = vec3(1.0) - kS;\n  \n  \n  \n  kD *= 1.0 - metallic;\n  float NdotL = max(dot(N, lightInfo.lightDir), 0.0);\n  return (kD * albedo / PI + specular) * lightInfo.radiance * NdotL;\n}\nvoid main() {\n  float opacity = 1.0;\n  #if USE_ALBEDO_TEXTURE\n    vec4 baseColor = gammaToLinearSpaceRGBA(albedo * texture2D(albedo_texture, uv0).rgba);\n    vec3 albedo    = baseColor.rgb;\n    opacity = baseColor.a;\n  #else\n    vec4 baseColor = gammaToLinearSpaceRGBA(albedo);\n    vec3 albedo    = baseColor.rgb;\n    opacity = baseColor.a;\n  #endif\n  #if USE_ALPHA_TEST\n    if(opacity < alphaTestThreshold) discard;\n  #endif\n  #if USE_MRA_TEXTURE\n    vec3 metalRoughness = texture2D(mra_texture, uv0).rgb;\n    float metallic = metalRoughness.r;\n    float roughness = metalRoughness.g;\n    float ao = metalRoughness.b;\n  #else\n    #if USE_METALLIC_TEXTURE\n      float metallic  = texture2D(metallic_texture, uv0).r;\n    #endif\n    #if USE_ROUGHNESS_TEXTURE\n      float roughness  = texture2D(roughness_texture, uv0).r;\n    #endif\n    #if USE_AO_TEXTURE\n      float ao  = texture2D(ao_texture, uv0).r;\n    #endif\n  #endif\n  vec3 N = normalize(normal_w);\n  #if USE_NORMAL_TEXTURE\n    N = getNormalFromTexture();\n  #endif\n  vec3 V = normalize(eye - pos_w);\n  \n  \n  vec3 F0 = vec3(0.04);\n  F0 = mix(F0, albedo, metallic);\n  \n  vec3 Lo = vec3(0.0);\n  \n  #if NUM_POINT_LIGHTS > 0\n    #pragma for id in range(0, NUM_POINT_LIGHTS)\n      LightInfo pointLight{id};\n      pointLight{id} = computePointLighting(point_light{id}_position, pos_w, point_light{id}_color, point_light{id}_range);\n      Lo += brdf(pointLight{id}, N, V, F0, albedo, metallic, roughness);\n    #pragma endFor\n  #endif\n  #if NUM_DIR_LIGHTS > 0\n    #pragma for id in range(0, NUM_DIR_LIGHTS)\n      LightInfo directionalLight{id};\n      directionalLight{id} = computeDirectionalLighting(dir_light{id}_direction, dir_light{id}_color);\n      Lo += brdf(directionalLight{id}, N, V, F0, albedo, metallic, roughness);\n    #pragma endFor\n  #endif\n  #if NUM_SPOT_LIGHTS > 0\n    #pragma for id in range(0, NUM_SPOT_LIGHTS)\n      LightInfo spotLight{id};\n      spotLight{id} = computeSpotLighting(spot_light{id}_position, pos_w, spot_light{id}_direction, spot_light{id}_color, spot_light{id}_spot, spot_light{id}_range);\n      Lo += brdf(spotLight{id}, N, V, F0, albedo, metallic, roughness);\n    #pragma endFor\n  #endif\n  #if USE_EMISSIVE\n    vec3 emissiveColor = gammaToLinearSpaceRGB(emissive);\n    #if USE_EMISSIVE_TEXTURE\n      emissiveColor *= gammaToLinearSpaceRGB(texture2D(emissive_texture, uv0).rgb);\n    #endif\n    Lo += emissiveColor;\n  #endif\n  \n  vec3 ambient = vec3(0.03) * albedo * ao;\n  #if USE_IBL\n    \n    vec3 F = fresnelSchlickRoughness(max(dot(N, V), 0.0), F0, roughness);\n    vec3 kS = F;\n    vec3 kD = vec3(1.0) - kS;\n    kD *= 1.0 - metallic;\n    vec3 diffuseEnv = textureCube(diffuseEnvTexture, N).rgb;\n    vec3 diffuse = diffuseEnv * albedo;\n    \n    vec3 R = reflect(-V, N);\n    #if USE_TEX_LOD\n      vec3 specularEnv = textureCubeLodEXT(specularEnvTexture, R, roughness * maxReflectionLod).rgb;\n    #else\n      vec3 specularEnv = textureCube(specularEnvTexture, R).rgb;\n    #endif\n    vec2 brdf  = texture2D(brdfLUT, vec2(max(dot(N, V), 0.0), roughness)).rg;\n    vec3 specular = specularEnv * (F * brdf.x + brdf.y);\n    ambient = (kD * diffuse + specular) * ao;\n  #endif\n  #if USE_SHADOW_MAP\n    float shadow = 1.0;\n    #if NUM_SHADOW_LIGHTS > 0\n      #pragma for id in range(0, NUM_SHADOW_LIGHTS)\n        shadow *= computeShadowESM(shadowMap_{id}, pos_lightspace_{id}, vDepth_{id}, depthScale_{id}, darkness_{id}, frustumEdgeFalloff_{id});\n      #pragma endFor\n    #endif\n    vec3 color = (ambient + Lo) * shadow;\n  #else\n    vec3 color = ambient + Lo;\n  #endif\n  \n  color = color / (color + vec3(1.0));\n  \n  vec4 finalColor = vec4(color, opacity);\n  gl_FragColor = linearToGammaSpaceRGBA(finalColor);\n}",defines:[{name:"USE_NORMAL_TEXTURE"},{name:"USE_ALBEDO_TEXTURE"},{name:"USE_METALLIC_ROUGHNESS_TEXTURE"},{name:"USE_METALLIC_TEXTURE"},{name:"USE_ROUGHNESS_TEXTURE"},{name:"USE_AO_TEXTURE"},{name:"USE_EMISSIVE"},{name:"USE_EMISSIVE_TEXTURE"},{name:"USE_IBL"},{name:"USE_TEX_LOD"},{name:"USE_ALPHA_TEST"},{name:"USE_SHADOW_MAP"},{name:"USE_SKINNING"},{name:"NUM_DIR_LIGHTS",min:0,max:4},{name:"NUM_POINT_LIGHTS",min:0,max:4},{name:"NUM_SPOT_LIGHTS",min:0,max:4},{name:"NUM_SHADOW_LIGHTS",min:0,max:4}]},{name:"phong",vert:"\nattribute vec3 a_position;\nattribute vec3 a_normal;\nuniform mat4 model;\nuniform mat4 viewProj;\nuniform mat3 normalMatrix;\nvarying vec3 normal_w;\nvarying vec3 pos_w;\n#if USE_NORMAL_TEXTURE || USE_DIFFUSE_TEXTURE || USE_EMISSIVE_TEXTURE\n  attribute vec2 a_uv0;\n  uniform vec2 mainTiling;\n  uniform vec2 mainOffset;\n  varying vec2 uv0;\n#endif\n#if USE_SKINNING\n  \nattribute vec4 a_weights;\nattribute vec4 a_joints;\nuniform sampler2D u_jointsTexture;\nuniform float u_jointsTextureSize;\nmat4 getBoneMatrix(const in float i) {\n  float size = u_jointsTextureSize;\n  float j = i * 4.0;\n  float x = mod(j, size);\n  float y = floor(j / size);\n  float dx = 1.0 / size;\n  float dy = 1.0 / size;\n  y = dy * (y + 0.5);\n  vec4 v1 = texture2D(u_jointsTexture, vec2(dx * (x + 0.5), y));\n  vec4 v2 = texture2D(u_jointsTexture, vec2(dx * (x + 1.5), y));\n  vec4 v3 = texture2D(u_jointsTexture, vec2(dx * (x + 2.5), y));\n  vec4 v4 = texture2D(u_jointsTexture, vec2(dx * (x + 3.5), y));\n  return mat4(v1, v2, v3, v4);\n}\nmat4 skinMatrix() {\n  return\n    getBoneMatrix(a_joints.x) * a_weights.x +\n    getBoneMatrix(a_joints.y) * a_weights.y +\n    getBoneMatrix(a_joints.z) * a_weights.z +\n    getBoneMatrix(a_joints.w) * a_weights.w\n    ;\n}\n#endif\n#if USE_SHADOW_MAP\n  #if NUM_SHADOW_LIGHTS > 0\n    #pragma for id in range(0, NUM_SHADOW_LIGHTS)\n      uniform mat4 lightViewProjMatrix_{id};\n      uniform float minDepth_{id};\n      uniform float maxDepth_{id};\n      varying vec4 pos_lightspace_{id};\n      varying float vDepth_{id};\n    #pragma endFor\n  #endif\n#endif\nvoid main () {\n  vec4 pos = vec4(a_position, 1);\n  #if USE_SKINNING\n    mat4 skinMat = skinMatrix();\n    pos = skinMat * pos;\n  #endif\n  pos_w = (model * pos).xyz;\n  pos = viewProj * model * pos;\n  #if USE_NORMAL_TEXTURE || USE_DIFFUSE_TEXTURE || USE_EMISSIVE_TEXTURE\n    uv0 = a_uv0 * mainTiling + mainOffset;\n  #endif\n  vec4 normal = vec4(a_normal, 0);\n  #if USE_SKINNING\n    normal = skinMat * normal;\n  #endif\n  normal_w = normalMatrix * normal.xyz;\n  #if USE_SHADOW_MAP\n    #if NUM_SHADOW_LIGHTS > 0\n      #pragma for id in range(0, NUM_SHADOW_LIGHTS)\n        pos_lightspace_{id} = lightViewProjMatrix_{id} * vec4(pos_w, 1.0);\n        vDepth_{id} = (pos_lightspace_{id}.z + minDepth_{id}) / (minDepth_{id} + maxDepth_{id});\n      #pragma endFor\n    #endif\n  #endif\n  gl_Position = pos;\n}",frag:"\n#if USE_NORMAL_TEXTURE\n#extension GL_OES_standard_derivatives : enable\n#endif\n\n#define PI 3.14159265359\n#define PI2 6.28318530718\n#define EPSILON 1e-6\n#define LOG2 1.442695\n#define saturate(a) clamp( a, 0.0, 1.0 )\n\nvec3 gammaToLinearSpaceRGB(vec3 sRGB) { \n  return sRGB * (sRGB * (sRGB * 0.305306011 + 0.682171111) + 0.012522878);\n}\nvec3 linearToGammaSpaceRGB(vec3 RGB) { \n  vec3 S1 = sqrt(RGB);\n  vec3 S2 = sqrt(S1);\n  vec3 S3 = sqrt(S2);\n  return 0.585122381 * S1 + 0.783140355 * S2 - 0.368262736 * S3;\n}\nvec4 gammaToLinearSpaceRGBA(vec4 sRGBA) {\n  return vec4(gammaToLinearSpaceRGB(sRGBA.rgb), sRGBA.a);\n}\nvec4 linearToGammaSpaceRGBA(vec4 RGBA) {\n  return vec4(linearToGammaSpaceRGB(RGBA.rgb), RGBA.a);\n}\nfloat gammaToLinearSpaceExact(float val) {\n  if (val <= 0.04045) {\n    return val / 12.92;\n  } else if (val < 1.0) {\n    return pow((val + 0.055) / 1.055, 2.4);\n  } else {\n    return pow(val, 2.2);\n  }\n}\nfloat linearToGammaSpaceExact(float val) {\n  if (val <= 0.0) {\n    return 0.0;\n  } else if (val <= 0.0031308) {\n    return 12.92 * val;\n  } else if (val < 1.0) {\n    return 1.055 * pow(val, 0.4166667) - 0.055;\n  } else {\n    return pow(val, 0.45454545);\n  }\n}\n\nstruct LightInfo {\n  vec3 diffuse;\n  vec3 specular;\n};\nLightInfo computeDirectionalLighting(\n  vec3 lightDirection,\n  vec3 lightColor,\n  vec3 normal,\n  vec3 viewDirection,\n  float glossiness\n) {\n  LightInfo lightingResult;\n  float ndl = 0.0;\n  float ndh = 0.0;\n  vec3 lightDir = -normalize(lightDirection);\n  ndl = max(0.0, dot(normal, lightDir));\n  lightingResult.diffuse = lightColor * ndl;\n  vec3 dirH = normalize(viewDirection + lightDir);\n  ndh = max(0.0, dot(normal, dirH));\n  ndh = (ndl == 0.0) ? 0.0: ndh;\n  ndh = pow(ndh, max(1.0, glossiness * 128.0));\n  lightingResult.specular = lightColor * ndh;\n  return lightingResult;\n}\nLightInfo computePointLighting(\n  vec3 lightPosition,\n  vec3 lightColor,\n  float lightRange,\n  vec3 normal,\n  vec3 positionW,\n  vec3 viewDirection,\n  float glossiness\n) {\n  LightInfo lightingResult;\n  float ndl = 0.0;\n  float ndh = 0.0;\n  vec3 lightDir = vec3(0, 0, 0);\n  float attenuation = 1.0;\n  lightDir = lightPosition - positionW;\n  attenuation = max(0., 1.0 - length(lightDir) / lightRange);\n  lightDir = normalize(lightDir);\n  ndl = max(0.0, dot(normal, lightDir));\n  lightingResult.diffuse = lightColor * ndl * attenuation;\n  vec3 dirH = normalize(viewDirection + lightDir);\n  ndh = max(0.0, dot(normal, dirH));\n  ndh = (ndl == 0.0) ? 0.0: ndh;\n  ndh = pow(ndh, max(1.0, glossiness * 128.0));\n  lightingResult.specular = lightColor * ndh * attenuation;\n  return lightingResult;\n}\nLightInfo computeSpotLighting(\n  vec3 lightPosition,\n  vec3 lightDirection,\n  vec3 lightColor,\n  float lightRange,\n  vec2 lightSpot,\n  vec3 normal,\n  vec3 positionW,\n  vec3 viewDirection,\n  float glossiness\n) {\n  LightInfo lightingResult;\n  float ndl = 0.0;\n  float ndh = 0.0;\n  vec3 lightDir = vec3(0, 0, 0);\n  float attenuation = 1.0;\n  float cosConeAngle = 1.0;\n  lightDir = lightPosition - positionW;\n  attenuation = max(0., 1.0 - length(lightDir) / lightRange);\n  lightDir = normalize(lightDir);\n  cosConeAngle = max(0., dot(lightDirection, -lightDir));\n  cosConeAngle = cosConeAngle < lightSpot.x ? 0.0 : cosConeAngle;\n  cosConeAngle = pow(cosConeAngle,lightSpot.y);\n  ndl = max(0.0, dot(normal, lightDir));\n  lightingResult.diffuse = lightColor * ndl * attenuation * cosConeAngle;\n  vec3 dirH = normalize(viewDirection + lightDir);\n  ndh = max(0.0, dot(normal, dirH));\n  ndh = (ndl == 0.0) ? 0.0: ndh;\n  ndh = pow(ndh, max(1.0, glossiness * 128.0));\n  lightingResult.specular = lightColor * ndh * attenuation * cosConeAngle;\n  return lightingResult;\n}\n#if NUM_DIR_LIGHTS > 0\n  #pragma for id in range(0, NUM_DIR_LIGHTS)\n    uniform vec3 dir_light{id}_direction;\n    uniform vec3 dir_light{id}_color;\n  #pragma endFor\n#endif\n#if NUM_POINT_LIGHTS > 0\n  #pragma for id in range(0, NUM_POINT_LIGHTS)\n    uniform vec3 point_light{id}_position;\n    uniform vec3 point_light{id}_color;\n    uniform float point_light{id}_range;\n  #pragma endFor\n#endif\n#if NUM_SPOT_LIGHTS > 0\n  #pragma for id in range(0, NUM_SPOT_LIGHTS)\n    uniform vec3 spot_light{id}_position;\n    uniform vec3 spot_light{id}_direction;\n    uniform vec3 spot_light{id}_color;\n    uniform float spot_light{id}_range;\n    uniform vec2 spot_light{id}_spot;\n  #pragma endFor\n#endif\nLightInfo getPhongLighting(\n  vec3 normal,\n  vec3 positionW,\n  vec3 viewDirection,\n  float glossiness\n) {\n  LightInfo result;\n  result.diffuse = vec3(0, 0, 0);\n  result.specular = vec3(0, 0, 0);\n  LightInfo dirLighting;\n  #if NUM_DIR_LIGHTS > 0\n    #pragma for id in range(0, NUM_DIR_LIGHTS)\n      dirLighting = computeDirectionalLighting(dir_light{id}_direction,dir_light{id}_color,normal, viewDirection, glossiness);\n      result.diffuse += dirLighting.diffuse;\n      result.specular += dirLighting.specular;\n    #pragma endFor\n  #endif\n  LightInfo pointLighting;\n  #if NUM_POINT_LIGHTS > 0\n    #pragma for id in range(0, NUM_POINT_LIGHTS)\n      pointLighting = computePointLighting(point_light{id}_position, point_light{id}_color, point_light{id}_range,\n                                          normal, positionW, viewDirection, glossiness);\n      result.diffuse += pointLighting.diffuse;\n      result.specular += pointLighting.specular;\n    #pragma endFor\n  #endif\n  LightInfo spotLighting;\n  #if NUM_SPOT_LIGHTS > 0\n    #pragma for id in range(0, NUM_SPOT_LIGHTS)\n      spotLighting = computeSpotLighting(spot_light{id}_position, spot_light{id}_direction, spot_light{id}_color,\n                      spot_light{id}_range, spot_light{id}_spot,normal, positionW, viewDirection, glossiness);\n      result.diffuse += spotLighting.diffuse;\n      result.specular += spotLighting.specular;\n    #pragma endFor\n  #endif\n  return result;\n}\n\n#if USE_SHADOW_MAP\n  \nvec4 packDepthToRGBA(float depth) {\n  vec4 ret = vec4(1.0, 255.0, 65025.0, 160581375.0) * depth;\n  ret = fract(ret);\n  ret -= ret.yzww * vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0, 0.0);\n  return ret;\n}\nfloat unpackRGBAToDepth(vec4 color) {\n  return dot(color, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n}\n  \n#if NUM_SHADOW_LIGHTS > 0\n  #pragma for id in range(0, NUM_SHADOW_LIGHTS)\n    uniform sampler2D shadowMap_{id};\n    uniform float darkness_{id};\n    uniform float depthScale_{id};\n    uniform float frustumEdgeFalloff_{id};\n    uniform float bias_{id};\n    uniform vec2 texelSize_{id};\n    varying vec4 pos_lightspace_{id};\n    varying float vDepth_{id};\n  #pragma endFor\n#endif\nfloat computeShadow(sampler2D shadowMap, vec4 pos_lightspace, float bias) {\n  vec3 projCoords = pos_lightspace.xyz / pos_lightspace.w;\n  projCoords = projCoords * 0.5 + 0.5;\n  float closestDepth = unpackRGBAToDepth(texture2D(shadowMap, projCoords.xy));\n  float currentDepth = projCoords.z;\n  float shadow = (currentDepth - bias > closestDepth) ? 0.0 : 1.0;\n  return shadow;\n}\nfloat computeFallOff(float esm, vec2 coords, float frustumEdgeFalloff) {\n  float mask = smoothstep(1.0 - frustumEdgeFalloff, 1.0, clamp(dot(coords, coords), 0.0, 1.0));\n  return mix(esm, 1.0, mask);\n}\nfloat computeShadowESM(sampler2D shadowMap, vec4 pos_lightspace, float vDepth, float depthScale, float darkness, float frustumEdgeFalloff) {\n  vec2 projCoords = pos_lightspace.xy / pos_lightspace.w;\n  vec2 shadowUV = projCoords * 0.5 + vec2(0.5);\n  if (shadowUV.x < 0.0 || shadowUV.x > 1.0 || shadowUV.y < 0.0 || shadowUV.y > 1.0) {\n    return 1.0;\n  }\n  float currentDepth = clamp(vDepth, 0.0, 1.0);\n  float closestDepth = unpackRGBAToDepth(texture2D(shadowMap, shadowUV));\n  \n  float esm = clamp(exp(-depthScale * (currentDepth - closestDepth)), 1.0 - darkness, 1.0);\n  return computeFallOff(esm, projCoords, frustumEdgeFalloff);\n}\nfloat computeShadowPCF(sampler2D shadowMap, vec4 pos_lightspace, float vDepth, float darkness, vec2 texelSize, float frustumEdgeFalloff) {\n  vec2 projCoords = pos_lightspace.xy / pos_lightspace.w;\n  vec2 shadowUV = projCoords * 0.5 + vec2(0.5);\n  if (shadowUV.x < 0.0 || shadowUV.x > 1.0 || shadowUV.y < 0.0 || shadowUV.y > 1.0) {\n    return 1.0;\n  }\n  float currentDepth = clamp(vDepth, 0.0, 1.0);\n  float visibility = 1.0;\n  vec2 poissonDisk[4];\n  poissonDisk[0] = vec2(-0.94201624, -0.39906216);\n  poissonDisk[1] = vec2(0.94558609, -0.76890725);\n  poissonDisk[2] = vec2(-0.094184101, -0.92938870);\n  poissonDisk[3] = vec2(0.34495938, 0.29387760);\n  if (unpackRGBAToDepth(texture2D(shadowMap, shadowUV + poissonDisk[0] * texelSize)) < currentDepth) visibility -= 0.25;\n  if (unpackRGBAToDepth(texture2D(shadowMap, shadowUV + poissonDisk[1] * texelSize)) < currentDepth) visibility -= 0.25;\n  if (unpackRGBAToDepth(texture2D(shadowMap, shadowUV + poissonDisk[2] * texelSize)) < currentDepth) visibility -= 0.25;\n  if (unpackRGBAToDepth(texture2D(shadowMap, shadowUV + poissonDisk[3] * texelSize)) < currentDepth) visibility -= 0.25;\n  return computeFallOff(min(1.0, visibility + 1.0 - darkness), projCoords, frustumEdgeFalloff);\n}\n#endif\nuniform vec3 eye;\nuniform vec3 sceneAmbient;\nvarying vec3 normal_w;\nvarying vec3 pos_w;\n#if USE_NORMAL_TEXTURE || USE_DIFFUSE_TEXTURE || USE_EMISSIVE_TEXTURE\n  varying vec2 uv0;\n#endif\nstruct phongMaterial\n{\n  vec3 diffuse;\n  vec3 emissive;\n  vec3 specular;\n  float glossiness;\n  float opacity;\n};\nuniform vec4 diffuseColor;\n#if USE_DIFFUSE_TEXTURE\n  uniform sampler2D diffuse_texture;\n#endif\n#if USE_EMISSIVE\n  uniform vec3 emissiveColor;\n  #if USE_EMISSIVE_TEXTURE\n    uniform sampler2D emissive_texture;\n  #endif\n#endif\n#if USE_SPECULAR\n  uniform vec3 specularColor;\n  uniform float glossiness;\n  #if USE_SPECULAR_TEXTURE\n    uniform sampler2D specular_texture;\n  #endif\n#endif\n#if USE_NORMAL_TEXTURE\n  uniform sampler2D normal_texture;\n  uniform float normalScale;  \n  vec3 getNormal(vec3 pos, vec3 normal) {\n    vec3 q0 = vec3( dFdx( pos.x ), dFdx( pos.y ), dFdx( pos.z ) );\n    vec3 q1 = vec3( dFdy( pos.x ), dFdy( pos.y ), dFdy( pos.z ) );\n    vec2 st0 = dFdx( uv0.st );\n    vec2 st1 = dFdy( uv0.st );\n    vec3 S = normalize( q0 * st1.t - q1 * st0.t );\n    vec3 T = normalize( -q0 * st1.s + q1 * st0.s );\n    vec3 N = normal;\n    vec3 mapN = texture2D(normal_texture, uv0).rgb * 2.0 - 1.0;\n    mapN.xy = 1.0 * mapN.xy;\n    mat3 tsn = mat3( S, T, N );\n    return normalize( tsn * mapN );\n  }\n#endif\n#if USE_ALPHA_TEST\n  uniform float alphaTestThreshold;\n#endif\nphongMaterial getPhongMaterial() {\n  phongMaterial result;\n  #if USE_DIFFUSE_TEXTURE\n    vec4 baseColor = gammaToLinearSpaceRGBA(diffuseColor * texture2D(diffuse_texture, uv0).rgba);\n    result.diffuse = baseColor.rgb;\n    result.opacity = baseColor.a;\n  #else\n    vec4 baseColor = gammaToLinearSpaceRGBA(diffuseColor);\n    result.diffuse = baseColor.rgb;\n    result.opacity = baseColor.a;\n  #endif\n  #if USE_EMISSIVE\n    result.emissive = gammaToLinearSpaceRGB(emissiveColor);\n    #if USE_EMISSIVE_TEXTURE\n      result.emissive *= gammaToLinearSpaceRGB(texture2D(emissive_texture, uv0).rgb);\n    #endif\n  #endif\n  #if USE_SPECULAR\n    result.specular = gammaToLinearSpaceRGB(specularColor);\n    #if USE_SPECULAR_TEXTURE\n      result.specular = gammaToLinearSpaceRGB(texture2D(specular_texture, uv0).rgb);\n    #endif\n    result.glossiness = glossiness;\n  #endif\n  return result;\n}\nvec4 composePhongShading(LightInfo lighting, phongMaterial mtl, float shadow)\n{\n  vec4 o = vec4(0.0, 0.0, 0.0, 1.0);\n  \n  o.xyz = lighting.diffuse * mtl.diffuse;\n  #if USE_EMISSIVE\n    o.xyz += mtl.emissive;\n  #endif\n  #if USE_SPECULAR\n    o.xyz += lighting.specular * mtl.specular;\n  #endif\n  o.xyz *= shadow;\n  o.w = mtl.opacity;\n  return o;\n}\nvoid main () {\n  LightInfo phongLighting;\n  vec3 viewDirection = normalize(eye - pos_w);\n  phongMaterial mtl = getPhongMaterial();\n  #if USE_ALPHA_TEST\n    if(mtl.opacity < alphaTestThreshold) discard;\n  #endif\n  vec3 normal = normalize(normal_w);\n  #if USE_NORMAL_TEXTURE\n    normal = getNormal(pos_w, normal);\n  #endif\n  phongLighting = getPhongLighting(normal, pos_w, viewDirection, mtl.glossiness);\n  phongLighting.diffuse += sceneAmbient;\n  #if USE_SHADOW_MAP\n    float shadow = 1.0;\n    #if NUM_SHADOW_LIGHTS > 0\n      #pragma for id in range(0, NUM_SHADOW_LIGHTS)\n        shadow *= computeShadowESM(shadowMap_{id}, pos_lightspace_{id}, vDepth_{id}, depthScale_{id}, darkness_{id}, frustumEdgeFalloff_{id});\n      #pragma endFor\n    #endif\n    vec4 finalColor = composePhongShading(phongLighting, mtl, shadow);\n  #else\n    vec4 finalColor = composePhongShading(phongLighting, mtl, 1.0);\n  #endif\n  gl_FragColor = linearToGammaSpaceRGBA(finalColor);\n}",defines:[{name:"USE_NORMAL_TEXTURE"},{name:"USE_DIFFUSE_TEXTURE"},{name:"USE_SPECULAR"},{name:"USE_SPECULAR_TEXTURE"},{name:"USE_EMISSIVE"},{name:"USE_EMISSIVE_TEXTURE"},{name:"USE_ALPHA_TEST"},{name:"USE_SKINNING"},{name:"USE_SHADOW_MAP"},{name:"NUM_DIR_LIGHTS",min:0,max:4},{name:"NUM_POINT_LIGHTS",min:0,max:4},{name:"NUM_SPOT_LIGHTS",min:0,max:4},{name:"NUM_SHADOW_LIGHTS",min:0,max:4}]},{name:"shadow-depth",vert:"\nattribute vec3 a_position;\nuniform mat4 model;\nuniform mat4 lightViewProjMatrix;\nuniform float minDepth;\nuniform float maxDepth;\nuniform float bias;\nvarying float vDepth;\n#if USE_SKINNING\n  \nattribute vec4 a_weights;\nattribute vec4 a_joints;\nuniform sampler2D u_jointsTexture;\nuniform float u_jointsTextureSize;\nmat4 getBoneMatrix(const in float i) {\n  float size = u_jointsTextureSize;\n  float j = i * 4.0;\n  float x = mod(j, size);\n  float y = floor(j / size);\n  float dx = 1.0 / size;\n  float dy = 1.0 / size;\n  y = dy * (y + 0.5);\n  vec4 v1 = texture2D(u_jointsTexture, vec2(dx * (x + 0.5), y));\n  vec4 v2 = texture2D(u_jointsTexture, vec2(dx * (x + 1.5), y));\n  vec4 v3 = texture2D(u_jointsTexture, vec2(dx * (x + 2.5), y));\n  vec4 v4 = texture2D(u_jointsTexture, vec2(dx * (x + 3.5), y));\n  return mat4(v1, v2, v3, v4);\n}\nmat4 skinMatrix() {\n  return\n    getBoneMatrix(a_joints.x) * a_weights.x +\n    getBoneMatrix(a_joints.y) * a_weights.y +\n    getBoneMatrix(a_joints.z) * a_weights.z +\n    getBoneMatrix(a_joints.w) * a_weights.w\n    ;\n}\n#endif\nvoid main() {\n  vec4 pos = vec4(a_position, 1);\n  #if USE_SKINNING\n    mat4 skinMat = skinMatrix();\n    pos = skinMat * pos;\n  #endif\n  gl_Position = lightViewProjMatrix * model * pos;\n  \n  vDepth = ((gl_Position.z + minDepth) / (minDepth + maxDepth)) + bias;\n}",frag:"\nuniform float depthScale;\nvarying float vDepth;\n\nvec4 packDepthToRGBA(float depth) {\n  vec4 ret = vec4(1.0, 255.0, 65025.0, 160581375.0) * depth;\n  ret = fract(ret);\n  ret -= ret.yzww * vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0, 0.0);\n  return ret;\n}\nfloat unpackRGBAToDepth(vec4 color) {\n  return dot(color, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n}\nvoid main() {\n  \n  \n  gl_FragColor = packDepthToRGBA(vDepth);\n  \n  \n}",defines:[{name:"USE_SKINNING"}]},{name:"simple",vert:"\nattribute vec3 a_position;\nuniform mat4 model;\nuniform mat4 viewProj;\n#if USE_TEXTURE\n  attribute vec2 a_uv0;\n  varying vec2 uv0;\n#endif\nvoid main () {\n  vec4 pos = viewProj * model * vec4(a_position, 1);\n  #if USE_TEXTURE\n    uv0 = a_uv0;\n  #endif\n  gl_Position = pos;\n}",frag:"\n#if USE_TEXTURE\n  uniform sampler2D texture;\n  varying vec2 uv0;\n#endif\n#if USE_COLOR\n  uniform vec4 color;\n#endif\nvoid main () {\n  vec4 o = vec4(1, 1, 1, 1);\n  #if USE_TEXTURE\n    o *= texture2D(texture, uv0);\n  #endif\n  #if USE_COLOR\n    o *= color;\n  #endif\n  if (!gl_FrontFacing) {\n    o.rgb *= 0.5;\n  }\n  gl_FragColor = o;\n}",defines:[{name:"USE_TEXTURE"},{name:"USE_COLOR"}]},{name:"skybox",vert:"\nattribute vec3 a_position;\nuniform mat4 view;\nuniform mat4 proj;\nvarying vec3 viewDir;\nvoid main() {\n  mat4 viewNoTrans = view;\n  viewNoTrans[3][0] = viewNoTrans[3][1] = viewNoTrans[3][2] = 0.0;\n  gl_Position = proj * viewNoTrans * vec4(a_position, 1.0);\n  \n  \n  \n  \n  gl_Position.z = gl_Position.w - 0.00001;\n  viewDir = a_position;\n}\n",frag:"\nvarying vec3 viewDir;\nuniform samplerCube cubeMap;\nvoid main() {\n    gl_FragColor = textureCube(cubeMap, viewDir);\n}",defines:[]},{name:"sprite",vert:"\nattribute vec3 a_position;\nuniform mat4 model;\nuniform mat4 viewProj;\nattribute vec2 a_uv0;\nattribute vec4 a_color;\nvarying vec2 uv0;\nvarying vec4 color;\nvoid main () {\n  vec4 pos = vec4(a_position, 1);\n  pos = viewProj * model * pos;\n  uv0 = a_uv0;\n  color = a_color;\n  gl_Position = pos;\n}",frag:"\nuniform sampler2D mainTexture;\nvarying vec2 uv0;\nvarying vec4 color;\nvoid main () {\n  vec4 o = vec4(1, 1, 1, 1);\n  o *= texture2D(mainTexture, uv0);\n  o *= color;\n  gl_FragColor = o;\n}",defines:[]},{name:"unlit",vert:"\nattribute vec3 a_position;\nuniform mat4 model;\nuniform mat4 viewProj;\n#if USE_TEXTURE\n  attribute vec2 a_uv0;\n  uniform vec2 mainTiling;\n  uniform vec2 mainOffset;\n  varying vec2 uv0;\n#endif\n#if USE_SKINNING\n  \nattribute vec4 a_weights;\nattribute vec4 a_joints;\nuniform sampler2D u_jointsTexture;\nuniform float u_jointsTextureSize;\nmat4 getBoneMatrix(const in float i) {\n  float size = u_jointsTextureSize;\n  float j = i * 4.0;\n  float x = mod(j, size);\n  float y = floor(j / size);\n  float dx = 1.0 / size;\n  float dy = 1.0 / size;\n  y = dy * (y + 0.5);\n  vec4 v1 = texture2D(u_jointsTexture, vec2(dx * (x + 0.5), y));\n  vec4 v2 = texture2D(u_jointsTexture, vec2(dx * (x + 1.5), y));\n  vec4 v3 = texture2D(u_jointsTexture, vec2(dx * (x + 2.5), y));\n  vec4 v4 = texture2D(u_jointsTexture, vec2(dx * (x + 3.5), y));\n  return mat4(v1, v2, v3, v4);\n}\nmat4 skinMatrix() {\n  return\n    getBoneMatrix(a_joints.x) * a_weights.x +\n    getBoneMatrix(a_joints.y) * a_weights.y +\n    getBoneMatrix(a_joints.z) * a_weights.z +\n    getBoneMatrix(a_joints.w) * a_weights.w\n    ;\n}\n#endif\nvoid main () {\n  vec4 pos = vec4(a_position, 1);\n  #if USE_SKINNING\n    pos = skinMatrix() * pos;\n  #endif\n  pos = viewProj * model * pos;\n  #if USE_TEXTURE\n    uv0 = a_uv0 * mainTiling + mainOffset;\n  #endif\n  gl_Position = pos;\n}",frag:"\n#if USE_TEXTURE\n  uniform sampler2D mainTexture;\n  varying vec2 uv0;\n#endif\n#if USE_COLOR\n  uniform vec4 color;\n#endif\nvoid main () {\n  vec4 o = vec4(1, 1, 1, 1);\n  #if USE_TEXTURE\n    o *= texture2D(mainTexture, uv0);\n  #endif\n  #if USE_COLOR\n    o *= color;\n  #endif\n  gl_FragColor = o;\n}",defines:[{name:"USE_TEXTURE"},{name:"USE_COLOR"},{name:"USE_SKINNING"}]},{name:"wireframe",vert:"\nattribute vec3 a_position;\nattribute vec3 a_normal;\nuniform mat4 model, viewProj;\nuniform mat3 normalMatrix;\nvarying vec3 position_w;\nvarying vec3 normal_w;\nvoid main () {\n  vec4 pos = vec4(a_position, 1);\n  position_w = (model * pos).xyz;\n  pos = viewProj * model * pos;\n  normal_w = normalMatrix * a_normal.xyz;\n  gl_Position = pos;\n}",frag:"\nuniform vec3 eye;\nuniform vec3 color;\nvarying vec3 position_w;\nvarying vec3 normal_w;\nvoid main () {\n  gl_FragColor = vec4(color, 1.0);\n  vec3 e2p = normalize(eye - position_w);\n  if (dot (normal_w, e2p) <= 0.0) {\n    gl_FragColor.rgb *= 0.6;\n  }\n}",defines:[]}];var Yr=0;function Kr(e,t,n){var r=[];for(var i in t){if(n[i]===undefined){if(t[i]===true){r.push("#define "+i+" 1")}else if(t[i]===false){r.push("#define "+i+" 0")}}else{if(e.ext(n[i])&&t[i]===true){r.push("#define "+i+" 1")}else{r.push("#define "+i+" 0")}}}return r.join("\n")}function Zr(e,t){var n={};var r=e;for(var i in t){if(Number.isInteger(t[i])){n[i]=t[i]}}for(var a in n){var s=new RegExp(a,"g");r=r.replace(s,n[a])}return r}function Jr(e){var t=/#pragma for (\w+) in range\(\s*(\d+)\s*,\s*(\d+)\s*\)([\s\S]+?)#pragma endFor/g;function n(e,t,n,r,i){var a="";var s=parseInt(n);var o=parseInt(r);if(s.isNaN||o.isNaN){console.error("Unroll For Loops Error: begin and end of range must be an int num.")}for(var l=s;l<o;++l){a+=i.replace(new RegExp("{"+t+"}","g"),l)}return a}return e.replace(t,n)}var Qr=function e(t,n,r){var i=this;if(n===void 0)n=[];if(r===void 0)r={};this._device=t;this._precision="precision highp float;\n";this._templates={};for(var a=0;a<n.length;++a){var s=n[a];i.define(s.name,s.vert,s.frag,s.defines)}this._chunks={};Object.assign(this._chunks,r);this._cache={}};Qr.prototype.define=function e(t,n,r,i){if(this._templates[t]){console.warn("Failed to define shader "+t+": already exists.");return}var a=++Yr;var s=0;for(var o=0;o<i.length;++o){var l=i[o];var u=1;if(l.min!==undefined&&l.max!==undefined){u=Math.ceil((l.max-l.min)*.5);l._map=function(e){return e-this.min<<this._offset}.bind(l)}else{l._map=function(e){if(e){return 1<<this._offset}return 0}.bind(l)}s+=u;l._offset=s}n=this._precision+n;r=this._precision+r;this._templates[t]={id:a,name:t,vert:n,frag:r,defines:i}};Qr.prototype.getKey=function e(t,n){var r=this._templates[t];var i=0;for(var a=0;a<r.defines.length;++a){var s=r.defines[a];var o=n[s.name];if(o===undefined){continue}i|=s._map(o)}return i<<8|r.id};Qr.prototype.getProgram=function e(t,n,r){var i=this.getKey(t,n);var a=this._cache[i];if(a){return a}var s=this._templates[t];var o=Kr(this._device,n,r)+"\n";var l=Zr(s.vert,n);l=o+Jr(l);var u=Zr(s.frag,n);u=o+Jr(u);a=new Me.Program(this._device,{vert:l,frag:u});a.link();this._cache[i]=a;return a};var $r=Lt.create();var ei=Pt.create();var ti=new cr(function(){return{stage:null,items:null}},8);var ni=new cr(function(){return new Float32Array(2)},8);var ri=new cr(function(){return new Float32Array(3)},8);var ii=new cr(function(){return new Float32Array(4)},8);var ai=new cr(function(){return new Float32Array(9)},8);var si=new cr(function(){return new Float32Array(16)},8);var oi=new cr(function(){return new Float32Array(64)},8);var li=new cr(function(){return new Int32Array(2)},8);var ui=new cr(function(){return new Int32Array(3)},8);var fi=new cr(function(){return new Int32Array(4)},8);var hi=new cr(function(){return new Int32Array(64)},8);var ci={};ci[Ae.PARAM_INT]=function(e){return e};ci[Ae.PARAM_INT2]=function(e){return Rt.array(li.add(),e)};ci[Ae.PARAM_INT3]=function(e){return Ut.array(ui.add(),e)};ci[Ae.PARAM_INT4]=function(e){return Dt.array(fi.add(),e)};ci[Ae.PARAM_FLOAT]=function(e){return e};ci[Ae.PARAM_FLOAT2]=function(e){return Rt.array(ni.add(),e)};ci[Ae.PARAM_FLOAT3]=function(e){return Ut.array(ri.add(),e)};ci[Ae.PARAM_FLOAT4]=function(e){return Dt.array(ii.add(),e)};ci[Ae.PARAM_COLOR3]=function(e){return Bt.array(ri.add(),e)};ci[Ae.PARAM_COLOR4]=function(e){return Ft.array(ii.add(),e)};ci[Ae.PARAM_MAT2]=function(e){return It.array(ii.add(),e)};ci[Ae.PARAM_MAT3]=function(e){return Lt.array(ai.add(),e)};ci[Ae.PARAM_MAT4]=function(e){return Pt.array(si.add(),e)};var pi={};pi[Ae.PARAM_INT]={func:function e(t){var n=hi.add();for(var r=0;r<t.length;++r){n[r]=t[r]}return n},size:1};pi[Ae.PARAM_INT2]={func:function e(t){var n=hi.add();for(var r=0;r<t.length;++r){n[2*r]=t[r].x;n[2*r+1]=t[r].y}return n},size:2};pi[Ae.PARAM_INT3]={func:undefined,size:3};pi[Ae.PARAM_INT4]={func:function e(t){var n=hi.add();for(var r=0;r<t.length;++r){var i=t[r];n[4*r]=i.x;n[4*r+1]=i.y;n[4*r+2]=i.z;n[4*r+3]=i.w}return n},size:4};pi[Ae.PARAM_FLOAT]={func:function e(t){var n=oi.add();for(var r=0;r<t.length;++r){n[r]=t[r]}return n},size:1};pi[Ae.PARAM_FLOAT2]={func:function e(t){var n=oi.add();for(var r=0;r<t.length;++r){n[2*r]=t[r].x;n[2*r+1]=t[r].y}return n},size:2};pi[Ae.PARAM_FLOAT3]={func:undefined,size:3};pi[Ae.PARAM_FLOAT4]={func:function e(t){var n=oi.add();for(var r=0;r<t.length;++r){var i=t[r];n[4*r]=i.x;n[4*r+1]=i.y;n[4*r+2]=i.z;n[4*r+3]=i.w}return n},size:4};pi[Ae.PARAM_COLOR3]={func:undefined,size:3};pi[Ae.PARAM_COLOR4]={func:function e(t){var n=oi.add();for(var r=0;r<t.length;++r){var i=t[r];n[4*r]=i.r;n[4*r+1]=i.g;n[4*r+2]=i.b;n[4*r+3]=i.a}return n},size:4};pi[Ae.PARAM_MAT2]={func:function e(t){var n=oi.add();for(var r=0;r<t.length;++r){var i=t[r];n[4*r]=i.m00;n[4*r+1]=i.m01;n[4*r+2]=i.m02;n[4*r+3]=i.m03}return n},size:4};pi[Ae.PARAM_MAT3]={func:undefined,size:9};pi[Ae.PARAM_MAT4]={func:function e(t){var n=oi.add();for(var r=0;r<t.length;++r){var i=t[r];n[16*r]=i.m00;n[16*r+1]=i.m01;n[16*r+2]=i.m02;n[16*r+3]=i.m03;n[16*r+4]=i.m04;n[16*r+5]=i.m05;n[16*r+6]=i.m06;n[16*r+7]=i.m07;n[16*r+8]=i.m08;n[16*r+9]=i.m09;n[16*r+10]=i.m10;n[16*r+11]=i.m11;n[16*r+12]=i.m12;n[16*r+13]=i.m13;n[16*r+14]=i.m14;n[16*r+15]=i.m15}return n},size:16};var di=function e(t,n){var r;this._device=t;this._programLib=new Qr(t,qr,jr);this._opts=n;this._type2defaultValue=(r={},r[Ae.PARAM_INT]=0,r[Ae.PARAM_INT2]=Rt.new(0,0),r[Ae.PARAM_INT3]=Ut.new(0,0,0),r[Ae.PARAM_INT4]=Dt.new(0,0,0,0),r[Ae.PARAM_FLOAT]=0,r[Ae.PARAM_FLOAT2]=Rt.new(0,0),r[Ae.PARAM_FLOAT3]=Ut.new(0,0,0),r[Ae.PARAM_FLOAT4]=Dt.new(0,0,0,0),r[Ae.PARAM_COLOR3]=Bt.new(0,0,0),r[Ae.PARAM_COLOR4]=Ft.new(0,0,0,1),r[Ae.PARAM_MAT2]=It.create(),r[Ae.PARAM_MAT3]=Lt.create(),r[Ae.PARAM_MAT4]=Pt.create(),r[Ae.PARAM_TEXTURE_2D]=n.defaultTexture,r[Ae.PARAM_TEXTURE_CUBE]=n.defaultTextureCube,r);this._stage2fn={};this._modelType2fn={};this._usedTextureUnits=0;this.frustum_test_func=on.box_frustum;this._accurateFrustumCulling=false;this._viewPools=new cr(function(){return new Mn},8);this._drawItemsPools=new cr(function(){return{model:null,node:null,ia:null,effect:null,defines:null,dependencies:null}},100);this._stageItemsPools=new cr(function(){return new cr(function(){return{model:null,node:null,ia:null,effect:null,defines:null,dependencies:null,technique:null,sortKey:-1}},100)},16)};var mi={accurateFrustumCulling:{configurable:true}};di.prototype._resetTextureUnit=function e(){this._usedTextureUnits=0};di.prototype._allocTextureUnit=function e(){var t=this._device;var n=this._usedTextureUnits;if(n>=t._caps.maxTextureUnits){console.warn("Trying to use "+n+" texture units while this GPU supports only "+t._caps.maxTextureUnits)}this._usedTextureUnits+=1;return n};di.prototype._registerStage=function e(t,n){this._stage2fn[t]=n};di.prototype._registerModel=function e(t,n){this._modelType2fn[t]=n};di.prototype._reset=function e(){this._viewPools.reset();this._stageItemsPools.reset()};di.prototype._requestView=function e(){var t=this._viewPools.add();t.fullUpdate=this._accurateFrustumCulling;return t};mi.accurateFrustumCulling.set=function(e){this._accurateFrustumCulling=e;if(!e){this.frustum_test_func=on.box_frustum}else{this.frustum_test_func=on.box_frustum_accurate}};di.prototype._render=function e(t,n){var r=this;var i=this._device;i.setFrameBuffer(t._framebuffer);i.setViewport(t._rect.x,t._rect.y,t._rect.w,t._rect.h);var a={};if(t._clearFlags&Ae.CLEAR_COLOR){a.color=[t._color.r,t._color.g,t._color.b,t._color.a]}if(t._clearFlags&Ae.CLEAR_DEPTH){a.depth=t._depth}if(t._clearFlags&Ae.CLEAR_STENCIL){a.stencil=t._stencil}i.clear(a);this._drawItemsPools.reset();if(t._clearFlags&Ae.CLEAR_SKYBOX&&t._clearModel!=null){var s=this._drawItemsPools.add();t._clearModel.extractDrawItem(s)}for(var o=0;o<n._models.length;++o){var l=n._models.data[o];if(t._cullingByID){if(l._viewID!==t._id){continue}}else{if(l._viewID!==-1){continue}}if(l._boundingBox!==null){l._node.getWorldMatrix(ei);yn.setTransform(l._boundingBox,ei,l._bbModelSpace);if(!r.frustum_test_func(l._boundingBox,t._frustum)){continue}}var u=r._drawItemsPools.add();l.extractDrawItem(u)}ti.reset();for(var f=0;f<t._stages.length;++f){var h=t._stages[f];var c=r._stageItemsPools.add();c.reset();for(var p=0;p<this._drawItemsPools.length;++p){var d=r._drawItemsPools.data[p];var m=d.effect.getTechnique(h);if(m){var _=c.add();_.model=d.model;_.node=d.node;_.ia=d.ia;_.effect=d.effect;_.defines=d.defines;_.dependencies=d.dependencies;_.technique=m;_.sortKey=-1}}var v=ti.add();v.stage=h;v.items=c}for(var g=0;g<ti.length;++g){var y=ti.data[g];var b=r._stage2fn[y.stage];b(t,y.items)}};di.prototype._drawModel=function e(t){var n=t.model;var r=this._modelType2fn[n._type];if(!r){return}r(t)};di.prototype._draw=function e(t){var n=this;var r=this._device;var i=this._programLib;var a=t.node;var s=t.ia;var o=t.effect;var l=t.technique;var u=t.defines;var f=t.dependencies;ni.reset();ri.reset();ii.reset();ai.reset();si.reset();oi.reset();li.reset();ui.reset();fi.reset();hi.reset();a.getWorldMatrix(ei);r.setUniform("model",Pt.array(si.add(),ei));Lt.normalFromMat4($r,ei);r.setUniform("normalMatrix",Lt.array(ai.add(),$r));for(var h=0;h<l._parameters.length;++h){var c=l._parameters[h];var p=o.getProperty(c.name);if(p===undefined||p===null){p=c.val}if(p===undefined||p===null){p=n._type2defaultValue[c.type]}if(p===undefined||p===null){console.warn("Failed to set technique property "+c.name+", value not found.");continue}if(c.type===Ae.PARAM_TEXTURE_2D||c.type===Ae.PARAM_TEXTURE_CUBE){if(u["USE_"+c.name.toUpperCase()]==false){continue}if(c.size!==undefined){if(c.size!==p.length){console.error("The length of texture array ("+p.length+") is not corrent(expect "+c.size+").");continue}var d=hi.add();for(var m=0;m<p.length;++m){d[m]=n._allocTextureUnit()}r.setTextureArray(c.name,p,d)}else{r.setTexture(c.name,p,n._allocTextureUnit())}}else{var _=void 0;if(c.size!==undefined){var v=pi[c.type];if(v.func===undefined){console.error("Uniform array of color3/int3/float3/mat3 can not be supportted!");continue}if(c.size*v.size>64){console.error("Uniform array is too long!");continue}_=v.func(p)}else{var g=ci[c.type];_=g(p)}r.setUniform(c.name,_)}}for(var y=0;y<l._passes.length;++y){var b=l._passes[y];var x=s.count;r.setVertexBuffer(0,s._vertexBuffer);if(s._indexBuffer){r.setIndexBuffer(s._indexBuffer)}r.setPrimitiveType(s._primitiveType);var T=i.getProgram(b._programName,u,f);r.setProgram(T);r.setCullMode(b._cullMode);if(b._blend){r.enableBlend();r.setBlendFuncSep(b._blendSrc,b._blendDst,b._blendSrcAlpha,b._blendDstAlpha);r.setBlendEqSep(b._blendEq,b._blendAlphaEq);r.setBlendColor32(b._blendColor)}if(b._depthTest){r.enableDepthTest();r.setDepthFunc(b._depthFunc)}if(b._depthWrite){r.enableDepthWrite()}if(b._stencilTest){r.enableStencilTest();r.setStencilFuncFront(b._stencilFuncFront,b._stencilRefFront,b._stencilMaskFront);r.setStencilOpFront(b._stencilFailOpFront,b._stencilZFailOpFront,b._stencilZPassOpFront,b._stencilWriteMaskFront);r.setStencilFuncBack(b._stencilFuncBack,b._stencilRefBack,b._stencilMaskBack);r.setStencilOpBack(b._stencilFailOpBack,b._stencilZFailOpBack,b._stencilZPassOpBack,b._stencilWriteMaskBack)}r.draw(s._start,x);n._resetTextureUnit()}};Object.defineProperties(di.prototype,mi);function _i(e,t,n,r){e[n]=new r(e._data);Object.defineProperty(e,t,{get:function e(){return this[n]}})}var vi=function e(t,n){var r=this;this._data=new ArrayBuffer(t);for(var i=0;i<n.length;++i){var a=n[i];if(a===Ae.BUFFER_VIEW_INT8){_i(r,"int8View","_int8View",Int8Array)}else if(a===Ae.BUFFER_VIEW_UINT8){_i(r,"uint8View","_uint8View",Uint8Array)}else if(a===Ae.BUFFER_VIEW_INT16){_i(r,"int16View","_int16View",Int16Array)}else if(a===Ae.BUFFER_VIEW_UINT16){_i(r,"uint16View","_uint16View",Uint16Array)}else if(a===Ae.BUFFER_VIEW_INT32){_i(r,"int32View","_int32View",Int32Array)}else if(a===Ae.BUFFER_VIEW_UINT32){_i(r,"uint32View","_uint32View",Uint32Array)}else if(a===Ae.BUFFER_VIEW_FLOAT32){_i(r,"float32View","_float32View",Float32Array)}}};var gi=512e3;var yi=64;var bi=zt.log2(yi);var xi=function e(t,n){var r=this;if(t===void 0)t=gi;if(n===void 0)n=[Ae.BUFFER_VIEW_FLOAT32];this._buffers=[];this._maxBytes=zt.nextPow2(t);this._maxLog=zt.log2(this._maxBytes);for(var i=bi;i<=this._maxLog;++i){r._buffers.push(new vi(1<<i,n))}};var Ti={maxBytes:{configurable:true}};Ti.maxBytes.get=function(){return this._maxBytes};xi.prototype.request=function e(t){var n=zt.nextPow2(t);var r=zt.log2(n);if(r>this._maxLog){return this._buffers[this._maxLog-bi]}else if(r<bi){return this._buffers[0]}else{return this._buffers[r-bi]}};Object.defineProperties(xi.prototype,Ti);var Si={};Si[Me.ATTR_TYPE_INT8]=Ae.BUFFER_VIEW_INT8;Si[Me.ATTR_TYPE_UINT8]=Ae.BUFFER_VIEW_UINT8;Si[Me.ATTR_TYPE_INT16]=Ae.BUFFER_VIEW_INT16;Si[Me.ATTR_TYPE_UINT16]=Ae.BUFFER_VIEW_UINT16;Si[Me.ATTR_TYPE_INT32]=Ae.BUFFER_VIEW_INT32;Si[Me.ATTR_TYPE_UINT32]=Ae.BUFFER_VIEW_UINT32;Si[Me.ATTR_TYPE_FLOAT32]=Ae.BUFFER_VIEW_FLOAT32;var Ei=function e(t,n,r,i,a,s,o){var l=this;if(s===void 0)s=Me.INDEX_FMT_UINT16;if(o===void 0)o=-1;var u=[];for(var f=0;f<i._elements.length;++f){var h=i._elements[f].type;var c=Si[h];if(u.indexOf(c)===-1){u.push(c)}}this._bytesPerVeretx=i._bytes;this._vdataPool=new xi(this._bytesPerVeretx*a,u);if(o!==-1){var p=-1;if(s===Me.INDEX_FMT_UINT8){p=Ae.BUFFER_VIEW_UINT8;this._bytesPerIndex=1}else if(s===Me.INDEX_FMT_UINT16){p=Ae.BUFFER_VIEW_UINT16;this._bytesPerIndex=2}else if(s===Me.INDEX_FMT_UINT32){p=Ae.BUFFER_VIEW_UINT32;this._bytesPerIndex=4}this._idataPool=new xi(this._bytesPerIndex*o,[p])}this._maxVerts=a;this._maxIndices=o;this._IAs=new jn(function(){return new Re(new Me.VertexBuffer(t,i,Me.USAGE_DYNAMIC,null,Math.ceil(l._vdataPool.maxBytes/l._bytesPerVeretx)),o===-1?null:new Me.IndexBuffer(t,s,Me.USAGE_DYNAMIC,null,Math.ceil(l._idataPool.maxBytes/l._bytesPerIndex)),r)},n)};var wi={maxVerts:{configurable:true},maxIndices:{configurable:true}};wi.maxVerts.get=function(){return this._maxVerts};wi.maxIndices.get=function(){return this._maxIndices};Ei.prototype.requestIA=function e(){return this._IAs.request()};Ei.prototype.requestVData=function e(t){return this._vdataPool.request(t*this._bytesPerVeretx)};Ei.prototype.requestIData=function e(t){return this._idataPool.request(t*this._bytesPerIndex)};Object.defineProperties(Ei.prototype,wi);var Mi=Ut.zero();var Ai=Ut.zero();var Ri=Ut.zero();var Ui=new Float32Array(16);var Di=new Float32Array(16);var Li=new Float32Array(16);var Oi=new Float32Array(16);var Ii=new Float32Array(3);var Ci=function(e){function t(t,n){e.call(this,t,n);this._directionalLights=[];this._pointLights=[];this._spotLights=[];this._shadowLights=[];this._sceneAmbient=new Float32Array([.5,.5,.5]);this._registerStage("shadowcast",this._shadowStage.bind(this));this._registerStage("opaque",this._opaqueStage.bind(this));this._registerStage("transparent",this._transparentStage.bind(this));this._registerStage("ui",this._uiStage.bind(this));this._registerModel("default",this._draw.bind(this));this._registerModel("line-batch",this._drawLineBatch.bind(this));this._registerModel("sprite-batch",this._drawSpriteBatch.bind(this));this._registerModel("particle-batch",this._drawParticleBatch.bind(this));this._registerModel("skinning",this._drawSkinning.bind(this));this._lineIAs=new Ei(t,2,Me.PT_LINES,new Me.VertexFormat([{name:Me.ATTR_POSITION,type:Me.ATTR_TYPE_FLOAT32,num:3},{name:Me.ATTR_COLOR,type:Me.ATTR_TYPE_FLOAT32,num:3}]),2e3);this._spriteIAs=new Ei(t,2,Me.PT_TRIANGLES,new Me.VertexFormat([{name:Me.ATTR_POSITION,type:Me.ATTR_TYPE_FLOAT32,num:3},{name:Me.ATTR_UV0,type:Me.ATTR_TYPE_FLOAT32,num:2},{name:Me.ATTR_COLOR,type:Me.ATTR_TYPE_FLOAT32,num:4}]),2e3,Me.INDEX_FMT_UINT16,2e3)}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.updateLights=function e(t){var n=this;this._directionalLights.length=0;this._pointLights.length=0;this._spotLights.length=0;this._shadowLights.length=0;var r=t._lights;for(var i=0;i<r.length;++i){var a=r.data[i];a.update(n._device);if(a.shadowType!==Ae.SHADOW_NONE){n._shadowLights.push(a);var s=n._requestView();a.extractView(s,["shadowcast"])}if(a._type===Ae.LIGHT_DIRECTIONAL){n._directionalLights.push(a)}else if(a._type===Ae.LIGHT_POINT){n._pointLights.push(a)}else{n._spotLights.push(a)}}};t.prototype.render=function e(t){var n=this;this._reset();var r=this._device._gl.canvas;this.updateLights(t);if(t._debugCamera){var i=this._requestView();t._debugCamera.extractView(i,r.width,r.height)}else{for(var a=0;a<t._cameras.length;++a){var s=n._requestView();t._cameras.data[a].extractView(s,r.width,r.height)}}this._viewPools.sort(function(e,t){return e._priority-t._priority});t._views.sort(function(e,t){return e._priority-t._priority});for(var o=0;o<this._viewPools.length;++o){var l=n._viewPools.data[o];n._render(l,t)}for(var u=0;u<t._views.length;++u){var f=t._views[u];n._render(f,t)}};t.prototype._submitLightUniforms=function e(){var t=this;this._device.setUniform("sceneAmbient",this._sceneAmbient);if(this._directionalLights.length>0){for(var n=0;n<this._directionalLights.length;++n){var r=t._directionalLights[n];t._device.setUniform("dir_light"+n+"_direction",r._directionUniform);t._device.setUniform("dir_light"+n+"_color",r._colorUniform)}}if(this._pointLights.length>0){for(var i=0;i<this._pointLights.length;++i){var a=t._pointLights[i];t._device.setUniform("point_light"+i+"_position",a._positionUniform);t._device.setUniform("point_light"+i+"_color",a._colorUniform);t._device.setUniform("point_light"+i+"_range",a._range)}}if(this._spotLights.length>0){for(var s=0;s<this._spotLights.length;++s){var o=t._spotLights[s];t._device.setUniform("spot_light"+s+"_position",o._positionUniform);t._device.setUniform("spot_light"+s+"_direction",o._directionUniform);t._device.setUniform("spot_light"+s+"_color",o._colorUniform);t._device.setUniform("spot_light"+s+"_range",o._range);t._device.setUniform("spot_light"+s+"_spot",o._spotUniform)}}};t.prototype._submitShadowStageUniforms=function e(t){var n=t._shadowLight;this._device.setUniform("minDepth",n.shadowMinDepth);this._device.setUniform("maxDepth",n.shadowMaxDepth);this._device.setUniform("bias",n.shadowBias);this._device.setUniform("depthScale",n.shadowDepthScale)};t.prototype._submitOtherStagesUniforms=function e(){var t=this;for(var n=0;n<this._shadowLights.length;++n){var r=t._shadowLights[n];t._device.setUniform("lightViewProjMatrix_"+n,Pt.array(Oi,r.viewProjMatrix));t._device.setUniform("minDepth_"+n,r.shadowMinDepth);t._device.setUniform("maxDepth_"+n,r.shadowMaxDepth);t._device.setUniform("bias_"+n,r.shadowBias);t._device.setUniform("depthScale_"+n,r.shadowDepthScale);t._device.setUniform("darkness_"+n,r.shadowDarkness);t._device.setUniform("frustumEdgeFalloff_"+n,r.frustumEdgeFalloff);t._device.setUniform("texelSize_"+n,new Float32Array([1/r.shadowResolution,1/r.shadowResolution]))}};t.prototype._updateShaderDefines=function e(t){var n=this;for(var r=0;r<t.length;++r){var i=t.data[r];var a=i.defines;a.NUM_DIR_LIGHTS=Math.min(4,n._directionalLights.length);a.NUM_POINT_LIGHTS=Math.min(4,n._pointLights.length);a.NUM_SPOT_LIGHTS=Math.min(4,n._spotLights.length);a.NUM_SHADOW_LIGHTS=Math.min(4,n._shadowLights.length)}};t.prototype._uiStage=function e(t,n){var r=this;this._device.setUniform("view",Pt.array(Ui,t._matView));this._device.setUniform("proj",Pt.array(Di,t._matProj));this._device.setUniform("viewProj",Pt.array(Li,t._matViewProj));n.sort(function(e,t){return e.model._userKey-t.model._userKey});for(var i=0;i<n.length;++i){var a=n.data[i];r._drawModel(a)}};t.prototype._shadowStage=function e(t,n){var r=this;var i=this._programLib;this._device.setUniform("lightViewProjMatrix",Pt.array(Li,t._matViewProj));this._submitLightUniforms();this._submitShadowStageUniforms(t);this._updateShaderDefines(n);for(var a=0;a<n.length;++a){var s=n.data[a];s.sortKey=i.getKey(s.technique._passes[0]._programName,s.defines)}n.sort(function(e,t){var n=e.technique;var r=t.technique;if(n._layer!==r._layer){return n._layer-r._layer}if(n._passes.length!==r._passes.length){return n._passes.length-r._passes.length}return e.sortKey-t.sortKey});for(var o=0;o<n.length;++o){var l=n.data[o];if(l.model._castShadow){r._drawModel(l)}}};t.prototype._opaqueStage=function e(t,n){var r=this;var i=this._programLib;t.getPosition(Mi);this._device.setUniform("view",Pt.array(Ui,t._matView));this._device.setUniform("proj",Pt.array(Di,t._matProj));this._device.setUniform("viewProj",Pt.array(Li,t._matViewProj));this._device.setUniform("eye",Ut.array(Ii,Mi));this._submitLightUniforms();this._submitOtherStagesUniforms();this._updateShaderDefines(n);for(var a=0;a<n.length;++a){var s=n.data[a];s.sortKey=i.getKey(s.technique._passes[0]._programName,s.defines)}n.sort(function(e,t){var n=e.technique;var r=t.technique;if(n._layer!==r._layer){return n._layer-r._layer}if(n._passes.length!==r._passes.length){return n._passes.length-r._passes.length}return e.sortKey-t.sortKey});for(var o=0;o<n.length;++o){var l=n.data[o];for(var u=0;u<this._shadowLights.length;++u){var f=r._shadowLights[u];r._device.setTexture("shadowMap_"+u,f.shadowMap,r._allocTextureUnit())}r._drawModel(l)}};t.prototype._transparentStage=function e(t,n){var r=this;t.getPosition(Mi);t.getForward(Ai);this._device.setUniform("view",Pt.array(Ui,t._matView));this._device.setUniform("proj",Pt.array(Di,t._matProj));this._device.setUniform("viewProj",Pt.array(Li,t._matViewProj));this._device.setUniform("eye",Ut.array(Ii,Mi));for(var i=0;i<n.length;++i){var a=n.data[i];a.node.getWorldPos(Ri);Ut.sub(Ri,Ri,Mi);a.sortKey=Ut.dot(Ri,Ai)}this._submitLightUniforms();this._submitOtherStagesUniforms();this._updateShaderDefines(n);n.sort(function(e,t){if(e.technique._layer!==t.technique._layer){return e.technique._layer-t.technique._layer}return t.sortKey-e.sortKey});for(var s=0;s<n.length;++s){var o=n.data[s];for(var l=0;l<this._shadowLights.length;++l){var u=r._shadowLights[l];r._device.setTexture("shadowMap_"+l,u.shadowMap,r._allocTextureUnit())}r._drawModel(o)}};t.prototype._drawSkinning=function e(t){var n=t.model;var r=t.defines;r.USE_SKINNING=true;this._device.setTexture("u_jointsTexture",n._jointsTexture,this._allocTextureUnit());this._device.setUniform("u_jointsTextureSize",n._jointsTexture._width);this._draw(t)};t.prototype._drawLineBatch=function e(t){var n=this;var r=t.model;var i=0;var a=this._lineIAs.requestVData(r.vertCount);var s=a.float32View;for(var o=r.lineCount-1;o>=0;--o){var l=r.getLine(o);if(i+2>=n._lineIAs.maxVerts){var u=n._lineIAs.requestIA();u._vertexBuffer.update(0,s);u._start=0;u._count=i;t.ia=u;n._draw(t);i=0}var f=i*6;s[f]=l.start.x;s[f+1]=l.start.y;s[f+2]=l.start.z;s[f+3]=l.color.r;s[f+4]=l.color.g;s[f+5]=l.color.b;s[f+6]=l.end.x;s[f+7]=l.end.y;s[f+8]=l.end.z;s[f+9]=l.color.r;s[f+10]=l.color.g;s[f+11]=l.color.b;i+=2}if(i>0){var h=this._lineIAs.requestIA();h._vertexBuffer.update(0,s);h._start=0;h._count=i;t.ia=h;this._draw(t)}};t.prototype._drawSpriteBatch=function e(t){var n=this;var r=t.model;var i=0;var a=0;var s=0;var o=this._spriteIAs.requestVData(r.vertCount);var l=this._spriteIAs.requestIData(r.indexCount);var u=o.float32View;var f=l.uint16View;for(var h=0;h<r.spriteCount;++h){var c=r.getSprite(h);var p=c.refPositions.length;var d=c.refIndices.length;if(a+p>=n._spriteIAs.maxVerts||s+d>=n._spriteIAs.maxIndices){var m=n._spriteIAs.requestIA();m._vertexBuffer.update(0,u);m._indexBuffer.update(0,f);m._start=0;m._count=s;t.ia=m;n._draw(t);i=0;a=0;s=0}for(var _=0;_<p;++_){var v=a*9;u[v]=c.refPositions[_].x;u[v+1]=c.refPositions[_].y;u[v+2]=c.refPositions[_].z;u[v+3]=c.refUVs[_].x;u[v+4]=c.refUVs[_].y;u[v+5]=c.refColor.r;u[v+6]=c.refColor.g;u[v+7]=c.refColor.b;u[v+8]=c.refColor.a;a+=1}for(var g=0;g<d;++g){var y=s;f[y]=i+c.refIndices[g];s+=1}i+=p}if(s>0){var b=this._spriteIAs.requestIA();b._vertexBuffer.update(0,u);b._indexBuffer.update(0,f);b._start=0;b._count=s;t.ia=b;this._draw(t)}};t.prototype._drawParticleBatch=function e(t){t.ia=t.model._ia;this._draw(t)};return t}(di);var Pi={addStage:Ie.addStage,createIA:ze,Pass:De,Technique:Pe,Effect:Fe,InputAssembler:Re,View:Mn,Light:Pn,Camera:Wn,Model:Xn,Scene:Nr,LineBatchModel:Gr,SpriteBatchModel:Vr,ParticleBatchModel:Wr,SkinningModel:Xr,ForwardRenderer:Ci};Object.assign(Pi,Ae);var Bi=0;var Fi=1;var zi=2;var ki=3;var Ni=0;var Gi=1;var Vi=2;var Hi=3;var Wi=null;var Xi=["start","pressing","end","cancel"];var ji=["none","down","pressing","up"];var qi=function e(t,n){var r=this;n=n||{};if(!Wi&&n.useMask){Wi=document.createElement("div");Wi.classList.add("drag-mask");Wi.style.position="fixed";Wi.style.zIndex="9999";Wi.style.top="0";Wi.style.right="0";Wi.style.bottom="0";Wi.style.left="0";Wi.oncontextmenu=function(){return false}}this._element=t||document.body;this._enabled=true;if(n.enabled!==undefined){this._enabled=n.enabled}this._lock=false;if(n.lock!==undefined){this._lock=n.lock}this._useMask=false;if(n.useMask!==undefined){this._useMask=n.useMask}this._maskCursor="default";if(n.maskCursor!==undefined){this._maskCursor=n.maskCursor}this._invertY=false;if(n.invertY!==undefined){this._invertY=n.invertY}var i=navigator.userAgent.toLowerCase();if(/mobile|android|iphone|ipad|phone/i.test(i)){this._hasTouch=true}this._globalEventInstalled=false;this._pointerLocked=false;this._mouseGrabbed=false;this._bcr=t.getBoundingClientRect();this._mouse={x:0,y:0,dx:0,dy:0,prevX:0,prevY:0,scrollX:0,scrollY:0,left:Bi,right:Bi,middle:Bi};this._keys=new fr(function(){return{_next:null,_prev:null,_state:0,key:"",get state(){return ji[this._state]}}},100);this._touches=new cr(function(){return{id:-1,x:0,y:0,dx:0,dy:0,prevX:0,prevY:0,get phase(){return Xi[this._phase]},_phase:-1}},16);this._mousemoveHandle=function(e){e.preventDefault();e.stopPropagation();r._mouse.dx=e.movementX;r._mouse.dy=e.movementY;if(r._pointerLocked){r._mouse.x+=e.movementX;if(r._invertY){r._mouse.y-=e.movementY}else{r._mouse.y+=e.movementY}}else{r._mouse.x=r._calcOffsetX(e.clientX);r._mouse.y=r._calcOffsetY(e.clientY)}};this._mousewheelHandle=function(e){e.preventDefault();e.stopPropagation();r._mouse.scrollX=e.deltaX;r._mouse.scrollY=e.deltaY};this._domMouseWheelHandle=function(e){e.preventDefault();e.stopPropagation();r._mouse.scrollX=0;r._mouse.scrollY=e.detail/3};this._mousedownHandle=function(e){e.preventDefault();e.stopPropagation();if(r._lock){r._lockPointer(true)}r._installGlobalEvents();r._element.focus();switch(e.button){case 0:if(r._mouse.left!==zi){r._mouse.left=Fi}break;case 1:if(r._mouse.middle!==zi){r._mouse.middle=Fi}break;case 2:if(r._mouse.right!==zi){r._mouse.right=Fi}break}};this._mouseupHandle=function(e){e.preventDefault();e.stopPropagation();r._mouse.dx=e.movementX;r._mouse.dy=e.movementY;r._mouse.prevX=r._mouse.x=r._calcOffsetX(e.clientX);r._mouse.prevY=r._mouse.y=r._calcOffsetY(e.clientY);switch(e.button){case 0:r._mouse.left=ki;break;case 1:r._mouse.middle=ki;break;case 2:r._mouse.right=ki;break}};this._mouseenterHandle=function(e){e.preventDefault();e.stopPropagation();r._mouse.dx=0;r._mouse.dy=0;r._mouse.prevX=r._mouse.x=r._calcOffsetX(e.clientX);r._mouse.prevY=r._mouse.y=r._calcOffsetY(e.clientY)};this._mouseleaveHandle=function(e){e.preventDefault();e.stopPropagation();if(r._mouseGrabbed){return}r._uninstallGlobalEvents();r._mouse.dx=e.movementX;r._mouse.dy=e.movementY;r._mouse.prevX=r._mouse.x=r._calcOffsetX(e.clientX);r._mouse.prevY=r._mouse.y=r._calcOffsetY(e.clientY)};this._keydownHandle=function(e){e.stopPropagation();var t=r._keys.head;while(t){if(t.key===e.key){break}t=t._next}if(t&&t._state===zi){return}if(!t){t=r._keys.add()}t.key=e.key;t._state=Fi};this._keyupHandle=function(e){e.stopPropagation();var t=r._keys.head;while(t){if(t.key===e.key){break}t=t._next}if(t){r._keys.remove(t)}t=r._keys.add();t.key=e.key;t._state=ki};this._touchstartHandle=function(e){e.preventDefault();for(var t=0;t<e.changedTouches.length;t++){var n=e.changedTouches[t];var i=r._touches.add();i.id=n.identifier;i._phase=Ni;i.x=r._calcOffsetX(n.clientX);i.y=r._calcOffsetY(n.clientY);i.dx=0;i.dy=0;i.prevX=0;i.prevY=0}};this._touchmoveHandle=function(e){e.preventDefault();for(var t=0;t<r._touches.length;t++){for(var n=0;n<e.changedTouches.length;n++){var i=r._touches.data[t];var a=e.changedTouches[n];if(i.id===a.identifier){i._phase=Gi;i.x=r._calcOffsetX(a.clientX);i.y=r._calcOffsetY(a.clientY);i.dx=i.x-i.prevX;i.dy=i.y-i.prevY}}}};this._touchendHandle=function(e){e.preventDefault();for(var t=0;t<r._touches.length;t++){for(var n=0;n<e.changedTouches.length;n++){var i=r._touches.data[t];var a=e.changedTouches[n];if(i.id===a.identifier){i._phase=Vi;i.prevX=i.x=r._calcOffsetX(a.clientX);i.prevY=i.y=r._calcOffsetY(a.clientY);i.dx=0;i.dy=0}}}};this._touchcancelHandle=function(e){e.preventDefault();for(var t=0;t<r._touches.length;t++){for(var n=0;n<e.changedTouches.length;n++){var i=r._touches.data[t];var a=e.changedTouches[n];if(i.id===a.identifier){i._phase=Hi;i.prevX=i.x=r._calcOffsetX(a.clientX);i.prevY=i.y=r._calcOffsetY(a.clientY);i.dx=0;i.dy=0}}}};this._contextmenuHandle=function(e){e.preventDefault();e.stopPropagation()};if(this._enabled){this._registerEvents()}};var Yi={enabled:{configurable:true},hasTouch:{configurable:true},mouseX:{configurable:true},mouseY:{configurable:true},mouseDeltaX:{configurable:true},mouseDeltaY:{configurable:true},mousePrevX:{configurable:true},mousePrevY:{configurable:true},mouseScrollX:{configurable:true},mouseScrollY:{configurable:true},mouseButtons:{configurable:true},touchCount:{configurable:true},hasKeyDown:{configurable:true},hasKeyUp:{configurable:true},hasMouseDown:{configurable:true},hasMouseUp:{configurable:true}};qi.prototype._registerMousewheelEvent=function e(){this._element.addEventListener("mousewheel",this._mousewheelHandle,{passive:false});this._element.addEventListener("DOMMouseScroll",this._domMouseWheelHandle,{passive:false})};qi.prototype._unregisterMousewheelEvent=function e(){this._element.removeEventListener("mousewheel",this._mousewheelHandle,{passive:true});this._element.removeEventListener("DOMMouseScroll",this._domMouseWheelHandle,{passive:true})};qi.prototype.destroy=function e(){this._element.removeEventListener("mousedown",this._mousedownHandle);this._element.removeEventListener("mouseenter",this._mouseenterHandle);this._element.removeEventListener("mouseleave",this._mouseleaveHandle);this._element.removeEventListener("mousemove",this._mousemoveHandle);this._unregisterMousewheelEvent();this._element.removeEventListener("keydown",this._keydownHandle);this._element.removeEventListener("keyup",this._keyupHandle);this._element.removeEventListener("touchstart",this._touchstartHandle);this._element.removeEventListener("touchend",this._touchendHandle);this._element.removeEventListener("touchcancel",this._touchcancelHandle);this._element.removeEventListener("touchmove",this._touchmoveHandle);this._element.removeEventListener("contextmenu",this._contextmenuHandle);this._uninstallGlobalEvents()};qi.prototype._registerEvents=function e(){this._element.addEventListener("mousedown",this._mousedownHandle);this._element.addEventListener("mouseenter",this._mouseenterHandle);this._element.addEventListener("mouseleave",this._mouseleaveHandle);this._element.addEventListener("mousemove",this._mousemoveHandle);this._registerMousewheelEvent();this._element.addEventListener("keydown",this._keydownHandle);this._element.addEventListener("keyup",this._keyupHandle);this._element.addEventListener("touchstart",this._touchstartHandle,false);this._element.addEventListener("touchend",this._touchendHandle,false);this._element.addEventListener("touchcancel",this._touchcancelHandle,false);this._element.addEventListener("touchmove",this._touchmoveHandle,false);this._element.addEventListener("contextmenu",this._contextmenuHandle)};qi.prototype._installGlobalEvents=function e(){if(this._globalEventInstalled){return}document.addEventListener("mouseup",this._mouseupHandle);document.addEventListener("mousemove",this._mousemoveHandle);document.addEventListener("mousewheel",this._mousewheelHandle,{passive:true});if(this._useMask){Wi.style.cursor=this._maskCursor||"default";document.body.appendChild(Wi)}this._globalEventInstalled=true};qi.prototype._uninstallGlobalEvents=function e(){if(!this._globalEventInstalled){return}if(this._mouse.left!==Bi&&this._mouse.left!==ki||this._mouse.right!==Bi&&this._mouse.right!==ki||this._mouse.middle!==Bi&&this._mouse.middle!==ki){return}this._lockPointer(false);if(this._mouseGrabbed){return}document.removeEventListener("mouseup",this._mouseupHandle);document.removeEventListener("mousemove",this._mousemoveHandle);document.removeEventListener("mousewheel",this._mousewheelHandle,{passive:true});if(this._useMask){Wi.remove()}this._globalEventInstalled=false};qi.prototype._lockPointer=function e(t){if(t){if(this._pointerLocked){return}if(this._element.requestPointerLock){this._element.requestPointerLock();this._pointerLocked=true}return}else{if(!this._pointerLocked){return}if(document.exitPointerLock){document.exitPointerLock();this._pointerLocked=false}}};qi.prototype._calcOffsetX=function e(t){return t-this._bcr.left};qi.prototype._calcOffsetY=function e(t){if(this._invertY){return this._bcr.height-(t-this._bcr.top)}return t-this._bcr.top};Yi.enabled.get=function(){return this._enabled};Yi.enabled.set=function(e){if(this._enabled!==e){this._enabled=e;if(this._enabled){this._registerEvents();if(this._mouseGrabbed){this._installGlobalEvents()}}else{this.destroy()}}};Yi.hasTouch.get=function(){return this._hasTouch};Yi.mouseX.get=function(){return this._mouse.x};Yi.mouseY.get=function(){return this._mouse.y};Yi.mouseDeltaX.get=function(){return this._mouse.dx};Yi.mouseDeltaY.get=function(){return this._mouse.dy};Yi.mousePrevX.get=function(){return this._mouse.prevX};Yi.mousePrevY.get=function(){return this._mouse.prevY};Yi.mouseScrollX.get=function(){return this._mouse.scrollX};Yi.mouseScrollY.get=function(){return this._mouse.scrollY};Yi.mouseButtons.get=function(){var e=0;var t=this._mouse.left;if(t===Fi||t===zi){e|=1}t=this._mouse.right;if(t===Fi||t===zi){e|=2}t=this._mouse.middle;if(t===Fi||t===zi){e|=4}return e};Yi.touchCount.get=function(){return this._touches.length};Yi.hasKeyDown.get=function(){var e=this._keys.head;while(e){if(e._state===Fi){return true}}return false};Yi.hasKeyUp.get=function(){var e=this._keys.head;while(e){if(e._state===ki){return true}}return false};Yi.hasMouseDown.get=function(){if(this._mouse.left===Fi||this._mouse.middle===Fi||this._mouse.right===Fi){return true}return false};Yi.hasMouseUp.get=function(){if(this._mouse.left===ki||this._mouse.middle===ki||this._mouse.right===ki){return true}return false};qi.prototype.getTouchInfo=function e(t){return this._touches.data[t]};qi.prototype.reset=function e(){var t=this;if(this._enabled===false){return}this._mouse.prevX=this._mouse.x;this._mouse.prevY=this._mouse.y;this._mouse.dx=0;this._mouse.dy=0;this._mouse.scrollX=0;this._mouse.scrollY=0;if(this._mouse.left===Fi){this._mouse.left=zi}else if(this._mouse.left===ki){this._mouse.left=Bi}if(this._mouse.middle===Fi){this._mouse.middle=zi}else if(this._mouse.middle===ki){this._mouse.middle=Bi}if(this._mouse.right===Fi){this._mouse.right=zi}else if(this._mouse.right===ki){this._mouse.right=Bi}var n=this._keys.head;var r=n;while(r){n=r;r=n._next;if(n._state===Fi){n._state=zi}else if(n._state===ki){t._keys.remove(n)}}for(var i=0;i<this._touches.length;i++){t._touches.data[i].prevX=t._touches.data[i].x;t._touches.data[i].prevY=t._touches.data[i].y;t._touches.data[i].dx=0;t._touches.data[i].dy=0;if(t._touches.data[i]._phase===Ni){t._touches.data[i]._phase=Gi}if(t._touches.data[i]._phase===Vi||t._touches.data[i]._phase===Hi){t._touches.remove(i)}}this._uninstallGlobalEvents()};qi.prototype.resize=function e(){this._bcr=this._element.getBoundingClientRect()};qi.prototype.grabMouse=function e(t){this._mouseGrabbed=t;if(this._enabled===false){return}if(t){this._installGlobalEvents()}else{this._uninstallGlobalEvents()}};qi.prototype.mousedown=function e(t){var n=this._mouse[t];if(n!==undefined){return n===Fi}return false};qi.prototype.mousepress=function e(t){var n=this._mouse[t];if(n!==undefined){return n===Fi||n===zi}return false};qi.prototype.mouseup=function e(t){var n=this._mouse[t];if(n!==undefined){return n===ki}return false};qi.prototype.keydown=function e(t){var n=this._keys.head;while(n){if(n.key===t&&n._state===Fi){return true}n=n._next}return false};qi.prototype.keyup=function e(t){var n=this._keys.head;while(n){if(n.key===t&&n._state===ki){return true}n=n._next}return false};qi.prototype.keypress=function e(t){var n=this._keys.head;while(n){if(n.key===t&&(n._state===Fi||n._state===zi)){return true}n=n._next}return false};Object.defineProperties(qi.prototype,Yi);var Ki=function e(t,n){if(n===void 0)n={};this.name=t;this.detail=n.detail;this.bubbles=!!n.bubbles;this.target=null;this._stopped=false};Ki.prototype.stop=function e(){this._stopped=true};var Zi=Object.prototype.hasOwnProperty;function Ji(){var e=Object.create(null);e.__tmp__=undefined;delete e.__tmp__;return e}function Qi(e,t,n){this.fn=e;this.context=t;this.once=n||false}function $i(e,t,n,r,i){var a=new Qi(n,r||e,i);if(!e._events[t]){e._events[t]=a;e._eventsCount++}else if(!e._events[t].fn){e._events[t].push(a)}else{e._events[t]=[e._events[t],a]}return e}function ea(e,t){if(--e._eventsCount===0){e._events=Ji()}else{delete e._events[t]}}function ta(e){var t=e.target;while(t){t.emit(e.name,e);if(!e.bubbles||e._stopped){break}t=t.parent}}var na=function e(){this._events=Ji();this._eventsCount=0};na.mixin=function e(t){Object.getOwnPropertyNames(na.prototype).forEach(function(e){if(t.prototype.hasOwnProperty(e)===false){Object.defineProperty(t.prototype,e,Object.getOwnPropertyDescriptor(na.prototype,e))}});t.prototype.__initEventEmitter=function(){this._events=Ji();this._eventsCount=0}};na.prototype.eventNames=function e(){var t=this;var n=[],r,i;if(this._eventsCount===0){return n}for(i in r=t._events){if(Zi.call(r,i)){n.push(i)}}if(Object.getOwnPropertySymbols){return n.concat(Object.getOwnPropertySymbols(r))}return n};na.prototype.listeners=function e(t,n){var r=this._events[t];if(n){return!!r}if(!r){return[]}if(r.fn){return[r.fn]}var i=r.length;var a=new Array(i);for(var s=0;s<i;++s){a[s]=r[s].fn}return a};na.prototype.emit=function e(t,n,r,i,a,s){var o=arguments;var l=this;if(!this._events[t]){return false}var u=this._events[t],f=arguments.length,h,c;if(u.fn){if(u.once){this.off(t,u.fn,undefined,true)}switch(f){case 1:return u.fn.call(u.context),true;case 2:return u.fn.call(u.context,n),true;case 3:return u.fn.call(u.context,n,r),true;case 4:return u.fn.call(u.context,n,r,i),true;case 5:return u.fn.call(u.context,n,r,i,a),true;case 6:return u.fn.call(u.context,n,r,i,a,s),true}for(c=1,h=new Array(f-1);c<f;c++){h[c-1]=o[c]}u.fn.apply(u.context,h)}else{var p=u.length,d;for(c=0;c<p;c++){if(u[c].once){l.off(t,u[c].fn,undefined,true)}switch(f){case 1:u[c].fn.call(u[c].context);break;case 2:u[c].fn.call(u[c].context,n);break;case 3:u[c].fn.call(u[c].context,n,r);break;case 4:u[c].fn.call(u[c].context,n,r,i);break;default:if(!h){for(d=1,h=new Array(f-1);d<f;d++){h[d-1]=o[d]}}u[c].fn.apply(u[c].context,h)}}}return true};na.prototype.on=function e(t,n,r){return $i(this,t,n,r,false)};na.prototype.once=function e(t,n,r){return $i(this,t,n,r,true)};na.prototype.off=function e(t,n,r,i){if(!this._events[t]){return this}if(!n){ea(this,t);return this}var a=this._events[t];if(a.fn){if(a.fn===n&&(!i||a.once)&&(!r||a.context===r)){ea(this,t)}}else{var s=[];for(var o=0,l=a.length;o<l;o++){if(a[o].fn!==n||i&&!a[o].once||r&&a[o].context!==r){s.push(a[o])}}if(s.length){this._events[t]=s.length===1?s[0]:s}else{ea(this,t)}}return this};na.prototype.removeAllListeners=function e(t){if(t){if(this._events[t]){ea(this,t)}}else{this._events=Ji();this._eventsCount=0}return this};na.prototype.dispatch=function e(t,n){var r=t;if(typeof t==="string"){r=new Ki(t,n)}r.target=this;ta(r)};var ra=function(e){function t(t,n){e.call(this,t,n);this.component=null}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;return t}(Ki);var ia=function e(){this._enabled=true;this._destroyed=false;this._inited=false;this._app=null;this._system=null;this._entity=null};var aa={enabled:{configurable:true},destroyed:{configurable:true},system:{configurable:true},entity:{configurable:true}};aa.enabled.get=function(){return this._entity.activeInHierarchy&&this._enabled};aa.enabled.set=function(e){if(this._enabled!==e){this._enabled=e;if(this._entity.activeInHierarchy){if(this._enabled){this.onEnable&&this.onEnable()}else{this.onDisable&&this.onDisable()}}}};ia.prototype._onEntityActiveChanged=function e(t){if(!this._inited){this._inited=true;if(this.onInit){this.onInit()}}if(this._enabled){if(t){this.onEnable&&this.onEnable()}else{this.onDisable&&this.onDisable()}}};ia.prototype._onComponentNeedDestroy=function e(){if(this._inited){this.onDestroy&&this.onDestroy();this._inited=false}};aa.destroyed.get=function(){return this._entity.destroyed||this._destroyed};aa.system.get=function(){return this._system};aa.entity.get=function(){return this._entity};ia.prototype.dispatch=function e(t,n){var r=t;if(typeof t==="string"){r=new ra(t,n)}r.target=this._entity;r.component=this;this._entity.dispatch(r)};ia.prototype.destroy=function e(){if(this._destroyed){return}this._destroyed=true;var t=this._entity;if(this.enabled){this.onDisable&&this.onDisable()}this._app._destroyComp(this)};Object.defineProperties(ia.prototype,aa);var sa=function e(t){this.__initNode();this.__initEventEmitter();this.name=t||"";this._active=false;this._ancestorActive=false;this._destroyed=false;this._comps=[];this._app=null;this._poolID=-1};var oa={active:{configurable:true},activeInHierarchy:{configurable:true},destroyed:{configurable:true}};oa.active.get=function(){return this._active};oa.active.set=function(e){e=!!e;if(this._active!==e){if(e){this.activate()}else{this.deactivate()}}};oa.activeInHierarchy.get=function(){return this._active&&this._ancestorActive};oa.destroyed.get=function(){return this._destroyed};sa.prototype.activate=function e(){if(this._active===true){return}this._active=true;if(this._ancestorActive){this._notifyComponents(true);this._notifyChildren(true)}};sa.prototype.deactivate=function e(){if(this._active===false){return}this._active=false;if(this._ancestorActive){this._notifyComponents(false);this._notifyChildren(false)}};sa.prototype._notifyComponents=function e(t){var n=this;this.emit(t?"active":"inactive");for(var r=0;r<this._comps.length;++r){var i=n._comps[r];i._onEntityActiveChanged(t)}};sa.prototype._notifyChildren=function e(t){var n=this;for(var r=0;r<this._children.length;++r){var i=n._children[r];i._ancestorActive=t;if(i.active){i._notifyComponents(t);i._notifyChildren(t)}}};sa.prototype.destroy=function e(){var t=this;if(this._destroyed){return}this._destroyed=true;for(var n=0;n<this._children.length;++n){var r=t._children[n];r.destroy()}for(var i=0;i<this._comps.length;++i){var a=t._comps[i];a.destroy()}if(this.activeInHierarchy){this.emit("inactive")}this._app._destroyEntity(this)};sa.prototype._onParentChanged=function e(t,n){var r=!!(t&&t.activeInHierarchy);this._ancestorActive=!!(n&&n.activeInHierarchy);if(this._active&&this._ancestorActive!==r){this._notifyComponents(this._ancestorActive);this._notifyChildren(this._ancestorActive)}this.emit("parent-changed",t,n)};sa.prototype.clone=function e(){return this._app.cloneEntity(this)};sa.prototype.deepClone=function e(){return this._app.deepCloneEntity(this)};sa.prototype.getComp=function e(t){var n=this;var r=this._app.getClass(t);for(var i=0;i<this._comps.length;++i){var a=n._comps[i];if(a instanceof r){return a}}return null};sa.prototype.getComps=function e(t){var n=this;var r=this._app.getClass(t);var i=[];for(var a=0;a<this._comps.length;++a){var s=n._comps[a];if(s instanceof r){i.push(s)}}return i};sa.prototype.getCompsInChildren=function e(t){var n=this._app.getClass(t);var r=[];kr.walk(this,function(e){for(var t=0;t<e._comps.length;++t){var i=e._comps[t];if(i instanceof n){r.push(i)}}});return r};sa.prototype.addComp=function e(t,n){var r=this._app.getClass(t);if(!r.multiple){if(this.getComp(t)){return null}}var i=this._app._createComp(r,this,n);this._comps.push(i);if(this.activeInHierarchy){i._onEntityActiveChanged(true)}return i};sa.prototype._removeComp=function e(t){var n=this;for(var r=0;r<this._comps.length;++r){var i=n._comps[r];if(i===t){n._comps.splice(r,1);return true}}return false};Object.defineProperties(sa.prototype,oa);Ur.mixin(sa);na.mixin(sa);var la=function(e){function t(t){e.call(this,t)}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.addComp=function e(){console.warn("Can not add component in level")};t.prototype.setParent=function e(){console.error("Can not set parent to level")};t.prototype.activate=function t(){if(this._active===true&&this._ancestorActive===true){return}this._ancestorActive=true;e.prototype.activate.call(this)};t.prototype.deactivate=function t(){if(this._active===false&&this._ancestorActive===false){return}this._ancestorActive=false;e.prototype.deactivate.call(this)};return t}(sa);var ua=function e(){this._enabled=true;this._id="";this._app=null;this._priority=0;this._componentCls=null};ua.prototype.init=function e(){};ua.prototype.add=function e(){};ua.prototype.remove=function e(){};ua.prototype.tick=function e(){};ua.prototype.postTick=function e(){};function fa(e){return function(t,n,r,i){var a=t.getClass(e);if(a===undefined){console.warn("Can not find class "+e+".");return null}n=n||{};if(n instanceof a){return n}if(n.constructor&&n.constructor.__classname__){console.warn("Invalid class instance, it is not instanceof "+e+".");return null}var s=new a;_a(t,s,n,i);return s}}function ha(e){if(e){return function(t,n,r,i){if(n===null){return[]}var a=new Array(n.length);for(var s=0;s<n.length;++s){a[s]=e(t,n[s],r,i)}return a}}return function(e,t){return t}}function ca(e,t){if(t.parse){return t.parse}var n=null;var r=e.getType(t.type);if(r){n=r.parse||null}else{n=fa(t.type)}if(t.array){return ha(n)}return n}function pa(e,t,n,r){if(r){if(n.set){return function(t){n.set.call(this,r(e,t,n))}}return function(i){this[t]=r(e,i,n)}}if(n.set){return n.set}return function(e){this[t]=e}}function da(e,t,n){if(n.get){return n.get}return function(){return this[t]}}function ma(e,t){var n={};for(var r in t){var i=t[r];if(i.type===undefined&&i.default===undefined){console.warn("Invalid property "+r+": you must provide 'default' or 'type'.");continue}if(i.array===undefined){i.array=false}if(i.array&&i.type===undefined){console.warn("Invalid property "+r+": array value must have a 'type'.");continue}var a=i.type;if(a===undefined){i.type=typeof i.default}if(i.default===undefined){var s=e.getType(i.type);if(s){i.default=s.default}else{i.default=null}}var o=ca(e,i);var l="_"+r;var u=da(e,l,i);var f=pa(e,l,i,o);n[r]={configurable:true,enumerable:true,get:u,set:f}}return n}function _a(e,t,n,r){var i=t.constructor;while(i.__classname__!==undefined){if(i.hasOwnProperty("schema")===false){i=Object.getPrototypeOf(i);continue}for(var a in i.schema){var s="_"+a;if(t[s]!==undefined){continue}var o=i.schema[a];var l=ca(e,o);var u=n&&n[a];if(u===undefined){u=o.default}if(l){var f=l(e,u,o,r);t[s]=f}else{t[s]=u}}i=Object.getPrototypeOf(i)}}var va={createPrototypeAccessors:ma,parse:_a};var ga=function e(t){var n=this;if(t===void 0)t={};var r=t.poolSize||100;this._types={};this._classes={};this._systems=[];this._activeLevel=new la;this._activeLevel._app=this;this._activeLevel.activate();this._entities=new or(r);this._deadComponents=new or(r);this._deadEntities=new or(r);if(t.systems){for(var i=0;i<t.systems.length;++i){var a=t.systems[i];n.registerSystem(a.id,a.system,a.component,a.priority)}}this._sortSystems()};var ya={activeLevel:{configurable:true}};ya.activeLevel.get=function(){return this._activeLevel};ga.prototype.registerType=function e(t,n){this._types[t]=n};ga.prototype.registerClass=function e(t,n){n.__classname__=t;var r=null;if(n.hasOwnProperty("schema")){r=n.schema}if(r){var i=va.createPrototypeAccessors(this,r);Object.defineProperties(n.prototype,i)}this._classes[t]=n};ga.prototype.registerSystem=function e(t,n,r,i){if(i===void 0)i=0;var a=new n;a._id=t;a._app=this;a._priority=i;a._componentCls=this.getClass(r);if(!a._componentCls){console.warn("Failed to get class "+r+", please register it first.")}a.init();this._systems.push(a);return a};ga.prototype.getType=function e(t){return this._types[t]};ga.prototype.getClass=function e(t){return this._classes[t]};ga.prototype.getClassName=function e(t){if(typeof t==="function"){return t.__classname__}return t.constructor.__classname__};ga.prototype.createObject=function e(t,n){var r=this.getClass(t);var i=new r;va.parse(this,i,n||{});return i};ga.prototype.createEntity=function e(t,n){if(n===void 0)n=null;var r=new sa(t);r._app=this;r._active=true;this._entities.push(r);var i=n||this._activeLevel;if(i){r.setParent(i)}return r};ga.prototype.cloneEntity=function e(t){var n=this;return kr.clone(t,sa,function(e,t){e._app=n;e._active=t._active;for(var r=0;r<t._comps.length;++r){var i=t._comps[r];if(i._destroyed){continue}var a=n._createComp(i.constructor,e,i);a._enabled=i._enabled;if(a.onClone){a.onClone(i)}e._comps.push(a)}n._entities.push(e)})};ga.prototype.deepCloneEntity=function e(t){var n=this;return kr.deepClone(t,sa,function(e,t){e._app=n;e._active=t._active;for(var r=0;r<t._comps.length;++r){var i=t._comps[r];if(i._destroyed){continue}var a=n._createComp(i.constructor,e,i);a._enabled=i._enabled;if(a.onClone){a.onClone(i)}e._comps.push(a)}n._entities.push(e)})};ga.prototype.loadLevel=function e(t){if(this._activeLevel){kr.walk(this._activeLevel,function(e){e.destroy()})}this._activeLevel=t;this._activeLevel._app=this;this._activeLevel.activate()};ga.prototype.tick=function e(){var t=this;for(var n=0;n<this._systems.length;++n){var r=t._systems[n];r.tick()}for(var i=0;i<this._systems.length;++i){var a=t._systems[i];a.postTick()}for(var s=0;s<this._deadComponents.length;++s){var o=t._deadComponents.data[s];o._onComponentNeedDestroy();o._entity._removeComp(o);for(var l=0;l<o.__events__.length;++l){var u=o.__events__[l];o._entity.off(u.name,u.fn)}o._app=null;o._system=null;o._entity=null}for(var f=0;f<this._deadEntities.length;++f){var h=t._deadEntities.data[f];h.emit("destroy");if(h._parent&&h._parent._destroyed===false){h.setParent(null)}var c=t._entities.data[t._entities.length-1];t._entities.fastRemove(h._poolID);c._poolID=h._poolID;h._poolID=-1;h._app=null;h._parent=null;h._children.length=0;h._comps.length=0}this._deadComponents.reset();this._deadEntities.reset()};ga.prototype.system=function e(t){var n=this;for(var r=0;r<this._systems.length;++r){var i=n._systems[r];if(i._id===t){return i}}return null};ga.prototype._getSystem=function e(t){var n=this;for(var r=0;r<this._systems.length;++r){var i=n._systems[r];if(t instanceof i._componentCls){return i}}return null};ga.prototype._destroyEntity=function e(t){this._deadEntities.push(t)};ga.prototype._finalizeComp=function e(t,n,r){var i=t._entity;var a=t.constructor;while(a.__classname__!==undefined){if(a.hasOwnProperty("events")){for(var s in a.events){var o=a.events[s];var l=t[o];if(l){l=l.bind(t);i.on(s,l);t.__events__.push({name:s,fn:l})}}}a=Object.getPrototypeOf(a)}va.parse(this,t,n,r)};ga.prototype._createComp=function e(t,n,r){if(r===void 0)r={};var i=new t;i._app=this;i._system=this._getSystem(i);i._entity=n;i.__events__=[];this._finalizeComp(i,r,null);return i};ga.prototype._destroyComp=function e(t){this._deadComponents.push(t)};ga.prototype._sortSystems=function e(){this._systems.sort(function(e,t){return e._priority-t._priority})};Object.defineProperties(ga.prototype,ya);var ba=[];var xa=[];var Ta=[];var Sa=[];var Ea={registerLoader:function e(t,n){ba.push({id:t,def:n})},registerType:function e(t,n){Ta.push({id:t,def:n})},registerClass:function e(t,n){xa.push({id:t,def:n})},registerSystem:function e(t,n,r,i){Sa.push({id:t,system:n,component:r,priority:i})},_init:function e(t){for(var n=0;n<ba.length;++n){var r=ba[n];t._assetMng.registerLoader(r.id,r.def)}for(var i=0;i<Ta.length;++i){var a=Ta[i];t.registerType(a.id,a.def)}for(var s=0;s<xa.length;++s){var o=xa[s];t.registerClass(o.id,o.def)}for(var l=0;l<Sa.length;++l){var u=Sa[l];t.registerSystem(u.id,u.system,u.component,u.priority)}}};var wa=["manifest","onDone","onProgress","onError"];var Ma=["type","src","stream","credentials","parser"];var Aa=["onData","onDone"];var Ra=-1;var Ua=0;var Da=1;function La(e){throw new Error("resl: "+e)}function Oa(e,t,n){Object.keys(e).forEach(function(e){if(t.indexOf(e)<0){La('invalid parameter "'+e+'" in '+n)}})}function Ia(e,t){this.state=Ua;this.ready=false;this.progress=0;this.name=e;this.cancel=t}function Ca(e){if(typeof e!=="object"||!e){La("invalid or missing configuration")}Oa(e,wa,"config");var t=e.manifest;if(typeof t!=="object"||!t){La("missing manifest")}function n(t){if(t in e){var n=e[t];if(typeof n!=="function"){La('invalid callback "'+t+'"')}return n}return null}var r=n("onDone");if(!r){La("missing onDone() callback")}var i=n("onProgress");var a=n("onError");var s={};var o=Ua;function l(e){var t=e.name;var n=e.stream;var r=e.type==="binary";var i=e.parser;var a=new XMLHttpRequest;var o=null;var l=new Ia(t,f);if(n){a.onreadystatechange=u}else{a.onreadystatechange=function(){if(a.readyState===4){u()}}}if(r){a.responseType="arraybuffer"}function u(){if(a.readyState<2||l.state===Da||l.state===Ra){return}if(a.status!==200){return c('error loading resource "'+e.name+'"')}if(a.readyState>2&&l.state===Ua){var n;if(e.type==="binary"){n=a.response}else{n=a.responseText}if(i.data){try{o=i.data(n)}catch(e){return c(e)}}else{o=n}}if(a.readyState>3&&l.state===Ua){if(i.done){try{o=i.done()}catch(e){return c(e)}}l.state=Da}s[t]=o;l.progress=.75*l.progress+.25;l.ready=e.stream&&!!o||l.state===Da;p()}function f(){if(l.state===Da||l.state===Ra){return}a.onreadystatechange=null;a.abort();l.state=Ra}if(e.credentials){a.withCredentials=true}a.open("GET",e.src,true);a.send();return l}function u(e,t){var n=e.name;var r=e.parser;var i=new Ia(n,_);var a=t;function o(){if(i.state===Ua){if(r.data){try{a=r.data(t)}catch(e){return c(e)}}else{a=t}}}function l(e){o();s[n]=a;if(e.lengthComputable){i.progress=Math.max(i.progress,e.loaded/e.total)}else{i.progress=.75*i.progress+.25}p(n)}function u(){o();if(i.state===Ua){if(r.done){try{a=r.done()}catch(e){return c(e)}}i.state=Da}i.progress=1;i.ready=true;s[n]=a;m();p("finish "+n)}function f(){c('error loading asset "'+n+'"')}if(e.stream){t.addEventListener("progress",l)}if(e.type==="image"){t.addEventListener("load",u)}else{var h=false;var d=false;t.addEventListener("loadedmetadata",function(){d=true;if(h){u()}});t.addEventListener("canplay",function(){h=true;if(d){u()}})}t.addEventListener("error",f);function m(){if(e.stream){t.removeEventListener("progress",l)}if(e.type==="image"){t.addEventListener("load",u)}else{t.addEventListener("canplay",u)}t.removeEventListener("error",f)}function _(){if(i.state===Da||i.state===Ra){return}i.state=Ra;m();t.src=""}if(e.credentials){t.crossOrigin="use-credentials"}else{t.crossOrigin="anonymous"}t.src=e.src;return i}var f={text:l,binary:function(e){return l(e)},image:function(e){return u(e,document.createElement("img"))},video:function(e){return u(e,document.createElement("video"))},audio:function(e){return u(e,document.createElement("audio"))}};var h=Object.keys(t).map(function(e){var n=t[e];if(typeof n==="string"){n={src:n}}else if(typeof n!=="object"||!n){La('invalid asset definition "'+e+'"')}Oa(n,Ma,'asset "'+e+'"');function r(t,r,i){var a=i;if(t in n){a=n[t]}if(r.indexOf(a)<0){La("invalid "+t+' "'+a+'" for asset "'+e+'", possible values: '+r)}return a}function i(t,r,i){var a=i;if(t in n){a=n[t]}else if(r){La("missing "+t+' for asset "'+e+'"')}if(typeof a!=="string"){La("invalid "+t+' for asset "'+e+'", must be a string')}return a}function a(e,t){if(e in n.parser){var r=n.parser[e];if(typeof r!=="function"){La("invalid parser callback "+e+' for asset "'+e+'"')}return r}else{return t}}var s={};if("parser"in n){if(typeof n.parser==="function"){s={data:n.parser}}else if(typeof n.parser==="object"&&n.parser){Oa(n.parser,Aa,'parser for asset "'+e+'"');if(!("onData"in n.parser)){La('missing onData callback for parser in asset "'+e+'"')}s={data:a("onData"),done:a("onDone")}}else{La('invalid parser for asset "'+e+'"')}}return{name:e,type:r("type",Object.keys(f),"text"),stream:!!n.stream,credentials:!!n.credentials,src:i("src",true,""),parser:s}}).map(function(e){return f[e.type](e)});function c(e){if(o===Ra||o===Da){return}o=Ra;h.forEach(function(e){e.cancel()});if(a){if(typeof e==="string"){a(new Error("resl: "+e))}else{a(e)}}else{console.error("resl error:",e)}}function p(e){if(o===Ra||o===Da){return}var t=0;var n=0;h.forEach(function(e){if(e.ready){n+=1}t+=e.progress});if(n===h.length){o=Da;r(s)}else{if(i){i(t/h.length,e)}}}if(h.length===0){setTimeout(function(){p("done")},1)}}var Pa=-1;var Ba=function e(){++Pa;this._uuid="internal-"+Pa;this._name="";this._loaded=false};var Fa={uuid:{configurable:true},name:{configurable:true}};Fa.uuid.get=function(){return this._uuid};Fa.name.get=function(){return this._name};Ba.prototype.subAsset=function e(){return null};Ba.prototype.unload=function e(){this._loaded=false};Ba.prototype.reload=function e(){};Ba.prototype.clone=function e(){};Object.defineProperties(Ba.prototype,Fa);var za=function(e){function t(){e.call(this);this._subMeshes=null;this._skinning=null;this._minPos=null;this._maxPos=null}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;var n={skinning:{configurable:true},subMeshCount:{configurable:true}};t.prototype.unload=function t(){var n=this;if(!this._loaded){return}this._subMeshes[0]._vertexBuffer.destroy();for(var r=0;r<this._subMeshes.length;++r){var i=n._subMeshes[r];i._indexBuffer.destroy()}this._subMeshes=null;e.prototype.unload.call(this)};n.skinning.get=function(){return this._skinning};n.subMeshCount.get=function(){return this._subMeshes.length};t.prototype.getSubMesh=function e(t){return this._subMeshes[t]};Object.defineProperties(t.prototype,n);return t}(Ba);var ka=function(e){function t(t){e.call(this);this._device=t;this._texture=null}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;return t}(Ba);var Na={linear:Me.FILTER_LINEAR,nearest:Me.FILTER_NEAREST};var Ga={repeat:Me.WRAP_REPEAT,clamp:Me.WRAP_CLAMP,mirror:Me.WRAP_MIRROR};var Va={"rgb-dxt1":Me.TEXTURE_FMT_RGB_DXT1,"rgba-dxt1":Me.TEXTURE_FMT_RGBA_DXT1,"rgba-dxt3":Me.TEXTURE_FMT_RGBA_DXT3,"rgba-dxt5":Me.TEXTURE_FMT_RGBA_DXT5,"rgb-etc1":Me.TEXTURE_FMT_RGB_ETC1,"rgb-pvrtc-2bppv1":Me.TEXTURE_FMT_RGB_PVRTC_2BPPV1,"rgba-pvrtc-2bppv1":Me.TEXTURE_FMT_RGBA_PVRTC_2BPPV1,"rgb-pvrtc-4bppv1":Me.TEXTURE_FMT_RGB_PVRTC_4BPPV1,"rgba-pvrtc-4bppv1":Me.TEXTURE_FMT_RGBA_PVRTC_4BPPV1,a8:Me.TEXTURE_FMT_A8,l8:Me.TEXTURE_FMT_L8,"l8-a8":Me.TEXTURE_FMT_L8_A8,"r5-g6-b5":Me.TEXTURE_FMT_R5_G6_B5,"r5-g5-b5-a1":Me.TEXTURE_FMT_R5_G5_B5_A1,"r4-g4-b4-a4":Me.TEXTURE_FMT_R4_G4_B4_A4,rgb8:Me.TEXTURE_FMT_RGB8,rgba8:Me.TEXTURE_FMT_RGBA8,rgb16f:Me.TEXTURE_FMT_RGB16F,rgba16f:Me.TEXTURE_FMT_RGBA16F,rgb32f:Me.TEXTURE_FMT_RGB32F,rgba32f:Me.TEXTURE_FMT_RGBA32F,r32f:Me.TEXTURE_FMT_R32F,"111110f":Me.TEXTURE_FMT_111110F,srgb:Me.TEXTURE_FMT_SRGB,srgba:Me.TEXTURE_FMT_SRGBA,d16:Me.TEXTURE_FMT_D16,d32:Me.TEXTURE_FMT_D32,d24s8:Me.TEXTURE_FMT_D24S8};var Ha={images:[],mipmap:true,width:2,height:2,format:Me.TEXTURE_FMT_RGBA8,anisotropy:1,wrapS:Me.WRAP_REPEAT,wrapT:Me.WRAP_REPEAT,minFilter:Me.FILTER_LINEAR,magFilter:Me.FILTER_LINEAR,mipFilter:Me.FILTER_LINEAR,premultiplyAlpha:false};function Wa(e,t){if(t._writable){e.images=[t._data]}else{e.images=t._images}e.mipmap=t._mipmap;e.width=t._width;e.height=t._height;e.format=Va[t._format];e.anisotropy=t._anisotropy;e.wrapS=Ga[t._wrapS];e.wrapT=Ga[t._wrapT];e.minFilter=Na[t._minFilter];e.magFilter=Na[t._magFilter];e.mipFilter=Na[t._mipFilter];e.premultiplyAlpha=t._premultiplyAlpha}function Xa(e){if(e._format==="a8"){return new Uint8Array(e._width*e._height)}else if(e._format==="rgb8"){return new Uint8Array(e._width*e._height*3)}else if(e._format==="rgba8"){return new Uint8Array(e._width*e._height*4)}else if(e._format==="rgba32f"){return new Float32Array(e._width*e._height*4)}return null}var ja=function(e){function t(t,n,r,i){if(n===void 0)n=2;if(r===void 0)r=2;if(i===void 0)i="rgba8";e.call(this,t);this._writable=false;this._data=null;this._images=[];this._mipmap=true;this._width=n;this._height=r;this._format=i;this._anisotropy=1;this._wrapS="repeat";this._wrapT="repeat";this._minFilter="linear";this._magFilter="linear";this._mipFilter="linear";this._premultiplyAlpha=false}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;var n={width:{configurable:true},height:{configurable:true},format:{configurable:true},data:{configurable:true},writable:{configurable:true},mipmap:{configurable:true},anisotropy:{configurable:true},wrapS:{configurable:true},wrapT:{configurable:true},minFilter:{configurable:true},magFilter:{configurable:true},mipFilter:{configurable:true},premultiplyAlpha:{configurable:true}};t.prototype.unload=function t(){if(!this._loaded){return}this._texture.destroy();e.prototype.unload.call(this)};t.prototype.setImage=function e(t,n){if(n instanceof HTMLCanvasElement||n instanceof HTMLImageElement||n instanceof HTMLVideoElement){this._images[t]=n;if(t===0){this.resize(n.width,n.height)}}};t.prototype.setImages=function e(t){this._images=t;this.resize(t[0].width,t[0].height)};t.prototype.resize=function e(t,n){this._width=t;this._height=n;if(this._writable){this._data=Xa(this)}};n.width.get=function(){return this._width};n.height.get=function(){return this._height};n.format.get=function(){return this._format};n.data.get=function(){return this._data};n.writable.set=function(e){this._writable=e;if(this._writable){this._data=Xa(this)}else{this._data=null}};n.writable.get=function(){return this._writable};n.mipmap.set=function(e){this._mipmap=e};n.mipmap.get=function(){return this._mipmap};n.anisotropy.set=function(e){this._anisotropy=e};n.anisotropy.get=function(){return this._anisotropy};n.wrapS.set=function(e){this._wrapS=e};n.wrapS.get=function(){return this._wrapS};n.wrapT.set=function(e){this._wrapT=e};n.wrapT.get=function(){return this._wrapT};n.minFilter.set=function(e){this._minFilter=e};n.minFilter.get=function(){return this._minFilter};n.magFilter.set=function(e){this._magFilter=e};n.magFilter.get=function(){return this._magFilter};n.mipFilter.set=function(e){this._mipFilter=e};n.mipFilter.get=function(){return this._mipFilter};n.premultiplyAlpha.set=function(e){this._premultiplyAlpha=e};n.premultiplyAlpha.get=function(){return this._premultiplyAlpha};t.prototype.commit=function e(){Wa(Ha,this);if(!this._texture){this._texture=new Me.Texture2D(this._device,Ha)}else{this._texture.update(Ha)}this._images=[]};Object.defineProperties(t.prototype,n);return t}(ka);function qa(e,t){var n=e.length;if(n===0){t(null)}var r=0;for(var i=0;i<e.length;++i){var a=e[i];a(function(e){if(e){t(e)}else if(++r===n){t(null)}})}}var Ya={parallel:qa};function Ka(e,t){for(var n=0;n<t.length;n++){var r=t[n];var i=e.entities[r.entity];var a=r.property.split(".");if(a.length===1){i[r.property]=r.value;continue}var s=null;for(var o=0;o<i.components.length;o++){var l=a[0];var u=i.components[o];if(u.type===l){s=u;break}}if(s===null){console.warn("Failed to apply modification for entity "+i.name+": component "+a[0]+" not found.");continue}var f=a[1];var h=f.match(/(.*)\[(\d+)\]/);if(h){var c=h[1];var p=parseInt(h[2]);s.properties[c][p]=r.value}else{if(a[1]==="enabled"){s[a[1]]=r.value}else{s.properties[a[1]]=r.value}}}return e}function Za(e,t,n){var r=e.getClass(n.type);if(!r){var i=new ia;i._app=e;i._system=null;i._entity=t;i.__events__=[];if(n.enabled!==undefined){i._enabled=n.enabled}console.error("component type "+n.type+" not found.");return i}var a=new r;a._app=e;a._system=e._getSystem(a);a._entity=t;a.__events__=[];if(n.enabled!==undefined){a._enabled=n.enabled}return a}function Ja(e,t,n){var r=e.createEntity(t.name,n);if(t.enabled!==undefined){r._active=t.enabled}if(!t.components){return r}r._comps=new Array(t.components.length);for(var i=0;i<t.components.length;++i){var a=t.components[i];r._comps[i]=Za(e,r,a)}return r}function Qa(e,t,n,r){if(n){t=JSON.parse(JSON.stringify(t));t=Ka(t,n)}var i=t.entities;var a=new Array(t.entities.length);for(var s=0;s<i.length;++s){var o=i[s];if(o.prefab){console.warn("nested prefab have not implemented.")}else{a[s]=Ja(e,o,r)}}es(e,a,i);return a[0]}function $a(e,t,n){var r={};var i=t.preloads;var a=[];var s=function(t){var n=i[t];a.push(function(t){e.assets.load(n,function(e,i){if(e){console.error(e);t();return}r[n]=i;t()})})};for(var o=0;o<i.length;++o)s(o);Ya.parallel(a,function(e){n(e,r)})}function es(e,t,n){for(var r=0;r<n.length;++r){var i=t[r];var a=n[r];if(!i){continue}if(a.translation){Ut.set(i.lpos,a.translation[0],a.translation[1],a.translation[2])}else{Ut.set(i.lpos,0,0,0)}if(a.rotation){Ot.set(i.lrot,a.rotation[0],a.rotation[1],a.rotation[2],a.rotation[3])}else{Ot.set(i.lrot,0,0,0,1)}if(a.scale){Ut.set(i.lscale,a.scale[0],a.scale[1],a.scale[2])}else{Ut.set(i.lscale,1,1,1)}if(a.children){for(var s=0;s<a.children.length;++s){var o=a.children[s];i.append(t[o])}}if(a.components){for(var l=0;l<a.components.length;++l){var u=i._comps[l];var f=a.components[l];e._finalizeComp(u,f.properties,t)}}}}var ts={createComponent:Za,createEntity:Ja,createPrefab:Qa,preloadAssets:$a,finalize:es};function ns(e,t,n){ts.preloadAssets(e,t,function(){var r=t.entities;var i=new Array(t.entities.length);var a=new la;for(var s=0;s<r.length;++s){var o=r[s];if(o.prefab){var l=e.assets.get(o.prefab);if(!l){console.error("Failed to load prefab "+o.prefab);continue}i[s]=l.instantiate(o.modifications,a)}else{i[s]=ts.createEntity(e,o,a)}console.log(o.name+" loaded")}ts.finalize(e,i,t.entities);for(var u=0;u<t.children.length;++u){var f=t.children[u];a.append(i[f])}var h=t.skyboxes;var c=function(t){var n=h[t];e.assets.load(n.texture,function(t,r){var i=e.find(n.camera);if(i==null){return}var a=i.addComp("Skybox");a.cubeMap=r})};for(var p=0;p<h.length;++p)c(p);if(n){n(null,a)}})}function rs(e,t){var n=t.jointIndices.length;var r;if(n>256){r=64}else if(n>64){r=32}else if(n>16){r=16}else{r=8}var i=new ja(e.device,r,r,"rgba32f");i.minFilter="nearest";i.magFilter="nearest";i.wrapS="clamp";i.wrapT="clamp";i.mipmap=false;i.writable=true;i.commit();return i}function is(e,t){var n=Pi.createIA(e.device,t);var r=new za;r._subMeshes=[n];r._minPos=t.minPos;r._maxPos=t.maxPos;return r}var as={createJointsTexture:rs,createMesh:is,parseLevel:ns,walk:kr.walk,flat:kr.flat,find:kr.find,Layers:Sr};function ss(){var e=Object.create(null);e.__tmp__=undefined;delete e.__tmp__;return e}function os(e,t){return function(n,r){if(n){if(t){t(n)}return}if(t){if(e){r=r.subAsset(e);if(!r){t(new Error("subasset "+e+" not found."));return}}t(null,r)}}}var ls=function(e){function t(){e.call(this)}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.run=function e(t,n,r){var i=this;t.loadUrls(r.type,r.urls,function(e,r){delete t._loadings[n];if(e){i.emit("loaded",e);return}r._uuid=n;r._loaded=true;t.add(n,r);i.emit("loaded",null,r)})};return t}(na);var us=function e(t){this._app=t;this._loaders=ss();this._assetInfos=ss();this._assets=ss();this._loadings=ss();this._levelInfos=ss()};us.prototype.registerLoader=function e(t,n){this._loaders[t]=n};us.prototype.registerAsset=function e(t,n){if(this._assetInfos[t]){console.warn("asset "+t+" already registerred.");return}this._assetInfos[t]=n};us.prototype.registerLevel=function e(t,n){if(this._levelInfos[t]){console.warn("level "+t+" is already registerred.");return}this._levelInfos[t]=n};us.prototype.loadLevel=function e(t,n){if(!this._levelInfos[t]){console.error("Cannot load scene "+t);n&&n(new Error("loadFail"),null)}else{var r=this._app;Ca({manifest:{sceneJson:{type:"text",parser:JSON.parse,src:this._levelInfos[t]}},onDone:function e(t){as.parseLevel(r,t.sceneJson,function(e,t){n&&n(e,t)})},onError:function e(t){n&&n(t,null)}})}};us.prototype.add=function e(t,n){if(this._assets[t]){console.warn("Failed to add asset "+t+", already exists.");return}this._assets[t]=n};us.prototype.get=function e(t){var n=t.indexOf("@");if(n===-1){return this._assets[t]}var r=t.substring(0,n);t=t.substring(n+1);var i=this._assets[t];if(i&&r){return i.subAsset(r)}return null};us.prototype.load=function e(t,n){var r=t.indexOf("@");var i;if(r!==-1){i=t.substring(0,r);t=t.substring(r+1)}var a=this._assets[t];if(a){if(n){if(i){a=a.subAsset(i);if(!a){n(new Error("subasset "+i+" not found."));return}}n(null,a)}return}var s=this._loadings[t];var o=os(i,n);if(s){s.once("loaded",o);return}var l=this._assetInfos[t];if(!l){if(n){n(new Error("asset info "+t+" not found, please add it first."))}return}s=new ls(this);this._loadings[t]=s;s.once("loaded",os(i,n));s.run(this,t,l)};us.prototype.loadUrls=function e(t,n,r){var i=this._loaders[t];if(!i){if(r){r(new Error("can not find loader for asset type "+t+", please register it first."))}return}i(this._app,n,r)};var fs=10;var hs=10;var cs=Ut.new(0,0,-1);var ps=Ut.new(1,0,0);var ds=Ut.new(0,1,0);var ms=Lt.create();var _s=Ut.zero();var vs=Ut.zero();var gs=Ut.new(0,1,0);var ys=Ut.zero();var bs=Ut.zero();var xs=function e(t){this._input=t;this._node=new Ur("debug-camera");Ut.set(this._node.lpos,10,10,10);this._node.lookAt(Ut.new(0,0,0));this._df=0;this._dr=0;this._panX=0;this._panY=0;this._panZ=0;this._rotX=0;this._rotY=0;this._curRot=Ot.create();this._destRot=Ot.create();this._curEye=Ut.zero();this._destEye=Ut.zero();this._node.getWorldRot(this._curRot);this._destRot=Ot.clone(this._curRot);this._node.getWorldPos(this._curEye);this._destEye=Ut.clone(this._curEye)};xs.prototype.reset=function e(){this._df=0;this._dr=0;this._du=0;this._panX=0;this._panY=0;this._panZ=0;this._rotX=0;this._rotY=0;this._node.getWorldRot(this._curRot);this._destRot=Ot.clone(this._curRot);this._node.getWorldPos(this._curEye);this._destEye=Ut.clone(this._curEye)};xs.prototype.tick=function e(t){var n=this._input;this._handleMouseAndKeyboard();if(n.hasTouch){this._handleTouches()}this._lerp(t)};xs.prototype._handleMouseAndKeyboard=function e(){var t=this._input;this._df=0;this._dr=0;this._du=0;this._panX=0;this._panY=0;this._panZ=0;this._rotX=0;this._rotY=0;if(t.mousepress("left")&&t.mousepress("right")){var n=t.mouseDeltaX;var r=t.mouseDeltaY;this._panX=n;this._panY=-r}else if(t.mousepress("left")){var i=t.mouseDeltaX;var a=t.mouseDeltaY;this._rotY=-i*.002;this._panZ=-a}else if(t.mousepress("right")){var s=t.mouseDeltaX;var o=t.mouseDeltaY;this._rotY=-s*.002;this._rotX=-o*.002}if(t.keypress("w")){this._df+=1}if(t.keypress("s")){this._df-=1}if(t.keypress("a")){this._dr-=1}if(t.keypress("d")){this._dr+=1}if(t.keypress("q")){this._du-=1}if(t.keypress("e")){this._du+=1}if(t.mouseScrollY){this._df-=t.mouseScrollY*.05}};xs.prototype._handleTouches=function e(){var t=this._input;this._df=0;this._dr=0;this._panX=0;this._panY=0;this._panZ=0;this._rotX=0;this._rotY=0;if(t.touchCount===1){var n=t.getTouchInfo(0);var r=n.dx;var i=n.dy;if(n.prevX===0&&n.prevY===0){r=0;i=0}this._rotY=-r*.002;this._rotX=i*.002}else if(t.touchCount===2){var a=t.getTouchInfo(0);var s=t.getTouchInfo(1);var o=Math.sqrt((a.x-s.x)*(a.x-s.x)+(a.y-s.y)*(a.y-s.y));var l=Math.sqrt((a.prevX-s.prevX)*(a.prevX-s.prevX)+(a.prevY-s.prevY)*(a.prevY-s.prevY));var u=Math.abs(o-l);if((a.dx!=0||a.dy!=0)&&(s.dx!=0||s.dy!=0)&&u<100){if(o>l){this._df+=u}else{this._df-=u}}if(s.phase===2||a.phase===2){t.touchCount=2}}else if(t.touchCount===3){var f=t.getTouchInfo(0);var h=f.dx;var c=f.dy;if(h<100&&c<100){this._rotY=-h*.002;this._panZ=-c}}};xs.prototype._lerp=function e(t){var n=this._panX;var r=this._panY;var i=this._panZ;var a=this._destEye;var s=this._destRot;Ot.rotateX(s,s,this._rotX);Ot.rotateAround(s,s,ds,this._rotY);Ot.slerp(this._curRot,this._curRot,s,t*fs);Lt.fromQuat(ms,this._curRot);Ut.transformMat3(_s,cs,ms);Ut.transformMat3(vs,ps,ms);if(this._df!==0){Ut.scaleAndAdd(a,a,_s,this._df*t*hs)}if(this._dr!==0){Ut.scaleAndAdd(a,a,vs,this._dr*t*hs)}if(this._du!==0){Ut.scaleAndAdd(a,a,gs,this._du*t*hs)}if(i!==0){Ut.copy(ys,_s);ys.y=0;Ut.normalize(ys,ys);Ut.scaleAndAdd(a,a,ys,i*t*hs)}if(n!==0){Ut.copy(bs,vs);bs.y=0;Ut.normalize(bs,bs);Ut.scaleAndAdd(a,a,bs,n*t*hs)}if(r!==0){Ut.scaleAndAdd(a,a,ds,r*t*hs)}Ut.lerp(this._curEye,this._curEye,a,t*fs);this._node.setWorldPos(this._curEye);this._node.setWorldRot(this._curRot)};function Ts(e){var t=[[0,1],[1,2],[2,0]];var n=[];var r={};for(var i=0;i<e.length;i+=3){for(var a=0;a<3;++a){var s=e[i+t[a][0]];var o=e[i+t[a][1]];var l=s>o?o<<16|s:s<<16|o;if(r[l]===undefined){r[l]=0;n.push(s,o)}}}return n}function Ss(e,t,n){if(n===void 0)n=1;var r=new Array(2*e.length);for(var i=0;i<e.length/3;++i){var a=3*i;var s=6*i;r[s+0]=e[a+0];r[s+1]=e[a+1];r[s+2]=e[a+2];r[s+3]=e[a+0]+t[a+0]*n;r[s+4]=e[a+1]+t[a+1]*n;r[s+5]=e[a+2]+t[a+2]*n}return r}var Es=Ut.zero();var ws=Ut.zero();var Ms=Ut.zero();var As=Ut.zero();var Rs=Ut.zero();var Us=Ut.zero();var Ds=Ut.zero();var Ls=Ut.zero();var Os=Ut.zero();var Is=Ut.zero();var Cs=Ut.zero();var Ps=Ut.zero();function Bs(e,t,n,r){if(e===void 0)e=2;if(t===void 0)t=2;if(n===void 0)n=2;if(r===void 0)r={};var i=r.widthSegments!==undefined?r.widthSegments:1;var a=r.heightSegments!==undefined?r.heightSegments:1;var s=r.lengthSegments!==undefined?r.lengthSegments:1;var o=r.invWinding!==undefined?r.invWinding:false;var l=e*.5;var u=t*.5;var f=n*.5;var h=[Ut.set(Rs,-l,-u,f),Ut.set(Us,l,-u,f),Ut.set(Ds,l,u,f),Ut.set(Ls,-l,u,f),Ut.set(Os,l,-u,-f),Ut.set(Is,-l,-u,-f),Ut.set(Cs,-l,u,-f),Ut.set(Ps,l,u,-f)];var c=[[0,1,3],[4,5,7],[3,2,6],[1,0,4],[1,4,2],[5,0,6]];var p=[[0,0,1],[0,0,-1],[0,1,0],[0,-1,0],[1,0,0],[-1,0,0]];var d=[];var m=[];var _=[];var v=[];var g=Ut.new(-l,-u,-f);var y=Ut.new(l,u,f);function b(e,t,n){var r,i;var a,s;var l=d.length/3;var u=c[e];var f=p[e];for(s=0;s<=n;s++){for(a=0;a<=t;a++){r=a/t;i=s/n;Ut.lerp(Es,h[u[0]],h[u[1]],r);Ut.lerp(ws,h[u[0]],h[u[2]],i);Ut.sub(Ms,ws,h[u[0]]);Ut.add(As,Es,Ms);d.push(As.x,As.y,As.z);m.push(f[0],f[1],f[2]);_.push(r,i);if(a<t&&s<n){var g=t+1;var y=a+s*g;var b=a+(s+1)*g;var x=a+1+(s+1)*g;var T=a+1+s*g;if(o){v.push(l+y,l+b,l+T);v.push(l+T,l+b,l+x)}else{v.push(l+y,l+T,l+b);v.push(l+b,l+T,l+x)}}}}}b(0,i,a);b(4,s,a);b(1,i,a);b(5,s,a);b(3,i,s);b(2,i,s);return{positions:d,normals:m,uvs:_,indices:v,minPos:g,maxPos:y}}var Fs=Ut.zero();var zs=Ut.zero();function ks(e,t,n,r){if(e===void 0)e=.5;if(t===void 0)t=.5;if(n===void 0)n=2;if(r===void 0)r={};var i=n*.5;var a=r.radialSegments||8;var s=r.heightSegments||1;var o=r.capped!==undefined?r.capped:true;var l=r.arc||2*Math.PI;var u=0;if(!o){if(e>0){u++}if(t>0){u++}}var f=(a+1)*(s+1);if(o){f+=(a+1)*u+a*u}var h=a*s*2*3;if(o){h+=a*u*3}var c=new Array(h);var p=new Array(f*3);var d=new Array(f*3);var m=new Array(f*2);var _=Math.max(e,t);var v=Ut.new(-_,-i,-_);var g=Ut.new(_,i,_);var y=0;var b=0;x();if(o){if(t>0){T(false)}if(e>0){T(true)}}return{positions:p,normals:d,uvs:m,indices:c,minPos:v,maxPos:g};function x(){var r=[];var o=(e-t)/n;for(var u=0;u<=s;u++){var f=[];var h=u/s;var _=h*(e-t)+t;for(var v=0;v<=a;++v){var g=v/a;var x=g*l;var T=Math.sin(x);var S=Math.cos(x);p[3*y]=_*T;p[3*y+1]=h*n-i;p[3*y+2]=_*S;Ut.normalize(Fs,Ut.set(zs,T,-o,S));d[3*y]=Fs.x;d[3*y+1]=Fs.y;d[3*y+2]=Fs.z;m[2*y]=g;m[2*y+1]=h;f.push(y);++y}r.push(f)}for(var E=0;E<s;++E){for(var w=0;w<a;++w){var M=r[E][w];var A=r[E+1][w];var R=r[E+1][w+1];var U=r[E][w+1];c[b]=M;++b;c[b]=U;++b;c[b]=A;++b;c[b]=U;++b;c[b]=R;++b;c[b]=A;++b}}}function T(n){var r,s;var o=n?e:t;var u=n?1:-1;r=y;for(var f=1;f<=a;++f){p[3*y]=0;p[3*y+1]=i*u;p[3*y+2]=0;d[3*y]=0;d[3*y+1]=u;d[3*y+2]=0;m[2*y]=.5;m[2*y+1]=.5;++y}s=y;for(var h=0;h<=a;++h){var _=h/a;var v=_*l;var g=Math.cos(v);var x=Math.sin(v);p[3*y]=o*x;p[3*y+1]=i*u;p[3*y+2]=o*g;d[3*y]=0;d[3*y+1]=u;d[3*y+2]=0;m[2*y]=.5-g*.5;m[2*y+1]=x*.5*u+.5;++y}for(var T=0;T<a;++T){var S=r+T;var E=s+T;if(n){c[b]=E+1;++b;c[b]=S;++b;c[b]=E;++b}else{c[b]=S;++b;c[b]=E+1;++b;c[b]=E;++b}}}}function Ns(e,t,n){if(e===void 0)e=.5;if(t===void 0)t=1;if(n===void 0)n={};return ks(0,e,t,n)}var Gs=Ut.zero();var Vs=Ut.zero();var Hs=Ut.zero();var Ws=Ut.zero();var Xs=Ut.zero();var js=Ut.zero();var qs=Ut.zero();function Ys(e,t,n){if(n===void 0)n={};var r=n.widthSegments!==undefined?n.widthSegments:5;var i=n.lengthSegments!==undefined?n.lengthSegments:5;var a=e*.5;var s=t*.5;var o=[];var l=[];var u=[];var f=[];var h=Ut.new(-a,0,-s);var c=Ut.new(a,0,s);Ut.set(Xs,-a,0,s);Ut.set(js,a,0,s);Ut.set(qs,-a,0,-s);for(var p=0;p<=i;p++){for(var d=0;d<=r;d++){var m=d/r;var _=p/i;Ut.lerp(Gs,Xs,js,m);Ut.lerp(Vs,Xs,qs,_);Ut.sub(Hs,Vs,Xs);Ut.add(Ws,Gs,Hs);o.push(Ws.x,Ws.y,Ws.z);l.push(0,1,0);u.push(m,_);if(d<r&&p<i){var v=r+1;var g=d+p*v;var y=d+(p+1)*v;var b=d+1+(p+1)*v;var x=d+1+p*v;f.push(g,x,y);f.push(x,b,y)}}}return{positions:o,normals:l,uvs:u,indices:f,minPos:h,maxPos:c}}var Ks=[-.5,-.5,0,-.5,.5,0,.5,.5,0,.5,-.5,0];var Zs=[0,0,1,0,0,1,0,0,1,0,0,1];var Js=[0,0,0,1,1,1,1,0];var Qs=[0,3,1,3,2,1];var $s=Ut.new(-.5,-.5,0);var eo=Ut.new(.5,.5,0);function to(){return{positions:Ks,indices:Qs,normals:Zs,uvs:Js,minPos:$s,maxPos:eo}}function no(e,t){if(e===void 0)e=1;if(t===void 0)t={};var n=t.segments!==undefined?t.segments:16;var r=[];var i=[];var a=[];var s=[];var o=Ut.new(-e,-e,-e);var l=Ut.new(e,e,e);for(var u=0;u<=n;++u){var f=u*Math.PI/n;var h=Math.sin(f);var c=-Math.cos(f);for(var p=0;p<=n;++p){var d=p*2*Math.PI/n-Math.PI/2;var m=Math.sin(d);var _=Math.cos(d);var v=m*h;var g=c;var y=_*h;var b=p/n;var x=u/n;r.push(v*e,g*e,y*e);i.push(v,g,y);a.push(b,x);if(u<n&&p<n){var T=n+1;var S=T*u+p;var E=T*(u+1)+p;var w=T*(u+1)+p+1;var M=T*u+p+1;s.push(S,M,E);s.push(M,w,E)}}}return{positions:r,indices:s,normals:i,uvs:a,minPos:o,maxPos:l}}function ro(e,t,n){if(e===void 0)e=.5;if(t===void 0)t=.2;if(n===void 0)n={};var r=n.radialSegments||30;var i=n.tubularSegments||20;var a=n.arc||2*Math.PI;var s=[];var o=[];var l=[];var u=[];var f=Ut.new(-e-t,-t,-e-t);var h=Ut.new(e+t,t,e+t);for(var c=0;c<=r;c++){for(var p=0;p<=i;p++){var d=p/i;var m=c/r;var _=d*a;var v=m*Math.PI*2;var g=(e+t*Math.cos(v))*Math.sin(_);var y=t*Math.sin(v);var b=(e+t*Math.cos(v))*Math.cos(_);var x=Math.sin(_)*Math.cos(v);var T=Math.sin(v);var S=Math.cos(_)*Math.cos(v);s.push(g,y,b);o.push(x,T,S);l.push(d,m);if(p<i&&c<r){var E=i+1;var w=E*c+p;var M=E*(c+1)+p;var A=E*(c+1)+p+1;var R=E*c+p+1;u.push(w,R,M);u.push(R,A,M)}}}return{positions:s,normals:o,uvs:l,indices:u,minPos:f,maxPos:h}}var io=Ut.zero();var ao=Ut.zero();function so(e,t,n,r){if(e===void 0)e=.5;if(t===void 0)t=.5;if(n===void 0)n=2;if(r===void 0)r={};var i=n-e-t;var a=r.sides||16;var s=r.heightSegments||10;var o=t/n;var l=i/n;var u=e/n;var f=Math.floor(s*o);var h=Math.floor(s*u);var c=Math.floor(s*l);var p=i+t-n/2;var d=t-n/2;var m=t-n/2;var _=r.arc||2*Math.PI;var v=[];var g=[];var y=[];var b=[];var x=Math.max(e,t);var T=Ut.new(-x,-n/2,-x);var S=Ut.new(x,n/2,x);var E=0;var w=[];A();M();R();return{positions:v,normals:g,uvs:y,indices:b,minPos:T,maxPos:S};function M(){var n=(e-t)/i;for(var r=0;r<=c;r++){var s=[];var u=r/c;var f=u*(e-t)+t;for(var h=0;h<=a;++h){var p=h/a;var m=u*l+o;var x=p*_-_/4;var T=Math.sin(x);var S=Math.cos(x);v.push(f*T);v.push(u*i+d);v.push(f*S);Ut.normalize(io,Ut.set(ao,T,-n,S));g.push(io.x);g.push(io.y);g.push(io.z);y.push(p,m);s.push(E);++E}w.push(s)}for(var M=0;M<c;++M){for(var A=0;A<a;++A){var R=w[M][A];var U=w[M+1][A];var D=w[M+1][A+1];var L=w[M][A+1];b.push(R);b.push(L);b.push(U);b.push(L);b.push(D);b.push(U)}}}function A(){for(var e=0;e<=f;++e){var n=e*Math.PI/f/2;var r=Math.sin(n);var i=-Math.cos(n);for(var o=0;o<=a;++o){var l=o*2*Math.PI/a-Math.PI/2;var u=Math.sin(l);var h=Math.cos(l);var c=u*r;var p=i;var d=h*r;var _=o/a;var x=e/s;v.push(c*t,p*t+m,d*t);g.push(c,p,d);y.push(_,x);if(e<f&&o<a){var T=a+1;var S=T*e+o;var w=T*(e+1)+o;var M=T*(e+1)+o+1;var A=T*e+o+1;b.push(S,A,w);b.push(A,M,w)}++E}}}function R(){for(var t=0;t<=h;++t){var n=t*Math.PI/h/2+Math.PI/2;var r=Math.sin(n);var i=-Math.cos(n);for(var o=0;o<=a;++o){var l=o*2*Math.PI/a-Math.PI/2;var f=Math.sin(l);var d=Math.cos(l);var m=f*r;var _=i;var x=d*r;var T=o/a;var S=t/s+(1-u);v.push(m*e,_*e+p,x*e);g.push(m,_,x);y.push(T,S);if(t<h&&o<a){var E=a+1;var M=E*t+o+w[c][a]+1;var A=E*(t+1)+o+w[c][a]+1;var R=E*(t+1)+o+1+w[c][a]+1;var U=E*t+o+1+w[c][a]+1;b.push(M,U,A);b.push(U,R,A)}}}}}var oo=Object.freeze({box:Bs,cone:Ns,cylinder:ks,plane:Ys,quad:to,sphere:no,torus:ro,capsule:so,wireframe:Ts,normals:Ss});var lo=Ut.new(1,0,0);var uo=Ut.new(0,1,0);var fo=Ut.new(0,0,1);var ho=Ut.zero();var co=Ut.zero();var po=Bt.create();var mo=function e(t){this._app=t;this._view2D=new Pi.View;this._view2D._clearFlags=0;this._view2D._cullingByID=true;this._view2D._stages=["opaque"];this._lines=new fr(function(){return{start:Ut.zero(),end:Ut.zero(),color:Bt.create(),duration:0,depthTest:false,timer:0,is2D:false,_prev:null,_next:null}},2e3);this._rects=new fr(function(){return{x:0,y:0,w:1,h:1,color:Bt.create(),duration:0,timer:0,_prev:null,_next:null}},2e3);this._axesList=new fr(function(){return{pos:Ut.zero(),up:Ut.zero(),right:Ut.zero(),forward:Ut.zero(),duration:0,depthTest:false,timer:0,is2D:false,_prev:null,_next:null}},2e3);var n=new Pi.Pass("wireframe");n.setDepth(true,true);var r=new Pi.Technique(["opaque"],[{name:"color",type:Pi.PARAM_COLOR3}],[n]);var i=new Pi.Effect([r],{},[]);i.setProperty("color",Bt.new(1,1,1));this._primitives=new fr(function(){return{model:function(){var e=new Pi.Model;var t=new Ur;e.setNode(t);e.setEffect(i);return e}(),duration:0,depthTest:false,timer:0,_prev:null,_next:null}},2e3);var a=new Pi.Pass("line");a.setDepth(true,true);var s=new Pi.Technique(["opaque"],[],[a]);var o=new Pi.Effect([s],{},[]);var l=new Pi.LineBatchModel;l.setNode(new Ur("debug-lines"));l.setEffect(o);var u=new Pi.LineBatchModel;u.setNode(new Ur("debug-lines-2d"));u.setEffect(o);var f=no(1,{segments:20});f.uvs=null;f.indices=Ts(f.indices);this._sphereIA=Pi.createIA(t.device,f);this._sphereIA._primitiveType=Me.PT_LINES;this._lineBatchModel=l;this._lineBatchModel2D=u};mo.prototype.start=function e(){this._app.scene.addView(this._view2D);this._app.scene.addModel(this._lineBatchModel);this._app.scene.addModel(this._lineBatchModel2D)};mo.prototype.stop=function e(){var t=this;this._app.scene.removeView(this._view2D);this._app.scene.removeModel(this._lineBatchModel);this._app.scene.removeModel(this._lineBatchModel2D);this._primitives.forEach(function(e){e.model.setInputAssembler(null);t._app.scene.removeModel(e.model);t._primitives.remove(e)})};mo.prototype.tick=function e(){var t=this;var n=this._app.deltaTime;var r=this._app._canvas.width;var i=this._app._canvas.height;Pt.ortho(this._view2D._matProj,0,r,0,i,-100,100);Pt.copy(this._view2D._matViewProj,this._view2D._matProj);Pt.invert(this._view2D._matInvViewProj,this._view2D._matProj);this._view2D._rect.x=this._view2D._rect.y=0;this._view2D._rect.w=r;this._view2D._rect.h=i;this._lineBatchModel.clear();this._lineBatchModel2D.clear();this._lineBatchModel2D._viewID=this._view2D._id;this._lines.forEach(function(e){if(e.timer>e.duration){t._lines.remove(e);return}if(e.is2D){t._lineBatchModel2D.addLine(e.start,e.end,e.color)}else if(e.depthTest){t._lineBatchModel.addLine(e.start,e.end,e.color)}else{console.warn("We have not support it yet")}e.timer+=n});this._rects.forEach(function(e){if(e.timer>e.duration){t._rects.remove(e);return}t._lineBatchModel2D.addLine(Ut.set(ho,e.x,e.y,0),Ut.set(co,e.x,e.y+e.h,0),e.color);t._lineBatchModel2D.addLine(Ut.set(ho,e.x,e.y+e.h,0),Ut.set(co,e.x+e.w,e.y+e.h,0),e.color);t._lineBatchModel2D.addLine(Ut.set(ho,e.x+e.w,e.y+e.h,0),Ut.set(co,e.x+e.w,e.y,0),e.color);t._lineBatchModel2D.addLine(Ut.set(ho,e.x+e.w,e.y,0),Ut.set(co,e.x,e.y,0),e.color);e.timer+=n});this._axesList.forEach(function(e){if(e.timer>e.duration){t._axesList.remove(e);return}if(e.is2D){t._lineBatchModel2D.addLine(e.pos,e.up,Bt.set(po,1,0,0));t._lineBatchModel2D.addLine(e.pos,e.right,Bt.set(po,0,1,0));t._lineBatchModel2D.addLine(e.pos,e.forward,Bt.set(po,0,0,1))}else if(e.depthTest){t._lineBatchModel.addLine(e.pos,e.up,Bt.set(po,1,0,0));t._lineBatchModel.addLine(e.pos,e.right,Bt.set(po,0,1,0));t._lineBatchModel.addLine(e.pos,e.forward,Bt.set(po,0,0,1))}else{console.warn("We have not support it yet")}e.timer+=n});this._primitives.forEach(function(e){if(e.timer>e.duration){e.model.setInputAssembler(null);t._app.scene.removeModel(e.model);t._primitives.remove(e);return}e.timer+=n})};mo.prototype.addLine=function e(t,n,r,i,a,s){if(i===void 0)i=0;if(a===void 0)a=true;if(s===void 0)s=false;var o=this._lines.add();Ut.copy(o.start,t);Ut.copy(o.end,n);Bt.copy(o.color,r);o.duration=i;o.depthTest=a;o.timer=0;o.is2D=s;if(s){o.start.z=0;o.end.z=0}};mo.prototype.addRect2D=function e(t,n,r,i,a,s){if(s===void 0)s=0;var o=this._rects.add();o.x=t;o.y=n;o.w=r;o.h=i;Bt.copy(o.color,a);o.duration=s;o.timer=0};mo.prototype.addAxes=function e(t,n,r,i,a,s){if(i===void 0)i=0;if(a===void 0)a=true;if(s===void 0)s=false;var o=this._axesList.add();Ut.copy(o.pos,t);Ut.transformQuat(ho,lo,n);Ut.scaleAndAdd(ho,t,ho,r),Ut.copy(o.right,ho);Ut.transformQuat(ho,uo,n);Ut.scaleAndAdd(ho,t,ho,r),Ut.copy(o.up,ho);Ut.transformQuat(ho,fo,n);Ut.scaleAndAdd(ho,t,ho,r),Ut.copy(o.forward,ho);o.duration=i;o.depthTest=a;o.timer=0;o.is2D=s};mo.prototype.addSphere=function e(t,n,r,i,a){if(i===void 0)i=0;if(a===void 0)a=true;var s=this._primitives.add();s.model.setInputAssembler(this._sphereIA);Ut.copy(s.model._node.lpos,t);Ut.set(s.model._node.lscale,n,n,n);s.duration=i;s.depthTest=a;s.timer=0;this._app.scene.addModel(s.model)};function _o(e,t,n,r){var i=[];var a=t*.5;var s=n*.5;var o=t/r;var l=n/r;for(var u=-a;u<=a;u+=o){i.push(u,0,-s);i.push(u,0,s)}for(var f=-s;f<=s;f+=l){i.push(-a,0,f);i.push(a,0,f)}var h=Pi.createIA(e.device,{positions:i});h._primitiveType=Me.PT_LINES;var c=new Pi.Pass("simple");c.setDepth(true,true);var p=new Pi.Technique(["opaque"],[{name:"color",type:Pi.PARAM_COLOR4}],[c]);var d=new Pi.Effect([p],{},[{name:"USE_TEXTURE",value:false},{name:"USE_COLOR",value:true}]);d.define("USE_COLOR",true);d.setProperty("color",Ft.new(.4,.4,.4,1));var m=new Pi.Model;m.setInputAssembler(h);m.setEffect(d);m.setNode(new Ur("debug-grid"));return m}var vo=function e(t){this._state="sleep";this._app=t;this._drawMng=new mo(t);this._debugInput=new qi(t._canvas,{lock:true,invertY:true,enabled:false});this._orbit=new xs(this._debugInput);this._camera=new Pi.Camera;this._camera.setColor(.3,.3,.3,1);this._camera.setNode(this._orbit._node);this._camera.setStages(["opaque","transparent"]);this._grid=_o(t,100,100,100)};vo.prototype.start=function e(){if(this._state!=="sleep"){return}this._state="enter"};vo.prototype.stop=function e(){if(this._state==="sleep"){return}this._state="fade2normal"};vo.prototype.tick=function e(){if(this._state==="sleep"){return}var t="_"+this._state;var n=this[t];if(!n){console.warn("Unknown state "+this._state);return}this[t]()};vo.prototype.postTick=function e(){this._drawMng.tick()};vo.prototype.drawLine=function e(t,n,r,i,a){if(this._state!=="debug"){return}this._drawMng.addLine(t,n,r,i,a,false)};vo.prototype.drawLine2D=function e(t,n,r,i){if(this._state!=="debug"){return}this._drawMng.addLine(t,n,r,i,false,true)};vo.prototype.drawRect=function e(t,n,r,i,a,s){if(this._state!=="debug"){return}this._drawMng.addRect2D(t,n,r,i,a,s)};vo.prototype.drawAxes=function e(t,n,r,i,a){if(this._state!=="debug"){return}this._drawMng.addAxes(t,n,r,i,a,false)};vo.prototype.drawAxes2D=function e(t,n,r,i){if(this._state!=="debug"){return}this._drawMng.addAxes(t,n,r,i,false,true)};vo.prototype.drawSphere=function e(t,n,r,i,a){if(this._state!=="debug"){return}this._drawMng.addSphere(t,n,r,i,a)};vo.prototype._enter=function e(){var t=null;as.walk(this._app.activeLevel,function(e){t=e.getComp("Camera");if(t){return false}return true});if(!t){return}this._app.input.enabled=false;this._debugInput.enabled=true;Ut.copy(this._orbit._node.lpos,t._entity.lpos);Ot.copy(this._orbit._node.lrot,t._entity.lrot);Ut.copy(this._orbit._node.lscale,t._entity.lscale);this._orbit.reset();this._app.scene.setDebugCamera(this._camera);this._app.scene.addModel(this._grid);this._drawMng.start();this._state="fade2debug"};vo.prototype._fade2debug=function e(){this._state="debug"};vo.prototype._debug=function e(){var t=this._app.deltaTime;this._orbit.tick(t);this._debugInput.reset()};vo.prototype._fade2normal=function e(){this._state="exit"};vo.prototype._exit=function e(){this._debugInput.enabled=false;this._app.input.enabled=true;this._app.scene.removeModel(this._grid);this._app.scene.setDebugCamera(null);this._drawMng.stop();this._state="sleep"};function go(e){return e.map(function(e){return Object.assign({},e)})}var yo=function(e){function t(){e.call(this);this._props={};this._effectInst=null;this._effect=null}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;var n={effect:{configurable:true},effectInst:{configurable:true}};t.prototype._updateEffectInst=function e(){var t=this;var n=this._effect.techniques.length;var r=new Array(n);var i={};for(var a=0;a<n;++a){var s=t._effect.techniques[a];for(var o=0;o<s.params.length;++o){var l=s.params[o];switch(l.type){case Pi.PARAM_FLOAT:i[l.name]=l.value;break;case Pi.PARAM_FLOAT2:i[l.name]=Rt.new(l.value[0],l.value[1]);break;case Pi.PARAM_FLOAT3:i[l.name]=Ut.new(l.value[0],l.value[1],l.value[2]);break;case Pi.PARAM_FLOAT4:i[l.name]=Dt.new(l.value[0],l.value[1],l.value[2],l.value[3]);break;case Pi.PARAM_COLOR3:i[l.name]=Bt.new(l.value[0],l.value[1],l.value[2]);break;case Pi.PARAM_COLOR4:i[l.name]=Ft.new(l.value[0],l.value[1],l.value[2],l.value[3]);break;case Pi.PARAM_TEXTURE_2D:case Pi.PARAM_TEXTURE_CUBE:i[l.name]=null;break;default:console.warn("unsupport param type in effect json.")}}var u=s.passes.length;var f=new Array(u);for(var h=0;h<u;++h){var c=s.passes[h];f[h]=new Pi.Pass(c.program);if(c.depthTest!==undefined&&c.depthWrite!==undefined){f[h].setDepth(c.depthTest,c.depthWrite)}if(c.cullMode!==undefined){f[h].setCullMode(c.cullMode)}if(c.blend===true){f[h].setBlend(c.blendEq,c.blendSrc,c.blendDst,c.blendAlphaEq,c.blendSrcAlpha,c.blendDstAlpha)}}r[a]=new Pi.Technique(s.stages,s.params,f,s.layer)}for(var p in i){t._props[p]=i[p]}var d=go(this._effect.defines);var m=go(this._effect.dependencies);if(this._effectInst){this._effectInst.clear();this._effectInst._techniques=r;this._effectInst._properties=i;this._effectInst._defines=d;this._effectInst._dependencies=m}else{this._effectInst=new Pi.Effect(r,i,d,m)}};n.effect.get=function(){return this._effect};n.effect.set=function(e){if(this._effect!==e){this._effect=e;this._updateEffectInst()}};n.effectInst.get=function(){return this._effectInst};t.prototype.copy=function e(t){var n=this;if(this._effect!==t._effect){this._effect=t._effect;this._updateEffectInst()}this._effectInst._defines=go(t._effectInst._defines);this._effectInst._dependencies=go(t._effectInst._dependencies);for(var r in t._props){n.setProperty(r,t._props[r])}};t.prototype.setProperty=function e(t,n){this._props[t]=n;if(n instanceof ka){this._effectInst.setProperty(t,n._texture)}else{this._effectInst.setProperty(t,n)}};t.prototype.define=function e(t,n){this._effectInst.define(t,n)};t.prototype.unload=function t(){if(!this._loaded){return}e.prototype.unload.call(this)};Object.defineProperties(t.prototype,n);return t}(Ba);var bo={images:[],mipmap:true,width:2,height:2,format:Me.TEXTURE_FMT_RGBA8,anisotropy:1,wrapS:Me.WRAP_REPEAT,wrapT:Me.WRAP_REPEAT,minFilter:Me.FILTER_LINEAR,magFilter:Me.FILTER_LINEAR,mipFilter:Me.FILTER_LINEAR};function xo(e,t){e.images=t._images;e.mipmap=t._mipmap;e.width=t._width;e.height=t._height;e.format=Va[t._format];e.anisotropy=t._anisotropy;e.wrapS=Ga[t._wrapS];e.wrapT=Ga[t._wrapT];e.minFilter=Na[t._minFilter];e.magFilter=Na[t._magFilter];e.mipFilter=Na[t._mipFilter]}var To=function(e){function t(t,n,r,i){if(n===void 0)n=2;if(r===void 0)r=2;if(i===void 0)i="rgba8";e.call(this,t);this._images=[];this._mipmap=true;this._width=n;this._height=r;this._format=i;this._anisotropy=1;this._wrapS="repeat";this._wrapT="repeat";this._minFilter="linear";this._magFilter="linear";this._mipFilter="linear"}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;var n={width:{configurable:true},height:{configurable:true},mipmap:{configurable:true},anisotropy:{configurable:true},wrapS:{configurable:true},wrapT:{configurable:true},minFilter:{configurable:true},magFilter:{configurable:true},mipFilter:{configurable:true}};t.prototype.unload=function t(){if(!this._loaded){return}this._texture.destroy();e.prototype.unload.call(this)};t.prototype.setImages=function e(t){this._images=t;this.resize(t[0][0].width,t[0][0].height)};t.prototype.resize=function e(t,n){this._width=t;this._height=n};n.width.get=function(){return this._width};n.height.get=function(){return this._height};n.mipmap.set=function(e){this._mipmap=e};n.mipmap.get=function(){return this._mipmap};n.anisotropy.set=function(e){this._anisotropy=e};n.anisotropy.get=function(){return this._anisotropy};n.wrapS.set=function(e){this._wrapS=e};n.wrapS.get=function(){return this._wrapS};n.wrapT.set=function(e){this._wrapT=e};n.wrapT.get=function(){return this._wrapT};n.minFilter.set=function(e){this._minFilter=e};n.minFilter.get=function(){return this._minFilter};n.magFilter.set=function(e){this._magFilter=e};n.magFilter.get=function(){return this._magFilter};n.mipFilter.set=function(e){this._mipFilter=e};n.mipFilter.get=function(){return this._mipFilter};t.prototype.commit=function e(){xo(bo,this);if(!this._texture){this._texture=new Me.TextureCube(this._device,bo)}else{this._texture.update(bo)}this._images=[]};Object.defineProperties(t.prototype,n);return t}(ka);var So=function(e){function t(){e.call(this);this._techniques=[];this._properties={};this._defines=[];this._dependencies=[]}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;var n={techniques:{configurable:true},properties:{configurable:true},defines:{configurable:true},dependencies:{configurable:true}};n.techniques.set=function(e){this._techniques=e};n.techniques.get=function(){return this._techniques};n.properties.set=function(e){this._properties=e};n.properties.get=function(){return this._properties};n.defines.set=function(e){this._defines=e};n.defines.get=function(){return this._defines};n.dependencies.set=function(e){this._dependencies=e};n.dependencies.get=function(){return this._dependencies};t.prototype.unload=function t(){if(!this._loaded){return}e.prototype.unload.call(this)};Object.defineProperties(t.prototype,n);return t}(Ba);var Eo=Ut.zero();var wo=Ut.zero();var Mo=Pt.create();var Ao=Pt.create();var Ro=function(e){function t(){var t=this;e.call(this);this._texture=null;this._x=0;this._y=0;this._width=64;this._height=64;this._rotated=false;this._left=0;this._right=0;this._top=0;this._bottom=0;this._uvs=new Array(16);for(var n=0;n<16;++n){t._uvs[n]=Ut.zero()}}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;var n={texture:{configurable:true},x:{configurable:true},y:{configurable:true},width:{configurable:true},height:{configurable:true},rotated:{configurable:true},left:{configurable:true},right:{configurable:true},top:{configurable:true},bottom:{configurable:true},uvs:{configurable:true}};n.texture.get=function(){return this._texture};n.texture.set=function(e){this._texture=e};n.x.get=function(){return this._x};n.x.set=function(e){this._x=e};n.y.get=function(){return this._y};n.y.set=function(e){this._y=e};n.width.get=function(){return this._width};n.width.set=function(e){this._width=e};n.height.get=function(){return this._height};n.height.set=function(e){this._height=e};n.rotated.get=function(){return this._rotated};n.rotated.set=function(e){this._rotated=e};n.left.get=function(){return this._left};n.left.set=function(e){this._left=e};n.right.get=function(){return this._right};n.right.set=function(e){this._right=e};n.top.get=function(){return this._top};n.top.set=function(e){this._top=e};n.bottom.get=function(){return this._bottom};n.bottom.set=function(e){this._bottom=e};n.uvs.get=function(){return this._uvs};t.prototype.commit=function e(){var t=this;var n=this._texture.width;var r=this._texture.height;if(this._rotated){Ut.set(wo,this._width,this._height,1);Pt.fromScaling(Ao,wo);Pt.fromZRotation(Mo,-Math.PI/2);Pt.multiply(Ao,Mo,Ao);Ut.set(Eo,this._x,r-this._y,0);Pt.fromTranslation(Mo,Eo);Pt.multiply(Ao,Mo,Ao);Ut.set(wo,1/n,1/r,1);Pt.fromScaling(Mo,wo);Pt.multiply(Ao,Mo,Ao)}else{Ut.set(wo,this._width,this._height,1);Pt.fromScaling(Ao,wo);Ut.set(Eo,this._x,r-(this._y+this._height),0);Pt.fromTranslation(Mo,Eo);Pt.multiply(Ao,Mo,Ao);Ut.set(wo,1/n,1/r,1);Pt.fromScaling(Mo,wo);Pt.multiply(Ao,Mo,Ao)}var i=this._uvs;i[0].x=i[4].x=i[8].x=i[12].x=0;i[1].x=i[5].x=i[9].x=i[13].x=this._left/this._width;i[2].x=i[6].x=i[10].x=i[14].x=1-this._right/this._width;i[3].x=i[7].x=i[11].x=i[15].x=1;i[0].y=i[1].y=i[2].y=i[3].y=0;i[4].y=i[5].y=i[6].y=i[7].y=this._bottom/this._height;i[8].y=i[9].y=i[10].y=i[11].y=1-this._top/this._height;i[12].y=i[13].y=i[14].y=i[15].y=1;for(var a=0;a<this._uvs.length;++a){Ut.transformMat4(t._uvs[a],t._uvs[a],Ao)}};Object.defineProperties(t.prototype,n);return t}(Ba);var Uo=[{name:"font",techniques:[{stages:["ui"],params:[{name:"mainTexture",type:13,value:null}],passes:[{program:"sprite",depthTest:true,depthWrite:false,blend:true,blendEq:32774,blendSrc:1,blendDst:771,blendAlphaEq:32774,blendSrcAlpha:1,blendDstAlpha:771}],layer:0}],properties:{},defines:[],dependencies:undefined},{name:"grid",techniques:[{stages:["opaque"],params:[{name:"tiling",type:5,value:[1,1]},{name:"baseColorWhite",type:8,value:[1,1,1]},{name:"baseColorBlack",type:8,value:[0,0,0]},{name:"basePattern",type:13,value:null},{name:"basePatternTiling",type:5,value:[1,1]},{name:"basePatternOffset",type:5,value:[0,0]},{name:"subPatternColor",type:9,value:[1,1,1,1]},{name:"subPattern",type:13,value:null},{name:"subPatternTiling",type:5,value:[1,1]},{name:"subPatternOffset",type:5,value:[0,0]},{name:"subPatternColor2",type:9,value:[1,1,1,1]},{name:"subPattern2",type:13,value:null},{name:"subPattern2Tiling",type:5,value:[1,1]},{name:"subPattern2Offset",type:5,value:[0,0]}],passes:[{program:"grid"}],layer:0}],properties:{},defines:[{name:"USE_WORLD_POS",value:false}],dependencies:undefined},{name:"line",techniques:[{stages:["opaque"],params:[],passes:[{program:"line",depthTest:true,depthWrite:true}],layer:0}],properties:{},defines:[],dependencies:undefined},{name:"matcap",techniques:[{stages:["opaque"],params:[{name:"mainTex",type:13,value:null},{name:"matcapTex",type:13,value:null},{name:"colorFactor",type:4,value:.5},{name:"color",type:9,value:[1,1,1,1]}],passes:[{program:"matcap",depthTest:true,depthWrite:true}],layer:0}],properties:{},defines:[{name:"USE_MAIN_TEX",value:false},{name:"USE_SKINNING",value:false}],dependencies:undefined},{name:"particle-add-multiply",techniques:[{stages:["transparent"],params:[{name:"mainTexture",type:13,value:null},{name:"mainTiling",type:5,value:[1,1]},{name:"mainOffset",type:5,value:[0,0]},{name:"tintColor",type:9,value:[.5,.5,.5,.5]},{name:"frameTile",type:5,value:[1,1]},{name:"velocityScale",type:4,value:0},{name:"lengthScale",type:4,value:0}],passes:[{program:"particle-add-multiply",cullMode:0,depthTest:true,depthWrite:false,blend:true,blendEq:32774,blendSrc:1,blendDst:771,blendAlphaEq:32774,blendSrcAlpha:1,blendDstAlpha:771}],layer:0}],properties:{},defines:[{name:"USE_SOFT_PARTICLE",value:false},{name:"USE_BILLBOARD",value:false},{name:"USE_STRETCHED_BILLBOARD",value:false},{name:"USE_HORIZONTAL_BILLBOARD",value:false},{name:"USE_VERTICAL_BILLBOARD",value:false},{name:"USE_WORLD_SPACE",value:false}],dependencies:undefined},{name:"particle-add-smooth",techniques:[{stages:["transparent"],params:[{name:"mainTexture",type:13,value:null},{name:"mainTiling",type:5,value:[1,1]},{name:"mainOffset",type:5,value:[0,0]},{name:"frameTile",type:5,value:[1,1]},{name:"velocityScale",type:4,value:0},{name:"lengthScale",type:4,value:0}],passes:[{program:"particle-add-smooth",cullMode:0,depthTest:true,depthWrite:false,blend:true,blendEq:32774,blendSrc:1,blendDst:769,blendAlphaEq:32774,blendSrcAlpha:1,blendDstAlpha:769}],layer:0}],properties:{},defines:[{name:"USE_SOFT_PARTICLE",value:false},{name:"USE_BILLBOARD",value:false},{name:"USE_STRETCHED_BILLBOARD",value:false},{name:"USE_HORIZONTAL_BILLBOARD",value:false},{name:"USE_VERTICAL_BILLBOARD",value:false},{name:"USE_WORLD_SPACE",value:false}],dependencies:undefined},{name:"particle-add",techniques:[{stages:["transparent"],params:[{name:"mainTexture",type:13,value:null},{name:"mainTiling",type:5,value:[1,1]},{name:"mainOffset",type:5,value:[0,0]},{name:"tintColor",type:9,value:[.5,.5,.5,.5]},{name:"frameTile",type:5,value:[1,1]},{name:"velocityScale",type:4,value:0},{name:"lengthScale",type:4,value:0}],passes:[{program:"particle-add",cullMode:0,depthTest:true,depthWrite:false,blend:true,blendEq:32774,blendSrc:770,blendDst:1,blendAlphaEq:32774,blendSrcAlpha:770,blendDstAlpha:1}],layer:0}],properties:{},defines:[{name:"USE_SOFT_PARTICLE",value:false},{name:"USE_BILLBOARD",value:false},{name:"USE_STRETCHED_BILLBOARD",value:false},{name:"USE_HORIZONTAL_BILLBOARD",value:false},{name:"USE_VERTICAL_BILLBOARD",value:false},{name:"USE_WORLD_SPACE",value:false}],dependencies:undefined},{name:"particle-alpha-blend",techniques:[{stages:["transparent"],params:[{name:"mainTexture",type:13,value:null},{name:"mainTiling",type:5,value:[1,1]},{name:"mainOffset",type:5,value:[0,0]},{name:"tintColor",type:9,value:[.5,.5,.5,.5]},{name:"frameTile",type:5,value:[1,1]},{name:"velocityScale",type:4,value:0},{name:"lengthScale",type:4,value:0}],passes:[{program:"particle-alpha-blend",cullMode:0,depthTest:true,depthWrite:false,blend:true,blendEq:32774,blendSrc:770,blendDst:771,blendAlphaEq:32774,blendSrcAlpha:770,blendDstAlpha:771}],layer:0}],properties:{},defines:[{name:"USE_SOFT_PARTICLE",value:false},{name:"USE_BILLBOARD",value:false},{name:"USE_STRETCHED_BILLBOARD",value:false},{name:"USE_HORIZONTAL_BILLBOARD",value:false},{name:"USE_VERTICAL_BILLBOARD",value:false},{name:"USE_WORLD_SPACE",value:false}],dependencies:undefined},{name:"particle-premultiply-blend",techniques:[{stages:["transparent"],params:[{name:"mainTexture",type:13,value:null},{name:"mainTiling",type:5,value:[1,1]},{name:"mainOffset",type:5,value:[0,0]},{name:"frameTile",type:5,value:[1,1]},{name:"velocityScale",type:4,value:0},{name:"lengthScale",type:4,value:0}],passes:[{program:"particle-premultiply-blend",cullMode:0,depthTest:true,depthWrite:false,blend:true,blendEq:32774,blendSrc:1,blendDst:771,blendAlphaEq:32774,blendSrcAlpha:1,blendDstAlpha:771}],layer:0}],properties:{},defines:[{name:"USE_SOFT_PARTICLE",value:false},{name:"USE_BILLBOARD",value:false},{name:"USE_STRETCHED_BILLBOARD",value:false},{name:"USE_HORIZONTAL_BILLBOARD",value:false},{name:"USE_VERTICAL_BILLBOARD",value:false},{name:"USE_WORLD_SPACE",value:false}],dependencies:undefined},{name:"pbr-transparent",techniques:[{stages:["transparent"],params:[{name:"albedo",type:9,value:[1,1,1,1]},{name:"mainTiling",type:5,value:[1,1]},{name:"mainOffset",type:5,value:[0,0]},{name:"albedo_texture",type:13,value:null},{name:"metallic",type:4,value:1},{name:"metallic_texture",type:13,value:null},{name:"roughness",type:4,value:.5},{name:"roughness_texture",type:13,value:null},{name:"ao",type:4,value:.2},{name:"ao_texture",type:13,value:null},{name:"emissive",type:8,value:[0,0,0]},{name:"emissive_texture",type:13,value:null},{name:"normal_texture",type:13,value:null},{name:"diffuseEnvTexture",type:14,value:null},{name:"specularEnvTexture",type:14,value:null},{name:"brdfLUT",type:13,value:null},{name:"maxReflectionLod",type:4,value:9},{name:"alphaTestThreshold",type:4,value:0}],passes:[{program:"pbr",cullMode:1029,depthTest:true,depthWrite:false,blend:true,blendEq:32774,blendSrc:770,blendDst:771,blendAlphaEq:32774,blendSrcAlpha:1,blendDstAlpha:771}],layer:0},{stages:["shadowcast"],params:[],passes:[{program:"shadow-depth",cullMode:1029,blendMode:0,depthTest:true,depthWrite:true}],layer:0}],properties:{},defines:[{name:"USE_NORMAL_TEXTURE",value:false},{name:"USE_ALBEDO_TEXTURE",value:false},{name:"USE_MRA_TEXTURE",value:false},{name:"USE_METALLIC_TEXTURE",value:false},{name:"USE_ROUGHNESS_TEXTURE",value:false},{name:"USE_AO_TEXTURE",value:false},{name:"USE_EMISSIVE",value:false},{name:"USE_EMISSIVE_TEXTURE",value:false},{name:"USE_IBL",value:false},{name:"USE_TEX_LOD",value:false},{name:"USE_ALPHA_TEST",value:false},{name:"USE_SHADOW_MAP",value:false},{name:"USE_SKINNING",value:false},{name:"NUM_DIR_LIGHTS",value:0},{name:"NUM_POINT_LIGHTS",value:0},{name:"NUM_SPOT_LIGHTS",value:0},{name:"NUM_SHADOW_LIGHTS",value:0}],dependencies:[{define:"USE_NORMAL_TEXTURE",extension:"OES_standard_derivatives"},{define:"USE_TEX_LOD",extension:"EXT_shader_texture_lod"}]},{name:"pbr",techniques:[{stages:["opaque"],params:[{name:"albedo",type:9,value:[1,1,1,1]},{name:"mainTiling",type:5,value:[1,1]},{name:"mainOffset",type:5,value:[0,0]},{name:"albedo_texture",type:13,value:null},{name:"metallic",type:4,value:1},{name:"metallic_texture",type:13,value:null},{name:"roughness",type:4,value:.5},{name:"roughness_texture",type:13,value:null},{name:"ao",type:4,value:.2},{name:"ao_texture",type:13,value:null},{name:"emissive",type:8,value:[0,0,0]},{name:"emissive_texture",type:13,value:null},{name:"normal_texture",type:13,value:null},{name:"diffuseEnvTexture",type:14,value:null},{name:"specularEnvTexture",type:14,value:null},{name:"brdfLUT",type:13,value:null},{name:"maxReflectionLod",type:4,value:9},{name:"alphaTestThreshold",type:4,value:0}],passes:[{program:"pbr",cullMode:1029,depthTest:true,depthWrite:true}],layer:0},{stages:["shadowcast"],params:[],passes:[{program:"shadow-depth",cullMode:1029,blendMode:0,depthTest:true,depthWrite:true}],layer:0}],properties:{},defines:[{name:"USE_NORMAL_TEXTURE",value:false},{name:"USE_ALBEDO_TEXTURE",value:false},{name:"USE_MRA_TEXTURE",value:false},{name:"USE_METALLIC_TEXTURE",value:false},{name:"USE_ROUGHNESS_TEXTURE",value:false},{name:"USE_AO_TEXTURE",value:false},{name:"USE_EMISSIVE",value:false},{name:"USE_EMISSIVE_TEXTURE",value:false},{name:"USE_IBL",value:false},{name:"USE_TEX_LOD",value:false},{name:"USE_ALPHA_TEST",value:false},{name:"USE_SHADOW_MAP",value:false},{name:"USE_SKINNING",value:false},{name:"NUM_DIR_LIGHTS",value:0},{name:"NUM_POINT_LIGHTS",value:0},{name:"NUM_SPOT_LIGHTS",value:0},{name:"NUM_SHADOW_LIGHTS",value:0}],dependencies:[{define:"USE_NORMAL_TEXTURE",extension:"OES_standard_derivatives"},{define:"USE_TEX_LOD",extension:"EXT_shader_texture_lod"}]},{name:"phong-transparent",techniques:[{stages:["transparent"],params:[{name:"diffuseColor",type:9,value:[.8,.8,.8,1]},{name:"mainTiling",type:5,value:[1,1]},{name:"mainOffset",type:5,value:[0,0]},{name:"diffuse_texture",type:13,value:null},{name:"specularColor",type:8,value:[0,0,0]},{name:"specular_texture",type:13,value:null},{name:"emissiveColor",type:8,value:[0,0,0]},{name:"emissive_texture",type:13,value:null},{name:"glossiness",type:4,value:10},{name:"normal_texture",type:13,value:null},{name:"alphaTestThreshold",type:4,value:0}],passes:[{program:"phong",cullMode:1029,depthTest:true,depthWrite:false,blend:true,blendEq:32774,blendSrc:770,blendDst:771,blendAlphaEq:32774,blendSrcAlpha:1,blendDstAlpha:771}],layer:0},{stages:["shadowcast"],params:[],passes:[{program:"shadow-depth",cullMode:1029,depthTest:true,depthWrite:true}],layer:0}],properties:{},defines:[{name:"USE_NORMAL_TEXTURE",value:false},{name:"USE_DIFFUSE_TEXTURE",value:false},{name:"USE_SPECULAR",value:false},{name:"USE_SPECULAR_TEXTURE",value:false},{name:"USE_EMISSIVE",value:false},{name:"USE_EMISSIVE_TEXTURE",value:false},{name:"USE_ALPHA_TEST",value:false},{name:"USE_SKINNING",value:false},{name:"USE_SHADOW_MAP",value:false},{name:"NUM_DIR_LIGHTS",value:0},{name:"NUM_POINT_LIGHTS",value:0},{name:"NUM_SPOT_LIGHTS",value:0},{name:"NUM_SHADOW_LIGHTS",value:0}],dependencies:[{define:"USE_NORMAL_TEXTURE",extension:"OES_standard_derivatives"}]},{name:"phong",techniques:[{stages:["opaque"],params:[{name:"diffuseColor",type:9,value:[.8,.8,.8,1]},{name:"mainTiling",type:5,value:[1,1]},{name:"mainOffset",type:5,value:[0,0]},{name:"diffuse_texture",type:13,value:null},{name:"specularColor",type:8,value:[0,0,0]},{name:"specular_texture",type:13,value:null},{name:"emissiveColor",type:8,value:[0,0,0]},{name:"emissive_texture",type:13,value:null},{name:"glossiness",type:4,value:10},{name:"normal_texture",type:13,value:null},{name:"alphaTestThreshold",type:4,value:0}],passes:[{program:"phong",cullMode:1029,depthTest:true,depthWrite:true}],layer:0},{stages:["shadowcast"],params:[],passes:[{program:"shadow-depth",cullMode:1029,depthTest:true,depthWrite:true}],layer:0}],properties:{},defines:[{name:"USE_NORMAL_TEXTURE",value:false},{name:"USE_DIFFUSE_TEXTURE",value:false},{name:"USE_SPECULAR",value:false},{name:"USE_SPECULAR_TEXTURE",value:false},{name:"USE_EMISSIVE",value:false},{name:"USE_EMISSIVE_TEXTURE",value:false},{name:"USE_ALPHA_TEST",value:false},{name:"USE_SKINNING",value:false},{name:"USE_SHADOW_MAP",value:false},{name:"NUM_DIR_LIGHTS",value:0},{name:"NUM_POINT_LIGHTS",value:0},{name:"NUM_SPOT_LIGHTS",value:0},{name:"NUM_SHADOW_LIGHTS",value:0}],dependencies:[{define:"USE_NORMAL_TEXTURE",extension:"OES_standard_derivatives"}]},{name:"simple",techniques:[{stages:["opaque"],params:[{name:"color",type:9,value:[.4,.4,.4,1]}],passes:[{program:"simple",depthTest:true,depthWrite:true}],layer:0}],properties:{},defines:[{name:"USE_TEXTURE",value:false},{name:"USE_COLOR",value:false}],dependencies:undefined},{name:"skybox",techniques:[{stages:["opaque"],params:[{name:"cubeMap",type:14,value:null}],passes:[{program:"skybox",cullMode:0}],layer:-1}],properties:{},defines:[],dependencies:undefined},{name:"sprite",techniques:[{stages:["ui"],params:[{name:"mainTexture",type:13,value:null}],passes:[{program:"sprite",depthTest:true,depthWrite:false,blend:true,blendEq:32774,blendSrc:770,blendDst:771,blendAlphaEq:32774,blendSrcAlpha:1,blendDstAlpha:771}],layer:0}],properties:{},defines:[],dependencies:undefined},{name:"unlit-transparent",techniques:[{stages:["transparent"],params:[{name:"color",type:9,value:[1,1,1,1]},{name:"mainTiling",type:5,value:[1,1]},{name:"mainOffset",type:5,value:[0,0]},{name:"mainTexture",type:13,value:null}],passes:[{program:"unlit",cullMode:1029,depthTest:true,depthWrite:true,blend:true,blendEq:32774,blendSrc:770,blendDst:771,blendAlphaEq:32774,blendSrcAlpha:1,blendDstAlpha:771}],layer:0}],properties:{},defines:[{name:"USE_TEXTURE",value:false},{name:"USE_COLOR",value:false},{name:"USE_SKINNING",value:false}],dependencies:undefined},{name:"unlit",techniques:[{stages:["opaque"],params:[{name:"color",type:9,value:[1,1,1,1]},{name:"mainTiling",type:5,value:[1,1]},{name:"mainOffset",type:5,value:[0,0]},{name:"mainTexture",type:13,value:null}],passes:[{program:"unlit",cullMode:1029,depthTest:true,depthWrite:true}],layer:0}],properties:{},defines:[{name:"USE_TEXTURE",value:false},{name:"USE_COLOR",value:false},{name:"USE_SKINNING",value:false}],dependencies:undefined},{name:"wireframe",techniques:[{stages:["opaque"],params:[{name:"color",type:8,value:[1,1,1]}],passes:[{program:"wireframe",depthTest:true,depthWrite:true}],layer:0}],properties:{},defines:[],dependencies:undefined}];function Do(e){var t;var n=document.createElement("canvas");var r=n.getContext("2d");n.width=n.height=128;r.fillStyle="#ddd";r.fillRect(0,0,128,128);r.fillStyle="#555";r.fillRect(0,0,64,64);r.fillStyle="#555";r.fillRect(64,64,64,64);var i=new ja(e);i.mipmap=true;i.wrapS="repeat";i.wrapT="repeat";i.setImage(0,n);i.commit();i._uuid="default-texture";i._loaded=true;var a=new To(e);a.setImages([[n,n,n,n,n,n]]);a.commit();a._uuid="default-texture-cube";a._loaded=true;n.width=n.height=2;r.fillStyle="#000";r.fillRect(0,0,2,2);var s=new ja(e);s.mipmap=false;s.wrapS="repeat";s.wrapT="repeat";s.minFilter="nearest";s.magFilter="nearest";s.setImage(0,n);s.commit();s._uuid="black-texture";s._loaded=true;n.width=n.height=2;r.fillStyle="#fff";r.fillRect(0,0,2,2);var o=new ja(e);o.mipmap=false;o.wrapS="repeat";o.wrapT="repeat";o.minFilter="nearest";o.magFilter="nearest";o.setImage(0,n);o.commit();o._uuid="white-texture";o._loaded=true;var l=new Ro;l._texture=o;l.width=o.width;l.height=o.height;l.commit();l._uuid="default-sprite";l._loaded=true;var u=new za;u._subMeshes=new Array(1);u._subMeshes[0]=Pi.createIA(e,Bs(1,1,1,{widthSegments:1,heightSegments:1,lengthSegments:1}));u._uuid="builtin-cube";u._loaded=true;var f=new za;f._subMeshes=new Array(1);f._subMeshes[0]=Pi.createIA(e,no(.5,{segments:64}));f._uuid="builtin-sphere";f._loaded=true;var h=new za;h._subMeshes=new Array(1);h._subMeshes[0]=Pi.createIA(e,ks(.5,.5,2,{radialSegments:20,capped:true}));h._uuid="builtin-cylinder";h._loaded=true;var c=new za;c._subMeshes=new Array(1);c._subMeshes[0]=Pi.createIA(e,Ys(10,10,{uSegments:10,vSegments:10}));c._uuid="builtin-plane";c._loaded=true;var p=new za;p._subMeshes=new Array(1);p._subMeshes[0]=Pi.createIA(e,so(.5,.5,2,{heightSegments:30,sides:20}));p._uuid="builtin-capsule";p._loaded=true;var d={};for(var m=0;m<Uo.length;++m){var _=Uo[m];var v=new So;v._name=_.name;v._uuid="builtin-effect-"+_.name;v._loaded=true;v.techniques=_.techniques;v.properties=_.properties;v.defines=_.defines;v.dependencies=_.dependencies?_.dependencies:[];d[v._uuid]=v}var g={};["sprite","font"].forEach(function(e){var t=new yo;t.effect=d["builtin-effect-"+e];t._uuid="builtin-material-"+e;t._loaded=true;g[t._uuid]=t});return Object.assign((t={},t[i._uuid]=i,t[a._uuid]=a,t[s._uuid]=s,t[o._uuid]=o,t[l._uuid]=l,t[u._uuid]=u,t[f._uuid]=f,t[h._uuid]=h,t[c._uuid]=c,t[p._uuid]=p,t),d,g)}var Lo={int:{default:0,parse:function e(t,n,r){var i=n;if(typeof n==="string"){i=parseInt(n)}if(r.min!==undefined){i=Math.max(r.min,i)}if(r.max!==undefined){i=Math.min(r.max,i)}return i}},number:{default:0,parse:function e(t,n,r){var i=n;if(typeof n==="string"){i=parseFloat(n)}if(r.min!==undefined){i=Math.max(r.min,i)}if(r.max!==undefined){i=Math.min(r.max,i)}return i}},string:{default:"",parse:function e(t,n){return n}},boolean:{default:true,parse:function e(t,n){return!!n}},object:{default:null,parse:function e(t,n){return n}},enums:{default:"",parse:function e(t,n,r){if(r.options.indexOf(n)===-1){console.log("Invalid option: "+n);if(r.default!==undefined){return r.default}return""}return n}},color3:{default:[1,1,1],parse:function e(t,n){if(Array.isArray(n)){return Bt.new(n[0],n[1],n[2])}return n}},color4:{default:[1,1,1,1],parse:function e(t,n){if(Array.isArray(n)){return Ft.new(n[0],n[1],n[2],n[3])}return n}},vec2:{default:[0,0],parse:function e(t,n){if(Array.isArray(n)){return Rt.new(n[0],n[1])}return n}},vec3:{default:[0,0,0],parse:function e(t,n){if(Array.isArray(n)){return Ut.new(n[0],n[1],n[2])}return n}},vec4:{default:[0,0,0,0],parse:function e(t,n){if(Array.isArray(n)){return Dt.new(n[0],n[1],n[2],n[3])}return n}},quat:{default:[0,0,0,1],parse:function e(t,n){if(Array.isArray(n)){return Ot.new(n[0],n[1],n[2],n[3])}return n}},mat3:{default:[1,0,0,0,1,0,0,0,1],parse:function e(t,n){if(Array.isArray(n)){return Lt.new(n[0],n[1],n[2],n[3],n[4],n[5],n[6],n[7],n[8])}return n}},mat4:{default:[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],parse:function e(t,n){if(Array.isArray(n)){return Pt.new(n[0],n[1],n[2],n[3],n[4],n[5],n[6],n[7],n[8],n[9],n[10],n[11],n[12],n[13],n[14],n[15])}return n}},asset:{default:null,parse:function e(t,n){if(typeof n==="string"){return t.assets.get(n)}return n}},rect:{default:[0,0,1,1],parse:function e(t,n){if(Array.isArray(n)){return n}return[n.x,n.y,n.w,n.h]}},entity:{default:null,parse:function e(t,n,r,i){if(typeof n==="string"){var a=n.match(/e(\d+)/);if(a){var s=parseInt(a[1]);return i[s]}}return n}},component:{default:null,parse:function e(t,n,r,i){if(typeof n==="string"){var a=n.match(/e(\d+)c(\d+)/);if(a){var s=parseInt(a[0]);var o=parseInt(a[1]);var l=i[s];var u=l._comps[o];return u}}return n}}};function Oo(e,t){var n=0;var r=e.length-1;var i;while(n<=r){i=n+r>>1;var a=e[i];if(a<t){n=i+1}else if(a>t){r=i-1}else{return i}}return n}var Io=function(e){function t(){e.call(this);this._framesList=null;this._length=0}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;var n={length:{configurable:true}};n.length.get=function(){return this._length};t.prototype.sample=function e(t,n){var r=this;We(n,0,this._length);for(var i=0;i<this._framesList.length;++i){var a=r._framesList[i];if(a.times.length===1){for(var s=0;s<a.joints.length;++s){var o=a.joints[s];var l=t._joints[o.id];if(o.translations){Ut.copy(l.lpos,o.translations[0])}if(o.rotations){Ot.copy(l.lrot,o.rotations[0])}if(o.scales){Ut.copy(l.lscale,o.scales[0])}}}else{var u=Oo(a.times,n);if(u===0){for(var f=0;f<a.joints.length;++f){var h=a.joints[f];var c=t._joints[h.id];if(h.translations){Ut.copy(c.lpos,h.translations[0])}if(h.rotations){Ot.copy(c.lrot,h.rotations[0])}if(h.scales){Ut.copy(c.lscale,h.scales[0])}}return}var p=Math.max(u-1,0);var d=Math.min(u,a.times.length);var m=(n-a.times[p])/(a.times[d]-a.times[p]);for(var _=0;_<a.joints.length;++_){var v=a.joints[_];var g=t._joints[v.id];if(v.translations){var y=v.translations[p];var b=v.translations[d];Ut.lerp(g.lpos,y,b,m)}if(v.rotations){var x=v.rotations[p];var T=v.rotations[d];Ot.slerp(g.lrot,x,T,m)}if(v.scales){var S=v.scales[p];var E=v.scales[d];Ut.lerp(g.lscale,S,E,m)}}}}t.updateMatrices()};Object.defineProperties(t.prototype,n);return t}(Ba);var Co=function e(){this._root=null;this._joints=null;this._matrices=null};Co.prototype.setRoot=function e(t){var n=this;this._root=t;this._joints=kr.flat(this._root);this._matrices=new Array(this._joints.length);for(var r=0;r<this._joints.length;++r){n._matrices[r]=Pt.create()}this.updateMatrices()};Co.prototype.blend=function e(t,n,r){var i=this;for(var a=0;a<this._joints.length;++a){var s=i._joints[a];var o=t._joints[a];var l=n._joints[a];Ut.lerp(s.lpos,o.lpos,l.lpos,r);Ut.lerp(s.lscale,o.lscale,l.lscale,r);Ot.slerp(s.lrot,o.lrot,l.lrot,r)}};Co.prototype.updateMatrices=function e(){var t=this;for(var n=0;n<this._joints.length;++n){t._joints[n].getWorldMatrix(t._matrices[n])}};Co.prototype.getWorldMatrix=function e(t){return this._matrices[t]};Co.prototype.clone=function e(){var t=new Co;t.setRoot(kr.deepClone(this._root));return t};var Po=function(e){function t(){e.call(this);this._nodes=null}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.instantiate=function e(){var t=Xo.createNodes(this._nodes);var n=new Co;n.setRoot(t[0]);return n};return t}(Ba);var Bo={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16};var Fo={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5124:Int32Array,5125:Uint32Array,5126:Float32Array};function zo(e,t,n){var r=e.accessors[n];var i=e.bufferViews[r.bufferView];var a=Bo[r.type];var s=Fo[r.componentType];var o=new s(t,i.byteOffset+r.byteOffset,r.count*a);return o}function ko(e){var t=new Array(e.length);for(var n=0;n<e.length;++n){var r=e[n];var i=new Ur(r.name);if(r.translation){Ut.set(i.lpos,r.translation[0],r.translation[1],r.translation[2])}if(r.rotation){Ot.set(i.lrot,r.rotation[0],r.rotation[1],r.rotation[2],r.rotation[3])}if(r.scale){Ut.set(i.lscale,r.scale[0],r.scale[1],r.scale[2])}t[n]=i}for(var a=0;a<e.length;++a){var s=e[a];var o=t[a];if(s.children){for(var l=0;l<s.children.length;++l){var u=s.children[l];o.append(t[u])}}}return t}function No(e,t){var n=new Array(t.length);for(var r=0;r<t.length;++r){var i=t[r];var a=e.createEntity(i.name);if(i.translation){Ut.set(a.lpos,i.translation[0],i.translation[1],i.translation[2])}if(i.rotation){Ot.set(a.lrot,i.rotation[0],i.rotation[1],i.rotation[2],i.rotation[3])}if(i.scale){Ut.set(a.lscale,i.scale[0],i.scale[1],i.scale[2])}n[r]=a}for(var s=0;s<t.length;++s){var o=t[s];var l=n[s];if(o.children){for(var u=0;u<o.children.length;++u){var f=o.children[u];l.append(n[f])}}}return n}function Go(e,t,n,r){if(r>=t.meshes.length){return null}var i=t.meshes[r];var a=t.accessors;var s=i.primitives[0].attributes;var o=null;var l=new za;l._name=i.name;l._subMeshes=new Array(i.primitives.length);var u=[];var f=0;if(s.POSITION!==undefined){var h=a[s.POSITION];u.push({name:Me.ATTR_POSITION,type:h.componentType,num:Bo[h.type]});f=h.count;o=t.bufferViews[h.bufferView];l._minPos=Ut.new(h.min[0],h.min[1],h.min[2]);l._maxPos=Ut.new(h.max[0],h.max[1],h.max[2])}if(s.NORMAL!==undefined){var c=a[s.NORMAL];u.push({name:Me.ATTR_NORMAL,type:c.componentType,num:Bo[c.type]})}if(s.TANGENT!==undefined){var p=a[s.TANGENT];u.push({name:Me.ATTR_TANGENT,type:p.componentType,num:Bo[p.type]})}if(s.TEXCOORD_0!==undefined){var d=a[s.TEXCOORD_0];u.push({name:Me.ATTR_UV0,type:d.componentType,num:Bo[d.type]})}if(s.TEXCOORD_1!==undefined){var m=a[s.TEXCOORD_1];u.push({name:Me.ATTR_UV1,type:m.componentType,num:Bo[m.type]})}if(s.TEXCOORD_2!==undefined){var _=a[s.TEXCOORD_2];u.push({name:Me.ATTR_UV2,type:_.componentType,num:Bo[_.type]})}if(s.TEXCOORD_3!==undefined){var v=a[s.TEXCOORD_3];u.push({name:Me.ATTR_UV3,type:v.componentType,num:Bo[v.type]})}if(s.COLOR_0!==undefined){var g=a[s.COLOR_0];u.push({name:Me.ATTR_COLOR0,type:g.componentType,num:Bo[g.type]})}if(s.JOINTS_0!==undefined){var y=a[s.JOINTS_0];u.push({name:Me.ATTR_JOINTS,type:y.componentType,num:Bo[y.type]})}if(s.WEIGHTS_0!==undefined){var b=a[s.WEIGHTS_0];u.push({name:Me.ATTR_WEIGHTS,type:b.componentType,num:Bo[b.type]})}var x=new Uint8Array(n,o.byteOffset,o.byteLength);var T=new Me.VertexBuffer(e.device,new Me.VertexFormat(u),Me.USAGE_STATIC,x,f);for(var S=0;S<i.primitives.length;++S){var E=i.primitives[S];var w=null;if(E.indices!==undefined){var M=a[E.indices];var A=t.bufferViews[M.bufferView];var R=new Uint8Array(n,A.byteOffset,A.byteLength);w=new Me.IndexBuffer(e.device,M.componentType,Me.USAGE_STATIC,R,M.count)}l._subMeshes[S]=new Pi.InputAssembler(T,w)}if(t.skins){for(var U=0;U<t.skins.length;++U){if(t.skins[U].name===i.name){l._skinning=Vo(t,n,U)}}}return l}function Vo(e,t,n){if(n>=e.skins.length){return null}var r=e.skins[n];var i=e.accessors[r.inverseBindMatrices];var a=e.bufferViews[i.bufferView];var s=new Float32Array(t,a.byteOffset+i.byteOffset,i.count*16);var o=new Array(i.count);for(var l=0;l<i.count;++l){o[l]=Pt.new(s[16*l+0],s[16*l+1],s[16*l+2],s[16*l+3],s[16*l+4],s[16*l+5],s[16*l+6],s[16*l+7],s[16*l+8],s[16*l+9],s[16*l+10],s[16*l+11],s[16*l+12],s[16*l+13],s[16*l+14],s[16*l+15])}return{jointIndices:r.joints,bindposes:o}}function Ho(e,t,n){if(n>=e.animations.length){return null}var r=e.animations[n];var i=[];var a=-1;for(var s=0;s<r.channels.length;++s){var o=r.channels[s];var l=e.accessors[o.input];var u=void 0;for(var f=0;f<i.length;++f){if(i[f].name===l.name){u=i[f];break}}if(!u){var h=zo(e,t,o.input);var c=new Array(h.length);for(var p=0;p<h.length;++p){var d=h[p];c[p]=d;if(a<d){a=d}}u={name:l.name,times:c,joints:[]};i.push(u)}var m=void 0;for(var _=0;_<u.joints.length;++_){if(u.joints[_].id===o.node){m=u.joints[_];break}}if(!m){m={id:o.node};u.joints.push(m)}var v=zo(e,t,o.output);if(o.path==="translation"){var g=v.length/3;m.translations=new Array(g);for(var y=0;y<g;++y){m.translations[y]=Ut.new(v[3*y+0],v[3*y+1],v[3*y+2])}}else if(o.path==="rotation"){var b=v.length/4;m.rotations=new Array(b);for(var x=0;x<b;++x){m.rotations[x]=Ot.new(v[4*x+0],v[4*x+1],v[4*x+2],v[4*x+3])}}else if(o.path==="scale"){var T=v.length/3;m.scales=new Array(T);for(var S=0;S<T;++S){m.scales[S]=Ut.new(v[3*S+0],v[3*S+1],v[3*S+2])}}}var E=new Io;E._name=r.name;E._framesList=i;E._length=a;return E}function Wo(e){var t=new Po;t._name=e.joints[0].name;t._nodes=e.joints;return t}var Xo={createArray:zo,createNodes:ko,createEntities:No,createMesh:Go,createSkinning:Vo,createAnimationClip:Ho,createJoints:Wo};function jo(e,t,n){Ca({manifest:{mesh:{type:"text",parser:JSON.parse,src:t.mesh},bin:{type:"binary",src:t.bin}},onDone:function t(r){var i=r.mesh;var a=r.bin;if(!i.meshes.length){n(new Error("No mesh in the gltf."));return}var s=Xo.createMesh(e,i,a,0);n(null,s)}})}function qo(e,t,n){Ca({manifest:{json:{type:"text",parser:JSON.parse,src:t.json}},onDone:function t(r){var i=r.json;var a=new yo;var s=i.properties;if(i.type==="unlit"){a.effect=e.assets.get("builtin-effect-unlit");if(s.color){a.setProperty("color",Ft.new(s.color[0],s.color[1],s.color[2],s.color[3]))}if(s.mainTiling){a.setProperty("mainTiling",Rt.new(s.mainTiling[0],s.mainTiling[1]))}if(s.mainOffset){a.setProperty("mainOffset",Rt.new(s.mainOffset[0],s.mainOffset[1]))}var o=[];if(s.mainTexture){o.push(function(t){e.assets.load(s.mainTexture,function(e,n){a.setProperty("mainTexture",n);a.define("USE_TEXTURE",true);t()})})}Ya.parallel(o,function(e){if(e){console.error(e)}n(null,a)})}else if(i.type==="phong"){a.effect=e.assets.get("builtin-effect-phong");if(s.diffuseColor){a.setProperty("diffuseColor",Ft.new(s.diffuseColor[0],s.diffuseColor[1],s.diffuseColor[2],s.diffuseColor[3]))}if(s.mainTiling){a.setProperty("mainTiling",Rt.new(s.mainTiling[0],s.mainTiling[1]))}if(s.mainOffset){a.setProperty("mainOffset",Rt.new(s.mainOffset[0],s.mainOffset[1]))}a.define("USE_SPECULAR",s.USE_SPECULAR);if(s.specularColor){a.setProperty("specularColor",Ft.new(s.specularColor[0],s.specularColor[1],s.specularColor[2],s.specularColor[3]))}a.define("USE_EMISSIVE",s.USE_EMISSIVE);if(s.emissiveColor){a.setProperty("emissiveColor",Bt.new(s.emissiveColor[0],s.emissiveColor[1],s.emissiveColor[2]))}if(s.glossiness){a.setProperty("glossiness",s.glossiness)}var l=[];a.define("USE_DIFFUSE_TEXTURE",s.USE_DIFFUSE_TEXTURE);if(s.diffuse_texture){l.push(function(t){e.assets.load(s.diffuse_texture,function(e,n){a.setProperty("diffuse_texture",n);t()})})}a.define("USE_SPECULAR_TEXTURE",s.USE_SPECULAR_TEXTURE);if(s.specular_texture){l.push(function(t){e.assets.load(s.specular_texture,function(e,n){a.setProperty("specular_texture",n);t()})})}a.define("USE_EMISSIVE_TEXTURE",s.USE_EMISSIVE_TEXTURE);if(s.emissive_texture){l.push(function(t){e.assets.load(s.emissive_texture,function(e,n){a.setProperty("emissive_texture",n);t()})})}a.define("USE_NORMAL_TEXTURE",s.USE_NORMAL_TEXTURE);if(s.normal_texture){l.push(function(t){e.assets.load(s.normal_texture,function(e,n){a.setProperty("normal_texture",n);t()})})}Ya.parallel(l,function(e){if(e){console.error(e)}n(null,a)})}else if(i.type==="grid"){a.effect=e.assets.get("builtin-effect-grid");a.define("USE_WORLD_POS",s.useWorldPos);a.setProperty("tiling",Rt.new(s.tilingX,s.tilingY));a.setProperty("baseColorBlack",Ft.new(s.baseColorBlack[0],s.baseColorBlack[1],s.baseColorBlack[2],s.baseColorBlack[3]));a.setProperty("baseColorWhite",Ft.new(s.baseColorWhite[0],s.baseColorWhite[1],s.baseColorWhite[2],s.baseColorWhite[3]));a.setProperty("subPatternColor",Ft.new(s.subPatternColor[0],s.subPatternColor[1],s.subPatternColor[2],s.subPatternColor[3]));a.setProperty("subPatternColor2",Ft.new(s.subPatternColor2[0],s.subPatternColor2[1],s.subPatternColor2[2],s.subPatternColor2[3]));a.setProperty("basePatternTiling",Rt.new(s.basePatternTiling[0],s.basePatternTiling[1]));a.setProperty("basePatternOffset",Rt.new(s.basePatternOffset[0],s.basePatternOffset[1]));a.setProperty("subPatternTiling",Rt.new(s.subPatternTiling[0],s.subPatternTiling[1]));a.setProperty("subPatternOffset",Rt.new(s.subPatternOffset[0],s.subPatternOffset[1]));a.setProperty("subPattern2Tiling",Rt.new(s.subPattern2Tiling[0],s.subPattern2Tiling[1]));a.setProperty("subPattern2Offset",Rt.new(s.subPattern2Offset[0],s.subPattern2Offset[1]));e.assets.load("black-texture",function(e,t){a.setProperty("basePattern",t);a.setProperty("subPattern",t);a.setProperty("subPattern2",t)});var u=[];if(s.basePattern){u.push(function(t){e.assets.load(s.basePattern,function(e,n){a.setProperty("basePattern",n);t()})})}if(s.subPattern){u.push(function(t){e.assets.load(s.subPattern,function(e,n){a.setProperty("subPattern",n);t()})})}if(s.subPattern2){u.push(function(t){e.assets.load(s.subPattern2,function(e,n){a.setProperty("subPattern2",n);t()})})}Ya.parallel(u,function(e){if(e){console.error(e)}n(null,a)})}else if(i.type==="matcap"){a.effect=e.assets.get("builtin-effect-matcap");if(s.colorFactor){a.setProperty("colorFactor",s.colorFactor)}if(s.color){a.setProperty("color",Ft.new(s.color[0],s.color[1],s.color[2],s.color[3]))}var f=[];if(s.mainTex){f.push(function(t){e.assets.load(s.mainTex,function(e,n){a.setProperty("mainTex",n);a.define("USE_MAIN_TEX",true);t()})})}if(s.matcapTex){f.push(function(t){e.assets.load(s.matcapTex,function(e,n){a.setProperty("matcapTex",n);t()})})}Ya.parallel(f,function(e){if(e){console.error(e)}n(null,a)})}else if(i.type==="pbr"){a.effect=e.assets.get("builtin-effect-pbr");a.setProperty("albedo",Ft.new(s.albedo[0],s.albedo[1],s.albedo[2],s.albedo[3]));if(s.mainTiling){a.setProperty("mainTiling",Rt.new(s.mainTiling[0],s.mainTiling[1]))}if(s.mainOffset){a.setProperty("mainOffset",Rt.new(s.mainOffset[0],s.mainOffset[1]))}if(s.metallic){a.setProperty("metallic",s.metallic)}if(s.roughness){a.setProperty("roughness",s.roughness)}if(s.ao){a.setProperty("ao",s.ao)}a.define("USE_EMISSIVE",s.USE_EMISSIVE);if(s.emissive){a.setProperty("emissive",Bt.new(s.emissive[0],s.emissive[1],s.emissive[2]))}var h=[];a.define("USE_ALBEDO_TEXTURE",s.USE_ALBEDO_TEXTURE);if(s.albedo_texture){h.push(function(t){e.assets.load(s.albedo_texture,function(e,n){a.setProperty("albedo_texture",n);t()})})}a.define("USE_METALLIC_TEXTURE",s.USE_METALLIC_TEXTURE);if(s.metallic_texture){h.push(function(t){e.assets.load(s.metallic_texture,function(e,n){a.setProperty("metallic_texture",n);t()})})}a.define("USE_ROUGHNESS_TEXTURE",s.USE_ROUGHNESS_TEXTURE);if(s.roughness_texture){h.push(function(t){e.assets.load(s.roughness_texture,function(e,n){a.setProperty("roughness_texture",n);t()})})}a.define("USE_NORMAL_TEXTURE",s.USE_NORMAL_TEXTURE);if(s.normal_texture){h.push(function(t){e.assets.load(s.normal_texture,function(e,n){a.setProperty("normal_texture",n);t()})})}a.define("USE_AO_TEXTURE",s.USE_AO_TEXTURE);if(s.ao_texture){h.push(function(t){e.assets.load(s.ao_texture,function(e,n){a.setProperty("ao_texture",n);t()})})}a.define("USE_EMISSIVE_TEXTURE",s.USE_EMISSIVE_TEXTURE);if(s.emissive_texture){h.push(function(t){e.assets.load(s.emissive_texture,function(e,n){a.setProperty("emissive_texture",n);t()})})}Ya.parallel(h,function(e){if(e){console.error(e)}n(null,a)})}else if(i.type.startsWith("particle")){a.effect=e.assets.get("builtin-effect-"+i.type);if(s.tintColor){a.setProperty("tintColor",Ft.new(s.tintColor[0],s.tintColor[1],s.tintColor[2],s.tintColor[3]))}if(s.mainTiling){a.setProperty("mainTiling",Rt.new(s.mainTiling[0],s.mainTiling[1]))}if(s.mainOffset){a.setProperty("mainOffset",Rt.new(s.mainOffset[0],s.mainOffset[1]))}var c=[];if(s.mainTexture){c.push(function(t){e.assets.load(s.mainTexture,function(e,n){a.setProperty("mainTexture",n);t()})})}Ya.parallel(c,function(e){if(e){console.error(e)}n(null,a)})}else{console.error("unsupported material loading")}}})}var Yo=function(e){function t(t){e.call(this,t);this._sprites={}}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;var n={sprites:{configurable:true}};n.sprites.get=function(){return this._sprites};t.prototype.unload=function t(){var n=this;if(!this._loaded){return}for(var r in n._sprites){n._sprites[r].unload()}e.prototype.unload.call(this)};t.prototype.subAsset=function e(t){var n=this._sprites[t];return n||null};Object.defineProperties(t.prototype,n);return t}(ja);function Ko(e,t,n){var r=new ja(e);if(n){r.mipmap=n.mipmap;r.anisotropy=n.anisotropy;r.minFilter=n.minFilter;r.magFilter=n.magFilter;r.mipFilter=n.mipFilter;r.wrapS=n.wrapS;r.wrapT=n.wrapT}r.setImages(t);r.commit();return r}function Zo(e,t,n){var r=new To(e);if(n){r.mipmap=n.mipmap;r.anisotropy=n.anisotropy;r.minFilter=n.minFilter;r.magFilter=n.magFilter;r.mipFilter=n.mipFilter;r.wrapS=n.wrapS;r.wrapT=n.wrapT}r.setImages(t);r.commit();return r}function Jo(e,t,n){var r=new Yo(e);if(n){r.mipmap=n.mipmap;r.anisotropy=n.anisotropy;r.minFilter=n.minFilter;r.magFilter=n.magFilter;r.mipFilter=n.mipFilter;r.wrapS=n.wrapS;r.wrapT=n.wrapT}r.setImages(t);r.commit();if(n&&n.sprites){for(var i in n.sprites){var a=n.sprites[i];var s=new Ro;s._name=i;s._rotated=a.rotated;s._x=a.x;s._y=a.y;s._width=a.width;s._height=a.height;s._left=a.left||0;s._right=a.right||0;s._top=a.top||0;s._bottom=a.bottom||0;s._texture=r;s.commit();r._sprites[i]=s}}return r}function Qo(e,t,n){var r={};var i=0;for(var a in t){if(a.indexOf("image")===0){var s=parseInt(a.split("@")[1]);if(s>i){i=s}r[a]={type:"image",src:t[a]}}}i+=1;if(t.json){r.json={type:"text",parser:JSON.parse,src:t.json}}Ca({manifest:r,onDone:function t(r){var a=r.json;var s=[];var o;var l=a?a.type:"2d";if(l==="2d"||l==="sprite"){for(var u=0;u<i;++u){if(u===0){s.push(r.image)}else{s.push(r["image@"+u])}}if(l==="2d"){o=Ko(e.device,s,a)}else if(l==="sprite"){o=Jo(e.device,s,a)}}else if(l==="cube"){for(var f=0;f<i;++f){if(f===0){s.push([r.imagePosX,r.imageNegX,r.imagePosY,r.imageNegY,r.imagePosZ,r.imageNegZ])}else{s.push([r["imagePosX@"+f],r["imageNegX@"+f],r["imagePosY@"+f],r["imageNegY@"+f],r["imagePosZ@"+f],r["imageNegZ@"+f]])}}o=Zo(e.device,s,a)}n(null,o)}})}var $o=function(e){function t(){e.call(this);this._app=null;this._json=null;this._assets=null}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.unload=function t(){if(!this._loaded){return}e.prototype.unload.call(this)};t.prototype.instantiate=function e(t,n){if(n===void 0)n=null;return ts.createPrefab(this._app,this._json,t,n)};return t}(Ba);function el(e,t,n){Ca({manifest:{json:{type:"text",parser:JSON.parse,src:t.json}},onDone:function t(r){ts.preloadAssets(e,r.json,function(t,i){var a=new $o;a._app=e;a._json=r.json;a._assets=i;if(t){n(t);return}n(null,a)})}})}var tl=function(e){function t(){e.call(this);this._nodes=null;this._meshes=null;this._joints=null}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.subAsset=function e(t){var n=parseInt(t.substring(1));if(t[0]==="m"){return this._meshes[n]}if(t==="joints"){return this._joints}return null};return t}(Ba);function nl(e,t,n){Ca({manifest:{gltf:{type:"text",parser:JSON.parse,src:t.gltf},bin:{type:"binary",src:t.bin}},onDone:function t(r){var i=r.gltf;var a=r.bin;var s=new tl;s._nodes=i.nodes;if(i.meshes){s._meshes=new Array(i.meshes.length);for(var o=0;o<i.meshes.length;++o){s._meshes[o]=Xo.createMesh(e,i,a,o)}}if(i.joints){s._joints=Xo.createJoints(i)}n(null,s)}})}function rl(e,t,n){Ca({manifest:{anim:{type:"text",parser:JSON.parse,src:t.anim},bin:{type:"binary",src:t.bin}},onDone:function e(t){var r=t.anim;var i=t.bin;if(!r.animations.length){n(new Error("No animation in the gltf."));return}var a=Xo.createAnimationClip(r,i,0);n(null,a)}})}var il={WEB_AUDIO:0,DOM_AUDIO:1};var al=function(e){function t(){e.call(this);this.__initEventEmitter();this._audio=null;this.loadMode=il.WEB_AUDIO}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;var n={nativeAsset:{configurable:true}};n.nativeAsset.get=function(){return this._audio};n.nativeAsset.set=function(e){this._audio=e;if(e){this._loaded=true}};Object.defineProperties(t.prototype,n);return t}(Ba);na.mixin(al);var sl=null;function ol(e,t,n){sl=e.system("audio");if(sl.__audioSupport.format.length===0){return new Error("no audio file format available.")}var r=sl.getIDByURL(t.bin);if(r){sl._getClipByID(r).once("load",function(){n(null,sl._getClipByID(r))});return}var i=null;if(!sl.__audioSupport.WEB_AUDIO){i=ll}else{i=ul}t.url=t.bin;i(t,n)}function ll(e,t){var n=document.createElement("audio");n.src=e.url;var r=function(){clearTimeout(i);n.removeEventListener("canplaythrough",s,false);n.removeEventListener("error",o,false);if(sl.__audioSupport.USE_LOADER_EVENT){n.removeEventListener(sl.__audioSupport.USE_LOADER_EVENT,s,false)}};var i=setTimeout(function(){if(n.readyState===0){o()}else{s()}},8e3);var a=new al;a.url=e.url;sl.addClip(e.url,a);var s=function(){r();a.nativeAsset=n;a.loadMode=il.DOM_AUDIO;a.emit("load");t(null,a)};var o=function(){r();var n="load audio failure - "+e.url;console.log(n);sl.removeClip(e.url);t(n)};n.addEventListener("canplaythrough",s,false);n.addEventListener("error",o,false);if(sl.__audioSupport.USE_LOADER_EVENT){n.addEventListener(sl.__audioSupport.USE_LOADER_EVENT,s,false)}}function ul(e,t){if(!sl.__audioSupport.context){t(new Error("audio context not found."))}var n=fl();n.open("GET",e.url,true);n.responseType="arraybuffer";var r=new al;r.url=e.url;sl.addClip(e.url,r);n.onload=function(){sl.__audioSupport.context["decodeAudioData"](n.response,function(e){r.nativeAsset=e;r.emit("load");t(null,r)},function(){sl.removeClip(e.url);t("decode error",null)})};n.onerror=function(){sl.removeClip(e.url);t("request error",null)};n.send()}function fl(){return window.XMLHttpRequest?new window.XMLHttpRequest:new window.ActiveXObject("MSXML2.XMLHTTP")}var hl=function(e){function t(){e.call(this);this._size=32;this._type="unknow";this._glyphs={};this._lineHeight=32;this._useKerning=false}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;var n={size:{configurable:true},lineHeight:{configurable:true},type:{configurable:true}};n.size.get=function(){return this._size};n.lineHeight.get=function(){return this._lineHeight};n.type.get=function(){return this._type};Object.defineProperties(t.prototype,n);return t}(Ba);var cl=function(e){function t(){e.call(this);this._texture=null;this._face="";this._defaultGlyph={char:" ",x:0,y:0,width:16,height:16,xoffset:0,yoffset:0,xadvance:16,uvs:[Rt.new(0,0),Rt.new(0,0),Rt.new(0,0),Rt.new(0,0)]};this._type="bitmap"}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;var n={texture:{configurable:true},face:{configurable:true}};n.texture.get=function(){return this._texture};n.face.get=function(){return this._face};Object.defineProperties(t.prototype,n);return t}(hl);function pl(e,t,n){Ca({manifest:{json:{type:"text",parser:JSON.parse,src:t.json}},onDone:function t(r){var i=r.json;var a=new cl;e.assets.load(i.texture,function(e,t){if(e){console.error(e);n(e,null);return}var r=t._texture._width;var s=t._texture._height;a._texture=t;a._face=i.face;a._size=i.size;a._lineHeight=i.lineHeight;for(var o in i.chars){var l=i.chars[o];var u=l.x/r;var f=(l.x+l.width)/r;var h=1-(l.y+l.height)/s;var c=1-l.y/s;a._glyphs[o]={char:String.fromCharCode(o),x:l.x,y:l.y,width:l.width,height:l.height,xoffset:l.xoffset,yoffset:l.yoffset,xadvance:l.xadvance};a._glyphs[o].uvs=[Rt.new(u,h),Rt.new(f,h),Rt.new(u,c),Rt.new(f,c)]}n(null,a)})}})}var dl=0;var ml=-3;function _l(){this.table=new Uint16Array(16);this.trans=new Uint16Array(288)}function vl(e,t){this.source=e;this.sourceIndex=0;this.tag=0;this.bitcount=0;this.dest=t;this.destLen=0;this.ltree=new _l;this.dtree=new _l}var gl=new _l;var yl=new _l;var bl=new Uint8Array(30);var xl=new Uint16Array(30);var Tl=new Uint8Array(30);var Sl=new Uint16Array(30);var El=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]);var wl=new _l;var Ml=new Uint8Array(288+32);function Al(e,t,n,r){var i,a;for(i=0;i<n;++i){e[i]=0}for(i=0;i<30-n;++i){e[i+n]=i/n|0}for(a=r,i=0;i<30;++i){t[i]=a;a+=1<<e[i]}}function Rl(e,t){var n;for(n=0;n<7;++n){e.table[n]=0}e.table[7]=24;e.table[8]=152;e.table[9]=112;for(n=0;n<24;++n){e.trans[n]=256+n}for(n=0;n<144;++n){e.trans[24+n]=n}for(n=0;n<8;++n){e.trans[24+144+n]=280+n}for(n=0;n<112;++n){e.trans[24+144+8+n]=144+n}for(n=0;n<5;++n){t.table[n]=0}t.table[5]=32;for(n=0;n<32;++n){t.trans[n]=n}}var Ul=new Uint16Array(16);function Dl(e,t,n,r){var i,a;for(i=0;i<16;++i){e.table[i]=0}for(i=0;i<r;++i){e.table[t[n+i]]++}e.table[0]=0;for(a=0,i=0;i<16;++i){Ul[i]=a;a+=e.table[i]}for(i=0;i<r;++i){if(t[n+i]){e.trans[Ul[t[n+i]]++]=i}}}function Ll(e){if(!e.bitcount--){e.tag=e.source[e.sourceIndex++];e.bitcount=7}var t=e.tag&1;e.tag>>>=1;return t}function Ol(e,t,n){if(!t){return n}while(e.bitcount<24){e.tag|=e.source[e.sourceIndex++]<<e.bitcount;e.bitcount+=8}var r=e.tag&65535>>>16-t;e.tag>>>=t;e.bitcount-=t;return r+n}function Il(e,t){while(e.bitcount<24){e.tag|=e.source[e.sourceIndex++]<<e.bitcount;e.bitcount+=8}var n=0,r=0,i=0;var a=e.tag;do{r=2*r+(a&1);a>>>=1;++i;n+=t.table[i];r-=t.table[i]}while(r>=0);e.tag=a;e.bitcount-=i;return t.trans[n+r]}function Cl(e,t,n){var r,i,a;var s,o,l;r=Ol(e,5,257);i=Ol(e,5,1);a=Ol(e,4,4);for(s=0;s<19;++s){Ml[s]=0}for(s=0;s<a;++s){var u=Ol(e,3,0);Ml[El[s]]=u}Dl(wl,Ml,0,19);for(o=0;o<r+i;){var f=Il(e,wl);switch(f){case 16:var h=Ml[o-1];for(l=Ol(e,2,3);l;--l){Ml[o++]=h}break;case 17:for(l=Ol(e,3,3);l;--l){Ml[o++]=0}break;case 18:for(l=Ol(e,7,11);l;--l){Ml[o++]=0}break;default:Ml[o++]=f;break}}Dl(t,Ml,0,r);Dl(n,Ml,r,i)}function Pl(e,t,n){while(1){var r=Il(e,t);if(r===256){return dl}if(r<256){e.dest[e.destLen++]=r}else{var i,a,s;var o;r-=257;i=Ol(e,bl[r],xl[r]);a=Il(e,n);s=e.destLen-Ol(e,Tl[a],Sl[a]);for(o=s;o<s+i;++o){e.dest[e.destLen++]=e.dest[o]}}}}function Bl(e){var t,n;var r;while(e.bitcount>8){e.sourceIndex--;e.bitcount-=8}t=e.source[e.sourceIndex+1];t=256*t+e.source[e.sourceIndex];n=e.source[e.sourceIndex+3];n=256*n+e.source[e.sourceIndex+2];if(t!==(~n&65535)){return ml}e.sourceIndex+=4;for(r=t;r;--r){e.dest[e.destLen++]=e.source[e.sourceIndex++]}e.bitcount=0;return dl}function Fl(e,t){var n=new vl(e,t);var r,i,a;do{r=Ll(n);i=Ol(n,2,0);switch(i){case 0:a=Bl(n);break;case 1:a=Pl(n,gl,yl);break;case 2:Cl(n,n.ltree,n.dtree);a=Pl(n,n.ltree,n.dtree);break;default:a=ml}if(a!==dl){throw new Error("Data error")}}while(!r);if(n.destLen<n.dest.length){if(typeof n.dest.slice==="function"){return n.dest.slice(0,n.destLen)}else{return n.dest.subarray(0,n.destLen)}}return n.dest}Rl(gl,yl);Al(bl,xl,4,3);Al(Tl,Sl,2,1);bl[28]=0;xl[28]=258;var zl=Fl;function kl(e,t,n,r,i){return Math.pow(1-i,3)*e+3*Math.pow(1-i,2)*i*t+3*(1-i)*Math.pow(i,2)*n+Math.pow(i,3)*r}function Nl(){this.x1=Number.NaN;this.y1=Number.NaN;this.x2=Number.NaN;this.y2=Number.NaN}Nl.prototype.isEmpty=function(){return isNaN(this.x1)||isNaN(this.y1)||isNaN(this.x2)||isNaN(this.y2)};Nl.prototype.addPoint=function(e,t){if(typeof e==="number"){if(isNaN(this.x1)||isNaN(this.x2)){this.x1=e;this.x2=e}if(e<this.x1){this.x1=e}if(e>this.x2){this.x2=e}}if(typeof t==="number"){if(isNaN(this.y1)||isNaN(this.y2)){this.y1=t;this.y2=t}if(t<this.y1){this.y1=t}if(t>this.y2){this.y2=t}}};Nl.prototype.addX=function(e){this.addPoint(e,null)};Nl.prototype.addY=function(e){this.addPoint(null,e)};Nl.prototype.addBezier=function(e,t,n,r,i,a,s,o){var l=this;var u=[e,t];var f=[n,r];var h=[i,a];var c=[s,o];this.addPoint(e,t);this.addPoint(s,o);for(var p=0;p<=1;p++){var d=6*u[p]-12*f[p]+6*h[p];var m=-3*u[p]+9*f[p]-9*h[p]+3*c[p];var _=3*f[p]-3*u[p];if(m===0){if(d===0){continue}var v=-_/d;if(0<v&&v<1){if(p===0){l.addX(kl(u[p],f[p],h[p],c[p],v))}if(p===1){l.addY(kl(u[p],f[p],h[p],c[p],v))}}continue}var g=Math.pow(d,2)-4*_*m;if(g<0){continue}var y=(-d+Math.sqrt(g))/(2*m);if(0<y&&y<1){if(p===0){l.addX(kl(u[p],f[p],h[p],c[p],y))}if(p===1){l.addY(kl(u[p],f[p],h[p],c[p],y))}}var b=(-d-Math.sqrt(g))/(2*m);if(0<b&&b<1){if(p===0){l.addX(kl(u[p],f[p],h[p],c[p],b))}if(p===1){l.addY(kl(u[p],f[p],h[p],c[p],b))}}}};Nl.prototype.addQuad=function(e,t,n,r,i,a){var s=e+2/3*(n-e);var o=t+2/3*(r-t);var l=s+1/3*(i-e);var u=o+1/3*(a-t);this.addBezier(e,t,s,o,l,u,i,a)};function Gl(){this.commands=[];this.fill="black";this.stroke=null;this.strokeWidth=1}Gl.prototype.moveTo=function(e,t){this.commands.push({type:"M",x:e,y:t})};Gl.prototype.lineTo=function(e,t){this.commands.push({type:"L",x:e,y:t})};Gl.prototype.curveTo=Gl.prototype.bezierCurveTo=function(e,t,n,r,i,a){this.commands.push({type:"C",x1:e,y1:t,x2:n,y2:r,x:i,y:a})};Gl.prototype.quadTo=Gl.prototype.quadraticCurveTo=function(e,t,n,r){this.commands.push({type:"Q",x1:e,y1:t,x:n,y:r})};Gl.prototype.close=Gl.prototype.closePath=function(){this.commands.push({type:"Z"})};Gl.prototype.extend=function(e){if(e.commands){e=e.commands}else if(e instanceof Nl){var t=e;this.moveTo(t.x1,t.y1);this.lineTo(t.x2,t.y1);this.lineTo(t.x2,t.y2);this.lineTo(t.x1,t.y2);this.close();return}Array.prototype.push.apply(this.commands,e)};Gl.prototype.getBoundingBox=function(){var e=this;var t=new Nl;var n=0;var r=0;var i=0;var a=0;for(var s=0;s<this.commands.length;s++){var o=e.commands[s];switch(o.type){case"M":t.addPoint(o.x,o.y);n=i=o.x;r=a=o.y;break;case"L":t.addPoint(o.x,o.y);i=o.x;a=o.y;break;case"Q":t.addQuad(i,a,o.x1,o.y1,o.x,o.y);i=o.x;a=o.y;break;case"C":t.addBezier(i,a,o.x1,o.y1,o.x2,o.y2,o.x,o.y);i=o.x;a=o.y;break;case"Z":i=n;a=r;break;default:throw new Error("Unexpected path command "+o.type)}}if(t.isEmpty()){t.addPoint(0,0)}return t};Gl.prototype.draw=function(e){var t=this;e.beginPath();for(var n=0;n<this.commands.length;n+=1){var r=t.commands[n];if(r.type==="M"){e.moveTo(r.x,r.y)}else if(r.type==="L"){e.lineTo(r.x,r.y)}else if(r.type==="C"){e.bezierCurveTo(r.x1,r.y1,r.x2,r.y2,r.x,r.y)}else if(r.type==="Q"){e.quadraticCurveTo(r.x1,r.y1,r.x,r.y)}else if(r.type==="Z"){e.closePath()}}if(this.fill){e.fillStyle=this.fill;e.fill()}if(this.stroke){e.strokeStyle=this.stroke;e.lineWidth=this.strokeWidth;e.stroke()}};Gl.prototype.toPathData=function(e){var t=this;e=e!==undefined?e:2;function n(t){if(Math.round(t)===t){return""+Math.round(t)}else{return t.toFixed(e)}}function r(){var e=arguments;var t="";for(var r=0;r<arguments.length;r+=1){var i=e[r];if(i>=0&&r>0){t+=" "}t+=n(i)}return t}var i="";for(var a=0;a<this.commands.length;a+=1){var s=t.commands[a];if(s.type==="M"){i+="M"+r(s.x,s.y)}else if(s.type==="L"){i+="L"+r(s.x,s.y)}else if(s.type==="C"){i+="C"+r(s.x1,s.y1,s.x2,s.y2,s.x,s.y)}else if(s.type==="Q"){i+="Q"+r(s.x1,s.y1,s.x,s.y)}else if(s.type==="Z"){i+="Z"}}return i};Gl.prototype.toSVG=function(e){var t='<path d="';t+=this.toPathData(e);t+='"';if(this.fill&&this.fill!=="black"){if(this.fill===null){t+=' fill="none"'}else{t+=' fill="'+this.fill+'"'}}if(this.stroke){t+=' stroke="'+this.stroke+'" stroke-width="'+this.strokeWidth+'"'}t+="/>";return t};Gl.prototype.toDOMElement=function(e){var t=this.toPathData(e);var n=document.createElementNS("http://www.w3.org/2000/svg","path");n.setAttribute("d",t);return n};function Vl(e){throw new Error(e)}function Hl(e,t){if(!e){Vl(t)}}var Wl={fail:Vl,argument:Hl,assert:Hl};var Xl=32768;var jl=2147483648;var ql={};var Yl={};var Kl={};function Zl(e){return function(){return e}}Yl.BYTE=function(e){Wl.argument(e>=0&&e<=255,"Byte value should be between 0 and 255.");return[e]};Kl.BYTE=Zl(1);Yl.CHAR=function(e){return[e.charCodeAt(0)]};Kl.CHAR=Zl(1);Yl.CHARARRAY=function(e){var t=[];for(var n=0;n<e.length;n+=1){t[n]=e.charCodeAt(n)}return t};Kl.CHARARRAY=function(e){return e.length};Yl.USHORT=function(e){return[e>>8&255,e&255]};Kl.USHORT=Zl(2);Yl.SHORT=function(e){if(e>=Xl){e=-(2*Xl-e)}return[e>>8&255,e&255]};Kl.SHORT=Zl(2);Yl.UINT24=function(e){return[e>>16&255,e>>8&255,e&255]};Kl.UINT24=Zl(3);Yl.ULONG=function(e){return[e>>24&255,e>>16&255,e>>8&255,e&255]};Kl.ULONG=Zl(4);Yl.LONG=function(e){if(e>=jl){e=-(2*jl-e)}return[e>>24&255,e>>16&255,e>>8&255,e&255]};Kl.LONG=Zl(4);Yl.FIXED=Yl.ULONG;Kl.FIXED=Kl.ULONG;Yl.FWORD=Yl.SHORT;Kl.FWORD=Kl.SHORT;Yl.UFWORD=Yl.USHORT;Kl.UFWORD=Kl.USHORT;Yl.LONGDATETIME=function(e){return[0,0,0,0,e>>24&255,e>>16&255,e>>8&255,e&255]};Kl.LONGDATETIME=Zl(8);Yl.TAG=function(e){Wl.argument(e.length===4,"Tag should be exactly 4 ASCII characters.");return[e.charCodeAt(0),e.charCodeAt(1),e.charCodeAt(2),e.charCodeAt(3)]};Kl.TAG=Zl(4);Yl.Card8=Yl.BYTE;Kl.Card8=Kl.BYTE;Yl.Card16=Yl.USHORT;Kl.Card16=Kl.USHORT;Yl.OffSize=Yl.BYTE;Kl.OffSize=Kl.BYTE;Yl.SID=Yl.USHORT;Kl.SID=Kl.USHORT;Yl.NUMBER=function(e){if(e>=-107&&e<=107){return[e+139]}else if(e>=108&&e<=1131){e=e-108;return[(e>>8)+247,e&255]}else if(e>=-1131&&e<=-108){e=-e-108;return[(e>>8)+251,e&255]}else if(e>=-32768&&e<=32767){return Yl.NUMBER16(e)}else{return Yl.NUMBER32(e)}};Kl.NUMBER=function(e){return Yl.NUMBER(e).length};Yl.NUMBER16=function(e){return[28,e>>8&255,e&255]};Kl.NUMBER16=Zl(3);Yl.NUMBER32=function(e){return[29,e>>24&255,e>>16&255,e>>8&255,e&255]};Kl.NUMBER32=Zl(5);Yl.REAL=function(e){var t=e.toString();var n=/\.(\d*?)(?:9{5,20}|0{5,20})\d{0,2}(?:e(.+)|$)/.exec(t);if(n){var r=parseFloat("1e"+((n[2]?+n[2]:0)+n[1].length));t=(Math.round(e*r)/r).toString()}var i="";for(var a=0,s=t.length;a<s;a+=1){var o=t[a];if(o==="e"){i+=t[++a]==="-"?"c":"b"}else if(o==="."){i+="a"}else if(o==="-"){i+="e"}else{i+=o}}i+=i.length&1?"f":"ff";var l=[30];for(var u=0,f=i.length;u<f;u+=2){l.push(parseInt(i.substr(u,2),16))}return l};Kl.REAL=function(e){return Yl.REAL(e).length};Yl.NAME=Yl.CHARARRAY;Kl.NAME=Kl.CHARARRAY;Yl.STRING=Yl.CHARARRAY;Kl.STRING=Kl.CHARARRAY;ql.UTF8=function(e,t,n){var r=[];var i=n;for(var a=0;a<i;a++,t+=1){r[a]=e.getUint8(t)}return String.fromCharCode.apply(null,r)};ql.UTF16=function(e,t,n){var r=[];var i=n/2;for(var a=0;a<i;a++,t+=2){r[a]=e.getUint16(t)}return String.fromCharCode.apply(null,r)};Yl.UTF16=function(e){var t=[];for(var n=0;n<e.length;n+=1){var r=e.charCodeAt(n);t[t.length]=r>>8&255;t[t.length]=r&255}return t};Kl.UTF16=function(e){return e.length*2};var Jl={"x-mac-croatian":"ÄÅÇÉÑÖÜáàâäãåçéèêëíìîïñóòôöõúùûü†°¢£§•¶ß®Š™´¨≠ŽØ∞±≤≥∆µ∂∑∏š∫ªºΩžø"+"¿¡¬√ƒ≈Ć«Č… ÀÃÕŒœĐ—“”‘’÷◊©⁄€‹›Æ»–·‚„‰ÂćÁčÈÍÎÏÌÓÔđÒÚÛÙıˆ˜¯πË˚¸Êæˇ","x-mac-cyrillic":"АБВГДЕЖЗИЙКЛМНОПРСТУФХЦЧШЩЪЫЬЭЮЯ†°Ґ£§•¶І®©™Ђђ≠Ѓѓ∞±≤≥іµґЈЄєЇїЉљЊњ"+"јЅ¬√ƒ≈∆«»… ЋћЌќѕ–—“”‘’÷„ЎўЏџ№Ёёяабвгдежзийклмнопрстуфхцчшщъыьэю","x-mac-gaelic":"ÄÅÇÉÑÖÜáàâäãåçéèêëíìîïñóòôöõúùûü†°¢£§•¶ß®©™´¨≠ÆØḂ±≤≥ḃĊċḊḋḞḟĠġṀæø"+"ṁṖṗɼƒſṠ«»… ÀÃÕŒœ–—“”‘’ṡẛÿŸṪ€‹›Ŷŷṫ·Ỳỳ⁊ÂÊÁËÈÍÎÏÌÓÔ♣ÒÚÛÙıÝýŴŵẄẅẀẁẂẃ","x-mac-greek":"Ä¹²É³ÖÜ΅àâä΄¨çéèêë£™îï•½‰ôö¦€ùûü†ΓΔΘΛΞΠß®©ΣΪ§≠°·Α±≤≥¥ΒΕΖΗΙΚΜΦΫΨΩ"+"άΝ¬ΟΡ≈Τ«»… ΥΧΆΈœ–―“”‘’÷ΉΊΌΎέήίόΏύαβψδεφγηιξκλμνοπώρστθωςχυζϊϋΐΰ­","x-mac-icelandic":"ÄÅÇÉÑÖÜáàâäãåçéèêëíìîïñóòôöõúùûüÝ°¢£§•¶ß®©™´¨≠ÆØ∞±≤≥¥µ∂∑∏π∫ªºΩæø"+"¿¡¬√ƒ≈∆«»… ÀÃÕŒœ–—“”‘’÷◊ÿŸ⁄€ÐðÞþý·‚„‰ÂÊÁËÈÍÎÏÌÓÔÒÚÛÙıˆ˜¯˘˙˚¸˝˛ˇ","x-mac-inuit":"ᐃᐄᐅᐆᐊᐋᐱᐲᐳᐴᐸᐹᑉᑎᑏᑐᑑᑕᑖᑦᑭᑮᑯᑰᑲᑳᒃᒋᒌᒍᒎᒐᒑ°ᒡᒥᒦ•¶ᒧ®©™ᒨᒪᒫᒻᓂᓃᓄᓅᓇᓈᓐᓯᓰᓱᓲᓴᓵᔅᓕᓖᓗ"+"ᓘᓚᓛᓪᔨᔩᔪᔫᔭ… ᔮᔾᕕᕖᕗ–—“”‘’ᕘᕙᕚᕝᕆᕇᕈᕉᕋᕌᕐᕿᖀᖁᖂᖃᖄᖅᖏᖐᖑᖒᖓᖔᖕᙱᙲᙳᙴᙵᙶᖖᖠᖡᖢᖣᖤᖥᖦᕼŁł","x-mac-ce":"ÄĀāÉĄÖÜáąČäčĆćéŹźĎíďĒēĖóėôöõúĚěü†°Ę£§•¶ß®©™ę¨≠ģĮįĪ≤≥īĶ∂∑łĻļĽľĹĺŅ"+"ņŃ¬√ńŇ∆«»… ňŐÕőŌ–—“”‘’÷◊ōŔŕŘ‹›řŖŗŠ‚„šŚśÁŤťÍŽžŪÓÔūŮÚůŰűŲųÝýķŻŁżĢˇ",macintosh:"ÄÅÇÉÑÖÜáàâäãåçéèêëíìîïñóòôöõúùûü†°¢£§•¶ß®©™´¨≠ÆØ∞±≤≥¥µ∂∑∏π∫ªºΩæø"+"¿¡¬√ƒ≈∆«»… ÀÃÕŒœ–—“”‘’÷◊ÿŸ⁄€‹›ﬁﬂ‡·‚„‰ÂÊÁËÈÍÎÏÌÓÔÒÚÛÙıˆ˜¯˘˙˚¸˝˛ˇ","x-mac-romanian":"ÄÅÇÉÑÖÜáàâäãåçéèêëíìîïñóòôöõúùûü†°¢£§•¶ß®©™´¨≠ĂȘ∞±≤≥¥µ∂∑∏π∫ªºΩăș"+"¿¡¬√ƒ≈∆«»… ÀÃÕŒœ–—“”‘’÷◊ÿŸ⁄€‹›Țț‡·‚„‰ÂÊÁËÈÍÎÏÌÓÔÒÚÛÙıˆ˜¯˘˙˚¸˝˛ˇ","x-mac-turkish":"ÄÅÇÉÑÖÜáàâäãåçéèêëíìîïñóòôöõúùûü†°¢£§•¶ß®©™´¨≠ÆØ∞±≤≥¥µ∂∑∏π∫ªºΩæø"+"¿¡¬√ƒ≈∆«»… ÀÃÕŒœ–—“”‘’÷◊ÿŸĞğİıŞş‡·‚„‰ÂÊÁËÈÍÎÏÌÓÔÒÚÛÙˆ˜¯˘˙˚¸˝˛ˇ"};ql.MACSTRING=function(e,t,n,r){var i=Jl[r];if(i===undefined){return undefined}var a="";for(var s=0;s<n;s++){var o=e.getUint8(t+s);if(o<=127){a+=String.fromCharCode(o)}else{a+=i[o&127]}}return a};var Ql=typeof WeakMap==="function"&&new WeakMap;var $l;var eu=function(e){if(!$l){$l={};for(var t in Jl){$l[t]=new String(t)}}var n=$l[e];if(n===undefined){return undefined}if(Ql){var r=Ql.get(n);if(r!==undefined){return r}}var i=Jl[e];if(i===undefined){return undefined}var a={};for(var s=0;s<i.length;s++){a[i.charCodeAt(s)]=s+128}if(Ql){Ql.set(n,a)}return a};Yl.MACSTRING=function(e,t){var n=eu(t);if(n===undefined){return undefined}var r=[];for(var i=0;i<e.length;i++){var a=e.charCodeAt(i);if(a>=128){a=n[a];if(a===undefined){return undefined}}r[i]=a}return r};Kl.MACSTRING=function(e,t){var n=Yl.MACSTRING(e,t);if(n!==undefined){return n.length}else{return 0}};function tu(e){return e>=-128&&e<=127}function nu(e,t,n){var r=0;var i=e.length;while(t<i&&r<64&&e[t]===0){++t;++r}n.push(128|r-1);return t}function ru(e,t,n){var r=0;var i=e.length;var a=t;while(a<i&&r<64){var s=e[a];if(!tu(s)){break}if(s===0&&a+1<i&&e[a+1]===0){break}++a;++r}n.push(r-1);for(var o=t;o<a;++o){n.push(e[o]+256&255)}return a}function iu(e,t,n){var r=0;var i=e.length;var a=t;while(a<i&&r<64){var s=e[a];if(s===0){break}if(tu(s)&&a+1<i&&tu(e[a+1])){break}++a;++r}n.push(64|r-1);for(var o=t;o<a;++o){var l=e[o];n.push(l+65536>>8&255,l+256&255)}return a}Yl.VARDELTAS=function(e){var t=0;var n=[];while(t<e.length){var r=e[t];if(r===0){t=nu(e,t,n)}else if(r>=-128&&r<=127){t=ru(e,t,n)}else{t=iu(e,t,n)}}return n};Yl.INDEX=function(e){var t=1;var n=[t];var r=[];for(var i=0;i<e.length;i+=1){var a=Yl.OBJECT(e[i]);Array.prototype.push.apply(r,a);t+=a.length;n.push(t)}if(r.length===0){return[0,0]}var s=[];var o=1+Math.floor(Math.log(t)/Math.log(2))/8|0;var l=[undefined,Yl.BYTE,Yl.USHORT,Yl.UINT24,Yl.ULONG][o];for(var u=0;u<n.length;u+=1){var f=l(n[u]);Array.prototype.push.apply(s,f)}return Array.prototype.concat(Yl.Card16(e.length),Yl.OffSize(o),s,r)};Kl.INDEX=function(e){return Yl.INDEX(e).length};Yl.DICT=function(e){var t=[];var n=Object.keys(e);var r=n.length;for(var i=0;i<r;i+=1){var a=parseInt(n[i],0);var s=e[a];t=t.concat(Yl.OPERAND(s.value,s.type));t=t.concat(Yl.OPERATOR(a))}return t};Kl.DICT=function(e){return Yl.DICT(e).length};Yl.OPERATOR=function(e){if(e<1200){return[e]}else{return[12,e-1200]}};Yl.OPERAND=function(e,t){var n=[];if(Array.isArray(t)){for(var r=0;r<t.length;r+=1){Wl.argument(e.length===t.length,"Not enough arguments given for type"+t);n=n.concat(Yl.OPERAND(e[r],t[r]))}}else{if(t==="SID"){n=n.concat(Yl.NUMBER(e))}else if(t==="offset"){n=n.concat(Yl.NUMBER32(e))}else if(t==="number"){n=n.concat(Yl.NUMBER(e))}else if(t==="real"){n=n.concat(Yl.REAL(e))}else{throw new Error("Unknown operand type "+t)}}return n};Yl.OP=Yl.BYTE;Kl.OP=Kl.BYTE;var au=typeof WeakMap==="function"&&new WeakMap;Yl.CHARSTRING=function(e){if(au){var t=au.get(e);if(t!==undefined){return t}}var n=[];var r=e.length;for(var i=0;i<r;i+=1){var a=e[i];n=n.concat(Yl[a.type](a.value))}if(au){au.set(e,n)}return n};Kl.CHARSTRING=function(e){return Yl.CHARSTRING(e).length};Yl.OBJECT=function(e){var t=Yl[e.type];Wl.argument(t!==undefined,"No encoding function for type "+e.type);return t(e.value)};Kl.OBJECT=function(e){var t=Kl[e.type];Wl.argument(t!==undefined,"No sizeOf function for type "+e.type);return t(e.value)};Yl.TABLE=function(e){var t=[];var n=e.fields.length;var r=[];var i=[];for(var a=0;a<n;a+=1){var s=e.fields[a];var o=Yl[s.type];Wl.argument(o!==undefined,"No encoding function for field type "+s.type+" ("+s.name+")");var l=e[s.name];if(l===undefined){l=s.value}var u=o(l);if(s.type==="TABLE"){i.push(t.length);t=t.concat([0,0]);r.push(u)}else{t=t.concat(u)}}for(var f=0;f<r.length;f+=1){var h=i[f];var c=t.length;Wl.argument(c<65536,"Table "+e.tableName+" too big.");t[h]=c>>8;t[h+1]=c&255;t=t.concat(r[f])}return t};Kl.TABLE=function(e){var t=0;var n=e.fields.length;for(var r=0;r<n;r+=1){var i=e.fields[r];var a=Kl[i.type];Wl.argument(a!==undefined,"No sizeOf function for field type "+i.type+" ("+i.name+")");var s=e[i.name];if(s===undefined){s=i.value}t+=a(s);if(i.type==="TABLE"){t+=2}}return t};Yl.RECORD=Yl.TABLE;Kl.RECORD=Kl.TABLE;Yl.LITERAL=function(e){return e};Kl.LITERAL=function(e){return e.length};function su(e,t,n){var r=this;for(var i=0;i<t.length;i+=1){var a=t[i];r[a.name]=a.value}this.tableName=e;this.fields=t;if(n){var s=Object.keys(n);for(var o=0;o<s.length;o+=1){var l=s[o];var u=n[l];if(r[l]!==undefined){r[l]=u}}}}su.prototype.encode=function(){return Yl.TABLE(this)};su.prototype.sizeOf=function(){return Kl.TABLE(this)};function ou(e,t,n){if(n===undefined){n=t.length}var r=new Array(t.length+1);r[0]={name:e+"Count",type:"USHORT",value:n};for(var i=0;i<t.length;i++){r[i+1]={name:e+i,type:"USHORT",value:t[i]}}return r}function lu(e,t,n){var r=t.length;var i=new Array(r+1);i[0]={name:e+"Count",type:"USHORT",value:r};for(var a=0;a<r;a++){i[a+1]={name:e+a,type:"TABLE",value:n(t[a],a)}}return i}function uu(e,t,n){var r=t.length;var i=[];i[0]={name:e+"Count",type:"USHORT",value:r};for(var a=0;a<r;a++){i=i.concat(n(t[a],a))}return i}function fu(e){if(e.format===1){su.call(this,"coverageTable",[{name:"coverageFormat",type:"USHORT",value:1}].concat(ou("glyph",e.glyphs)))}else{Wl.assert(false,"Can't create coverage table format 2 yet.")}}fu.prototype=Object.create(su.prototype);fu.prototype.constructor=fu;function hu(e){su.call(this,"scriptListTable",uu("scriptRecord",e,function(e,t){var n=e.script;var r=n.defaultLangSys;Wl.assert(!!r,"Unable to write GSUB: script "+e.tag+" has no default language system.");return[{name:"scriptTag"+t,type:"TAG",value:e.tag},{name:"script"+t,type:"TABLE",value:new su("scriptTable",[{name:"defaultLangSys",type:"TABLE",value:new su("defaultLangSys",[{name:"lookupOrder",type:"USHORT",value:0},{name:"reqFeatureIndex",type:"USHORT",value:r.reqFeatureIndex}].concat(ou("featureIndex",r.featureIndexes)))}].concat(uu("langSys",n.langSysRecords,function(e,t){var n=e.langSys;return[{name:"langSysTag"+t,type:"TAG",value:e.tag},{name:"langSys"+t,type:"TABLE",value:new su("langSys",[{name:"lookupOrder",type:"USHORT",value:0},{name:"reqFeatureIndex",type:"USHORT",value:n.reqFeatureIndex}].concat(ou("featureIndex",n.featureIndexes)))}]})))}]}))}hu.prototype=Object.create(su.prototype);hu.prototype.constructor=hu;function cu(e){su.call(this,"featureListTable",uu("featureRecord",e,function(e,t){var n=e.feature;return[{name:"featureTag"+t,type:"TAG",value:e.tag},{name:"feature"+t,type:"TABLE",value:new su("featureTable",[{name:"featureParams",type:"USHORT",value:n.featureParams}].concat(ou("lookupListIndex",n.lookupListIndexes)))}]}))}cu.prototype=Object.create(su.prototype);cu.prototype.constructor=cu;function pu(e,t){su.call(this,"lookupListTable",lu("lookup",e,function(e){var n=t[e.lookupType];Wl.assert(!!n,"Unable to write GSUB lookup type "+e.lookupType+" tables.");return new su("lookupTable",[{name:"lookupType",type:"USHORT",value:e.lookupType},{name:"lookupFlag",type:"USHORT",value:e.lookupFlag}].concat(lu("subtable",e.subtables,n)))}))}pu.prototype=Object.create(su.prototype);pu.prototype.constructor=pu;var du={Table:su,Record:su,Coverage:fu,ScriptList:hu,FeatureList:cu,LookupList:pu,ushortList:ou,tableList:lu,recordList:uu};function mu(e,t){return e.getUint8(t)}function _u(e,t){return e.getUint16(t,false)}function vu(e,t){return e.getInt16(t,false)}function gu(e,t){return e.getUint32(t,false)}function yu(e,t){var n=e.getInt16(t,false);var r=e.getUint16(t+2,false);return n+r/65535}function bu(e,t){var n="";for(var r=t;r<t+4;r+=1){n+=String.fromCharCode(e.getInt8(r))}return n}function xu(e,t,n){var r=0;for(var i=0;i<n;i+=1){r<<=8;r+=e.getUint8(t+i)}return r}function Tu(e,t,n){var r=[];for(var i=t;i<n;i+=1){r.push(e.getUint8(i))}return r}function Su(e){var t="";for(var n=0;n<e.length;n+=1){t+=String.fromCharCode(e[n])}return t}var Eu={byte:1,uShort:2,short:2,uLong:4,fixed:4,longDateTime:8,tag:4};function wu(e,t){this.data=e;this.offset=t;this.relativeOffset=0}wu.prototype.parseByte=function(){var e=this.data.getUint8(this.offset+this.relativeOffset);this.relativeOffset+=1;return e};wu.prototype.parseChar=function(){var e=this.data.getInt8(this.offset+this.relativeOffset);this.relativeOffset+=1;return e};wu.prototype.parseCard8=wu.prototype.parseByte;wu.prototype.parseUShort=function(){var e=this.data.getUint16(this.offset+this.relativeOffset);this.relativeOffset+=2;return e};wu.prototype.parseCard16=wu.prototype.parseUShort;wu.prototype.parseSID=wu.prototype.parseUShort;wu.prototype.parseOffset16=wu.prototype.parseUShort;wu.prototype.parseShort=function(){var e=this.data.getInt16(this.offset+this.relativeOffset);this.relativeOffset+=2;return e};wu.prototype.parseF2Dot14=function(){var e=this.data.getInt16(this.offset+this.relativeOffset)/16384;this.relativeOffset+=2;return e};wu.prototype.parseULong=function(){var e=gu(this.data,this.offset+this.relativeOffset);this.relativeOffset+=4;return e};wu.prototype.parseFixed=function(){var e=yu(this.data,this.offset+this.relativeOffset);this.relativeOffset+=4;return e};wu.prototype.parseString=function(e){var t=this.data;var n=this.offset+this.relativeOffset;var r="";this.relativeOffset+=e;for(var i=0;i<e;i++){r+=String.fromCharCode(t.getUint8(n+i))}return r};wu.prototype.parseTag=function(){return this.parseString(4)};wu.prototype.parseLongDateTime=function(){var e=gu(this.data,this.offset+this.relativeOffset+4);e-=2082844800;this.relativeOffset+=8;return e};wu.prototype.parseVersion=function(){var e=_u(this.data,this.offset+this.relativeOffset);var t=_u(this.data,this.offset+this.relativeOffset+2);this.relativeOffset+=4;return e+t/4096/10};wu.prototype.skip=function(e,t){if(t===undefined){t=1}this.relativeOffset+=Eu[e]*t};wu.prototype.parseOffset16List=wu.prototype.parseUShortList=function(e){if(e===undefined){e=this.parseUShort()}var t=new Array(e);var n=this.data;var r=this.offset+this.relativeOffset;for(var i=0;i<e;i++){t[i]=n.getUint16(r);r+=2}this.relativeOffset+=e*2;return t};wu.prototype.parseShortList=function(e){var t=new Array(e);var n=this.data;var r=this.offset+this.relativeOffset;for(var i=0;i<e;i++){t[i]=n.getInt16(r);r+=2}this.relativeOffset+=e*2;return t};wu.prototype.parseByteList=function(e){var t=new Array(e);var n=this.data;var r=this.offset+this.relativeOffset;for(var i=0;i<e;i++){t[i]=n.getUint8(r++)}this.relativeOffset+=e;return t};wu.prototype.parseList=function(e,t){var n=this;if(!t){t=e;e=this.parseUShort()}var r=new Array(e);for(var i=0;i<e;i++){r[i]=t.call(n)}return r};wu.prototype.parseRecordList=function(e,t){var n=this;if(!t){t=e;e=this.parseUShort()}var r=new Array(e);var i=Object.keys(t);for(var a=0;a<e;a++){var s={};for(var o=0;o<i.length;o++){var l=i[o];var u=t[l];s[l]=u.call(n)}r[a]=s}return r};wu.prototype.parseStruct=function(e){var t=this;if(typeof e==="function"){return e.call(this)}else{var n=Object.keys(e);var r={};for(var i=0;i<n.length;i++){var a=n[i];var s=e[a];r[a]=s.call(t)}return r}};wu.prototype.parsePointer=function(e){var t=this.parseOffset16();if(t>0){return new wu(this.data,this.offset+t).parseStruct(e)}return undefined};wu.prototype.parseListOfLists=function(e){var t=this;var n=this.parseOffset16List();var r=n.length;var i=this.relativeOffset;var a=new Array(r);for(var s=0;s<r;s++){var o=n[s];if(o===0){a[s]=undefined;continue}t.relativeOffset=o;if(e){var l=t.parseOffset16List();var u=new Array(l.length);for(var f=0;f<l.length;f++){t.relativeOffset=o+l[f];u[f]=e.call(t)}a[s]=u}else{a[s]=t.parseUShortList()}}this.relativeOffset=i;return a};wu.prototype.parseCoverage=function(){var e=this;var t=this.offset+this.relativeOffset;var n=this.parseUShort();var r=this.parseUShort();if(n===1){return{format:1,glyphs:this.parseUShortList(r)}}else if(n===2){var i=new Array(r);for(var a=0;a<r;a++){i[a]={start:e.parseUShort(),end:e.parseUShort(),index:e.parseUShort()}}return{format:2,ranges:i}}throw new Error("0x"+t.toString(16)+": Coverage format must be 1 or 2.")};wu.prototype.parseClassDef=function(){var e=this.offset+this.relativeOffset;var t=this.parseUShort();if(t===1){return{format:1,startGlyph:this.parseUShort(),classes:this.parseUShortList()}}else if(t===2){return{format:2,ranges:this.parseRecordList({start:wu.uShort,end:wu.uShort,classId:wu.uShort})}}throw new Error("0x"+e.toString(16)+": ClassDef format must be 1 or 2.")};wu.list=function(e,t){return function(){return this.parseList(e,t)}};wu.recordList=function(e,t){return function(){return this.parseRecordList(e,t)}};wu.pointer=function(e){return function(){return this.parsePointer(e)}};wu.tag=wu.prototype.parseTag;wu.byte=wu.prototype.parseByte;wu.uShort=wu.offset16=wu.prototype.parseUShort;wu.uShortList=wu.prototype.parseUShortList;wu.struct=wu.prototype.parseStruct;wu.coverage=wu.prototype.parseCoverage;wu.classDef=wu.prototype.parseClassDef;var Mu={reserved:wu.uShort,reqFeatureIndex:wu.uShort,featureIndexes:wu.uShortList};wu.prototype.parseScriptList=function(){return this.parsePointer(wu.recordList({tag:wu.tag,script:wu.pointer({defaultLangSys:wu.pointer(Mu),langSysRecords:wu.recordList({tag:wu.tag,langSys:wu.pointer(Mu)})})}))};wu.prototype.parseFeatureList=function(){return this.parsePointer(wu.recordList({tag:wu.tag,feature:wu.pointer({featureParams:wu.offset16,lookupListIndexes:wu.uShortList})}))};wu.prototype.parseLookupList=function(e){return this.parsePointer(wu.list(wu.pointer(function(){var t=this.parseUShort();Wl.argument(1<=t&&t<=8,"GSUB lookup type "+t+" unknown.");var n=this.parseUShort();var r=n&16;return{lookupType:t,lookupFlag:n,subtables:this.parseList(wu.pointer(e[t])),markFilteringSet:r?this.parseUShort():undefined}})))};var Au={getByte:mu,getCard8:mu,getUShort:_u,getCard16:_u,getShort:vu,getULong:gu,getFixed:yu,getTag:bu,getOffset:xu,getBytes:Tu,bytesToString:Su,Parser:wu};function Ru(e,t){t.parseUShort();e.length=t.parseULong();e.language=t.parseULong();var n;e.groupCount=n=t.parseULong();e.glyphIndexMap={};for(var r=0;r<n;r+=1){var i=t.parseULong();var a=t.parseULong();var s=t.parseULong();for(var o=i;o<=a;o+=1){e.glyphIndexMap[o]=s;s++}}}function Uu(e,t,n,r,i){e.length=t.parseUShort();e.language=t.parseUShort();var a;e.segCount=a=t.parseUShort()>>1;t.skip("uShort",3);e.glyphIndexMap={};var s=new Au.Parser(n,r+i+14);var o=new Au.Parser(n,r+i+16+a*2);var l=new Au.Parser(n,r+i+16+a*4);var u=new Au.Parser(n,r+i+16+a*6);var f=r+i+16+a*8;for(var h=0;h<a-1;h+=1){var c=void 0;var p=s.parseUShort();var d=o.parseUShort();var m=l.parseShort();var _=u.parseUShort();for(var v=d;v<=p;v+=1){if(_!==0){f=u.offset+u.relativeOffset-2;f+=_;f+=(v-d)*2;c=Au.getUShort(n,f);if(c!==0){c=c+m&65535}}else{c=v+m&65535}e.glyphIndexMap[v]=c}}}function Du(e,t){var n={};n.version=Au.getUShort(e,t);Wl.argument(n.version===0,"cmap table version should be 0.");n.numTables=Au.getUShort(e,t+2);var r=-1;for(var i=n.numTables-1;i>=0;i-=1){var a=Au.getUShort(e,t+4+i*8);var s=Au.getUShort(e,t+4+i*8+2);if(a===3&&(s===0||s===1||s===10)){r=Au.getULong(e,t+4+i*8+4);break}}if(r===-1){throw new Error("No valid cmap sub-tables found.")}var o=new Au.Parser(e,t+r);n.format=o.parseUShort();if(n.format===12){Ru(n,o)}else if(n.format===4){Uu(n,o,e,t,r)}else{throw new Error("Only format 4 and 12 cmap tables are supported (found format "+n.format+").")}return n}function Lu(e,t,n){e.segments.push({end:t,start:t,delta:-(t-n),offset:0})}function Ou(e){e.segments.push({end:65535,start:65535,delta:1,offset:0})}function Iu(e){var t=new du.Table("cmap",[{name:"version",type:"USHORT",value:0},{name:"numTables",type:"USHORT",value:1},{name:"platformID",type:"USHORT",value:3},{name:"encodingID",type:"USHORT",value:1},{name:"offset",type:"ULONG",value:12},{name:"format",type:"USHORT",value:4},{name:"length",type:"USHORT",value:0},{name:"language",type:"USHORT",value:0},{name:"segCountX2",type:"USHORT",value:0},{name:"searchRange",type:"USHORT",value:0},{name:"entrySelector",type:"USHORT",value:0},{name:"rangeShift",type:"USHORT",value:0}]);t.segments=[];for(var n=0;n<e.length;n+=1){var r=e.get(n);for(var i=0;i<r.unicodes.length;i+=1){Lu(t,r.unicodes[i],n)}t.segments=t.segments.sort(function(e,t){return e.start-t.start})}Ou(t);var a;a=t.segments.length;t.segCountX2=a*2;t.searchRange=Math.pow(2,Math.floor(Math.log(a)/Math.log(2)))*2;t.entrySelector=Math.log(t.searchRange/2)/Math.log(2);t.rangeShift=t.segCountX2-t.searchRange;var s=[];var o=[];var l=[];var u=[];var f=[];for(var h=0;h<a;h+=1){var c=t.segments[h];s=s.concat({name:"end_"+h,type:"USHORT",value:c.end});o=o.concat({name:"start_"+h,type:"USHORT",value:c.start});l=l.concat({name:"idDelta_"+h,type:"SHORT",value:c.delta});u=u.concat({name:"idRangeOffset_"+h,type:"USHORT",value:c.offset});if(c.glyphId!==undefined){f=f.concat({name:"glyph_"+h,type:"USHORT",value:c.glyphId})}}t.fields=t.fields.concat(s);t.fields.push({name:"reservedPad",type:"USHORT",value:0});t.fields=t.fields.concat(o);t.fields=t.fields.concat(l);t.fields=t.fields.concat(u);t.fields=t.fields.concat(f);t.length=14+s.length*2+2+o.length*2+l.length*2+u.length*2+f.length*2;return t}var Cu={parse:Du,make:Iu};var Pu=[".notdef","space","exclam","quotedbl","numbersign","dollar","percent","ampersand","quoteright","parenleft","parenright","asterisk","plus","comma","hyphen","period","slash","zero","one","two","three","four","five","six","seven","eight","nine","colon","semicolon","less","equal","greater","question","at","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","bracketleft","backslash","bracketright","asciicircum","underscore","quoteleft","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","braceleft","bar","braceright","asciitilde","exclamdown","cent","sterling","fraction","yen","florin","section","currency","quotesingle","quotedblleft","guillemotleft","guilsinglleft","guilsinglright","fi","fl","endash","dagger","daggerdbl","periodcentered","paragraph","bullet","quotesinglbase","quotedblbase","quotedblright","guillemotright","ellipsis","perthousand","questiondown","grave","acute","circumflex","tilde","macron","breve","dotaccent","dieresis","ring","cedilla","hungarumlaut","ogonek","caron","emdash","AE","ordfeminine","Lslash","Oslash","OE","ordmasculine","ae","dotlessi","lslash","oslash","oe","germandbls","onesuperior","logicalnot","mu","trademark","Eth","onehalf","plusminus","Thorn","onequarter","divide","brokenbar","degree","thorn","threequarters","twosuperior","registered","minus","eth","multiply","threesuperior","copyright","Aacute","Acircumflex","Adieresis","Agrave","Aring","Atilde","Ccedilla","Eacute","Ecircumflex","Edieresis","Egrave","Iacute","Icircumflex","Idieresis","Igrave","Ntilde","Oacute","Ocircumflex","Odieresis","Ograve","Otilde","Scaron","Uacute","Ucircumflex","Udieresis","Ugrave","Yacute","Ydieresis","Zcaron","aacute","acircumflex","adieresis","agrave","aring","atilde","ccedilla","eacute","ecircumflex","edieresis","egrave","iacute","icircumflex","idieresis","igrave","ntilde","oacute","ocircumflex","odieresis","ograve","otilde","scaron","uacute","ucircumflex","udieresis","ugrave","yacute","ydieresis","zcaron","exclamsmall","Hungarumlautsmall","dollaroldstyle","dollarsuperior","ampersandsmall","Acutesmall","parenleftsuperior","parenrightsuperior","266 ff","onedotenleader","zerooldstyle","oneoldstyle","twooldstyle","threeoldstyle","fouroldstyle","fiveoldstyle","sixoldstyle","sevenoldstyle","eightoldstyle","nineoldstyle","commasuperior","threequartersemdash","periodsuperior","questionsmall","asuperior","bsuperior","centsuperior","dsuperior","esuperior","isuperior","lsuperior","msuperior","nsuperior","osuperior","rsuperior","ssuperior","tsuperior","ff","ffi","ffl","parenleftinferior","parenrightinferior","Circumflexsmall","hyphensuperior","Gravesmall","Asmall","Bsmall","Csmall","Dsmall","Esmall","Fsmall","Gsmall","Hsmall","Ismall","Jsmall","Ksmall","Lsmall","Msmall","Nsmall","Osmall","Psmall","Qsmall","Rsmall","Ssmall","Tsmall","Usmall","Vsmall","Wsmall","Xsmall","Ysmall","Zsmall","colonmonetary","onefitted","rupiah","Tildesmall","exclamdownsmall","centoldstyle","Lslashsmall","Scaronsmall","Zcaronsmall","Dieresissmall","Brevesmall","Caronsmall","Dotaccentsmall","Macronsmall","figuredash","hypheninferior","Ogoneksmall","Ringsmall","Cedillasmall","questiondownsmall","oneeighth","threeeighths","fiveeighths","seveneighths","onethird","twothirds","zerosuperior","foursuperior","fivesuperior","sixsuperior","sevensuperior","eightsuperior","ninesuperior","zeroinferior","oneinferior","twoinferior","threeinferior","fourinferior","fiveinferior","sixinferior","seveninferior","eightinferior","nineinferior","centinferior","dollarinferior","periodinferior","commainferior","Agravesmall","Aacutesmall","Acircumflexsmall","Atildesmall","Adieresissmall","Aringsmall","AEsmall","Ccedillasmall","Egravesmall","Eacutesmall","Ecircumflexsmall","Edieresissmall","Igravesmall","Iacutesmall","Icircumflexsmall","Idieresissmall","Ethsmall","Ntildesmall","Ogravesmall","Oacutesmall","Ocircumflexsmall","Otildesmall","Odieresissmall","OEsmall","Oslashsmall","Ugravesmall","Uacutesmall","Ucircumflexsmall","Udieresissmall","Yacutesmall","Thornsmall","Ydieresissmall","001.000","001.001","001.002","001.003","Black","Bold","Book","Light","Medium","Regular","Roman","Semibold"];var Bu=["","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","space","exclam","quotedbl","numbersign","dollar","percent","ampersand","quoteright","parenleft","parenright","asterisk","plus","comma","hyphen","period","slash","zero","one","two","three","four","five","six","seven","eight","nine","colon","semicolon","less","equal","greater","question","at","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","bracketleft","backslash","bracketright","asciicircum","underscore","quoteleft","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","braceleft","bar","braceright","asciitilde","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","exclamdown","cent","sterling","fraction","yen","florin","section","currency","quotesingle","quotedblleft","guillemotleft","guilsinglleft","guilsinglright","fi","fl","","endash","dagger","daggerdbl","periodcentered","","paragraph","bullet","quotesinglbase","quotedblbase","quotedblright","guillemotright","ellipsis","perthousand","","questiondown","","grave","acute","circumflex","tilde","macron","breve","dotaccent","dieresis","","ring","cedilla","","hungarumlaut","ogonek","caron","emdash","","","","","","","","","","","","","","","","","AE","","ordfeminine","","","","","Lslash","Oslash","OE","ordmasculine","","","","","","ae","","","","dotlessi","","","lslash","oslash","oe","germandbls"];var Fu=["","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","space","exclamsmall","Hungarumlautsmall","","dollaroldstyle","dollarsuperior","ampersandsmall","Acutesmall","parenleftsuperior","parenrightsuperior","twodotenleader","onedotenleader","comma","hyphen","period","fraction","zerooldstyle","oneoldstyle","twooldstyle","threeoldstyle","fouroldstyle","fiveoldstyle","sixoldstyle","sevenoldstyle","eightoldstyle","nineoldstyle","colon","semicolon","commasuperior","threequartersemdash","periodsuperior","questionsmall","","asuperior","bsuperior","centsuperior","dsuperior","esuperior","","","isuperior","","","lsuperior","msuperior","nsuperior","osuperior","","","rsuperior","ssuperior","tsuperior","","ff","fi","fl","ffi","ffl","parenleftinferior","","parenrightinferior","Circumflexsmall","hyphensuperior","Gravesmall","Asmall","Bsmall","Csmall","Dsmall","Esmall","Fsmall","Gsmall","Hsmall","Ismall","Jsmall","Ksmall","Lsmall","Msmall","Nsmall","Osmall","Psmall","Qsmall","Rsmall","Ssmall","Tsmall","Usmall","Vsmall","Wsmall","Xsmall","Ysmall","Zsmall","colonmonetary","onefitted","rupiah","Tildesmall","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","exclamdownsmall","centoldstyle","Lslashsmall","","","Scaronsmall","Zcaronsmall","Dieresissmall","Brevesmall","Caronsmall","","Dotaccentsmall","","","Macronsmall","","","figuredash","hypheninferior","","","Ogoneksmall","Ringsmall","Cedillasmall","","","","onequarter","onehalf","threequarters","questiondownsmall","oneeighth","threeeighths","fiveeighths","seveneighths","onethird","twothirds","","","zerosuperior","onesuperior","twosuperior","threesuperior","foursuperior","fivesuperior","sixsuperior","sevensuperior","eightsuperior","ninesuperior","zeroinferior","oneinferior","twoinferior","threeinferior","fourinferior","fiveinferior","sixinferior","seveninferior","eightinferior","nineinferior","centinferior","dollarinferior","periodinferior","commainferior","Agravesmall","Aacutesmall","Acircumflexsmall","Atildesmall","Adieresissmall","Aringsmall","AEsmall","Ccedillasmall","Egravesmall","Eacutesmall","Ecircumflexsmall","Edieresissmall","Igravesmall","Iacutesmall","Icircumflexsmall","Idieresissmall","Ethsmall","Ntildesmall","Ogravesmall","Oacutesmall","Ocircumflexsmall","Otildesmall","Odieresissmall","OEsmall","Oslashsmall","Ugravesmall","Uacutesmall","Ucircumflexsmall","Udieresissmall","Yacutesmall","Thornsmall","Ydieresissmall"];var zu=[".notdef",".null","nonmarkingreturn","space","exclam","quotedbl","numbersign","dollar","percent","ampersand","quotesingle","parenleft","parenright","asterisk","plus","comma","hyphen","period","slash","zero","one","two","three","four","five","six","seven","eight","nine","colon","semicolon","less","equal","greater","question","at","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","bracketleft","backslash","bracketright","asciicircum","underscore","grave","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","braceleft","bar","braceright","asciitilde","Adieresis","Aring","Ccedilla","Eacute","Ntilde","Odieresis","Udieresis","aacute","agrave","acircumflex","adieresis","atilde","aring","ccedilla","eacute","egrave","ecircumflex","edieresis","iacute","igrave","icircumflex","idieresis","ntilde","oacute","ograve","ocircumflex","odieresis","otilde","uacute","ugrave","ucircumflex","udieresis","dagger","degree","cent","sterling","section","bullet","paragraph","germandbls","registered","copyright","trademark","acute","dieresis","notequal","AE","Oslash","infinity","plusminus","lessequal","greaterequal","yen","mu","partialdiff","summation","product","pi","integral","ordfeminine","ordmasculine","Omega","ae","oslash","questiondown","exclamdown","logicalnot","radical","florin","approxequal","Delta","guillemotleft","guillemotright","ellipsis","nonbreakingspace","Agrave","Atilde","Otilde","OE","oe","endash","emdash","quotedblleft","quotedblright","quoteleft","quoteright","divide","lozenge","ydieresis","Ydieresis","fraction","currency","guilsinglleft","guilsinglright","fi","fl","daggerdbl","periodcentered","quotesinglbase","quotedblbase","perthousand","Acircumflex","Ecircumflex","Aacute","Edieresis","Egrave","Iacute","Icircumflex","Idieresis","Igrave","Oacute","Ocircumflex","apple","Ograve","Uacute","Ucircumflex","Ugrave","dotlessi","circumflex","tilde","macron","breve","dotaccent","ring","cedilla","hungarumlaut","ogonek","caron","Lslash","lslash","Scaron","scaron","Zcaron","zcaron","brokenbar","Eth","eth","Yacute","yacute","Thorn","thorn","minus","multiply","onesuperior","twosuperior","threesuperior","onehalf","onequarter","threequarters","franc","Gbreve","gbreve","Idotaccent","Scedilla","scedilla","Cacute","cacute","Ccaron","ccaron","dcroat"];function ku(e){this.font=e}ku.prototype.charToGlyphIndex=function(e){var t=e.charCodeAt(0);var n=this.font.glyphs;if(n){for(var r=0;r<n.length;r+=1){var i=n.get(r);for(var a=0;a<i.unicodes.length;a+=1){if(i.unicodes[a]===t){return r}}}}return null};function Nu(e){this.cmap=e}Nu.prototype.charToGlyphIndex=function(e){return this.cmap.glyphIndexMap[e.charCodeAt(0)]||0};function Gu(e,t){this.encoding=e;this.charset=t}Gu.prototype.charToGlyphIndex=function(e){var t=e.charCodeAt(0);var n=this.encoding[t];return this.charset.indexOf(n)};function Vu(e){var t=this;switch(e.version){case 1:this.names=zu.slice();break;case 2:this.names=new Array(e.numberOfGlyphs);for(var n=0;n<e.numberOfGlyphs;n++){if(e.glyphNameIndex[n]<zu.length){t.names[n]=zu[e.glyphNameIndex[n]]}else{t.names[n]=e.names[e.glyphNameIndex[n]-zu.length]}}break;case 2.5:this.names=new Array(e.numberOfGlyphs);for(var r=0;r<e.numberOfGlyphs;r++){t.names[r]=zu[r+e.glyphNameIndex[r]]}break;case 3:this.names=[];break;default:this.names=[];break}}Vu.prototype.nameToGlyphIndex=function(e){return this.names.indexOf(e)};Vu.prototype.glyphIndexToName=function(e){return this.names[e]};function Hu(e){var t;var n=e.tables.cmap.glyphIndexMap;var r=Object.keys(n);for(var i=0;i<r.length;i+=1){var a=r[i];var s=n[a];t=e.glyphs.get(s);t.addUnicode(parseInt(a))}for(var o=0;o<e.glyphs.length;o+=1){t=e.glyphs.get(o);if(e.cffEncoding){if(e.isCIDFont){t.name="gid"+o}else{t.name=e.cffEncoding.charset[o]}}else if(e.glyphNames.names){t.name=e.glyphNames.glyphIndexToName(o)}}}function Wu(e,t,n,r,i){e.beginPath();e.moveTo(t,n);e.lineTo(r,i);e.stroke()}var Xu={line:Wu};function ju(e,t,n,r,i){var a;if((t&r)>0){a=e.parseByte();if((t&i)===0){a=-a}a=n+a}else{if((t&i)>0){a=n}else{a=n+e.parseShort()}}return a}function qu(e,t,n){var r=new Au.Parser(t,n);e.numberOfContours=r.parseShort();e._xMin=r.parseShort();e._yMin=r.parseShort();e._xMax=r.parseShort();e._yMax=r.parseShort();var i;var a;if(e.numberOfContours>0){var s=e.endPointIndices=[];for(var o=0;o<e.numberOfContours;o+=1){s.push(r.parseUShort())}e.instructionLength=r.parseUShort();e.instructions=[];for(var l=0;l<e.instructionLength;l+=1){e.instructions.push(r.parseByte())}var u=s[s.length-1]+1;i=[];for(var f=0;f<u;f+=1){a=r.parseByte();i.push(a);if((a&8)>0){var h=r.parseByte();for(var c=0;c<h;c+=1){i.push(a);f+=1}}}Wl.argument(i.length===u,"Bad flags.");if(s.length>0){var p=[];var d;if(u>0){for(var m=0;m<u;m+=1){a=i[m];d={};d.onCurve=!!(a&1);d.lastPointOfContour=s.indexOf(m)>=0;p.push(d)}var _=0;for(var v=0;v<u;v+=1){a=i[v];d=p[v];d.x=ju(r,a,_,2,16);_=d.x}var g=0;for(var y=0;y<u;y+=1){a=i[y];d=p[y];d.y=ju(r,a,g,4,32);g=d.y}}e.points=p}else{e.points=[]}}else if(e.numberOfContours===0){e.points=[]}else{e.isComposite=true;e.points=[];e.components=[];var b=true;while(b){i=r.parseUShort();var x={glyphIndex:r.parseUShort(),xScale:1,scale01:0,scale10:0,yScale:1,dx:0,dy:0};if((i&1)>0){if((i&2)>0){x.dx=r.parseShort();x.dy=r.parseShort()}else{x.matchedPoints=[r.parseUShort(),r.parseUShort()]}}else{if((i&2)>0){x.dx=r.parseChar();x.dy=r.parseChar()}else{x.matchedPoints=[r.parseByte(),r.parseByte()]}}if((i&8)>0){x.xScale=x.yScale=r.parseF2Dot14()}else if((i&64)>0){x.xScale=r.parseF2Dot14();x.yScale=r.parseF2Dot14()}else if((i&128)>0){x.xScale=r.parseF2Dot14();x.scale01=r.parseF2Dot14();x.scale10=r.parseF2Dot14();x.yScale=r.parseF2Dot14()}e.components.push(x);b=!!(i&32)}if(i&256){e.instructionLength=r.parseUShort();e.instructions=[];for(var T=0;T<e.instructionLength;T+=1){e.instructions.push(r.parseByte())}}}}function Yu(e,t){var n=[];for(var r=0;r<e.length;r+=1){var i=e[r];var a={x:t.xScale*i.x+t.scale01*i.y+t.dx,y:t.scale10*i.x+t.yScale*i.y+t.dy,onCurve:i.onCurve,lastPointOfContour:i.lastPointOfContour};n.push(a)}return n}function Ku(e){var t=[];var n=[];for(var r=0;r<e.length;r+=1){var i=e[r];n.push(i);if(i.lastPointOfContour){t.push(n);n=[]}}Wl.argument(n.length===0,"There are still points left in the current contour.");return t}function Zu(e){var t=new Gl;if(!e){return t}var n=Ku(e);for(var r=0;r<n.length;++r){var i=n[r];var a=null;var s=i[i.length-1];var o=i[0];if(s.onCurve){t.moveTo(s.x,s.y)}else{if(o.onCurve){t.moveTo(o.x,o.y)}else{var l={x:(s.x+o.x)*.5,y:(s.y+o.y)*.5};t.moveTo(l.x,l.y)}}for(var u=0;u<i.length;++u){a=s;s=o;o=i[(u+1)%i.length];if(s.onCurve){t.lineTo(s.x,s.y)}else{var f=a;var h=o;if(!a.onCurve){f={x:(s.x+a.x)*.5,y:(s.y+a.y)*.5};t.lineTo(f.x,f.y)}if(!o.onCurve){h={x:(s.x+o.x)*.5,y:(s.y+o.y)*.5}}t.lineTo(f.x,f.y);t.quadraticCurveTo(s.x,s.y,h.x,h.y)}}t.closePath()}return t}function Ju(e,t){if(t.isComposite){for(var n=0;n<t.components.length;n+=1){var r=t.components[n];var i=e.get(r.glyphIndex);i.getPath();if(i.points){var a=void 0;if(r.matchedPoints===undefined){a=Yu(i.points,r)}else{if(r.matchedPoints[0]>t.points.length-1||r.matchedPoints[1]>i.points.length-1){throw Error("Matched points out of range in "+t.name)}var s=t.points[r.matchedPoints[0]];var o=i.points[r.matchedPoints[1]];var l={xScale:r.xScale,scale01:r.scale01,scale10:r.scale10,yScale:r.yScale,dx:0,dy:0};o=Yu([o],l)[0];l.dx=s.x-o.x;l.dy=s.y-o.y;a=Yu(i.points,l)}t.points=t.points.concat(a)}}}return Zu(t.points)}function Qu(e,t,n,r){var i=new lf.GlyphSet(r);for(var a=0;a<n.length-1;a+=1){var s=n[a];var o=n[a+1];if(s!==o){i.push(a,lf.ttfGlyphLoader(r,a,qu,e,t+s,Ju))}else{i.push(a,lf.glyphLoader(r,a))}}return i}var $u={getPath:Zu,parse:Qu};function ef(e,t){var n=t||{commands:[]};return{configurable:true,get:function(){if(typeof n==="function"){n=n()}return n},set:function(e){n=e}}}function tf(e){this.bindConstructorValues(e)}tf.prototype.bindConstructorValues=function(e){this.index=e.index||0;this.name=e.name||null;this.unicode=e.unicode||undefined;this.unicodes=e.unicodes||e.unicode!==undefined?[e.unicode]:[];if(e.xMin){this.xMin=e.xMin}if(e.yMin){this.yMin=e.yMin}if(e.xMax){this.xMax=e.xMax}if(e.yMax){this.yMax=e.yMax}if(e.advanceWidth){this.advanceWidth=e.advanceWidth}Object.defineProperty(this,"path",ef(this,e.path))};tf.prototype.addUnicode=function(e){if(this.unicodes.length===0){this.unicode=e}this.unicodes.push(e)};tf.prototype.getBoundingBox=function(){return this.path.getBoundingBox()};tf.prototype.getPath=function(e,t,n,r,i){e=e!==undefined?e:0;t=t!==undefined?t:0;n=n!==undefined?n:72;var a;var s;if(!r){r={}}var o=r.xScale;var l=r.yScale;if(r.hinting&&i&&i.hinting){s=this.path&&i.hinting.exec(this,n)}if(s){a=$u.getPath(s).commands;e=Math.round(e);t=Math.round(t);o=l=1}else{a=this.path.commands;var u=1/this.path.unitsPerEm*n;if(o===undefined){o=u}if(l===undefined){l=u}}var f=new Gl;for(var h=0;h<a.length;h+=1){var c=a[h];if(c.type==="M"){f.moveTo(e+c.x*o,t+-c.y*l)}else if(c.type==="L"){f.lineTo(e+c.x*o,t+-c.y*l)}else if(c.type==="Q"){f.quadraticCurveTo(e+c.x1*o,t+-c.y1*l,e+c.x*o,t+-c.y*l)}else if(c.type==="C"){f.curveTo(e+c.x1*o,t+-c.y1*l,e+c.x2*o,t+-c.y2*l,e+c.x*o,t+-c.y*l)}else if(c.type==="Z"){f.closePath()}}return f};tf.prototype.getContours=function(){var e=this;if(this.points===undefined){return[]}var t=[];var n=[];for(var r=0;r<this.points.length;r+=1){var i=e.points[r];n.push(i);if(i.lastPointOfContour){t.push(n);n=[]}}Wl.argument(n.length===0,"There are still points left in the current contour.");return t};tf.prototype.getMetrics=function(){var e=this.path.commands;var t=[];var n=[];for(var r=0;r<e.length;r+=1){var i=e[r];if(i.type!=="Z"){t.push(i.x);n.push(i.y)}if(i.type==="Q"||i.type==="C"){t.push(i.x1);n.push(i.y1)}if(i.type==="C"){t.push(i.x2);n.push(i.y2)}}var a={xMin:Math.min.apply(null,t),yMin:Math.min.apply(null,n),xMax:Math.max.apply(null,t),yMax:Math.max.apply(null,n),leftSideBearing:this.leftSideBearing};if(!isFinite(a.xMin)){a.xMin=0}if(!isFinite(a.xMax)){a.xMax=this.advanceWidth}if(!isFinite(a.yMin)){a.yMin=0}if(!isFinite(a.yMax)){a.yMax=0}a.rightSideBearing=this.advanceWidth-a.leftSideBearing-(a.xMax-a.xMin);return a};tf.prototype.draw=function(e,t,n,r,i){this.getPath(t,n,r,i).draw(e)};tf.prototype.drawPoints=function(e,t,n,r){function i(t,n,r,i){var a=Math.PI*2;e.beginPath();for(var s=0;s<t.length;s+=1){e.moveTo(n+t[s].x*i,r+t[s].y*i);e.arc(n+t[s].x*i,r+t[s].y*i,2,0,a,false)}e.closePath();e.fill()}t=t!==undefined?t:0;n=n!==undefined?n:0;r=r!==undefined?r:24;var a=1/this.path.unitsPerEm*r;var s=[];var o=[];var l=this.path;for(var u=0;u<l.commands.length;u+=1){var f=l.commands[u];if(f.x!==undefined){s.push({x:f.x,y:-f.y})}if(f.x1!==undefined){o.push({x:f.x1,y:-f.y1})}if(f.x2!==undefined){o.push({x:f.x2,y:-f.y2})}}e.fillStyle="blue";i(s,t,n,a);e.fillStyle="red";i(o,t,n,a)};tf.prototype.drawMetrics=function(e,t,n,r){var i;t=t!==undefined?t:0;n=n!==undefined?n:0;r=r!==undefined?r:24;i=1/this.path.unitsPerEm*r;e.lineWidth=1;e.strokeStyle="black";Xu.line(e,t,-1e4,t,1e4);Xu.line(e,-1e4,n,1e4,n);var a=this.xMin||0;var s=this.yMin||0;var o=this.xMax||0;var l=this.yMax||0;var u=this.advanceWidth||0;e.strokeStyle="blue";Xu.line(e,t+a*i,-1e4,t+a*i,1e4);Xu.line(e,t+o*i,-1e4,t+o*i,1e4);Xu.line(e,-1e4,n+-s*i,1e4,n+-s*i);Xu.line(e,-1e4,n+-l*i,1e4,n+-l*i);e.strokeStyle="green";Xu.line(e,t+u*i,-1e4,t+u*i,1e4)};function nf(e,t,n){Object.defineProperty(e,t,{get:function(){e.path;return e[n]},set:function(t){e[n]=t},enumerable:true,configurable:true})}function rf(e,t){var n=this;this.font=e;this.glyphs={};if(Array.isArray(t)){for(var r=0;r<t.length;r++){n.glyphs[r]=t[r]}}this.length=t&&t.length||0}rf.prototype.get=function(e){if(typeof this.glyphs[e]==="function"){this.glyphs[e]=this.glyphs[e]()}return this.glyphs[e]};rf.prototype.push=function(e,t){this.glyphs[e]=t;this.length++};function af(e,t){return new tf({index:t,font:e})}function sf(e,t,n,r,i,a){return function(){var s=new tf({index:t,font:e});s.path=function(){n(s,r,i);var t=a(e.glyphs,s);t.unitsPerEm=e.unitsPerEm;return t};nf(s,"xMin","_xMin");nf(s,"xMax","_xMax");nf(s,"yMin","_yMin");nf(s,"yMax","_yMax");return s}}function of(e,t,n,r){return function(){var i=new tf({index:t,font:e});i.path=function(){var t=n(e,i,r);t.unitsPerEm=e.unitsPerEm;return t};return i}}var lf={GlyphSet:rf,glyphLoader:af,ttfGlyphLoader:sf,cffGlyphLoader:of};function uf(e,t){if(e===t){return true}else if(Array.isArray(e)&&Array.isArray(t)){if(e.length!==t.length){return false}for(var n=0;n<e.length;n+=1){if(!uf(e[n],t[n])){return false}}return true}else{return false}}function ff(e){var t;if(e.length<1240){t=107}else if(e.length<33900){t=1131}else{t=32768}return t}function hf(e,t,n){var r=[];var i=[];var a=Au.getCard16(e,t);var s;var o;if(a!==0){var l=Au.getByte(e,t+2);s=t+(a+1)*l+2;var u=t+3;for(var f=0;f<a+1;f+=1){r.push(Au.getOffset(e,u,l));u+=l}o=s+r[a]}else{o=t+2}for(var h=0;h<r.length-1;h+=1){var c=Au.getBytes(e,s+r[h],s+r[h+1]);if(n){c=n(c)}i.push(c)}return{objects:i,startOffset:t,endOffset:o}}function cf(e){var t="";var n=15;var r=["0","1","2","3","4","5","6","7","8","9",".","E","E-",null,"-"];while(true){var i=e.parseByte();var a=i>>4;var s=i&15;if(a===n){break}t+=r[a];if(s===n){break}t+=r[s]}return parseFloat(t)}function pf(e,t){var n;var r;var i;var a;if(t===28){n=e.parseByte();r=e.parseByte();return n<<8|r}if(t===29){n=e.parseByte();r=e.parseByte();i=e.parseByte();a=e.parseByte();return n<<24|r<<16|i<<8|a}if(t===30){return cf(e)}if(t>=32&&t<=246){return t-139}if(t>=247&&t<=250){n=e.parseByte();return(t-247)*256+n+108}if(t>=251&&t<=254){n=e.parseByte();return-(t-251)*256-n-108}throw new Error("Invalid b0 "+t)}function df(e){var t={};for(var n=0;n<e.length;n+=1){var r=e[n][0];var i=e[n][1];var a=void 0;if(i.length===1){a=i[0]}else{a=i}if(t.hasOwnProperty(r)&&!isNaN(t[r])){throw new Error("Object "+t+" already has key "+r)}t[r]=a}return t}function mf(e,t,n){t=t!==undefined?t:0;var r=new Au.Parser(e,t);var i=[];var a=[];n=n!==undefined?n:e.length;while(r.relativeOffset<n){var s=r.parseByte();if(s<=21){if(s===12){s=1200+r.parseByte()}i.push([s,a]);a=[]}else{a.push(pf(r,s))}}return df(i)}function _f(e,t){if(t<=390){t=Pu[t]}else{t=e[t-391]}return t}function vf(e,t,n){var r={};var i;for(var a=0;a<t.length;a+=1){var s=t[a];if(Array.isArray(s.type)){var o=[];o.length=s.type.length;for(var l=0;l<s.type.length;l++){i=e[s.op]!==undefined?e[s.op][l]:undefined;if(i===undefined){i=s.value!==undefined&&s.value[l]!==undefined?s.value[l]:null}if(s.type[l]==="SID"){i=_f(n,i)}o[l]=i}r[s.name]=o}else{i=e[s.op];if(i===undefined){i=s.value!==undefined?s.value:null}if(s.type==="SID"){i=_f(n,i)}r[s.name]=i}}return r}function gf(e,t){var n={};n.formatMajor=Au.getCard8(e,t);n.formatMinor=Au.getCard8(e,t+1);n.size=Au.getCard8(e,t+2);n.offsetSize=Au.getCard8(e,t+3);n.startOffset=t;n.endOffset=t+4;return n}var yf=[{name:"version",op:0,type:"SID"},{name:"notice",op:1,type:"SID"},{name:"copyright",op:1200,type:"SID"},{name:"fullName",op:2,type:"SID"},{name:"familyName",op:3,type:"SID"},{name:"weight",op:4,type:"SID"},{name:"isFixedPitch",op:1201,type:"number",value:0},{name:"italicAngle",op:1202,type:"number",value:0},{name:"underlinePosition",op:1203,type:"number",value:-100},{name:"underlineThickness",op:1204,type:"number",value:50},{name:"paintType",op:1205,type:"number",value:0},{name:"charstringType",op:1206,type:"number",value:2},{name:"fontMatrix",op:1207,type:["real","real","real","real","real","real"],value:[.001,0,0,.001,0,0]},{name:"uniqueId",op:13,type:"number"},{name:"fontBBox",op:5,type:["number","number","number","number"],value:[0,0,0,0]},{name:"strokeWidth",op:1208,type:"number",value:0},{name:"xuid",op:14,type:[],value:null},{name:"charset",op:15,type:"offset",value:0},{name:"encoding",op:16,type:"offset",value:0},{name:"charStrings",op:17,type:"offset",value:0},{name:"private",op:18,type:["number","offset"],value:[0,0]},{name:"ros",op:1230,type:["SID","SID","number"]},{name:"cidFontVersion",op:1231,type:"number",value:0},{name:"cidFontRevision",op:1232,type:"number",value:0},{name:"cidFontType",op:1233,type:"number",value:0},{name:"cidCount",op:1234,type:"number",value:8720},{name:"uidBase",op:1235,type:"number"},{name:"fdArray",op:1236,type:"offset"},{name:"fdSelect",op:1237,type:"offset"},{name:"fontName",op:1238,type:"SID"}];var bf=[{name:"subrs",op:19,type:"offset",value:0},{name:"defaultWidthX",op:20,type:"number",value:0},{name:"nominalWidthX",op:21,type:"number",value:0}];function xf(e,t){var n=mf(e,0,e.byteLength);return vf(n,yf,t)}function Tf(e,t,n,r){var i=mf(e,t,n);return vf(i,bf,r)}function Sf(e,t,n,r){var i=[];for(var a=0;a<n.length;a+=1){var s=new DataView(new Uint8Array(n[a]).buffer);var o=xf(s,r);o._subrs=[];o._subrsBias=0;var l=o.private[0];var u=o.private[1];if(l!==0&&u!==0){var f=Tf(e,u+t,l,r);o._defaultWidthX=f.defaultWidthX;o._nominalWidthX=f.nominalWidthX;if(f.subrs!==0){var h=u+f.subrs;var c=hf(e,h+t);o._subrs=c.objects;o._subrsBias=ff(o._subrs)}o._privateDict=f}i.push(o)}return i}function Ef(e,t,n,r){var i;var a;var s=new Au.Parser(e,t);n-=1;var o=[".notdef"];var l=s.parseCard8();if(l===0){for(var u=0;u<n;u+=1){i=s.parseSID();o.push(_f(r,i))}}else if(l===1){while(o.length<=n){i=s.parseSID();a=s.parseCard8();for(var f=0;f<=a;f+=1){o.push(_f(r,i));i+=1}}}else if(l===2){while(o.length<=n){i=s.parseSID();a=s.parseCard16();for(var h=0;h<=a;h+=1){o.push(_f(r,i));i+=1}}}else{throw new Error("Unknown charset format "+l)}return o}function wf(e,t,n){var r;var i={};var a=new Au.Parser(e,t);var s=a.parseCard8();if(s===0){var o=a.parseCard8();for(var l=0;l<o;l+=1){r=a.parseCard8();i[r]=l}}else if(s===1){var u=a.parseCard8();r=1;for(var f=0;f<u;f+=1){var h=a.parseCard8();var c=a.parseCard8();for(var p=h;p<=h+c;p+=1){i[p]=r;r+=1}}}else{throw new Error("Unknown encoding format "+s)}return new Gu(i,n)}function Mf(e,t,n){var r;var i;var a;var s;var o=new Gl;var l=[];var u=0;var f=false;var h=false;var c=0;var p=0;var d;var m;var _;var v;if(e.isCIDFont){var g=e.tables.cff.topDict._fdSelect[t.index];var y=e.tables.cff.topDict._fdArray[g];d=y._subrs;m=y._subrsBias;_=y._defaultWidthX;v=y._nominalWidthX}else{d=e.tables.cff.topDict._subrs;m=e.tables.cff.topDict._subrsBias;_=e.tables.cff.topDict._defaultWidthX;v=e.tables.cff.topDict._nominalWidthX}var b=_;function x(e,t){if(h){o.closePath()}o.moveTo(e,t);h=true}function T(){var e;e=l.length%2!==0;if(e&&!f){b=l.shift()+v}u+=l.length>>1;l.length=0;f=true}function S(n){var _;var g;var y;var E;var w;var M;var A;var R;var U;var D;var L;var O;var I=0;while(I<n.length){var C=n[I];I+=1;switch(C){case 1:T();break;case 3:T();break;case 4:if(l.length>1&&!f){b=l.shift()+v;f=true}p+=l.pop();x(c,p);break;case 5:while(l.length>0){c+=l.shift();p+=l.shift();o.lineTo(c,p)}break;case 6:while(l.length>0){c+=l.shift();o.lineTo(c,p);if(l.length===0){break}p+=l.shift();o.lineTo(c,p)}break;case 7:while(l.length>0){p+=l.shift();o.lineTo(c,p);if(l.length===0){break}c+=l.shift();o.lineTo(c,p)}break;case 8:while(l.length>0){r=c+l.shift();i=p+l.shift();a=r+l.shift();s=i+l.shift();c=a+l.shift();p=s+l.shift();o.curveTo(r,i,a,s,c,p)}break;case 10:w=l.pop()+m;M=d[w];if(M){S(M)}break;case 11:return;case 12:C=n[I];I+=1;switch(C){case 35:r=c+l.shift();i=p+l.shift();a=r+l.shift();s=i+l.shift();A=a+l.shift();R=s+l.shift();U=A+l.shift();D=R+l.shift();L=U+l.shift();O=D+l.shift();c=L+l.shift();p=O+l.shift();l.shift();o.curveTo(r,i,a,s,A,R);o.curveTo(U,D,L,O,c,p);break;case 34:r=c+l.shift();i=p;a=r+l.shift();s=i+l.shift();A=a+l.shift();R=s;U=A+l.shift();D=s;L=U+l.shift();O=p;c=L+l.shift();o.curveTo(r,i,a,s,A,R);o.curveTo(U,D,L,O,c,p);break;case 36:r=c+l.shift();i=p+l.shift();a=r+l.shift();s=i+l.shift();A=a+l.shift();R=s;U=A+l.shift();D=s;L=U+l.shift();O=D+l.shift();c=L+l.shift();o.curveTo(r,i,a,s,A,R);o.curveTo(U,D,L,O,c,p);break;case 37:r=c+l.shift();i=p+l.shift();a=r+l.shift();s=i+l.shift();A=a+l.shift();R=s+l.shift();U=A+l.shift();D=R+l.shift();L=U+l.shift();O=D+l.shift();if(Math.abs(L-c)>Math.abs(O-p)){c=L+l.shift()}else{p=O+l.shift()}o.curveTo(r,i,a,s,A,R);o.curveTo(U,D,L,O,c,p);break;default:console.log("Glyph "+t.index+": unknown operator "+1200+C);l.length=0}break;case 14:if(l.length>0&&!f){b=l.shift()+v;f=true}if(h){o.closePath();h=false}break;case 18:T();break;case 19:case 20:T();I+=u+7>>3;break;case 21:if(l.length>2&&!f){b=l.shift()+v;f=true}p+=l.pop();c+=l.pop();x(c,p);break;case 22:if(l.length>1&&!f){b=l.shift()+v;f=true}c+=l.pop();x(c,p);break;case 23:T();break;case 24:while(l.length>2){r=c+l.shift();i=p+l.shift();a=r+l.shift();s=i+l.shift();c=a+l.shift();p=s+l.shift();o.curveTo(r,i,a,s,c,p)}c+=l.shift();p+=l.shift();o.lineTo(c,p);break;case 25:while(l.length>6){c+=l.shift();p+=l.shift();o.lineTo(c,p)}r=c+l.shift();i=p+l.shift();a=r+l.shift();s=i+l.shift();c=a+l.shift();p=s+l.shift();o.curveTo(r,i,a,s,c,p);break;case 26:if(l.length%2){c+=l.shift()}while(l.length>0){r=c;i=p+l.shift();a=r+l.shift();s=i+l.shift();c=a;p=s+l.shift();o.curveTo(r,i,a,s,c,p)}break;case 27:if(l.length%2){p+=l.shift()}while(l.length>0){r=c+l.shift();i=p;a=r+l.shift();s=i+l.shift();c=a+l.shift();p=s;o.curveTo(r,i,a,s,c,p)}break;case 28:_=n[I];g=n[I+1];l.push((_<<24|g<<16)>>16);I+=2;break;case 29:w=l.pop()+e.gsubrsBias;M=e.gsubrs[w];if(M){S(M)}break;case 30:while(l.length>0){r=c;i=p+l.shift();a=r+l.shift();s=i+l.shift();c=a+l.shift();p=s+(l.length===1?l.shift():0);o.curveTo(r,i,a,s,c,p);if(l.length===0){break}r=c+l.shift();i=p;a=r+l.shift();s=i+l.shift();p=s+l.shift();c=a+(l.length===1?l.shift():0);o.curveTo(r,i,a,s,c,p)}break;case 31:while(l.length>0){r=c+l.shift();i=p;a=r+l.shift();s=i+l.shift();p=s+l.shift();c=a+(l.length===1?l.shift():0);o.curveTo(r,i,a,s,c,p);if(l.length===0){break}r=c;i=p+l.shift();a=r+l.shift();s=i+l.shift();c=a+l.shift();p=s+(l.length===1?l.shift():0);o.curveTo(r,i,a,s,c,p)}break;default:if(C<32){console.log("Glyph "+t.index+": unknown operator "+C)}else if(C<247){l.push(C-139)}else if(C<251){_=n[I];I+=1;l.push((C-247)*256+_+108)}else if(C<255){_=n[I];I+=1;l.push(-(C-251)*256-_-108)}else{_=n[I];g=n[I+1];y=n[I+2];E=n[I+3];I+=4;l.push((_<<24|g<<16|y<<8|E)/65536)}}}}S(n);t.advanceWidth=b;return o}function Af(e,t,n,r){var i=[];var a;var s=new Au.Parser(e,t);var o=s.parseCard8();if(o===0){for(var l=0;l<n;l++){a=s.parseCard8();if(a>=r){throw new Error("CFF table CID Font FDSelect has bad FD index value "+a+" (FD count "+r+")")}i.push(a)}}else if(o===3){var u=s.parseCard16();var f=s.parseCard16();if(f!==0){throw new Error("CFF Table CID Font FDSelect format 3 range has bad initial GID "+f)}var h;for(var c=0;c<u;c++){a=s.parseCard8();h=s.parseCard16();if(a>=r){throw new Error("CFF table CID Font FDSelect has bad FD index value "+a+" (FD count "+r+")")}if(h>n){throw new Error("CFF Table CID Font FDSelect format 3 range has bad GID "+h)}for(;f<h;f++){i.push(a)}f=h}if(h!==n){throw new Error("CFF Table CID Font FDSelect format 3 range has bad final GID "+h)}}else{throw new Error("CFF Table CID Font FDSelect table has unsupported format "+o)}return i}function Rf(e,t,n){n.tables.cff={};var r=gf(e,t);var i=hf(e,r.endOffset,Au.bytesToString);var a=hf(e,i.endOffset);var s=hf(e,a.endOffset,Au.bytesToString);var o=hf(e,s.endOffset);n.gsubrs=o.objects;n.gsubrsBias=ff(n.gsubrs);var l=Sf(e,t,a.objects,s.objects);if(l.length!==1){throw new Error("CFF table has too many fonts in 'FontSet' - count of fonts NameIndex.length = "+l.length)}var u=l[0];n.tables.cff.topDict=u;if(u._privateDict){n.defaultWidthX=u._privateDict.defaultWidthX;n.nominalWidthX=u._privateDict.nominalWidthX}if(u.ros[0]!==undefined&&u.ros[1]!==undefined){n.isCIDFont=true}if(n.isCIDFont){var f=u.fdArray;var h=u.fdSelect;if(f===0||h===0){throw new Error("Font is marked as a CID font, but FDArray and/or FDSelect information is missing")}f+=t;var c=hf(e,f);var p=Sf(e,t,c.objects,s.objects);u._fdArray=p;h+=t;u._fdSelect=Af(e,h,n.numGlyphs,p.length)}var d=t+u.private[1];var m=Tf(e,d,u.private[0],s.objects);n.defaultWidthX=m.defaultWidthX;n.nominalWidthX=m.nominalWidthX;if(m.subrs!==0){var _=d+m.subrs;var v=hf(e,_);n.subrs=v.objects;n.subrsBias=ff(n.subrs)}else{n.subrs=[];n.subrsBias=0}var g=hf(e,t+u.charStrings);n.nGlyphs=g.objects.length;var y=Ef(e,t+u.charset,n.nGlyphs,s.objects);if(u.encoding===0){n.cffEncoding=new Gu(Bu,y)}else if(u.encoding===1){n.cffEncoding=new Gu(Fu,y)}else{n.cffEncoding=wf(e,t+u.encoding,y)}n.encoding=n.encoding||n.cffEncoding;n.glyphs=new lf.GlyphSet(n);for(var b=0;b<n.nGlyphs;b+=1){var x=g.objects[b];n.glyphs.push(b,lf.cffGlyphLoader(n,b,Mf,x))}}function Uf(e,t){var n;var r=Pu.indexOf(e);if(r>=0){n=r}r=t.indexOf(e);if(r>=0){n=r+Pu.length}else{n=Pu.length+t.length;t.push(e)}return n}function Df(){return new du.Record("Header",[{name:"major",type:"Card8",value:1},{name:"minor",type:"Card8",value:0},{name:"hdrSize",type:"Card8",value:4},{name:"major",type:"Card8",value:1}])}function Lf(e){var t=new du.Record("Name INDEX",[{name:"names",type:"INDEX",value:[]}]);t.names=[];for(var n=0;n<e.length;n+=1){t.names.push({name:"name_"+n,type:"NAME",value:e[n]})}return t}function Of(e,t,n){var r={};for(var i=0;i<e.length;i+=1){var a=e[i];var s=t[a.name];if(s!==undefined&&!uf(s,a.value)){if(a.type==="SID"){s=Uf(s,n)}r[a.op]={name:a.name,type:a.type,value:s}}}return r}function If(e,t){var n=new du.Record("Top DICT",[{name:"dict",type:"DICT",value:{}}]);n.dict=Of(yf,e,t);return n}function Cf(e){var t=new du.Record("Top DICT INDEX",[{name:"topDicts",type:"INDEX",value:[]}]);t.topDicts=[{name:"topDict_0",type:"TABLE",value:e}];return t}function Pf(e){var t=new du.Record("String INDEX",[{name:"strings",type:"INDEX",value:[]}]);t.strings=[];for(var n=0;n<e.length;n+=1){t.strings.push({name:"string_"+n,type:"STRING",value:e[n]})}return t}function Bf(){return new du.Record("Global Subr INDEX",[{name:"subrs",type:"INDEX",value:[]}])}function Ff(e,t){var n=new du.Record("Charsets",[{name:"format",type:"Card8",value:0}]);for(var r=0;r<e.length;r+=1){var i=e[r];var a=Uf(i,t);n.fields.push({name:"glyph_"+r,type:"SID",value:a})}return n}function zf(e){var t=[];var n=e.path;t.push({name:"width",type:"NUMBER",value:e.advanceWidth});var r=0;var i=0;for(var a=0;a<n.commands.length;a+=1){var s=void 0;var o=void 0;var l=n.commands[a];if(l.type==="Q"){var u=1/3;var f=2/3;l={type:"C",x:l.x,y:l.y,x1:u*r+f*l.x1,y1:u*i+f*l.y1,x2:u*l.x+f*l.x1,y2:u*l.y+f*l.y1}}if(l.type==="M"){s=Math.round(l.x-r);o=Math.round(l.y-i);t.push({name:"dx",type:"NUMBER",value:s});t.push({name:"dy",type:"NUMBER",value:o});t.push({name:"rmoveto",type:"OP",value:21});r=Math.round(l.x);i=Math.round(l.y)}else if(l.type==="L"){s=Math.round(l.x-r);o=Math.round(l.y-i);t.push({name:"dx",type:"NUMBER",value:s});t.push({name:"dy",type:"NUMBER",value:o});t.push({name:"rlineto",type:"OP",value:5});r=Math.round(l.x);i=Math.round(l.y)}else if(l.type==="C"){var h=Math.round(l.x1-r);var c=Math.round(l.y1-i);var p=Math.round(l.x2-l.x1);var d=Math.round(l.y2-l.y1);s=Math.round(l.x-l.x2);o=Math.round(l.y-l.y2);t.push({name:"dx1",type:"NUMBER",value:h});t.push({name:"dy1",type:"NUMBER",value:c});t.push({name:"dx2",type:"NUMBER",value:p});t.push({name:"dy2",type:"NUMBER",value:d});t.push({name:"dx",type:"NUMBER",value:s});t.push({name:"dy",type:"NUMBER",value:o});t.push({name:"rrcurveto",type:"OP",value:8});r=Math.round(l.x);i=Math.round(l.y)}}t.push({name:"endchar",type:"OP",value:14});return t}function kf(e){var t=new du.Record("CharStrings INDEX",[{name:"charStrings",type:"INDEX",value:[]}]);for(var n=0;n<e.length;n+=1){var r=e.get(n);var i=zf(r);t.charStrings.push({name:r.name,type:"CHARSTRING",value:i})}return t}function Nf(e,t){var n=new du.Record("Private DICT",[{name:"dict",type:"DICT",value:{}}]);n.dict=Of(bf,e,t);return n}function Gf(e,t){var n=new du.Table("CFF ",[{name:"header",type:"RECORD"},{name:"nameIndex",type:"RECORD"},{name:"topDictIndex",type:"RECORD"},{name:"stringIndex",type:"RECORD"},{name:"globalSubrIndex",type:"RECORD"},{name:"charsets",type:"RECORD"},{name:"charStringsIndex",type:"RECORD"},{name:"privateDict",type:"RECORD"}]);var r=1/t.unitsPerEm;var i={version:t.version,fullName:t.fullName,familyName:t.familyName,weight:t.weightName,fontBBox:t.fontBBox||[0,0,0,0],fontMatrix:[r,0,0,r,0,0],charset:999,encoding:0,charStrings:999,private:[0,999]};var a={};var s=[];var o;for(var l=1;l<e.length;l+=1){o=e.get(l);s.push(o.name)}var u=[];n.header=Df();n.nameIndex=Lf([t.postScriptName]);var f=If(i,u);n.topDictIndex=Cf(f);n.globalSubrIndex=Bf();n.charsets=Ff(s,u);n.charStringsIndex=kf(e);n.privateDict=Nf(a,u);n.stringIndex=Pf(u);var h=n.header.sizeOf()+n.nameIndex.sizeOf()+n.topDictIndex.sizeOf()+n.stringIndex.sizeOf()+n.globalSubrIndex.sizeOf();i.charset=h;i.encoding=0;i.charStrings=i.charset+n.charsets.sizeOf();i.private[1]=i.charStrings+n.charStringsIndex.sizeOf();f=If(i,u);n.topDictIndex=Cf(f);return n}var Vf={parse:Rf,make:Gf};function Hf(e,t){var n={};var r=new Au.Parser(e,t);n.version=r.parseVersion();n.fontRevision=Math.round(r.parseFixed()*1e3)/1e3;n.checkSumAdjustment=r.parseULong();n.magicNumber=r.parseULong();Wl.argument(n.magicNumber===1594834165,"Font header has wrong magic number.");n.flags=r.parseUShort();n.unitsPerEm=r.parseUShort();n.created=r.parseLongDateTime();n.modified=r.parseLongDateTime();n.xMin=r.parseShort();n.yMin=r.parseShort();n.xMax=r.parseShort();n.yMax=r.parseShort();n.macStyle=r.parseUShort();n.lowestRecPPEM=r.parseUShort();n.fontDirectionHint=r.parseShort();n.indexToLocFormat=r.parseShort();n.glyphDataFormat=r.parseShort();return n}function Wf(e){var t=Math.round((new Date).getTime()/1e3)+2082844800;var n=t;if(e.createdTimestamp){n=e.createdTimestamp+2082844800}return new du.Table("head",[{name:"version",type:"FIXED",value:65536},{name:"fontRevision",type:"FIXED",value:65536},{name:"checkSumAdjustment",type:"ULONG",value:0},{name:"magicNumber",type:"ULONG",value:1594834165},{name:"flags",type:"USHORT",value:0},{name:"unitsPerEm",type:"USHORT",value:1e3},{name:"created",type:"LONGDATETIME",value:n},{name:"modified",type:"LONGDATETIME",value:t},{name:"xMin",type:"SHORT",value:0},{name:"yMin",type:"SHORT",value:0},{name:"xMax",type:"SHORT",value:0},{name:"yMax",type:"SHORT",value:0},{name:"macStyle",type:"USHORT",value:0},{name:"lowestRecPPEM",type:"USHORT",value:0},{name:"fontDirectionHint",type:"SHORT",value:2},{name:"indexToLocFormat",type:"SHORT",value:0},{name:"glyphDataFormat",type:"SHORT",value:0}],e)}var Xf={parse:Hf,make:Wf};function jf(e,t){var n={};var r=new Au.Parser(e,t);n.version=r.parseVersion();n.ascender=r.parseShort();n.descender=r.parseShort();n.lineGap=r.parseShort();n.advanceWidthMax=r.parseUShort();n.minLeftSideBearing=r.parseShort();n.minRightSideBearing=r.parseShort();n.xMaxExtent=r.parseShort();n.caretSlopeRise=r.parseShort();n.caretSlopeRun=r.parseShort();n.caretOffset=r.parseShort();r.relativeOffset+=8;n.metricDataFormat=r.parseShort();n.numberOfHMetrics=r.parseUShort();return n}function qf(e){return new du.Table("hhea",[{name:"version",type:"FIXED",value:65536},{name:"ascender",type:"FWORD",value:0},{name:"descender",type:"FWORD",value:0},{name:"lineGap",type:"FWORD",value:0},{name:"advanceWidthMax",type:"UFWORD",value:0},{name:"minLeftSideBearing",type:"FWORD",value:0},{name:"minRightSideBearing",type:"FWORD",value:0},{name:"xMaxExtent",type:"FWORD",value:0},{name:"caretSlopeRise",type:"SHORT",value:1},{name:"caretSlopeRun",type:"SHORT",value:0},{name:"caretOffset",type:"SHORT",value:0},{name:"reserved1",type:"SHORT",value:0},{name:"reserved2",type:"SHORT",value:0},{name:"reserved3",type:"SHORT",value:0},{name:"reserved4",type:"SHORT",value:0},{name:"metricDataFormat",type:"SHORT",value:0},{name:"numberOfHMetrics",type:"USHORT",value:0}],e)}var Yf={parse:jf,make:qf};function Kf(e,t,n,r,i){var a;var s;var o=new Au.Parser(e,t);for(var l=0;l<r;l+=1){if(l<n){a=o.parseUShort();s=o.parseShort()}var u=i.get(l);u.advanceWidth=a;u.leftSideBearing=s}}function Zf(e){var t=new du.Table("hmtx",[]);for(var n=0;n<e.length;n+=1){var r=e.get(n);var i=r.advanceWidth||0;var a=r.leftSideBearing||0;t.fields.push({name:"advanceWidth_"+n,type:"USHORT",value:i});t.fields.push({name:"leftSideBearing_"+n,type:"SHORT",value:a})}return t}var Jf={parse:Kf,make:Zf};function Qf(e){var t=new du.Table("ltag",[{name:"version",type:"ULONG",value:1},{name:"flags",type:"ULONG",value:0},{name:"numTags",type:"ULONG",value:e.length}]);var n="";var r=12+e.length*4;for(var i=0;i<e.length;++i){var a=n.indexOf(e[i]);if(a<0){a=n.length;n+=e[i]}t.fields.push({name:"offset "+i,type:"USHORT",value:r+a});t.fields.push({name:"length "+i,type:"USHORT",value:e[i].length})}t.fields.push({name:"stringPool",type:"CHARARRAY",value:n});return t}function $f(e,t){var n=new Au.Parser(e,t);var r=n.parseULong();Wl.argument(r===1,"Unsupported ltag table version.");n.skip("uLong",1);var i=n.parseULong();var a=[];for(var s=0;s<i;s++){var o="";var l=t+n.parseUShort();var u=n.parseUShort();for(var f=l;f<l+u;++f){o+=String.fromCharCode(e.getInt8(f))}a.push(o)}return a}var eh={make:Qf,parse:$f};function th(e,t){var n={};var r=new Au.Parser(e,t);n.version=r.parseVersion();n.numGlyphs=r.parseUShort();if(n.version===1){n.maxPoints=r.parseUShort();n.maxContours=r.parseUShort();n.maxCompositePoints=r.parseUShort();n.maxCompositeContours=r.parseUShort();n.maxZones=r.parseUShort();n.maxTwilightPoints=r.parseUShort();n.maxStorage=r.parseUShort();n.maxFunctionDefs=r.parseUShort();n.maxInstructionDefs=r.parseUShort();n.maxStackElements=r.parseUShort();n.maxSizeOfInstructions=r.parseUShort();n.maxComponentElements=r.parseUShort();n.maxComponentDepth=r.parseUShort()}return n}function nh(e){return new du.Table("maxp",[{name:"version",type:"FIXED",value:20480},{name:"numGlyphs",type:"USHORT",value:e}])}var rh={parse:th,make:nh};var ih=["copyright","fontFamily","fontSubfamily","uniqueID","fullName","version","postScriptName","trademark","manufacturer","designer","description","manufacturerURL","designerURL","license","licenseURL","reserved","preferredFamily","preferredSubfamily","compatibleFullName","sampleText","postScriptFindFontName","wwsFamily","wwsSubfamily"];var ah={0:"en",1:"fr",2:"de",3:"it",4:"nl",5:"sv",6:"es",7:"da",8:"pt",9:"no",10:"he",11:"ja",12:"ar",13:"fi",14:"el",15:"is",16:"mt",17:"tr",18:"hr",19:"zh-Hant",20:"ur",21:"hi",22:"th",23:"ko",24:"lt",25:"pl",26:"hu",27:"es",28:"lv",29:"se",30:"fo",31:"fa",32:"ru",33:"zh",34:"nl-BE",35:"ga",36:"sq",37:"ro",38:"cz",39:"sk",40:"si",41:"yi",42:"sr",43:"mk",44:"bg",45:"uk",46:"be",47:"uz",48:"kk",49:"az-Cyrl",50:"az-Arab",51:"hy",52:"ka",53:"mo",54:"ky",55:"tg",56:"tk",57:"mn-CN",58:"mn",59:"ps",60:"ks",61:"ku",62:"sd",63:"bo",64:"ne",65:"sa",66:"mr",67:"bn",68:"as",69:"gu",70:"pa",71:"or",72:"ml",73:"kn",74:"ta",75:"te",76:"si",77:"my",78:"km",79:"lo",80:"vi",81:"id",82:"tl",83:"ms",84:"ms-Arab",85:"am",86:"ti",87:"om",88:"so",89:"sw",90:"rw",91:"rn",92:"ny",93:"mg",94:"eo",128:"cy",129:"eu",130:"ca",131:"la",132:"qu",133:"gn",134:"ay",135:"tt",136:"ug",137:"dz",138:"jv",139:"su",140:"gl",141:"af",142:"br",143:"iu",144:"gd",145:"gv",146:"ga",147:"to",148:"el-polyton",149:"kl",150:"az",151:"nn"};var sh={0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:5,11:1,12:4,13:0,14:6,15:0,16:0,17:0,18:0,19:2,20:4,21:9,22:21,23:3,24:29,25:29,26:29,27:29,28:29,29:0,30:0,31:4,32:7,33:25,34:0,35:0,36:0,37:0,38:29,39:29,40:0,41:5,42:7,43:7,44:7,45:7,46:7,47:7,48:7,49:7,50:4,51:24,52:23,53:7,54:7,55:7,56:7,57:27,58:7,59:4,60:4,61:4,62:4,63:26,64:9,65:9,66:9,67:13,68:13,69:11,70:10,71:12,72:17,73:16,74:14,75:15,76:18,77:19,78:20,79:22,80:30,81:0,82:0,83:0,84:4,85:28,86:28,87:28,88:0,89:0,90:0,91:0,92:0,93:0,94:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:7,136:4,137:26,138:0,139:0,140:0,141:0,142:0,143:28,144:0,145:0,146:0,147:0,148:6,149:0,150:0,151:0};var oh={1078:"af",1052:"sq",1156:"gsw",1118:"am",5121:"ar-DZ",15361:"ar-BH",3073:"ar",2049:"ar-IQ",11265:"ar-JO",13313:"ar-KW",12289:"ar-LB",4097:"ar-LY",6145:"ary",8193:"ar-OM",16385:"ar-QA",1025:"ar-SA",10241:"ar-SY",7169:"aeb",14337:"ar-AE",9217:"ar-YE",1067:"hy",1101:"as",2092:"az-Cyrl",1068:"az",1133:"ba",1069:"eu",1059:"be",2117:"bn",1093:"bn-IN",8218:"bs-Cyrl",5146:"bs",1150:"br",1026:"bg",1027:"ca",3076:"zh-HK",5124:"zh-MO",2052:"zh",4100:"zh-SG",1028:"zh-TW",1155:"co",1050:"hr",4122:"hr-BA",1029:"cs",1030:"da",1164:"prs",1125:"dv",2067:"nl-BE",1043:"nl",3081:"en-AU",10249:"en-BZ",4105:"en-CA",9225:"en-029",16393:"en-IN",6153:"en-IE",8201:"en-JM",17417:"en-MY",5129:"en-NZ",13321:"en-PH",18441:"en-SG",7177:"en-ZA",11273:"en-TT",2057:"en-GB",1033:"en",12297:"en-ZW",1061:"et",1080:"fo",1124:"fil",1035:"fi",2060:"fr-BE",3084:"fr-CA",1036:"fr",5132:"fr-LU",6156:"fr-MC",4108:"fr-CH",1122:"fy",1110:"gl",1079:"ka",3079:"de-AT",1031:"de",5127:"de-LI",4103:"de-LU",2055:"de-CH",1032:"el",1135:"kl",1095:"gu",1128:"ha",1037:"he",1081:"hi",1038:"hu",1039:"is",1136:"ig",1057:"id",1117:"iu",2141:"iu-Latn",2108:"ga",1076:"xh",1077:"zu",1040:"it",2064:"it-CH",1041:"ja",1099:"kn",1087:"kk",1107:"km",1158:"quc",1159:"rw",1089:"sw",1111:"kok",1042:"ko",1088:"ky",1108:"lo",1062:"lv",1063:"lt",2094:"dsb",1134:"lb",1071:"mk",2110:"ms-BN",1086:"ms",1100:"ml",1082:"mt",1153:"mi",1146:"arn",1102:"mr",1148:"moh",1104:"mn",2128:"mn-CN",1121:"ne",1044:"nb",2068:"nn",1154:"oc",1096:"or",1123:"ps",1045:"pl",1046:"pt",2070:"pt-PT",1094:"pa",1131:"qu-BO",2155:"qu-EC",3179:"qu",1048:"ro",1047:"rm",1049:"ru",9275:"smn",4155:"smj-NO",5179:"smj",3131:"se-FI",1083:"se",2107:"se-SE",8251:"sms",6203:"sma-NO",7227:"sms",1103:"sa",7194:"sr-Cyrl-BA",3098:"sr",6170:"sr-Latn-BA",2074:"sr-Latn",1132:"nso",1074:"tn",1115:"si",1051:"sk",1060:"sl",11274:"es-AR",16394:"es-BO",13322:"es-CL",9226:"es-CO",5130:"es-CR",7178:"es-DO",12298:"es-EC",17418:"es-SV",4106:"es-GT",18442:"es-HN",2058:"es-MX",19466:"es-NI",6154:"es-PA",15370:"es-PY",10250:"es-PE",20490:"es-PR",3082:"es",1034:"es",21514:"es-US",14346:"es-UY",8202:"es-VE",2077:"sv-FI",1053:"sv",1114:"syr",1064:"tg",2143:"tzm",1097:"ta",1092:"tt",1098:"te",1054:"th",1105:"bo",1055:"tr",1090:"tk",1152:"ug",1058:"uk",1070:"hsb",1056:"ur",2115:"uz-Cyrl",1091:"uz",1066:"vi",1106:"cy",1160:"wo",1157:"sah",1144:"ii",1130:"yo"};function lh(e,t,n){switch(e){case 0:if(t===65535){return"und"}else if(n){return n[t]}break;case 1:return ah[t];case 3:return oh[t]}return undefined}var uh="utf-16";var fh={0:"macintosh",1:"x-mac-japanese",2:"x-mac-chinesetrad",3:"x-mac-korean",6:"x-mac-greek",7:"x-mac-cyrillic",9:"x-mac-devanagai",10:"x-mac-gurmukhi",11:"x-mac-gujarati",12:"x-mac-oriya",13:"x-mac-bengali",14:"x-mac-tamil",15:"x-mac-telugu",16:"x-mac-kannada",17:"x-mac-malayalam",18:"x-mac-sinhalese",19:"x-mac-burmese",20:"x-mac-khmer",21:"x-mac-thai",22:"x-mac-lao",23:"x-mac-georgian",24:"x-mac-armenian",25:"x-mac-chinesesimp",26:"x-mac-tibetan",27:"x-mac-mongolian",28:"x-mac-ethiopic",29:"x-mac-ce",30:"x-mac-vietnamese",31:"x-mac-extarabic"};var hh={15:"x-mac-icelandic",17:"x-mac-turkish",18:"x-mac-croatian",24:"x-mac-ce",25:"x-mac-ce",26:"x-mac-ce",27:"x-mac-ce",28:"x-mac-ce",30:"x-mac-icelandic",37:"x-mac-romanian",38:"x-mac-ce",39:"x-mac-ce",40:"x-mac-ce",143:"x-mac-inuit",146:"x-mac-gaelic"};function ch(e,t,n){switch(e){case 0:return uh;case 1:return hh[n]||fh[t];case 3:if(t===1||t===10){return uh}break}return undefined}function ph(e,t,n){var r={};var i=new Au.Parser(e,t);var a=i.parseUShort();var s=i.parseUShort();var o=i.offset+i.parseUShort();for(var l=0;l<s;l++){var u=i.parseUShort();var f=i.parseUShort();var h=i.parseUShort();var c=i.parseUShort();var p=ih[c]||c;var d=i.parseUShort();var m=i.parseUShort();var _=lh(u,h,n);var v=ch(u,f,h);if(v!==undefined&&_!==undefined){var g=void 0;if(v===uh){g=ql.UTF16(e,o+m,d)}else{g=ql.MACSTRING(e,o+m,d,v)}if(g){var y=r[p];if(y===undefined){y=r[p]={}}y[_]=g}}}var b=0;if(a===1){b=i.parseUShort()}return r}function dh(e){var t={};for(var n in e){t[e[n]]=parseInt(n)}return t}function mh(e,t,n,r,i,a){return new du.Record("NameRecord",[{name:"platformID",type:"USHORT",value:e},{name:"encodingID",type:"USHORT",value:t},{name:"languageID",type:"USHORT",value:n},{name:"nameID",type:"USHORT",value:r},{name:"length",type:"USHORT",value:i},{name:"offset",type:"USHORT",value:a}])}function _h(e,t){var n=e.length;var r=t.length-n+1;e:for(var i=0;i<r;i++){for(;i<r;i++){for(var a=0;a<n;a++){if(t[i+a]!==e[a]){continue e}}return i}}return-1}function vh(e,t){var n=_h(e,t);if(n<0){n=t.length;var r=0;var i=e.length;for(;r<i;++r){t.push(e[r])}}return n}function gh(e,t){var n;var r=[];var i={};var a=dh(ih);for(var s in e){var o=a[s];if(o===undefined){o=s}n=parseInt(o);if(isNaN(n)){throw new Error('Name table entry "'+s+'" does not exist, see nameTableNames for complete list.')}i[n]=e[s];r.push(n)}var l=dh(ah);var u=dh(oh);var f=[];var h=[];for(var c=0;c<r.length;c++){n=r[c];var p=i[n];for(var d in p){var m=p[d];var _=1;var v=l[d];var g=sh[v];var y=ch(_,g,v);var b=Yl.MACSTRING(m,y);if(b===undefined){_=0;v=t.indexOf(d);if(v<0){v=t.length;t.push(d)}g=4;b=Yl.UTF16(m)}var x=vh(b,h);f.push(mh(_,g,v,n,b.length,x));var T=u[d];if(T!==undefined){var S=Yl.UTF16(m);var E=vh(S,h);f.push(mh(3,1,T,n,S.length,E))}}}f.sort(function(e,t){return e.platformID-t.platformID||e.encodingID-t.encodingID||e.languageID-t.languageID||e.nameID-t.nameID});var w=new du.Table("name",[{name:"format",type:"USHORT",value:0},{name:"count",type:"USHORT",value:f.length},{name:"stringOffset",type:"USHORT",value:6+f.length*12}]);for(var M=0;M<f.length;M++){w.fields.push({name:"record_"+M,type:"RECORD",value:f[M]})}w.fields.push({name:"strings",type:"LITERAL",value:h});return w}var yh={parse:ph,make:gh};var bh=[{begin:0,end:127},{begin:128,end:255},{begin:256,end:383},{begin:384,end:591},{begin:592,end:687},{begin:688,end:767},{begin:768,end:879},{begin:880,end:1023},{begin:11392,end:11519},{begin:1024,end:1279},{begin:1328,end:1423},{begin:1424,end:1535},{begin:42240,end:42559},{begin:1536,end:1791},{begin:1984,end:2047},{begin:2304,end:2431},{begin:2432,end:2559},{begin:2560,end:2687},{begin:2688,end:2815},{begin:2816,end:2943},{begin:2944,end:3071},{begin:3072,end:3199},{begin:3200,end:3327},{begin:3328,end:3455},{begin:3584,end:3711},{begin:3712,end:3839},{begin:4256,end:4351},{begin:6912,end:7039},{begin:4352,end:4607},{begin:7680,end:7935},{begin:7936,end:8191},{begin:8192,end:8303},{begin:8304,end:8351},{begin:8352,end:8399},{begin:8400,end:8447},{begin:8448,end:8527},{begin:8528,end:8591},{begin:8592,end:8703},{begin:8704,end:8959},{begin:8960,end:9215},{begin:9216,end:9279},{begin:9280,end:9311},{begin:9312,end:9471},{begin:9472,end:9599},{begin:9600,end:9631},{begin:9632,end:9727},{begin:9728,end:9983},{begin:9984,end:10175},{begin:12288,end:12351},{begin:12352,end:12447},{begin:12448,end:12543},{begin:12544,end:12591},{begin:12592,end:12687},{begin:43072,end:43135},{begin:12800,end:13055},{begin:13056,end:13311},{begin:44032,end:55215},{begin:55296,end:57343},{begin:67840,end:67871},{begin:19968,end:40959},{begin:57344,end:63743},{begin:12736,end:12783},{begin:64256,end:64335},{begin:64336,end:65023},{begin:65056,end:65071},{begin:65040,end:65055},{begin:65104,end:65135},{begin:65136,end:65279},{begin:65280,end:65519},{begin:65520,end:65535},{begin:3840,end:4095},{begin:1792,end:1871},{begin:1920,end:1983},{begin:3456,end:3583},{begin:4096,end:4255},{begin:4608,end:4991},{begin:5024,end:5119},{begin:5120,end:5759},{begin:5760,end:5791},{begin:5792,end:5887},{begin:6016,end:6143},{begin:6144,end:6319},{begin:10240,end:10495},{begin:40960,end:42127},{begin:5888,end:5919},{begin:66304,end:66351},{begin:66352,end:66383},{begin:66560,end:66639},{begin:118784,end:119039},{begin:119808,end:120831},{begin:1044480,end:1048573},{begin:65024,end:65039},{begin:917504,end:917631},{begin:6400,end:6479},{begin:6480,end:6527},{begin:6528,end:6623},{begin:6656,end:6687},{begin:11264,end:11359},{begin:11568,end:11647},{begin:19904,end:19967},{begin:43008,end:43055},{begin:65536,end:65663},{begin:65856,end:65935},{begin:66432,end:66463},{begin:66464,end:66527},{begin:66640,end:66687},{begin:66688,end:66735},{begin:67584,end:67647},{begin:68096,end:68191},{begin:119552,end:119647},{begin:73728,end:74751},{begin:119648,end:119679},{begin:7040,end:7103},{begin:7168,end:7247},{begin:7248,end:7295},{begin:43136,end:43231},{begin:43264,end:43311},{begin:43312,end:43359},{begin:43520,end:43615},{begin:65936,end:65999},{begin:66e3,end:66047},{begin:66208,end:66271},{begin:127024,end:127135}];function xh(e){for(var t=0;t<bh.length;t+=1){var n=bh[t];if(e>=n.begin&&e<n.end){return t}}return-1}function Th(e,t){var n={};var r=new Au.Parser(e,t);n.version=r.parseUShort();n.xAvgCharWidth=r.parseShort();n.usWeightClass=r.parseUShort();n.usWidthClass=r.parseUShort();n.fsType=r.parseUShort();n.ySubscriptXSize=r.parseShort();n.ySubscriptYSize=r.parseShort();n.ySubscriptXOffset=r.parseShort();n.ySubscriptYOffset=r.parseShort();n.ySuperscriptXSize=r.parseShort();n.ySuperscriptYSize=r.parseShort();n.ySuperscriptXOffset=r.parseShort();n.ySuperscriptYOffset=r.parseShort();n.yStrikeoutSize=r.parseShort();n.yStrikeoutPosition=r.parseShort();n.sFamilyClass=r.parseShort();n.panose=[];for(var i=0;i<10;i++){n.panose[i]=r.parseByte()}n.ulUnicodeRange1=r.parseULong();n.ulUnicodeRange2=r.parseULong();n.ulUnicodeRange3=r.parseULong();n.ulUnicodeRange4=r.parseULong();n.achVendID=String.fromCharCode(r.parseByte(),r.parseByte(),r.parseByte(),r.parseByte());n.fsSelection=r.parseUShort();n.usFirstCharIndex=r.parseUShort();n.usLastCharIndex=r.parseUShort();n.sTypoAscender=r.parseShort();n.sTypoDescender=r.parseShort();n.sTypoLineGap=r.parseShort();n.usWinAscent=r.parseUShort();n.usWinDescent=r.parseUShort();if(n.version>=1){n.ulCodePageRange1=r.parseULong();n.ulCodePageRange2=r.parseULong()}if(n.version>=2){n.sxHeight=r.parseShort();n.sCapHeight=r.parseShort();n.usDefaultChar=r.parseUShort();n.usBreakChar=r.parseUShort();n.usMaxContent=r.parseUShort()}return n}function Sh(e){return new du.Table("OS/2",[{name:"version",type:"USHORT",value:3},{name:"xAvgCharWidth",type:"SHORT",value:0},{name:"usWeightClass",type:"USHORT",value:0},{name:"usWidthClass",type:"USHORT",value:0},{name:"fsType",type:"USHORT",value:0},{name:"ySubscriptXSize",type:"SHORT",value:650},{name:"ySubscriptYSize",type:"SHORT",value:699},{name:"ySubscriptXOffset",type:"SHORT",value:0},{name:"ySubscriptYOffset",type:"SHORT",value:140},{name:"ySuperscriptXSize",type:"SHORT",value:650},{name:"ySuperscriptYSize",type:"SHORT",value:699},{name:"ySuperscriptXOffset",type:"SHORT",value:0},{name:"ySuperscriptYOffset",type:"SHORT",value:479},{name:"yStrikeoutSize",type:"SHORT",value:49},{name:"yStrikeoutPosition",type:"SHORT",value:258},{name:"sFamilyClass",type:"SHORT",value:0},{name:"bFamilyType",type:"BYTE",value:0},{name:"bSerifStyle",type:"BYTE",value:0},{name:"bWeight",type:"BYTE",value:0},{name:"bProportion",type:"BYTE",value:0},{name:"bContrast",type:"BYTE",value:0},{name:"bStrokeVariation",type:"BYTE",value:0},{name:"bArmStyle",type:"BYTE",value:0},{name:"bLetterform",type:"BYTE",value:0},{name:"bMidline",type:"BYTE",value:0},{name:"bXHeight",type:"BYTE",value:0},{name:"ulUnicodeRange1",type:"ULONG",value:0},{name:"ulUnicodeRange2",type:"ULONG",value:0},{name:"ulUnicodeRange3",type:"ULONG",value:0},{name:"ulUnicodeRange4",type:"ULONG",value:0},{name:"achVendID",type:"CHARARRAY",value:"XXXX"},{name:"fsSelection",type:"USHORT",value:0},{name:"usFirstCharIndex",type:"USHORT",value:0},{name:"usLastCharIndex",type:"USHORT",value:0},{name:"sTypoAscender",type:"SHORT",value:0},{name:"sTypoDescender",type:"SHORT",value:0},{name:"sTypoLineGap",type:"SHORT",value:0},{name:"usWinAscent",type:"USHORT",value:0},{name:"usWinDescent",type:"USHORT",value:0},{name:"ulCodePageRange1",type:"ULONG",value:0},{name:"ulCodePageRange2",type:"ULONG",value:0},{name:"sxHeight",type:"SHORT",value:0},{name:"sCapHeight",type:"SHORT",value:0},{name:"usDefaultChar",type:"USHORT",value:0},{name:"usBreakChar",type:"USHORT",value:0},{name:"usMaxContext",type:"USHORT",value:0}],e)}var Eh={parse:Th,make:Sh,unicodeRanges:bh,getUnicodeRange:xh};function wh(e,t){var n={};var r=new Au.Parser(e,t);n.version=r.parseVersion();n.italicAngle=r.parseFixed();n.underlinePosition=r.parseShort();n.underlineThickness=r.parseShort();n.isFixedPitch=r.parseULong();n.minMemType42=r.parseULong();n.maxMemType42=r.parseULong();n.minMemType1=r.parseULong();n.maxMemType1=r.parseULong();switch(n.version){case 1:n.names=zu.slice();break;case 2:n.numberOfGlyphs=r.parseUShort();n.glyphNameIndex=new Array(n.numberOfGlyphs);for(var i=0;i<n.numberOfGlyphs;i++){n.glyphNameIndex[i]=r.parseUShort()}n.names=[];for(var a=0;a<n.numberOfGlyphs;a++){if(n.glyphNameIndex[a]>=zu.length){var s=r.parseChar();n.names.push(r.parseString(s))}}break;case 2.5:n.numberOfGlyphs=r.parseUShort();n.offset=new Array(n.numberOfGlyphs);for(var o=0;o<n.numberOfGlyphs;o++){n.offset[o]=r.parseChar()}break}return n}function Mh(){return new du.Table("post",[{name:"version",type:"FIXED",value:196608},{name:"italicAngle",type:"FIXED",value:0},{name:"underlinePosition",type:"FWORD",value:0},{name:"underlineThickness",type:"FWORD",value:0},{name:"isFixedPitch",type:"ULONG",value:0},{name:"minMemType42",type:"ULONG",value:0},{name:"maxMemType42",type:"ULONG",value:0},{name:"minMemType1",type:"ULONG",value:0},{name:"maxMemType1",type:"ULONG",value:0}])}var Ah={parse:wh,make:Mh};var Rh=new Array(9);Rh[1]=function e(){var t=this.offset+this.relativeOffset;var n=this.parseUShort();if(n===1){return{substFormat:1,coverage:this.parsePointer(wu.coverage),deltaGlyphId:this.parseUShort()}}else if(n===2){return{substFormat:2,coverage:this.parsePointer(wu.coverage),substitute:this.parseOffset16List()}}Wl.assert(false,"0x"+t.toString(16)+": lookup type 1 format must be 1 or 2.")};Rh[2]=function e(){var t=this.parseUShort();Wl.argument(t===1,"GSUB Multiple Substitution Subtable identifier-format must be 1");return{substFormat:t,coverage:this.parsePointer(wu.coverage),sequences:this.parseListOfLists()}};Rh[3]=function e(){var t=this.parseUShort();Wl.argument(t===1,"GSUB Alternate Substitution Subtable identifier-format must be 1");return{substFormat:t,coverage:this.parsePointer(wu.coverage),alternateSets:this.parseListOfLists()}};Rh[4]=function e(){var t=this.parseUShort();Wl.argument(t===1,"GSUB ligature table identifier-format must be 1");return{substFormat:t,coverage:this.parsePointer(wu.coverage),ligatureSets:this.parseListOfLists(function(){return{ligGlyph:this.parseUShort(),components:this.parseUShortList(this.parseUShort()-1)}})}};var Uh={sequenceIndex:wu.uShort,lookupListIndex:wu.uShort};Rh[5]=function e(){var t=this.offset+this.relativeOffset;var n=this.parseUShort();if(n===1){return{substFormat:n,coverage:this.parsePointer(wu.coverage),ruleSets:this.parseListOfLists(function(){var e=this.parseUShort();var t=this.parseUShort();return{input:this.parseUShortList(e-1),lookupRecords:this.parseRecordList(t,Uh)}})}}else if(n===2){return{substFormat:n,coverage:this.parsePointer(wu.coverage),classDef:this.parsePointer(wu.classDef),classSets:this.parseListOfLists(function(){var e=this.parseUShort();var t=this.parseUShort();return{classes:this.parseUShortList(e-1),lookupRecords:this.parseRecordList(t,Uh)}})}}else if(n===3){var r=this.parseUShort();var i=this.parseUShort();return{substFormat:n,coverages:this.parseList(r,wu.pointer(wu.coverage)),lookupRecords:this.parseRecordList(i,Uh)}}Wl.assert(false,"0x"+t.toString(16)+": lookup type 5 format must be 1, 2 or 3.")};Rh[6]=function e(){var t=this.offset+this.relativeOffset;var n=this.parseUShort();if(n===1){return{substFormat:1,coverage:this.parsePointer(wu.coverage),chainRuleSets:this.parseListOfLists(function(){return{backtrack:this.parseUShortList(),input:this.parseUShortList(this.parseShort()-1),lookahead:this.parseUShortList(),lookupRecords:this.parseRecordList(Uh)}})}}else if(n===2){return{substFormat:2,coverage:this.parsePointer(wu.coverage),backtrackClassDef:this.parsePointer(wu.classDef),inputClassDef:this.parsePointer(wu.classDef),lookaheadClassDef:this.parsePointer(wu.classDef),chainClassSet:this.parseListOfLists(function(){return{backtrack:this.parseUShortList(),input:this.parseUShortList(this.parseShort()-1),lookahead:this.parseUShortList(),lookupRecords:this.parseRecordList(Uh)}})}}else if(n===3){return{substFormat:3,backtrackCoverage:this.parseList(wu.pointer(wu.coverage)),inputCoverage:this.parseList(wu.pointer(wu.coverage)),lookaheadCoverage:this.parseList(wu.pointer(wu.coverage)),lookupRecords:this.parseRecordList(Uh)}}Wl.assert(false,"0x"+t.toString(16)+": lookup type 6 format must be 1, 2 or 3.")};Rh[7]=function e(){var t=this.parseUShort();Wl.argument(t===1,"GSUB Extension Substitution subtable identifier-format must be 1");var n=this.parseUShort();var r=new wu(this.data,this.offset+this.parseULong());return{substFormat:1,lookupType:n,extension:Rh[n].call(r)}};Rh[8]=function e(){var t=this.parseUShort();Wl.argument(t===1,"GSUB Reverse Chaining Contextual Single Substitution Subtable identifier-format must be 1");return{substFormat:t,coverage:this.parsePointer(wu.coverage),backtrackCoverage:this.parseList(wu.pointer(wu.coverage)),lookaheadCoverage:this.parseList(wu.pointer(wu.coverage)),substitutes:this.parseUShortList()}};function Dh(e,t){t=t||0;var n=new wu(e,t);var r=n.parseVersion();Wl.argument(r===1,"Unsupported GSUB table version.");return{version:r,scripts:n.parseScriptList(),features:n.parseFeatureList(),lookups:n.parseLookupList(Rh)}}var Lh=new Array(9);Lh[1]=function e(t){if(t.substFormat===1){return new du.Table("substitutionTable",[{name:"substFormat",type:"USHORT",value:1},{name:"coverage",type:"TABLE",value:new du.Coverage(t.coverage)},{name:"deltaGlyphID",type:"USHORT",value:t.deltaGlyphId}])}else{return new du.Table("substitutionTable",[{name:"substFormat",type:"USHORT",value:2},{name:"coverage",type:"TABLE",value:new du.Coverage(t.coverage)}].concat(du.ushortList("substitute",t.substitute)))}Wl.fail("Lookup type 1 substFormat must be 1 or 2.")};Lh[3]=function e(t){Wl.assert(t.substFormat===1,"Lookup type 3 substFormat must be 1.");return new du.Table("substitutionTable",[{name:"substFormat",type:"USHORT",value:1},{name:"coverage",type:"TABLE",value:new du.Coverage(t.coverage)}].concat(du.tableList("altSet",t.alternateSets,function(e){return new du.Table("alternateSetTable",du.ushortList("alternate",e))})))};Lh[4]=function e(t){Wl.assert(t.substFormat===1,"Lookup type 4 substFormat must be 1.");return new du.Table("substitutionTable",[{name:"substFormat",type:"USHORT",value:1},{name:"coverage",type:"TABLE",value:new du.Coverage(t.coverage)}].concat(du.tableList("ligSet",t.ligatureSets,function(e){return new du.Table("ligatureSetTable",du.tableList("ligature",e,function(e){return new du.Table("ligatureTable",[{name:"ligGlyph",type:"USHORT",value:e.ligGlyph}].concat(du.ushortList("component",e.components,e.components.length+1)))}))})))};function Oh(e){return new du.Table("GSUB",[{name:"version",type:"ULONG",value:65536},{name:"scripts",type:"TABLE",value:new du.ScriptList(e.scripts)},{name:"features",type:"TABLE",value:new du.FeatureList(e.features)},{name:"lookups",type:"TABLE",value:new du.LookupList(e.lookups,Lh)}])}var Ih={parse:Dh,make:Oh};function Ch(e,t){var n=new Au.Parser(e,t);var r=n.parseULong();Wl.argument(r===1,"Unsupported META table version.");n.parseULong();n.parseULong();var i=n.parseULong();var a={};for(var s=0;s<i;s++){var o=n.parseTag();var l=n.parseULong();var u=n.parseULong();var f=ql.UTF8(e,t+l,u);a[o]=f}return a}function Ph(e){var t=Object.keys(e).length;var n="";var r=16+t*12;var i=new du.Table("meta",[{name:"version",type:"ULONG",value:1},{name:"flags",type:"ULONG",value:0},{name:"offset",type:"ULONG",value:r},{name:"numTags",type:"ULONG",value:t}]);for(var a in e){var s=n.length;n+=e[a];i.fields.push({name:"tag "+a,type:"TAG",value:a});i.fields.push({name:"offset "+a,type:"ULONG",value:r+s});i.fields.push({name:"length "+a,type:"ULONG",value:e[a].length})}i.fields.push({name:"stringPool",type:"CHARARRAY",value:n});return i}var Bh={parse:Ch,make:Ph};function Fh(e){return Math.log(e)/Math.log(2)|0}function zh(e){while(e.length%4!==0){e.push(0)}var t=0;for(var n=0;n<e.length;n+=4){t+=(e[n]<<24)+(e[n+1]<<16)+(e[n+2]<<8)+e[n+3]}t%=Math.pow(2,32);return t}function kh(e,t,n,r){return new du.Record("Table Record",[{name:"tag",type:"TAG",value:e!==undefined?e:""},{name:"checkSum",type:"ULONG",value:t!==undefined?t:0},{name:"offset",type:"ULONG",value:n!==undefined?n:0},{name:"length",type:"ULONG",value:r!==undefined?r:0}])}function Nh(e){var t=new du.Table("sfnt",[{name:"version",type:"TAG",value:"OTTO"},{name:"numTables",type:"USHORT",value:0},{name:"searchRange",type:"USHORT",value:0},{name:"entrySelector",type:"USHORT",value:0},{name:"rangeShift",type:"USHORT",value:0}]);t.tables=e;t.numTables=e.length;var n=Math.pow(2,Fh(t.numTables));t.searchRange=16*n;t.entrySelector=Fh(n);t.rangeShift=t.numTables*16-t.searchRange;var r=[];var i=[];var a=t.sizeOf()+kh().sizeOf()*t.numTables;while(a%4!==0){a+=1;i.push({name:"padding",type:"BYTE",value:0})}for(var s=0;s<e.length;s+=1){var o=e[s];Wl.argument(o.tableName.length===4,"Table name"+o.tableName+" is invalid.");var l=o.sizeOf();var u=kh(o.tableName,zh(o.encode()),a,l);r.push({name:u.tag+" Table Record",type:"RECORD",value:u});i.push({name:o.tableName+" table",type:"RECORD",value:o});a+=l;Wl.argument(!isNaN(a),"Something went wrong calculating the offset.");while(a%4!==0){a+=1;i.push({name:"padding",type:"BYTE",value:0})}}r.sort(function(e,t){if(e.value.tag>t.value.tag){return 1}else{return-1}});t.fields=t.fields.concat(r);t.fields=t.fields.concat(i);return t}function Gh(e,t,n){for(var r=0;r<t.length;r+=1){var i=e.charToGlyphIndex(t[r]);if(i>0){var a=e.glyphs.get(i);return a.getMetrics()}}return n}function Vh(e){var t=0;for(var n=0;n<e.length;n+=1){t+=e[n]}return t/e.length}function Hh(e){var t=[];var n=[];var r=[];var i=[];var a=[];var s=[];var o=[];var l;var u=0;var f=0;var h=0;var c=0;var p=0;for(var d=0;d<e.glyphs.length;d+=1){var m=e.glyphs.get(d);var _=m.unicode|0;if(isNaN(m.advanceWidth)){throw new Error("Glyph "+m.name+" ("+d+"): advanceWidth is not a number.")}if(l>_||l===undefined){if(_>0){l=_}}if(u<_){u=_}var v=Eh.getUnicodeRange(_);if(v<32){f|=1<<v}else if(v<64){h|=1<<v-32}else if(v<96){c|=1<<v-64}else if(v<123){p|=1<<v-96}else{throw new Error("Unicode ranges bits > 123 are reserved for internal usage")}if(m.name===".notdef"){continue}var g=m.getMetrics();t.push(g.xMin);n.push(g.yMin);r.push(g.xMax);i.push(g.yMax);s.push(g.leftSideBearing);o.push(g.rightSideBearing);a.push(m.advanceWidth)}var y={xMin:Math.min.apply(null,t),yMin:Math.min.apply(null,n),xMax:Math.max.apply(null,r),yMax:Math.max.apply(null,i),advanceWidthMax:Math.max.apply(null,a),advanceWidthAvg:Vh(a),minLeftSideBearing:Math.min.apply(null,s),maxLeftSideBearing:Math.max.apply(null,s),minRightSideBearing:Math.min.apply(null,o)};y.ascender=e.ascender;y.descender=e.descender;var b=Xf.make({flags:3,unitsPerEm:e.unitsPerEm,xMin:y.xMin,yMin:y.yMin,xMax:y.xMax,yMax:y.yMax,lowestRecPPEM:3,createdTimestamp:e.createdTimestamp});var x=Yf.make({ascender:y.ascender,descender:y.descender,advanceWidthMax:y.advanceWidthMax,minLeftSideBearing:y.minLeftSideBearing,minRightSideBearing:y.minRightSideBearing,xMaxExtent:y.maxLeftSideBearing+(y.xMax-y.xMin),numberOfHMetrics:e.glyphs.length});var T=rh.make(e.glyphs.length);var S=Eh.make({xAvgCharWidth:Math.round(y.advanceWidthAvg),usWeightClass:e.tables.os2.usWeightClass,usWidthClass:e.tables.os2.usWidthClass,usFirstCharIndex:l,usLastCharIndex:u,ulUnicodeRange1:f,ulUnicodeRange2:h,ulUnicodeRange3:c,ulUnicodeRange4:p,fsSelection:e.tables.os2.fsSelection,sTypoAscender:y.ascender,sTypoDescender:y.descender,sTypoLineGap:0,usWinAscent:y.yMax,usWinDescent:Math.abs(y.yMin),ulCodePageRange1:1,sxHeight:Gh(e,"xyvw",{yMax:Math.round(y.ascender/2)}).yMax,sCapHeight:Gh(e,"HIKLEFJMNTZBDPRAGOQSUVWXY",y).yMax,usDefaultChar:e.hasChar(" ")?32:0,usBreakChar:e.hasChar(" ")?32:0});var E=Jf.make(e.glyphs);var w=Cu.make(e.glyphs);var M=e.getEnglishName("fontFamily");var A=e.getEnglishName("fontSubfamily");var R=M+" "+A;var U=e.getEnglishName("postScriptName");if(!U){U=M.replace(/\s/g,"")+"-"+A}var D={};for(var L in e.names){D[L]=e.names[L]}if(!D.uniqueID){D.uniqueID={en:e.getEnglishName("manufacturer")+":"+R}}if(!D.postScriptName){D.postScriptName={en:U}}if(!D.preferredFamily){D.preferredFamily=e.names.fontFamily}if(!D.preferredSubfamily){D.preferredSubfamily=e.names.fontSubfamily}var O=[];var I=yh.make(D,O);var C=O.length>0?eh.make(O):undefined;var P=Ah.make();var B=Vf.make(e.glyphs,{version:e.getEnglishName("version"),fullName:R,familyName:M,weightName:A,postScriptName:U,unitsPerEm:e.unitsPerEm,fontBBox:[0,y.yMin,y.ascender,y.advanceWidthMax]});var F=e.metas&&Object.keys(e.metas).length>0?Bh.make(e.metas):undefined;var z=[b,x,T,S,I,w,P,B,E];if(C){z.push(C)}if(e.tables.gsub){z.push(Ih.make(e.tables.gsub))}if(F){z.push(F)}var k=Nh(z);var N=k.encode();var G=zh(N);var V=k.fields;var H=false;for(var W=0;W<V.length;W+=1){if(V[W].name==="head table"){V[W].value.checkSumAdjustment=2981146554-G;H=true;break}}if(!H){throw new Error("Could not find head table with checkSum to adjust.")}return k}var Wh={make:Nh,fontToTable:Hh,computeCheckSum:zh};function Xh(e,t){var n=0;var r=e.length-1;while(n<=r){var i=n+r>>>1;var a=e[i].tag;if(a===t){return i}else if(a<t){n=i+1}else{r=i-1}}return-n-1}function jh(e,t){var n=0;var r=e.length-1;while(n<=r){var i=n+r>>>1;var a=e[i];if(a===t){return i}else if(a<t){n=i+1}else{r=i-1}}return-n-1}function qh(e,t){this.font=e;this.tableName=t}qh.prototype={searchTag:Xh,binSearch:jh,getTable:function(e){var t=this.font.tables[this.tableName];if(!t&&e){t=this.font.tables[this.tableName]=this.createDefaultTable()}return t},getScriptNames:function(){var e=this.getTable();if(!e){return[]}return e.scripts.map(function(e){return e.tag})},getDefaultScriptName:function(){var e=this.getTable();if(!e){return}var t=false;for(var n=0;n<e.scripts.length;n++){var r=e.scripts[n].tag;if(r==="DFLT"){return r}if(r==="latn"){t=true}}if(t){return"latn"}},getScriptTable:function(e,t){var n=this.getTable(t);if(n){e=e||"DFLT";var r=n.scripts;var i=Xh(n.scripts,e);if(i>=0){return r[i].script}else if(t){var a={tag:e,script:{defaultLangSys:{reserved:0,reqFeatureIndex:65535,featureIndexes:[]},langSysRecords:[]}};r.splice(-1-i,0,a);return a.script}}},getLangSysTable:function(e,t,n){var r=this.getScriptTable(e,n);if(r){if(!t||t==="dflt"||t==="DFLT"){return r.defaultLangSys}var i=Xh(r.langSysRecords,t);if(i>=0){return r.langSysRecords[i].langSys}else if(n){var a={tag:t,langSys:{reserved:0,reqFeatureIndex:65535,featureIndexes:[]}};r.langSysRecords.splice(-1-i,0,a);return a.langSys}}},getFeatureTable:function(e,t,n,r){var i=this.getLangSysTable(e,t,r);if(i){var a;var s=i.featureIndexes;var o=this.font.tables[this.tableName].features;for(var l=0;l<s.length;l++){a=o[s[l]];if(a.tag===n){return a.feature}}if(r){var u=o.length;Wl.assert(u===0||n>=o[u-1].tag,"Features must be added in alphabetical order.");a={tag:n,feature:{params:0,lookupListIndexes:[]}};o.push(a);s.push(u);return a.feature}}},getLookupTables:function(e,t,n,r,i){var a=this.getFeatureTable(e,t,n,i);var s=[];if(a){var o;var l=a.lookupListIndexes;var u=this.font.tables[this.tableName].lookups;for(var f=0;f<l.length;f++){o=u[l[f]];if(o.lookupType===r){s.push(o)}}if(s.length===0&&i){o={lookupType:r,lookupFlag:0,subtables:[],markFilteringSet:undefined};var h=u.length;u.push(o);l.push(h);return[o]}}return s},expandCoverage:function(e){if(e.format===1){return e.glyphs}else{var t=[];var n=e.ranges;for(var r=0;r<n.length;r++){var i=n[r];var a=i.start;var s=i.end;for(var o=a;o<=s;o++){t.push(o)}}return t}}};function Yh(e){qh.call(this,e,"gsub")}function Kh(e,t){var n=e.length;if(n!==t.length){return false}for(var r=0;r<n;r++){if(e[r]!==t[r]){return false}}return true}function Zh(e,t,n){var r=e.subtables;for(var i=0;i<r.length;i++){var a=r[i];if(a.substFormat===t){return a}}if(n){r.push(n);return n}return undefined}Yh.prototype=qh.prototype;Yh.prototype.createDefaultTable=function(){return{version:1,scripts:[{tag:"DFLT",script:{defaultLangSys:{reserved:0,reqFeatureIndex:65535,featureIndexes:[]},langSysRecords:[]}}],features:[],lookups:[]}};Yh.prototype.getSingle=function(e,t,n){var r=this;var i=[];var a=this.getLookupTables(t,n,e,1);for(var s=0;s<a.length;s++){var o=a[s].subtables;for(var l=0;l<o.length;l++){var u=o[l];var f=r.expandCoverage(u.coverage);var h=void 0;if(u.substFormat===1){var c=u.deltaGlyphId;for(h=0;h<f.length;h++){var p=f[h];i.push({sub:p,by:p+c})}}else{var d=u.substitute;for(h=0;h<f.length;h++){i.push({sub:f[h],by:d[h]})}}}}return i};Yh.prototype.getAlternates=function(e,t,n){var r=this;var i=[];var a=this.getLookupTables(t,n,e,3);for(var s=0;s<a.length;s++){var o=a[s].subtables;for(var l=0;l<o.length;l++){var u=o[l];var f=r.expandCoverage(u.coverage);var h=u.alternateSets;for(var c=0;c<f.length;c++){i.push({sub:f[c],by:h[c]})}}}return i};Yh.prototype.getLigatures=function(e,t,n){var r=this;var i=[];var a=this.getLookupTables(t,n,e,4);for(var s=0;s<a.length;s++){var o=a[s].subtables;for(var l=0;l<o.length;l++){var u=o[l];var f=r.expandCoverage(u.coverage);var h=u.ligatureSets;for(var c=0;c<f.length;c++){var p=f[c];var d=h[c];for(var m=0;m<d.length;m++){var _=d[m];i.push({sub:[p].concat(_.components),by:_.ligGlyph})}}}}return i};Yh.prototype.addSingle=function(e,t,n,r){var i=this.getLookupTables(n,r,e,1,true)[0];var a=Zh(i,2,{substFormat:2,coverage:{format:1,glyphs:[]},substitute:[]});Wl.assert(a.coverage.format===1,"Ligature: unable to modify coverage table format "+a.coverage.format);var s=t.sub;var o=this.binSearch(a.coverage.glyphs,s);if(o<0){o=-1-o;a.coverage.glyphs.splice(o,0,s);a.substitute.splice(o,0,0)}a.substitute[o]=t.by};Yh.prototype.addAlternate=function(e,t,n,r){var i=this.getLookupTables(n,r,e,3,true)[0];var a=Zh(i,1,{substFormat:1,coverage:{format:1,glyphs:[]},alternateSets:[]});Wl.assert(a.coverage.format===1,"Ligature: unable to modify coverage table format "+a.coverage.format);var s=t.sub;var o=this.binSearch(a.coverage.glyphs,s);if(o<0){o=-1-o;a.coverage.glyphs.splice(o,0,s);a.alternateSets.splice(o,0,0)}a.alternateSets[o]=t.by};Yh.prototype.addLigature=function(e,t,n,r){var i=this.getLookupTables(n,r,e,4,true)[0];var a=i.subtables[0];if(!a){a={substFormat:1,coverage:{format:1,glyphs:[]},ligatureSets:[]};i.subtables[0]=a}Wl.assert(a.coverage.format===1,"Ligature: unable to modify coverage table format "+a.coverage.format);var s=t.sub[0];var o=t.sub.slice(1);var l={ligGlyph:t.by,components:o};var u=this.binSearch(a.coverage.glyphs,s);if(u>=0){var f=a.ligatureSets[u];for(var h=0;h<f.length;h++){if(Kh(f[h].components,o)){return}}f.push(l)}else{u=-1-u;a.coverage.glyphs.splice(u,0,s);a.ligatureSets.splice(u,0,[l])}};Yh.prototype.getFeature=function(e,t,n){if(/ss\d\d/.test(e)){return this.getSingle(e,t,n)}switch(e){case"aalt":case"salt":return this.getSingle(e,t,n).concat(this.getAlternates(e,t,n));case"dlig":case"liga":case"rlig":return this.getLigatures(e,t,n)}return undefined};Yh.prototype.add=function(e,t,n,r){if(/ss\d\d/.test(e)){return this.addSingle(e,t,n,r)}switch(e){case"aalt":case"salt":if(typeof t.by==="number"){return this.addSingle(e,t,n,r)}return this.addAlternate(e,t,n,r);case"dlig":case"liga":case"rlig":return this.addLigature(e,t,n,r)}return undefined};function Jh(){return typeof window!=="undefined"}function Qh(e){var t=new Buffer(e.byteLength);var n=new Uint8Array(e);for(var r=0;r<t.length;++r){t[r]=n[r]}return t}function $h(e,t){if(!e){throw t}}var ec;var tc;var nc;var rc;function ic(e){this.font=e;this._fpgmState=this._prepState=undefined;this._errorState=0}function ac(e){return e}function sc(e){return Math.sign(e)*Math.round(Math.abs(e))}function oc(e){return Math.sign(e)*Math.round(Math.abs(e*2))/2}function lc(e){return Math.sign(e)*(Math.round(Math.abs(e)+.5)-.5)}function uc(e){return Math.sign(e)*Math.ceil(Math.abs(e))}function fc(e){return Math.sign(e)*Math.floor(Math.abs(e))}var hc=function(e){var t=this.srPeriod;var n=this.srPhase;var r=this.srThreshold;var i=1;if(e<0){e=-e;i=-1}e+=r-n;e=Math.trunc(e/t)*t;e+=n;if(i>0&&e<0){return n}if(i<0&&e>0){return-n}return e*i};var cc={x:1,y:0,axis:"x",distance:function(e,t,n,r){return(n?e.xo:e.x)-(r?t.xo:t.x)},interpolate:function(e,t,n,r){var i;var a;var s;var o;var l;var u;var f;if(!r||r===this){i=e.xo-t.xo;a=e.xo-n.xo;l=t.x-t.xo;u=n.x-n.xo;s=Math.abs(i);o=Math.abs(a);f=s+o;if(f===0){e.x=e.xo+(l+u)/2;return}e.x=e.xo+(l*o+u*s)/f;return}i=r.distance(e,t,true,true);a=r.distance(e,n,true,true);l=r.distance(t,t,false,true);u=r.distance(n,n,false,true);s=Math.abs(i);o=Math.abs(a);f=s+o;if(f===0){cc.setRelative(e,e,(l+u)/2,r,true);return}cc.setRelative(e,e,(l*o+u*s)/f,r,true)},normalSlope:Number.NEGATIVE_INFINITY,setRelative:function(e,t,n,r,i){if(!r||r===this){e.x=(i?t.xo:t.x)+n;return}var a=i?t.xo:t.x;var s=i?t.yo:t.y;var o=a+n*r.x;var l=s+n*r.y;e.x=o+(e.y-l)/r.normalSlope},slope:0,touch:function(e){e.xTouched=true},touched:function(e){return e.xTouched},untouch:function(e){e.xTouched=false}};var pc={x:0,y:1,axis:"y",distance:function(e,t,n,r){return(n?e.yo:e.y)-(r?t.yo:t.y)},interpolate:function(e,t,n,r){var i;var a;var s;var o;var l;var u;var f;if(!r||r===this){i=e.yo-t.yo;a=e.yo-n.yo;l=t.y-t.yo;u=n.y-n.yo;s=Math.abs(i);o=Math.abs(a);f=s+o;if(f===0){e.y=e.yo+(l+u)/2;return}e.y=e.yo+(l*o+u*s)/f;return}i=r.distance(e,t,true,true);a=r.distance(e,n,true,true);l=r.distance(t,t,false,true);u=r.distance(n,n,false,true);s=Math.abs(i);o=Math.abs(a);f=s+o;if(f===0){pc.setRelative(e,e,(l+u)/2,r,true);return}pc.setRelative(e,e,(l*o+u*s)/f,r,true)},normalSlope:0,setRelative:function(e,t,n,r,i){if(!r||r===this){e.y=(i?t.yo:t.y)+n;return}var a=i?t.xo:t.x;var s=i?t.yo:t.y;var o=a+n*r.x;var l=s+n*r.y;e.y=l+r.normalSlope*(e.x-o)},slope:Number.POSITIVE_INFINITY,touch:function(e){e.yTouched=true},touched:function(e){return e.yTouched},untouch:function(e){e.yTouched=false}};Object.freeze(cc);Object.freeze(pc);function dc(e,t){this.x=e;this.y=t;this.axis=undefined;this.slope=t/e;this.normalSlope=-e/t;Object.freeze(this)}dc.prototype.distance=function(e,t,n,r){return this.x*cc.distance(e,t,n,r)+this.y*pc.distance(e,t,n,r)};dc.prototype.interpolate=function(e,t,n,r){var i;var a;var s;var o;var l;var u;var f;s=r.distance(e,t,true,true);o=r.distance(e,n,true,true);i=r.distance(t,t,false,true);a=r.distance(n,n,false,true);l=Math.abs(s);u=Math.abs(o);f=l+u;if(f===0){this.setRelative(e,e,(i+a)/2,r,true);return}this.setRelative(e,e,(i*u+a*l)/f,r,true)};dc.prototype.setRelative=function(e,t,n,r,i){r=r||this;var a=i?t.xo:t.x;var s=i?t.yo:t.y;var o=a+n*r.x;var l=s+n*r.y;var u=r.normalSlope;var f=this.slope;var h=e.x;var c=e.y;e.x=(f*h-u*o+l-c)/(f-u);e.y=f*(e.x-h)+c};dc.prototype.touch=function(e){e.xTouched=true;e.yTouched=true};function mc(e,t){var n=Math.sqrt(e*e+t*t);e/=n;t/=n;if(e===1&&t===0){return cc}else if(e===0&&t===1){return pc}else{return new dc(e,t)}}function _c(e,t,n,r){this.x=this.xo=Math.round(e*64)/64;this.y=this.yo=Math.round(t*64)/64;this.lastPointOfContour=n;this.onCurve=r;this.prevPointOnContour=undefined;this.nextPointOnContour=undefined;this.xTouched=false;this.yTouched=false;Object.preventExtensions(this)}_c.prototype.nextTouched=function(e){var t=this.nextPointOnContour;while(!e.touched(t)&&t!==this){t=t.nextPointOnContour}return t};_c.prototype.prevTouched=function(e){var t=this.prevPointOnContour;while(!e.touched(t)&&t!==this){t=t.prevPointOnContour}return t};var vc=Object.freeze(new _c(0,0));var gc={cvCutIn:17/16,deltaBase:9,deltaShift:.125,loop:1,minDis:1,autoFlip:true};function yc(e,t){this.env=e;this.stack=[];this.prog=t;switch(e){case"glyf":this.zp0=this.zp1=this.zp2=1;this.rp0=this.rp1=this.rp2=0;case"prep":this.fv=this.pv=this.dpv=cc;this.round=sc}}ic.prototype.exec=function(e,t){if(typeof t!=="number"){throw new Error("Point size is not a number!")}if(this._errorState>2){return}var n=this.font;var r=this._prepState;if(!r||r.ppem!==t){var i=this._fpgmState;if(!i){yc.prototype=gc;i=this._fpgmState=new yc("fpgm",n.tables.fpgm);i.funcs=[];i.font=n;if(exports.DEBUG){console.log("---EXEC FPGM---");i.step=-1}try{tc(i)}catch(e){console.log("Hinting error in FPGM:"+e);this._errorState=3;return}}yc.prototype=i;r=this._prepState=new yc("prep",n.tables.prep);r.ppem=t;var a=n.tables.cvt;if(a){var s=r.cvt=new Array(a.length);var o=t/n.unitsPerEm;for(var l=0;l<a.length;l++){s[l]=a[l]*o}}else{r.cvt=[]}if(exports.DEBUG){console.log("---EXEC PREP---");r.step=-1}try{tc(r)}catch(e){if(this._errorState<2){console.log("Hinting error in PREP:"+e)}this._errorState=2}}if(this._errorState>1){return}try{return nc(e,r)}catch(e){if(this._errorState<1){console.log("Hinting error:"+e);console.log("Note: further hinting errors are silenced")}this._errorState=1;return undefined}};nc=function(e,t){var n=t.ppem/t.font.unitsPerEm;var r=n;var i=e.components;var a;var s;var o;yc.prototype=t;if(!i){o=new yc("glyf",e.instructions);if(exports.DEBUG){console.log("---EXEC GLYPH---");o.step=-1}rc(e,o,n,r);s=o.gZone}else{var l=t.font;s=[];a=[];for(var u=0;u<i.length;u++){var f=i[u];var h=l.glyphs.get(f.glyphIndex);o=new yc("glyf",h.instructions);if(exports.DEBUG){console.log("---EXEC COMP "+u+"---");o.step=-1}rc(h,o,n,r);var c=Math.round(f.dx*n);var p=Math.round(f.dy*r);var d=o.gZone;var m=o.contours;for(var _=0;_<d.length;_++){var v=d[_];v.xTouched=v.yTouched=false;v.xo=v.x=v.x+c;v.yo=v.y=v.y+p}var g=s.length;s.push.apply(s,d);for(var y=0;y<m.length;y++){a.push(m[y]+g)}}if(e.instructions&&!o.inhibitGridFit){o=new yc("glyf",e.instructions);o.gZone=o.z0=o.z1=o.z2=s;o.contours=a;s.push(new _c(0,0),new _c(Math.round(e.advanceWidth*n),0));if(exports.DEBUG){console.log("---EXEC COMPOSITE---");o.step=-1}tc(o);s.length-=2}}return s};rc=function(e,t,n,r){var i=e.points||[];var a=i.length;var s=t.gZone=t.z0=t.z1=t.z2=[];var o=t.contours=[];var l;for(var u=0;u<a;u++){l=i[u];s[u]=new _c(l.x*n,l.y*r,l.lastPointOfContour,l.onCurve)}var f;var h;for(var c=0;c<a;c++){l=s[c];if(!f){f=l;o.push(c)}if(l.lastPointOfContour){l.nextPointOnContour=f;f.prevPointOnContour=l;f=undefined}else{h=s[c+1];l.nextPointOnContour=h;h.prevPointOnContour=l}}if(t.inhibitGridFit){return}s.push(new _c(0,0),new _c(Math.round(e.advanceWidth*n),0));tc(t);s.length-=2;if(exports.DEBUG){console.log("FINISHED GLYPH",t.stack);for(var p=0;p<a;p++){console.log(p,s[p].x,s[p].y)}}};tc=function(e){var t=e.prog;if(!t){return}var n=t.length;var r;for(e.ip=0;e.ip<n;e.ip++){if(exports.DEBUG){e.step++}r=ec[t[e.ip]];if(!r){throw new Error("unknown instruction: 0x"+Number(t[e.ip]).toString(16))}r(e)}};function bc(e){var t=e.tZone=new Array(e.gZone.length);for(var n=0;n<t.length;n++){t[n]=new _c(0,0)}}function xc(e,t){var n=e.prog;var r=e.ip;var i=1;var a;do{a=n[++r];if(a===88){i++}else if(a===89){i--}else if(a===64){r+=n[r+1]+1}else if(a===65){r+=2*n[r+1]+1}else if(a>=176&&a<=183){r+=a-176+1}else if(a>=184&&a<=191){r+=(a-184+1)*2}else if(t&&i===1&&a===27){break}}while(i>0);e.ip=r}function Tc(e,t){if(exports.DEBUG){console.log(t.step,"SVTCA["+e.axis+"]")}t.fv=t.pv=t.dpv=e}function Sc(e,t){if(exports.DEBUG){console.log(t.step,"SPVTCA["+e.axis+"]")}t.pv=t.dpv=e}function Ec(e,t){if(exports.DEBUG){console.log(t.step,"SFVTCA["+e.axis+"]")}t.fv=e}function wc(e,t){var n=t.stack;var r=n.pop();var i=n.pop();var a=t.z2[r];var s=t.z1[i];if(exports.DEBUG){console.log("SPVTL["+e+"]",r,i)}var o;var l;if(!e){o=s.x-a.x;l=s.y-a.y}else{o=a.y-s.y;l=s.x-a.x}t.pv=t.dpv=mc(o,l)}function Mc(e,t){var n=t.stack;var r=n.pop();var i=n.pop();var a=t.z2[r];var s=t.z1[i];if(exports.DEBUG){console.log("SFVTL["+e+"]",r,i)}var o;var l;if(!e){o=s.x-a.x;l=s.y-a.y}else{o=a.y-s.y;l=s.x-a.x}t.fv=mc(o,l)}function Ac(e){var t=e.stack;var n=t.pop();var r=t.pop();if(exports.DEBUG){console.log(e.step,"SPVFS[]",n,r)}e.pv=e.dpv=mc(r,n)}function Rc(e){var t=e.stack;var n=t.pop();var r=t.pop();if(exports.DEBUG){console.log(e.step,"SPVFS[]",n,r)}e.fv=mc(r,n)}function Uc(e){var t=e.stack;var n=e.pv;if(exports.DEBUG){console.log(e.step,"GPV[]")}t.push(n.x*16384);t.push(n.y*16384)}function Dc(e){var t=e.stack;var n=e.fv;if(exports.DEBUG){console.log(e.step,"GFV[]")}t.push(n.x*16384);t.push(n.y*16384)}function Lc(e){e.fv=e.pv;if(exports.DEBUG){console.log(e.step,"SFVTPV[]")}}function Oc(e){var t=e.stack;var n=t.pop();var r=t.pop();var i=t.pop();var a=t.pop();var s=t.pop();var o=e.z0;var l=e.z1;var u=o[n];var f=o[r];var h=l[i];var c=l[a];var p=e.z2[s];if(exports.DEBUG){console.log("ISECT[], ",n,r,i,a,s)}var d=u.x;var m=u.y;var _=f.x;var v=f.y;var g=h.x;var y=h.y;var b=c.x;var x=c.y;var T=(d-_)*(y-x)-(m-v)*(g-b);var S=d*v-m*_;var E=g*x-y*b;p.x=(S*(g-b)-E*(d-_))/T;p.y=(S*(y-x)-E*(m-v))/T}function Ic(e){e.rp0=e.stack.pop();if(exports.DEBUG){console.log(e.step,"SRP0[]",e.rp0)}}function Cc(e){e.rp1=e.stack.pop();if(exports.DEBUG){console.log(e.step,"SRP1[]",e.rp1)}}function Pc(e){e.rp2=e.stack.pop();if(exports.DEBUG){console.log(e.step,"SRP2[]",e.rp2)}}function Bc(e){var t=e.stack.pop();if(exports.DEBUG){console.log(e.step,"SZP0[]",t)}e.zp0=t;switch(t){case 0:if(!e.tZone){bc(e)}e.z0=e.tZone;break;case 1:e.z0=e.gZone;break;default:throw new Error("Invalid zone pointer")}}function Fc(e){var t=e.stack.pop();if(exports.DEBUG){console.log(e.step,"SZP1[]",t)}e.zp1=t;switch(t){case 0:if(!e.tZone){bc(e)}e.z1=e.tZone;break;case 1:e.z1=e.gZone;break;default:throw new Error("Invalid zone pointer")}}function zc(e){var t=e.stack.pop();if(exports.DEBUG){console.log(e.step,"SZP2[]",t)}e.zp2=t;switch(t){case 0:if(!e.tZone){bc(e)}e.z2=e.tZone;break;case 1:e.z2=e.gZone;break;default:throw new Error("Invalid zone pointer")}}function kc(e){var t=e.stack.pop();if(exports.DEBUG){console.log(e.step,"SZPS[]",t)}e.zp0=e.zp1=e.zp2=t;switch(t){case 0:if(!e.tZone){bc(e)}e.z0=e.z1=e.z2=e.tZone;break;case 1:e.z0=e.z1=e.z2=e.gZone;break;default:throw new Error("Invalid zone pointer")}}function Nc(e){e.loop=e.stack.pop();if(exports.DEBUG){console.log(e.step,"SLOOP[]",e.loop)}}function Gc(e){if(exports.DEBUG){console.log(e.step,"RTG[]")}e.round=sc}function Vc(e){if(exports.DEBUG){console.log(e.step,"RTHG[]")}e.round=lc}function Hc(e){var t=e.stack.pop();if(exports.DEBUG){console.log(e.step,"SMD[]",t)}e.minDis=t/64}function Wc(e){if(exports.DEBUG){console.log(e.step,"ELSE[]")}xc(e,false)}function Xc(e){var t=e.stack.pop();if(exports.DEBUG){console.log(e.step,"JMPR[]",t)}e.ip+=t-1}function jc(e){var t=e.stack.pop();if(exports.DEBUG){console.log(e.step,"SCVTCI[]",t)}e.cvCutIn=t/64}function qc(e){var t=e.stack;if(exports.DEBUG){console.log(e.step,"DUP[]")}t.push(t[t.length-1])}function Yc(e){if(exports.DEBUG){console.log(e.step,"POP[]")}e.stack.pop()}function Kc(e){if(exports.DEBUG){console.log(e.step,"CLEAR[]")}e.stack.length=0}function Zc(e){var t=e.stack;var n=t.pop();var r=t.pop();if(exports.DEBUG){console.log(e.step,"SWAP[]")}t.push(n);t.push(r)}function Jc(e){var t=e.stack;if(exports.DEBUG){console.log(e.step,"DEPTH[]")}t.push(t.length)}function Qc(e){var t=e.stack;var n=t.pop();var r=t.pop();if(exports.DEBUG){console.log(e.step,"LOOPCALL[]",n,r)}var i=e.ip;var a=e.prog;e.prog=e.funcs[n];for(var s=0;s<r;s++){tc(e);if(exports.DEBUG){console.log(++e.step,s+1<r?"next loopcall":"done loopcall",s)}}e.ip=i;e.prog=a}function $c(e){var t=e.stack.pop();if(exports.DEBUG){console.log(e.step,"CALL[]",t)}var n=e.ip;var r=e.prog;e.prog=e.funcs[t];tc(e);e.ip=n;e.prog=r;if(exports.DEBUG){console.log(++e.step,"returning from",t)}}function ep(e){var t=e.stack;var n=t.pop();if(exports.DEBUG){console.log(e.step,"CINDEX[]",n)}t.push(t[t.length-n])}function tp(e){var t=e.stack;var n=t.pop();if(exports.DEBUG){console.log(e.step,"MINDEX[]",n)}t.push(t.splice(t.length-n,1)[0])}function np(e){if(e.env!=="fpgm"){throw new Error("FDEF not allowed here")}var t=e.stack;var n=e.prog;var r=e.ip;var i=t.pop();var a=r;if(exports.DEBUG){console.log(e.step,"FDEF[]",i)}while(n[++r]!==45){}e.ip=r;e.funcs[i]=n.slice(a+1,r)}function rp(e,t){var n=t.stack.pop();var r=t.z0[n];var i=t.fv;var a=t.pv;if(exports.DEBUG){console.log(t.step,"MDAP["+e+"]",n)}var s=a.distance(r,vc);if(e){s=t.round(s)}i.setRelative(r,vc,s,a);i.touch(r);t.rp0=t.rp1=n}function ip(e,t){var n=t.z2;var r=n.length-2;var i;var a;var s;if(exports.DEBUG){console.log(t.step,"IUP["+e.axis+"]")}for(var o=0;o<r;o++){i=n[o];if(e.touched(i)){continue}a=i.prevTouched(e);if(a===i){continue}s=i.nextTouched(e);if(a===s){e.setRelative(i,i,e.distance(a,a,false,true),e,true)}e.interpolate(i,a,s,e)}}function ap(e,t){var n=t.stack;var r=e?t.rp1:t.rp2;var i=(e?t.z0:t.z1)[r];var a=t.fv;var s=t.pv;var o=t.loop;var l=t.z2;while(o--){var u=n.pop();var f=l[u];var h=s.distance(i,i,false,true);a.setRelative(f,f,h,s);a.touch(f);if(exports.DEBUG){console.log(t.step,(t.loop>1?"loop "+(t.loop-o)+": ":"")+"SHP["+(e?"rp1":"rp2")+"]",u)}}t.loop=1}function sp(e,t){var n=t.stack;var r=e?t.rp1:t.rp2;var i=(e?t.z0:t.z1)[r];var a=t.fv;var s=t.pv;var o=n.pop();var l=t.z2[t.contours[o]];var u=l;if(exports.DEBUG){console.log(t.step,"SHC["+e+"]",o)}var f=s.distance(i,i,false,true);do{if(u!==i){a.setRelative(u,u,f,s)}u=u.nextPointOnContour}while(u!==l)}function op(e,t){var n=t.stack;var r=e?t.rp1:t.rp2;var i=(e?t.z0:t.z1)[r];var a=t.fv;var s=t.pv;var o=n.pop();if(exports.DEBUG){console.log(t.step,"SHZ["+e+"]",o)}var l;switch(o){case 0:l=t.tZone;break;case 1:l=t.gZone;break;default:throw new Error("Invalid zone")}var u;var f=s.distance(i,i,false,true);var h=l.length-2;for(var c=0;c<h;c++){u=l[c];if(u!==i){a.setRelative(u,u,f,s)}}}function lp(e){var t=e.stack;var n=e.loop;var r=e.fv;var i=t.pop()/64;var a=e.z2;while(n--){var s=t.pop();var o=a[s];if(exports.DEBUG){console.log(e.step,(e.loop>1?"loop "+(e.loop-n)+": ":"")+"SHPIX[]",s,i)}r.setRelative(o,o,i);r.touch(o)}e.loop=1}function up(e){var t=e.stack;var n=e.rp1;var r=e.rp2;var i=e.loop;var a=e.z0[n];var s=e.z1[r];var o=e.fv;var l=e.dpv;var u=e.z2;while(i--){var f=t.pop();var h=u[f];if(exports.DEBUG){console.log(e.step,(e.loop>1?"loop "+(e.loop-i)+": ":"")+"IP[]",f,n,"<->",r)}o.interpolate(h,a,s,l);o.touch(h)}e.loop=1}function fp(e,t){var n=t.stack;var r=n.pop()/64;var i=n.pop();var a=t.z1[i];var s=t.z0[t.rp0];var o=t.fv;var l=t.pv;o.setRelative(a,s,r,l);o.touch(a);if(exports.DEBUG){console.log(t.step,"MSIRP["+e+"]",r,i)}t.rp1=t.rp0;t.rp2=i;if(e){t.rp0=i}}function hp(e){var t=e.stack;var n=e.rp0;var r=e.z0[n];var i=e.loop;var a=e.fv;var s=e.pv;var o=e.z1;while(i--){var l=t.pop();var u=o[l];if(exports.DEBUG){console.log(e.step,(e.loop>1?"loop "+(e.loop-i)+": ":"")+"ALIGNRP[]",l)}a.setRelative(u,r,0,s);a.touch(u)}e.loop=1}function cp(e){if(exports.DEBUG){console.log(e.step,"RTDG[]")}e.round=oc}function pp(e,t){var n=t.stack;var r=n.pop();var i=n.pop();var a=t.z0[i];var s=t.fv;var o=t.pv;var l=t.cvt[r];if(e){l=t.round(l)}if(exports.DEBUG){console.log(t.step,"MIAP["+e+"]",r,"(",l,")",i)}s.setRelative(a,vc,l,o);if(t.zp0===0){a.xo=a.x;a.yo=a.y}s.touch(a);t.rp0=t.rp1=i}function dp(e){var t=e.prog;var n=e.ip;var r=e.stack;var i=t[++n];if(exports.DEBUG){console.log(e.step,"NPUSHB[]",i)}for(var a=0;a<i;a++){r.push(t[++n])}e.ip=n}function mp(e){var t=e.ip;var n=e.prog;var r=e.stack;var i=n[++t];if(exports.DEBUG){console.log(e.step,"NPUSHW[]",i)}for(var a=0;a<i;a++){var s=n[++t]<<8|n[++t];if(s&32768){s=-((s^65535)+1)}r.push(s)}e.ip=t}function _p(e){var t=e.stack;var n=e.store;if(!n){n=e.store=[]}var r=t.pop();var i=t.pop();if(exports.DEBUG){console.log(e.step,"WS",r,i)}n[i]=r}function vp(e){var t=e.stack;var n=e.store;var r=t.pop();if(exports.DEBUG){console.log(e.step,"RS",r)}var i=n&&n[r]||0;t.push(i)}function gp(e){var t=e.stack;var n=t.pop();var r=t.pop();if(exports.DEBUG){console.log(e.step,"WCVTP",n,r)}e.cvt[r]=n/64}function yp(e){var t=e.stack;var n=t.pop();if(exports.DEBUG){console.log(e.step,"RCVT",n)}t.push(e.cvt[n]*64)}function bp(e,t){var n=t.stack;var r=n.pop();var i=t.z2[r];if(exports.DEBUG){console.log(t.step,"GC["+e+"]",r)}n.push(t.dpv.distance(i,vc,e,false)*64)}function xp(e,t){var n=t.stack;var r=n.pop();var i=n.pop();var a=t.z1[r];var s=t.z0[i];var o=t.dpv.distance(s,a,e,e);if(exports.DEBUG){console.log(t.step,"MD["+e+"]",r,i,"->",o)}t.stack.push(Math.round(o*64))}function Tp(e){if(exports.DEBUG){console.log(e.step,"MPPEM[]")}e.stack.push(e.ppem)}function Sp(e){if(exports.DEBUG){console.log(e.step,"FLIPON[]")}e.autoFlip=true}function Ep(e){var t=e.stack;var n=t.pop();var r=t.pop();if(exports.DEBUG){console.log(e.step,"LT[]",n,r)}t.push(r<n?1:0)}function wp(e){var t=e.stack;var n=t.pop();var r=t.pop();if(exports.DEBUG){console.log(e.step,"LTEQ[]",n,r)}t.push(r<=n?1:0)}function Mp(e){var t=e.stack;var n=t.pop();var r=t.pop();if(exports.DEBUG){console.log(e.step,"GT[]",n,r)}t.push(r>n?1:0)}function Ap(e){var t=e.stack;var n=t.pop();var r=t.pop();if(exports.DEBUG){console.log(e.step,"GTEQ[]",n,r)}t.push(r>=n?1:0)}function Rp(e){var t=e.stack;var n=t.pop();var r=t.pop();if(exports.DEBUG){console.log(e.step,"EQ[]",n,r)}t.push(n===r?1:0)}function Up(e){var t=e.stack;var n=t.pop();var r=t.pop();if(exports.DEBUG){console.log(e.step,"NEQ[]",n,r)}t.push(n!==r?1:0)}function Dp(e){var t=e.stack;var n=t.pop();if(exports.DEBUG){console.log(e.step,"ODD[]",n)}t.push(Math.trunc(n)%2?1:0)}function Lp(e){var t=e.stack;var n=t.pop();if(exports.DEBUG){console.log(e.step,"EVEN[]",n)}t.push(Math.trunc(n)%2?0:1)}function Op(e){var t=e.stack.pop();var n;if(exports.DEBUG){console.log(e.step,"IF[]",t)}if(!t){xc(e,true);if(exports.DEBUG){console.log(e.step,n===27?"ELSE[]":"EIF[]")}}}function Ip(e){if(exports.DEBUG){console.log(e.step,"EIF[]")}}function Cp(e){var t=e.stack;var n=t.pop();var r=t.pop();if(exports.DEBUG){console.log(e.step,"AND[]",n,r)}t.push(n&&r?1:0)}function Pp(e){var t=e.stack;var n=t.pop();var r=t.pop();if(exports.DEBUG){console.log(e.step,"OR[]",n,r)}t.push(n||r?1:0)}function Bp(e){var t=e.stack;var n=t.pop();if(exports.DEBUG){console.log(e.step,"NOT[]",n)}t.push(n?0:1)}function Fp(e,t){var n=t.stack;var r=n.pop();var i=t.fv;var a=t.pv;var s=t.ppem;var o=t.deltaBase+(e-1)*16;var l=t.deltaShift;var u=t.z0;if(exports.DEBUG){console.log(t.step,"DELTAP["+e+"]",r,n)}for(var f=0;f<r;f++){var h=n.pop();var c=n.pop();var p=o+((c&240)>>4);if(p!==s){continue}var d=(c&15)-8;if(d>=0){d++}if(exports.DEBUG){console.log(t.step,"DELTAPFIX",h,"by",d*l)}var m=u[h];i.setRelative(m,m,d*l,a)}}function zp(e){var t=e.stack;var n=t.pop();if(exports.DEBUG){console.log(e.step,"SDB[]",n)}e.deltaBase=n}function kp(e){var t=e.stack;var n=t.pop();if(exports.DEBUG){console.log(e.step,"SDS[]",n)}e.deltaShift=Math.pow(.5,n)}function Np(e){var t=e.stack;var n=t.pop();var r=t.pop();if(exports.DEBUG){console.log(e.step,"ADD[]",n,r)}t.push(r+n)}function Gp(e){var t=e.stack;var n=t.pop();var r=t.pop();if(exports.DEBUG){console.log(e.step,"SUB[]",n,r)}t.push(r-n)}function Vp(e){var t=e.stack;var n=t.pop();var r=t.pop();if(exports.DEBUG){console.log(e.step,"DIV[]",n,r)}t.push(r*64/n)}function Hp(e){var t=e.stack;var n=t.pop();var r=t.pop();if(exports.DEBUG){console.log(e.step,"MUL[]",n,r)}t.push(r*n/64)}function Wp(e){var t=e.stack;var n=t.pop();if(exports.DEBUG){console.log(e.step,"ABS[]",n)}t.push(Math.abs(n))}function Xp(e){var t=e.stack;var n=t.pop();if(exports.DEBUG){console.log(e.step,"NEG[]",n)}t.push(-n)}function jp(e){var t=e.stack;var n=t.pop();if(exports.DEBUG){console.log(e.step,"FLOOR[]",n)}t.push(Math.floor(n/64)*64)}function qp(e){var t=e.stack;var n=t.pop();if(exports.DEBUG){console.log(e.step,"CEILING[]",n)}t.push(Math.ceil(n/64)*64)}function Yp(e,t){var n=t.stack;var r=n.pop();if(exports.DEBUG){console.log(t.step,"ROUND[]")}n.push(t.round(r/64)*64)}function Kp(e){var t=e.stack;var n=t.pop();var r=t.pop();if(exports.DEBUG){console.log(e.step,"WCVTF[]",n,r)}e.cvt[r]=n*e.ppem/e.font.unitsPerEm}function Zp(e,t){var n=t.stack;var r=n.pop();var i=t.ppem;var a=t.deltaBase+(e-1)*16;var s=t.deltaShift;if(exports.DEBUG){console.log(t.step,"DELTAC["+e+"]",r,n)}for(var o=0;o<r;o++){var l=n.pop();var u=n.pop();var f=a+((u&240)>>4);if(f!==i){continue}var h=(u&15)-8;if(h>=0){h++}var c=h*s;if(exports.DEBUG){console.log(t.step,"DELTACFIX",l,"by",c)}t.cvt[l]+=c}}function Jp(e){var t=e.stack.pop();if(exports.DEBUG){console.log(e.step,"SROUND[]",t)}e.round=hc;var n;switch(t&192){case 0:n=.5;break;case 64:n=1;break;case 128:n=2;break;default:throw new Error("invalid SROUND value")}e.srPeriod=n;switch(t&48){case 0:e.srPhase=0;break;case 16:e.srPhase=.25*n;break;case 32:e.srPhase=.5*n;break;case 48:e.srPhase=.75*n;break;default:throw new Error("invalid SROUND value")}t&=15;if(t===0){e.srThreshold=0}else{e.srThreshold=(t/8-.5)*n}}function Qp(e){var t=e.stack.pop();if(exports.DEBUG){console.log(e.step,"S45ROUND[]",t)}e.round=hc;var n;switch(t&192){case 0:n=Math.sqrt(2)/2;break;case 64:n=Math.sqrt(2);break;case 128:n=2*Math.sqrt(2);break;default:throw new Error("invalid S45ROUND value")}e.srPeriod=n;switch(t&48){case 0:e.srPhase=0;break;case 16:e.srPhase=.25*n;break;case 32:e.srPhase=.5*n;break;case 48:e.srPhase=.75*n;break;default:throw new Error("invalid S45ROUND value")}t&=15;if(t===0){e.srThreshold=0}else{e.srThreshold=(t/8-.5)*n}}function $p(e){if(exports.DEBUG){console.log(e.step,"ROFF[]")}e.round=ac}function ed(e){if(exports.DEBUG){console.log(e.step,"RUTG[]")}e.round=uc}function td(e){if(exports.DEBUG){console.log(e.step,"RDTG[]")}e.round=fc}function nd(e){var t=e.stack.pop();if(exports.DEBUG){console.log(e.step,"SCANCTRL[]",t)}}function rd(e,t){var n=t.stack;var r=n.pop();var i=n.pop();var a=t.z2[r];var s=t.z1[i];if(exports.DEBUG){console.log("SDPVTL["+e+"]",r,i)}var o;var l;if(!e){o=s.x-a.x;l=s.y-a.y}else{o=a.y-s.y;l=s.x-a.x}t.dpv=mc(o,l)}function id(e){var t=e.stack;var n=t.pop();var r=0;if(exports.DEBUG){console.log(e.step,"GETINFO[]",n)}if(n&1){r=35}if(n&32){r|=4096}t.push(r)}function ad(e){var t=e.stack;var n=t.pop();var r=t.pop();var i=t.pop();if(exports.DEBUG){console.log(e.step,"ROLL[]")}t.push(r);t.push(n);t.push(i)}function sd(e){var t=e.stack;var n=t.pop();var r=t.pop();if(exports.DEBUG){console.log(e.step,"MAX[]",n,r)}t.push(Math.max(r,n))}function od(e){var t=e.stack;var n=t.pop();var r=t.pop();if(exports.DEBUG){console.log(e.step,"MIN[]",n,r)}t.push(Math.min(r,n))}function ld(e){var t=e.stack.pop();if(exports.DEBUG){console.log(e.step,"SCANTYPE[]",t)}}function ud(e){var t=e.stack.pop();var n=e.stack.pop();if(exports.DEBUG){console.log(e.step,"INSTCTRL[]",t,n)}switch(t){case 1:e.inhibitGridFit=!!n;return;case 2:e.ignoreCvt=!!n;return;default:throw new Error("invalid INSTCTRL[] selector")}}function fd(e,t){var n=t.stack;var r=t.prog;var i=t.ip;if(exports.DEBUG){console.log(t.step,"PUSHB["+e+"]")}for(var a=0;a<e;a++){n.push(r[++i])}t.ip=i}function hd(e,t){var n=t.ip;var r=t.prog;var i=t.stack;if(exports.DEBUG){console.log(t.ip,"PUSHW["+e+"]")}for(var a=0;a<e;a++){var s=r[++n]<<8|r[++n];if(s&32768){s=-((s^65535)+1)}i.push(s)}t.ip=n}function cd(e,t,n,r,i,a){var s=a.stack;var o=e&&s.pop();var l=s.pop();var u=a.rp0;var f=a.z0[u];var h=a.z1[l];var c=a.minDis;var p=a.fv;var d=a.dpv;var m;var _;var v;var g;_=m=d.distance(h,f,true,true);v=_>=0?1:-1;_=Math.abs(_);if(e){g=a.cvt[o];if(r&&Math.abs(_-g)<a.cvCutIn){_=g}}if(n&&_<c){_=c}if(r){_=a.round(_)}p.setRelative(h,f,v*_,d);p.touch(h);if(exports.DEBUG){console.log(a.step,(e?"MIRP[":"MDRP[")+(t?"M":"m")+(n?">":"_")+(r?"R":"_")+(i===0?"Gr":i===1?"Bl":i===2?"Wh":"")+"]",e?o+"("+a.cvt[o]+","+g+")":"",l,"(d =",m,"->",v*_,")")}a.rp1=a.rp0;a.rp2=l;if(t){a.rp0=l}}ec=[Tc.bind(undefined,pc),Tc.bind(undefined,cc),Sc.bind(undefined,pc),Sc.bind(undefined,cc),Ec.bind(undefined,pc),Ec.bind(undefined,cc),wc.bind(undefined,0),wc.bind(undefined,1),Mc.bind(undefined,0),Mc.bind(undefined,1),Ac,Rc,Uc,Dc,Lc,Oc,Ic,Cc,Pc,Bc,Fc,zc,kc,Nc,Gc,Vc,Hc,Wc,Xc,jc,undefined,undefined,qc,Yc,Kc,Zc,Jc,ep,tp,undefined,undefined,undefined,Qc,$c,np,undefined,rp.bind(undefined,0),rp.bind(undefined,1),ip.bind(undefined,pc),ip.bind(undefined,cc),ap.bind(undefined,0),ap.bind(undefined,1),sp.bind(undefined,0),sp.bind(undefined,1),op.bind(undefined,0),op.bind(undefined,1),lp,up,fp.bind(undefined,0),fp.bind(undefined,1),hp,cp,pp.bind(undefined,0),pp.bind(undefined,1),dp,mp,_p,vp,gp,yp,bp.bind(undefined,0),bp.bind(undefined,1),undefined,xp.bind(undefined,0),xp.bind(undefined,1),Tp,undefined,Sp,undefined,undefined,Ep,wp,Mp,Ap,Rp,Up,Dp,Lp,Op,Ip,Cp,Pp,Bp,Fp.bind(undefined,1),zp,kp,Np,Gp,Vp,Hp,Wp,Xp,jp,qp,Yp.bind(undefined,0),Yp.bind(undefined,1),Yp.bind(undefined,2),Yp.bind(undefined,3),undefined,undefined,undefined,undefined,Kp,Fp.bind(undefined,2),Fp.bind(undefined,3),Zp.bind(undefined,1),Zp.bind(undefined,2),Zp.bind(undefined,3),Jp,Qp,undefined,undefined,$p,undefined,ed,td,Yc,Yc,undefined,undefined,undefined,undefined,undefined,nd,rd.bind(undefined,0),rd.bind(undefined,1),id,undefined,ad,sd,od,ld,ud,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,fd.bind(undefined,1),fd.bind(undefined,2),fd.bind(undefined,3),fd.bind(undefined,4),fd.bind(undefined,5),fd.bind(undefined,6),fd.bind(undefined,7),fd.bind(undefined,8),hd.bind(undefined,1),hd.bind(undefined,2),hd.bind(undefined,3),hd.bind(undefined,4),hd.bind(undefined,5),hd.bind(undefined,6),hd.bind(undefined,7),hd.bind(undefined,8),cd.bind(undefined,0,0,0,0,0),cd.bind(undefined,0,0,0,0,1),cd.bind(undefined,0,0,0,0,2),cd.bind(undefined,0,0,0,0,3),cd.bind(undefined,0,0,0,1,0),cd.bind(undefined,0,0,0,1,1),cd.bind(undefined,0,0,0,1,2),cd.bind(undefined,0,0,0,1,3),cd.bind(undefined,0,0,1,0,0),cd.bind(undefined,0,0,1,0,1),cd.bind(undefined,0,0,1,0,2),cd.bind(undefined,0,0,1,0,3),cd.bind(undefined,0,0,1,1,0),cd.bind(undefined,0,0,1,1,1),cd.bind(undefined,0,0,1,1,2),cd.bind(undefined,0,0,1,1,3),cd.bind(undefined,0,1,0,0,0),cd.bind(undefined,0,1,0,0,1),cd.bind(undefined,0,1,0,0,2),cd.bind(undefined,0,1,0,0,3),cd.bind(undefined,0,1,0,1,0),cd.bind(undefined,0,1,0,1,1),cd.bind(undefined,0,1,0,1,2),cd.bind(undefined,0,1,0,1,3),cd.bind(undefined,0,1,1,0,0),cd.bind(undefined,0,1,1,0,1),cd.bind(undefined,0,1,1,0,2),cd.bind(undefined,0,1,1,0,3),cd.bind(undefined,0,1,1,1,0),cd.bind(undefined,0,1,1,1,1),cd.bind(undefined,0,1,1,1,2),cd.bind(undefined,0,1,1,1,3),cd.bind(undefined,1,0,0,0,0),cd.bind(undefined,1,0,0,0,1),cd.bind(undefined,1,0,0,0,2),cd.bind(undefined,1,0,0,0,3),cd.bind(undefined,1,0,0,1,0),cd.bind(undefined,1,0,0,1,1),cd.bind(undefined,1,0,0,1,2),cd.bind(undefined,1,0,0,1,3),cd.bind(undefined,1,0,1,0,0),cd.bind(undefined,1,0,1,0,1),cd.bind(undefined,1,0,1,0,2),cd.bind(undefined,1,0,1,0,3),cd.bind(undefined,1,0,1,1,0),cd.bind(undefined,1,0,1,1,1),cd.bind(undefined,1,0,1,1,2),cd.bind(undefined,1,0,1,1,3),cd.bind(undefined,1,1,0,0,0),cd.bind(undefined,1,1,0,0,1),cd.bind(undefined,1,1,0,0,2),cd.bind(undefined,1,1,0,0,3),cd.bind(undefined,1,1,0,1,0),cd.bind(undefined,1,1,0,1,1),cd.bind(undefined,1,1,0,1,2),cd.bind(undefined,1,1,0,1,3),cd.bind(undefined,1,1,1,0,0),cd.bind(undefined,1,1,1,0,1),cd.bind(undefined,1,1,1,0,2),cd.bind(undefined,1,1,1,0,3),cd.bind(undefined,1,1,1,1,0),cd.bind(undefined,1,1,1,1,1),cd.bind(undefined,1,1,1,1,2),cd.bind(undefined,1,1,1,1,3)];function pd(e){e=e||{};if(!e.empty){$h(e.familyName,"When creating a new Font object, familyName is required.");$h(e.styleName,"When creating a new Font object, styleName is required.");$h(e.unitsPerEm,"When creating a new Font object, unitsPerEm is required.");$h(e.ascender,"When creating a new Font object, ascender is required.");$h(e.descender,"When creating a new Font object, descender is required.");$h(e.descender<0,"Descender should be negative (e.g. -512).");this.names={fontFamily:{en:e.familyName||" "},fontSubfamily:{en:e.styleName||" "},fullName:{en:e.fullName||e.familyName+" "+e.styleName},postScriptName:{en:e.postScriptName||e.familyName+e.styleName},designer:{en:e.designer||" "},designerURL:{en:e.designerURL||" "},manufacturer:{en:e.manufacturer||" "},manufacturerURL:{en:e.manufacturerURL||" "},license:{en:e.license||" "},licenseURL:{en:e.licenseURL||" "},version:{en:e.version||"Version 0.1"},description:{en:e.description||" "},copyright:{en:e.copyright||" "},trademark:{en:e.trademark||" "}};this.unitsPerEm=e.unitsPerEm||1e3;this.ascender=e.ascender;this.descender=e.descender;this.createdTimestamp=e.createdTimestamp;this.tables={os2:{usWeightClass:e.weightClass||this.usWeightClasses.MEDIUM,usWidthClass:e.widthClass||this.usWidthClasses.MEDIUM,fsSelection:e.fsSelection||this.fsSelectionValues.REGULAR}}}this.supported=true;this.glyphs=new lf.GlyphSet(this,e.glyphs||[]);this.encoding=new ku(this);this.substitution=new Yh(this);this.tables=this.tables||{};Object.defineProperty(this,"hinting",{get:function(){if(this._hinting){return this._hinting}if(this.outlinesFormat==="truetype"){return this._hinting=new ic(this)}}})}pd.prototype.hasChar=function(e){return this.encoding.charToGlyphIndex(e)!==null};pd.prototype.charToGlyphIndex=function(e){return this.encoding.charToGlyphIndex(e)};pd.prototype.charToGlyph=function(e){var t=this.charToGlyphIndex(e);var n=this.glyphs.get(t);if(!n){n=this.glyphs.get(0)}return n};pd.prototype.stringToGlyphs=function(e,t){var n=this;t=t||this.defaultRenderOptions;var r=[];for(var i=0;i<e.length;i+=1){var a=e[i];r.push(n.charToGlyphIndex(a))}var s=r.length;if(t.features){var o=t.script||this.substitution.getDefaultScriptName();var l=[];if(t.features.liga){l=l.concat(this.substitution.getFeature("liga",o,t.language))}if(t.features.rlig){l=l.concat(this.substitution.getFeature("rlig",o,t.language))}for(var u=0;u<s;u+=1){for(var f=0;f<l.length;f++){var h=l[f];var c=h.sub;var p=c.length;var d=0;while(d<p&&c[d]===r[u+d]){d++}if(d===p){r.splice(u,p,h.by);s=s-p+1}}}}var m=new Array(s);var _=this.glyphs.get(0);for(var v=0;v<s;v+=1){m[v]=n.glyphs.get(r[v])||_}return m};pd.prototype.nameToGlyphIndex=function(e){return this.glyphNames.nameToGlyphIndex(e)};pd.prototype.nameToGlyph=function(e){var t=this.nameToGlyphIndex(e);var n=this.glyphs.get(t);if(!n){n=this.glyphs.get(0)}return n};pd.prototype.glyphIndexToName=function(e){if(!this.glyphNames.glyphIndexToName){return""}return this.glyphNames.glyphIndexToName(e)};pd.prototype.getKerningValue=function(e,t){e=e.index||e;t=t.index||t;var n=this.getGposKerningValue;return n?n(e,t):this.kerningPairs[e+","+t]||0};pd.prototype.defaultRenderOptions={kerning:true,features:{liga:true,rlig:true}};pd.prototype.forEachGlyph=function(e,t,n,r,i,a){var s=this;t=t!==undefined?t:0;n=n!==undefined?n:0;r=r!==undefined?r:72;i=i||this.defaultRenderOptions;var o=1/this.unitsPerEm*r;var l=this.stringToGlyphs(e,i);for(var u=0;u<l.length;u+=1){var f=l[u];a.call(s,f,t,n,r,i);if(f.advanceWidth){t+=f.advanceWidth*o}if(i.kerning&&u<l.length-1){var h=s.getKerningValue(f,l[u+1]);t+=h*o}if(i.letterSpacing){t+=i.letterSpacing*r}else if(i.tracking){t+=i.tracking/1e3*r}}return t};pd.prototype.getPath=function(e,t,n,r,i){var a=new Gl;this.forEachGlyph(e,t,n,r,i,function(e,t,n,r){var s=e.getPath(t,n,r,i,this);a.extend(s)});return a};pd.prototype.getPaths=function(e,t,n,r,i){var a=[];this.forEachGlyph(e,t,n,r,i,function(e,t,n,r){var s=e.getPath(t,n,r,i,this);a.push(s)});return a};pd.prototype.getAdvanceWidth=function(e,t,n){return this.forEachGlyph(e,0,0,t,n,function(){})};pd.prototype.draw=function(e,t,n,r,i,a){this.getPath(t,n,r,i,a).draw(e)};pd.prototype.drawPoints=function(e,t,n,r,i,a){this.forEachGlyph(t,n,r,i,a,function(t,n,r,i){t.drawPoints(e,n,r,i)})};pd.prototype.drawMetrics=function(e,t,n,r,i,a){this.forEachGlyph(t,n,r,i,a,function(t,n,r,i){t.drawMetrics(e,n,r,i)})};pd.prototype.getEnglishName=function(e){var t=this.names[e];if(t){return t.en}};pd.prototype.validate=function(){var e=[];var t=this;function n(t,n){if(!t){e.push(n)}}function r(e){var r=t.getEnglishName(e);n(r&&r.trim().length>0,"No English "+e+" specified.")}r("fontFamily");r("weightName");r("manufacturer");r("copyright");r("version");n(this.unitsPerEm>0,"No unitsPerEm specified.")};pd.prototype.toTables=function(){return Wh.fontToTable(this)};pd.prototype.toBuffer=function(){console.warn("Font.toBuffer is deprecated. Use Font.toArrayBuffer instead.");return this.toArrayBuffer()};pd.prototype.toArrayBuffer=function(){var e=this.toTables();var t=e.encode();var n=new ArrayBuffer(t.length);var r=new Uint8Array(n);for(var i=0;i<t.length;i++){r[i]=t[i]}return n};pd.prototype.download=function(e){var t=this.getEnglishName("fontFamily");var n=this.getEnglishName("fontSubfamily");e=e||t.replace(/\s/g,"")+"-"+n+".otf";var r=this.toArrayBuffer();if(Jh()){window.requestFileSystem=window.requestFileSystem||window.webkitRequestFileSystem;window.requestFileSystem(window.TEMPORARY,r.byteLength,function(t){t.root.getFile(e,{create:true},function(e){e.createWriter(function(t){var n=new DataView(r);var i=new Blob([n],{type:"font/opentype"});t.write(i);t.addEventListener("writeend",function(){location.href=e.toURL()},false)})})},function(e){throw new Error(e.name+": "+e.message)})}else{var i=require("fs");var a=Qh(r);i.writeFileSync(e,a)}};pd.prototype.fsSelectionValues={ITALIC:1,UNDERSCORE:2,NEGATIVE:4,OUTLINED:8,STRIKEOUT:16,BOLD:32,REGULAR:64,USER_TYPO_METRICS:128,WWS:256,OBLIQUE:512};pd.prototype.usWidthClasses={ULTRA_CONDENSED:1,EXTRA_CONDENSED:2,CONDENSED:3,SEMI_CONDENSED:4,MEDIUM:5,SEMI_EXPANDED:6,EXPANDED:7,EXTRA_EXPANDED:8,ULTRA_EXPANDED:9};pd.prototype.usWeightClasses={THIN:100,EXTRA_LIGHT:200,LIGHT:300,NORMAL:400,MEDIUM:500,SEMI_BOLD:600,BOLD:700,EXTRA_BOLD:800,BLACK:900};function dd(e,t){var n=JSON.stringify(e);var r=256;for(var i in t){var a=parseInt(i);if(!a||a<256){continue}if(JSON.stringify(t[i])===n){return a}if(r<=a){r=a+1}}t[r]=e;return r}function md(e,t,n){var r=dd(t.name,n);return[{name:"tag_"+e,type:"TAG",value:t.tag},{name:"minValue_"+e,type:"FIXED",value:t.minValue<<16},{name:"defaultValue_"+e,type:"FIXED",value:t.defaultValue<<16},{name:"maxValue_"+e,type:"FIXED",value:t.maxValue<<16},{name:"flags_"+e,type:"USHORT",value:0},{name:"nameID_"+e,type:"USHORT",value:r}]}function _d(e,t,n){var r={};var i=new Au.Parser(e,t);r.tag=i.parseTag();r.minValue=i.parseFixed();r.defaultValue=i.parseFixed();r.maxValue=i.parseFixed();i.skip("uShort",1);r.name=n[i.parseUShort()]||{};return r}function vd(e,t,n,r){var i=dd(t.name,r);var a=[{name:"nameID_"+e,type:"USHORT",value:i},{name:"flags_"+e,type:"USHORT",value:0}];for(var s=0;s<n.length;++s){var o=n[s].tag;a.push({name:"axis_"+e+" "+o,type:"FIXED",value:t.coordinates[o]<<16})}return a}function gd(e,t,n,r){var i={};var a=new Au.Parser(e,t);i.name=r[a.parseUShort()]||{};a.skip("uShort",1);i.coordinates={};for(var s=0;s<n.length;++s){i.coordinates[n[s].tag]=a.parseFixed()}return i}function yd(e,t){var n=new du.Table("fvar",[{name:"version",type:"ULONG",value:65536},{name:"offsetToData",type:"USHORT",value:0},{name:"countSizePairs",type:"USHORT",value:2},{name:"axisCount",type:"USHORT",value:e.axes.length},{name:"axisSize",type:"USHORT",value:20},{name:"instanceCount",type:"USHORT",value:e.instances.length},{name:"instanceSize",type:"USHORT",value:4+e.axes.length*4}]);n.offsetToData=n.sizeOf();for(var r=0;r<e.axes.length;r++){n.fields=n.fields.concat(md(r,e.axes[r],t))}for(var i=0;i<e.instances.length;i++){n.fields=n.fields.concat(vd(i,e.instances[i],e.axes,t))}return n}function bd(e,t,n){var r=new Au.Parser(e,t);var i=r.parseULong();Wl.argument(i===65536,"Unsupported fvar table version.");var a=r.parseOffset16();r.skip("uShort",1);var s=r.parseUShort();var o=r.parseUShort();var l=r.parseUShort();var u=r.parseUShort();var f=[];for(var h=0;h<s;h++){f.push(_d(e,t+a+h*o,n))}var c=[];var p=t+a+s*o;for(var d=0;d<l;d++){c.push(gd(e,p+d*u,f,n))}return{axes:f,instances:c}}var xd={make:yd,parse:bd};function Td(e,t){var n=new Au.Parser(e,t);var r=n.parseUShort();var i=[];for(var a=0;a<r;a++){i[n.parseTag()]={offset:n.parseUShort()}}return i}function Sd(e,t){var n=new Au.Parser(e,t);var r=n.parseUShort();var i=n.parseUShort();if(r===1){return n.parseUShortList(i)}else if(r===2){var a=[];for(;i--;){var s=n.parseUShort();var o=n.parseUShort();var l=n.parseUShort();for(var u=s;u<=o;u++){a[l++]=u}}return a}}function Ed(e,t){var n=new Au.Parser(e,t);var r=n.parseUShort();if(r===1){var i=n.parseUShort();var a=n.parseUShort();var s=n.parseUShortList(a);return function(e){return s[e-i]||0}}else if(r===2){var o=n.parseUShort();var l=[];var u=[];var f=[];for(var h=0;h<o;h++){l[h]=n.parseUShort();u[h]=n.parseUShort();f[h]=n.parseUShort()}return function(e){var t=0;var n=l.length-1;while(t<n){var r=t+n+1>>1;if(e<l[r]){n=r-1}else{t=r}}if(l[t]<=e&&e<=u[t]){return f[t]||0}return 0}}}function wd(e,t){var n=new Au.Parser(e,t);var r=n.parseUShort();var i=n.parseUShort();var a=Sd(e,t+i);var s=n.parseUShort();var o=n.parseUShort();var l;var u;if(s!==4||o!==0){return}var f={};if(r===1){var h=n.parseUShort();var c=[];var p=n.parseOffset16List(h);for(var d=0;d<h;d++){var m=p[d];var _=f[m];if(!_){_={};n.relativeOffset=m;var v=n.parseUShort();for(;v--;){var g=n.parseUShort();if(s){l=n.parseShort()}if(o){u=n.parseShort()}_[g]=l}}c[a[d]]=_}return function(e,t){var n=c[e];if(n){return n[t]}}}else if(r===2){var y=n.parseUShort();var b=n.parseUShort();var x=n.parseUShort();var T=n.parseUShort();var S=Ed(e,t+y);var E=Ed(e,t+b);var w=[];for(var M=0;M<x;M++){var A=w[M]=[];for(var R=0;R<T;R++){if(s){l=n.parseShort()}if(o){u=n.parseShort()}A[R]=l}}var U={};for(var D=0;D<a.length;D++){U[a[D]]=1}return function(e,t){if(!U[e]){return}var n=S(e);var r=E(t);var i=w[n];if(i){return i[r]}}}}function Md(e,t){var n=new Au.Parser(e,t);var r=n.parseUShort();var i=n.parseUShort();var a=i&16;var s=n.parseUShort();var o=n.parseOffset16List(s);var l={lookupType:r,lookupFlag:i,markFilteringSet:a?n.parseUShort():-1};if(r===2){var u=[];for(var f=0;f<s;f++){var h=wd(e,t+o[f]);if(h){u.push(h)}}l.getKerningValue=function(e,t){for(var n=u.length;n--;){var r=u[n](e,t);if(r!==undefined){return r}}return 0}}return l}function Ad(e,t,n){var r=new Au.Parser(e,t);var i=r.parseFixed();Wl.argument(i===1,"Unsupported GPOS table version.");Td(e,t+r.parseUShort());Td(e,t+r.parseUShort());var a=r.parseUShort();r.relativeOffset=a;var s=r.parseUShort();var o=r.parseOffset16List(s);var l=t+a;for(var u=0;u<s;u++){var f=Md(e,l+o[u]);if(f.lookupType===2&&!n.getGposKerningValue){n.getGposKerningValue=f.getKerningValue}}}var Rd={parse:Ad};function Ud(e){var t={};e.skip("uShort");var n=e.parseUShort();Wl.argument(n===0,"Unsupported kern sub-table version.");e.skip("uShort",2);var r=e.parseUShort();e.skip("uShort",3);for(var i=0;i<r;i+=1){var a=e.parseUShort();var s=e.parseUShort();var o=e.parseShort();t[a+","+s]=o}return t}function Dd(e){var t={};e.skip("uShort");var n=e.parseULong();if(n>1){console.warn("Only the first kern subtable is supported.")}e.skip("uLong");var r=e.parseUShort();var i=r&255;e.skip("uShort");if(i===0){var a=e.parseUShort();e.skip("uShort",3);for(var s=0;s<a;s+=1){var o=e.parseUShort();var l=e.parseUShort();var u=e.parseShort();t[o+","+l]=u}}return t}function Ld(e,t){var n=new Au.Parser(e,t);var r=n.parseUShort();if(r===0){return Ud(n)}else if(r===1){return Dd(n)}else{throw new Error("Unsupported kern table version ("+r+").")}}var Od={parse:Ld};function Id(e,t,n,r){var i=new Au.Parser(e,t);var a=r?i.parseUShort:i.parseULong;var s=[];for(var o=0;o<n+1;o+=1){var l=a.call(i);if(r){l*=2}s.push(l)}return s}var Cd={parse:Id};function Pd(e,t){var n=[];var r=12;for(var i=0;i<t;i+=1){var a=Au.getTag(e,r);var s=Au.getULong(e,r+4);var o=Au.getULong(e,r+8);var l=Au.getULong(e,r+12);n.push({tag:a,checksum:s,offset:o,length:l,compression:false});r+=16}return n}function Bd(e,t){var n=[];var r=44;for(var i=0;i<t;i+=1){var a=Au.getTag(e,r);var s=Au.getULong(e,r+4);var o=Au.getULong(e,r+8);var l=Au.getULong(e,r+12);var u=void 0;if(o<l){u="WOFF"}else{u=false}n.push({tag:a,offset:s,compression:u,compressedLength:o,length:l});r+=20}return n}function Fd(e,t){if(t.compression==="WOFF"){var n=new Uint8Array(e.buffer,t.offset+2,t.compressedLength-2);var r=new Uint8Array(t.length);zl(n,r);if(r.byteLength!==t.length){throw new Error("Decompression error: "+t.tag+" decompressed length doesn't match recorded length")}var i=new DataView(r.buffer,0);return{data:i,offset:0}}else{return{data:e,offset:t.offset}}}function zd(e){var t;var n;var r=new pd({empty:true});var i=new DataView(e,0);var a;var s=[];var o=Au.getTag(i,0);if(o===String.fromCharCode(0,1,0,0)||o==="true"||o==="typ1"){r.outlinesFormat="truetype";a=Au.getUShort(i,4);s=Pd(i,a)}else if(o==="OTTO"){r.outlinesFormat="cff";a=Au.getUShort(i,4);s=Pd(i,a)}else if(o==="wOFF"){var l=Au.getTag(i,4);if(l===String.fromCharCode(0,1,0,0)){r.outlinesFormat="truetype"}else if(l==="OTTO"){r.outlinesFormat="cff"}else{throw new Error("Unsupported OpenType flavor "+o)}a=Au.getUShort(i,12);s=Bd(i,a)}else{throw new Error("Unsupported OpenType signature "+o)}var u;var f;var h;var c;var p;var d;var m;var _;var v;var g;var y;for(var b=0;b<a;b+=1){var x=s[b];var T=void 0;switch(x.tag){case"cmap":T=Fd(i,x);r.tables.cmap=Cu.parse(T.data,T.offset);r.encoding=new Nu(r.tables.cmap);break;case"cvt ":T=Fd(i,x);y=new Au.Parser(T.data,T.offset);r.tables.cvt=y.parseShortList(x.length/2);break;case"fvar":f=x;break;case"fpgm":T=Fd(i,x);y=new Au.Parser(T.data,T.offset);r.tables.fpgm=y.parseByteList(x.length);break;case"head":T=Fd(i,x);r.tables.head=Xf.parse(T.data,T.offset);r.unitsPerEm=r.tables.head.unitsPerEm;t=r.tables.head.indexToLocFormat;break;case"hhea":T=Fd(i,x);r.tables.hhea=Yf.parse(T.data,T.offset);r.ascender=r.tables.hhea.ascender;r.descender=r.tables.hhea.descender;r.numberOfHMetrics=r.tables.hhea.numberOfHMetrics;break;case"hmtx":d=x;break;case"ltag":T=Fd(i,x);n=eh.parse(T.data,T.offset);break;case"maxp":T=Fd(i,x);r.tables.maxp=rh.parse(T.data,T.offset);r.numGlyphs=r.tables.maxp.numGlyphs;break;case"name":v=x;break;case"OS/2":T=Fd(i,x);r.tables.os2=Eh.parse(T.data,T.offset);break;case"post":T=Fd(i,x);r.tables.post=Ah.parse(T.data,T.offset);r.glyphNames=new Vu(r.tables.post);break;case"prep":T=Fd(i,x);y=new Au.Parser(T.data,T.offset);r.tables.prep=y.parseByteList(x.length);break;case"glyf":h=x;break;case"loca":_=x;break;case"CFF ":u=x;break;case"kern":m=x;break;case"GPOS":c=x;break;case"GSUB":p=x;break;case"meta":g=x;break}}var S=Fd(i,v);r.tables.name=yh.parse(S.data,S.offset,n);r.names=r.tables.name;if(h&&_){var E=t===0;var w=Fd(i,_);var M=Cd.parse(w.data,w.offset,r.numGlyphs,E);var A=Fd(i,h);r.glyphs=$u.parse(A.data,A.offset,M,r)}else if(u){var R=Fd(i,u);Vf.parse(R.data,R.offset,r)}else{throw new Error("Font doesn't contain TrueType or CFF outlines.")}var U=Fd(i,d);Jf.parse(U.data,U.offset,r.numberOfHMetrics,r.numGlyphs,r.glyphs);Hu(r);if(m){var D=Fd(i,m);r.kerningPairs=Od.parse(D.data,D.offset)}else{r.kerningPairs={}}if(c){var L=Fd(i,c);Rd.parse(L.data,L.offset,r)}if(p){var O=Fd(i,p);r.tables.gsub=Ih.parse(O.data,O.offset)}if(f){var I=Fd(i,f);r.tables.fvar=xd.parse(I.data,I.offset,r.names)}if(g){var C=Fd(i,g);r.tables.meta=Bh.parse(C.data,C.offset);r.metas=r.tables.meta}return r}function kd(e,t,n){n=n||{};this.w=e||64;this.h=t||64;this.autoResize=!!n.autoResize;this.shelves=[];this.freebins=[];this.stats={};this.bins={};this.maxId=0}kd.prototype.pack=function(e,t){var n=this;e=[].concat(e);t=t||{};var r=[],i,a,s,o;for(var l=0;l<e.length;l++){i=e[l].w||e[l].width;a=e[l].h||e[l].height;s=e[l].id;if(i&&a){o=n.packOne(i,a,s);if(!o){continue}if(t.inPlace){e[l].x=o.x;e[l].y=o.y;e[l].id=o.id}r.push(o)}}this.shrink();return r};kd.prototype.packOne=function(e,t,n){var r=this;var i={freebin:-1,shelf:-1,waste:Infinity},a=0,s,o,l,u;if(typeof n==="string"||typeof n==="number"){s=this.getBin(n);if(s){this.ref(s);return s}if(typeof n==="number"){this.maxId=Math.max(n,this.maxId)}}else{n=++this.maxId}for(u=0;u<this.freebins.length;u++){s=r.freebins[u];if(t===s.maxh&&e===s.maxw){return r.allocFreebin(u,e,t,n)}if(t>s.maxh||e>s.maxw){continue}if(t<=s.maxh&&e<=s.maxw){l=s.maxw*s.maxh-e*t;if(l<i.waste){i.waste=l;i.freebin=u}}}for(u=0;u<this.shelves.length;u++){o=r.shelves[u];a+=o.h;if(e>o.free){continue}if(t===o.h){return r.allocShelf(u,e,t,n)}if(t>o.h){continue}if(t<o.h){l=(o.h-t)*e;if(l<i.waste){i.freebin=-1;i.waste=l;i.shelf=u}}}if(i.freebin!==-1){return this.allocFreebin(i.freebin,e,t,n)}if(i.shelf!==-1){return this.allocShelf(i.shelf,e,t,n)}if(t<=this.h-a&&e<=this.w){o=new Nd(a,this.w,t);return this.allocShelf(this.shelves.push(o)-1,e,t,n)}if(this.autoResize){var f,h,c,p;f=h=this.h;c=p=this.w;if(c<=f||e>c){p=Math.max(e,c)*2}if(f<c||t>f){h=Math.max(t,f)*2}this.resize(p,h);return this.packOne(e,t,n)}return null};kd.prototype.allocFreebin=function(e,t,n,r){var i=this.freebins.splice(e,1)[0];i.id=r;i.w=t;i.h=n;i.refcount=0;this.bins[r]=i;this.ref(i);return i};kd.prototype.allocShelf=function(e,t,n,r){var i=this.shelves[e];var a=i.alloc(t,n,r);this.bins[r]=a;this.ref(a);return a};kd.prototype.shrink=function(){var e=this;if(this.shelves.length>0){var t=0;var n=0;for(var r=0;r<this.shelves.length;r++){var i=e.shelves[r];n+=i.h;t=Math.max(i.w-i.free,t)}this.resize(t,n)}};kd.prototype.getBin=function(e){return this.bins[e]};kd.prototype.ref=function(e){if(++e.refcount===1){var t=e.h;this.stats[t]=(this.stats[t]|0)+1}return e.refcount};kd.prototype.unref=function(e){if(e.refcount===0){return 0}if(--e.refcount===0){this.stats[e.h]--;delete this.bins[e.id];this.freebins.push(e)}return e.refcount};kd.prototype.clear=function(){this.shelves=[];this.freebins=[];this.stats={};this.bins={};this.maxId=0};kd.prototype.resize=function(e,t){var n=this;this.w=e;this.h=t;for(var r=0;r<this.shelves.length;r++){n.shelves[r].resize(e)}return true};function Nd(e,t,n){this.x=0;this.y=e;this.w=this.free=t;this.h=n}Nd.prototype.alloc=function(e,t,n){if(e>this.free||t>this.h){return null}var r=this.x;this.x+=e;this.free-=e;return new Gd(n,r,this.y,e,t,e,this.h)};Nd.prototype.resize=function(e){this.free+=e-this.w;this.w=e;return true};function Gd(e,t,n,r,i,a,s){this.id=e;this.x=t;this.y=n;this.w=r;this.h=i;this.maxw=a||r;this.maxh=s||i;this.refcount=0}var Vd=function(e){function t(t,n,r){if(n===void 0)n=1024;if(r===void 0)r=1024;e.call(this);this._font=null;this._padding=2;this._fontScale=1;this._textCache={};this._packer=new kd(n,r);this._packCanvas=document.createElement("canvas");this._packCanvas.width=n;this._packCanvas.height=r;this._fontAtlas=new ja(t,n,r);this._fontAtlas.mipmap=false;this._fontAtlas.premultiplyAlpha=true;this._defaultGlyph={id:32,x:0,y:0,width:16,height:16,xoffset:0,yoffset:0,xadvance:16,uvs:[Rt.new(0,0),Rt.new(0,0),Rt.new(0,0),Rt.new(0,0)]};this._type="opentype"}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;var n={font:{configurable:true},texture:{configurable:true},size:{configurable:true},lineHeight:{configurable:true}};n.font.set=function(e){this._font=e;this._fontScale=this._size/this._font.unitsPerEm};n.font.get=function(){return this._font};n.texture.get=function(){return this._fontAtlas};n.size.set=function(e){if(this._size!==e){this._size=e;this.clear()}};n.lineHeight.set=function(e){if(this._lineHeight!==e){this._lineHeight=e;this.clear()}};t.prototype.addText=function e(t){if(this._textCache[t]===undefined){this._textCache[t]=t;this._addTextToFontAtlas(t)}};t.prototype.removeText=function e(t){if(this._textCache[t]===undefined){console.warn("can not remove text: '"+t+"' from font. not exists.")}else{this._removeTextFromFontAtlas(t);delete this._textCache[t]}};t.prototype.clear=function e(){this._packer.clear();var t=this._packCanvas.getContext("2d");t.clearRect(0,0,this._packCanvas.width,this._packCanvas.height);this._fontAtlas.setImages([this._packCanvas]);this._fontAtlas.commit()};t.prototype._addTextToFontAtlas=function e(t){var n=this;var r=this._packCanvas.getContext("2d");var i=false;for(var a=0;a<t.length;++a){var s=t[a];var o=t.charCodeAt(a);var l=n._font.charToGlyph(s);if(l.path.getBoundingBox===undefined){continue}var u=l.getBoundingBox();var f={id:o,x:0,y:0,width:0,height:0,xoffset:0,yoffset:0,xadvance:0};f.width=(u.x2-u.x1)*n._fontScale;f.height=(u.y2-u.y1)*n._fontScale;if(n._glyphs[o]!==undefined){n._packer.packOne(f.width,f.height,f.id)}else{i=true;f.xadvance=l.advanceWidth*n._fontScale;n._glyphs[o]=f;var h=n._packer.packOne(f.width+n._padding,f.height+n._padding,f.id);if(h!==null){f.xoffset=u.x1*n._fontScale;f.yoffset=n._size-u.y2*n._fontScale+n._font.descender*n._fontScale;var c=(h.x+n._padding/2)/n._packCanvas.width;var p=(h.x+n._padding/2+f.width)/n._packCanvas.width;var d=1-(h.y+n._padding/2+f.height)/n._packCanvas.height;var m=1-(h.y+n._padding/2)/n._packCanvas.height;f.uvs=[Rt.new(c,d),Rt.new(p,d),Rt.new(c,m),Rt.new(p,m)];var _=l.getPath(h.x-u.x1*n._fontScale+n._padding/2,h.y+u.y2*n._fontScale+n._padding/2,n._size,{xScale:n._fontScale,yScale:n._fontScale});_.fill="#FFFFFF";_.draw(r)}else{console.error("font glyph pack failed. font atlas size is not enough.")}}}if(i){this._fontAtlas.setImages([this._packCanvas]);this._fontAtlas.commit()}};t.prototype._removeTextFromFontAtlas=function e(t){var n=this;var r=this._packCanvas.getContext("2d");var i=false;for(var a=0;a<t.length;++a){var s=t.charCodeAt(a);if(n._glyphs[s]!==undefined){var o=n._packer.getBin(s);var l=n._packer.unref(o);if(l===0){delete n._glyphs[s];r.clearRect(o.x,o.y,o.w,o.h);i=true}}else{console.warn("try to remove a no exist glyph.")}}if(i){this._fontAtlas.setImages([this._packCanvas]);this._fontAtlas.commit()}};Object.defineProperties(t.prototype,n);return t}(hl);function Hd(e,t,n){var r={};r.bin={type:"binary",src:t.bin};if(t.json){r.json={type:"text",parser:JSON.parse,src:t.json}}Ca({manifest:r,onDone:function t(r){var i=r.bin;var a=r.json;var s=null;if(a&&a.width&&a.height){s=new Vd(e.device,a.width,a.height)}else{s=new Vd(e.device,512,512)}var o=zd(i);s.font=o;s.size=a.size?a.size:32;s.lineHeight=a.lineHeight?a.lineHeight:32;n(null,s)}})}var Wd=function(e){function t(){e.call(this);this._startedFlag=0}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.onInit=function e(){this._system.add(this)};t.prototype.onDestroy=function e(){this._system.remove(this)};t.prototype.awake=function e(){};t.prototype.start=function e(){};t.prototype.tick=function e(){};t.prototype.postTick=function e(){};t.prototype.end=function e(){};return t}(ia);var Xd=function(e){function t(){e.call(this);this._camera=new Pi.Camera}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.onInit=function e(){this._camera.setStages(["opaque","transparent"]);this._camera.setNode(this._entity);this.projection=this._projection;this.priority=this._priority;this.fov=this._fov;this.orthoHeight=this._orthoHeight;this.near=this._near;this.far=this._far;this.color=this._color;this.depth=this._depth;this.stencil=this._stencil;this.clearFlags=this._clearFlags;this.rect=this._rect};t.prototype.onEnable=function e(){this._app.scene.addCamera(this._camera)};t.prototype.onDisable=function e(){this._app.scene.removeCamera(this._camera)};return t}(ia);Xd.schema={projection:{type:"enums",default:"perspective",options:["ortho","perspective"],set:function e(t){this._projection=t;var n=Pi.PROJ_PERSPECTIVE;if(this._projection==="ortho"){n=Pi.PROJ_ORTHO}this._camera.setType(n)}},priority:{type:"number",default:0,set:function e(t){this._priority=t;this._camera.setPriority(t)}},fov:{type:"number",default:45,set:function e(t){this._fov=t;this._camera.setFov(qe(t))}},orthoHeight:{type:"number",default:10,set:function e(t){this._orthoHeight=t;this._camera.setOrthoHeight(t)}},near:{type:"number",default:.01,set:function e(t){this._near=t;this._camera.setNear(t)}},far:{type:"number",default:1e3,set:function e(t){this._far=t;this._camera.setFar(t)}},color:{type:"color4",default:[.2,.3,.47,1],set:function e(t){this._color=t;this._camera.setColor(t.r,t.g,t.b,t.a)}},depth:{type:"number",default:1,set:function e(t){this._depth=t;this._camera.setDepth(t)}},stencil:{type:"number",default:0,set:function e(t){this._stencil=t;this._camera.setStencil(t)}},clearFlags:{type:"number",default:3,set:function e(t){this._clearFlags=t;this._camera.setClearFlags(t)}},rect:{type:"rect",default:[0,0,1,1],set:function e(t){this._rect=t;this._camera.setRect(t[0],t[1],t[2],t[3])}}};var jd=function(e){function t(){e.call(this);this._light=new Pi.Light}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.onInit=function e(){this._light.setNode(this._entity);this.type=this._type;this.color=this._color;this.intensity=this._intensity;this.range=this._range;this.spotAngle=this._spotAngle;this.spotExp=this._spotExp;this.shadowType=this._shadowType;this.shadowResolution=this._shadowResolution;this.shadowDarkness=this._shadowDarkness;this.shadowMinDepth=this._shadowMinDepth;this.shadowMaxDepth=this._shadowMaxDepth;this.shadowDepthScale=this._shadowDepthScale;this.shadowFrustumSize=this._shadowFrustumSize;this.shadowBias=this._shadowBias};t.prototype.onEnable=function e(){this._app.scene.addLight(this._light)};t.prototype.onDisable=function e(){this._app.scene.removeLight(this._light)};return t}(ia);jd.schema={type:{type:"enums",default:"directional",options:["directional","point","spot"],set:function e(t){this._type=t;var n=Pi.LIGHT_DIRECTIONAL;if(this._type==="point"){n=Pi.LIGHT_POINT}else if(this._type==="spot"){n=Pi.LIGHT_SPOT}this._light.setType(n)}},color:{type:"color3",default:[1,1,1],set:function e(t){this._color=t;this._light.setColor(t.r,t.g,t.b)}},intensity:{type:"number",default:1,set:function e(t){this._intensity=t;this._light.setIntensity(t)}},range:{type:"number",default:1,set:function e(t){this._range=t;this._light.setRange(t)}},spotAngle:{type:"number",default:60,set:function e(t){this._spotAngle=t;this._light.setSpotAngle(qe(t))}},spotExp:{type:"number",default:1,set:function e(t){this._spotExp=t;this._light.setSpotExp(t)}},shadowType:{type:"enums",default:"none",options:["none","hard","soft"],set:function e(t){this._shadowType=t;var n=Pi.SHADOW_NONE;if(t==="hard"){n=Pi.SHADOW_HARD}else if(t==="soft"){n=Pi.SHADOW_SOFT}this._light.setShadowType(n)}},shadowResolution:{type:"number",default:1024,set:function e(t){this._shadowResolution=t;this._light.setShadowResolution(t)}},shadowDarkness:{type:"number",default:.5,set:function e(t){this._shadowDarkness=t;this._light.setShadowDarkness(t)}},shadowMinDepth:{type:"number",default:1,set:function e(t){this._shadowMinDepth=t;this._light.setShadowMinDepth(t)}},shadowMaxDepth:{type:"number",default:1e3,set:function e(t){this._shadowMaxDepth=t;this._light.setShadowMaxDepth(t)}},shadowDepthScale:{type:"number",default:250,set:function e(t){this._shadowDepthScale=t;this._light.setShadowDepthScale(t)}},shadowFrustumSize:{type:"number",default:50,set:function e(t){this._shadowFrustumSize=t;this._light.setShadowFrustumSize(t)}},shadowBias:{type:"number",default:5e-4,set:function e(t){this._shadowBias=t;this._light.setShadowBias(t)}}};var qd=function(e){function t(){e.apply(this,arguments)}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;var n={material:{configurable:true}};t.prototype.onInit=function e(){this._models=[];this.materials=this._materials;this.mesh=this._mesh;this.shadowCastingMode=this._shadowCastingMode;this.receiveShadows=this._receiveShadows};t.prototype.onEnable=function e(){var t=this;for(var n=0;n<this._models.length;++n){t._app.scene.addModel(t._models[n])}};t.prototype.onDisable=function e(){var t=this;for(var n=0;n<this._models.length;++n){t._app.scene.removeModel(t._models[n])}};t.prototype.getMaterial=function e(t){if(this._materials.length===0){return null}if(t<this._materials.length){return this._materials[t]}return this._materials[this._materials.length-1]};n.material.get=function(){return this.getMaterial(0)};n.material.set=function(e){if(this._materials.length===1&&this._materials[0]===e){return}this._materials[0]=e;if(this._models.length>0){this._models[0].setEffect(e.effectInst)}};t.prototype._updateModels=function e(){var t=this;var n=this._mesh?this._mesh.subMeshCount:0;var r=this._models;this._models=new Array(n);for(var i=0;i<n;++i){var a=new Pi.Model;a.createBoundingBox(t._mesh._minPos,t._mesh._maxPos);t._models[i]=a}this._updateModelParams();if(this.enabled){for(var s=0;s<r.length;++s){t._app.scene.removeModel(r[s])}for(var o=0;o<this._models.length;++o){t._app.scene.addModel(t._models[o])}}};t.prototype._updateModelParams=function e(){var t=this;for(var n=0;n<this._models.length;++n){var r=t._models[n];var i=t.getMaterial(n);var a=t._mesh.getSubMesh(n);r.setInputAssembler(a);r.setEffect(i?i.effectInst:null);r.setNode(t._entity)}};t.prototype._updateCastShadow=function e(){var t=this;if(this._shadowCastingMode==="off"){for(var n=0;n<this._models.length;++n){var r=t._models[n];r._castShadow=false}}else if(this._shadowCastingMode==="on"){for(var i=0;i<this._models.length;++i){var a=t._models[i];a._castShadow=true}}else{console.warn("ShadowCastingMode "+this._shadowCastingMode+" is not supported.")}};t.prototype._updateReceiveShadow=function e(){var t=this;if(this._receiveShadows){for(var n=0;n<this._models.length;++n){var r=t._models[n];r._effect.define("USE_SHADOW_MAP",true)}}else{for(var i=0;i<this._models.length;++i){var a=t._models[i];a._effect.define("USE_SHADOW_MAP",false)}}};Object.defineProperties(t.prototype,n);return t}(ia);qd.schema={materials:{type:"asset",default:[],array:true,set:function e(t){this._materials=t;this._updateModelParams()}},mesh:{type:"asset",default:null,set:function e(t){this._mesh=t;this._updateModels()}},shadowCastingMode:{type:"enums",default:"off",options:["off","on","twoSided","shadowsOnly"],set:function e(t){this._shadowCastingMode=t;this._updateCastShadow()}},receiveShadows:{type:"boolean",default:false,set:function e(t){this._receiveShadows=t;this._updateReceiveShadow()}}};var Yd=Pt.create();var Kd=function(e){function t(){e.apply(this,arguments)}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.onInit=function e(){this._models=[];this._jointsTexture=null;this._refSkeleton=null;this._updateModels();this._updateCastShadow();this._updateReceiveShadow();var t=this._entity.parent;var n=t.getComp("Animation");if(n){this._refSkeleton=n.skeleton}else{console.warn("Can not find Animation component in root entity.")}this._system.add(this)};t.prototype.onDestroy=function e(){this._system.remove(this)};t.prototype._updateMatrices=function e(){var t=this;if(!this._mesh||!this._mesh.skinning){return}var n=this._jointsTexture;var r=this._mesh.skinning.jointIndices;var i=this._mesh.skinning.bindposes;for(var a=0;a<r.length;++a){var s=i[a];var o=r[a];var l=t._refSkeleton.getWorldMatrix(o);Pt.multiply(Yd,l,s);n.data[16*a+0]=Yd.m00;n.data[16*a+1]=Yd.m01;n.data[16*a+2]=Yd.m02;n.data[16*a+3]=Yd.m03;n.data[16*a+4]=Yd.m04;n.data[16*a+5]=Yd.m05;n.data[16*a+6]=Yd.m06;n.data[16*a+7]=Yd.m07;n.data[16*a+8]=Yd.m08;n.data[16*a+9]=Yd.m09;n.data[16*a+10]=Yd.m10;n.data[16*a+11]=Yd.m11;n.data[16*a+12]=Yd.m12;n.data[16*a+13]=Yd.m13;n.data[16*a+14]=Yd.m14;n.data[16*a+15]=Yd.m15}n.commit()};t.prototype._updateModels=function e(){var t=this;if(this._mesh.skinning){if(this._jointsTexture){this._jointsTexture.unload();this._jointsTexture=null}this._jointsTexture=as.createJointsTexture(this._app,this._mesh.skinning)}var n=this._mesh?this._mesh.subMeshCount:0;var r=this._models;this._models=new Array(n);for(var i=0;i<n;++i){var a=new Pi.SkinningModel;a.createBoundingBox(t._mesh._minPos,t._mesh._maxPos);t._models[i]=a}this._updateModelParams();if(this.enabled){this._entity.emit("skinning-model-changed",this,"mesh",r)}};t.prototype._updateModelParams=function t(){var n=this;e.prototype._updateModelParams.call(this);for(var r=0;r<this._models.length;++r){n._models[r].setJointsTexture(n._jointsTexture._texture)}};return t}(qd);var Zd=function e(t){this.clip=t;this.blendMode="blend";this.wrapMode="loop";this.speed=1;this.time=0;this.weight=1};var Jd=function e(){this._current=null;this._next=null;this._blendTime=0;this._blendDuration=.3;this._skeleton=null;this._skelFrom=null;this._skelTo=null};Jd.prototype.setSkeleton=function e(t){this._skeleton=t;this._skelFrom=t.clone();this._skelTo=t.clone()};Jd.prototype.crossFade=function e(t,n){if(this._current&&n>0){this._next=t;this._blendTime=0;this._blendDuration=n}else{this._current=t;this._next=null}};Jd.prototype.tick=function e(t){if(this._current&&this._next){var n=this._getTime(this._current);var r=this._getTime(this._next);var i=this._blendTime/this._blendDuration;this._current.time+=t;this._next.time+=t;this._blendTime+=t;if(i>1){this._current=this._next;this._next=null;this._current.clip.sample(this._skeleton,r)}else{this._current.clip.sample(this._skelFrom,n);this._next.clip.sample(this._skelTo,r);this._skeleton.blend(this._skelFrom,this._skelTo,i);this._skeleton.updateMatrices()}return}if(this._current){var a=this._getTime(this._current);this._current.clip.sample(this._skeleton,a);this._current.time+=t}};Jd.prototype._getTime=function e(t){var n=t.time;var r=t.clip.length;if(t.wrapMode==="once"){if(n>r){n=0}}else if(t.wrapMode==="loop"){n%=r}else if(t.wrapMode==="ping-pong"){var i=Math.floor(n/r);if(i%2===1){n=r-n%r}}return n};var Qd=function(e){function t(){e.apply(this,arguments)}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;var n={skeleton:{configurable:true}};t.prototype.onInit=function e(){this._name2states={};this._animCtrl=new Jd;this.clips=this._clips;this.joints=this._joints;this._system.add(this)};t.prototype.onDestroy=function e(){this._system.remove(this)};n.skeleton.get=function(){return this._skeleton};t.prototype.addClip=function e(t,n){if(this._name2states[t]){console.warn("Failed to add clip "+t+", the name already exsits.");return}this._clips.push(n);this._name2states[t]=new Zd(n)};t.prototype.getState=function e(t){return this._name2states[t]};t.prototype.play=function e(t,n){if(n===void 0)n=.3;if(!this._name2states[t]){console.warn("Failed to play animation "+t+", not found.");return}var r=this._name2states[t];r.time=0;this._animCtrl.crossFade(r,n)};t.prototype._updateSkeleton=function e(){this.joints=this._joints};Object.defineProperties(t.prototype,n);return t}(ia);Qd.schema={clips:{type:"asset",default:[],array:true,set:function e(t){var n=this;this._clips=t;for(var r=0;r<this._clips.length;++r){var i=n._clips[r];if(n._name2states[i.name]){console.warn("Failed to add clip "+i.name+", the name already exsits.");continue}n._name2states[i.name]=new Zd(i)}}},joints:{type:"asset",default:null,set:function e(t){this._joints=t;if(this._joints){this._skeleton=this._joints.instantiate();this._animCtrl.setSkeleton(this._skeleton)}else{this._skeleton=null}}}};var $d=false;var em=false;var tm=false;var nm=[];var rm={};rm.State={ERROR:-1,INITIALZING:0,PLAYING:1,PAUSED:2};var im=function(e){function t(){e.call(this);this._element=null;this._nextTime=0;this._state=rm.State.INITIALZING}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;var n={currentTime:{configurable:true},duration:{configurable:true},state:{configurable:true},paused:{configurable:true}};t.prototype.onInit=function e(){this._system.add(this);this.clip=this._clip;this.loop=this._loop;this.volume=this._volume;this.playOnAwake=this._playOnAwake};t.prototype.onDestroy=function e(){this._system.remove(this)};t.prototype.play=function e(){this._state=rm.State.PLAYING;if(!this._element){return}this._bindEnded();this._element.play();if(!(em||$d)&&this._clip&&this._clip.loadMode===il.DOM_AUDIO&&this._element.paused){nm.push({instance:this,offset:0,audio:this._element})}if(tm){return}tm=true;window.addEventListener("touchstart",function(){var e=nm.pop();while(e){e.audio.play(e.offset);e=nm.pop()}})};t.prototype.pause=function e(){if(!this._element){return}this._unbindEnded();this._element.pause();this._state=rm.State.PAUSED};t.prototype.resume=function e(){if(!this._element||this._state===rm.State.PLAYING){return}this._bindEnded();this._element.play();this._state=rm.State.PLAYING};t.prototype.stop=function e(){var t=this;if(!this._element){return}try{this._element.currentTime=0}catch(e){console.log(e)}this._element.pause();for(var n=0;n<nm.length;n++){if(nm[n].instance===t){nm.splice(n,1);break}}this._unbindEnded();this._state=rm.State.PAUSED};n.currentTime.set=function(e){if(this._element){this._nextTime=0}else{this._nextTime=e;return}this._unbindEnded();if(!(em||$d)){this._bindEnded(function(){this._bindEnded()}.bind(this))}try{this._element.currentTime=e}catch(r){var t=this._element;if(t.addEventListener){var n=function(){t.removeEventListener("loadedmetadata",n);t.currentTime=e};t.addEventListener("loadedmetadata",n)}}};n.currentTime.get=function(){return this._element?this._element.currentTime:0};n.duration.get=function(){return this._element?this._element.duration:0};n.state.get=function(){if(!$d){var e=this._element;if(e&&rm.State.PLAYING===this._state&&e.paused){this._state=rm.State.PAUSED}}return this._state};n.paused.get=function(){return this._element?this._element.paused:true};t.prototype._bindEnded=function e(t){t=t||this._onended;if(this._clip&&this._clip.loadMode===il.DOM_AUDIO){this._element.addEventListener("ended",t)}else{this._element.onended=t}};t.prototype._unbindEnded=function e(){if(this._clip&&this._clip.loadMode===il.DOM_AUDIO){this._element.removeEventListener("ended",this._onended)}else{this._element.onended=null}};t.prototype._onLoaded=function e(){var t=this._clip.nativeAsset;if(this._clip.loadMode===il.DOM_AUDIO||em||$d){this._element=t}else{this._element=new am(t,this)}this.volume=this._volume;this.loop=this._loop;if(this._nextTime!==0){this.setCurrentTime(this._nextTime)}if(this._state===rm.State.PLAYING||this._playOnAwake){this.play()}else{this._state=rm.State.INITIALZING}};Object.defineProperties(t.prototype,n);return t}(ia);im.schema={clip:{type:"asset",default:null,set:function e(t){if(t){this._clip=t;if(t._loaded){this._onLoaded()}else{t.once("load",function(){if(t===this._clip){this._onLoaded()}}.bind(this))}}else{this._clip=null;this._element=null;this._state=rm.State.INITIALZING}return t}},loop:{type:"boolean",default:false,set:function e(t){this._loop=t;if(this._element){this._element.loop=t}}},playOnAwake:{type:"boolean",default:true,set:function e(t){this._playOnAwake=t;if(t){this._state=rm.State.PLAYING}}},volume:{type:"number",default:1,set:function e(t){this._volume=t;if(this._element){this._element.volume=t}}}};var am=function(e,t){this._audio=t;this._context=this._audio._system.__audioSupport.context;this._buffer=e;this._gainObj=this._context["createGain"]();this._volume=1;if(this._gainObj["gain"].setTargetAtTime){this._gainObj["gain"].setTargetAtTime(this._volume,this._context.currentTime,.01)}else{this._gainObj["gain"].value=this._volume}this._gainObj["connect"](this._context["destination"]);this._loop=false;this._startTime=-1;this._currentSource=null;this.playedLength=0;this._currextTimer=null;this._endCallback=function(){if(this.onended){this.onended(this)}}.bind(this)};(function(e){e.play=function(e){if(this._currentSource&&!this.paused){this._currentSource.onended=null;this._currentSource.stop(0);this.playedLength=0}var t=this._context["createBufferSource"]();t.buffer=this._buffer;t["connect"](this._gainObj);t.loop=this._loop;this._startTime=this._context.currentTime;e=e||this.playedLength;if(e){this._startTime-=e}var n=this._buffer.duration;var r=e;var i;if(this._loop){if(t.start){t.start(0,r)}else if(t["notoGrainOn"]){t["noteGrainOn"](0,r)}else{t["noteOn"](0,r)}}else{i=n-e;if(t.start){t.start(0,r,i)}else if(t["notoGrainOn"]){t["noteGrainOn"](0,r,i)}else{t["noteOn"](0,r,i)}}this._currentSource=t;t.onended=this._endCallback;if((!t.context.state||t.context.state==="suspended")&&this._context.currentTime===0){var a=this;clearTimeout(this._currextTimer);this._currextTimer=setTimeout(function(){if(!(em||$d)&&a._context.currentTime===0){nm.push({instance:a._audio,offset:e,audio:a})}},10)}};e.pause=function(){clearTimeout(this._currextTimer);if(this.paused){return}this.playedLength=this._context.currentTime-this._startTime;this.playedLength%=this._buffer.duration;var e=this._currentSource;this._currentSource=null;this._startTime=-1;if(e){e.stop(0)}};e.__defineGetter__("paused",function(){if(this._currentSource&&this._currentSource.loop){return false}if(this._startTime===-1){return true}return this._context.currentTime-this._startTime>this._buffer.duration});e.__defineGetter__("loop",function(){return this._loop});e.__defineSetter__("loop",function(e){if(this._currentSource){this._currentSource.loop=e}return this._loop=e});e.__defineGetter__("volume",function(){return this._volume});e.__defineSetter__("volume",function(e){this._volume=e;if(this._gainObj["gain"].setTargetAtTime){this._gainObj["gain"].setTargetAtTime(this._volume,this._context.currentTime,.01)}else{this._volume["gain"].value=e}if(this._audio._system.os===this._audio._system.OS_IOS&&!this.paused&&this._currentSource){this._currentSource.onended=null;this.pause();this.play()}return e});e.__defineGetter__("currentTime",function(){if(this.paused){return this.playedLength}this.playedLength=this._context.currentTime-this._startTime;this.playedLength%=this._buffer.duration;return this.playedLength});e.__defineSetter__("currentTime",function(e){if(!this.paused){this.pause();this.playedLength=e;this.play()}else{this.playedLength=e}return e});e.__defineGetter__("duration",function(){return this._buffer.duration})})(am.prototype);var sm=function(e){function t(){e.call(this);this._model=new Pi.Model;this._attachedCamera=null;this.material=this._material;this.cubeMap=this._cubeMap}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.onInit=function e(){this._model.setNode(this._entity);var t=Pi.createIA(this._app.device,Bs(2,2,2,{widthSegments:1,heightSegments:1,lengthSegments:1}));this._model.setInputAssembler(t);if(this._material===null){this._material=new yo;this._material.effect=this._app.assets.get("builtin-effect-skybox")}this._updateMaterialParams();this._model.setEffect(this._material.effectInst)};t.prototype.onEnable=function e(){if(this._entity!=null){var t=this._entity.getComp("Camera");if(t!=null&&t._clearFlags&Pi.CLEAR_SKYBOX){this._attachedCamera=t._camera;this._attachedCamera._clearModel=this._model}}};t.prototype.onDisable=function e(){if(this._attachedCamera!=null){this._attachedCamera._clearModel=null;this._attachedCamera=null}};t.prototype._updateMaterialParams=function e(){if(this._material===null||this._material===undefined){return}if(this._cubeMap!==null&&this._cubeMap!==undefined){this._material.setProperty("cubeMap",this._cubeMap)}};return t}(ia);sm.schema={material:{type:"asset",default:null,set:function e(t){this._material=t;if(!this._material){return}this._updateMaterialParams();this._model.setEffect(t.effectInst)}},cubeMap:{type:"asset",default:null,set:function e(t){this._cubeMap=t;this._updateMaterialParams()}}};var om=function e(t){this.particleSystem=t;this.position=Ut.new(0,0,0);this.velocity=Ut.new(0,0,0);this.animatedVelocity=Ut.new(0,0,0);this.ultimateVelocity=Ut.new(0,0,0);this.angularVelocity=Ut.new(0,0,0);this.axisOfRotation=Ut.new(0,0,0);this.rotation=Ut.new(0,0,0);this.startSize=Ut.new(0,0,0);this.size=Ut.zero();this.startColor=Ft.new(1,1,1,1);this.color=Ft.create();this.randomSeed=0;this.remainingLifetime=0;this.startLifetime=0;this.emitAccumulator0=0;this.emitAccumulator1=0;this.frameIndex=0};var lm=function e(){};lm.schema={color:{type:"color3",default:[1,1,1]},time:{type:"number",default:0}};var um=function e(){};um.schema={alpha:{type:"number",default:1},time:{type:"number",default:0}};var fm=function e(){this._rgb=Bt.new(1,1,1);this._rgba=Ft.new(1,1,1,1)};fm.prototype.setKeys=function e(t,n){this._colorKeys=t;this._alphaKeys=n};fm.prototype.sortKeys=function e(){if(this._colorKeys.length>1){this._colorKeys.sort(function(e,t){return e.time-t.time})}if(this._alphaKeys.length>1){this._alphaKeys.sort(function(e,t){return e.time-t.time})}};fm.prototype.getRGB=function e(t){var n=this;if(this._colorKeys.length>1){t=nt(t,1);for(var r=1;r<this._colorKeys.length;++r){var i=n._colorKeys[r-1].time;var a=n._colorKeys[r].time;if(t>=i&&t<a){if(n._mode==="fixed"){return n._colorKeys[r].color}var s=(t-i)/(a-i);Bt.lerp(n._rgb,n._colorKeys[r-1].color,n._colorKeys[r].color,s);return n._rgb}}console.warn("something went wrong. can not get gradient color.")}else if(this._colorKeys.length===1){return this._colorKeys[0].color}else{return Bt.set(this._rgb,1,1,1)}};fm.prototype.getAlpha=function e(t){var n=this;if(this._alphaKeys.length>1){t=nt(t,1);for(var r=1;r<this._alphaKeys.length;++r){var i=n._alphaKeys[r-1].time;var a=n._alphaKeys[r].time;if(t>=i&&t<a){if(n._mode==="fixed"){return n._alphaKeys[r].alpha}var s=(t-i)/(a-i);return n._alphaKeys[r-1].alpha*(1-s)+n._alphaKeys[r].alpha*s}}console.warn("something went wrong. can not get gradient alpha.")}else if(this._alphaKeys.length===1){return this._alphaKeys[0].alpha}else{return 1}};fm.prototype.evaluate=function e(t){var n=this.getRGB(t);Ft.set(this._rgba,n.r,n.g,n.b,this.getAlpha(t));return this._rgba};fm.prototype.randomColor=function e(){var t=this._colorKeys[Math.trunc(Math.random()*this._colorKeys.length)];var n=this._alphaKeys[Math.trunc(Math.random()*this._alphaKeys.length)];Ft.set(this._rgba,t.r,t.g,t.b,n);return this._rgba};fm.schema={colorKeys:{type:"ColorKey",default:[],array:true},alphaKeys:{type:"AlphaKey",default:[],array:true},mode:{type:"enums",default:"blend",options:["blend","fixed"]}};var hm=function e(){};hm.prototype.evaluate=function e(t,n){switch(this._mode){case"constant":return this._constant;case"curve":return this._curve.evaluate(t)*this._multiplier;case"twoCurves":return je(this._curveMin.evaluate(t),this._curveMax.evaluate(t),n)*this._multiplier;case"twoConstants":return je(this._constantMin,this._constantMax,n)}};hm.schema={mode:{type:"enums",default:"constant",options:["constant","curve","twoCurves","twoConstants"]},curve:{type:"AnimationCurve",default:null},curveMin:{type:"AnimationCurve",default:null},curveMax:{type:"AnimationCurve",default:null},constant:{type:"number",default:0},constantMin:{type:"number",default:0},constantMax:{type:"number",default:0},multiplier:{type:"number",default:1}};var cm=function e(){};cm.prototype.evaluate=function e(t,n){switch(this._mode){case"color":return this._color;case"twoColors":return Ft.set(this._color,je(this._colorMin.r,this._colorMax.r,n),je(this._colorMin.g,this._colorMax.g,n),je(this._colorMin.b,this._colorMax.b,n),je(this._colorMin.a,this._colorMax.a,n));case"randomColor":return this._gradient.randomColor();case"gradient":return this._gradient.evaluate(t);case"twoGradients":this._colorMin=this._gradientMin.evaluate(t);this._colorMax=this._gradientMax.evaluate(t);return Ft.set(this._color,je(this._colorMin.r,this._colorMax.r,n),je(this._colorMin.g,this._colorMax.g,n),je(this._colorMin.b,this._colorMax.b,n),je(this._colorMin.a,this._colorMax.a,n))}};cm.schema={mode:{type:"enums",default:"color",options:["color","gradient","twoColors","twoGradients","randomColor"]},color:{type:"color4",default:[1,1,1,1]},colorMin:{type:"color4",default:[1,1,1,1]},colorMax:{type:"color4",default:[1,1,1,1]},gradient:{type:"Gradient",default:null},gradientMin:{type:"Gradient",default:null},gradientMax:{type:"Gradient",default:null}};var pm={position:Ut.zero(),uv:Dt.zero(),uv0:Rt.zero(),color:Dt.zero(),color0:Dt.zero(),normal:Ut.zero(),tangent:Ut.zero()};var dm={position:{name:Me.ATTR_POSITION,type:Me.ATTR_TYPE_FLOAT32,num:3},uv:{name:Me.ATTR_UV,type:Me.ATTR_TYPE_FLOAT32,num:3},uv0:{name:Me.ATTR_UV0,type:Me.ATTR_TYPE_FLOAT32,num:2},color:{name:Me.ATTR_COLOR,type:Me.ATTR_TYPE_FLOAT32,num:4},normal:{name:Me.ATTR_NORMAL,type:Me.ATTR_TYPE_FLOAT32,num:3},tangent:{name:Me.ATTR_TANGENT,type:Me.ATTR_TYPE_FLOAT32,num:3},custom1:{name:Me.ATTR_UV1,type:Me.ATTR_TYPE_FLOAT32,num:2},custom2:{name:Me.ATTR_UV2,type:Me.ATTR_TYPE_FLOAT32,num:2}};var mm=[0,0,1,0,0,1,1,1];var _m=function e(){this._model=null;this._vertAttrs=[];this._vertAttrFlags={position:true,uv:true,uv0:true,color:true,normal:false,tangent:false,custom1:false,custom2:false,color0:false};this.frameTile=Rt.new(1,1)};_m.prototype.setVertexAtrributes=function e(t){var n=this;for(var r in n._vertAttrFlags){n._vertAttrFlags[r]=false}for(var i=0;i<t.length;++i){var a=dm[t[i]];if(a!==undefined){n._vertAttrs.push(a);n._vertAttrFlags[t[i]]=true}else{console.error("vertex attribute name wrong.")}}this._model.setVertexAttributes(this._vertAttrs)};_m.prototype.onInit=function e(t){this.particleSystem=t;if(this._material===null||this._material===undefined){this._material=new yo;this._material.effect=t._app.assets.get("builtin-effect-particle-premultiply-blend")}this._updateMaterialParams();this._updateModel()};_m.prototype._updateMaterialParams=function e(){if(!this.particleSystem){return}if(this.particleSystem._simulationSpace==="world"){this._material.define("USE_WORLD_SPACE",true)}else{this._material.define("USE_WORLD_SPACE",false)}if(this._renderMode==="billboard"){this._material.define("USE_BILLBOARD",true);this._material.define("USE_STRETCHED_BILLBOARD",false);this._material.define("USE_HORIZONTAL_BILLBOARD",false);this._material.define("USE_VERTICAL_BILLBOARD",false)}else if(this._renderMode==="stretchedBillboard"){this._material.define("USE_BILLBOARD",false);this._material.define("USE_STRETCHED_BILLBOARD",true);this._material.define("USE_HORIZONTAL_BILLBOARD",false);this._material.define("USE_VERTICAL_BILLBOARD",false);this._material.setProperty("velocityScale",this._velocityScale);this._material.setProperty("lengthScale",this._lengthScale)}else if(this._renderMode==="horizontalBillboard"){this._material.define("USE_BILLBOARD",false);this._material.define("USE_STRETCHED_BILLBOARD",false);this._material.define("USE_HORIZONTAL_BILLBOARD",true);this._material.define("USE_VERTICAL_BILLBOARD",false)}else if(this._renderMode==="verticalBillboard"){this._material.define("USE_BILLBOARD",false);this._material.define("USE_STRETCHED_BILLBOARD",false);this._material.define("USE_HORIZONTAL_BILLBOARD",false);this._material.define("USE_VERTICAL_BILLBOARD",true)}else{console.warn("particle system renderMode "+this._renderMode+" not support.")}if(this.particleSystem.textureAnimationModule.enable){this._material.setProperty("frameTile",Rt.set(this.frameTile,this.particleSystem.textureAnimationModule.numTilesX,this.particleSystem.textureAnimationModule.numTilesY))}else{this._material.setProperty("frameTile",this.frameTile)}};_m.prototype._updateModel=function e(){if(!this.particleSystem){return}if(this._model===null){this._model=new Pi.ParticleBatchModel(this.particleSystem._app.device,this.particleSystem._capacity);this._model.setNode(this.particleSystem._entity)}this._model.setEffect(this._material?this._material.effectInst:null);if(this._renderMode==="stretchedBillboard"){this._model.enableStretchedBillboard();this._vertAttrFlags.color0=true}else{this._model.disableStretchedBillboard();this._vertAttrFlags.color0=false}};_m.prototype._updateRenderData=function e(){var t=this;var n=0;for(var r=0;r<this.particleSystem._particles.length;++r){var i=t.particleSystem._particles.data[r];if(t.particleSystem.textureAnimationModule.enable){pm.uv.z=i.frameIndex}else{pm.uv.z=0}for(var a=0;a<4;++a){var s=[];if(t._vertAttrFlags.position){s.push(Ut.set(pm.position,i.position.x,i.position.y,i.position.z))}if(t._vertAttrFlags.uv){pm.uv.x=mm[2*a];pm.uv.y=mm[2*a+1];s.push(pm.uv)}if(t._vertAttrFlags.uv0){s.push(Rt.set(pm.uv0,i.size.x,i.rotation.x))}if(t._vertAttrFlags.color){s.push(Dt.set(pm.color,i.color.r,i.color.g,i.color.b,i.color.a))}if(t._vertAttrFlags.custom1){s.push(t._customData1)}if(t._vertAttrFlags.custom2){s.push(t._customData2)}if(t._vertAttrFlags.color0){s.push(Ut.set(pm.color0,i.ultimateVelocity.x,i.ultimateVelocity.y,i.ultimateVelocity.z))}t._model.addParticleVertexData(n++,s)}}this._model.updateIA(this.particleSystem._particles.length*6)};_m.schema={material:{type:"asset",default:null,set:function e(t){if(this._material===t){return}this._material=t;this._updateMaterialParams();this._updateModel()},parse:function e(t,n){if(typeof n==="string"){var r=new yo;r.copy(t.assets.get(n));return r}return n}},renderMode:{type:"enums",default:"billboard",options:["billboard","stretchedBillboard","horizontalBillboard","verticalBillboard","mesh"],set:function e(t){if(this._renderMode===t){return}this._renderMode=t;this._updateMaterialParams();this._updateModel()}},velocityScale:{type:"number",default:1,set:function e(t){this._velocityScale=t;this._updateMaterialParams();this._updateModel()}},lengthScale:{type:"number",default:.4,set:function e(t){this._lengthScale=t;this._updateMaterialParams();this._updateModel()}}};var vm=function e(){};vm.prototype.animate=function e(t){if(!this._separateAxes){Ut.scale(t.size,t.startSize,this._size.evaluate(1-t.remainingLifetime/t.startLifetime,t.randomSeed))}};vm.schema={enable:{type:"boolean",default:false},separateAxes:{type:"boolean",default:false},size:{type:"CurveRange",default:null},x:{type:"CurveRange",default:null},y:{type:"CurveRange",default:null},z:{type:"CurveRange",default:null}};var gm=function e(){};gm.prototype.animate=function e(t){if(this._enable){Ft.multiply(t.color,t.startColor,this._color.evaluate(1-t.remainingLifetime/t.startLifetime,t.randomSeed))}};gm.schema={enable:{type:"boolean",default:false},color:{type:"GradientRange",default:null}};var ym=Ut.new(0,0,-1);function bm(e,t,n,r){if(t!==e){if(e==="world"){Pt.getRotation(r,n)}else{Pt.invert(n,n);Pt.getRotation(r,n)}return true}else{Ot.identity(r);return false}}function xm(e,t){Rt.set(e,Math.cos(t),Math.sin(t))}function Tm(e){var t=Ze(-1,1);var n=Ze(0,2*Math.PI);var r=Math.sqrt(1-t*t);var i=r*Math.cos(n);var a=r*Math.sin(n);Ut.set(e,i,a,t)}function Sm(e,t,n){Tm(e);Ut.scale(e,e,t+(n-t)*Ke())}function Em(e,t,n,r){xm(e,r);Ut.scale(e,e,t+(n-t)*Ke())}function wm(e,t){Ut.set(e,Ze(-t.x,t.x),Ze(-t.y,t.y),Ze(-t.z,t.z))}function Mm(e){for(var t=0;t<e.length;t++){var n=t+Je(0,e.length-t);var r=e[n];e[n]=e[t];e[t]=r}}function Am(){var e=Ze(-1,1);e===0?e++:e;return lt(e)}var Rm=function e(){this.rotation=Ot.create()};Rm.prototype.update=function e(t,n){this.needTransform=bm(t,this._space,n,this.rotation)};Rm.prototype.animate=function e(t){var n=1-t.remainingLifetime/t.startLifetime;var r=Ut.new(this._x.evaluate(n,t.randomSeed),this._y.evaluate(n,t.randomSeed),this._z.evaluate(n,t.randomSeed));if(this.needTransform){Ut.transformQuat(r,r,this.rotation)}Ut.add(t.animatedVelocity,t.animatedVelocity,r);Ut.add(t.ultimateVelocity,t.velocity,t.animatedVelocity);Ut.scale(t.ultimateVelocity,t.ultimateVelocity,this._speedModifier.evaluate(1-t.remainingLifetime/t.startLifetime,t.randomSeed))};Rm.schema={enable:{type:"boolean",default:false},x:{type:"CurveRange",default:null},y:{type:"CurveRange",default:null},z:{type:"CurveRange",default:null},speedModifier:{type:"CurveRange",default:null},space:{type:"enums",options:["local","world"],default:"local"}};var Um=function e(){this.rotation=Ot.create()};Um.prototype.update=function e(t,n){this.needTransform=bm(t,this._space,n,this.rotation)};Um.prototype.animate=function e(t,n){var r=1-t.remainingLifetime/t.startLifetime;var i=Ut.new(this._x.evaluate(r,t.randomSeed),this._y.evaluate(r,t.randomSeed),this._z.evaluate(r,t.randomSeed));if(this.needTransform){Ut.transformQuat(i,i,this.rotation)}Ut.scaleAndAdd(t.velocity,t.velocity,i,n)};Um.schema={enable:{type:"boolean",default:false},x:{type:"CurveRange",default:null},y:{type:"CurveRange",default:null},z:{type:"CurveRange",default:null},space:{type:"enums",default:"local",options:["local","world"]},randomized:{type:"boolean",default:false}};var Dm=function e(){};Dm.prototype.animate=function e(t){var n=1-t.remainingLifetime/t.startLifetime;var r=Ut.zero();if(this._separateAxes){Ut.set(r,Lm(t.ultimateVelocity.x,this._limitX.evaluate(n,t.randomSeed),this._dampen),Lm(t.ultimateVelocity.y,this._limitY.evaluate(n,t.randomSeed),this._dampen),Lm(t.ultimateVelocity.z,this._limitZ.evaluate(n,t.randomSeed),this._dampen))}else{Ut.normalize(r,t.ultimateVelocity);Ut.scale(r,r,Lm(Ut.magnitude(t.ultimateVelocity),this._limit.evaluate(n,t.randomSeed),this._dampen))}Ut.copy(t.ultimateVelocity,r)};function Lm(e,t,n){var r=Math.sign(e);var i=Math.abs(e);if(i>t){i=je(i,t,n)}return i*r}Dm.schema={enable:{type:"boolean",default:false},limitX:{type:"CurveRange",default:null},limitY:{type:"CurveRange",default:null},limitZ:{type:"CurveRange",default:null},limit:{type:"CurveRange",default:null},dampen:{type:"number",default:0},separateAxes:{type:"boolean",default:false},space:{type:"enums",default:"local",options:["local","world"]},drag:{type:"CurveRange",default:null},multiplyDragByParticleSize:{type:"boolean",default:false},multiplyDragByParticleVelocity:{type:"boolean",default:false}};var Om=function e(){};Om.prototype.animate=function e(t,n){var r=1-t.remainingLifetime/t.startLifetime;if(!this._separateAxes){t.rotation.x+=this._z.evaluate(r,t.randomSeed)*n}else{}};Om.schema={enable:{type:"boolean",default:false},separateAxes:{type:"boolean",default:false,set:function e(t){if(!t){this._separateAxes=t}else{console.error("rotation overtime separateAxes is not supported!")}}},x:{type:"CurveRange",default:null},y:{type:"CurveRange",default:null},z:{type:"CurveRange",default:null}};var Im=function e(){};Im.prototype.animate=function e(t){var n=1-t.remainingLifetime/t.startLifetime;var r=this._startFrame.evaluate(n,t.randomSeed)/(this._numTilesX*this._numTilesY);if(this._animation=="wholeSheet"){t.frameIndex=nt(this._cycleCount*(this._frameOverTime.evaluate(n,t.randomSeed)+r),1)}else if(this._animation=="singleRow"){var i=1/this._numTilesY;if(this._randomRow){var a=nt(this._cycleCount*(this._frameOverTime.evaluate(n,t.randomSeed)+r),1);var s=Math.floor(Math.random()*this._numTilesY);var o=s*i;var l=o+i;t.frameIndex=je(o,l,a)}else{var u=this._rowIndex*i;var f=u+i;t.frameIndex=je(u,f,nt(this._cycleCount*(this._frameOverTime.evaluate(n,t.randomSeed)+r),1))}}};Im.schema={enable:{type:"boolean",default:false},mode:{type:"enums",options:["grid","sprites"],default:"grid",set:function e(t){if(t==="sprites"){console.error("particle texture animation's sprites is not supported!");return}}},numTilesX:{type:"number",default:0},numTilesY:{type:"number",default:0},animation:{type:"enums",options:["wholeSheet","singleRow"],default:"wholeSheet"},frameOverTime:{type:"CurveRange",default:null},startFrame:{type:"CurveRange",default:null},cycleCount:{type:"number",default:0},flipU:{type:"number",default:0,set:function e(t){console.error("particle texture animation's flipU is not supported!")}},flipV:{type:"number",default:0,set:function e(t){console.error("particle texture animation's flipV is not supported!")}},uvChannelMask:{type:"number",default:-1,set:function e(t){console.error("particle texture animation's uvChannelMask is not supported!")}},randomRow:{type:"boolean",default:false},rowIndex:{type:"number",default:0}};var Cm=Ut.zero();var Pm=new Array;var Bm=Ut.new(.5,.5,.5);var Fm=function e(){this.mat=Pt.create();this.quat=Ot.create()};Fm.prototype.onInit=function e(t){this.constructMat();this.particleSystem=t;this.lastTime=t._time;this.totalAngle=0};Fm.prototype.constructMat=function e(){Ot.fromEuler(this.quat,this._rotation.x,this._rotation.y,this._rotation.z);Pt.fromRTS(this.mat,this.quat,this._position,this._scale)};Fm.prototype.emit=function e(t){switch(this._shapeType){case"box":Gm(this._emitFrom,this._boxThickness,t.position,t.velocity);break;case"circle":Vm(this._radius,this._radiusThickness,this.generateArcAngle(),t.position,t.velocity);break;case"cone":Nm(this._emitFrom,this._radius,this._radiusThickness,this.generateArcAngle(),this._angle,this._length,t.position,t.velocity);break;case"sphere":zm(this._emitFrom,this._radius,this._radiusThickness,t.position,t.velocity);break;case"hemisphere":km(this._emitFrom,this._radius,this._radiusThickness,t.position,t.velocity);break;default:console.warn(this._shapeType+" shapeType is not supported by ShapeModule.")}if(this._randomPositionAmount>0){t.position.x+=Ze(-this._randomPositionAmount,this._randomPositionAmount);t.position.y+=Ze(-this._randomPositionAmount,this._randomPositionAmount);t.position.z+=Ze(-this._randomPositionAmount,this._randomPositionAmount)}Ut.transformQuat(t.velocity,t.velocity,this.quat);Ut.transformMat4(t.position,t.position,this.mat);if(this._sphericalDirectionAmount>0){var n=Ut.normalize(Cm,t.position);Ut.lerp(t.velocity,t.velocity,n,this._sphericalDirectionAmount)}this.lastTime=this.particleSystem._time};Fm.prototype.generateArcAngle=function e(){if(this._arcMode==="random"){return Ze(0,this._arc)}var t=this.totalAngle+2*Math.PI*this._arcSpeed.evaluate(this.particleSystem._time)*(this.particleSystem._time-this.lastTime);this.totalAngle=t;if(this._arcSpread!==0){t=Math.floor(t/(this._arc*this._arcSpread))*this._arc*this._arcSpread}switch(this._arcMode){case"loop":return nt(t,this._arc);case"pingPong":return rt(t,this._arc)}};function zm(e,t,n,r,i){switch(e){case"volume":Sm(r,t*(1-n),t);Ut.copy(i,r);Ut.normalize(i,i);break;case"shell":Tm(r);Ut.scale(r,t);Ut.copy(i,r);break;default:console.warn(e+" is not supported for sphere emitter.")}}function km(e,t,n,r,i){switch(e){case"volume":Sm(r,t*(1-n),t);if(r.z>0){r.z*=-1}Ut.copy(i,r);Ut.normalize(i,i);break;case"shell":Tm(r);Ut.scale(r,t);if(r.z<0){r.z*=-1}Ut.copy(i,r);break;default:console.warn(e+" is not supported for hemisphere emitter.")}}function Nm(e,t,n,r,i,a,s,o){switch(e){case"base":Em(s,t*(1-n),t,r);Rt.scale(o,s,Math.sin(i));o.z=-Math.cos(i)*t;s.z=0;break;case"shell":xm(s,r);Rt.scale(o,s,Math.sin(i));o.z=-Math.cos(i);Rt.scale(s,s,t);s.z=0;break;case"volume":Em(s,t*(1-n),t,r);Rt.scale(o,s,Math.sin(i));o.z=-Math.cos(i)*t;Ut.normalize(o,o);s.z=0;Ut.add(s,s,Ut.scale(Cm,o,a*Ke()/-o.z));break;default:console.warn(e+" is not supported for cone emitter.")}}function Gm(e,t,n,r){switch(e){case"volume":wm(n,Bm);break;case"shell":Pm.splice(0,Pm.length);Pm.push(Ze(-.5,.5));Pm.push(Ze(-.5,.5));Pm.push(Am()*.5);Mm(Pm);Hm(Pm,t);Ut.set(n,Pm[0],Pm[1],Pm[2]);break;case"edge":Pm.splice(0,Pm.length);Pm.push(Ze(-.5,.5));Pm.push(Am()*.5);Pm.push(Am()*.5);Mm(Pm);Hm(Pm,t);Ut.set(n,Pm[0],Pm[1],Pm[2]);break;default:console.warn(e+" is not supported for box emitter.")}Ut.copy(r,ym)}function Vm(e,t,n,r,i){Em(r,e*(1-t),e,n);Ut.normalize(i,r)}function Hm(e,t){if(t.x>0){e[0]+=.5*Ze(-t.x,t.x);e[0]=We(e[0],-.5,.5)}if(t.y>0){e[1]+=.5*Ze(-t.y,t.y);e[1]=We(e[0],-.5,.5)}if(t.z>0){e[2]+=.5*Ze(-t.z,t.z);e[2]=We(e[0],-.5,.5)}}Fm.schema={enable:{type:"boolean",default:false},shapeType:{type:"enums",options:["box","circle","cone","sphere","hemisphere"],default:"box"},emitFrom:{type:"enums",options:["base","edge","shell","volume"],default:"base"},position:{type:"vec3",default:[0,0,0],set:function e(t){this._position=t;this.constructMat()}},rotation:{type:"vec3",default:[0,0,0],set:function e(t){this._rotation=t;this.constructMat()}},scale:{type:"vec3",default:[1,1,1],set:function e(t){this._scale=t;this.constructMat()}},alignToDirection:{type:"boolean",default:false},randomDirectionAmount:{type:"number",default:0},sphericalDirectionAmount:{type:"number",default:0},randomPositionAmount:{type:"number",default:0},radius:{type:"number",default:0},radiusThickness:{type:"number",default:1},arc:{type:"number",default:0},arcMode:{type:"enums",options:["random","loop","pingPong"],default:"random"},arcSpread:{type:"number",default:0},arcSpeed:{type:"CurveRange",default:null},angle:{type:"number",default:0},length:{type:"number",default:0},boxThickness:{type:"vec3",default:[0,0,0]}};var Wm=function e(){this._remainingCount=1;this._curTime=0};Wm.prototype.update=function e(t,n){if(t._loop&&this._remainingCount===0){this._remainingCount=this._repeatCount;this._curTime=this._time}if(this._remainingCount>0){var r=nt(t._time-t._startDelay.evaluate(),t._duration)-n;r=r>0?r:0;var i=nt(t.time-t._startDelay.evaluate(),t._duration);if(this._curTime>=r&&this._curTime<i){t.emit(this._count.evaluate(this._curTime/t._duration));this._curTime+=this._repeatInterval;--this._remainingCount}}};Wm.schema={time:{type:"number",default:0,set:function e(t){this._time=t;this._curTime=t}},minCount:{type:"int",default:30},maxCount:{type:"int",default:30},repeatCount:{type:"number",default:1,set:function e(t){this._repeatCount=t;this._remainingCount=t}},repeatInterval:{type:"number",default:1},count:{type:"CurveRange",default:null}};Ea.registerClass("Burst",Wm);Ea.registerClass("ColorKey",lm);Ea.registerClass("AlphaKey",um);Ea.registerClass("Gradient",fm);Ea.registerClass("GradientRange",cm);Ea.registerClass("CurveRange",hm);Ea.registerClass("SizeOvertimeModule",vm);Ea.registerClass("ColorOverLifetimeModule",gm);Ea.registerClass("ParticleSystemRenderer",_m);Ea.registerClass("VelocityOvertimeModule",Rm);Ea.registerClass("ForceOvertimeModule",Um);Ea.registerClass("LimitVelocityOvertimeModule",Dm);Ea.registerClass("RotationOvertimeModule",Om);Ea.registerClass("TextureAnimationModule",Im);Ea.registerClass("ShapeModule",Fm);var Xm=Pt.create();var jm=function(e){function t(){e.call(this);this._isPlaying=false;this._isPaused=false;this._isStopped=true;this._isEmitting=false;this._time=0;this._emitRateTimeCounter=0;this._emitRateDistanceCounter=0;this._oldWPos=Ut.zero();this._curWPos=Ut.zero();this._customData1=Rt.zero();this._customData2=Rt.zero();this._subEmitters=[];this._vertAttrs=[];this._vertAttrFlags={position:true,uv:true,uv0:true,color:true,normal:false,tangent:false,custom1:false,custom2:false,color0:false}}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;var n={isPlaying:{configurable:true},isPaused:{configurable:true},isStopped:{configurable:true},isEmitting:{configurable:true},time:{configurable:true}};t.prototype.onInit=function e(){var t=this;this._particles=new cr(function(){return new om(t)},this._capacity);this._renderer.onInit(this);this._shapeModule.onInit(this);this._entity.getWorldPos(this._oldWPos);Ut.copy(this._curWPos,this._oldWPos);this._system.add(this)};t.prototype.onDestroy=function e(){this._renderer._model.destroy();this._system.remove(this)};t.prototype.onEnable=function e(){this._app.scene.addModel(this._renderer._model);if(this._playOnAwake){this.play()}};t.prototype.onDisable=function e(){this._app.scene.removeModel(this._renderer._model)};t.prototype.play=function e(){if(this._isPaused){this._isPaused=false}if(this._isStopped){this._isStopped=false}this._time=0;this._emitRateTimeCounter=0;this._emitRateDistanceCounter=0;this._isPlaying=true;if(this._prewarm){this._prewarmSystem()}};t.prototype.pause=function e(){if(this._isStopped){console.warn("pause(): particle system is already stopped.");return}if(this._isPlaying){this._isPlaying=false}this._isPaused=true};t.prototype.stop=function e(){if(this._isPlaying){this._isPlaying=false}if(this._isPaused){this._isPaused=false}this.clear();this._time=0;this._emitRateTimeCounter=0;this._emitRateDistanceCounter=0;this._isStopped=true};t.prototype.clear=function e(){this._particles.reset();this._renderer._model.clear()};t.prototype.emit=function e(t,n){var r=this;if(n===void 0)n=null;for(var i=0;i<t;++i){if(r._particles.length>=r._capacity){return}var a=r._particles.add();var s=Qe(Je(0,st));if(r._shapeModule.enable){r._shapeModule.emit(a)}else{Ut.set(a.position,0,0,0);Ut.copy(a.velocity,ym)}Ut.scale(a.velocity,a.velocity,r._startSpeed.evaluate(r._time/r._duration,s));switch(r._simulationSpace){case"local":break;case"world":{r._entity.getWorldMatrix(Xm);Ut.transformMat4(a.position,a.position,Xm);var o=Ot.create();r._entity.getWorldRot(o);Ut.transformQuat(a.velocity,a.velocity,o)}break;case"custom":break}Ut.set(a.rotation,r._startRotation.evaluate(r._time/r._duration,s),0,0);Ut.set(a.startSize,r._startSize.evaluate(r._time/r._duration,s),0,0);Ut.copy(a.size,a.startSize);Ft.copy(a.startColor,r._startColor.evaluate(r._time/r._duration,s));Ft.copy(a.color,a.startColor);a.startLifetime=r._startLifetime.evaluate(r._time/r._duration,s);a.remainingLifetime=a.startLifetime;a.randomSeed=Qe(Je(0,st))}};t.prototype._updateParticles=function e(t){var n=this;this._entity.getWorldMatrix(Xm);if(this._velocityOvertimeModule.enable){this._velocityOvertimeModule.update(this._simulationSpace,Xm)}if(this._forceOvertimeModule.enable){this._forceOvertimeModule.update(this._simulationSpace,Xm)}for(var r=0;r<this._particles.length;++r){var i=n._particles.data[r];i.remainingLifetime-=t;Ut.set(i.animatedVelocity,0,0,0);if(i.remainingLifetime<0){n._particles.remove(r);--r;continue}i.velocity.y-=n._gravityModifier.evaluate(1-i.remainingLifetime/i.startLifetime,i.randomSeed)*9.8*t;if(n._sizeOvertimeModule.enable){n._sizeOvertimeModule.animate(i)}if(n._colorOverLifetimeModule.enable){n._colorOverLifetimeModule.animate(i)}if(n._forceOvertimeModule.enable){n._forceOvertimeModule.animate(i,t)}if(n._velocityOvertimeModule.enable){n._velocityOvertimeModule.animate(i)}else{Ut.copy(i.ultimateVelocity,i.velocity)}if(n._limitVelocityOvertimeModule.enable){n._limitVelocityOvertimeModule.animate(i)}if(n._rotationOvertimeModule.enable){n._rotationOvertimeModule.animate(i,t)}if(n._textureAnimationModule.enable){n._textureAnimationModule.animate(i)}Ut.scaleAndAdd(i.position,i.position,i.ultimateVelocity,t)}};t.prototype._prewarmSystem=function e(){var t=this;this._startDelay.mode="constant";this._startDelay.constant=0;var n=1;var r=this._duration/n;for(var i=0;i<r;++i){t._time+=n;t._emit(n);t._updateParticles(n)}};t.prototype._emit=function e(t){var n=this;var r=this._startDelay.evaluate();if(this._time>r){if(!this._isStopped){this._isEmitting=true}if(this._time>this._duration+r){if(!this._loop){this._isEmitting=false;this._isStopped=true}}this._emitRateTimeCounter+=this._rateOverTime.evaluate(this._time/this._duration,1)*t;if(this._emitRateTimeCounter>1&&this._isEmitting){var i=Math.floor(this._emitRateTimeCounter);this._emitRateTimeCounter-=i;this.emit(i)}this._entity.getWorldPos(this._curWPos);var a=Ut.distance(this._curWPos,this._oldWPos);Ut.copy(this._oldWPos,this._curWPos);this._emitRateDistanceCounter+=a*this._rateOverDistance.evaluate(this._time/this._duration,1);if(this._emitRateDistanceCounter>1&&this._isEmitting){var s=Math.floor(this._emitRateDistanceCounter);this._emitRateDistanceCounter-=s;this.emit(s)}for(var o=0;o<this._bursts.length;++o){n._bursts[o].update(n,t)}}};t.prototype.tick=function e(t){var n=t*this._simulationSpeed;if(this._isPlaying){this._time+=n;this._emit(n);this._updateParticles(n);this.renderer._updateRenderData()}};t.prototype.addSubEmitter=function e(t){this._subEmitters.push(t)};t.prototype.removeSubEmitter=function e(t){this._subEmitters.remove(t)};t.prototype.addBurst=function e(t){this._bursts.push(t)};t.prototype.removeBurst=function e(t){this._bursts.remove(t)};t.prototype.getParticleCount=function e(){return this._particles.length};t.prototype.setCustomData1=function e(t,n){Rt.set(this._customData1,t,n)};t.prototype.setCustomData2=function e(t,n){Rt.set(this._customData2,t,n)};n.isPlaying.get=function(){return this._isPlaying};n.isPaused.get=function(){return this._isPaused};n.isStopped.get=function(){return this._isStopped};n.isEmitting.get=function(){return this._isEmitting};n.time.get=function(){return this._time};Object.defineProperties(t.prototype,n);return t}(ia);jm.schema={capacity:{type:"int",default:2e3},startColor:{type:"GradientRange",default:{mode:"color",color:[1,1,1,1]}},startSize:{type:"CurveRange",default:{mode:"constant",constant:1}},startSpeed:{type:"CurveRange",default:{mode:"constant",constant:5}},startRotation:{type:"CurveRange",default:{mode:"constant",constant:0}},startDelay:{type:"CurveRange",default:{mode:"constant",constant:0}},startLifetime:{type:"CurveRange",default:{mode:"constant",constant:5}},duration:{type:"number",default:5},loop:{type:"boolean",default:true},prewarm:{type:"boolean",default:false,set:function e(t){if(t===true&&this._loop===false){}this._prewarm=t}},simulationSpace:{type:"enums",default:"local",options:["local","world","custom"],set:function e(t){if(t==="world"){this._renderer._material.define("USE_WORLD_SPACE",true)}else{this._renderer._material.define("USE_WORLD_SPACE",false)}this._simulationSpace=t}},simulationSpeed:{type:"number",default:1},playOnAwake:{type:"boolean",default:false},gravityModifier:{type:"CurveRange",default:{mode:"constant",constant:0}},rateOverTime:{type:"CurveRange",default:{mode:"constant",constant:10}},rateOverDistance:{type:"CurveRange",default:{mode:"constant",constant:10}},bursts:{type:"Burst",default:[],array:true},colorOverLifetimeModule:{type:"ColorOverLifetimeModule",default:null},shapeModule:{type:"ShapeModule",default:null},renderer:{type:"ParticleSystemRenderer",default:null},sizeOvertimeModule:{type:"SizeOvertimeModule",default:null},velocityOvertimeModule:{type:"VelocityOvertimeModule",default:null},forceOvertimeModule:{type:"ForceOvertimeModule",default:null},limitVelocityOvertimeModule:{type:"LimitVelocityOvertimeModule",default:null},rotationOvertimeModule:{type:"RotationOvertimeModule",default:null},textureAnimationModule:{type:"TextureAnimationModule",default:null}};var qm=Pt.create();var Ym=function(e){function t(){e.call(this);this._rect={x:0,y:0,w:0,h:0}}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype._onRectChanged=function e(){};t.prototype.setAnchors=function e(t,n,r,i){this._anchorLeft=t;this._anchorRight=r;this._anchorBottom=n;this._anchorTop=i};t.prototype.setOffset=function e(t,n){this._offsetX=t;this._offsetY=n};t.prototype.setSize=function e(t,n){this._sizeX=t;this._sizeY=n};t.prototype.setPivot=function e(t,n){this._pivotX=t;this._pivotY=n};t.prototype.getLeft=function e(){return this._offsetX-this._sizeX*this._pivotX};t.prototype.getRight=function e(){return-(this._offsetX+this._sizeX*(1-this._pivotX))};t.prototype.getBottom=function e(){return this._offsetY-this._sizeY*this._pivotY};t.prototype.getTop=function e(){return-(this._offsetY+this._sizeY*(1-this._pivotY))};t.prototype.setLeft=function e(t){var n=t-(this._offsetX-this._sizeX*this._pivotX);this._sizeX-=n;this._offsetX+=n*(1-this._pivotX)};t.prototype.setRight=function e(t){var n=-t-(this._offsetX+this._sizeX*(1-this._pivotX));this._sizeX+=n;this._offsetX+=n*this._pivotX};t.prototype.setBottom=function e(t){var n=t-(this._offsetY-this._sizeY*this._pivotY);this._sizeY-=n;this._offsetY+=n*(1-this._pivotY)};t.prototype.setTop=function e(t){var n=-t-(this._offsetY+this._sizeY*(1-this._pivotY));this._sizeY+=n;this._offsetY+=n*this._pivotY};t.prototype.calculate=function e(t,n,r,i){var a=t+r*this._anchorLeft;var s=n+i*this._anchorBottom;var o=t+r*this._anchorRight;var l=n+i*this._anchorTop;var u=0;var f=0;var h=0;var c=0;h=o-a+this._sizeX;c=l-s+this._sizeY;u=a+this._offsetX-this._sizeX*this._pivotX;f=s+this._offsetY-this._sizeY*this._pivotY;var p=u+h*this._pivotX;var d=f+c*this._pivotY;Ut.set(this._entity.lpos,p,d,this._entity.lpos.z);u=u-p;f=f-d;if(u!==this._rect.x||f!==this._rect.y||h!==this._rect.w||c!==this._rect.h){this._onRectChanged()}this._rect.x=u;this._rect.y=f;this._rect.w=h;this._rect.h=c};t.prototype.getWorldCorners=function e(t,n,r,i){this._entity.getWorldMatrix(qm);var a=this._rect.x;var s=this._rect.y;var o=this._rect.w;var l=this._rect.h;Ut.set(t,a,s+l,0);Ut.transformMat4(t,t,qm);Ut.set(n,a,s,0);Ut.transformMat4(n,n,qm);Ut.set(r,a+o,s,0);Ut.transformMat4(r,r,qm);Ut.set(i,a+o,s+l,0);Ut.transformMat4(i,i,qm)};return t}(ia);Ym.schema={focusable:{type:"boolean",default:false},pivotX:{type:"number",default:.5},pivotY:{type:"number",default:.5},anchorLeft:{type:"number",default:.5},anchorBottom:{type:"number",default:.5},anchorRight:{type:"number",default:.5},anchorTop:{type:"number",default:.5},offsetX:{type:"number",default:0},offsetY:{type:"number",default:0},sizeX:{type:"number",default:100},sizeY:{type:"number",default:100}};var Km=function(e){function t(){e.call(this);this._view=new Pi.View}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.onInit=function e(){this._view._clearFlags=Pi.CLEAR_DEPTH|Pi.CLEAR_STENCIL;this._view._cullingByID=true;this._view._stages=["ui"];this._view._stencil=0;this._view._priority=this._priority;this._system.addScreen(this)};t.prototype.onDestroy=function e(){this._system.removeScreen(this)};return t}(Ym);Km.schema={priority:{type:"number",default:0,set:function e(t){if(this._priority===t){return}this._priority=t;this._view._priority=t}},width:{type:"number",default:960,set:function e(t){this._width=t}},height:{type:"number",default:640,set:function e(t){this._height=t}},scaleFactor:{type:"number",default:1,set:function e(t){if(this._scaleFactor===t){return}this._scaleFactor=t;this._entity.lscale=Ut.new(this._scaleFactor,this._scaleFactor,this._scaleFactor)}}};var Zm=function(e){function t(){e.apply(this,arguments)}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.onInit=function e(){this._system.add(this)};t.prototype.onDestroy=function e(){this._system.remove(this)};return t}(ia);var Jm=function(e){function t(){e.apply(this,arguments)}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.tick=function e(){var t=this._entity&&this._entity.getComp("Screen");if(!t){return}var n=this._app._canvas;var r=[n.width/t.width,n.height/t.height];if(this._adaptionMode==="match-width-or-height"){var i=Math.log2(r[0]);var a=Math.log2(r[1]);var s=je(i,a,this._match);this._scaleFactor=Math.pow(2,s)}else if(this._adaptionMode==="expand"){this._scaleFactor=Math.min(r[0],r[1])}else if(this._adaptionMode==="shrink"){this._scaleFactor=Math.max(r[0],r[1])}t.scaleFactor=this._scaleFactor};return t}(Zm);Jm.schema={adaptionMode:{type:"enums",default:"none",options:["none","match-width-or-height","expand","shrink"],set:function e(t){if(this._adaptionMode===t){return}this._adaptionMode=t;this._adaption()}},match:{type:"number",default:0},scaleFactor:{type:"number",default:1,set:function e(t){if(this._scaleFactor===t){return}if(this._adaptionMode!=="none"){return}this._scaleFactor=t}}};var Qm=[0,0,0,0];var $m=[0,0,0,0];var e_=Pt.create();var t_=[0,1,2,3,2,1];var n_=[0,1,4,5,4,1,1,2,5,6,5,2,2,3,6,7,6,3,4,5,8,9,8,5,5,6,9,10,9,6,6,7,10,11,10,7,8,9,12,13,12,9,9,10,13,14,13,10,10,11,14,15,14,11];var r_=[0,1,2,0,3,4,0,5,6,0,7,8,0,9,10];function i_(e,t){var n=4;var r=null;if(e==="simple"){n=4;r=t_}else if(e==="sliced"){n=16;r=n_}else if(e==="filled"){if(t==="radial"){n=11}else{n=4;r=t_}}var i=new Array(n);var a=new Array(n);var s=new Array(n);var o=Ft.create();for(var l=0;l<n;++l){a[l]=Ut.zero();i[l]=Ut.zero();s[l]=Ut.zero()}return{wposList:a,lposList:i,uvs:s,color:o,indices:r}}function a_(e,t,n,r,i,a){Ut.set(e.lposList[0],n,r,0);Ut.set(e.lposList[1],n+i,r,0);Ut.set(e.lposList[2],n,r+a,0);Ut.set(e.lposList[3],n+i,r+a,0);Ut.copy(e.uvs[0],t.uvs[0]);Ut.copy(e.uvs[1],t.uvs[3]);Ut.copy(e.uvs[2],t.uvs[12]);Ut.copy(e.uvs[3],t.uvs[15]);return e}function s_(e,t,n,r,i,a){var s=1;var o=1;if(t._left+t._right>i){s=i/(t._left+t._right)}if(t._bottom+t._top>a){o=a/(t._bottom+t._top)}Qm[0]=n;Qm[1]=n+t._left*s;Qm[2]=n+i-t._right*s;Qm[3]=n+i;$m[0]=r;$m[1]=r+t._bottom*o;$m[2]=r+a-t._top*o;$m[3]=r+a;for(var l=0;l<4;++l){for(var u=0;u<4;++u){Ut.set(e.lposList[l*4+u],Qm[u],$m[l],0)}}for(var f=0;f<16;++f){Ut.copy(e.uvs[f],t.uvs[f])}return e}function o_(e,t,n,r,i,a,s,o){s=s<0?0:s;s=s>1?1:s;o=o<0?0:o;var l=o+s>1?1:o+s;Ut.set(e.lposList[0],i*s+n,r,0);Ut.set(e.lposList[1],i*l+n,r,0);Ut.set(e.lposList[2],i*s+n,r+a,0);Ut.set(e.lposList[3],i*l+n,r+a,0);Ut.lerp(e.uvs[0],t.uvs[0],t.uvs[3],s);Ut.lerp(e.uvs[1],t.uvs[0],t.uvs[3],l);Ut.lerp(e.uvs[2],t.uvs[12],t.uvs[15],s);Ut.lerp(e.uvs[3],t.uvs[12],t.uvs[15],l);return e}function l_(e,t,n,r,i,a,s,o){s=s<0?0:s;s=s>1?1:s;o=o<0?0:o;var l=o+s>1?1:o+s;Ut.set(e.lposList[0],n,r+a*s,0);Ut.set(e.lposList[1],i+n,r+a*s,0);Ut.set(e.lposList[2],n,r+a*l,0);Ut.set(e.lposList[3],i+n,r+a*l,0);Ut.lerp(e.uvs[0],t.uvs[0],t.uvs[12],s);Ut.lerp(e.uvs[1],t.uvs[3],t.uvs[15],s);Ut.lerp(e.uvs[2],t.uvs[0],t.uvs[12],l);Ut.lerp(e.uvs[3],t.uvs[3],t.uvs[15],l);return e}function u_(e,t){var n,r;n=t.x-e.x;r=t.y-e.y;if(n===0&&r===0){return NaN}else if(n===0){if(r>0){return Math.PI*.5}else{return Math.PI*1.5}}else{var i=Math.atan(r/n);if(n<0){i+=Math.PI}return i}}function f_(e,t,n,r,i){var a=e.left;var s=e.right;var o=e.top;var l=e.bottom;var u=Math.sin(n);var f=Math.cos(n);var h,c;if(Math.cos(n)!==0){h=u/f;if((a-t.x)*f>0){var p=t.y+h*(a-t.x);r[3].x=a;r[3].y=p;Ut.lerp(i[3],e.uvbl,e.uvtl,(p-e.bottom)/(e.top-e.bottom))}if((s-t.x)*f>0){var d=t.y+h*(s-t.x);r[1].x=s;r[1].y=d;Ut.lerp(i[1],e.uvbr,e.uvtr,(d-e.bottom)/(e.top-e.bottom))}}if(Math.sin(n)!==0){c=f/u;if((o-t.y)*u>0){var m=t.x+c*(o-t.y);r[2].x=m;r[2].y=o;Ut.lerp(i[2],e.uvtl,e.uvtr,(m-e.left)/(e.right-e.left))}if((l-t.y)*u>0){var _=t.x+c*(l-t.y);r[0].x=_;r[0].y=l;Ut.lerp(i[0],e.uvbl,e.uvbr,(_-e.left)/(e.right-e.left))}}}var h_=function(){var e=[Ut.zero(),Ut.zero(),Ut.zero(),Ut.zero()];var t=[Ut.zero(),Ut.zero(),Ut.zero(),Ut.zero()];var n=[Ut.zero(),Ut.zero(),Ut.zero(),Ut.zero()];var r=[Ut.zero(),Ut.zero(),Ut.zero(),Ut.zero()];var i=Ut.zero();var a=Ut.zero();var s=[Ut.zero(),Ut.zero(),Ut.zero(),Ut.zero()];var o=[0,0,0,0];var l=Ut.zero();var u=Ut.zero();var f={left:0,right:100,bottom:0,top:100,uvbl:Ut.new(0,0,0),uvbr:Ut.new(1,0,0),uvtl:Ut.new(0,1,0),uvtr:Ut.new(1,1,0)};var h=new Array(4);return function(c,p,d,m,_,v,g,y,b,x){Ut.sub(l,p.uvs[3],p.uvs[0]);Ut.sub(u,p.uvs[12],p.uvs[0]);h[0]=p.uvs[0];h[1]=p.uvs[3];h[2]=p.uvs[15];h[3]=p.uvs[12];if(y>=1){a_(c,p,d,m,_,v);c.indices=t_;return c}c.indices=r_;y=y<0?0:y;while(g>=1){g=g-1}while(g<0){g=g+1}g=g*Math.PI*2;y=y*Math.PI*2;var T=g+y;i.x=b<0?0:b;i.y=x<0?0:x;i.x=b>1?1:b;i.y=x>1?1:x;Ut.copy(a,p.uvs[0]);a.x+=l.x*b;a.y+=l.y*b;a.x+=u.x*x;a.y+=u.y*x;i.x=i.x*_;i.y=i.y*v;s[0].x=0;s[0].y=0;s[1].x=_;s[1].y=0;s[2].x=_;s[2].y=v;s[3].x=0;s[3].y=v;for(var S=0;S<4;++S){o[S]=u_(i,s[S])}f.left=0;f.bottom=0;f.right=_;f.top=v;f.uvbl=p.uvs[0];f.uvbr=p.uvs[3];f.uvtl=p.uvs[12];f.uvtr=p.uvs[15];f_(f,i,g,e,n);f_(f,i,T,t,r);var E=1;Ut.copy(c.lposList[0],i);Ut.copy(c.uvs[0],a);for(var w=0;w<4;++w){var M=o[w];var A=o[(w+1)%4];if(A<M){A+=Math.PI*2}M-=Math.PI*2;A-=Math.PI*2;for(var R=0;R<3;++R){if(M>=T){}else if(M>=g){if(A>=T){Ut.copy(c.lposList[E],s[w]);Ut.copy(c.lposList[E+1],t[w]);Ut.copy(c.uvs[E],h[w]);Ut.copy(c.uvs[E+1],r[w]);E+=2}else{Ut.copy(c.lposList[E],s[w]);Ut.copy(c.lposList[E+1],s[(w+1)%4]);Ut.copy(c.uvs[E],h[w]);Ut.copy(c.uvs[E+1],h[(w+1)%4]);E+=2}}else{if(A<=g){}else if(A<=T){Ut.copy(c.lposList[E],e[w]);Ut.copy(c.lposList[E+1],s[(w+1)%4]);Ut.copy(c.uvs[E],n[w]);Ut.copy(c.uvs[E+1],h[(w+1)%4]);E+=2}else{Ut.copy(c.lposList[E],e[w]);Ut.copy(c.lposList[E+1],t[w]);Ut.copy(c.uvs[E],n[w]);Ut.copy(c.uvs[E+1],r[w]);E+=2}}M+=Math.PI*2;A+=Math.PI*2}}for(var U=0;U<E;++U){c.lposList[U].x+=d;c.lposList[U].y+=m}for(var D=E;D<c.lposList.length;++D){Ut.copy(c.lposList[D],c.lposList[0])}return c}}();var c_=function(e){function t(){e.apply(this,arguments)}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.onInit=function e(){this._cachedVertexData=i_(this._type,this._fillType);this._vertexDataDirty=true;if(this._material===null){this._material=this._app.assets.get("builtin-material-sprite")}};t.prototype._onRectChanged=function e(){this._vertexDataDirty=true};t.prototype.calcVertexData=function e(t,n,r,i){var a=this;if(this._vertexDataDirty){this._vertexDataDirty=false;var s=this._sprite;if(s===null){s=this._app.assets.get("default-sprite")}Ft.copy(this._cachedVertexData.color,this._color);if(this._type==="simple"){a_(this._cachedVertexData,s,t,n,r,i)}else if(this._type=="sliced"){s_(this._cachedVertexData,s,t,n,r,i)}else if(this._type==="filled"){if(this._fillType==="radial"){h_(this._cachedVertexData,s,t,n,r,i,this._fillStart,this._fillRange,this._fillCenter.x,this._fillCenter.y)}else if(this._fillType==="vertical"){l_(this._cachedVertexData,s,t,n,r,i,this._fillStart,this._fillRange)}else{o_(this._cachedVertexData,s,t,n,r,i,this._fillStart,this._fillRange)}}}this._entity.getWorldMatrix(e_);for(var o=0;o<this._cachedVertexData.lposList.length;++o){var l=a._cachedVertexData.lposList[o];var u=a._cachedVertexData.wposList[o];Ut.transformMat4(u,l,e_)}return this._cachedVertexData};return t}(Ym);c_.schema={material:{type:"asset",default:null,set:function e(t){if(t===this._material){return}this._material=t}},type:{type:"enums",default:"simple",options:["simple","sliced","filled"],set:function e(t){if(t===this._type){return}this._type=t;this._cachedVertexData=i_(this._type,this._fillType);this._vertexDataDirty=true}},fillType:{type:"enums",default:"horizontal",options:["horizontal","vertical","radial"],set:function e(t){if(t===this._fillType){return}this._fillType=t;if(this._type==="filled"){this._cachedVertexData=i_(this._type,this._fillType);this._vertexDataDirty=true}}},fillStart:{type:"number",default:.2,set:function e(t){if(t===this._fillStart){return}this._fillStart=t;if(this._type==="filled"){this._vertexDataDirty=true}}},fillRange:{type:"number",default:.8,set:function e(t){if(t===this._fillRange){return}this._fillRange=t;if(this._type==="filled"){this._vertexDataDirty=true}}},fillCenter:{type:"vec2",default:[.5,.5],set:function e(t){if(Rt.equals(this._fillCenter,t)){return}this._fillCenter=t;if(this._type==="filled"&&this._fillType==="radial"){this._vertexDataDirty=true}}},sprite:{type:"asset",default:null,set:function e(t){if(t===this._sprite){return}this._sprite=t;this._vertexDataDirty=true}},color:{type:"color4",default:[1,1,1,1],set:function e(t){if(Ft.equals(this._color,t)){return}Ft.copy(this._color,t);this._vertexDataDirty=true}}};var p_=Pt.create();var d_=document.createElement("canvas");d_.width=d_.height=1;function m_(e){var t=4*e;var n=6*e;var r=new Array(n);var i=new Array(t);var a=new Array(t);var s=new Array(t);var o=Ft.new();for(var l=0;l<t;++l){a[l]=Ut.zero();i[l]=Ut.zero();s[l]=Rt.zero()}for(var u=0;u<e;++u){r[6*u+0]=4*u+0;r[6*u+1]=4*u+1;r[6*u+2]=4*u+2;r[6*u+3]=4*u+3;r[6*u+4]=4*u+2;r[6*u+5]=4*u+1}return{wposList:a,lposList:i,uvs:s,color:o,indices:r}}function __(e,t,n){var r=0;if(e._font===null){r=t.measureText(n).width}else{var i=e._fontSize/e._font._size;for(var a=0;a<n.length;++a){var s=n.charCodeAt(a);var o=e._font._glyphs[s]||e._font._defaultGlyph;r+=o.xadvance*i}}return r}function v_(e,t,n){var r=[];var i=t.split(e._regWordSep);var a=0;var s=0;var o=0;var l=d_.getContext("2d");if(e._font===null){var u=e._italic?"italic":"";var f=e._bold?"bold":"";var h=u+" "+f+" "+e._fontSize+"px "+e._fontFamily;l.font=h}for(var c=0;c+1<i.length;){var p=__(e,l,i[c]);var d=__(e,l,i[c+1]);if(o+p+d<n){if(c!==0&&o===0){o+=d;a=a+i[c].length;s+=i[c].length+i[c+1].length;c+=2}else{o+=p+d;s+=i[c].length+i[c+1].length;c+=2}}else if(o===0){r.push({start:a+i[c].length,end:a+i[c].length+i[c+1].length,width:d});a=a+i[c].length+i[c+1].length;s=a;o=0;c+=2}else{r.push({start:a,end:s,width:o});a=s;o=0}}if(o>0){r.push({start:a,end:s,width:o})}return r}function g_(e,t,n,r,i){function a(t){var n=t.text.slice(t.start,t.end);var i=d.measureText(n).width;var a=(r-i)*e._alignH;o.fillText(n,a,t.y)}var s=e._cachedVertexData;Ut.set(s.lposList[0],t,n,0);Ut.set(s.lposList[1],t+r,n,0);Ut.set(s.lposList[2],t,n+i,0);Ut.set(s.lposList[3],t+r,n+i,0);Rt.set(s.uvs[0],0,0);Rt.set(s.uvs[1],1,0);Rt.set(s.uvs[2],0,1);Rt.set(s.uvs[3],1,1);e._fontCanvas.width=r;e._fontCanvas.height=i;var o=e._fontCanvas.getContext("2d");o.clearRect(0,0,r,i);o.fillStyle="#FFFFFF";var l=e._italic?"italic":"";var u=e._bold?"bold":"";var f=l+" "+u+" "+e._fontSize+"px "+e._fontFamily;o.font=f;var h=e._lineHeight*e._fontSize*-.15;var c=h;var p=e._text.split("\n");var d=d_.getContext("2d");d.font=f;var m=[];if(e._wrap){for(var _=0;_<p.length;++_){var v=v_(e,p[_],r);if(v.length===0){c+=e._lineHeight*e._fontSize;m.push({text:"",start:0,end:0,y:c})}else{for(var g=0;g<v.length;++g){c+=e._lineHeight*e._fontSize;m.push({text:p[_],start:v[g].start,end:v[g].end,y:c})}}}}else{for(var y=0;y<p.length;++y){c+=e._lineHeight*e._fontSize;m.push({text:p[y],start:0,end:p[y].length,y:c})}}var b=m[m.length-1].y-h;for(var x=0;x<m.length;++x){m[x].y+=(i-b)*e._alignV;a(m[x])}e._fontTexture.setImages([e._fontCanvas]);e._fontTexture.commit()}function y_(e,t,n,r,i){var a=0;var s=e._text.split("\n");var o=e._font;var l=e._fontSize/o._size;var u=e._cachedVertexData;var f=0;var h=0;function c(t,n,i){var s=0;for(var c=0;c<i-n;++c){var p=t.charCodeAt(c+n);var d=o._glyphs[p]||o._defaultGlyph;var m=s+d.xoffset*l;var _=s+(d.width+d.xoffset)*l;var v=a-(d.height+d.yoffset)*l;var g=a-d.yoffset*l;var y=h+c;Ut.set(u.lposList[4*y+0],m,v,0);Ut.set(u.lposList[4*y+1],_,v,0);Ut.set(u.lposList[4*y+2],m,g,0);Ut.set(u.lposList[4*y+3],_,g,0);Rt.copy(u.uvs[4*y+0],d.uvs[0]);Rt.copy(u.uvs[4*y+1],d.uvs[1]);Rt.copy(u.uvs[4*y+2],d.uvs[2]);Rt.copy(u.uvs[4*y+3],d.uvs[3]);s+=d.xadvance*l}if(s<r){for(var b=0;b<i-n;++b){var x=(r-s)*e._alignH;var T=h+b;u.lposList[4*T+0].x+=x;u.lposList[4*T+1].x+=x;u.lposList[4*T+2].x+=x;u.lposList[4*T+3].x+=x}}h+=i-n;++f;a-=e._lineHeight*o._lineHeight*l}if(e._wrap){for(var p=0;p<s.length;++p){var d=v_(e,s[p],r);if(d.length===0&&e._text.length!==0){c(" ",0,1)}else{for(var m=0;m<d.length;++m){c(s[p],d[m].start,d[m].end)}}}}else{for(var _=0;_<s.length;++_){c(s[_],0,s[_].length)}}var v=f*e._lineHeight*o._lineHeight*l;var g=v<i?(i-v)*-e._alignV:0;var y=n+i+g;for(var b=0;b<h;++b){u.lposList[4*b+0].x+=t;u.lposList[4*b+1].x+=t;u.lposList[4*b+2].x+=t;u.lposList[4*b+3].x+=t;u.lposList[4*b+0].y+=y;u.lposList[4*b+1].y+=y;u.lposList[4*b+2].y+=y;u.lposList[4*b+3].y+=y}return h}var b_=function(e){function t(){e.apply(this,arguments)}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.onInit=function e(){this._alignH=0;this._alignV=0;this._regWordSep=new RegExp(this._wordSep);this._fontCanvas=document.createElement("canvas");if(this._material===null){this._material=this._app.assets.get("builtin-material-font")}if(this._font===null&&this._fontTexture===null){this._fontTexture=new ja(this._app.device);this._fontTexture.mipmap=false;this._fontTexture.wrapS="clamp";this._fontTexture.wrapT="clamp";this._fontTexture.premultiplyAlpha=true}this._updateFont();this._updateAlignHV()};t.prototype._onRectChanged=function e(){this._vertexDataDirty=true};t.prototype._updateFont=function e(){if(this._font===null){this._cachedVertexData=m_(1);this._vertexDataDirty=true;return}if(this._font.type==="opentype"){this._font.addText(this._text)}else if(this._font.type==="bitmap"){this._material=this._app.assets.get("builtin-material-sprite")}this._cachedVertexData=m_(this._text.length);this._vertexDataDirty=true};t.prototype._updateAlignHV=function e(){if(this._align==="top-left"){this._alignH=0;this._alignV=0}else if(this._align==="top-center"){this._alignH=.5;this._alignV=0}else if(this._align==="top-right"){this._alignH=1;this._alignV=0}else if(this._align==="middle-left"){this._alignH=0;this._alignV=.5}else if(this._align==="middle-center"){this._alignH=.5;this._alignV=.5}else if(this._align==="middle-right"){this._alignH=1;this._alignV=.5}else if(this._align==="bottom-left"){this._alignH=0;this._alignV=1}else if(this._align==="bottom-center"){this._alignH=.5;this._alignV=1}else if(this._align==="bottom-right"){this._alignH=1;this._alignV=1}};t.prototype.calcVertexData=function e(t,n,r,i){var a=this;if(this._vertexDataDirty){this._vertexDataDirty=false;Ft.copy(this._cachedVertexData.color,this._color);if(this._font===null){g_(this,t,n,r,i)}else{y_(this,t,n,r,i)}}this._entity.getWorldMatrix(p_);for(var s=0;s<this._cachedVertexData.lposList.length;++s){var o=a._cachedVertexData.lposList[s];var l=a._cachedVertexData.wposList[s];Ut.transformMat4(l,o,p_)}return this._cachedVertexData};return t}(Ym);b_.schema={material:{type:"asset",default:null,set:function e(t){if(t===this._material){return}this._material=t}},font:{type:"asset",default:null,set:function e(t){if(t===this._font){return}this._font=t;this._updateFont()}},text:{type:"string",default:"",set:function e(t){if(this._text===t){return}this._text=t;this._updateFont()}},align:{type:"enums",default:"top-left",options:["top-left","top-center","top-right","middle-left","middle-center","middle-right","bottom-left","bottom-center","bottom-right"],set:function e(t){if(this._align===t){return}this._align=t;this._vertexDataDirty=true;this._updateAlignHV()}},wrap:{type:"boolean",default:true,set:function e(t){if(this._wrap===t){return}this._wrap=t;this._vertexDataDirty=true}},fontSize:{type:"int",default:32,set:function e(t){if(this._fontSize===t){return}this._fontSize=t;this._vertexDataDirty=true}},lineHeight:{type:"number",default:1,set:function e(t){if(this._lineHeight===t){return}this._lineHeight=t;this._vertexDataDirty=true}},color:{type:"color4",default:[1,1,1,1],set:function e(t){if(Ft.equals(this._color,t)){return}this._color=t;this._vertexDataDirty=true}},wordSep:{type:"string",default:/([a-zA-Z0-9ÄÖÜäöüßéèçàùêâîôûа-яА-ЯЁё]+|\S)/,set:function e(t){if(this._wordSep===t){return}this._wordSep=t;this._regWordSep=new RegExp(t)}},fontFamily:{type:"string",default:"Arial",set:function e(t){if(this._fontFamily===t){return}this._fontFamily=t;this._vertexDataDirty=true}},italic:{type:"boolean",default:false,set:function e(t){if(this._italic===t){return}this._italic=t;this._vertexDataDirty=true}},bold:{type:"boolean",default:false,set:function e(t){if(this._bold===t){return}this._bold=t;this._vertexDataDirty=true}},fontTexture:{type:"asset",default:null}};var x_=Pt.create();function T_(){var e=4;var t=[0,1,2,3,2,1];var n=new Array(e);var r=new Array(e);var i=new Array(e);var a=Ft.new(1,1,1,1);i[0]=Rt.new(0,0);i[1]=Rt.new(1,0);i[2]=Rt.new(0,1);i[3]=Rt.new(1,1);for(var s=0;s<e;++s){r[s]=Ut.zero();n[s]=Ut.zero()}return{wposList:r,lposList:n,uvs:i,color:a,indices:t}}var S_=function(e){function t(){e.apply(this,arguments)}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.onInit=function e(){this._cachedVertexData=T_();this._vertexDataDirty=true;if(this._material===null){this._material=this._app.assets.get("builtin-material-sprite")}};t.prototype._onRectChanged=function e(){this._vertexDataDirty=true};t.prototype.calcVertexData=function e(t,n,r,i){var a=this;if(this._vertexDataDirty){this._vertexDataDirty=false;Ut.set(this._cachedVertexData.lposList[0],t,n,0);Ut.set(this._cachedVertexData.lposList[1],t+r,n,0);Ut.set(this._cachedVertexData.lposList[2],t,n+i,0);Ut.set(this._cachedVertexData.lposList[3],t+r,n+i,0)}this._entity.getWorldMatrix(x_);for(var s=0;s<this._cachedVertexData.lposList.length;++s){var o=a._cachedVertexData.lposList[s];var l=a._cachedVertexData.wposList[s];Ut.transformMat4(l,o,x_)}return this._cachedVertexData};return t}(Ym);S_.schema={material:{type:"asset",default:null,set:function e(t){if(t===this._material){return}this._material=t}},sprite:{type:"asset",default:null,set:function e(t){if(t!==this._sprite){return}this._sprite=t}}};var E_=function(e){function t(){e.call(this);this._uiElements=new or(200)}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.add=function e(t){this._uiElements.push(t)};t.prototype.remove=function e(t){var n=this;for(var r=0;r<this._uiElements.length;++r){var i=n._uiElements.data[r];if(i===t){n._uiElements.fastRemove(r);break}}};t.prototype.tick=function e(){var t=this;for(var n=0;n<this._uiElements.length;++n){var r=t._uiElements.data[n];if(r&&r.tick){r.tick()}}};t.prototype.postTick=function e(){var t=this;for(var n=0;n<this._uiElements.length;++n){var r=t._uiElements.data[n];if(r&&r.postTick){r.postTick()}}};return t}(ua);var w_=function(e){function t(){e.call(this);this._highlighting=false;this._pressing=false;this._widget=null;this._bgImage=null;this._state="none";this._fingerId=-1}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.onInit=function e(){this._widget=this._entity.getComp("Widget");this._widget.focusable=true;this._bgImage=this._background&&this._background.getComp("Image");if(!this._bgImage){this._bgImage=this._entity.getComp("Image")}};t.prototype.onDestroy=function e(){this._widget.focusable=false};t.prototype._updateState=function e(){var t="normal";if(this._pressing){t="pressed"}else if(this._highlighting){t="highlight"}if(this._state===t){return}var n=this._state;this._state=t;this.dispatch("transition",{detail:{oldState:n,newState:this._state}});if(this._bgImage===null){return}if(this._transition==="none"){return}if(this._transition==="color"){this._bgImage.color=this._transitionColors[t]}else if(this._transition==="sprite"){this._bgImage.sprite=this._transitionSprites[t]}else{console.warn("Button transition animation is not implemented")}};t.prototype._onMouseEnter=function e(t){if(this.enabled===false){return}var n=this._widget.system;this._highlighting=true;if(n.focusedEntity===this._entity&&t.buttons&1!==0){this._pressing=true}this._updateState()};t.prototype._onMouseLeave=function e(){if(this.enabled===false){return}var t=this._widget.system;this._pressing=false;if(t.focusedEntity&&t.focusedEntity===this._entity){this._highlighting=true}else{this._highlighting=false}this._updateState()};t.prototype._onMouseDown=function e(t){if(this.enabled===false){return}var n=this._widget.system;if(t.button==="left"){t.stop();if(n.focusedEntity!==this._entity){return}this._pressing=true;this._updateState()}};t.prototype._onMouseUp=function e(t){if(this.enabled===false){return}if(t.button==="left"){t.stop();this._pressing=false;this._updateState();this.dispatch("clicked")}};t.prototype._onFocus=function e(){if(this.enabled===false){return}this._highlighting=true;this._updateState()};t.prototype._onBlur=function e(){if(this.enabled===false){return}this._fingerId=-1;this._highlighting=false;this._updateState()};t.prototype._onTouchEnter=function e(t){if(this.enabled===false){return}if(this._fingerId===t.id){t.stop();this._pressing=true;this._updateState()}};t.prototype._onTouchLeave=function e(t){if(this.enabled===false){return}t.stop();this._pressing=false;this._updateState()};t.prototype._onTouchStart=function e(t){if(this.enabled===false){return}t.stop();this._fingerId=t.id;this._pressing=true;this._updateState()};t.prototype._onTouchEnd=function e(t){if(this.enabled===false){return}t.stop();this._fingerId=-1;this._pressing=false;this._updateState();this.dispatch("clicked")};return t}(Zm);w_.events={mouseenter:"_onMouseEnter",mouseleave:"_onMouseLeave",mousedown:"_onMouseDown",mouseup:"_onMouseUp",focus:"_onFocus",blur:"_onBlur",touchenter:"_onTouchEnter",touchleave:"_onTouchLeave",touchstart:"_onTouchStart",touchend:"_onTouchEnd"};w_.schema={transitionColors:{type:"object",default:{normal:Ft.create(),highlight:Ft.create(),pressed:Ft.create(),disabled:Ft.create()}},transitionSprites:{type:"object",parse:function e(t,n,r,i){if(n){var a={normal:null,highlight:null,pressed:null,disabled:null};if(n.normal&&typeof n.normal==="string"){a.normal=t.assets.get(n.normal)}if(n.highlight&&typeof n.highlight==="string"){a.highlight=t.assets.get(n.highlight)}if(n.pressed&&typeof n.pressed==="string"){a.pressed=t.assets.get(n.pressed)}if(n.disabled&&typeof n.disabled==="string"){a.disabled=t.assets.get(n.disabled)}return a}},default:{normal:null,highlight:null,pressed:null,disabled:null}},background:{type:"entity",default:null,set:function e(t){if(!(t instanceof sa)){return}this._background=t;if(this._background){this._bgImage=this._background.getComp("Image")}}},transition:{type:"enums",default:"none",options:["none","color","sprite"]}};var M_=function(e){function t(){e.call(this);this._state="none";this._highlighting=false;this._pressing=false;this._widget=null;this._bgImage=null;this._toggleGroupComp=null;this._checkerImage=null;this._fingerId=-1}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.onInit=function e(){this._widget=this._entity.getComp("Widget");this._widget.focusable=true;this._bgImage=this._background&&this._background.getComp("Image");if(!this._bgImage){this._bgImage=this._entity.getComp("Image")}this._toggleGroupComp=this._toggleGroup&&this._toggleGroup.getComp("ToggleGroup");if(this._toggleGroupComp){this._toggleGroupComp._addItem(this)}this._checkerImage=this._checker&&this._checker.getComp("Image");if(this._checkerImage){this._checkerImage.enabled=this._checked}};t.prototype.onDestroy=function e(){this._widget.focusable=false};t.prototype._updateState=function e(){var t="normal";if(this._pressing){t="pressed"}else if(this._highlighting){t="highlight"}if(this._state===t){return}var n=this._state;this._state=t;this.dispatch("transition",{detail:{oldState:n,newState:this._state}});if(this._bgImage===null){return}if(this._transition==="none"){return}if(this._transition==="color"){this._bgImage.color=this._transitionColors[t]}else if(this._transition==="sprite"){this._bgImage.sprite=this._transitionSprites[t]}else{console.warn("Button transition animation is not implemented")}};t.prototype._onMouseEnter=function e(t){if(this.enabled===false){return}var n=this._widget.system;this._highlighting=true;if(n.focusedEntity===this._entity&&t.buttons&1!==0){this._pressing=true}this._updateState()};t.prototype._onMouseLeave=function e(){if(this.enabled===false){return}var t=this._widget.system;this._pressing=false;if(t.focusedEntity&&t.focusedEntity===this._entity){this._highlighting=true}else{this._highlighting=false}this._updateState()};t.prototype._onMouseDown=function e(t){if(this.enabled===false){return}var n=this._widget.system;if(t.button==="left"){t.stop();if(n.focusedEntity!==this._entity){return}this._pressing=true;this._updateState()}};t.prototype._onMouseUp=function e(t){if(this.enabled===false){return}var n=this._widget.system;if(t.button==="left"){t.stop();if(n.focusedEntity!==this._entity){return}this.checked=!this.checked;this.dispatch("change");if(this._toggleGroupComp){this._toggleGroupComp._updateCheck(this)}this._pressing=false;this._updateState()}};t.prototype._onFocus=function e(){if(this.enabled===false){return}this._highlighting=true;this._updateState()};t.prototype._onBlur=function e(){if(this.enabled===false){return}this._fingerId=-1;this._highlighting=false;this._updateState()};t.prototype._onTouchEnter=function e(t){if(this.enabled===false){return}if(this._fingerId===t.id){t.stop();this._pressing=true;this._updateState()}};t.prototype._onTouchLeave=function e(t){if(this.enabled===false){return}t.stop();this._pressing=false;this._updateState()};t.prototype._onTouchStart=function e(t){if(this.enabled===false){return}t.stop();this._fingerId=t.id;this._pressing=true;this._updateState()};t.prototype._onTouchEnd=function e(t){if(this.enabled===false){return}t.stop();this._fingerId=-1;this._pressing=false;this._updateState();this.checked=!this.checked;this.dispatch("change");if(this._toggleGroupComp){this._toggleGroupComp._updateCheck(this)}};return t}(Zm);M_.events={mouseenter:"_onMouseEnter",mouseleave:"_onMouseLeave",mousedown:"_onMouseDown",mouseup:"_onMouseUp",focus:"_onFocus",blur:"_onBlur",touchenter:"_onTouchEnter",touchleave:"_onTouchLeave",touchstart:"_onTouchStart",touchend:"_onTouchEnd"};M_.schema={checker:{type:"entity",default:null,set:function e(t){if(!(t instanceof sa)){return}if(this._checker===t){return}this._checker=t;if(this._checker){this._checkerImage=this._checker.getComp("Image");this._checkerImage.enabled=this._checked}}},checked:{type:"boolean",default:true,set:function e(t){if(this._checked===t){return}this._checked=t;if(this._checkerImage){this._checkerImage.enabled=this._checked}}},toggleGroup:{type:"entity",default:null,set:function e(t){if(!(t instanceof sa)){return}if(this._toggleGroup===t){return}this._toggleGroup=t;if(this._toggleGroupComp){this._toggleGroupComp._removeItem(this);this._toggleGroupComp=null}if(this._toggleGroup){this._toggleGroupComp=this._toggleGroup.getComp("ToggleGroup");if(this._toggleGroupComp){this._toggleGroupComp._addItem(this)}}}},transitionColors:{type:"object",default:{normal:Ft.create(),highlight:Ft.create(),pressed:Ft.create(),disabled:Ft.create()}},transitionSprites:{type:"object",parse:function e(t,n,r,i){if(n){var a={normal:null,highlight:null,pressed:null,disabled:null};if(n.normal&&typeof n.normal==="string"){a.normal=t.assets.get(n.normal)}if(n.highlight&&typeof n.highlight==="string"){a.highlight=t.assets.get(n.highlight)}if(n.pressed&&typeof n.pressed==="string"){a.pressed=t.assets.get(n.pressed)}if(n.disabled&&typeof n.disabled==="string"){a.disabled=t.assets.get(n.disabled)}return a}},default:{normal:null,highlight:null,pressed:null,disabled:null}},background:{type:"entity",default:null,set:function e(t){if(!(t instanceof sa)){return}if(this._background===t){return}this._background=t;if(this._background){this._bgImage=this._background.getComp("Image")}}},transition:{type:"enums",default:"none",options:["none","color","sprite"]}};var A_=function(e){function t(){e.call(this);this._toggleItems=[];this._activeItem=null}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype._addItem=function e(t){if(this._toggleItems.indexOf(t)===-1){this._toggleItems.push(t);if(this._activeItem===null){if(t.checked){this._activeItem=t}}else{t.checked=false}}else{console.warn("toggle item already added into toggle groups")}};t.prototype._removeItem=function e(t){var n=this._toggleItems.indexOf(t);if(n===-1){console.warn("toggle item not exists in toggle groups")}else{if(this._activeItem===t){this._activeItem=null}this._toggleItems.splice(n,1)}};t.prototype._updateCheck=function e(t){var n=this._toggleItems.indexOf(t);if(n===-1){console.warn("toggle item not exists in toggle groups");return true}else{if(this._activeItem!==t){if(this._activeItem){this._activeItem.checked=false}this._activeItem=t}else{if(!this._allowSwitchOff){if(this._activeItem&&!this._activeItem.checked){this._activeItem.checked=true}}}}};return t}(Zm);A_.schema={allowSwitchOff:{type:"boolean",default:false}};var R_=function(e){function t(){var t=this;e.call(this);this._state="none";this._calMinValue=0;this._calMaxValue=1;this._highlighting=false;this._pressing=false;this._widget=null;this._dragging=false;this._bgImage=null;this._handleWidget=null;this._fillWidget=null;this._lastAxis="horizontal";this._normalizedValue=0;this._reverse=false;this._fingerId=-1;this._onMouseEnter=function(e){if(t.enabled===false){return}var n=t._widget.system;t._highlighting=true;if(n.focusedEntity===t._entity&&e.buttons&1!==0){t._pressing=true}t._updateState()};this._onMouseLeave=function(){if(t.enabled===false){return}var e=t._widget.system;t._pressing=false;if(e.focusedEntity&&e.focusedEntity===t._entity){t._highlighting=true}else{t._highlighting=false}t._updateState()};this._onMouseDown=function(e){if(t.enabled===false){return}var n=t._widget.system;if(e.button==="left"){e.stop();if(n.focusedEntity!==t._entity){return}t._pressing=true;t._updateState();if(!t._handle||e.target!==t._handle){t._updateDrag(Ut.new(e.mouseX,e.mouseY,0))}t._dragging=true}};this._onMouseMove=function(e){if(t.enabled===false){return}if(e.button===0){e.stop();if(t._dragging){t._updateDrag(Ut.new(e.mouseX,e.mouseY,0))}}};this._onMouseUp=function(e){if(t.enabled===false){return}if(e.button==="left"){e.stop();t._dragging=false;t._pressing=false;t._updateState()}};this._onTouchMove=function(e){if(t.enabled===false){return}e.stop();if(e.id===t._fingerId){if(t._dragging){t._updateDrag(Ut.new(e.x,e.y,0))}}};this._onTouchStart=function(e){if(t.enabled===false){return}e.stop();if(t._fingerId!==-1){return}t._fingerId=e.id;t._pressing=true;t._updateState();if(!t._handle||e.target!==t._handle){t._updateDrag(Ut.new(e.x,e.y,0))}t._dragging=true};this._onTouchEnd=function(e){if(t.enabled===false){return}e.stop();if(e.id!==t._fingerId){return}t._dragging=false;t._fingerId=-1;t._pressing=false;t._updateState()}}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.onInit=function t(){e.prototype.onInit.call(this);this._widget=this._entity.getComp("Widget");this._widget.focusable=true;this._bgImage=this._background&&this._background.getComp("Image");if(!this._bgImage){this._bgImage=this._entity.getComp("Image")}this._fillWidget=this._fill&&this._fill.getComp("Widget");this._handleWidget=this._handle&&this._handle.getComp("Widget");var n=0;if(this._value>0){n=(this._value-this._calMinValue)/(this._calMaxValue-this._calMinValue);n=Math.round(n*100)/100}this._normalizedValue=this._reverse?1-n:n;this._updateVisuals()};t.prototype.onDestroy=function t(){this._widget.focusable=false;e.prototype.onDestroy.call(this)};t.prototype._updateState=function e(){var t="normal";if(this._pressing){t="pressed"}else if(this._highlighting){t="highlight"}if(this._state===t){return}var n=this._state;this._state=t;this.dispatch("transition",{detail:{oldState:n,newState:this._state}});if(this._bgImage===null){return}if(this._transition==="none"){return}if(this._transition==="color"){this._bgImage.color=this._transitionColors[t]}else if(this._transition==="sprite"){this._bgImage.sprite=this._transitionSprites[t]}else{console.warn("Button transition animation is not implemented")}};t.prototype._set=function e(t){var n=We(t,this._calMinValue,this._calMaxValue);if(this._value!=n){this._value=n;this._updateVisuals();this._emitValueChangedEvents()}};t.prototype._getReverseValue=function e(){return this._maxValue<this._minValue};t.prototype._updateDrag=function e(t){var n=this._handle?this._handleWidget:this._fillWidget;var r=n._entity.parent.getComp("Widget");if(r){var i=[Ut.zero(),Ut.zero(),Ut.zero(),Ut.zero()];r.getWorldCorners(i[0],i[1],i[2],i[3]);var a=i[1];var s=Ut.zero(),o=Ut.zero();var l=0,u=0;if(this._direction==="horizontal"){Ut.subtract(s,i[2],a);Ut.subtract(o,t,a);l=Ut.distance(i[2],a);this._normalizedValue=Xe(u/l)}else{Ut.subtract(s,i[0],a);Ut.subtract(o,t,a);l=Ut.distance(i[0],a)}u=Ut.dot(s,o)/l;this._normalizedValue=Xe(u/l);this._clampValue()}};t.prototype._updateVisuals=function e(){var t=[0,0];var n=[1,1];var r=this._direction==="horizontal"?0:1;if(this._fillWidget){var i=this._fill.getComp("Image");if(i){if(i.type==="filled"){i.filledStart=this._normalizedValue}else if(this._reverse){t[r]=this._normalizedValue}else{n[r]=this._normalizedValue}}this._fillWidget.setAnchors(t[0],t[1],n[0],n[1])}if(this._handleWidget){t=[0,0];n=[1,1];t[r]=this._normalizedValue;n[r]=this._normalizedValue;this._handleWidget.setAnchors(t[0],t[1],n[0],n[1])}};t.prototype._clampValue=function e(){this.value=(this._reverse?1-this._normalizedValue:this._normalizedValue)*(this._calMaxValue-this._calMinValue)};t.prototype._getCalculateWidget=function e(){return this._handle.parent.getComp("Widget")};t.prototype._onFocus=function e(){if(this.enabled===false){return}this._highlighting=true;this._updateState()};t.prototype._onBlur=function e(){if(this.enabled===false){return}this._fingerId=-1;this._highlighting=false;this._updateState()};t.prototype._onTouchEnter=function e(t){if(this.enabled===false){return}if(this._fingerId!==-1&&this._fingerId===t.id){t.stop();this._pressing=true;this._updateState()}};t.prototype._onTouchLeave=function e(t){if(this.enabled===false){return}if(this._fingerId!==-1&&this._fingerId===t.id){t.stop();this._pressing=false;this._updateState()}};t.prototype._emitValueChangedEvents=function e(){this.dispatch("Slider.onValueChanged")};return t}(Zm);R_.events={mouseenter:"_onMouseEnter",mouseleave:"_onMouseLeave",mousemove:"_onMouseMove",mousedown:"_onMouseDown",mouseup:"_onMouseUp",focus:"_onFocus",blur:"_onBlur",touchenter:"_onTouchEnter",touchleave:"_onTouchLeave",touchstart:"_onTouchStart",touchmove:"_onTouchMove",touchend:"_onTouchEnd"};R_.schema={handle:{type:"entity",default:null,set:function e(t){if(!(t instanceof sa)){return}if(this._handle===t){return}this._handle=t;if(this._handle){this._handleWidget=this._handle.getComp("Widget")}this._updateVisuals()}},fill:{type:"entity",default:null,set:function e(t){if(!(t instanceof sa)){return}if(this._fill===t){return}this._fill=t;if(this._fill){this._fillWidget=this._fill.getComp("Widget")}this._updateVisuals()}},direction:{type:"enums",default:"horizontal",options:["horizontal","vertical"],set:function e(t){if(this._direction===t){return}this._direction=t;this._lastAxis=this._direction}},minValue:{type:"number",default:0,set:function e(t){if(this._minValue===t){return}this._minValue=t;this._calMinValue=t;if(this._minValue>this._maxValue){this._calMinValue=this._maxValue;this._calMaxValue=this._minValue}}},maxValue:{type:"number",default:1,set:function e(t){if(this._maxValue===t){return}this._maxValue=t;this._calMaxValue=t;if(this._minValue>this._maxValue){this._calMinValue=this._maxValue;this._calMaxValue=this._minValue}}},value:{type:"number",default:0,set:function e(t){if(this._value===t){return}this._set(t,false)}},transitionColors:{type:"object",default:{normal:Ft.create(),highlight:Ft.create(),pressed:Ft.create(),disabled:Ft.create()}},transitionSprites:{type:"object",parse:function e(t,n,r,i){if(n){var a={normal:null,highlight:null,pressed:null,disabled:null};if(n.normal&&typeof n.normal==="string"){a.normal=t.assets.get(n.normal)}if(n.highlight&&typeof n.highlight==="string"){a.highlight=t.assets.get(n.highlight)}if(n.pressed&&typeof n.pressed==="string"){a.pressed=t.assets.get(n.pressed)}if(n.disabled&&typeof n.disabled==="string"){a.disabled=t.assets.get(n.disabled)}return a}},default:{normal:null,highlight:null,pressed:null,disabled:null}},background:{type:"entity",default:null,set:function e(t){if(!(t instanceof sa)){return}if(this._background===t){return}this._background=t;if(this._background){this._bgImage=this._background.getComp("Image")}}},transition:{type:"enums",default:"none",options:["none","color","sprite"]}};var U_=function(e){function t(){var t=this;e.call(this);this._state="none";this._highlighting=false;this._pressing=false;this._widget=null;this._bgImage=null;this._textComp=null;this._activeDom=null;this._inputText="";this._editMode=false;this._onMouseMove=function(){if(t._pressing){t._flushDom()}};this._onMouseEnter=function(e){if(t.enabled===false){return}var n=t._widget.system;t._highlighting=true;if(n.focusedEntity===t._entity&&e.buttons&1!==0){t._pressing=true}t._updateState()};this._onMouseLeave=function(){if(t.enabled===false){return}var e=t._widget.system;t._pressing=false;if(e.focusedEntity&&e.focusedEntity===t._entity){t._highlighting=true}else{t._highlighting=false}t._updateState()};this._onMouseDown=function(e){if(t.enabled===false){return}var n=t._widget.system;if(e.button==="left"){e.stop();if(n.focusedEntity!==t._entity){return}t._pressing=true;t._updateState()}};this._onMouseUp=function(e){if(t.enabled===false){return}if(e.button==="left"){e.stop();t._pressing=false;t._updateState();t._onClk()}};this._onInput=function(){t._text=t._activeDom.value;t._emitValueChangedEvents()};this._onReturnKey=function(e){if(t._textComp===null){return}if(e.keyCode===13){if(t._returnKeyType==="new-line"){if(t._lineType==="multi-line"){t._text+="\n"}}else{t._endInput();if(t._returnKeyType==="submit"){t._emitSubmitEvents()}}}};this._onTouchEnd=function(e){if(t.enabled===false){return}e.stop();t._pressing=false;t._updateState();t._onClk()}}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.onInit=function t(){e.prototype.onInit.call(this);this._widget=this._entity.getComp("Widget");this._widget.focusable=true;this._bgImage=this._background&&this._background.getComp("Image");if(!this._bgImage){this._bgImage=this._entity.getComp("Image")}this._textComp=this._textEnt&&this._textEnt.getComp("Text");if(this._textComp){var n=this._textComp.align;var r=n.split("-");if(r.indexOf("middle")===-1){this._textComp.align="middle-"+r[1]}}this._dealText(this._text);if(this._lineType==="multi-line"){this._createDom("textarea")}else{this._createDom("input")}};t.prototype.onDisable=function e(){this._endInput()};t.prototype.onDestroy=function t(){this._widget.focusable=false;this._endInput();e.prototype.onDestroy.call(this)};t.prototype._updateState=function e(){var t="normal";if(this._pressing){t="pressed"}else if(this._highlighting){t="highlight"}if(this._state===t){return}var n=this._state;this._state=t;this.dispatch("transition",{detail:{oldState:n,newState:this._state}});if(this._bgImage===null){return}if(this._transition==="none"){return}if(this._transition==="color"){this._bgImage.color=this._transitionColors[t]}else if(this._transition==="sprite"){this._bgImage.sprite=this._transitionSprites[t]}else{console.warn("Button transition animation is not implemented")}};t.prototype._registerEvent=function e(){this._activeDom.addEventListener("input",this._onInput);this._activeDom.addEventListener("keypress",this._onReturnKey)};t.prototype._unregisterEvent=function e(){this._activeDom.removeEventListener("input",this._onInput);this._activeDom.removeEventListener("keypress",this._onReturnKey)};t.prototype._onClk=function e(){if(this._textComp===null){return}if(!this._editMode){this._editMode=true;this._activeDom.style.display="block";this._activeDom.value=this._text;this._textComp.enabled=false;this._startFocus()}};t.prototype._startFocus=function e(){this._activeDom.focus();this._flushDom()};t.prototype._dealText=function e(t){var n=this;if(this._textComp===null){return}this._text="";if(this._lineType==="single-line"){t=t.replace("\n","")}var r=Math.min(t.length,this._maxLength);for(var i=0;i<r;++i){var a=n._checkChar(t[i],n._text.length,n._text);if(a.length>0){n._text+=a}}this._switchTextState();var s=this._text;if(this._contentType==="password"){s=this._text.replace(new RegExp(".+?","g"),"V")}this._textComp.text=s.length>0?s:this.defaultText};t.prototype._switchTextState=function e(){var t=this._textComp.color;if(this._text.length<=0){this._textComp.color=Ft.new(t.r,t.g,t.b,.5)}else{this._textComp.color=Ft.new(t.r,t.g,t.b,1)}};t.prototype._checkChar=function e(t,n,r){var i=false;if(this._contentType==="standard"){return t}if(this._contentType==="int-number"||this._contentType==="decimal-number"){i=new RegExp("[0-9]").test(t);if(i){return t}if(t==="-"){if(n===0){return t}}if(t==="."&&this._contentType==="decimal-number"&&this._text.indexOf(".")<0){return t}}else if(this._contentType==="alpha-number"){i=new RegExp("[0-9a-zA-Z]").test(t);if(i){return t}}else if(this._contentType==="caps-all"){return t.toUpperCase()}else if(this._contentType==="name"){i=new RegExp("[a-zA-Z]").test(t);if(i){i=new RegExp("[a-z]").test(t);if(i){if(n===0||r[n-1]===" "){return t.toUpperCase()}}else{if(n>0&&r[n-1]!==" "){return t.toLowerCase()}}return t}else{if(t===" "&&n>0){if(r[n-1]!==" "){return t}}}}else if(this._contentType==="email"){i=new RegExp("[0-9a-zA-Z]").test(t);if(i){return t}if(t==="@"&&this._text.indexOf("@")===-1){return t}var a="!#$%&'*+-/=?^_`{}|~";if(a.indexOf(t)!==-1){return t}if(t==="."){if(n>0&&r[n-1]!=="."){return t}}}else{return t}return""};t.prototype._endInput=function e(){if(this._textComp===null){return}if(this._editMode){this._editMode=false;this._activeDom.style.display="none";this._dealText(this._text);this._textComp.enabled=true;if(this._text.length<=0){this._textComp.text=this.defaultText}this._switchTextState();this._activeDom.blur()}};t.prototype._createDom=function e(t){if(this._activeDom){this._unregisterEvent();document.body.removeChild(this._activeDom)}this._activeDom=document.createElement(t);document.body.appendChild(this._activeDom);if(this._activeDom.type!=="textarea"){this._activeDom.type=this._contentType==="password"?"password":"text"}this._activeDom.style.background="transparent";this._activeDom.style.position="absolute";this._activeDom.style.padding="2px";this._activeDom.style.fontSize=this._textComp!==null?this._textComp.fontSize+"px":"10px";this._activeDom.style.display="none";if(this._activeDom.type==="textarea"){this._activeDom.style.active=0;this._activeDom.style.overflowY="scroll";this._activeDom.style.resize="none"}this._activeDom.maxLength=this._maxLength;this._registerEvent()};t.prototype._flushDom=function e(){if(this._textComp===null||this._activeDom.style.display==="none"){return}var t=this._app._canvas;var n=this._textComp.entity.getComp("Widget");var r=[Ut.zero(),Ut.zero(),Ut.zero(),Ut.zero()];n.getWorldCorners(r[0],r[1],r[2],r[3]);var i=4;var a=r[0].x+i;var s=t.height-r[0].y+i;var o=this._textComp.align;this._activeDom.type==="textarea"?"textarea":"input";o=o.indexOf("left")!==-1?"left":o.indexOf("center")!==-1?"center":"right";this._activeDom.style.textAlign=o;this._activeDom.maxLength=this._maxLength;this._activeDom.style.width=n._rect.w-i-2+"px";this._activeDom.style.height=n._rect.h-i-2+"px";this._activeDom.style.top=s+"px";this._activeDom.style.left=a+"px"};t.prototype._onFocus=function e(){if(this.enabled===false){return}this._highlighting=true;this._updateState()};t.prototype._onBlur=function e(){if(this._entity.enabledInHierarchy===false){return}this._fingerId=-1;this._highlighting=false;this._updateState();this._endInput()};t.prototype._onTouchEnter=function e(t){if(this.enabled===false){return}if(this._fingerId===t.id){t.stop();this._pressing=true;this._updateState()}};t.prototype._onTouchLeave=function e(t){if(this.enabled===false){return}t.stop();this._pressing=false;this._updateState()};t.prototype._onTouchStart=function e(t){if(this.enabled===false){return}t.stop();this._fingerId=t.id;this._pressing=true;this._updateState()};t.prototype._emitValueChangedEvents=function e(){this.dispatch("EditBox.onValueChanged")};t.prototype._emitSubmitEvents=function e(){this.dispatch("EditBox.onSubmit")};return t}(Zm);U_.events={mouseenter:"_onMouseEnter",mouseleave:"_onMouseLeave",mousedown:"_onMouseDown",mousemove:"_onMouseMove",mouseup:"_onMouseUp",focus:"_onFocus",blur:"_onBlur",touchenter:"_onTouchEnter",touchleave:"_onTouchLeave",touchstart:"_onTouchStart",touchend:"_onTouchEnd"};U_.schema={defaultText:{type:"string",default:""},textEnt:{type:"entity",default:null,set:function e(t){if(!(t instanceof sa)){return}if(this._textEnt===t){return}this._textEnt=t;if(!this._textEnt){console.warn("Text component cannot be null")}if(this._textEnt){this._textComp=this._textEnt.getComp("Text");if(this._textComp){this._activeDom.style.fontSize=this._textComp.fontSize+"px";this._textComp.text=this._defaultText;var n=this._textComp.align;var r=n.split("-");if(r.indexOf("middle")===-1){this._textComp.align="middle-"+r[1]}}this._switchTextState()}}},text:{type:"string",default:"",set:function e(t){t=!t?"":t;if(this._text===t){return}this._dealText(t)}},contentType:{type:"enums",default:"standard",options:["standard","int-number","decimal-number","alpha-number","caps-all","name","email","password"],set:function e(t){if(this._contentType===t){return}this._contentType=t;if(this._contentType==="password"){this._activeDom.type="password";this.lineType="single-line"}else if(this._contentType==="email"){this._activeDom.type="email";this.lineType="single-line"}else{this._activeDom.type="text";this.lineType=this._lineType}this._dealText(this._text)}},lineType:{type:"enums",default:"single-line",options:["single-line","multi-line"],set:function e(t){if(this._lineType===t){return}if(this._contentType==="standard"){this._lineType=t}else{this._lineType="single-line"}if(this._lineType==="multi-line"){this._createDom("textarea")}else{this._createDom("input")}}},returnKeyType:{type:"enums",default:"none",options:["none","submit","new-line"]},maxLength:{type:"int",default:2147483647,set:function e(t){if(this._maxLength===t){return}this._maxLength=t;if(this._maxLength<=0){this._maxLength=2147483647}this._activeDom.maxLength=this._maxLength;this._dealText(this._text)}},transitionColors:{type:"object",default:{normal:Ft.create(),highlight:Ft.create(),pressed:Ft.create(),disabled:Ft.create()}},transitionSprites:{type:"object",parse:function e(t,n,r,i){if(n){var a={normal:null,highlight:null,pressed:null,disabled:null};if(n.normal&&typeof n.normal==="string"){a.normal=t.assets.get(n.normal)}if(n.highlight&&typeof n.highlight==="string"){a.highlight=t.assets.get(n.highlight)}if(n.pressed&&typeof n.pressed==="string"){a.pressed=t.assets.get(n.pressed)}if(n.disabled&&typeof n.disabled==="string"){a.disabled=t.assets.get(n.disabled)}return a}},default:{normal:null,highlight:null,pressed:null,disabled:null}},background:{type:"entity",default:null,set:function e(t){if(!(t instanceof sa)){return}if(this._background===t){return}this._background=t;if(this._background){this._bgImage=this._background.getComp("Image")}}},transition:{type:"enums",default:"none",options:["none","color","sprite"],set:function e(t){if(this._transition!==t){this._transition=t}}}};var D_=function(e){function t(){var t=this;e.call(this);this._state="none";this._highlighting=false;this._pressing=false;this._widget=null;this._dragging=false;this._handleWidget=null;this._startDistance=0;this._fingerId=-1;this._onMouseEnter=function(e){if(t.enabled===false){return}var n=t._widget.system;t._highlighting=true;if(n.focusedEntity===t._entity&&e.buttons&1!==0){t._pressing=true}t._updateState()};this._onMouseLeave=function(){if(t.enabled===false){return}var e=t._widget.system;t._pressing=false;if(e.focusedEntity&&e.focusedEntity===t._entity){t._highlighting=true}else{t._highlighting=false}t._updateState()};this._onMouseDown=function(e){if(t.enabled===false){return}var n=t._widget.system;if(e.button==="left"){e.stop();if(n.focusedEntity!==t._entity){return}t._pressing=true;t._updateState();if(e.target!==t._handle){if(!t._dragging){t._dragging=true;t._updateValue(Rt.new(e.mouseX,e.mouseY),true)}}else{t._dragging=true;t._startOffset(Rt.new(e.mouseX,e.mouseY))}}};this._onMouseMove=function(e){if(t.enabled===false){return}if(e.button===0){e.stop();if(t._dragging){t._updateValue(Ut.new(e.mouseX,e.mouseY,0))}}};this._onMouseUp=function(e){if(t.enabled===false){return}if(e.button==="left"){e.stop();t._dragging=false;t._pressing=false;t._updateState()}};this._onTouchStart=function(e){if(t.enabled===false){return}e.stop();if(t._fingerId!==-1){return}t._fingerId=e.id;t._pressing=true;t._updateState();t._startPos=Ut.new(e.x,e.y,0);t._offsetValue=0;if(e.target!==t._handle){if(!t._dragging){t._dragging=true;t._clkBar(Ut.new(e.x,e.y,0),true)}}else{t._dragging=true;t._startOffset(Rt.new(e.x,e.y))}};this._onTouchMove=function(e){if(t.enabled===false){return}e.stop();if(e.id===t._fingerId){if(t._dragging){t._updateValue(Ut.new(e.x,e.y,0))}}};this._onTouchEnd=function(e){if(t.enabled===false){return}e.stop();if(e.id!==t._fingerId){return}t._dragging=false;t._fingerId=-1;t._pressing=false;t._updateState()}}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.onInit=function t(){this._widget=this._entity.getComp("Widget");this._widget.focusable=true;this._bgImage=this._background&&this._background.getComp("Image");if(!this._bgImage){this._bgImage=this._entity.getComp("Image")}this._handleWidget=this._handle&&this._handle.getComp("Widget");e.prototype.onInit.call(this)};t.prototype.onEnable=function e(){this._updateHandle()};t.prototype.onDestroy=function t(){this._widget.focusable=false;e.prototype.onDestroy.call(this)};t.prototype._updateState=function e(){var t="normal";if(this._pressing){t="pressed"}else if(this._highlighting){t="highlight"}if(this._state===t){return}var n=this._state;this._state=t;this.dispatch("transition",{detail:{oldState:n,newState:this._state}});if(this._background===null){return}if(this._transition==="none"){return}if(this._transition==="color"){this._background.color=this._transitionColors[t]}else if(this._transition==="sprite"){this._background.sprite=this._transitionSprites[t]}else{console.warn("Button transition animation is not implemented")}};t.prototype._set=function e(t){var n=this._value;if(t===n){return}this._value=Xe(t);this._emitValueChangedEvents()};t.prototype._updateValue=function e(t,n){if(n===void 0)n=false;if(!this._handle||!this._handle){return}var r=this._getCalculateWidget();var i=[Ut.zero(),Ut.zero(),Ut.zero(),Ut.zero()];r.getWorldCorners(i[0],i[1],i[2],i[3]);var a=Rt.new(i[1].x,i[1].y);var s=Rt.zero(),o=Rt.zero();var l=this._direction==="horizontal"?Rt.new(i[2].x,i[2].y):Rt.new(i[0].x,i[0].y);Rt.subtract(s,l,a);Rt.subtract(o,t,a);var u=[r._rect.w*this._size/2,r._rect.h*this._size/2];var f=Rt.dot(s,o)/(this._direction==="horizontal"?r._rect.w:r._rect.h);if(this._direction==="horizontal"){f-=u[0]+(n?0:this._startDistance);f=Xe(f/(r._rect.w*(1-this._size)))}else{f-=u[1]+(n?0:this._startDistance);f=Xe(f/(r._rect.h*(1-this._size)))}this.value=this._reverse?1-f:f};t.prototype._startOffset=function e(t){var n=[Ut.zero(),Ut.zero(),Ut.zero(),Ut.zero()];var r=this._getCalculateWidget();r.getWorldCorners(n[0],n[1],n[2],n[3]);var i=Ut.zero();if(this._direction==="horizontal"){Ut.subtract(i,n[2],n[1])}else{Ut.subtract(i,n[3],n[2])}var a=[Ut.zero(),Ut.zero(),Ut.zero(),Ut.zero()];this._handleWidget.getWorldCorners(a[0],a[1],a[2],a[3]);var s=Ut.zero(),o=Rt.zero();Ut.add(s,a[3],a[1]);Ut.divide(s,s,Ut.new(2,2,2));Rt.subtract(o,t,Rt.new(s.x,s.y));var l=Rt.dot(o,Rt.new(i.x,i.y))/(this._direction==="horizontal"?r._rect.w:r._rect.h);return l};t.prototype._updateHandle=function e(){if(!this._handle||!this._handle){return}var t={0:0,1:0};var n={0:1,1:1};var r=this._value*(1-this._size);r=Math.round(parseFloat(r)*100)/100;var i=this._direction==="horizontal"?0:1;if(this._reverse){t[i]=1-r-this._size;n[i]=1-r}else{t[i]=r;n[i]=r+this._size}this._handleWidget.setAnchors(t[0],t[1],n[0],n[1])};t.prototype._getCalculateWidget=function e(){if(!this._handle||!this._handle){return null}var t=this._handle.parent.getComp("Widget");return t};t.prototype._onFocus=function e(){if(this.enabled===false){return}this._highlighting=true;this._updateState()};t.prototype._onBlur=function e(){if(this.enabled===false){return}this._fingerId=-1;this._highlighting=false;this._updateState()};t.prototype._onTouchEnter=function e(t){if(this.enabled===false){return}if(this._fingerId!==-1&&this._fingerId===t.id){t.stop();this._pressing=true;this._updateState()}};t.prototype._onTouchLeave=function e(t){if(this.enabled===false){return}if(this._fingerId!==-1&&this._fingerId===t.id){t.stop();this._pressing=false;this._updateState()}};t.prototype._emitValueChangedEvents=function e(){this.dispatch("ScrollBar.onValueChanged")};return t}(Zm);D_.events={mouseenter:"_onMouseEnter",mouseleave:"_onMouseLeave",mousedown:"_onMouseDown",mousemove:"_onMouseMove",mouseup:"_onMouseUp",focus:"_onFocus",blur:"_onBlur",touchenter:"_onTouchEnter",touchleave:"_onTouchLeave",touchstart:"_onTouchStart",touchmove:"_onTouchMove",touchend:"_onTouchEnd"};D_.schema={direction:{type:"enums",default:"horizontal",options:["horizontal","vertical"],set:function e(t){if(t===this._direction){return}this._direction=t}},size:{type:"number",default:0,set:function e(t){if(this._size===t){return}this._size=Xe(t);this._updateHandle()},get:function e(){this._size=Math.round(parseFloat(this._size)*100)/100;return this._size}},value:{type:"number",default:0,set:function e(t){if(this._value===t){return}this._set(t);this._updateHandle()},get:function e(){this._value=Math.round(parseFloat(this._value)*100)/100;return this._value}},reverse:{type:"boolean",default:false},handle:{type:"entity",default:null,set:function e(t){if(!(t instanceof sa)){return}if(this._handle===t){return}this._handle=t;if(this._handle){this._handleWidget=this._handle.getComp("Widget")}}},transitionColors:{type:"object",default:{normal:Ft.create(),highlight:Ft.create(),pressed:Ft.create(),disabled:Ft.create()}},transitionSprites:{type:"object",parse:function e(t,n,r,i){if(n){var a={normal:null,highlight:null,pressed:null,disabled:null};if(n.normal&&typeof n.normal==="string"){a.normal=t.assets.get(n.normal)}if(n.highlight&&typeof n.highlight==="string"){a.highlight=t.assets.get(n.highlight)}if(n.pressed&&typeof n.pressed==="string"){a.pressed=t.assets.get(n.pressed)}if(n.disabled&&typeof n.disabled==="string"){a.disabled=t.assets.get(n.disabled)}return a}},default:{normal:null,highlight:null,pressed:null,disabled:null}},background:{type:"entity",default:null,set:function e(t){if(!(t instanceof sa)){return}if(this._background===t){return}this._background=t;if(this._background){this._bgImage=this._background.getComp("Image")}}},transition:{type:"enums",default:"none",options:["none","color","sprite"]}};var L_=function e(t,n){this._center=Ut.zero();Ut.copy(this._center,t);this._extents=Ut.zero();Ut.mul(this._extents,n,Ut.new(.5,.5,.5));this._size=Ut.zero();this._min=Ut.zero();this._max=Ut.zero()};var O_={center:{configurable:true},size:{configurable:true},min:{configurable:true},max:{configurable:true}};O_.center.set=function(e){this._center=e};O_.center.get=function(){return this._center};O_.size.set=function(e){Ut.mul(this._extents,e,Ut.new(.5,.5,.5))};O_.size.get=function(){var e=Ut.zero();Ut.mul(e,this._extents,Ut.new(2,2,2));return e};O_.min.set=function(e){this.setMinMax(e,this._max)};O_.min.get=function(){var e=Ut.zero();Ut.subtract(e,this._center,this._extents);return e};O_.max.set=function(e){this.setMinMax(this._min,e)};O_.max.get=function(){var e=Ut.zero();Ut.add(e,this._center,this._extents);return e};L_.prototype.setMinMax=function e(t,n){var r=Ut.zero();Ut.subtract(r,n,t);Ut.mul(r,r,Ut.new(.5,.5,.5));Ut.set(this._extents,r.x,r.y,r.z);Ut.add(this._center,t,this._extents)};L_.prototype.encapsulate=function e(t){var n=Ut.zero(),r=Ut.zero();Ut.min(n,this.min,t);Ut.max(r,this.max,t);this.setMinMax(n,r)};Object.defineProperties(L_.prototype,O_);var I_=function(e){function t(){var t=this;e.call(this);this._widget=null;this._viewBound=null;this._contentBound=null;this._contentWidget=null;this._viewPortWidget=null;this._hScrollBarComp=null;this._vScrollBarComp=null;this._dragging=false;this._velocity=Rt.zero();this._startPos=Rt.zero();this._startPoint=Rt.zero();this._fingerId=-1;this._correctInited=false;this._prevContentBound=null;this._prevViewBound=null;this._prevPosition=Rt.zero();this._onMouseDown=function(e){if(t.enabled===false){return}e.stop();t._dragging=true;t._startPos=Rt.new(t._contentWidget.offsetX,t._contentWidget.offsetY);t._startPoint=Rt.new(e.mouseX,e.mouseY)};this._onMouseUp=function(e){if(t.enabled===false){return}e.stop();t._dragging=false};this._onMouseMove=function(e){if(t.enabled===false){return}e.stop();if(t._dragging){t._onDrag(Rt.new(e.mouseX,e.mouseY))}};this._onTouchStart=function(e){if(t.enabled===false){return}e.stop();if(t._fingerId!==-1){return}t._fingerId=e.id;t._dragging=true;t._startPos=Rt.new(t._contentWidget.offsetX,t._contentWidget.offsetY);t._startPoint=Rt.new(e.x,e.y)};this._onTouchMove=function(e){if(t.enabled===false){return}e.stop();if(e.id===t._fingerId){if(t._dragging){t._onDrag(Rt.new(e.x,e.y))}}};this._onTouchEnd=function(e){if(t.enabled===false){return}e.stop();if(e.id!==t._fingerId){return}t._fingerId=-1;t._dragging=false};this._updateScrollView=function(e){if(e.component._dragging===false){return}t._updateBound();var n=e.component.reverse?1-e.component.value:e.component.value;if(e.component.direction==="horizontal"){var r=t._contentBound.size.x-t._viewBound.size.x;var i=r*n;var a=t._viewBound.min.x-t._contentBound.min.x;t._contentWidget.offsetX+=a-i}else{var s=t._contentBound.size.y-t._viewBound.size.y;var o=s*n;var l=t._viewBound.min.y-t._contentBound.min.y;t._contentWidget.offsetY+=l-o}t._updateBound()}}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.onInit=function t(){e.prototype.onInit.call(this);this._widget=this._entity.getComp("Widget");this._viewPortWidget=this._viewPort&&this._viewPort.getComp("Widget");this._contentWidget=this._content&&this._content.getComp("Widget");if(this._vScrollBarComp){this._vScrollBar.off("ScrollBar.onValueChanged",this._updateScrollView)}this._vScrollBarComp=this._vScrollBar&&this._vScrollBar.getComp("ScrollBar");if(this._vScrollBarComp){this._vScrollBar._reverse=true;this._vScrollBar.on("ScrollBar.onValueChanged",this._updateScrollView)}if(this._hScrollBarComp){this._hScrollBar.off("ScrollBar.onValueChanged",this._updateScrollView)}this._hScrollBarComp=this._hScrollBar&&this._hScrollBar.getComp("ScrollBar");if(this._hScrollBarComp){this._hScrollBar.on("ScrollBar.onValueChanged",this._updateScrollView)}};t.prototype.onDestroy=function t(){this._vScrollBar._entity.off("ScrollBar.onValueChanged",this._updateScrollView);this._hScrollBar._entity.off("ScrollBar.onValueChanged",this._updateScrollView);e.prototype.onDestroy.call(this)};t.prototype.tick=function e(){if(this._viewPortWidget){if(this._viewPortWidget.anchorLeft!==0||this._viewPortWidget.anchorRight!==1||this._viewPortWidget.anchorBottom!==0||this._viewPortWidget.anchorTop!==1){this._viewPortWidget.setAnchors(0,0,1,1)}}if(this._correctInited===false){this._correctVisual()}};t.prototype._correctVisual=function e(){this._getBound();if(this._viewBound&&!Ut.equals(this._viewBound.size,Ut.zero())&&this._contentBound&&!Ut.equals(this._contentBound.size,Ut.zero())){this._correctInited=true;if(this._viewBound.size.x>=this._contentBound.size.x){if(this._hScrollBar&&this._hScrollBar.active){this._hScrollBar.active=false}if(this._viewPortWidget){this._viewPortWidget.offsetY=0;this._viewPortWidget.sizeY=0}}else{if(this._hScrollBar){if(this._hScrollBar.active===false){this._hScrollBar.active=true}var t=this._hScrollBar.getComp("Widget");if(this._viewPortWidget){this._viewPortWidget.offsetY=t._rect.h*(1-this._viewPortWidget.pivotY);this._viewPortWidget.sizeY=-t._rect.h}t.setAnchors(0,0,1,0);if(this._vScrollBar){if(this._vScrollBar.active){var n=this._vScrollBar.getComp("Widget");t.sizeX=-n._rect.w;t.offsetX=-n._rect.w*t.pivotX}else{t.sizeX=0;t.offsetX=0}}}}if(this._viewBound.size.y>=this._contentBound.size.y){if(this._vScrollBar&&this._vScrollBar.active){this._vScrollBar.active=false}if(this._viewPortWidget){this._viewPortWidget.offsetX=0;this._viewPortWidget.sizeX=0}}else{if(this._vScrollBar){if(this._vScrollBar.active===false){this._vScrollBar.active=true}var r=this._vScrollBar.getComp("Widget");if(this._viewPortWidget){this._viewPortWidget.offsetX=-r._rect.w*this._viewPortWidget.pivotX;this._viewPortWidget.sizeX=-r._rect.w}r.setAnchors(1,0,1,1);if(this._hScrollBar){if(this._hScrollBar.active){var i=this._hScrollBar.getComp("Widget");r.sizeY=-i._rect.h;r.offsetY=i._rect.h*(1-r.pivotY)}else{r.sizeY=0;r.offsetY=0}}}}}};t.prototype.postTick=function e(){this._lateUpdate()};t.prototype._onDrag=function e(t){if(!this._contentWidget){return}this._updateBound();var n=Rt.zero(),r=Rt.zero();Rt.subtract(n,t,this._startPoint);Rt.add(r,n,this._startPos);Rt.subtract(n,r,Rt.new(this._contentWidget.offsetX,this._contentWidget.offsetY));var i=this._calculateOffset(n);Rt.add(r,r,i);var a=[r.x,r.y];if(this._movementType=="elastic"){var s=this._viewBound.size;if(i.x!==0){a[0]-=(1-1/(Math.abs(i.x)*.5/s.x+1))*s.x*this._sign(i.x)}if(i.y!==0){a[1]-=(1-1/(Math.abs(i.y)*.5/s.y+1))*s.y*this._sign(i.y)}}this._setContentOffset(Rt.new(a[0],a[1]))};t.prototype._sign=function e(t){if(t>=0){return 1}return-1};t.prototype._getBound=function e(){if(!this._contentWidget){return new L_(Ut.zero(),Ut.zero())}var t=[Ut.zero(),Ut.zero(),Ut.zero(),Ut.zero()];this._viewPortWidget.getWorldCorners(t[0],t[1],t[2],t[3]);var n=Ut.zero();Ut.add(n,t[0],t[2]);Ut.divide(n,n,Ut.new(2,2,2));var r=this._viewPortWidget._rect;this._viewBound=new L_(n,Ut.new(r.w,r.h,0));var i=[Ut.zero(),Ut.zero(),Ut.zero(),Ut.zero()];this._contentWidget.getWorldCorners(i[0],i[1],i[2],i[3]);var a=Ut.new(3.4e38,3.4e38,3.4e38);var s=Ut.new(-3.4e38,-3.4e38,-3.4e38);for(var o=0;o<4;o++){Ut.min(a,a,i[o]);Ut.max(s,s,i[o])}this._contentBound=new L_(a,Ut.zero());this._contentBound.encapsulate(s)};t.prototype._adjustBound=function e(t,n){var r=[t.x,t.y];var i=[n.x,n.y];var a=Ut.zero();Ut.subtract(a,this._viewBound.size,this._contentBound.size);if(a.x>0){i[0]-=a.x*(this._contentWidget.pivotX-.5);r[0]=this._viewBound.size.x}if(a.y>0){i[1]-=a.y*(this._contentWidget.pivotY-.5);r[1]=this._viewBound.size.y}return{size:Ut.new(r[0],r[1],0),center:Ut.new(i[0],i[1],0)}};t.prototype._updateBound=function e(){this._getBound();if(!this._contentWidget){return}var t=this._contentBound.size;var n=this._contentBound.center;var r=this._adjustBound(t,n);this._contentBound.size=r.size;this._contentBound.center=r.center;if(this._movementType==="clamp"){var i=[0,0];if(this._viewBound.max.x>this._contentBound.max.y){i[0]=Math.min(this._viewBound.max.x-this._contentBound.max.x,this._viewBound.min.x-this._contentBound.min.x)}else if(this._viewBound.min.x<this._contentBound.min.x){i[0]=Math.max(this._viewBound.max.x-this._contentBound.max.x,this._viewBound.min.x-this._contentBound.min.x)}if(this._viewBound.max.y>this._contentBound.max.y){i[1]=Math.min(this._viewBound.max.y-this._contentBound.max.y,this._viewBound.min.y-this._contentBound.min.y)}else if(this._viewBound.min.y<this._contentBound.min.y){i[1]=Math.max(this._viewBound.max.y-this._contentBound.max.y,this._viewBound.min.y-this._contentBound.min.y)}if(!Rt.equals(Rt.new(i.x,i.y),Rt.zero())){n=[];n[0]=this._contentWidget.offsetX+i[0];n[1]=this._contentWidget.offsetY+i[1];if(!this._horizontal){n[0]=this._contentWidget.offsetX}if(!this._vertical){n[1]=this._contentWidget.offsetX}this._setContentOffset(Rt.new(n[0],n[1]))}}};t.prototype._calculateOffset=function e(t){var n=[0,0];if(this._movementType==="unrestricted"){return Rt.zero()}else{var r=[this._contentBound.min.x,this._contentBound.min.y];var i=[this._contentBound.max.x,this._contentBound.max.y];if(this._horizontal){r[0]+=t.x;i[0]+=t.x;if(r[0]>this._viewBound.min.x){n[0]=this._viewBound.min.x-r[0]}else if(i[0]<this._viewBound.max.x){n[0]=this._viewBound.max.x-i[0]}}if(this._vertical){r[1]+=t.y;i[1]+=t.y;if(r[1]>this._viewBound.min.y){n[1]=this._viewBound.min.y-r[1]}else if(i[1]<this._viewBound.max.y){n[1]=this._viewBound.max.y-i[1]}}}return Rt.new(n[0],n[1])};t.prototype._lateUpdate=function e(){var t=this;if(!this._contentWidget){return}this._getBound();var n=this._calculateOffset(Rt.zero());var r=!Rt.equals(n,Rt.zero());var i=!Rt.equals(this._velocity,Rt.zero());if(!this._dragging&&(r||i)){var a=[this._contentWidget.offsetX,this._contentWidget.offsetY];var s=[n.x,n.y];var o=[this._velocity.x,this._velocity.y];for(var l=0;l<2;l++){if(t._movementType==="elastic"&&s[l]!==0){var u=t._smoothBack(a[l],a[l]+s[l],o[l]);a[l]=u.value;o[l]=u.velocity;if(Math.abs(o[l])<1){o[l]=0}}else if(t._inertia){o[l]=o[l]*Math.pow(t._brake,t._app.deltaTime);if(Math.abs(o[l])<1){o[l]=0}a[l]+=o[l]*t._app.deltaTime}else{o[l]=0}}this._velocity=Rt.new(o[0],o[1]);if(!Rt.equals(this._velocity,Rt.zero())){if(this._movementType==="clamped"){var f=Rt.zero();Rt.subtract(f,Rt.new(a.x,a.y),Rt.new(this._contentWidget.offsetX,this._contentWidget.offsetY));n=this._calculateOffset(f);a[0]+=n.x;a[1]+=n.y}this._setContentOffset(Rt.new(a[0],a[1]))}else if(!Rt.equals(n,Rt.zero())){this._setContentOffset(Rt.new(a[0]+n.x,a[1]+n.y))}}var h=Rt.new(this._contentWidget.offsetX,this._contentWidget.offsetY);if(this._dragging&&this._inertia){var c=Rt.zero();Rt.subtract(c,h,this._prevPosition);Rt.divide(c,c,Rt.new(this._app.deltaTime,this._app.deltaTime));Rt.lerp(this._velocity,this._velocity,c,this._app.deltaTime*10)}if(this._prevPosition.x-h.x>.01||this._prevPosition.y>h.y>.01||this._viewBound!==this._prevViewBound||this._contentBound!==this._prevContentBound){this._updateScrollBar();this._emitValueChangedEvents();this._updatePrevData()}};t.prototype._smoothBack=function e(t,n,r){var i=this._app.deltaTime;this._elasticityDuration=Math.max(1e-4,this._elasticityDuration);var a=2/this._elasticityDuration;var s=a*i;var o=1/(1+s+.48*Math.pow(s,2)+.235*Math.pow(s,3));var l=t-n;var u=n;var f=st*this._elasticityDuration;l=We(l,-f,f);n=t-l;var h=(r+a*l)*i;r=(r-a*h)*o;var c=n+(l+h)*o;if(u-t>0===c>u){c=u;r=(c-u)/i}return{value:c,velocity:r}};t.prototype._setContentOffset=function e(t){var n=[t.x,t.y];if(!this._contentWidget){return}if(!this._horizontal){n[0]=this._contentWidget.offsetX}if(!this._vertical){n[1]=this._contentWidget.offsetY}if(!Rt.equals(t,Rt.new(this._contentWidget.offsetX,this._contentWidget.offsetY))){this._contentWidget.setOffset(n[0],n[1]);this._updateBound()}};t.prototype._updatePrevData=function e(){this._prevPosition=Rt.new(this._contentWidget.offsetX,this._contentWidget.offsetY);this._prevContentBound=this._contentBound;this._prevViewBound=this._viewBound};t.prototype._updateScrollBar=function e(){var t=this._calculateOffset(Rt.zero());if(this._hScrollBarComp&&this._hScrollBar.active&&this._hScrollBarComp.handle){this._hScrollBarComp.size=Xe(this._viewBound.size.x/(this._contentBound.size.x+Math.abs(t.x)));if(this._contentBound.size.x<=this._viewBound.size.x){this._hScrollBarComp.value=this._viewBound.min.x<=this._contentBound.min.x?0:1}else{var n=(this._viewBound.min.x-this._contentBound.min.x)/(this._contentBound.size.x-this._viewBound.size.x);this._hScrollBarComp.value=this._hScrollBarComp.reverse?1-Xe(n,0,1):Xe(n,0,1)}}if(this._vScrollBarComp&&this._vScrollBar.active&&this._vScrollBarComp.handle){this._vScrollBarComp.size=Xe(this._viewBound.size.y/(this._contentBound.size.y+Math.abs(t.y)));if(this._contentBound.size.y<=this._viewBound.size.y){this._vScrollBarComp.value=this._viewBound.min.x<=this._contentBound.min.x?0:1}else{var r=(this._viewBound.min.y-this._contentBound.min.y)/(this._contentBound.size.y-this._viewBound.size.y);this._vScrollBarComp.value=this._vScrollBarComp.reverse?1-Xe(r,0,1):Xe(r,0,1)}}};t.prototype._emitValueChangedEvents=function e(){this.dispatch("ScrollView.onValueChanged")};return t}(Zm);I_.events={mousedown:"_onMouseDown",mousemove:"_onMouseMove",mouseup:"_onMouseUp",touchstart:"_onTouchStart",touchmove:"_onTouchMove",touchend:"_onTouchEnd"};I_.schema={horizontal:{type:"boolean",default:true},vertical:{type:"boolean",default:true},viewPort:{type:"entity",default:null,set:function e(t){if(!(t instanceof sa)){return}if(this._viewPort===t){return}this._viewPort=t;if(!this._viewPort){console.warn("ViewPort cannot be null")}if(this._viewPort){this._viewPortWidget=this._viewPort.getComp("Widget")}}},content:{type:"entity",default:null,set:function e(t){if(!(t instanceof sa)){return}if(this._content===t){return}this._content=t;if(!this._content){console.warn("Content cannot be null");return}if(this._content){this._contentWidget=this._content.getComp("Widget")}}},movementType:{type:"enums",default:"clamped",options:["unrestricted","elastic","clamped"]},elasticityDuration:{type:"number",default:.1},inertia:{type:"boolean",default:true},brake:{type:"number",default:.135},vScrollBar:{type:"entity",default:null,set:function e(t){if(!(t instanceof sa)){return}if(this._vScrollBar===t){return}if(this._vScrollBarComp){this._vScrollBar.off("ScrollBar.onValueChanged",this._updateScrollView)}this._vScrollBar=t;if(this._vScrollBar){this._vScrollBar.on("ScrollBar.onValueChanged",this._updateScrollView);this._vScrollBarComp=this._vScrollBar.getComp("ScrollBar");this._vScrollBarComp.reverse=true;this._correctVisual()}}},hScrollBar:{type:"entity",default:null,set:function e(t){if(!(t instanceof sa)){return}if(this._hScrollBar===t){return}if(this._hScrollBarComp){this._hScrollBar.off("ScrollBar.onValueChanged",this._updateScrollView)}this._hScrollBar=t;if(this._hScrollBar){this._hScrollBar.on("ScrollBar.onValueChanged",this._updateScrollView);this._hScrollBarComp=this._hScrollBar.getComp("ScrollBar");this._correctVisual()}}}};var C_=function(e){function t(){e.call(this);this._childManager=[];this._childAlignEnum=0;this._cornerEnum=0;this._lastSize=Rt.zero();this._dirty=false}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.onInit=function t(){e.prototype.onInit.call(this);this._widget=this._entity.getComp("Widget");var n=["upper-left","upper-center","upper-right","middle-left","middle-center","middle-right","lower-left","lower-center","lower-right"];this._childAlignEnum=n.indexOf(this._childAlign);if(this._childAlignEnum===-1){this._childAlignEnum=0}n=["upper-left","upper-right","lower-left","lower-right"];this._cornerEnum=n.indexOf(this._corner);if(this._cornerEnum===-1){this._cornerEnum=0}this._lastSize=Rt.new(this._widget._rect.w,this._widget._rect.h)};t.prototype.tick=function e(){var t=this;if(!Rt.equals(this._lastSize,Rt.new(this._widget._rect.w,this._widget._rect.h))){this._lastSize=Rt.new(this._widget._rect.w,this._widget._rect.h);this._dirty=true}if(!this._dirty){if(this._childManager.length!==this._entity.children.length){this._dirty=true}else{for(var n=0;n<this._entity.children.length;++n){var r=t._entity.children[n];if(r.enabled!==t._childManager[n].enabled){t._dirty=true;break}}}}if(this._dirty){this._calculate();this._dirty=false}};t.prototype.reset=function e(){this._setSpacing(0,0);this._setPadding(0,0,0,0);this._setCellSize(100,100);this._axisDirection="horizontal";var t=["upper-left","upper-right","lower-left","lower-right"];this._corner="upper-left";this._cornerEnum=t.indexOf(this._corner);t=["upper-left","upper-center","upper-right","middle-left","middle-center","middle-right","lower-left","lower-center","lower-right"];this._childAlign="upper-left";this._childAlignEnum=t.indexOf(this._childAlign);this._constraint="flexible";this._constraintCount=2;this._dirty=true};t.prototype._calculate=function e(){var t=this;if(!this._widget){return}this._childManager=[];var n=this._widget._rect.w,r=this._widget._rect.h;var i=this._entity.children.length;var a,s;if(this._constraint==="fixed-row"){a=We(this._constraintCount,1,i);s=Math.max(1,Math.ceil(i/(1*a)))}else if(this._constraint==="fixed-col"){s=We(this._constraintCount,1,i);a=Math.max(1,Math.ceil(i/(1*s)))}else{if(this._cellWidth+this._spacingX<=0){s=65535}else{s=Math.floor((n-this._getPaddingHorizontal()+this._spacingX)/(this._cellWidth+this._spacingX));s=Math.max(1,s)}if(this._cellHeight+this._spacingY<=0){a=65535}else{a=Math.floor((r-this._getPaddingVertical()+this._spacingY)/(this._cellHeight+this._spacingY));a=Math.max(1,a)}}var o,l,u;if(this._axisDirection==="horizontal"){u=s;o=We(s,1,i);l=We(a,1,Math.ceil(i/(1*u)))}else{u=a;l=We(a,1,i);o=We(s,1,Math.ceil(i/(1*u)))}var f=Rt.new(this._cellWidth*o+this._spacingX*(o-1),this._cellHeight*l+this._spacingY*(l-1));var h=Rt.new(this._getStartOffset("horizontal",f.x),this._getStartOffset("vertical",f.y));var c=this._cornerEnum%2,p=parseInt(this._cornerEnum/2);var d=0;for(var m=0;m<i;++m){var _=t._entity.children[m];if(_.enabled===false){continue}var v=_.getComp("Widget");v.setSize(t._cellWidth,t._cellHeight);v.setAnchors(0,1,0,1);var g=void 0,y=void 0;if(t._axisDirection==="horizontal"){g=d%u;y=parseInt(d/u)}else{g=parseInt(d/u);y=d%u}var b=void 0,x=void 0;if(c===1){g=o-g-1}if(p===1){y=l-y-1}b=h.x+(t._cellWidth+t._spacingX)*g+v.pivotX*t._cellWidth;x=h.y+(t._cellHeight+t._spacingY)*y+(1-v.pivotY)*t._cellHeight;v.setOffset(b,-x);t._childManager.push(_);d++}};t.prototype._getStartOffset=function e(t,n){var r=n+(t==="horizontal"?this._getPaddingHorizontal():this._getPaddingVertical());var i=(t==="horizontal"?this._widget._rect.w:this._widget._rect.h)-r;var a=t==="horizontal"?this._childAlignEnum%3*.5:parseInt(this._childAlignEnum/3)*.5;return(t==="horizontal"?this._paddingLeft:this._paddingTop)+i*a};t.prototype._getPaddingHorizontal=function e(){return this._paddingLeft+this._paddingRight};t.prototype._getPaddingVertical=function e(){return this._paddingTop+this._paddingBottom};t.prototype._setPadding=function e(t,n,r,i){this._paddingLeft=t;this._paddingRight=r;this._paddingBottom=n;this._paddingTop=i};t.prototype._setSpacing=function e(t,n){this._spacingX=t;this._spacingY=n};t.prototype._setCellSize=function e(t,n){this._cellWidth=t;this._cellHeight=n};t.prototype.getItems=function e(){return this._childManager};return t}(Zm);C_.schema={axisDirection:{type:"enums",default:"horizontal",options:["horizontal","vertical"],set:function e(t){if(this._axisDirection===t){return}this._axisDirection=t;this._dirty=true}},paddingLeft:{type:"number",default:0,set:function e(t){if(this._paddingLeft===t){return}this._paddingLeft=t;this._dirty=true}},paddingRight:{type:"number",default:0,set:function e(t){if(this._paddingRight===t){return}this._paddingRight=t;this._dirty=true}},paddingBottom:{type:"number",default:0,set:function e(t){if(this._paddingBottom===t){return}this._paddingBottom=t;this._dirty=true}},paddingTop:{type:"number",default:0,set:function e(t){if(this._paddingTop===t){return}this._paddingTop=t;this._dirty=true}},cellWidth:{type:"number",default:100,set:function e(t){if(this._cellWidth===t){return}this._cellWidth=t;this._dirty=true}},cellHeight:{type:"number",default:100,set:function e(t){if(this._cellHeight===t){return}this._cellHeight=t;this._dirty=true}},spacingX:{type:"number",default:0,set:function e(t){if(this._spacingX===t){return}this._spacingX=t;this._dirty=true}},spacingY:{type:"number",default:0,set:function e(t){if(this._spacingY===t){return}this._spacingY=t;this._dirty=true}},corner:{type:"enums",default:"upper-left",options:["upper-left","upper-right","lower-left","lower-right"],set:function e(t){if(this._corner===t){return}var n=["upper-left","upper-right","lower-left","lower-right"];this._cornerEnum=n.indexOf(t);if(this._cornerEnum!==-1){this._corner=t;this._dirty=true}else{this._cornerEnum=0}}},childAlign:{type:"enums",default:"upper-left",options:["upper-left","upper-center","upper-right","middle-left","middle-center","middle-right","lower-left","lower-center","lower-right"],set:function e(t){if(this._childAlign===t){return}var n=["upper-left","upper-center","upper-right","middle-left","middle-center","middle-right","lower-left","lower-center","lower-right"];this._childAlignEnum=n.indexOf(t);if(this._childAlignEnum!==-1){this._childAlign=t;this._dirty=true}else{this._childAlignEnum=0}}},constraint:{type:"enums",default:"flexible",options:["flexible","fixed-row","fixed-col"],set:function e(t){if(this._constraint===t){return}this._constraint=t;this._dirty=true}},constraintCount:{type:"int",default:2,set:function e(t){if(this._constraintCount===t){return}this._constraintCount=t;this._dirty=true}}};var P_=function(e){function t(){e.call(this);this._scripts=new or(200)}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.add=function e(t){this._scripts.push(t);t.awake()};t.prototype.remove=function e(t){var n=this;for(var r=0;r<this._scripts.length;++r){var i=n._scripts.data[r];if(i===t){n._scripts.fastRemove(r);t.end();break}}};t.prototype.tick=function e(){var t=this;for(var n=0;n<this._scripts.length;++n){var r=t._scripts.data[n];if(r.destroyed||!r.enabled){continue}if(r._startedFlag===0){r._startedFlag=1;r.start();continue}r.tick()}};t.prototype.postTick=function e(){var t=this;for(var n=0;n<this._scripts.length;++n){var r=t._scripts.data[n];if(r._startedFlag===1){r._startedFlag=2;continue}if(r.destroyed||!r.enabled){continue}r.postTick()}};return t}(ua);var B_=function(e){function t(){e.call(this);this._comps=new or(200)}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.add=function e(t){this._comps.push(t)};t.prototype.remove=function e(t){var n=this;for(var r=0;r<this._comps.length;++r){var i=n._comps.data[r];if(i===t){n._comps.fastRemove(r);break}}};t.prototype.tick=function e(){var t=this;for(var n=0;n<this._comps.length;++n){var r=t._comps.data[n];if(r.enabled===false){continue}r._updateMatrices()}};return t}(ua);var F_=function(e){function t(){e.call(this);this._anims=new or(200)}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.add=function e(t){this._anims.push(t)};t.prototype.remove=function e(t){var n=this;for(var r=0;r<this._anims.length;++r){var i=n._anims.data[r];if(i===t){n._anims.fastRemove(r);break}}};t.prototype.tick=function e(){var t=this;for(var n=0;n<this._anims.length;++n){var r=t._anims.data[n];r._animCtrl.tick(t._app.deltaTime)}};return t}(ua);var z_=function(e){function t(){e.call(this);this.instanceID=0;this.id2audio={};this.url2id={};var t={};var n=false;var r=t.browserVersion;var i=!!(window.AudioContext||window.webkitAudioContext||window.mozAudioContext);var a={ONLY_ONE:false,WEB_AUDIO:i,DELAY_CREATE_CTX:false};if(t.os===t.OS_IOS){a.USE_LOADER_EVENT="loadedmetadata"}if(t.browserType===t.BROWSER_TYPE_FIREFOX){a.DELAY_CREATE_CTX=true;a.USE_LOADER_EVENT="canplay"}if(t.os===t.OS_ANDROID){if(t.browserType===t.BROWSER_TYPE_UC){a.ONE_SOURCE=true}}if(n){setTimeout(function(){console.log("browse type: "+t.browserType);console.log("browse version: "+r);console.log("MULTI_CHANNEL: "+a.MULTI_CHANNEL);console.log("WEB_AUDIO: "+a.WEB_AUDIO);console.log("AUTOPLAY: "+a.AUTOPLAY)},0)}try{if(a.WEB_AUDIO){a.context=new(window.AudioContext||window.webkitAudioContext||window.mozAudioContext);if(a.DELAY_CREATE_CTX){setTimeout(function(){a.context=new(window.AudioContext||window.webkitAudioContext||window.mozAudioContext)},0)}}}catch(e){a.WEB_AUDIO=false;console.log(e)}function s(){var e=[];var t=document.createElement("audio");if(t.canPlayType){var n=t.canPlayType('audio/ogg; codecs="vorbis"');if(n){e.push(".ogg")}var r=t.canPlayType("audio/mpeg");if(r){e.push(".mp3")}var i=t.canPlayType('audio/wav; codecs="1"');if(i){e.push(".wav")}var a=t.canPlayType("audio/mp4");if(a){e.push(".mp4")}var s=t.canPlayType("audio/x-m4a");if(s){e.push(".m4a")}}return e}a.format=s();this.__audioSupport=a;this._audios=new or(200)}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.add=function e(t){this._audios.push(t)};t.prototype.remove=function e(t){var n=this;for(var r=0;r<this._audios.length;++r){var i=n._audios.data[r];if(i===t){n._audios.fastRemove(r);break}}};t.prototype.addClip=function e(t,n){this.instanceID++;this.url2id[t]=this.instanceID;this.id2audio[this.instanceID]=n;return this.instanceID};t.prototype.getIDByURL=function e(t){return this.url2id[t]};t.prototype.removeClip=function e(t){var n=null;if(!t){return}else if(typeof t==="string"){n=t}else{n=t.url}var r=this.url2id[n];delete this.url2id[n];var i=this.id2audio[r];if(i){i.stop();i.destroy();delete this.id2audio[r]}};t.prototype.setVolumeForAll=function e(t){var n=this;for(var r=0;r<this._audios.length;r++){n._audios.data[r].setVolume(t)}};t.prototype.pauseAll=function e(){var t=this;for(var n=0;n<this._audios.length;n++){t._audios.data[n].pause()}};t.prototype.stopAll=function e(){var t=this;for(var n=0;n<this._audios.length;n++){t._audios.data[n].stop()}};t.prototype.resumeAll=function e(){var t=this;for(var n=0;n<this._audios.length;n++){t._audios.data[n].resume()}};t.prototype._getClipByURL=function e(t){return this.id2audio[this.url2id[t]]};t.prototype._getClipByID=function e(t){return this.id2audio[t]};return t}(ua);var k_=function(e){function t(t,n){e.call(this,t,n);this.reset()}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.reset=function e(){this._stopped=false;this.target=null;this.bubbles=false;this.dx=0;this.dy=0;this.mouseX=0;this.mouseY=0;this.button=0;this.buttons=0};return t}(Ki);var N_=function(e){function t(t,n){e.call(this,t,n);this.reset()}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.reset=function e(){this._stopped=false;this.target=null;this.bubbles=false;this.key=""};return t}(Ki);var G_=function(e){function t(t,n){e.call(this,t,n);this.reset()}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.reset=function e(){this._stopped=false;this.target=null;this.bubbles=false;this.dx=0;this.dy=0;this.x=0;this.y=0};return t}(Ki);var V_=function(e){function t(t,n){e.call(this,t,n);this.reset()}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.reset=function e(){this._stopped=false;this.target=null;this.bubbles=false;this.relatedTarget=null};return t}(Ki);var H_=8;function W_(e,t,n,r,i,a,s,o,l){var u=e.effectInst.getTechnique("ui");for(var f=0;f<u.passes.length;++f){var h=u.passes[f];h.setStencilFront(t,n,r,i,a,s,o,l);h.setStencilBack(t,n,r,i,a,s,o,l)}}var X_=function e(t){this._app=t;this._screen=null;this._curMaterail=null;this._curTexture=null;this._curSpriteBatch=null;this._curStencilLevel=0;this._curUserKey=0;this._dummyNode=new Ur;this._materialPool=new cr(function(){return new yo},100);this._spriteBatchModelPool=new cr(function(){return new Pi.SpriteBatchModel},100)};X_.prototype.reset=function e(){var t=this;for(var n=0;n<this._spriteBatchModelPool.length;++n){var r=t._spriteBatchModelPool.data[n];r.clear();t._app.scene.removeModel(r)}this._materialPool.reset();this._spriteBatchModelPool.reset()};X_.prototype.resetScreen=function e(t){this._screen=t;this._curMaterail=null;this._curTexture=null;this._curSpriteBatch=null;this._curStencilLevel=0;this._curUserKey=0};X_.prototype._stencilWriteMask=function e(){return 1<<this._curStencilLevel-1};X_.prototype._stencilRef=function e(){var t=0;for(var n=0;n<this._curStencilLevel;++n){t+=1<<n}return t};X_.prototype._cloneMaterial=function e(t){var n=this._materialPool.add();n.copy(t);return n};X_.prototype._getSpriteBatchModel=function e(t,n){if(this._curSpriteBatch!==null&&this._curMaterail===t&&this._curTexture===n){return this._curSpriteBatch}var r=this._cloneMaterial(t);r.setProperty("mainTexture",n);if(this._curStencilLevel!==0){var i=this._stencilRef();W_(r,true,Me.DS_FUNC_EQUAL,i,i,Me.STENCIL_OP_KEEP,Me.STENCIL_OP_KEEP,Me.STENCIL_OP_KEEP,0)}else{W_(r,false,Me.DS_FUNC_ALWAYS,0,0,Me.STENCIL_OP_KEEP,Me.STENCIL_OP_KEEP,Me.STENCIL_OP_KEEP,0)}var a=this._spriteBatchModelPool.add();a.setNode(this._dummyNode);a.setEffect(r.effectInst);a._viewID=this._screen._view._id;a.setUserKey(this._curUserKey++);this._app.scene.addModel(a);this._curMaterail=t;this._curTexture=n;this._curSpriteBatch=a;return a};X_.prototype.addImage=function e(t){var n=t.calcVertexData(t._rect.x,t._rect.y,t._rect.w,t._rect.h);var r=t.sprite;if(t.sprite===null){r=this._app.assets.get("default-sprite")}var i=this._getSpriteBatchModel(t.material,r.texture);i.addSprite(n.wposList,n.uvs,n.color,n.indices)};X_.prototype.addText=function e(t){var n=t.calcVertexData(t._rect.x,t._rect.y,t._rect.w,t._rect.h);var r=t.font===null?t.fontTexture:t.font.texture;var i=this._getSpriteBatchModel(t.material,r);i.addSprite(n.wposList,n.uvs,n.color,n.indices)};X_.prototype.pushMask=function e(t){if(this._curStencilLevel+1>H_){console.error("Stencil level exceeed, we only support "+H_+" level in this device.");return}this._curStencilLevel++;var n=t.calcVertexData(t._rect.x,t._rect.y,t._rect.w,t._rect.h);this._curSpriteBatch=null;var r=t.sprite;if(t.sprite===null){r=this._app.assets.get("default-sprite")}var i=this._cloneMaterial(t.material);i.setProperty("mainTexture",r.texture);var a=this._stencilRef();var s=this._stencilWriteMask();W_(i,true,Me.DS_FUNC_NEVER,a,s,Me.STENCIL_OP_REPLACE,Me.STENCIL_OP_KEEP,Me.STENCIL_OP_KEEP,s);var o=this._spriteBatchModelPool.add();o.setNode(this._dummyNode);o.setEffect(i.effectInst);o._viewID=this._screen._view._id;o.setUserKey(this._curUserKey++);o.addSprite(n.wposList,n.uvs,n.color,n.indices);this._app.scene.addModel(o)};X_.prototype.popMask=function e(t){if(this._curStencilLevel-1<0){console.error("popMask being called more than once");return}this._curSpriteBatch=null;var n=t.calcVertexData(t._rect.x,t._rect.y,t._rect.w,t._rect.h);var r=t.sprite;if(t.sprite===null){r=this._app.assets.get("default-sprite")}var i=this._cloneMaterial(t.material);i.setProperty("mainTexture",r.texture);var a=this._stencilWriteMask();W_(i,true,Me.DS_FUNC_NEVER,0,a,Me.STENCIL_OP_REPLACE,Me.STENCIL_OP_KEEP,Me.STENCIL_OP_KEEP,a);var s=this._spriteBatchModelPool.add();s.setNode(this._dummyNode);s.setEffect(i.effectInst);s._viewID=this._screen._view._id;s.setUserKey(this._curUserKey++);s.addSprite(n.wposList,n.uvs,n.color,n.indices);this._app.scene.addModel(s);this._curStencilLevel--};var j_=new or(100);var q_=["left","middle","right"];var Y_=function(){var e=Ut.zero();var t=Ut.zero();var n=Ut.zero();var r=Ut.zero();var i=Ut.zero();var a=Ut.zero();return function(s,o,l,u){Ut.set(e,l,u,1);Ut.set(t,l,u,-1);for(var f=o.length-1;f>=0;--f){var h=o.data[f];var c=h.getComp("Widget");c.getWorldCorners(n,r,i,a);if(on.line_quad(e,t,n,r,i,a)){var p=h.parent;var d=p.getComp("Widget");var m=false;while(d){if(p.getComp("Mask")){d.getWorldCorners(n,r,i,a);if(on.line_quad(e,t,n,r,i,a)===false){m=true}}p=p.parent;d=p.getComp("Widget")}if(m){continue}return h}}return null}}();var K_=function(e){function t(){e.call(this);this._screens=[];this._screenRenderHelper=null;this._hoveringEntity=null;this._focusedEntity=null;this._capturingEntities=[];this._mouseEventPool=new cr(function(){return new k_("unknown")},8);this._keyboardEventPool=new cr(function(){return new N_("unknown")},8);this._touchEventPool=new cr(function(){return new G_("unknown")},8);this._focusEventPool=new cr(function(){return new V_("unknown")},8)}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;var n={hoveringEntity:{configurable:true},focusedEntity:{configurable:true}};n.hoveringEntity.get=function(){return this._hoveringEntity};n.focusedEntity.get=function(){return this._focusedEntity};t.prototype.init=function e(){this._screenRenderHelper=new X_(this._app)};t.prototype.addScreen=function e(t){this._screens.push(t);this._app.scene.addView(t._view)};t.prototype.removeScreen=function e(t){var n=this._screens.indexOf(t);if(n!==-1){this._screens.splice(n,1);this._app.scene.removeView(t._view)}};t.prototype.tick=function e(){var t=this;this._mouseEventPool.reset();this._keyboardEventPool.reset();this._touchEventPool.reset();this._focusEventPool.reset();this._screenRenderHelper.reset();j_.reset();for(var n=0;n<this._screens.length;++n){var r=t._screens[n];if(!r.enabled){continue}var i=false;var a=r._entity.parent;while(a){if(a.getComp("Screen")){i=true;break}a=a.parent}if(i){continue}j_.push(r._entity);kr.walkSibling(r._entity,function(e){if(e.enabled===false){return false}j_.push(e);return true})}this._processInputs(j_);this._processLayout(j_);this._renderScreens()};t.prototype._processInputs=function e(t){var n=this;var r=this._app.input;var i=null;var a=null;if(r.hasTouch){for(var s=0;s<r.touchCount;++s){var o=r.getTouchInfo(s);a=Y_(screen,t,o.x,o.y);i=n._capturingEntities[s]?n._capturingEntities[s]:a;if(i===null){continue}var l=n._touchEventPool.add();l.reset();l.id=o.id;l.dx=o.dx;l.dy=o.dy;l.x=o.x;l.y=o.y;l.target=i;if(o.phase==="start"){if(s===0){n._focus(i)}l.name="touchstart";l.bubbles=true;i.dispatch(l);n._capturingEntities[s]=i;if(s===0){n._hover(a,true)}}else if(o.phase==="pressing"){if(o.dx!==0||o.dy!==0){if(s===0){n._hover(a,true)}l.name="touchmove";l.bubbles=true;i.dispatch(l)}}else if(o.phase==="end"){if(s===0){n._hover(null,true)}l.name="touchend";l.bubbles=true;i.dispatch(l);n._capturingEntities[s]=null}else if(o.phase==="cancel"){if(s===0){n._hover(null,true)}l.name="touchcancel";l.bubbles=true;i.dispatch(l);n._capturingEntities[s]=null}}return}var u=r.hasMouseDown;var f=r.hasMouseUp;var h=r.mouseDeltaX!==0||r.mouseDeltaY!==0;if(h||u||f){a=Y_(screen,t,r.mouseX,r.mouseY);i=this._capturingEntities[0]?this._capturingEntities[0]:a}if(u){this._focus(i);this._capturingEntities[0]=i}if(i){if(u){for(var c=0;c<q_.length;++c){var p=q_[c];if(r.mousedown(p)){var d=n._mouseEventPool.add();d.reset();d.name="mousedown";d.bubbles=true;d.dx=r.mouseDeltaX;d.dy=r.mouseDeltaY;d.mouseX=r.mouseX;d.mouseY=r.mouseY;d.target=i;d.button=p;d.buttons=r.mouseButtons;i.dispatch(d)}}}if(f){for(var m=0;m<q_.length;++m){var _=q_[m];if(r.mouseup(_)){var v=n._mouseEventPool.add();v.reset();v.name="mouseup";v.bubbles=true;v.dx=r.mouseDeltaX;v.dy=r.mouseDeltaY;v.mouseX=r.mouseX;v.mouseY=r.mouseY;v.target=i;v.button=_;v.buttons=r.mouseButtons;i.dispatch(v)}}this._capturingEntities[0]=null}}if(h){this._hover(a,false);if(i){var g=this._mouseEventPool.add();g.reset();g.name="mousemove";g.bubbles=true;g.dx=r.mouseDeltaX;g.dy=r.mouseDeltaY;g.mouseX=r.mouseX;g.mouseY=r.mouseY;g.target=i;g.button=0;g.buttons=r.mouseButtons;i.dispatch(g)}}if(this._focusedEntity){r._keys.forEach(function(e){if(e.state==="down"){var t=n._keyboardEventPool.add();t.reset();t.name="keydown";t.bubbles=true;t.key=e.key;t.target=n._focusedEntity;n._focusedEntity.dispatch(t)}if(e.state==="up"){var r=n._keyboardEventPool.add();r.reset();r.name="keyup";r.bubbles=true;r.key=e.key;r.target=n._focusedEntity;n._focusedEntity.dispatch(r)}})}};t.prototype._focus=function e(t){var n=t;if(n&&n._destroyed){n=null}var r=n?n.getComp("Widget"):null;while(r){if(r.focusable){break}n=n.parent;r=n.getComp("Widget")}if(this._focusedEntity===n){return}var i=this._focusedEntity;this._focusedEntity=n;if(i){var a=this._focusEventPool.add();a.reset();a.name="blur";a.bubbles=false;a.target=i;a.relatedTarget=n;i.dispatch(a)}if(n){var s=this._focusEventPool.add();s.reset();s.name="focus";s.bubbles=false;s.target=n;s.relatedTarget=i;n.dispatch(s)}};t.prototype._hover=function e(t,n){var r=this;if(this._hoveringEntity===t){return}var i=this._app.input;var a=this._hoveringEntity;this._hoveringEntity=t;var s=[];var o=[];var l=a;if(l&&l._destroyed){l=null}var u=l?l.getComp("Widget"):null;while(u){s.push(l);l=l.parent;u=l.getComp("Widget")}l=t;u=l?l.getComp("Widget"):null;while(u){o.push(l);l=l.parent;u=l.getComp("Widget")}var f=s.length;var h=o.length;var c=false;for(var p=0;p<s.length;++p){var d=s[p];for(var m=0;m<o.length;++m){var _=o[p];if(_===d){f=p;h=m;c=true}}if(c){break}}if(!n){for(var v=0;v<f;++v){var g=s[v];var y=r._mouseEventPool.add();y.reset();y.name="mouseleave";y.bubbles=false;y.dx=i.mouseDeltaX;y.dy=i.mouseDeltaY;y.mouseX=i.mouseX;y.mouseY=i.mouseY;y.target=g;y.button=0;y.buttons=i.mouseButtons;g.emit("mouseleave",y)}for(var b=h-1;b>=0;--b){var x=o[b];var T=r._mouseEventPool.add();T.reset();T.name="mouseenter";T.bubbles=false;T.dx=i.mouseDeltaX;T.dy=i.mouseDeltaY;T.mouseX=i.mouseX;T.mouseY=i.mouseY;T.target=x;T.button=0;T.buttons=i.mouseButtons;x.emit("mouseenter",T)}}else{var S=i.getTouchInfo(0);for(var E=0;E<f;++E){var w=s[E];var M=r._touchEventPool.add();M.reset();M.name="touchleave";M.bubbles=false;M.id=S.id;M.dx=S.dx;M.dy=S.dy;M.x=S.x;M.y=S.y;M.target=w;w.emit("touchleave",M)}for(var A=h-1;A>=0;--A){var R=o[A];var U=r._touchEventPool.add();U.reset();U.name="touchenter";U.bubbles=false;U.id=S.id;U.dx=S.dx;U.dy=S.dy;U.x=S.x;U.y=S.y;U.target=R;R.emit("touchenter",U)}}};t.prototype._processLayout=function e(t){var n=this;for(var r=0;r<t.length;++r){var i=t.data[r];var a=i.getComp("Widget");var s=i.parent;var o=s.getComp("Widget");var l=0,u=0;var f=0,h=0;if(o===null){l=0;u=0;f=n._app._canvas.width/a.scaleFactor;h=n._app._canvas.height/a.scaleFactor;a.setOffset(0,0);a.setAnchors(0,0,0,0);a.setSize(f,h);a.setPivot(0,0)}else{l=o._rect.x;u=o._rect.y;f=o._rect.w;h=o._rect.h}a.calculate(l,u,f,h)}};t.prototype._renderScreens=function e(){var t=this;for(var n=0;n<this._screens.length;++n){var r=t._screens[n];if(!r.enabled){continue}var i=r._view;var a=t._app._canvas.width;var s=t._app._canvas.height;Pt.ortho(i._matProj,0,a,0,s,-100,100);Pt.copy(i._matViewProj,i._matProj);Pt.invert(i._matInvViewProj,i._matProj);i._rect.x=i._rect.y=0;i._rect.w=a;i._rect.h=s;t._screenRenderHelper.resetScreen(r);kr.walk2(r._entity,function(e){var n=e.getComp("Mask");if(n&&n.enabled){t._screenRenderHelper.pushMask(n)}var r=e.getComp("Image");if(r&&r.enabled){t._screenRenderHelper.addImage(r)}var i=e.getComp("Text");if(i&&i.enabled){t._screenRenderHelper.addText(i)}},function(e){var n=e.getComp("Mask");if(n&&n.enabled){t._screenRenderHelper.popMask(n)}})}};Object.defineProperties(t.prototype,n);return t}(ua);var Z_=function(e){function t(){e.call(this);this._particleSystems=new or(10)}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.add=function e(t){this._particleSystems.push(t)};t.prototype.remove=function e(t){var n=this;for(var r=0;r<this._particleSystems.length;++r){var i=n._particleSystems.data[r];if(i===t){n._particleSystems.fastRemove(r);break}}};t.prototype.tick=function e(){var t=this;for(var n=0;n<this._particleSystems.length;++n){var r=t._particleSystems.data[n];r.tick(t._app.deltaTime)}};return t}(ua);Ea.registerLoader("mesh",jo);Ea.registerLoader("material",qo);Ea.registerLoader("texture",Qo);Ea.registerLoader("prefab",el);Ea.registerLoader("gltf",nl);Ea.registerLoader("animation",rl);Ea.registerLoader("audio",ol);Ea.registerLoader("bmfont",pl);Ea.registerLoader("otfont",Hd);for(var J_ in Lo){Ea.registerType(J_,Lo[J_])}Ea.registerClass("Script",Wd);Ea.registerClass("Camera",Xd);Ea.registerClass("Light",jd);Ea.registerClass("Model",qd);Ea.registerClass("SkinningModel",Kd);Ea.registerClass("Animation",Qd);Ea.registerClass("AudioSource",im);Ea.registerClass("Skybox",sm);Ea.registerClass("Screen",Km);Ea.registerClass("ScreenScaler",Jm);Ea.registerClass("Widget",Ym);Ea.registerClass("Mask",S_);Ea.registerClass("Image",c_);Ea.registerClass("Text",b_);Ea.registerClass("UIElement",Zm);Ea.registerClass("Button",w_);Ea.registerClass("Toggle",M_);Ea.registerClass("ToggleGroup",A_);Ea.registerClass("Slider",R_);Ea.registerClass("EditBox",U_);Ea.registerClass("ScrollBar",D_);Ea.registerClass("ScrollView",I_);Ea.registerClass("GridLayout",C_);Ea.registerClass("ParticleSystem",jm);Ea.registerSystem("script",P_,"Script",0);Ea.registerSystem("skinning-model",B_,"SkinningModel",100);Ea.registerSystem("animation",F_,"Animation",200);Ea.registerSystem("audio",z_,"AudioSource",200);Ea.registerSystem("widget",K_,"Widget",100);Ea.registerSystem("ui-element",E_,"UIElement",101);Ea.registerSystem("particle-system",Z_,"ParticleSystem",100);Ea.registerClass("Keyframe",bn);Ea.registerClass("AnimationCurve",xn);function Q_(e){var t=e;return function(e){t._tickID=requestAnimationFrame(t._tick);if(e===undefined){e=0}t.deltaTime=(e-t._lasttime)/1e3;t.totalTime=e/1e3;t._lasttime=e;t._debugger.tick();t.emit("tick");t.tick();t._debugger.postTick();t._forward.render(t.scene);t._input.reset();t._scene.reset()}}var $_=function(e){function t(t,n){var r=this;if(n===void 0)n={};e.call(this,{poolSize:n.poolSize||100});this.__initEventEmitter();this._canvas=t;this._input=new qi(t,{lock:false,invertY:true});this._device=new Me.Device(t,n);var i=Do(this._device);Pi.addStage("opaque");Pi.addStage("transparent");Pi.addStage("ui");Pi.addStage("shadowcast");this._forward=new Pi.ForwardRenderer(this._device,{defaultTexture:i["default-texture"]._texture,defaultTextureCube:i["default-texture-cube"]._texture});this._scene=new Pi.Scene;this._assetMng=new us(this);this._debugger=new vo(this);for(var a in i){var s=i[a];r._assetMng.add(s._uuid,s)}Ea._init(this);this._sortSystems();this._tick=Q_(this);this.deltaTime=0;this.totalTime=0;this._tickID=null;this._lasttime=0;this._activeCamera=null;window.addEventListener("resize",function(){r.resize()})}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;var n={device:{configurable:true},scene:{configurable:true},input:{configurable:true},assets:{configurable:true},debugger:{configurable:true}};n.device.get=function(){return this._device};n.scene.get=function(){return this._scene};n.input.get=function(){return this._input};n.assets.get=function(){return this._assetMng};n.debugger.get=function(){return this._debugger};t.prototype.run=function e(){if(!this._activeLevel){console.warn("There is no level to run, please load it first");return}this._tickID=requestAnimationFrame(this._tick)};t.prototype.resize=function e(){if(!this._canvas){return}var t=this._canvas.parentElement.getBoundingClientRect();this._canvas.width=t.width;this._canvas.height=t.height;this._input.resize()};t.prototype.destroy=function e(){this._canvas=null;this._input.destroy();this._activeLevel.destroy();this._activeLevel=null;if(this._tickID){cancelAnimationFrame(this._tickID)}};t.prototype.find=function e(t,n){if(!t){return null}n=n||this._activeLevel;return kr.find(n,t)};Object.defineProperties(t.prototype,n);return t}(ga);na.mixin($_);function ev(e){return e.replace(/\\/g,"/").replace(/[\/]+/g,"/").replace(/\/\?/g,"?").replace(/\/\#/g,"#").replace(/\:\//g,"://")}var tv={normalize:function e(t){return ev(t)},join:function e(){var t=[].slice.call(arguments,0).join("/");return ev(t)}};var nv={registerLoader:Ea.registerLoader,registerClass:Ea.registerClass,registerSystem:Ea.registerSystem,Node:Ur,Asset:Ba,Mesh:za,Joints:Po,Material:yo,Prefab:$o,AnimationClip:Io,AudioClip:al,Gltf:tl,Texture:ka,Texture2D:ja,TextureCube:To,Sprite:Ro,App:$_,Level:la,System:ua,Component:ia,ScriptComponent:Wd,CameraComponent:Xd,LightComponent:jd,ModelComponent:qd,SkinningModelComponent:Kd,AnimationComponent:Qd,AudioSourceComponent:im,SkyboxComponent:sm,ParticleSystemComponent:jm,ScreenComponent:Km,ScreenScalerComponent:Jm,WidgetComponent:Ym,ImageComponent:c_,TextComponent:b_,MaskComponent:S_,UIElementComponent:Zm,ButtonComponent:w_,ToggleComponent:M_,ToggleGroupComponent:A_,SliderComponent:R_,EditBoxComponent:U_,ScrollBarComponent:D_,BoundComponent:L_,ScrollViewComponent:I_,GridLayoutComponent:C_,math:kt,geometry:Tn,memop:xr,primitives:oo,renderer:Pi,gfx:Me,utils:as,resl:Ca,path:tv,async:Ya};return nv}();
//# sourceMappingURL=engine.min.js.map