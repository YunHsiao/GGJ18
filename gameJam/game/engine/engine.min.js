var cc=function(){"use strict";var e=9728;var t=9729;var r=9984;var n=9985;var i=9986;var a=9987;var o=5121;var s=5123;var l=5125;var u=5126;var h=33635;var c=32819;var f=32820;var p=36193;var d=6402;var v=6406;var m=6407;var _=6408;var g=6409;var y=6410;var x=33776;var b=33777;var w=33778;var T=33779;var E=35840;var S=35841;var M=35842;var A=35843;var R=36196;var L=[[e,r,i],[t,n,a]];var C=[{format:m,internalFormat:x,pixelType:null},{format:_,internalFormat:b,pixelType:null},{format:_,internalFormat:w,pixelType:null},{format:_,internalFormat:T,pixelType:null},{format:m,internalFormat:R,pixelType:null},{format:m,internalFormat:S,pixelType:null},{format:_,internalFormat:A,pixelType:null},{format:m,internalFormat:E,pixelType:null},{format:_,internalFormat:M,pixelType:null},{format:v,internalFormat:v,pixelType:o},{format:g,internalFormat:g,pixelType:o},{format:y,internalFormat:y,pixelType:o},{format:m,internalFormat:m,pixelType:h},{format:_,internalFormat:_,pixelType:f},{format:_,internalFormat:_,pixelType:c},{format:m,internalFormat:m,pixelType:o},{format:_,internalFormat:_,pixelType:o},{format:m,internalFormat:m,pixelType:p},{format:_,internalFormat:_,pixelType:p},{format:m,internalFormat:m,pixelType:u},{format:_,internalFormat:_,pixelType:u},{format:null,internalFormat:null,pixelType:null},{format:null,internalFormat:null,pixelType:null},{format:null,internalFormat:null,pixelType:null},{format:null,internalFormat:null,pixelType:null},{format:d,internalFormat:d,pixelType:s},{format:d,internalFormat:d,pixelType:l},{format:null,internalFormat:null,pixelType:null}];var I={USAGE_STATIC:35044,USAGE_DYNAMIC:35048,USAGE_STREAM:35040,INDEX_FMT_UINT8:5121,INDEX_FMT_UINT16:5123,INDEX_FMT_UINT32:5125,ATTR_POSITION:"a_position",ATTR_NORMAL:"a_normal",ATTR_TANGENT:"a_tangent",ATTR_BITANGENT:"a_bitangent",ATTR_WEIGHTS:"a_weights",ATTR_JOINTS:"a_joints",ATTR_COLOR:"a_color",ATTR_COLOR0:"a_color0",ATTR_COLOR1:"a_color1",ATTR_UV:"a_uv",ATTR_UV0:"a_uv0",ATTR_UV1:"a_uv1",ATTR_UV2:"a_uv2",ATTR_UV3:"a_uv3",ATTR_UV4:"a_uv4",ATTR_UV5:"a_uv5",ATTR_UV6:"a_uv6",ATTR_UV7:"a_uv7",ATTR_TYPE_INT8:5120,ATTR_TYPE_UINT8:5121,ATTR_TYPE_INT16:5122,ATTR_TYPE_UINT16:5123,ATTR_TYPE_INT32:5124,ATTR_TYPE_UINT32:5125,ATTR_TYPE_FLOAT32:5126,FILTER_NEAREST:0,FILTER_LINEAR:1,WRAP_REPEAT:10497,WRAP_CLAMP:33071,WRAP_MIRROR:33648,TEXTURE_FMT_RGB_DXT1:0,TEXTURE_FMT_RGBA_DXT1:1,TEXTURE_FMT_RGBA_DXT3:2,TEXTURE_FMT_RGBA_DXT5:3,TEXTURE_FMT_RGB_ETC1:4,TEXTURE_FMT_RGB_PVRTC_2BPPV1:5,TEXTURE_FMT_RGBA_PVRTC_2BPPV1:6,TEXTURE_FMT_RGB_PVRTC_4BPPV1:7,TEXTURE_FMT_RGBA_PVRTC_4BPPV1:8,TEXTURE_FMT_A8:9,TEXTURE_FMT_L8:10,TEXTURE_FMT_L8_A8:11,TEXTURE_FMT_R5_G6_B5:12,TEXTURE_FMT_R5_G5_B5_A1:13,TEXTURE_FMT_R4_G4_B4_A4:14,TEXTURE_FMT_RGB8:15,TEXTURE_FMT_RGBA8:16,TEXTURE_FMT_RGB16F:17,TEXTURE_FMT_RGBA16F:18,TEXTURE_FMT_RGB32F:19,TEXTURE_FMT_RGBA32F:20,TEXTURE_FMT_R32F:21,TEXTURE_FMT_111110F:22,TEXTURE_FMT_SRGB:23,TEXTURE_FMT_SRGBA:24,TEXTURE_FMT_D16:25,TEXTURE_FMT_D32:26,TEXTURE_FMT_D24S8:27,DS_FUNC_NEVER:512,DS_FUNC_LESS:513,DS_FUNC_EQUAL:514,DS_FUNC_LEQUAL:515,DS_FUNC_GREATER:516,DS_FUNC_NOTEQUAL:517,DS_FUNC_GEQUAL:518,DS_FUNC_ALWAYS:519,RB_FMT_RGBA4:32854,RB_FMT_RGB5_A1:32855,RB_FMT_RGB565:36194,RB_FMT_D16:33189,RB_FMT_S8:36168,RB_FMT_D24S8:34041,BLEND_FUNC_ADD:32774,BLEND_FUNC_SUBTRACT:32778,BLEND_FUNC_REVERSE_SUBTRACT:32779,BLEND_ZERO:0,BLEND_ONE:1,BLEND_SRC_COLOR:768,BLEND_ONE_MINUS_SRC_COLOR:769,BLEND_DST_COLOR:774,BLEND_ONE_MINUS_DST_COLOR:775,BLEND_SRC_ALPHA:770,BLEND_ONE_MINUS_SRC_ALPHA:771,BLEND_DST_ALPHA:772,BLEND_ONE_MINUS_DST_ALPHA:773,BLEND_CONSTANT_COLOR:32769,BLEND_ONE_MINUS_CONSTANT_COLOR:32770,BLEND_CONSTANT_ALPHA:32771,BLEND_ONE_MINUS_CONSTANT_ALPHA:32772,BLEND_SRC_ALPHA_SATURATE:776,STENCIL_OP_KEEP:7680,STENCIL_OP_ZERO:0,STENCIL_OP_REPLACE:7681,STENCIL_OP_INCR:7682,STENCIL_OP_INCR_WRAP:34055,STENCIL_OP_DECR:7683,STENCIL_OP_DECR_WRAP:34056,STENCIL_OP_INVERT:5386,CULL_NONE:0,CULL_FRONT:1028,CULL_BACK:1029,CULL_FRONT_AND_BACK:1032,PT_POINTS:0,PT_LINES:1,PT_LINE_LOOP:2,PT_LINE_STRIP:3,PT_TRIANGLES:4,PT_TRIANGLE_STRIP:5,PT_TRIANGLE_FAN:6};function U(e){if(e===I.ATTR_TYPE_INT8){return 1}else if(e===I.ATTR_TYPE_UINT8){return 1}else if(e===I.ATTR_TYPE_INT16){return 2}else if(e===I.ATTR_TYPE_UINT16){return 2}else if(e===I.ATTR_TYPE_INT32){return 4}else if(e===I.ATTR_TYPE_UINT32){return 4}else if(e===I.ATTR_TYPE_FLOAT32){return 4}console.warn("Unknown ATTR_TYPE: "+e);return 0}function D(e,t,r){if(r===void 0)r=-1;var n=L[t][r+1];if(n===undefined){console.warn("Unknown FILTER: "+t);return r===-1?e.LINEAR:e.LINEAR_MIPMAP_LINEAR}return n}function O(e){var t=C[e];if(t===undefined){console.warn("Unknown TEXTURE_FMT: "+e);return C[I.TEXTURE_FMT_RGBA8]}return t}var B=function e(t){var r=this;this._attr2el={};this._elements=[];this._bytes=0;var n=0;for(var i=0,a=t.length;i<a;++i){var o=t[i];var s={name:o.name,offset:n,stride:0,stream:-1,type:o.type,num:o.num,normalize:o.normalize===undefined?false:o.normalize,bytes:o.num*U(o.type)};r._attr2el[s.name]=s;r._elements.push(s);r._bytes+=s.bytes;n+=s.bytes}for(var l=0,u=this._elements.length;l<u;++l){var h=r._elements[l];h.stride=r._bytes}};B.prototype.element=function e(t){return this._attr2el[t]};var P=function e(t,r,n,i,a){this._device=t;this._format=r;this._usage=n;this._numIndices=a;this._bytesPerIndex=0;if(r===I.INDEX_FMT_UINT8){this._bytesPerIndex=1}else if(r===I.INDEX_FMT_UINT16){this._bytesPerIndex=2}else if(r===I.INDEX_FMT_UINT32){this._bytesPerIndex=4}this._bytes=this._bytesPerIndex*a;this._glID=t._gl.createBuffer();this.update(0,i);t._stats.ib+=this._bytes};var F={count:{configurable:true}};P.prototype.destroy=function e(){if(this._glID===-1){console.error("The buffer already destroyed");return}var t=this._device._gl;t.deleteBuffer(this._glID);this._device._stats.ib-=this.bytes;this._glID=-1};P.prototype.update=function e(t,r){if(this._glID===-1){console.error("The buffer is destroyed");return}if(r&&r.byteLength+t>this._bytes){console.error("Failed to update data, bytes exceed.");return}var n=this._device._gl;var i=this._usage;n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,this._glID);if(!r){if(this._bytes){n.bufferData(n.ELEMENT_ARRAY_BUFFER,this._bytes,i)}else{console.warn("bufferData should not submit 0 bytes data")}}else{if(t){n.bufferSubData(n.ELEMENT_ARRAY_BUFFER,t,r)}else{n.bufferData(n.ELEMENT_ARRAY_BUFFER,r,i)}}this._device._restoreIndexBuffer()};F.count.get=function(){return this._numIndices};Object.defineProperties(P.prototype,F);var z=function e(t,r,n,i,a){this._device=t;this._format=r;this._usage=n;this._numVertices=a;this._bytes=this._format._bytes*a;this._glID=t._gl.createBuffer();this.update(0,i);t._stats.vb+=this._bytes};var N={count:{configurable:true}};z.prototype.destroy=function e(){if(this._glID===-1){console.error("The buffer already destroyed");return}var t=this._device._gl;t.deleteBuffer(this._glID);this._device._stats.vb-=this.bytes;this._glID=-1};z.prototype.update=function e(t,r){if(this._glID===-1){console.error("The buffer is destroyed");return}if(r&&r.byteLength+t>this._bytes){console.error("Failed to update data, bytes exceed.");return}var n=this._device._gl;var i=this._usage;n.bindBuffer(n.ARRAY_BUFFER,this._glID);if(!r){if(this._bytes){n.bufferData(n.ARRAY_BUFFER,this._bytes,i)}else{console.warn("bufferData should not submit 0 bytes data")}}else{if(t){n.bufferSubData(n.ARRAY_BUFFER,t,r)}else{n.bufferData(n.ARRAY_BUFFER,r,i)}}n.bindBuffer(n.ARRAY_BUFFER,null)};N.count.get=function(){return this._numVertices};Object.defineProperties(z.prototype,N);var k=0;function V(e,t,r){r.split("\n").forEach(function(r){if(r.length<5){return}var n=/^ERROR\:\s+(\d+)\:(\d+)\:\s*(.*)$/.exec(r);if(n){e.push({type:t,fileID:n[1]|0,line:n[2]|0,message:n[3].trim()})}else if(r.length>0){e.push({type:t,fileID:-1,line:0,message:r})}})}var G=function e(t,r){this._device=t;this._attributes=[];this._uniforms=[];this._samplers=[];this._errors=[];this._linked=false;this._vertSource=r.vert;this._fragSource=r.frag;this._glID=null;this._id=k++};var W={id:{configurable:true}};W.id.get=function(){return this._id};G.prototype.link=function e(){var t=this;if(this._linked){return}var r=this._device._gl;var n=H(r,r.VERTEX_SHADER,this._vertSource);var i=H(r,r.FRAGMENT_SHADER,this._fragSource);var a=r.createProgram();r.attachShader(a,n);r.attachShader(a,i);r.linkProgram(a);var o=false;var s=this._errors;if(!r.getShaderParameter(n,r.COMPILE_STATUS)){V(s,"vs",r.getShaderInfoLog(n));o=true}if(!r.getShaderParameter(i,r.COMPILE_STATUS)){V(s,"fs",r.getShaderInfoLog(i));o=true}r.deleteShader(n);r.deleteShader(i);if(o){s.forEach(function(e){console.error("Failed to compile "+e.type+" "+e.fileID+" (ln "+e.line+"): "+e.message)});return}if(!r.getProgramParameter(a,r.LINK_STATUS)){console.error("Failed to link shader program: "+r.getProgramInfoLog(a));o=true}if(o){return}this._glID=a;var l=r.getProgramParameter(a,r.ACTIVE_ATTRIBUTES);for(var u=0;u<l;++u){var h=r.getActiveAttrib(a,u);var c=r.getAttribLocation(a,h.name);t._attributes.push({name:h.name,location:c,type:h.type})}var f=r.getProgramParameter(a,r.ACTIVE_UNIFORMS);for(var p=0;p<f;++p){var d=r.getActiveUniform(a,p);var v=d.name;var m=r.getUniformLocation(a,v);var _=v.substr(v.length-3)==="[0]";if(_){v=v.substr(0,v.length-3)}t._uniforms.push({name:v,location:m,type:d.type,size:_?d.size:undefined})}this._linked=true};G.prototype.destroy=function e(){var t=this._device._gl;t.deleteProgram(this._glID);this._linked=false;this._glID=null;this._attributes=[];this._uniforms=[];this._samplers=[]};Object.defineProperties(G.prototype,W);function H(e,t,r){var n=e.createShader(t);e.shaderSource(n,r);e.compileShader(n);return n}var j=function e(t){this._device=t;this._width=4;this._height=4;this._hasMipmap=false;this._compressed=false;this._anisotropy=1;this._minFilter=I.FILTER_LINEAR;this._magFilter=I.FILTER_LINEAR;this._mipFilter=I.FILTER_LINEAR;this._wrapS=I.WRAP_REPEAT;this._wrapT=I.WRAP_REPEAT;this._format=I.TEXTURE_FMT_RGBA8;this._target=-1};j.prototype.destroy=function e(){if(this._glID===-1){console.error("The texture already destroyed");return}var t=this._device._gl;t.deleteTexture(this._glID);this._device._stats.tex-=this.bytes;this._glID=-1};function q(e){return!(e&e-1)&&!!e}var X=function(e){function t(t,r){e.call(this,t);var n=this._device._gl;this._target=n.TEXTURE_2D;this._glID=n.createTexture();r.images=r.images||[null];this.update(r)}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.update=function e(t){var r=this._device._gl;var n=this._hasMipmap;if(t){if(t.width!==undefined){this._width=t.width}if(t.height!==undefined){this._height=t.height}if(t.anisotropy!==undefined){this._anisotropy=t.anisotropy}if(t.minFilter!==undefined){this._minFilter=t.minFilter}if(t.magFilter!==undefined){this._magFilter=t.magFilter}if(t.mipFilter!==undefined){this._mipFilter=t.mipFilter}if(t.wrapS!==undefined){this._wrapS=t.wrapS}if(t.wrapT!==undefined){this._wrapT=t.wrapT}if(t.format!==undefined){this._format=t.format;this._compressed=this._format>=I.TEXTURE_FMT_RGB_DXT1&&this._format<=I.TEXTURE_FMT_RGBA_PVRTC_4BPPV1}if(t.mipmap!==undefined){this._hasMipmap=t.mipmap;n=t.mipmap}if(t.images!==undefined){if(t.images.length>1){n=false;var i=t.width>t.height?t.width:t.height;if(i>>t.images.length-1!==1){console.error("texture-2d mipmap is invalid, should have a 1x1 mipmap.")}}}}var a=q(this._width)&&q(this._height);if(!a){n=false}r.activeTexture(r.TEXTURE0);r.bindTexture(r.TEXTURE_2D,this._glID);if(t.images!==undefined&&t.images.length>0){this._setMipmap(t.images,t.flipY,t.premultiplyAlpha);if(t.images.length>1){this._hasMipmap=true}}if(n){r.hint(r.GENERATE_MIPMAP_HINT,r.NICEST);r.generateMipmap(r.TEXTURE_2D);this._hasMipmap=true}this._setTexInfo();this._device._restoreTexture(0)};t.prototype.updateSubImage=function e(t){var r=this._device._gl;var n=O(this._format);r.activeTexture(r.TEXTURE0);r.bindTexture(r.TEXTURE_2D,this._glID);this._setSubImage(n,t);this._device._restoreTexture(0)};t.prototype.updateImage=function e(t){var r=this._device._gl;var n=O(this._format);r.activeTexture(r.TEXTURE0);r.bindTexture(r.TEXTURE_2D,this._glID);this._setImage(n,t);this._device._restoreTexture(0)};t.prototype._setSubImage=function e(t,r){var n=this._device._gl;var i=r.flipY;var a=r.premultiplyAlpha;var o=r.image;if(o instanceof HTMLCanvasElement||o instanceof HTMLImageElement||o instanceof HTMLVideoElement){if(i===undefined){n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,true)}else{n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,i)}if(a===undefined){n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,false)}else{n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,a)}n.texSubImage2D(n.TEXTURE_2D,r.level,r.x,r.y,t.format,t.pixelType,o)}else{if(i===undefined){n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,false)}else{n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,i)}if(a===undefined){n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,false)}else{n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,a)}if(this._compressed){n.compressedTexSubImage2D(n.TEXTURE_2D,r.level,r.x,r.y,r.width,r.height,t.format,o)}else{n.texSubImage2D(n.TEXTURE_2D,r.level,r.x,r.y,r.width,r.height,t.format,t.pixelType,o)}}};t.prototype._setImage=function e(t,r){var n=this._device._gl;var i=r.flipY;var a=r.premultiplyAlpha;var o=r.image;if(o instanceof HTMLCanvasElement||o instanceof HTMLImageElement||o instanceof HTMLVideoElement){if(i===undefined){n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,true)}else{n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,i)}if(a===undefined){n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,false)}else{n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,a)}n.texImage2D(n.TEXTURE_2D,r.level,t.internalFormat,t.format,t.pixelType,o)}else{if(i===undefined){n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,false)}else{n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,i)}if(a===undefined){n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,false)}else{n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,a)}if(this._compressed){n.compressedTexImage2D(n.TEXTURE_2D,r.level,t.internalFormat,r.width,r.height,0,o)}else{n.texImage2D(n.TEXTURE_2D,r.level,t.internalFormat,r.width,r.height,0,t.format,t.pixelType,o)}}};t.prototype._setMipmap=function e(t,r,n){var i=this;var a=O(this._format);var o={width:this._width,height:this._height,flipY:r,premultiplyAlpha:n,level:0,image:null};for(var s=0;s<t.length;++s){o.level=s;o.width=i._width>>s;o.height=i._height>>s;o.image=t[s];i._setImage(a,o)}};t.prototype._setTexInfo=function e(){var t=this._device._gl;var r=q(this._width)&&q(this._height);if(!r&&(this._wrapS!==I.WRAP_CLAMP||this._wrapT!==I.WRAP_CLAMP)){console.warn("WebGL1 doesn't support all wrap modes with NPOT textures");this._wrapS=I.WRAP_CLAMP;this._wrapT=I.WRAP_CLAMP}var n=this._hasMipmap?this._mipFilter:-1;if(!r&&n!==-1){console.warn("NPOT textures do not support mipmap filter");n=-1}t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,D(t,this._minFilter,n));t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,D(t,this._magFilter,-1));t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,this._wrapS);t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,this._wrapT);var i=this._device.ext("EXT_texture_filter_anisotropic");if(i){t.texParameteri(t.TEXTURE_2D,i.TEXTURE_MAX_ANISOTROPY_EXT,this._anisotropy)}};return t}(j);var Y=function(e){function t(t,r){e.call(this,t);var n=this._device._gl;this._target=n.TEXTURE_CUBE_MAP;this._glID=n.createTexture();this.update(r)}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.update=function e(t){var r=this._device._gl;var n=this._hasMipmap;if(t){if(t.width!==undefined){this._width=t.width}if(t.height!==undefined){this._height=t.height}if(t.anisotropy!==undefined){this._anisotropy=t.anisotropy}if(t.minFilter!==undefined){this._minFilter=t.minFilter}if(t.magFilter!==undefined){this._magFilter=t.magFilter}if(t.mipFilter!==undefined){this._mipFilter=t.mipFilter}if(t.wrapS!==undefined){this._wrapS=t.wrapS}if(t.wrapT!==undefined){this._wrapT=t.wrapT}if(t.format!==undefined){this._format=t.format;this._compressed=this._format>=I.TEXTURE_FMT_RGB_DXT1&&this._format<=I.TEXTURE_FMT_RGBA_PVRTC_4BPPV1}if(t.mipmap!==undefined){this._hasMipmap=t.mipmap;n=t.mipmap}if(t.images!==undefined){if(t.images.length>1){n=false;if(t.width!==t.height){console.warn("texture-cube width and height should be identical.")}if(t.width>>t.images.length-1!==1){console.error("texture-cube mipmap is invalid. please set mipmap as 1x1, 2x2, 4x4 ... nxn")}}}}var i=q(this._width)&&q(this._height);if(!i){n=false}r.activeTexture(r.TEXTURE0);r.bindTexture(r.TEXTURE_CUBE_MAP,this._glID);if(t.images!==undefined&&t.images.length>0){this._setMipmap(t.images,t.flipY,t.premultiplyAlpha);if(t.images.length>1){this._hasMipmap=true}}if(n){r.hint(r.GENERATE_MIPMAP_HINT,r.NICEST);r.generateMipmap(r.TEXTURE_CUBE_MAP);this._hasMipmap=true}this._setTexInfo();this._device._restoreTexture(0)};t.prototype.updateSubImage=function e(t){var r=this._device._gl;var n=O(this._format);r.activeTexture(r.TEXTURE0);r.bindTexture(r.TEXTURE_CUBE_MAP,this._glID);this._setSubImage(n,t);this._device._restoreTexture(0)};t.prototype.updateImage=function e(t){var r=this._device._gl;var n=O(this._format);r.activeTexture(r.TEXTURE0);r.bindTexture(r.TEXTURE_CUBE_MAP,this._glID);this._setImage(n,t);this._device._restoreTexture(0)};t.prototype._setSubImage=function e(t,r){var n=this._device._gl;var i=r.flipY;var a=r.premultiplyAlpha;var o=r.faceIndex;var s=r.image;if(i===undefined){n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,false)}else{n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,i)}if(a===undefined){n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,false)}else{n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,a)}if(s instanceof HTMLCanvasElement||s instanceof HTMLImageElement||s instanceof HTMLVideoElement){n.texSubImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+o,r.level,r.x,r.y,t.format,t.pixelType,s)}else{if(this._compressed){n.compressedTexSubImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+o,r.level,r.x,r.y,r.width,r.height,t.format,s)}else{n.texSubImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+o,r.level,r.x,r.y,r.width,r.height,t.format,t.pixelType,s)}}};t.prototype._setImage=function e(t,r){var n=this._device._gl;var i=r.flipY;var a=r.premultiplyAlpha;var o=r.faceIndex;var s=r.image;if(i===undefined){n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,false)}else{n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,i)}if(a===undefined){n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,false)}else{n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,a)}if(s instanceof HTMLCanvasElement||s instanceof HTMLImageElement||s instanceof HTMLVideoElement){n.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+o,r.level,t.internalFormat,t.format,t.pixelType,s)}else{if(this._compressed){n.compressedTexImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+o,r.level,t.internalFormat,r.width,r.height,0,s)}else{n.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+o,r.level,t.internalFormat,r.width,r.height,0,t.format,t.pixelType,s)}}};t.prototype._setMipmap=function e(t,r,n){var i=this;var a=O(this._format);var o={width:this._width,height:this._height,faceIndex:0,flipY:r,premultiplyAlpha:n,level:0,image:null};for(var s=0;s<t.length;++s){var l=t[s];o.level=s;o.width=i._width>>s;o.height=i._height>>s;for(var u=0;u<6;++u){o.faceIndex=u;o.image=l[u];i._setImage(a,o)}}};t.prototype._setTexInfo=function e(){var t=this._device._gl;var r=q(this._width)&&q(this._height);if(!r&&(this._wrapS!==I.WRAP_CLAMP||this._wrapT!==I.WRAP_CLAMP)){console.warn("WebGL1 doesn't support all wrap modes with NPOT textures");this._wrapS=I.WRAP_CLAMP;this._wrapT=I.WRAP_CLAMP}var n=this._hasMipmap?this._mipFilter:-1;if(!r&&n!==-1){console.warn("NPOT textures do not support mipmap filter");n=-1}t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_MIN_FILTER,D(t,this._minFilter,n));t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_MAG_FILTER,D(t,this._magFilter,-1));t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_WRAP_S,this._wrapS);t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_WRAP_T,this._wrapT);var i=this._device.ext("EXT_texture_filter_anisotropic");if(i){t.texParameteri(t.TEXTURE_CUBE_MAP,i.TEXTURE_MAX_ANISOTROPY_EXT,this._anisotropy)}};return t}(j);var K=function e(t,r,n,i){this._device=t;this._format=r;this._width=n;this._height=i;var a=t._gl;this._glID=a.createRenderbuffer();a.bindRenderbuffer(a.RENDERBUFFER,this._glID);a.renderbufferStorage(a.RENDERBUFFER,r,n,i);a.bindRenderbuffer(a.RENDERBUFFER,null)};K.prototype.destroy=function e(){if(this._glID===null){console.error("The render-buffer already destroyed");return}var t=this._device._gl;t.bindRenderbuffer(t.RENDERBUFFER,null);t.deleteRenderbuffer(this._glID);this._glID=null};var Z=function e(t,r,n,i){this._device=t;this._width=r;this._height=n;this._colors=i.colors||[];this._depth=i.depth||null;this._stencil=i.stencil||null;this._depthStencil=i.depthStencil||null;this._glID=t._gl.createFramebuffer()};Z.prototype.destroy=function e(){if(this._glID===null){console.error("The frame-buffer already destroyed");return}var t=this._device._gl;t.deleteFramebuffer(this._glID);this._glID=null};var Q={blend:false,blendSep:false,blendColor:4294967295,blendEq:I.BLEND_FUNC_ADD,blendAlphaEq:I.BLEND_FUNC_ADD,blendSrc:I.BLEND_ONE,blendDst:I.BLEND_ZERO,blendSrcAlpha:I.BLEND_ONE,blendDstAlpha:I.BLEND_ZERO,depthTest:false,depthWrite:false,depthFunc:I.DS_FUNC_LESS,stencilTest:false,stencilSep:false,stencilFuncFront:I.DS_FUNC_ALWAYS,stencilRefFront:0,stencilMaskFront:255,stencilFailOpFront:I.STENCIL_OP_KEEP,stencilZFailOpFront:I.STENCIL_OP_KEEP,stencilZPassOpFront:I.STENCIL_OP_KEEP,stencilWriteMaskFront:255,stencilFuncBack:I.DS_FUNC_ALWAYS,stencilRefBack:0,stencilMaskBack:255,stencilFailOpBack:I.STENCIL_OP_KEEP,stencilZFailOpBack:I.STENCIL_OP_KEEP,stencilZPassOpBack:I.STENCIL_OP_KEEP,stencilWriteMaskBack:255,cullMode:I.CULL_BACK,primitiveType:I.PT_TRIANGLES,maxStream:-1,vertexBuffers:[],vertexBufferOffsets:[],indexBuffer:null,maxTextureSlot:-1,textureUnits:[],program:null};var J=function e(t){this.vertexBuffers=new Array(t._caps.maxVertexStreams);this.vertexBufferOffsets=new Array(t._caps.maxVertexStreams);this.textureUnits=new Array(t._caps.maxTextureUnits);this.set(Q)};J.initDefault=function e(t){Q.vertexBuffers=new Array(t._caps.maxVertexStreams);Q.vertexBufferOffsets=new Array(t._caps.maxVertexStreams);Q.textureUnits=new Array(t._caps.maxTextureUnits)};J.prototype.reset=function e(){this.set(Q)};J.prototype.set=function e(t){var r=this;this.blend=t.blend;this.blendSep=t.blendSep;this.blendColor=t.blendColor;this.blendEq=t.blendEq;this.blendAlphaEq=t.blendAlphaEq;this.blendSrc=t.blendSrc;this.blendDst=t.blendDst;this.blendSrcAlpha=t.blendSrcAlpha;this.blendDstAlpha=t.blendDstAlpha;this.depthTest=t.depthTest;this.depthWrite=t.depthWrite;this.depthFunc=t.depthFunc;this.stencilTest=t.stencilTest;this.stencilSep=t.stencilSep;this.stencilFuncFront=t.stencilFuncFront;this.stencilRefFront=t.stencilRefFront;this.stencilMaskFront=t.stencilMaskFront;this.stencilFailOpFront=t.stencilFailOpFront;this.stencilZFailOpFront=t.stencilZFailOpFront;this.stencilZPassOpFront=t.stencilZPassOpFront;this.stencilWriteMaskFront=t.stencilWriteMaskFront;this.stencilFuncBack=t.stencilFuncBack;this.stencilRefBack=t.stencilRefBack;this.stencilMaskBack=t.stencilMaskBack;this.stencilFailOpBack=t.stencilFailOpBack;this.stencilZFailOpBack=t.stencilZFailOpBack;this.stencilZPassOpBack=t.stencilZPassOpBack;this.stencilWriteMaskBack=t.stencilWriteMaskBack;this.cullMode=t.cullMode;this.primitiveType=t.primitiveType;this.maxStream=t.maxStream;for(var n=0;n<t.vertexBuffers.length;++n){r.vertexBuffers[n]=t.vertexBuffers[n]}for(var i=0;i<t.vertexBufferOffsets.length;++i){r.vertexBufferOffsets[i]=t.vertexBufferOffsets[i]}this.indexBuffer=t.indexBuffer;this.maxTextureSlot=t.maxTextureSlot;for(var a=0;a<t.textureUnits.length;++a){r.textureUnits[a]=t.textureUnits[a]}this.program=t.program};var $=5124;var ee=5126;var te=35664;var re=35665;var ne=35666;var ie=35667;var ae=35668;var oe=35669;var se=35670;var le=35671;var ue=35672;var he=35673;var ce=35674;var fe=35675;var pe=35676;var de=35678;var ve=35680;var me={};me[$]=function(e,t,r){e.uniform1i(t,r)};me[ee]=function(e,t,r){e.uniform1f(t,r)};me[te]=function(e,t,r){e.uniform2fv(t,r)};me[re]=function(e,t,r){e.uniform3fv(t,r)};me[ne]=function(e,t,r){e.uniform4fv(t,r)};me[ie]=function(e,t,r){e.uniform2iv(t,r)};me[ae]=function(e,t,r){e.uniform3iv(t,r)};me[oe]=function(e,t,r){e.uniform4iv(t,r)};me[se]=function(e,t,r){e.uniform1i(t,r)};me[le]=function(e,t,r){e.uniform2iv(t,r)};me[ue]=function(e,t,r){e.uniform3iv(t,r)};me[he]=function(e,t,r){e.uniform4iv(t,r)};me[ce]=function(e,t,r){e.uniformMatrix2fv(t,false,r)};me[fe]=function(e,t,r){e.uniformMatrix3fv(t,false,r)};me[pe]=function(e,t,r){e.uniformMatrix4fv(t,false,r)};me[de]=function(e,t,r){e.uniform1i(t,r)};me[ve]=function(e,t,r){e.uniform1i(t,r)};var _e={};_e[$]=function(e,t,r){e.uniform1iv(t,r)};_e[ee]=function(e,t,r){e.uniform1fv(t,r)};_e[te]=function(e,t,r){e.uniform2fv(t,r)};_e[re]=function(e,t,r){e.uniform3fv(t,r)};_e[ne]=function(e,t,r){e.uniform4fv(t,r)};_e[ie]=function(e,t,r){e.uniform2iv(t,r)};_e[ae]=function(e,t,r){e.uniform3iv(t,r)};_e[oe]=function(e,t,r){e.uniform4iv(t,r)};_e[se]=function(e,t,r){e.uniform1iv(t,r)};_e[le]=function(e,t,r){e.uniform2iv(t,r)};_e[ue]=function(e,t,r){e.uniform3iv(t,r)};_e[he]=function(e,t,r){e.uniform4iv(t,r)};_e[ce]=function(e,t,r){e.uniformMatrix2fv(t,false,r)};_e[fe]=function(e,t,r){e.uniformMatrix3fv(t,false,r)};_e[pe]=function(e,t,r){e.uniformMatrix4fv(t,false,r)};_e[de]=function(e,t,r){e.uniform1iv(t,r)};_e[ve]=function(e,t,r){e.uniform1iv(t,r)};function ge(e,t,r){if(t.blend!==r.blend){if(!r.blend){e.disable(e.BLEND);return}e.enable(e.BLEND);if(r.blendSrc===I.BLEND_CONSTANT_COLOR||r.blendSrc===I.BLEND_ONE_MINUS_CONSTANT_COLOR||r.blendDst===I.BLEND_CONSTANT_COLOR||r.blendDst===I.BLEND_ONE_MINUS_CONSTANT_COLOR){e.blendColor((r.blendColor>>24)/255,(r.blendColor>>16&255)/255,(r.blendColor>>8&255)/255,(r.blendColor&255)/255)}if(r.blendSep){e.blendFuncSeparate(r.blendSrc,r.blendDst,r.blendSrcAlpha,r.blendDstAlpha);e.blendEquationSeparate(r.blendEq,r.blendAlphaEq)}else{e.blendFunc(r.blendSrc,r.blendDst);e.blendEquation(r.blendEq)}return}if(r.blend===false){return}if(t.blendColor!==r.blendColor){e.blendColor((r.blendColor>>24)/255,(r.blendColor>>16&255)/255,(r.blendColor>>8&255)/255,(r.blendColor&255)/255)}if(t.blendSep!==r.blendSep){if(r.blendSep){e.blendFuncSeparate(r.blendSrc,r.blendDst,r.blendSrcAlpha,r.blendDstAlpha);e.blendEquationSeparate(r.blendEq,r.blendAlphaEq)}else{e.blendFunc(r.blendSrc,r.blendDst);e.blendEquation(r.blendEq)}return}if(r.blendSep){if(t.blendSrc!==r.blendSrc||t.blendDst!==r.blendDst||t.blendSrcAlpha!==r.blendSrcAlpha||t.blendDstAlpha!==r.blendDstAlpha){e.blendFuncSeparate(r.blendSrc,r.blendDst,r.blendSrcAlpha,r.blendDstAlpha)}if(t.blendEq!==r.blendEq||t.blendAlphaEq!==r.blendAlphaEq){e.blendEquationSeparate(r.blendEq,r.blendAlphaEq)}}else{if(t.blendSrc!==r.blendSrc||t.blendDst!==r.blendDst){e.blendFunc(r.blendSrc,r.blendDst)}if(t.blendEq!==r.blendEq){e.blendEquation(r.blendEq)}}}function ye(e,t,r){if(t.depthTest!==r.depthTest){if(!r.depthTest){e.disable(e.DEPTH_TEST);return}e.enable(e.DEPTH_TEST);e.depthFunc(r.depthFunc);e.depthMask(r.depthWrite);return}if(t.depthWrite!==r.depthWrite){e.depthMask(r.depthWrite)}if(r.depthTest===false){if(r.depthWrite){r.depthTest=true;r.depthFunc=I.DS_FUNC_ALWAYS;e.enable(e.DEPTH_TEST);e.depthFunc(r.depthFunc)}return}if(t.depthFunc!==r.depthFunc){e.depthFunc(r.depthFunc)}}function xe(e,t,r){if(r.stencilTest!==t.stencilTest){if(!r.stencilTest){e.disable(e.STENCIL_TEST);return}e.enable(e.STENCIL_TEST);if(r.stencilSep){e.stencilFuncSeparate(e.FRONT,r.stencilFuncFront,r.stencilRefFront,r.stencilMaskFront);e.stencilMaskSeparate(e.FRONT,r.stencilWriteMaskFront);e.stencilOpSeparate(e.FRONT,r.stencilFailOpFront,r.stencilZFailOpFront,r.stencilZPassOpFront);e.stencilFuncSeparate(e.BACK,r.stencilFuncBack,r.stencilRefBack,r.stencilMaskBack);e.stencilMaskSeparate(e.BACK,r.stencilWriteMaskBack);e.stencilOpSeparate(e.BACK,r.stencilFailOpBack,r.stencilZFailOpBack,r.stencilZPassOpBack)}else{e.stencilFunc(r.stencilFuncFront,r.stencilRefFront,r.stencilMaskFront);e.stencilMask(r.stencilWriteMaskFront);e.stencilOp(r.stencilFailOpFront,r.stencilZFailOpFront,r.stencilZPassOpFront)}return}if(!r.stencilTest){return}if(t.stencilSep!==r.stencilSep){if(r.stencilSep){e.stencilFuncSeparate(e.FRONT,r.stencilFuncFront,r.stencilRefFront,r.stencilMaskFront);e.stencilMaskSeparate(e.FRONT,r.stencilWriteMaskFront);e.stencilOpSeparate(e.FRONT,r.stencilFailOpFront,r.stencilZFailOpFront,r.stencilZPassOpFront);e.stencilFuncSeparate(e.BACK,r.stencilFuncBack,r.stencilRefBack,r.stencilMaskBack);e.stencilMaskSeparate(e.BACK,r.stencilWriteMaskBack);e.stencilOpSeparate(e.BACK,r.stencilFailOpBack,r.stencilZFailOpBack,r.stencilZPassOpBack)}else{e.stencilFunc(r.stencilFuncFront,r.stencilRefFront,r.stencilMaskFront);e.stencilMask(r.stencilWriteMaskFront);e.stencilOp(r.stencilFailOpFront,r.stencilZFailOpFront,r.stencilZPassOpFront)}return}if(r.stencilSep){if(t.stencilFuncFront!==r.stencilFuncFront||t.stencilRefFront!==r.stencilRefFront||t.stencilMaskFront!==r.stencilMaskFront){e.stencilFuncSeparate(e.FRONT,r.stencilFuncFront,r.stencilRefFront,r.stencilMaskFront)}if(t.stencilWriteMaskFront!==r.stencilWriteMaskFront){e.stencilMaskSeparate(e.FRONT,r.stencilWriteMaskFront)}if(t.stencilFailOpFront!==r.stencilFailOpFront||t.stencilZFailOpFront!==r.stencilZFailOpFront||t.stencilZPassOpFront!==r.stencilZPassOpFront){e.stencilOpSeparate(e.FRONT,r.stencilFailOpFront,r.stencilZFailOpFront,r.stencilZPassOpFront)}if(t.stencilFuncBack!==r.stencilFuncBack||t.stencilRefBack!==r.stencilRefBack||t.stencilMaskBack!==r.stencilMaskBack){e.stencilFuncSeparate(e.BACK,r.stencilFuncBack,r.stencilRefBack,r.stencilMaskBack)}if(t.stencilWriteMaskBack!==r.stencilWriteMaskBack){e.stencilMaskSeparate(e.BACK,r.stencilWriteMaskBack)}if(t.stencilFailOpBack!==r.stencilFailOpBack||t.stencilZFailOpBack!==r.stencilZFailOpBack||t.stencilZPassOpBack!==r.stencilZPassOpBack){e.stencilOpSeparate(e.BACK,r.stencilFailOpBack,r.stencilZFailOpBack,r.stencilZPassOpBack)}}else{if(t.stencilFuncFront!==r.stencilFuncFront||t.stencilRefFront!==r.stencilRefFront||t.stencilMaskFront!==r.stencilMaskFront){e.stencilFunc(r.stencilFuncFront,r.stencilRefFront,r.stencilMaskFront)}if(t.stencilWriteMaskFront!==r.stencilWriteMaskFront){e.stencilMask(r.stencilWriteMaskFront)}if(t.stencilFailOpFront!==r.stencilFailOpFront||t.stencilZFailOpFront!==r.stencilZFailOpFront||t.stencilZPassOpFront!==r.stencilZPassOpFront){e.stencilOp(r.stencilFailOpFront,r.stencilZFailOpFront,r.stencilZPassOpFront)}}}function be(e,t,r){if(t.cullMode===r.cullMode){return}if(r.cullMode===I.CULL_NONE){e.disable(e.CULL_FACE);return}e.enable(e.CULL_FACE);e.cullFace(r.cullMode)}function we(e,t,r,n){var i=false;if(n.maxStream===-1){console.warn("VertexBuffer not assigned, please call setVertexBuffer before every draw.");return}if(r.maxStream!==n.maxStream){i=true}else if(r.program!==n.program){i=true}else{for(var a=0;a<n.maxStream+1;++a){if(r.vertexBuffers[a]!==n.vertexBuffers[a]||r.vertexBufferOffsets[a]!==n.vertexBufferOffsets[a]){i=true;break}}}if(i){for(var o=0;o<e._caps.maxVertexAttribs;++o){e._newAttributes[o]=0}for(var s=0;s<n.maxStream+1;++s){var l=n.vertexBuffers[s];var u=n.vertexBufferOffsets[s];if(!l){continue}t.bindBuffer(t.ARRAY_BUFFER,l._glID);for(var h=0;h<n.program._attributes.length;++h){var c=n.program._attributes[h];var f=l._format.element(c.name);if(!f){console.warn("Can not find vertex attribute: "+c.name);continue}if(e._enabledAttributes[c.location]===0){t.enableVertexAttribArray(c.location);e._enabledAttributes[c.location]=1}e._newAttributes[c.location]=1;t.vertexAttribPointer(c.location,f.num,f.type,f.normalize,f.stride,f.offset+u*f.stride)}}for(var p=0;p<e._caps.maxVertexAttribs;++p){if(e._enabledAttributes[p]!==e._newAttributes[p]){t.disableVertexAttribArray(p);e._enabledAttributes[p]=0}}}}function Te(e,t,r){for(var n=0;n<r.maxTextureSlot+1;++n){if(t.textureUnits[n]!==r.textureUnits[n]){var i=r.textureUnits[n];if(i!==undefined&&i._glID!==-1){e.activeTexture(e.TEXTURE0+n);e.bindTexture(i._target,i._glID)}}}}function Ee(e,t,r,n){if(n===void 0)n=0;if(r instanceof X){e.framebufferTexture2D(e.FRAMEBUFFER,t,e.TEXTURE_2D,r._glID,0)}else if(r instanceof Y){e.framebufferTexture2D(e.FRAMEBUFFER,t,e.TEXTURE_CUBE_MAP_POSITIVE_X+n,r._glID,0)}else{e.framebufferRenderbuffer(e.FRAMEBUFFER,t,e.RENDERBUFFER,r._glID)}}var Se=function e(t,r){var n=this;var i;r=r||{};if(r.alpha===undefined){r.alpha=false}if(r.stencil===undefined){r.stencil=true}if(r.depth===undefined){r.depth=true}if(r.antialias===undefined){r.antialias=false}if(r.preserveDrawingBuffer===undefined){r.preserveDrawingBuffer=false}try{i=t.getContext("webgl",r)}catch(e){console.error(e);return}this._gl=i;this._extensions={};this._caps={};this._stats={texture:0,vb:0,ib:0,drawcalls:0};this._initExtensions(["EXT_texture_filter_anisotropic","EXT_shader_texture_lod","OES_standard_derivatives","OES_texture_float","OES_texture_float_linear","OES_texture_half_float","OES_texture_half_float_linear","OES_vertex_array_object","WEBGL_compressed_texture_atc","WEBGL_compressed_texture_etc1","WEBGL_compressed_texture_pvrtc","WEBGL_compressed_texture_s3tc","WEBGL_depth_texture","WEBGL_draw_buffers"]);this._initCaps();this._initStates();J.initDefault(this);this._current=new J(this);this._next=new J(this);this._uniforms={};this._vx=this._vy=this._vw=this._vh=0;this._sx=this._sy=this._sw=this._sh=0;this._framebuffer=null;this._enabledAttributes=new Array(this._caps.maxVertexAttribs);this._newAttributes=new Array(this._caps.maxVertexAttribs);for(var a=0;a<this._caps.maxVertexAttribs;++a){n._enabledAttributes[a]=0;n._newAttributes[a]=0}};Se.prototype._initExtensions=function e(t){var r=this;var n=this._gl;for(var i=0;i<t.length;++i){var a=t[i];try{var o=n.getExtension(a);if(o){r._extensions[a]=o}}catch(e){console.error(e)}}};Se.prototype._initCaps=function e(){var t=this._gl;var r=this.ext("WEBGL_draw_buffers");this._caps.maxVertexStreams=4;this._caps.maxVertexTextures=t.getParameter(t.MAX_VERTEX_TEXTURE_IMAGE_UNITS);this._caps.maxFragUniforms=t.getParameter(t.MAX_FRAGMENT_UNIFORM_VECTORS);this._caps.maxTextureUnits=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS);this._caps.maxVertexAttribs=t.getParameter(t.MAX_VERTEX_ATTRIBS);this._caps.maxDrawBuffers=r?t.getParameter(r.MAX_DRAW_BUFFERS_WEBGL):1;this._caps.maxColorAttachments=r?t.getParameter(r.MAX_COLOR_ATTACHMENTS_WEBGL):1};Se.prototype._initStates=function e(){var t=this._gl;t.disable(t.BLEND);t.blendFunc(t.ONE,t.ZERO);t.blendEquation(t.FUNC_ADD);t.blendColor(1,1,1,1);t.colorMask(true,true,true,true);t.enable(t.CULL_FACE);t.cullFace(t.BACK);t.disable(t.DEPTH_TEST);t.depthFunc(t.LESS);t.depthMask(false);t.disable(t.POLYGON_OFFSET_FILL);t.depthRange(0,1);t.disable(t.STENCIL_TEST);t.stencilFunc(t.ALWAYS,0,255);t.stencilMask(255);t.stencilOp(t.KEEP,t.KEEP,t.KEEP);t.clearDepth(1);t.clearColor(0,0,0,0);t.clearStencil(0);t.disable(t.SCISSOR_TEST)};Se.prototype._restoreTexture=function e(t){var r=this._gl;var n=this._current.textureUnits[t];if(n&&n._glID!==-1){r.bindTexture(n._target,n._glID)}else{r.bindTexture(r.TEXTURE_2D,null)}};Se.prototype._restoreIndexBuffer=function e(){var t=this._gl;var r=this._current.indexBuffer;t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,r?r._glID:null)};Se.prototype.ext=function e(t){return this._extensions[t]};Se.prototype.setFrameBuffer=function e(t){var r=this;if(this._framebuffer===t){return}this._framebuffer=t;var n=this._gl;if(t===null){n.bindFramebuffer(n.FRAMEBUFFER,null);return}n.bindFramebuffer(n.FRAMEBUFFER,t._glID);var i=this._framebuffer._colors.length;for(var a=0;a<i;++a){var o=r._framebuffer._colors[a];Ee(n,n.COLOR_ATTACHMENT0+a,o)}for(var s=i;s<this._caps.maxColorAttachments;++s){n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0+s,n.TEXTURE_2D,null,0)}if(this._framebuffer._depth){Ee(n,n.DEPTH_ATTACHMENT,this._framebuffer._depth)}if(this._framebuffer._stencil){Ee(n,n.STENCIL_ATTACHMENT,t._stencil)}if(this._framebuffer._depthStencil){Ee(n,n.DEPTH_STENCIL_ATTACHMENT,t._depthStencil)}};Se.prototype.setViewport=function e(t,r,n,i){if(this._vx!==t||this._vy!==r||this._vw!==n||this._vh!==i){this._gl.viewport(t,r,n,i);this._vx=t;this._vy=r;this._vw=n;this._vh=i}};Se.prototype.setScissor=function e(t,r,n,i){if(this._sx!==t||this._sy!==r||this._sw!==n||this._sh!==i){this._gl.scissor(t,r,n,i);this._sx=t;this._sy=r;this._sw=n;this._sh=i}};Se.prototype.clear=function e(t){var r=this._gl;var n=0;if(t.color!==undefined){n|=r.COLOR_BUFFER_BIT;r.clearColor(t.color[0],t.color[1],t.color[2],t.color[3])}if(t.depth!==undefined){n|=r.DEPTH_BUFFER_BIT;r.clearDepth(t.depth);r.enable(r.DEPTH_TEST);r.depthMask(true);r.depthFunc(r.ALWAYS)}if(t.stencil!==undefined){n|=r.STENCIL_BUFFER_BIT;r.clearStencil(t.stencil)}r.clear(n);if(t.depth!==undefined){if(this._current.depthTest===false){r.disable(r.DEPTH_TEST)}else{if(this._current.depthWrite===false){r.depthMask(false)}if(this._current.depthFunc!==I.DS_FUNC_ALWAYS){r.depthFunc(this._current.depthFunc)}}}};Se.prototype.enableBlend=function e(){this._next.blend=true};Se.prototype.enableDepthTest=function e(){this._next.depthTest=true};Se.prototype.enableDepthWrite=function e(){this._next.depthWrite=true};Se.prototype.enableStencilTest=function e(){this._next.stencilTest=true};Se.prototype.setStencilFunc=function e(t,r,n){this._next.stencilSep=false;this._next.stencilFuncFront=this._next.stencilFuncBack=t;this._next.stencilRefFront=this._next.stencilRefBack=r;this._next.stencilMaskFront=this._next.stencilMaskBack=n};Se.prototype.setStencilFuncFront=function e(t,r,n){this._next.stencilSep=true;this._next.stencilFuncFront=t;this._next.stencilRefFront=r;this._next.stencilMaskFront=n};Se.prototype.setStencilFuncBack=function e(t,r,n){this._next.stencilSep=true;this._next.stencilFuncBack=t;this._next.stencilRefBack=r;this._next.stencilMaskBack=n};Se.prototype.setStencilOp=function e(t,r,n,i){this._next.stencilFailOpFront=this._next.stencilFailOpBack=t;this._next.stencilZFailOpFront=this._next.stencilZFailOpBack=r;this._next.stencilZPassOpFront=this._next.stencilZPassOpBack=n;this._next.stencilWriteMaskFront=this._next.stencilWriteMaskBack=i};Se.prototype.setStencilOpFront=function e(t,r,n,i){this._next.stencilSep=true;this._next.stencilFailOpFront=t;this._next.stencilZFailOpFront=r;this._next.stencilZPassOpFront=n;this._next.stencilWriteMaskFront=i};Se.prototype.setStencilOpBack=function e(t,r,n,i){this._next.stencilSep=true;this._next.stencilFailOpBack=t;this._next.stencilZFailOpBack=r;this._next.stencilZPassOpBack=n;this._next.stencilWriteMaskBack=i};Se.prototype.setDepthFunc=function e(t){this._next.depthFunc=t};Se.prototype.setBlendColor32=function e(t){this._next.blendColor=t};Se.prototype.setBlendColor=function e(t,r,n,i){this._next.blendColor=(t*255<<24|r*255<<16|n*255<<8|i*255)>>>0};Se.prototype.setBlendFunc=function e(t,r){this._next.blendSep=false;this._next.blendSrc=t;this._next.blendDst=r};Se.prototype.setBlendFuncSep=function e(t,r,n,i){this._next.blendSep=true;this._next.blendSrc=t;this._next.blendDst=r;this._next.blendSrcAlpha=n;this._next.blendDstAlpha=i};Se.prototype.setBlendEq=function e(t){this._next.blendSep=false;this._next.blendEq=t};Se.prototype.setBlendEqSep=function e(t,r){this._next.blendSep=true;this._next.blendEq=t;this._next.blendAlphaEq=r};Se.prototype.setCullMode=function e(t){this._next.cullMode=t};Se.prototype.setVertexBuffer=function e(t,r,n){if(n===void 0)n=0;this._next.vertexBuffers[t]=r;this._next.vertexBufferOffsets[t]=n;if(this._next.maxStream<t){this._next.maxStream=t}};Se.prototype.setIndexBuffer=function e(t){this._next.indexBuffer=t};Se.prototype.setProgram=function e(t){this._next.program=t};Se.prototype.setTexture=function e(t,r,n){if(n>=this._caps.maxTextureUnits){console.warn("Can not set texture "+t+" at stage "+n+", max texture exceed: "+this._caps.maxTextureUnits);return}this._next.textureUnits[n]=r;this.setUniform(t,n);if(this._next.maxTextureSlot<n){this._next.maxTextureSlot=n}};Se.prototype.setTextureArray=function e(t,r,n){var i=this;var a=r.length;if(a>=this._caps.maxTextureUnits){console.warn("Can not set "+a+" textures for "+t+", max texture exceed: "+this._caps.maxTextureUnits);return}for(var o=0;o<a;++o){var s=n[o];i._next.textureUnits[s]=r[o]}this.setUniform(t,n)};Se.prototype.setUniform=function e(t,r){var n=this._uniforms[t];if(!n){n={dirty:true,value:r}}else{n.dirty=true;n.value=r}this._uniforms[t]=n};Se.prototype.setPrimitiveType=function e(t){this._next.primitiveType=t};Se.prototype.draw=function e(t,r){var n=this;var i=this._gl;var a=this._current;var o=this._next;ge(i,a,o);ye(i,a,o);xe(i,a,o);be(i,a,o);we(this,i,a,o);if(a.indexBuffer!==o.indexBuffer){i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,o.indexBuffer?o.indexBuffer._glID:null)}var s=false;if(a.program!==o.program){if(o.program._linked){i.useProgram(o.program._glID)}else{console.warn("Failed to use program: has not linked yet.")}s=true}Te(i,a,o);for(var l=0;l<o.program._uniforms.length;++l){var u=o.program._uniforms[l];var h=n._uniforms[u.name];if(!h){continue}if(!s&&!h.dirty){continue}h.dirty=false;var c=u.size===undefined?me[u.type]:_e[u.type];if(!c){console.warn("Can not find commit function for uniform "+u.name);continue}c(i,u.location,h.value)}if(o.indexBuffer){i.drawElements(this._next.primitiveType,r,o.indexBuffer._format,t*o.indexBuffer._bytesPerIndex)}else{i.drawArrays(this._next.primitiveType,t,r)}this._stats.drawcalls+=1;a.set(o);o.reset()};var Me={VertexFormat:B,IndexBuffer:P,VertexBuffer:z,Program:G,Texture:j,Texture2D:X,TextureCube:Y,RenderBuffer:K,FrameBuffer:Z,Device:Se,attrTypeBytes:U,glFilter:D,glTextureFmt:O};Object.assign(Me,I);var Ae={PROJ_PERSPECTIVE:0,PROJ_ORTHO:1,LIGHT_DIRECTIONAL:0,LIGHT_POINT:1,LIGHT_SPOT:2,SHADOW_NONE:0,SHADOW_HARD:1,SHADOW_SOFT:2,PARAM_INT:0,PARAM_INT2:1,PARAM_INT3:2,PARAM_INT4:3,PARAM_FLOAT:4,PARAM_FLOAT2:5,PARAM_FLOAT3:6,PARAM_FLOAT4:7,PARAM_COLOR3:8,PARAM_COLOR4:9,PARAM_MAT2:10,PARAM_MAT3:11,PARAM_MAT4:12,PARAM_TEXTURE_2D:13,PARAM_TEXTURE_CUBE:14,CLEAR_COLOR:1,CLEAR_DEPTH:2,CLEAR_STENCIL:4,CLEAR_SKYBOX:8,BUFFER_VIEW_INT8:0,BUFFER_VIEW_UINT8:1,BUFFER_VIEW_INT16:2,BUFFER_VIEW_UINT16:3,BUFFER_VIEW_INT32:4,BUFFER_VIEW_UINT32:5,BUFFER_VIEW_FLOAT32:6};var Re=function e(t,r,n){if(n===void 0)n=Me.PT_TRIANGLES;this._vertexBuffer=t;this._indexBuffer=r;this._primitiveType=n;this._start=0;this._count=-1};var Le={count:{configurable:true}};Le.count.get=function(){if(this._count!==-1){return this._count}if(this._indexBuffer){return this._indexBuffer.count}return this._vertexBuffer.count};Object.defineProperties(Re.prototype,Le);var Ce=function e(t){this._programName=t;this._cullMode=Me.CULL_BACK;this._blend=false;this._blendEq=Me.BLEND_FUNC_ADD;this._blendAlphaEq=Me.BLEND_FUNC_ADD;this._blendSrc=Me.BLEND_ONE;this._blendDst=Me.BLEND_ZERO;this._blendSrcAlpha=Me.BLEND_ONE;this._blendDstAlpha=Me.BLEND_ZERO;this._blendColor=4294967295;this._depthTest=false;this._depthWrite=false;this._depthFunc=Me.DS_FUNC_LESS,this._stencilTest=false;this._stencilFuncFront=Me.DS_FUNC_ALWAYS;this._stencilRefFront=0;this._stencilMaskFront=255;this._stencilFailOpFront=Me.STENCIL_OP_KEEP;this._stencilZFailOpFront=Me.STENCIL_OP_KEEP;this._stencilZPassOpFront=Me.STENCIL_OP_KEEP;this._stencilWriteMaskFront=255;this._stencilFuncBack=Me.DS_FUNC_ALWAYS;this._stencilRefBack=0;this._stencilMaskBack=255;this._stencilFailOpBack=Me.STENCIL_OP_KEEP;this._stencilZFailOpBack=Me.STENCIL_OP_KEEP;this._stencilZPassOpBack=Me.STENCIL_OP_KEEP;this._stencilWriteMaskBack=255};Ce.prototype.setCullMode=function e(t){this._cullMode=t};Ce.prototype.setBlend=function e(t,r,n,i,a,o,s){if(t===void 0)t=Me.BLEND_FUNC_ADD;if(r===void 0)r=Me.BLEND_ONE;if(n===void 0)n=Me.BLEND_ZERO;if(i===void 0)i=Me.BLEND_FUNC_ADD;if(a===void 0)a=Me.BLEND_ONE;if(o===void 0)o=Me.BLEND_ZERO;if(s===void 0)s=4294967295;this._blend=true;this._blendEq=t;this._blendSrc=r;this._blendDst=n;this._blendAlphaEq=i;this._blendSrcAlpha=a;this._blendDstAlpha=o;this._blendColor=s};Ce.prototype.setDepth=function e(t,r,n){if(t===void 0)t=false;if(r===void 0)r=false;if(n===void 0)n=Me.DS_FUNC_LESS;this._depthTest=t;this._depthWrite=r;this._depthFunc=n};Ce.prototype.setStencilFront=function e(t,r,n,i,a,o,s,l){if(t===void 0)t=false;if(r===void 0)r=Me.DS_FUNC_ALWAYS;if(n===void 0)n=0;if(i===void 0)i=255;if(a===void 0)a=Me.STENCIL_OP_KEEP;if(o===void 0)o=Me.STENCIL_OP_KEEP;if(s===void 0)s=Me.STENCIL_OP_KEEP;if(l===void 0)l=255;this._stencilTest=t;this._stencilFuncFront=r;this._stencilRefFront=n;this._stencilMaskFront=i;this._stencilFailOpFront=a;this._stencilZFailOpFront=o;this._stencilZPassOpFront=s;this._stencilWriteMaskFront=l};Ce.prototype.setStencilBack=function e(t,r,n,i,a,o,s,l){if(t===void 0)t=false;if(r===void 0)r=Me.DS_FUNC_ALWAYS;if(n===void 0)n=0;if(i===void 0)i=255;if(a===void 0)a=Me.STENCIL_OP_KEEP;if(o===void 0)o=Me.STENCIL_OP_KEEP;if(s===void 0)s=Me.STENCIL_OP_KEEP;if(l===void 0)l=255;this._stencilTest=t;this._stencilFuncBack=r;this._stencilRefBack=n;this._stencilMaskBack=i;this._stencilFailOpBack=a;this._stencilZFailOpBack=o;this._stencilZPassOpBack=s;this._stencilWriteMaskBack=l};var Ie=0;var Ue={};var De={addStage:function(e){if(Ue[e]!==undefined){return}var t=1<<Ie;Ue[e]=t;Ie+=1},stageID:function(e){var t=Ue[e];if(t===undefined){return-1}return t},stageIDs:function(e){var t=0;for(var r=0;r<e.length;++r){var n=Ue[e[r]];if(n!==undefined){t|=n}}return t}};var Oe=0;var Be=function e(t,r,n,i){if(i===void 0)i=0;this._id=Oe++;this._stageIDs=De.stageIDs(t);this._parameters=r;this._passes=n;this._layer=i};var Pe={passes:{configurable:true},stageIDs:{configurable:true}};Be.prototype.setStages=function e(t){this._stageIDs=De.stageIDs(t)};Pe.passes.get=function(){return this._passes};Pe.stageIDs.get=function(){return this._stageIDs};Object.defineProperties(Be.prototype,Pe);var Fe=function e(t,r,n,i){if(r===void 0)r={};if(n===void 0)n=[];if(i===void 0)i=[];this._techniques=t;this._properties=r;this._defines=n;this._dependencies=i};Fe.prototype.clear=function e(){this._techniques.length=0;this._properties=null;this._defines.length=0};Fe.prototype.getTechnique=function e(t){var r=this;var n=De.stageID(t);if(n===-1){return null}for(var i=0;i<this._techniques.length;++i){var a=r._techniques[i];if(a.stageIDs&n){return a}}return null};Fe.prototype.getProperty=function e(t){return this._properties[t]};Fe.prototype.setProperty=function e(t,r){this._properties[t]=r};Fe.prototype.getDefine=function e(t){var r=this;for(var n=0;n<this._defines.length;++n){var i=r._defines[n];if(i.name===t){return i.value}}console.warn("Failed to get define "+t+", define not found.");return null};Fe.prototype.define=function e(t,r){var n=this;for(var i=0;i<this._defines.length;++i){var a=n._defines[i];if(a.name===t){a.value=r;return}}console.warn("Failed to set define "+t+", define not found.")};Fe.prototype.extractDefines=function e(t){var r=this;if(t===void 0)t={};for(var n=0;n<this._defines.length;++n){var i=r._defines[n];t[i.name]=i.value}return t};Fe.prototype.extractDependencies=function e(t){var r=this;if(t===void 0)t={};for(var n=0;n<this._dependencies.length;++n){var i=r._dependencies[n];t[i.define]=i.extension}return t};function ze(e,t){if(!t.positions){console.error("The data must have positions field");return null}var r=[];var n=t.positions.length/3;for(var i=0;i<n;++i){r.push(t.positions[3*i],t.positions[3*i+1],t.positions[3*i+2]);if(t.normals){r.push(t.normals[3*i],t.normals[3*i+1],t.normals[3*i+2])}if(t.uvs){r.push(t.uvs[2*i],t.uvs[2*i+1])}}var a=[];a.push({name:Me.ATTR_POSITION,type:Me.ATTR_TYPE_FLOAT32,num:3});if(t.normals){a.push({name:Me.ATTR_NORMAL,type:Me.ATTR_TYPE_FLOAT32,num:3})}if(t.uvs){a.push({name:Me.ATTR_UV0,type:Me.ATTR_TYPE_FLOAT32,num:2})}var o=new Me.VertexBuffer(e,new Me.VertexFormat(a),Me.USAGE_STATIC,new Float32Array(r),n);var s=null;if(t.indices){s=new Me.IndexBuffer(e,Me.INDEX_FMT_UINT16,Me.USAGE_STATIC,new Uint16Array(t.indices),t.indices.length)}return new Re(o,s)}var Ne=Math.PI/180;var ke=180/Math.PI;var Ve=1e-6;function Ge(e,t){return Math.abs(e-t)<=Ve*Math.max(1,Math.abs(e),Math.abs(t))}function We(e,t,r){r=r||Ve;return Math.abs(e-t)<=r}function He(e,t,r){return e<t?t:e>r?r:e}function je(e){return e<0?0:e>1?1:e}function qe(e,t,r){return e+(t-e)*r}function Xe(e){return e*Ne}function Ye(e){return e*ke}var Ke=Math.random;function Ze(e,t){return Math.random()*(t-e)+e}function Qe(e,t){return Math.floor(Ze(e,t))}function Je(e){e=(e*9301+49297)%233280;return e/233280}function $e(e,t,r){return Je(e)*(r-t)+t}function et(e,t,r){return Math.floor($e(e,t,r))}function tt(e){--e;e=e>>1|e;e=e>>2|e;e=e>>4|e;e=e>>8|e;e=e>>16|e;++e;return e}function rt(e,t){return e-Math.floor(e/t)*t}function nt(e,t){e=rt(e,t*2);e=t-Math.abs(e-t);return e}function it(e,t,r){return(r-e)/(t-e)}var at=32;var ot=2147483647;var st=-1<<at-1;function lt(e){return(e>0)-(e<0)}function ut(e){var t=e>>at-1;return(e^t)-t}function ht(e,t){return t^(e^t)&-(e<t)}function ct(e,t){return e^(e^t)&-(e<t)}function ft(e){return!(e&e-1)&&!!e}function pt(e){var t,r;t=(e>65535)<<4;e>>>=t;r=(e>255)<<3;e>>>=r;t|=r;r=(e>15)<<2;e>>>=r;t|=r;r=(e>3)<<1;e>>>=r;t|=r;return t|e>>1}function dt(e){return e>=1e9?9:e>=1e8?8:e>=1e7?7:e>=1e6?6:e>=1e5?5:e>=1e4?4:e>=1e3?3:e>=100?2:e>=10?1:0}function vt(e){e=e-(e>>>1&1431655765);e=(e&858993459)+(e>>>2&858993459);return(e+(e>>>4)&252645135)*16843009>>>24}function mt(e){var t=32;e&=-e;if(e){t--}if(e&65535){t-=16}if(e&16711935){t-=8}if(e&252645135){t-=4}if(e&858993459){t-=2}if(e&1431655765){t-=1}return t}function _t(e){e+=e===0;--e;e|=e>>>1;e|=e>>>2;e|=e>>>4;e|=e>>>8;e|=e>>>16;return e+1}function gt(e){e|=e>>>1;e|=e>>>2;e|=e>>>4;e|=e>>>8;e|=e>>>16;return e-(e>>>1)}function yt(e){e^=e>>>16;e^=e>>>8;e^=e>>>4;e&=15;return 27030>>>e&1}var xt=new Array(256);(function(e){for(var t=0;t<256;++t){var r=t,n=t,i=7;for(r>>>=1;r;r>>>=1){n<<=1;n|=r&1;--i}e[t]=n<<i&255}})(xt);function bt(e){return xt[e&255]<<24|xt[e>>>8&255]<<16|xt[e>>>16&255]<<8|xt[e>>>24&255]}function wt(e,t){e&=65535;e=(e|e<<8)&16711935;e=(e|e<<4)&252645135;e=(e|e<<2)&858993459;e=(e|e<<1)&1431655765;t&=65535;t=(t|t<<8)&16711935;t=(t|t<<4)&252645135;t=(t|t<<2)&858993459;t=(t|t<<1)&1431655765;return e|t<<1}function Tt(e,t){e=e>>>t&1431655765;e=(e|e>>>1)&858993459;e=(e|e>>>2)&252645135;e=(e|e>>>4)&16711935;e=(e|e>>>16)&65535;return e<<16>>16}function Et(e,t,r){e&=1023;e=(e|e<<16)&4278190335;e=(e|e<<8)&251719695;e=(e|e<<4)&3272356035;e=(e|e<<2)&1227133513;t&=1023;t=(t|t<<16)&4278190335;t=(t|t<<8)&251719695;t=(t|t<<4)&3272356035;t=(t|t<<2)&1227133513;e|=t<<1;r&=1023;r=(r|r<<16)&4278190335;r=(r|r<<8)&251719695;r=(r|r<<4)&3272356035;r=(r|r<<2)&1227133513;return e|r<<2}function St(e,t){e=e>>>t&1227133513;e=(e|e>>>2)&3272356035;e=(e|e>>>4)&251719695;e=(e|e>>>8)&4278190335;e=(e|e>>>16)&1023;return e<<22>>22}function Mt(e){var t=e|e-1;return t+1|(~t&-~t)-1>>>mt(e)+1}var At=Object.freeze({INT_BITS:at,INT_MAX:ot,INT_MIN:st,sign:lt,abs:ut,min:ht,max:ct,isPow2:ft,log2:pt,log10:dt,popCount:vt,countTrailingZeros:mt,nextPow2:_t,prevPow2:gt,parity:yt,reverse:bt,interleave2:wt,deinterleave2:Tt,interleave3:Et,deinterleave3:St,nextCombination:Mt});var Rt=function e(t,r){this.x=t;this.y=r};Rt.new=function e(t,r){return new Rt(t,r)};Rt.zero=function e(){return new Rt(0,0)};Rt.clone=function e(t){return new Rt(t.x,t.y)};Rt.copy=function e(t,r){t.x=r.x;t.y=r.y;return t};Rt.set=function e(t,r,n){t.x=r;t.y=n;return t};Rt.add=function e(t,r,n){t.x=r.x+n.x;t.y=r.y+n.y;return t};Rt.subtract=function e(t,r,n){t.x=r.x-n.x;t.y=r.y-n.y;return t};Rt.sub=function e(t,r,n){return Rt.subtract(t,r,n)};Rt.multiply=function e(t,r,n){t.x=r.x*n.x;t.y=r.y*n.y;return t};Rt.mul=function e(t,r,n){return Rt.multiply(t,r,n)};Rt.divide=function e(t,r,n){t.x=r.x/n.x;t.y=r.y/n.y;return t};Rt.div=function e(t,r,n){return Rt.divide(t,r,n)};Rt.ceil=function e(t,r){t.x=Math.ceil(r.x);t.y=Math.ceil(r.y);return t};Rt.floor=function e(t,r){t.x=Math.floor(r.x);t.y=Math.floor(r.y);return t};Rt.min=function e(t,r,n){t.x=Math.min(r.x,n.x);t.y=Math.min(r.y,n.y);return t};Rt.max=function e(t,r,n){t.x=Math.max(r.x,n.x);t.y=Math.max(r.y,n.y);return t};Rt.round=function e(t,r){t.x=Math.round(r.x);t.y=Math.round(r.y);return t};Rt.scale=function e(t,r,n){t.x=r.x*n;t.y=r.y*n;return t};Rt.scaleAndAdd=function e(t,r,n,i){t.x=r.x+n.x*i;t.y=r.y+n.y*i;return t};Rt.distance=function e(t,r){var n=r.x-t.x,i=r.y-t.y;return Math.sqrt(n*n+i*i)};Rt.dist=function e(t,r){return Rt.distance(t,r)};Rt.squaredDistance=function e(t,r){var n=r.x-t.x,i=r.y-t.y;return n*n+i*i};Rt.sqrDist=function e(t,r){return Rt.squaredDistance(t,r)};Rt.magnitude=function e(t){var r=t.x,n=t.y;return Math.sqrt(r*r+n*n)};Rt.mag=function e(t){return Rt.magnitude(t)};Rt.squaredMagnitude=function e(t){var r=t.x,n=t.y;return r*r+n*n};Rt.sqrMag=function e(t){return Rt.squaredMagnitude(t)};Rt.negate=function e(t,r){t.x=-r.x;t.y=-r.y;return t};Rt.inverse=function e(t,r){t.x=1/r.x;t.y=1/r.y;return t};Rt.inverseSafe=function e(t,r){var n=r.x,i=r.y;if(Math.abs(n)<Ve){t.x=0}else{t.x=1/n}if(Math.abs(i)<Ve){t.y=0}else{t.y=1/r.y}return t};Rt.normalize=function e(t,r){var n=r.x,i=r.y;var a=n*n+i*i;if(a>0){a=1/Math.sqrt(a);t.x=r.x*a;t.y=r.y*a}return t};Rt.dot=function e(t,r){return t.x*r.x+t.y*r.y};Rt.cross=function e(t,r,n){var i=r.x*n.y-r.y*n.x;t.x=t.y=0;t.z=i;return t};Rt.lerp=function e(t,r,n,i){var a=r.x,o=r.y;t.x=a+i*(n.x-a);t.y=o+i*(n.y-o);return t};Rt.random=function e(t,r){r=r||1;var n=Ke()*2*Math.PI;t.x=Math.cos(n)*r;t.y=Math.sin(n)*r;return t};Rt.transformMat2=function e(t,r,n){var i=r.x,a=r.y;t.x=n.m00*i+n.m02*a;t.y=n.m01*i+n.m03*a;return t};Rt.transformMat23=function e(t,r,n){var i=r.x,a=r.y;t.x=n.m00*i+n.m02*a+n.m04;t.y=n.m01*i+n.m03*a+n.m05;return t};Rt.transformMat3=function e(t,r,n){var i=r.x,a=r.y;t.x=n.m00*i+n.m03*a+n.m06;t.y=n.m01*i+n.m04*a+n.m07;return t};Rt.transformMat4=function e(t,r,n){var i=r.x,a=r.y;t.x=n.m00*i+n.m04*a+n.m12;t.y=n.m01*i+n.m05*a+n.m13;return t};Rt.forEach=function e(t,r,n,i,a,o){return Rt._forEach(t,r,n,i,a,o)};Rt.str=function e(t){return"vec2("+t.x+", "+t.y+")"};Rt.array=function e(t,r){t[0]=r.x;t[1]=r.y;return t};Rt.exactEquals=function e(t,r){return t.x===r.x&&t.y===r.y};Rt.equals=function e(t,r){var n=t.x,i=t.y;var a=r.x,o=r.y;return Math.abs(n-a)<=Ve*Math.max(1,Math.abs(n),Math.abs(a))&&Math.abs(i-o)<=Ve*Math.max(1,Math.abs(i),Math.abs(o))};Rt._forEach=function(){var e=Rt.zero();return function(t,r,n,i,a,o){var s,l;if(!r){r=2}if(!n){n=0}if(i){l=Math.min(i*r+n,t.length)}else{l=t.length}for(s=n;s<l;s+=r){e.x=t[s];e.y=t[s+1];a(e,e,o);t[s]=e.x;t[s+1]=e.y}return t}}();var Lt=function e(t,r,n){this.x=t;this.y=r;this.z=n};Lt.new=function e(t,r,n){return new Lt(t,r,n)};Lt.zero=function e(){return Lt.new(0,0,0)};Lt.clone=function e(t){return new Lt(t.x,t.y,t.z)};Lt.copy=function e(t,r){t.x=r.x;t.y=r.y;t.z=r.z;return t};Lt.set=function e(t,r,n,i){t.x=r;t.y=n;t.z=i;return t};Lt.add=function e(t,r,n){t.x=r.x+n.x;t.y=r.y+n.y;t.z=r.z+n.z;return t};Lt.subtract=function e(t,r,n){t.x=r.x-n.x;t.y=r.y-n.y;t.z=r.z-n.z;return t};Lt.sub=function e(t,r,n){return Lt.subtract(t,r,n)};Lt.multiply=function e(t,r,n){t.x=r.x*n.x;t.y=r.y*n.y;t.z=r.z*n.z;return t};Lt.mul=function e(t,r,n){return Lt.multiply(t,r,n)};Lt.divide=function e(t,r,n){t.x=r.x/n.x;t.y=r.y/n.y;t.z=r.z/n.z;return t};Lt.div=function e(t,r,n){return Lt.divide(t,r,n)};Lt.ceil=function e(t,r){t.x=Math.ceil(r.x);t.y=Math.ceil(r.y);t.z=Math.ceil(r.z);return t};Lt.floor=function e(t,r){t.x=Math.floor(r.x);t.y=Math.floor(r.y);t.z=Math.floor(r.z);return t};Lt.min=function e(t,r,n){t.x=Math.min(r.x,n.x);t.y=Math.min(r.y,n.y);t.z=Math.min(r.z,n.z);return t};Lt.max=function e(t,r,n){t.x=Math.max(r.x,n.x);t.y=Math.max(r.y,n.y);t.z=Math.max(r.z,n.z);return t};Lt.round=function e(t,r){t.x=Math.round(r.x);t.y=Math.round(r.y);t.z=Math.round(r.z);return t};Lt.scale=function e(t,r,n){t.x=r.x*n;t.y=r.y*n;t.z=r.z*n;return t};Lt.scaleAndAdd=function e(t,r,n,i){t.x=r.x+n.x*i;t.y=r.y+n.y*i;t.z=r.z+n.z*i;return t};Lt.distance=function e(t,r){var n=r.x-t.x,i=r.y-t.y,a=r.z-t.z;return Math.sqrt(n*n+i*i+a*a)};Lt.dist=function e(t,r){return Lt.distance(t,r)};Lt.squaredDistance=function e(t,r){var n=r.x-t.x,i=r.y-t.y,a=r.z-t.z;return n*n+i*i+a*a};Lt.sqrDist=function e(t,r){return Lt.squaredDistance(t,r)};Lt.magnitude=function e(t){var r=t.x,n=t.y,i=t.z;return Math.sqrt(r*r+n*n+i*i)};Lt.mag=function e(t){return Lt.magnitude(t)};Lt.squaredMagnitude=function e(t){var r=t.x,n=t.y,i=t.z;return r*r+n*n+i*i};Lt.sqrMag=function e(t){return Lt.squaredMagnitude(t)};Lt.negate=function e(t,r){t.x=-r.x;t.y=-r.y;t.z=-r.z;return t};Lt.inverse=function e(t,r){t.x=1/r.x;t.y=1/r.y;t.z=1/r.z;return t};Lt.inverseSafe=function e(t,r){var n=r.x,i=r.y,a=r.z;if(Math.abs(n)<Ve){t.x=0}else{t.x=1/n}if(Math.abs(i)<Ve){t.y=0}else{t.y=1/i}if(Math.abs(a)<Ve){t.z=0}else{t.z=1/a}return t};Lt.normalize=function e(t,r){var n=r.x,i=r.y,a=r.z;var o=n*n+i*i+a*a;if(o>0){o=1/Math.sqrt(o);t.x=n*o;t.y=i*o;t.z=a*o}return t};Lt.dot=function e(t,r){return t.x*r.x+t.y*r.y+t.z*r.z};Lt.cross=function e(t,r,n){var i=r.x,a=r.y,o=r.z,s=n.x,l=n.y,u=n.z;t.x=a*u-o*l;t.y=o*s-i*u;t.z=i*l-a*s;return t};Lt.lerp=function e(t,r,n,i){var a=r.x,o=r.y,s=r.z;t.x=a+i*(n.x-a);t.y=o+i*(n.y-o);t.z=s+i*(n.z-s);return t};Lt.hermite=function e(t,r,n,i,a,o){var s=o*o,l=s*(2*o-3)+1,u=s*(o-2)+o,h=s*(o-1),c=s*(3-2*o);t.x=r.x*l+n.x*u+i.x*h+a.x*c;t.y=r.y*l+n.y*u+i.y*h+a.y*c;t.z=r.z*l+n.z*u+i.z*h+a.z*c;return t};Lt.bezier=function e(t,r,n,i,a,o){var s=1-o,l=s*s,u=o*o,h=l*s,c=3*o*l,f=3*u*s,p=u*o;t.x=r.x*h+n.x*c+i.x*f+a.x*p;t.y=r.y*h+n.y*c+i.y*f+a.y*p;t.z=r.z*h+n.z*c+i.z*f+a.z*p;return t};Lt.random=function e(t,r){r=r||1;var n=Ke()*2*Math.PI;var i=Ke()*2-1;var a=Math.sqrt(1-i*i)*r;t.x=Math.cos(n)*a;t.y=Math.sin(n)*a;t.z=i*r;return t};Lt.transformMat4=function e(t,r,n){var i=r.x,a=r.y,o=r.z,s=n.m03*i+n.m07*a+n.m11*o+n.m15;s=s||1;t.x=(n.m00*i+n.m04*a+n.m08*o+n.m12)/s;t.y=(n.m01*i+n.m05*a+n.m09*o+n.m13)/s;t.z=(n.m02*i+n.m06*a+n.m10*o+n.m14)/s;return t};Lt.transformMat3=function e(t,r,n){var i=r.x,a=r.y,o=r.z;t.x=i*n.m00+a*n.m03+o*n.m06;t.y=i*n.m01+a*n.m04+o*n.m07;t.z=i*n.m02+a*n.m05+o*n.m08;return t};Lt.transformQuat=function e(t,r,n){var i=r.x,a=r.y,o=r.z;var s=n.x,l=n.y,u=n.z,h=n.w;var c=h*i+l*o-u*a;var f=h*a+u*i-s*o;var p=h*o+s*a-l*i;var d=-s*i-l*a-u*o;t.x=c*h+d*-s+f*-u-p*-l;t.y=f*h+d*-l+p*-s-c*-u;t.z=p*h+d*-u+c*-l-f*-s;return t};Lt.rotateX=function e(t,r,n,i){var a=[],o=[];a.x=r.x-n.x;a.y=r.y-n.y;a.z=r.z-n.z;o.x=a.x;o.y=a.y*Math.cos(i)-a.z*Math.sin(i);o.z=a.y*Math.sin(i)+a.z*Math.cos(i);t.x=o.x+n.x;t.y=o.y+n.y;t.z=o.z+n.z;return t};Lt.rotateY=function e(t,r,n,i){var a=[],o=[];a.x=r.x-n.x;a.y=r.y-n.y;a.z=r.z-n.z;o.x=a.z*Math.sin(i)+a.x*Math.cos(i);o.y=a.y;o.z=a.z*Math.cos(i)-a.x*Math.sin(i);t.x=o.x+n.x;t.y=o.y+n.y;t.z=o.z+n.z;return t};Lt.rotateZ=function e(t,r,n,i){var a=[],o=[];a.x=r.x-n.x;a.y=r.y-n.y;a.z=r.z-n.z;o.x=a.x*Math.cos(i)-a.y*Math.sin(i);o.y=a.x*Math.sin(i)+a.y*Math.cos(i);o.z=a.z;t.x=o.x+n.x;t.y=o.y+n.y;t.z=o.z+n.z;return t};Lt.str=function e(t){return"vec3("+t.x+", "+t.y+", "+t.z+")"};Lt.array=function e(t,r){t[0]=r.x;t[1]=r.y;t[2]=r.z;return t};Lt.exactEquals=function e(t,r){return t.x===r.x&&t.y===r.y&&t.z===r.z};Lt.equals=function e(t,r){var n=t.x,i=t.y,a=t.z;var o=r.x,s=r.y,l=r.z;return Math.abs(n-o)<=Ve*Math.max(1,Math.abs(n),Math.abs(o))&&Math.abs(i-s)<=Ve*Math.max(1,Math.abs(i),Math.abs(s))&&Math.abs(a-l)<=Ve*Math.max(1,Math.abs(a),Math.abs(l))};Lt.forEach=function e(t,r,n,i,a,o){return Lt._forEach(t,r,n,i,a,o)};Lt.angle=function e(t,r){return Lt._angle(t,r)};Lt._forEach=function(){var e=Lt.zero();return function(t,r,n,i,a,o){var s,l;if(!r){r=3}if(!n){n=0}if(i){l=Math.min(i*r+n,t.length)}else{l=t.length}for(s=n;s<l;s+=r){e.x=t[s];e.y=t[s+1];e.z=t[s+2];a(e,e,o);t[s]=e.x;t[s+1]=e.y;t[s+2]=e.z}return t}}();Lt._angle=function(){var e=Lt.zero();var t=Lt.zero();return function(r,n){Lt.copy(e,r);Lt.copy(t,n);Lt.normalize(e,e);Lt.normalize(t,t);var i=Lt.dot(e,t);if(i>1){return 0}if(i<-1){return Math.PI}return Math.acos(i)}}();var Ct=function e(t,r,n,i){this.x=t;this.y=r;this.z=n;this.w=i};Ct.new=function e(t,r,n,i){return new Ct(t,r,n,i)};Ct.zero=function e(){return Ct.new(0,0,0,0)};Ct.clone=function e(t){return new Ct(t.x,t.y,t.z,t.w)};Ct.copy=function e(t,r){t.x=r.x;t.y=r.y;t.z=r.z;t.w=r.w;return t};Ct.set=function e(t,r,n,i,a){t.x=r;t.y=n;t.z=i;t.w=a;return t};Ct.add=function e(t,r,n){t.x=r.x+n.x;t.y=r.y+n.y;t.z=r.z+n.z;t.w=r.w+n.w;return t};Ct.subtract=function e(t,r,n){t.x=r.x-n.x;t.y=r.y-n.y;t.z=r.z-n.z;t.w=r.w-n.w;return t};Ct.sub=function e(t,r,n){return Ct.subtract(t,r,n)};Ct.multiply=function e(t,r,n){t.x=r.x*n.x;t.y=r.y*n.y;t.z=r.z*n.z;t.w=r.w*n.w;return t};Ct.mul=function e(t,r,n){return Ct.multiply(t,r,n)};Ct.divide=function e(t,r,n){t.x=r.x/n.x;t.y=r.y/n.y;t.z=r.z/n.z;t.w=r.w/n.w;return t};Ct.div=function e(t,r,n){return Ct.divide(t,r,n)};Ct.ceil=function e(t,r){t.x=Math.ceil(r.x);t.y=Math.ceil(r.y);t.z=Math.ceil(r.z);t.w=Math.ceil(r.w);return t};Ct.floor=function e(t,r){t.x=Math.floor(r.x);t.y=Math.floor(r.y);t.z=Math.floor(r.z);t.w=Math.floor(r.w);return t};Ct.min=function e(t,r,n){t.x=Math.min(r.x,n.x);t.y=Math.min(r.y,n.y);t.z=Math.min(r.z,n.z);t.w=Math.min(r.w,n.w);return t};Ct.max=function e(t,r,n){t.x=Math.max(r.x,n.x);t.y=Math.max(r.y,n.y);t.z=Math.max(r.z,n.z);t.w=Math.max(r.w,n.w);return t};Ct.round=function e(t,r){t.x=Math.round(r.x);t.y=Math.round(r.y);t.z=Math.round(r.z);t.w=Math.round(r.w);return t};Ct.scale=function e(t,r,n){t.x=r.x*n;t.y=r.y*n;t.z=r.z*n;t.w=r.w*n;return t};Ct.scaleAndAdd=function e(t,r,n,i){t.x=r.x+n.x*i;t.y=r.y+n.y*i;t.z=r.z+n.z*i;t.w=r.w+n.w*i;return t};Ct.distance=function e(t,r){var n=r.x-t.x,i=r.y-t.y,a=r.z-t.z,o=r.w-t.w;return Math.sqrt(n*n+i*i+a*a+o*o)};Ct.dist=function e(t,r){return Ct.distance(t,r)};Ct.squaredDistance=function e(t,r){var n=r.x-t.x,i=r.y-t.y,a=r.z-t.z,o=r.w-t.w;return n*n+i*i+a*a+o*o};Ct.sqrDist=function e(t,r){return Ct.squaredDistance(t,r)};Ct.magnitude=function e(t){var r=t.x,n=t.y,i=t.z,a=t.w;return Math.sqrt(r*r+n*n+i*i+a*a)};Ct.mag=function e(t){return Ct.magnitude(t)};Ct.squaredMagnitude=function e(t){var r=t.x,n=t.y,i=t.z,a=t.w;return r*r+n*n+i*i+a*a};Ct.sqrMag=function e(t){return Ct.squaredMagnitude(t)};Ct.negate=function e(t,r){t.x=-r.x;t.y=-r.y;t.z=-r.z;t.w=-r.w;return t};Ct.inverse=function e(t,r){t.x=1/r.x;t.y=1/r.y;t.z=1/r.z;t.w=1/r.w;return t};Ct.inverseSafe=function e(t,r){var n=r.x,i=r.y,a=r.z,o=r.w;if(Math.abs(n)<Ve){t.x=0}else{t.x=1/n}if(Math.abs(i)<Ve){t.y=0}else{t.y=1/i}if(Math.abs(a)<Ve){t.z=0}else{t.z=1/a}if(Math.abs(o)<Ve){t.w=0}else{t.w=1/o}return t};Ct.normalize=function e(t,r){var n=r.x,i=r.y,a=r.z,o=r.w;var s=n*n+i*i+a*a+o*o;if(s>0){s=1/Math.sqrt(s);t.x=n*s;t.y=i*s;t.z=a*s;t.w=o*s}return t};Ct.dot=function e(t,r){return t.x*r.x+t.y*r.y+t.z*r.z+t.w*r.w};Ct.lerp=function e(t,r,n,i){var a=r.x,o=r.y,s=r.z,l=r.w;t.x=a+i*(n.x-a);t.y=o+i*(n.y-o);t.z=s+i*(n.z-s);t.w=l+i*(n.w-l);return t};Ct.random=function e(t,r){r=r||1;t.x=Ke();t.y=Ke();t.z=Ke();t.w=Ke();Ct.normalize(t,t);Ct.scale(t,t,r);return t};Ct.transformMat4=function e(t,r,n){var i=r.x,a=r.y,o=r.z,s=r.w;t.x=n.m00*i+n.m04*a+n.m08*o+n.m12*s;t.y=n.m01*i+n.m05*a+n.m09*o+n.m13*s;t.z=n.m02*i+n.m06*a+n.m10*o+n.m14*s;t.w=n.m03*i+n.m07*a+n.m11*o+n.m15*s;return t};Ct.transformQuat=function e(t,r,n){var i=r.x,a=r.y,o=r.z;var s=n.x,l=n.y,u=n.z,h=n.w;var c=h*i+l*o-u*a;var f=h*a+u*i-s*o;var p=h*o+s*a-l*i;var d=-s*i-l*a-u*o;t.x=c*h+d*-s+f*-u-p*-l;t.y=f*h+d*-l+p*-s-c*-u;t.z=p*h+d*-u+c*-l-f*-s;t.w=r.w;return t};Ct.str=function e(t){return"vec4("+t.x+", "+t.y+", "+t.z+", "+t.w+")"};Ct.array=function e(t,r){t[0]=r.x;t[1]=r.y;t[2]=r.z;t[3]=r.w;return t};Ct.exactEquals=function e(t,r){return t.x===r.x&&t.y===r.y&&t.z===r.z&&t.w===r.w};Ct.equals=function e(t,r){var n=t.x,i=t.y,a=t.z,o=t.w;var s=r.x,l=r.y,u=r.z,h=r.w;return Math.abs(n-s)<=Ve*Math.max(1,Math.abs(n),Math.abs(s))&&Math.abs(i-l)<=Ve*Math.max(1,Math.abs(i),Math.abs(l))&&Math.abs(a-u)<=Ve*Math.max(1,Math.abs(a),Math.abs(u))&&Math.abs(o-h)<=Ve*Math.max(1,Math.abs(o),Math.abs(h))};Ct.forEach=function e(t,r,n,i,a,o){return Ct._forEach(t,r,n,i,a,o)};Ct._forEach=function(){var e=Ct.zero();return function(t,r,n,i,a,o){var s,l;if(!r){r=4}if(!n){n=0}if(i){l=Math.min(i*r+n,t.length)}else{l=t.length}for(s=n;s<l;s+=r){e.x=t[s];e.y=t[s+1];e.z=t[s+2];e.w=t[s+3];a(e,e,o);t[s]=e.x;t[s+1]=e.y;t[s+2]=e.z;t[s+3]=e.w}return t}}();var It=function e(t,r,n,i,a,o,s,l,u){this.m00=t;this.m01=r;this.m02=n;this.m03=i;this.m04=a;this.m05=o;this.m06=s;this.m07=l;this.m08=u};It.create=function e(){return new It(1,0,0,0,1,0,0,0,1)};It.new=function e(t,r,n,i,a,o,s,l,u){return new It(t,r,n,i,a,o,s,l,u)};It.clone=function e(t){return new It(t.m00,t.m01,t.m02,t.m03,t.m04,t.m05,t.m06,t.m07,t.m08)};It.copy=function e(t,r){t.m00=r.m00;t.m01=r.m01;t.m02=r.m02;t.m03=r.m03;t.m04=r.m04;t.m05=r.m05;t.m06=r.m06;t.m07=r.m07;t.m08=r.m08;return t};It.set=function e(t,r,n,i,a,o,s,l,u,h){t.m00=r;t.m01=n;t.m02=i;t.m03=a;t.m04=o;t.m05=s;t.m06=l;t.m07=u;t.m08=h;return t};It.identity=function e(t){t.m00=1;t.m01=0;t.m02=0;t.m03=0;t.m04=1;t.m05=0;t.m06=0;t.m07=0;t.m08=1;return t};It.transpose=function e(t,r){if(t===r){var n=r.m01,i=r.m02,a=r.m05;t.m01=r.m03;t.m02=r.m06;t.m03=n;t.m05=r.m07;t.m06=i;t.m07=a}else{t.m00=r.m00;t.m01=r.m03;t.m02=r.m06;t.m03=r.m01;t.m04=r.m04;t.m05=r.m07;t.m06=r.m02;t.m07=r.m05;t.m08=r.m08}return t};It.invert=function e(t,r){var n=r.m00,i=r.m01,a=r.m02,o=r.m03,s=r.m04,l=r.m05,u=r.m06,h=r.m07,c=r.m08;var f=c*s-l*h;var p=-c*o+l*u;var d=h*o-s*u;var v=n*f+i*p+a*d;if(!v){return null}v=1/v;t.m00=f*v;t.m01=(-c*i+a*h)*v;t.m02=(l*i-a*s)*v;t.m03=p*v;t.m04=(c*n-a*u)*v;t.m05=(-l*n+a*o)*v;t.m06=d*v;t.m07=(-h*n+i*u)*v;t.m08=(s*n-i*o)*v;return t};It.adjoint=function e(t,r){var n=r.m00,i=r.m01,a=r.m02,o=r.m03,s=r.m04,l=r.m05,u=r.m06,h=r.m07,c=r.m08;t.m00=s*c-l*h;t.m01=a*h-i*c;t.m02=i*l-a*s;t.m03=l*u-o*c;t.m04=n*c-a*u;t.m05=a*o-n*l;t.m06=o*h-s*u;t.m07=i*u-n*h;t.m08=n*s-i*o;return t};It.determinant=function e(t){var r=t.m00,n=t.m01,i=t.m02,a=t.m03,o=t.m04,s=t.m05,l=t.m06,u=t.m07,h=t.m08;return r*(h*o-s*u)+n*(-h*a+s*l)+i*(u*a-o*l)};It.multiply=function e(t,r,n){var i=r.m00,a=r.m01,o=r.m02,s=r.m03,l=r.m04,u=r.m05,h=r.m06,c=r.m07,f=r.m08;var p=n.m00,d=n.m01,v=n.m02;var m=n.m03,_=n.m04,g=n.m05;var y=n.m06,x=n.m07,b=n.m08;t.m00=p*i+d*s+v*h;t.m01=p*a+d*l+v*c;t.m02=p*o+d*u+v*f;t.m03=m*i+_*s+g*h;t.m04=m*a+_*l+g*c;t.m05=m*o+_*u+g*f;t.m06=y*i+x*s+b*h;t.m07=y*a+x*l+b*c;t.m08=y*o+x*u+b*f;return t};It.mul=function e(t,r,n){return It.multiply(t,r,n)};It.translate=function e(t,r,n){var i=r.m00,a=r.m01,o=r.m02,s=r.m03,l=r.m04,u=r.m05,h=r.m06,c=r.m07,f=r.m08;var p=n.x,d=n.y;t.m00=i;t.m01=a;t.m02=o;t.m03=s;t.m04=l;t.m05=u;t.m06=p*i+d*s+h;t.m07=p*a+d*l+c;t.m08=p*o+d*u+f;return t};It.rotate=function e(t,r,n){var i=r.m00,a=r.m01,o=r.m02,s=r.m03,l=r.m04,u=r.m05,h=r.m06,c=r.m07,f=r.m08;var p=Math.sin(n);var d=Math.cos(n);t.m00=d*i+p*s;t.m01=d*a+p*l;t.m02=d*o+p*u;t.m03=d*s-p*i;t.m04=d*l-p*a;t.m05=d*u-p*o;t.m06=h;t.m07=c;t.m08=f;return t};It.scale=function e(t,r,n){var i=n.x,a=n.y;t.m00=i*r.m00;t.m01=i*r.m01;t.m02=i*r.m02;t.m03=a*r.m03;t.m04=a*r.m04;t.m05=a*r.m05;t.m06=r.m06;t.m07=r.m07;t.m08=r.m08;return t};It.fromMat4=function e(t,r){t.m00=r.m00;t.m01=r.m01;t.m02=r.m02;t.m03=r.m04;t.m04=r.m05;t.m05=r.m06;t.m06=r.m08;t.m07=r.m09;t.m08=r.m10;return t};It.fromTranslation=function e(t,r){t.m00=1;t.m01=0;t.m02=0;t.m03=0;t.m04=1;t.m05=0;t.m06=r.x;t.m07=r.y;t.m08=1;return t};It.fromRotation=function e(t,r){var n=Math.sin(r),i=Math.cos(r);t.m00=i;t.m01=n;t.m02=0;t.m03=-n;t.m04=i;t.m05=0;t.m06=0;t.m07=0;t.m08=1;return t};It.fromScaling=function e(t,r){t.m00=r.x;t.m01=0;t.m02=0;t.m03=0;t.m04=r.y;t.m05=0;t.m06=0;t.m07=0;t.m08=1;return t};It.fromMat2d=function e(t,r){t.m00=r.m00;t.m01=r.m01;t.m02=0;t.m03=r.m02;t.m04=r.m03;t.m05=0;t.m06=r.m04;t.m07=r.m05;t.m08=1;return t};It.fromQuat=function e(t,r){var n=r.x,i=r.y,a=r.z,o=r.w;var s=n+n;var l=i+i;var u=a+a;var h=n*s;var c=i*s;var f=i*l;var p=a*s;var d=a*l;var v=a*u;var m=o*s;var _=o*l;var g=o*u;t.m00=1-f-v;t.m03=c-g;t.m06=p+_;t.m01=c+g;t.m04=1-h-v;t.m07=d-m;t.m02=p-_;t.m05=d+m;t.m08=1-h-f;return t};It.fromViewUp=function e(t,r,n){return It._fromViewUp(t,r,n)};It.normalFromMat4=function e(t,r){var n=r.m00,i=r.m01,a=r.m02,o=r.m03,s=r.m04,l=r.m05,u=r.m06,h=r.m07,c=r.m08,f=r.m09,p=r.m10,d=r.m11,v=r.m12,m=r.m13,_=r.m14,g=r.m15;var y=n*l-i*s;var x=n*u-a*s;var b=n*h-o*s;var w=i*u-a*l;var T=i*h-o*l;var E=a*h-o*u;var S=c*m-f*v;var M=c*_-p*v;var A=c*g-d*v;var R=f*_-p*m;var L=f*g-d*m;var C=p*g-d*_;var I=y*C-x*L+b*R+w*A-T*M+E*S;if(!I){return null}I=1/I;t.m00=(l*C-u*L+h*R)*I;t.m01=(u*A-s*C-h*M)*I;t.m02=(s*L-l*A+h*S)*I;t.m03=(a*L-i*C-o*R)*I;t.m04=(n*C-a*A+o*M)*I;t.m05=(i*A-n*L-o*S)*I;t.m06=(m*E-_*T+g*w)*I;t.m07=(_*b-v*E-g*x)*I;t.m08=(v*T-m*b+g*y)*I;return t};It.str=function e(t){return"mat3("+t.m00+", "+t.m01+", "+t.m02+", "+t.m03+", "+t.m04+", "+t.m05+", "+t.m06+", "+t.m07+", "+t.m08+")"};It.array=function e(t,r){t[0]=r.m00;t[1]=r.m01;t[2]=r.m02;t[3]=r.m03;t[4]=r.m04;t[5]=r.m05;t[6]=r.m06;t[7]=r.m07;t[8]=r.m08;return t};It.frob=function e(t){return Math.sqrt(Math.pow(t.m00,2)+Math.pow(t.m01,2)+Math.pow(t.m02,2)+Math.pow(t.m03,2)+Math.pow(t.m04,2)+Math.pow(t.m05,2)+Math.pow(t.m06,2)+Math.pow(t.m07,2)+Math.pow(t.m08,2))};It.add=function e(t,r,n){t.m00=r.m00+n.m00;t.m01=r.m01+n.m01;t.m02=r.m02+n.m02;t.m03=r.m03+n.m03;t.m04=r.m04+n.m04;t.m05=r.m05+n.m05;t.m06=r.m06+n.m06;t.m07=r.m07+n.m07;t.m08=r.m08+n.m08;return t};It.subtract=function e(t,r,n){t.m00=r.m00-n.m00;t.m01=r.m01-n.m01;t.m02=r.m02-n.m02;t.m03=r.m03-n.m03;t.m04=r.m04-n.m04;t.m05=r.m05-n.m05;t.m06=r.m06-n.m06;t.m07=r.m07-n.m07;t.m08=r.m08-n.m08;return t};It.sub=function e(t,r,n){return It.subtract(t,r,n)};It.multiplyScalar=function e(t,r,n){t.m00=r.m00*n;t.m01=r.m01*n;t.m02=r.m02*n;t.m03=r.m03*n;t.m04=r.m04*n;t.m05=r.m05*n;t.m06=r.m06*n;t.m07=r.m07*n;t.m08=r.m08*n;return t};It.multiplyScalarAndAdd=function e(t,r,n,i){t.m00=r.m00+n.m00*i;t.m01=r.m01+n.m01*i;t.m02=r.m02+n.m02*i;t.m03=r.m03+n.m03*i;t.m04=r.m04+n.m04*i;t.m05=r.m05+n.m05*i;t.m06=r.m06+n.m06*i;t.m07=r.m07+n.m07*i;t.m08=r.m08+n.m08*i;return t};It.exactEquals=function e(t,r){return t.m00===r.m00&&t.m01===r.m01&&t.m02===r.m02&&t.m03===r.m03&&t.m04===r.m04&&t.m05===r.m05&&t.m06===r.m06&&t.m07===r.m07&&t.m08===r.m08};It.equals=function e(t,r){var n=t.m00,i=t.m01,a=t.m02,o=t.m03,s=t.m04,l=t.m05,u=t.m06,h=t.m07,c=t.m08;var f=r.m00,p=r.m01,d=r.m02,v=r.m03,m=r.m04,_=r.m05,g=r.m06,y=r.m07,x=r.m08;return Math.abs(n-f)<=Ve*Math.max(1,Math.abs(n),Math.abs(f))&&Math.abs(i-p)<=Ve*Math.max(1,Math.abs(i),Math.abs(p))&&Math.abs(a-d)<=Ve*Math.max(1,Math.abs(a),Math.abs(d))&&Math.abs(o-v)<=Ve*Math.max(1,Math.abs(o),Math.abs(v))&&Math.abs(s-m)<=Ve*Math.max(1,Math.abs(s),Math.abs(m))&&Math.abs(l-_)<=Ve*Math.max(1,Math.abs(l),Math.abs(_))&&Math.abs(u-g)<=Ve*Math.max(1,Math.abs(u),Math.abs(g))&&Math.abs(h-y)<=Ve*Math.max(1,Math.abs(h),Math.abs(y))&&Math.abs(c-x)<=Ve*Math.max(1,Math.abs(c),Math.abs(x))};It._fromViewUp=function(){var e=Lt.new(0,1,0);var t=Lt.zero();var r=Lt.zero();return function(n,i,a){if(Lt.sqrMag(i)<Ve*Ve){It.identity(n);return n}a=a||e;Lt.normalize(t,Lt.cross(t,a,i));if(Lt.sqrMag(t)<Ve*Ve){It.identity(n);return n}Lt.cross(r,i,t);It.set(n,t.x,t.y,t.z,r.x,r.y,r.z,i.x,i.y,i.z);return n}}();var Ut=function e(t,r,n,i){this.x=t;this.y=r;this.z=n;this.w=i};Ut.new=function e(t,r,n,i){return new Ut(t,r,n,i)};Ut.create=function e(){return new Ut(0,0,0,1)};Ut.clone=function e(t){return new Ut(t.x,t.y,t.z,t.w)};Ut.copy=function e(t,r){return Ct.copy(t,r)};Ut.set=function e(t,r,n,i,a){t.x=r;t.y=n;t.z=i;t.w=a;return t};Ut.identity=function e(t){t.x=0;t.y=0;t.z=0;t.w=1;return t};Ut.rotationTo=function e(t,r,n){return Ut._rotationTo(t,r,n)};Ut.getAxisAngle=function e(t,r){var n=Math.acos(r.w)*2;var i=Math.sin(n/2);if(i!=0){t.x=r.x/i;t.y=r.y/i;t.z=r.z/i}else{t.x=1;t.y=0;t.z=0}return n};Ut.multiply=function e(t,r,n){var i=r.x,a=r.y,o=r.z,s=r.w,l=n.x,u=n.y,h=n.z,c=n.w;t.x=i*c+s*l+a*h-o*u;t.y=a*c+s*u+o*l-i*h;t.z=o*c+s*h+i*u-a*l;t.w=s*c-i*l-a*u-o*h;return t};Ut.mul=function e(t,r,n){return Ut.multiply(t,r,n)};Ut.scale=function e(t,r,n){t.x=r.x*n;t.y=r.y*n;t.z=r.z*n;t.w=r.w*n;return t};Ut.rotateX=function e(t,r,n){n*=.5;var i=r.x,a=r.y,o=r.z,s=r.w,l=Math.sin(n),u=Math.cos(n);t.x=i*u+s*l;t.y=a*u+o*l;t.z=o*u-a*l;t.w=s*u-i*l;return t};Ut.rotateY=function e(t,r,n){n*=.5;var i=r.x,a=r.y,o=r.z,s=r.w,l=Math.sin(n),u=Math.cos(n);t.x=i*u-o*l;t.y=a*u+s*l;t.z=o*u+i*l;t.w=s*u-a*l;return t};Ut.rotateZ=function e(t,r,n){n*=.5;var i=r.x,a=r.y,o=r.z,s=r.w,l=Math.sin(n),u=Math.cos(n);t.x=i*u+a*l;t.y=a*u-i*l;t.z=o*u+s*l;t.w=s*u-o*l;return t};Ut.rotateAround=function e(t,r,n,i){return Ut._rotateAround(t,r,n,i)};Ut.rotateAroundLocal=function e(t,r,n,i){return Ut._rotateAroundLocal(t,r,n,i)};Ut.calculateW=function e(t,r){var n=r.x,i=r.y,a=r.z;t.x=n;t.y=i;t.z=a;t.w=Math.sqrt(Math.abs(1-n*n-i*i-a*a));return t};Ut.dot=function e(t,r){return t.x*r.x+t.y*r.y+t.z*r.z+t.w*r.w};Ut.lerp=function e(t,r,n,i){var a=r.x,o=r.y,s=r.z,l=r.w;t.x=a+i*(n.x-a);t.y=o+i*(n.y-o);t.z=s+i*(n.z-s);t.w=l+i*(n.w-l);return t};Ut.slerp=function e(t,r,n,i){var a=r.x,o=r.y,s=r.z,l=r.w,u=n.x,h=n.y,c=n.z,f=n.w;var p,d,v,m,_;d=a*u+o*h+s*c+l*f;if(d<0){d=-d;u=-u;h=-h;c=-c;f=-f}if(1-d>1e-6){p=Math.acos(d);v=Math.sin(p);m=Math.sin((1-i)*p)/v;_=Math.sin(i*p)/v}else{m=1-i;_=i}t.x=m*a+_*u;t.y=m*o+_*h;t.z=m*s+_*c;t.w=m*l+_*f;return t};Ut.sqlerp=function e(t,r,n,i,a,o){return Ut._sqlerp(t,r,n,i,a,o)};Ut.invert=function e(t,r){var n=r.x,i=r.y,a=r.z,o=r.w;var s=n*n+i*i+a*a+o*o;var l=s?1/s:0;t.x=-n*l;t.y=-i*l;t.z=-a*l;t.w=o*l;return t};Ut.conjugate=function e(t,r){t.x=-r.x;t.y=-r.y;t.z=-r.z;t.w=r.w;return t};Ut.magnitude=function e(t){var r=t.x,n=t.y,i=t.z,a=t.w;return Math.sqrt(r*r+n*n+i*i+a*a)};Ut.mag=function e(t){return Ut.magnitude(t)};Ut.squaredMagnitude=function e(t){var r=t.x,n=t.y,i=t.z,a=t.w;return r*r+n*n+i*i+a*a};Ut.sqrMag=function e(t){return Ut.squaredMagnitude(t)};Ut.normalize=function e(t,r){var n=r.x,i=r.y,a=r.z,o=r.w;var s=n*n+i*i+a*a+o*o;if(s>0){s=1/Math.sqrt(s);t.x=n*s;t.y=i*s;t.z=a*s;t.w=o*s}return t};Ut.fromAxes=function e(t,r,n,i){return Ut._fromAxes(t,r,n,i)};Ut.fromViewUp=function e(t,r,n){return Ut._fromViewUp(t,r,n)};Ut.fromAxisAngle=function e(t,r,n){n=n*.5;var i=Math.sin(n);t.x=i*r.x;t.y=i*r.y;t.z=i*r.z;t.w=Math.cos(n);return t};Ut.fromMat3=function e(t,r){var n=r.m00,i=r.m03,a=r.m06,o=r.m01,s=r.m04,l=r.m07,u=r.m02,h=r.m05,c=r.m08;var f=n+s+c;if(f>0){var p=.5/Math.sqrt(f+1);t.w=.25/p;t.x=(h-l)*p;t.y=(a-u)*p;t.z=(o-i)*p}else if(n>s&&n>c){var d=2*Math.sqrt(1+n-s-c);t.w=(h-l)/d;t.x=.25*d;t.y=(i+o)/d;t.z=(a+u)/d}else if(s>c){var v=2*Math.sqrt(1+s-n-c);t.w=(a-u)/v;t.x=(i+o)/v;t.y=.25*v;t.z=(l+h)/v}else{var m=2*Math.sqrt(1+c-n-s);t.w=(o-i)/m;t.x=(a+u)/m;t.y=(l+h)/m;t.z=.25*m}return t};Ut.fromEuler=function e(t,r,n,i){var a=.5*Math.PI/180;r*=a;n*=a;i*=a;var o=Math.sin(r);var s=Math.cos(r);var l=Math.sin(n);var u=Math.cos(n);var h=Math.sin(i);var c=Math.cos(i);t.x=o*u*c-s*l*h;t.y=s*l*c+o*u*h;t.z=s*u*h-o*l*c;t.w=s*u*c+o*l*h;return t};Ut.str=function e(t){return"quat("+t.x+", "+t.y+", "+t.z+", "+t.w+")"};Ut.array=function e(t,r){t[0]=r.x;t[1]=r.y;t[2]=r.z;t[3]=r.w;return t};Ut.exactEquals=function e(t,r){return Ct.exactEquals(t,r)};Ut.equals=function e(t,r){return Ct.equals(t,r)};Ut._rotationTo=function(){var e=Lt.zero();var t=Lt.new(1,0,0);var r=Lt.new(0,1,0);return function(n,i,a){var o=Lt.dot(i,a);if(o<-.999999){Lt.cross(e,t,i);if(Lt.magnitude(e)<1e-6){Lt.cross(e,r,i)}Lt.normalize(e,e);Ut.fromAxisAngle(n,e,Math.PI);return n}else if(o>.999999){n.x=0;n.y=0;n.z=0;n.w=1;return n}else{Lt.cross(e,i,a);n.x=e.x;n.y=e.y;n.z=e.z;n.w=1+o;return Ut.normalize(n,n)}}}();Ut._rotateAround=function(){var e=Lt.zero();var t=Ut.create();return function(r,n,i,a){Ut.invert(t,n);Lt.transformQuat(e,i,t);Ut.fromAxisAngle(t,e,a);Ut.mul(r,n,t);return r}}();Ut._rotateAroundLocal=function(){var e=Ut.create();return function(t,r,n,i){Ut.fromAxisAngle(e,n,i);Ut.mul(t,r,e);return t}}();Ut._sqlerp=function(){var e=Ut.create();var t=Ut.create();return function(r,n,i,a,o,s){Ut.slerp(e,n,o,s);Ut.slerp(t,i,a,s);Ut.slerp(r,e,t,2*s*(1-s));return r}}();Ut._fromAxes=function(){var e=It.create();return function(t,r,n,i){It.set(e,r.x,r.y,r.z,n.x,n.y,n.z,i.x,i.y,i.z);return Ut.normalize(t,Ut.fromMat3(t,e))}}();Ut._fromViewUp=function(){var e=It.create();return function(t,r,n){It.fromViewUp(e,r,n);if(!e){return null}return Ut.normalize(t,Ut.fromMat3(t,e))}}();var Dt=function e(t,r,n,i){this.m00=t;this.m01=r;this.m02=n;this.m03=i};Dt.create=function e(){return new Dt(1,0,0,1)};Dt.new=function e(t,r,n,i){return new Dt(t,r,n,i)};Dt.clone=function e(t){return new Dt(t.m00,t.m01,t.m02,t.m03)};Dt.copy=function e(t,r){t.m00=r.m00;t.m01=r.m01;t.m02=r.m02;t.m03=r.m03;return t};Dt.identity=function e(t){t.m00=1;t.m01=0;t.m02=0;t.m03=1;return t};Dt.set=function e(t,r,n,i,a){t.m00=r;t.m01=n;t.m02=i;t.m03=a;return t};Dt.transpose=function e(t,r){if(t===r){var n=r.m01;t.m01=r.m02;t.m02=n}else{t.m00=r.m00;t.m01=r.m02;t.m02=r.m01;t.m03=r.m03}return t};Dt.invert=function e(t,r){var n=r.m00,i=r.m01,a=r.m02,o=r.m03;var s=n*o-a*i;if(!s){return null}s=1/s;t.m00=o*s;t.m01=-i*s;t.m02=-a*s;t.m03=n*s;return t};Dt.adjoint=function e(t,r){var n=r.m00;t.m00=r.m03;t.m01=-r.m01;t.m02=-r.m02;t.m03=n;return t};Dt.determinant=function e(t){return t.m00*t.m03-t.m02*t.m01};Dt.multiply=function e(t,r,n){var i=r.m00,a=r.m01,o=r.m02,s=r.m03;var l=n.m00,u=n.m01,h=n.m02,c=n.m03;t.m00=i*l+o*u;t.m01=a*l+s*u;t.m02=i*h+o*c;t.m03=a*h+s*c;return t};Dt.mul=function e(t,r,n){return Dt.multiply(t,r,n)};Dt.rotate=function e(t,r,n){var i=r.m00,a=r.m01,o=r.m02,s=r.m03,l=Math.sin(n),u=Math.cos(n);t.m00=i*u+o*l;t.m01=a*u+s*l;t.m02=i*-l+o*u;t.m03=a*-l+s*u;return t};Dt.scale=function e(t,r,n){var i=r.m00,a=r.m01,o=r.m02,s=r.m03,l=n.x,u=n.y;t.m00=i*l;t.m01=a*l;t.m02=o*u;t.m03=s*u;return t};Dt.fromRotation=function e(t,r){var n=Math.sin(r),i=Math.cos(r);t.m00=i;t.m01=n;t.m02=-n;t.m03=i;return t};Dt.fromScaling=function e(t,r){t.m00=r.x;t.m01=0;t.m02=0;t.m03=r.y;return t};Dt.str=function e(t){return"mat2("+t.m00+", "+t.m01+", "+t.m02+", "+t.m03+")"};Dt.array=function e(t,r){t[0]=r.m00;t[1]=r.m01;t[2]=r.m02;t[3]=r.m03;return t};Dt.frob=function e(t){return Math.sqrt(Math.pow(t.m00,2)+Math.pow(t.m01,2)+Math.pow(t.m02,2)+Math.pow(t.m03,2))};Dt.LDU=function e(t,r,n,i){t.m02=i.m02/i.m00;n.m00=i.m00;n.m01=i.m01;n.m03=i.m03-t.m02*n.m01};Dt.add=function e(t,r,n){t.m00=r.m00+n.m00;t.m01=r.m01+n.m01;t.m02=r.m02+n.m02;t.m03=r.m03+n.m03;return t};Dt.subtract=function e(t,r,n){t.m00=r.m00-n.m00;t.m01=r.m01-n.m01;t.m02=r.m02-n.m02;t.m03=r.m03-n.m03;return t};Dt.sub=function e(t,r,n){return Dt.subtract(t,r,n)};Dt.exactEquals=function e(t,r){return t.m00===r.m00&&t.m01===r.m01&&t.m02===r.m02&&t.m03===r.m03};Dt.equals=function e(t,r){var n=t.m00,i=t.m01,a=t.m02,o=t.m03;var s=r.m00,l=r.m01,u=r.m02,h=r.m03;return Math.abs(n-s)<=Ve*Math.max(1,Math.abs(n),Math.abs(s))&&Math.abs(i-l)<=Ve*Math.max(1,Math.abs(i),Math.abs(l))&&Math.abs(a-u)<=Ve*Math.max(1,Math.abs(a),Math.abs(u))&&Math.abs(o-h)<=Ve*Math.max(1,Math.abs(o),Math.abs(h))};Dt.multiplyScalar=function e(t,r,n){t.m00=r.m00*n;t.m01=r.m01*n;t.m02=r.m02*n;t.m03=r.m03*n;return t};Dt.multiplyScalarAndAdd=function e(t,r,n,i){t.m00=r.m00+n.m00*i;t.m01=r.m01+n.m01*i;t.m02=r.m02+n.m02*i;t.m03=r.m03+n.m03*i;return t};var Ot=function e(t,r,n,i,a,o){this.m00=t;this.m01=r;this.m02=n;this.m03=i;this.m04=a;this.m05=o};Ot.create=function e(){return new Ot(1,0,0,1,0,0)};Ot.new=function e(t,r,n,i,a,o){return new Ot(t,r,n,i,a,o)};Ot.clone=function e(t){return new Ot(t.m00,t.m01,t.m02,t.m03,t.m04,t.m05)};Ot.copy=function e(t,r){t.m00=r.m00;t.m01=r.m01;t.m02=r.m02;t.m03=r.m03;t.m04=r.m04;t.m05=r.m05;return t};Ot.identity=function e(t){t.m00=1;t.m01=0;t.m02=0;t.m03=1;t.m04=0;t.m05=0;return t};Ot.set=function e(t,r,n,i,a,o,s){t.m00=r;t.m01=n;t.m02=i;t.m03=a;t.m04=o;t.m05=s;return t};Ot.invert=function e(t,r){var n=r.m00,i=r.m01,a=r.m02,o=r.m03,s=r.m04,l=r.m05;var u=n*o-i*a;if(!u){return null}u=1/u;t.m00=o*u;t.m01=-i*u;t.m02=-a*u;t.m03=n*u;t.m04=(a*l-o*s)*u;t.m05=(i*s-n*l)*u;return t};Ot.determinant=function e(t){return t.m00*t.m03-t.m01*t.m02};Ot.multiply=function e(t,r,n){var i=r.m00,a=r.m01,o=r.m02,s=r.m03,l=r.m04,u=r.m05,h=n.m00,c=n.m01,f=n.m02,p=n.m03,d=n.m04,v=n.m05;t.m00=i*h+o*c;t.m01=a*h+s*c;t.m02=i*f+o*p;t.m03=a*f+s*p;t.m04=i*d+o*v+l;t.m05=a*d+s*v+u;return t};Ot.mul=function e(t,r,n){return Ot.multiply(t,r,n)};Ot.rotate=function e(t,r,n){var i=r.m00,a=r.m01,o=r.m02,s=r.m03,l=r.m04,u=r.m05,h=Math.sin(n),c=Math.cos(n);t.m00=i*c+o*h;t.m01=a*c+s*h;t.m02=i*-h+o*c;t.m03=a*-h+s*c;t.m04=l;t.m05=u;return t};Ot.scale=function e(t,r,n){var i=r.m00,a=r.m01,o=r.m02,s=r.m03,l=r.m04,u=r.m05,h=n.x,c=n.y;t.m00=i*h;t.m01=a*h;t.m02=o*c;t.m03=s*c;t.m04=l;t.m05=u;return t};Ot.translate=function e(t,r,n){var i=r.m00,a=r.m01,o=r.m02,s=r.m03,l=r.m04,u=r.m05,h=n.x,c=n.y;t.m00=i;t.m01=a;t.m02=o;t.m03=s;t.m04=i*h+o*c+l;t.m05=a*h+s*c+u;return t};Ot.fromRotation=function e(t,r){var n=Math.sin(r),i=Math.cos(r);t.m00=i;t.m01=n;t.m02=-n;t.m03=i;t.m04=0;t.m05=0;return t};Ot.fromScaling=function e(t,r){t.m00=r.m00;t.m01=0;t.m02=0;t.m03=r.m01;t.m04=0;t.m05=0;return t};Ot.fromTranslation=function e(t,r){t.m00=1;t.m01=0;t.m02=0;t.m03=1;t.m04=r.x;t.m05=r.y;return t};Ot.fromRTS=function e(t,r,n,i){var a=Math.sin(r),o=Math.cos(r);t.m00=o*i.x;t.m01=a*i.x;t.m02=-a*i.y;t.m03=o*i.y;t.m04=n.x;t.m05=n.y;return t};Ot.str=function e(t){return"mat23("+t.m00+", "+t.m01+", "+t.m02+", "+t.m03+", "+t.m04+", "+t.m05+")"};Ot.array=function e(t,r){t[0]=r.m00;t[1]=r.m01;t[2]=r.m02;t[3]=r.m03;t[4]=r.m04;t[5]=r.m05;return t};Ot.array4x4=function e(t,r){t[0]=r.m00;t[1]=r.m01;t[2]=0;t[3]=0;t[4]=r.m02;t[5]=r.m03;t[6]=0;t[7]=0;t[8]=0;t[9]=0;t[10]=1;t[11]=0;t[12]=r.m04;t[13]=r.m05;t[14]=0;t[15]=1;return t};Ot.frob=function e(t){return Math.sqrt(Math.pow(t.m00,2)+Math.pow(t.m01,2)+Math.pow(t.m02,2)+Math.pow(t.m03,2)+Math.pow(t.m04,2)+Math.pow(t.m05,2)+1)};Ot.add=function e(t,r,n){t.m00=r.m00+n.m00;t.m01=r.m01+n.m01;t.m02=r.m02+n.m02;t.m03=r.m03+n.m03;t.m04=r.m04+n.m04;t.m05=r.m05+n.m05;return t};Ot.subtract=function e(t,r,n){t.m00=r.m00-n.m00;t.m01=r.m01-n.m01;t.m02=r.m02-n.m02;t.m03=r.m03-n.m03;t.m04=r.m04-n.m04;t.m05=r.m05-n.m05;return t};Ot.sub=function e(t,r,n){return Ot.subtract(t,r,n)};Ot.multiplyScalar=function e(t,r,n){t.m00=r.m00*n;t.m01=r.m01*n;t.m02=r.m02*n;t.m03=r.m03*n;t.m04=r.m04*n;t.m05=r.m05*n;return t};Ot.multiplyScalarAndAdd=function e(t,r,n,i){t.m00=r.m00+n.m00*i;t.m01=r.m01+n.m01*i;t.m02=r.m02+n.m02*i;t.m03=r.m03+n.m03*i;t.m04=r.m04+n.m04*i;t.m05=r.m05+n.m05*i;return t};Ot.exactEquals=function e(t,r){return t.m00===r.m00&&t.m01===r.m01&&t.m02===r.m02&&t.m03===r.m03&&t.m04===r.m04&&t.m05===r.m05};Ot.equals=function e(t,r){var n=t.m00,i=t.m01,a=t.m02,o=t.m03,s=t.m04,l=t.m05;var u=r.m00,h=r.m01,c=r.m02,f=r.m03,p=r.m04,d=r.m05;return Math.abs(n-u)<=Ve*Math.max(1,Math.abs(n),Math.abs(u))&&Math.abs(i-h)<=Ve*Math.max(1,Math.abs(i),Math.abs(h))&&Math.abs(a-c)<=Ve*Math.max(1,Math.abs(a),Math.abs(c))&&Math.abs(o-f)<=Ve*Math.max(1,Math.abs(o),Math.abs(f))&&Math.abs(s-p)<=Ve*Math.max(1,Math.abs(s),Math.abs(p))&&Math.abs(l-d)<=Ve*Math.max(1,Math.abs(l),Math.abs(d))};var Bt=function e(t,r,n,i,a,o,s,l,u,h,c,f,p,d,v,m){this.m00=t;this.m01=r;this.m02=n;this.m03=i;this.m04=a;this.m05=o;this.m06=s;this.m07=l;this.m08=u;this.m09=h;this.m10=c;this.m11=f;this.m12=p;this.m13=d;this.m14=v;this.m15=m};Bt.new=function e(t,r,n,i,a,o,s,l,u,h,c,f,p,d,v,m){return new Bt(t,r,n,i,a,o,s,l,u,h,c,f,p,d,v,m)};Bt.create=function e(){return new Bt(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1)};Bt.clone=function e(t){return new Bt(t.m00,t.m01,t.m02,t.m03,t.m04,t.m05,t.m06,t.m07,t.m08,t.m09,t.m10,t.m11,t.m12,t.m13,t.m14,t.m15)};Bt.copy=function e(t,r){t.m00=r.m00;t.m01=r.m01;t.m02=r.m02;t.m03=r.m03;t.m04=r.m04;t.m05=r.m05;t.m06=r.m06;t.m07=r.m07;t.m08=r.m08;t.m09=r.m09;t.m10=r.m10;t.m11=r.m11;t.m12=r.m12;t.m13=r.m13;t.m14=r.m14;t.m15=r.m15;return t};Bt.set=function e(t,r,n,i,a,o,s,l,u,h,c,f,p,d,v,m,_){t.m00=r;t.m01=n;t.m02=i;t.m03=a;t.m04=o;t.m05=s;t.m06=l;t.m07=u;t.m08=h;t.m09=c;t.m10=f;t.m11=p;t.m12=d;t.m13=v;t.m14=m;t.m15=_;return t};Bt.identity=function e(t){t.m00=1;t.m01=0;t.m02=0;t.m03=0;t.m04=0;t.m05=1;t.m06=0;t.m07=0;t.m08=0;t.m09=0;t.m10=1;t.m11=0;t.m12=0;t.m13=0;t.m14=0;t.m15=1;return t};Bt.transpose=function e(t,r){if(t===r){var n=r.m01,i=r.m02,a=r.m03,o=r.m06,s=r.m07,l=r.m11;t.m01=r.m04;t.m02=r.m08;t.m03=r.m12;t.m04=n;t.m06=r.m09;t.m07=r.m13;t.m08=i;t.m09=o;t.m11=r.m14;t.m12=a;t.m13=s;t.m14=l}else{t.m00=r.m00;t.m01=r.m04;t.m02=r.m08;t.m03=r.m12;t.m04=r.m01;t.m05=r.m05;t.m06=r.m09;t.m07=r.m13;t.m08=r.m02;t.m09=r.m06;t.m10=r.m10;t.m11=r.m14;t.m12=r.m03;t.m13=r.m07;t.m14=r.m11;t.m15=r.m15}return t};Bt.invert=function e(t,r){var n=r.m00,i=r.m01,a=r.m02,o=r.m03,s=r.m04,l=r.m05,u=r.m06,h=r.m07,c=r.m08,f=r.m09,p=r.m10,d=r.m11,v=r.m12,m=r.m13,_=r.m14,g=r.m15;var y=n*l-i*s;var x=n*u-a*s;var b=n*h-o*s;var w=i*u-a*l;var T=i*h-o*l;var E=a*h-o*u;var S=c*m-f*v;var M=c*_-p*v;var A=c*g-d*v;var R=f*_-p*m;var L=f*g-d*m;var C=p*g-d*_;var I=y*C-x*L+b*R+w*A-T*M+E*S;if(!I){return null}I=1/I;t.m00=(l*C-u*L+h*R)*I;t.m01=(a*L-i*C-o*R)*I;t.m02=(m*E-_*T+g*w)*I;t.m03=(p*T-f*E-d*w)*I;t.m04=(u*A-s*C-h*M)*I;t.m05=(n*C-a*A+o*M)*I;t.m06=(_*b-v*E-g*x)*I;t.m07=(c*E-p*b+d*x)*I;t.m08=(s*L-l*A+h*S)*I;t.m09=(i*A-n*L-o*S)*I;t.m10=(v*T-m*b+g*y)*I;t.m11=(f*b-c*T-d*y)*I;t.m12=(l*M-s*R-u*S)*I;t.m13=(n*R-i*M+a*S)*I;t.m14=(m*x-v*w-_*y)*I;t.m15=(c*w-f*x+p*y)*I;return t};Bt.adjoint=function e(t,r){var n=r.m00,i=r.m01,a=r.m02,o=r.m03,s=r.m04,l=r.m05,u=r.m06,h=r.m07,c=r.m08,f=r.m09,p=r.m10,d=r.m11,v=r.m12,m=r.m13,_=r.m14,g=r.m15;t.m00=l*(p*g-d*_)-f*(u*g-h*_)+m*(u*d-h*p);t.m01=-(i*(p*g-d*_)-f*(a*g-o*_)+m*(a*d-o*p));t.m02=i*(u*g-h*_)-l*(a*g-o*_)+m*(a*h-o*u);t.m03=-(i*(u*d-h*p)-l*(a*d-o*p)+f*(a*h-o*u));t.m04=-(s*(p*g-d*_)-c*(u*g-h*_)+v*(u*d-h*p));t.m05=n*(p*g-d*_)-c*(a*g-o*_)+v*(a*d-o*p);t.m06=-(n*(u*g-h*_)-s*(a*g-o*_)+v*(a*h-o*u));t.m07=n*(u*d-h*p)-s*(a*d-o*p)+c*(a*h-o*u);t.m08=s*(f*g-d*m)-c*(l*g-h*m)+v*(l*d-h*f);t.m09=-(n*(f*g-d*m)-c*(i*g-o*m)+v*(i*d-o*f));t.m10=n*(l*g-h*m)-s*(i*g-o*m)+v*(i*h-o*l);t.m11=-(n*(l*d-h*f)-s*(i*d-o*f)+c*(i*h-o*l));t.m12=-(s*(f*_-p*m)-c*(l*_-u*m)+v*(l*p-u*f));t.m13=n*(f*_-p*m)-c*(i*_-a*m)+v*(i*p-a*f);t.m14=-(n*(l*_-u*m)-s*(i*_-a*m)+v*(i*u-a*l));t.m15=n*(l*p-u*f)-s*(i*p-a*f)+c*(i*u-a*l);return t};Bt.determinant=function e(t){var r=t.m00,n=t.m01,i=t.m02,a=t.m03,o=t.m04,s=t.m05,l=t.m06,u=t.m07,h=t.m08,c=t.m09,f=t.m10,p=t.m11,d=t.m12,v=t.m13,m=t.m14,_=t.m15;var g=r*s-n*o;var y=r*l-i*o;var x=r*u-a*o;var b=n*l-i*s;var w=n*u-a*s;var T=i*u-a*l;var E=h*v-c*d;var S=h*m-f*d;var M=h*_-p*d;var A=c*m-f*v;var R=c*_-p*v;var L=f*_-p*m;return g*L-y*R+x*A+b*M-w*S+T*E};Bt.multiply=function e(t,r,n){var i=r.m00,a=r.m01,o=r.m02,s=r.m03,l=r.m04,u=r.m05,h=r.m06,c=r.m07,f=r.m08,p=r.m09,d=r.m10,v=r.m11,m=r.m12,_=r.m13,g=r.m14,y=r.m15;var x=n.m00,b=n.m01,w=n.m02,T=n.m03;t.m00=x*i+b*l+w*f+T*m;t.m01=x*a+b*u+w*p+T*_;t.m02=x*o+b*h+w*d+T*g;t.m03=x*s+b*c+w*v+T*y;x=n.m04;b=n.m05;w=n.m06;T=n.m07;t.m04=x*i+b*l+w*f+T*m;t.m05=x*a+b*u+w*p+T*_;t.m06=x*o+b*h+w*d+T*g;t.m07=x*s+b*c+w*v+T*y;x=n.m08;b=n.m09;w=n.m10;T=n.m11;t.m08=x*i+b*l+w*f+T*m;t.m09=x*a+b*u+w*p+T*_;t.m10=x*o+b*h+w*d+T*g;t.m11=x*s+b*c+w*v+T*y;x=n.m12;b=n.m13;w=n.m14;T=n.m15;t.m12=x*i+b*l+w*f+T*m;t.m13=x*a+b*u+w*p+T*_;t.m14=x*o+b*h+w*d+T*g;t.m15=x*s+b*c+w*v+T*y;return t};Bt.mul=function e(t,r,n){return Bt.multiply(t,r,n)};Bt.translate=function e(t,r,n){var i=n.x,a=n.y,o=n.z,s,l,u,h,c,f,p,d,v,m,_,g;if(r===t){t.m12=r.m00*i+r.m04*a+r.m08*o+r.m12;t.m13=r.m01*i+r.m05*a+r.m09*o+r.m13;t.m14=r.m02*i+r.m06*a+r.m10*o+r.m14;t.m15=r.m03*i+r.m07*a+r.m11*o+r.m15}else{s=r.m00;l=r.m01;u=r.m02;h=r.m03;c=r.m04;f=r.m05;p=r.m06;d=r.m07;v=r.m08;m=r.m09;_=r.m10;g=r.m11;t.m00=s;t.m01=l;t.m02=u;t.m03=h;t.m04=c;t.m05=f;t.m06=p;t.m07=d;t.m08=v;t.m09=m;t.m10=_;t.m11=g;t.m12=s*i+c*a+v*o+r.m12;t.m13=l*i+f*a+m*o+r.m13;t.m14=u*i+p*a+_*o+r.m14;t.m15=h*i+d*a+g*o+r.m15}return t};Bt.scale=function e(t,r,n){var i=n.x,a=n.y,o=n.z;t.m00=r.m00*i;t.m01=r.m01*i;t.m02=r.m02*i;t.m03=r.m03*i;t.m04=r.m04*a;t.m05=r.m05*a;t.m06=r.m06*a;t.m07=r.m07*a;t.m08=r.m08*o;t.m09=r.m09*o;t.m10=r.m10*o;t.m11=r.m11*o;t.m12=r.m12;t.m13=r.m13;t.m14=r.m14;t.m15=r.m15;return t};Bt.rotate=function e(t,r,n,i){var a=i.x,o=i.y,s=i.z;var l,u,h,c,f,p,d,v,m,_,g,y,x,b,w,T,E,S,M,A,R,L,C,I;var U=Math.sqrt(a*a+o*o+s*s);if(Math.abs(U)<Ve){return null}U=1/U;a*=U;o*=U;s*=U;l=Math.sin(n);u=Math.cos(n);h=1-u;c=r.m00;f=r.m01;p=r.m02;d=r.m03;v=r.m04;m=r.m05;_=r.m06;g=r.m07;y=r.m08;x=r.m09;b=r.m10;w=r.m11;T=a*a*h+u;E=o*a*h+s*l;S=s*a*h-o*l;M=a*o*h-s*l;A=o*o*h+u;R=s*o*h+a*l;L=a*s*h+o*l;C=o*s*h-a*l;I=s*s*h+u;t.m00=c*T+v*E+y*S;t.m01=f*T+m*E+x*S;t.m02=p*T+_*E+b*S;t.m03=d*T+g*E+w*S;t.m04=c*M+v*A+y*R;t.m05=f*M+m*A+x*R;t.m06=p*M+_*A+b*R;t.m07=d*M+g*A+w*R;t.m08=c*L+v*C+y*I;t.m09=f*L+m*C+x*I;t.m10=p*L+_*C+b*I;t.m11=d*L+g*C+w*I;if(r!==t){t.m12=r.m12;t.m13=r.m13;t.m14=r.m14;t.m15=r.m15}return t};Bt.rotateX=function e(t,r,n){var i=Math.sin(n),a=Math.cos(n),o=r.m04,s=r.m05,l=r.m06,u=r.m07,h=r.m08,c=r.m09,f=r.m10,p=r.m11;if(r!==t){t.m00=r.m00;t.m01=r.m01;t.m02=r.m02;t.m03=r.m03;t.m12=r.m12;t.m13=r.m13;t.m14=r.m14;t.m15=r.m15}t.m04=o*a+h*i;t.m05=s*a+c*i;t.m06=l*a+f*i;t.m07=u*a+p*i;t.m08=h*a-o*i;t.m09=c*a-s*i;t.m10=f*a-l*i;t.m11=p*a-u*i;return t};Bt.rotateY=function e(t,r,n){var i=Math.sin(n),a=Math.cos(n),o=r.m00,s=r.m01,l=r.m02,u=r.m03,h=r.m08,c=r.m09,f=r.m10,p=r.m11;if(r!==t){t.m04=r.m04;t.m05=r.m05;t.m06=r.m06;t.m07=r.m07;t.m12=r.m12;t.m13=r.m13;t.m14=r.m14;t.m15=r.m15}t.m00=o*a-h*i;t.m01=s*a-c*i;t.m02=l*a-f*i;t.m03=u*a-p*i;t.m08=o*i+h*a;t.m09=s*i+c*a;t.m10=l*i+f*a;t.m11=u*i+p*a;return t};Bt.rotateZ=function e(t,r,n){var i=Math.sin(n),a=Math.cos(n),o=r.m00,s=r.m01,l=r.m02,u=r.m03,h=r.m04,c=r.m05,f=r.m06,p=r.m07;if(r!==t){t.m08=r.m08;t.m09=r.m09;t.m10=r.m10;t.m11=r.m11;t.m12=r.m12;t.m13=r.m13;t.m14=r.m14;t.m15=r.m15}t.m00=o*a+h*i;t.m01=s*a+c*i;t.m02=l*a+f*i;t.m03=u*a+p*i;t.m04=h*a-o*i;t.m05=c*a-s*i;t.m06=f*a-l*i;t.m07=p*a-u*i;return t};Bt.fromTranslation=function e(t,r){t.m00=1;t.m01=0;t.m02=0;t.m03=0;t.m04=0;t.m05=1;t.m06=0;t.m07=0;t.m08=0;t.m09=0;t.m10=1;t.m11=0;t.m12=r.x;t.m13=r.y;t.m14=r.z;t.m15=1;return t};Bt.fromScaling=function e(t,r){t.m00=r.x;t.m01=0;t.m02=0;t.m03=0;t.m04=0;t.m05=r.y;t.m06=0;t.m07=0;t.m08=0;t.m09=0;t.m10=r.z;t.m11=0;t.m12=0;t.m13=0;t.m14=0;t.m15=1;return t};Bt.fromRotation=function e(t,r,n){var i=n.x,a=n.y,o=n.z;var s=Math.sqrt(i*i+a*a+o*o);var l,u,h;if(Math.abs(s)<Ve){return null}s=1/s;i*=s;a*=s;o*=s;l=Math.sin(r);u=Math.cos(r);h=1-u;t.m00=i*i*h+u;t.m01=a*i*h+o*l;t.m02=o*i*h-a*l;t.m03=0;t.m04=i*a*h-o*l;t.m05=a*a*h+u;t.m06=o*a*h+i*l;t.m07=0;t.m08=i*o*h+a*l;t.m09=a*o*h-i*l;t.m10=o*o*h+u;t.m11=0;t.m12=0;t.m13=0;t.m14=0;t.m15=1;return t};Bt.fromXRotation=function e(t,r){var n=Math.sin(r),i=Math.cos(r);t.m00=1;t.m01=0;t.m02=0;t.m03=0;t.m04=0;t.m05=i;t.m06=n;t.m07=0;t.m08=0;t.m09=-n;t.m10=i;t.m11=0;t.m12=0;t.m13=0;t.m14=0;t.m15=1;return t};Bt.fromYRotation=function e(t,r){var n=Math.sin(r),i=Math.cos(r);t.m00=i;t.m01=0;t.m02=-n;t.m03=0;t.m04=0;t.m05=1;t.m06=0;t.m07=0;t.m08=n;t.m09=0;t.m10=i;t.m11=0;t.m12=0;t.m13=0;t.m14=0;t.m15=1;return t};Bt.fromZRotation=function e(t,r){var n=Math.sin(r),i=Math.cos(r);t.m00=i;t.m01=n;t.m02=0;t.m03=0;t.m04=-n;t.m05=i;t.m06=0;t.m07=0;t.m08=0;t.m09=0;t.m10=1;t.m11=0;t.m12=0;t.m13=0;t.m14=0;t.m15=1;return t};Bt.fromRT=function e(t,r,n){var i=r.x,a=r.y,o=r.z,s=r.w;var l=i+i;var u=a+a;var h=o+o;var c=i*l;var f=i*u;var p=i*h;var d=a*u;var v=a*h;var m=o*h;var _=s*l;var g=s*u;var y=s*h;t.m00=1-(d+m);t.m01=f+y;t.m02=p-g;t.m03=0;t.m04=f-y;t.m05=1-(c+m);t.m06=v+_;t.m07=0;t.m08=p+g;t.m09=v-_;t.m10=1-(c+d);t.m11=0;t.m12=n.x;t.m13=n.y;t.m14=n.z;t.m15=1;return t};Bt.getTranslation=function e(t,r){t.x=r.m12;t.y=r.m13;t.z=r.m14;return t};Bt.getScaling=function e(t,r){var n=r.m00,i=r.m01,a=r.m02,o=r.m04,s=r.m05,l=r.m06,u=r.m08,h=r.m09,c=r.m10;t.x=Math.sqrt(n*n+i*i+a*a);t.y=Math.sqrt(o*o+s*s+l*l);t.z=Math.sqrt(u*u+h*h+c*c);return t};Bt.getRotation=function e(t,r){var n=r.m00+r.m05+r.m10;var i=0;if(n>0){i=Math.sqrt(n+1)*2;t.w=.25*i;t.x=(r.m06-r.m09)/i;t.y=(r.m08-r.m02)/i;t.z=(r.m01-r.m04)/i}else if(r.m00>r.m05&r.m00>r.m10){i=Math.sqrt(1+r.m00-r.m05-r.m10)*2;t.w=(r.m06-r.m09)/i;t.x=.25*i;t.y=(r.m01+r.m04)/i;t.z=(r.m08+r.m02)/i}else if(r.m05>r.m10){i=Math.sqrt(1+r.m05-r.m00-r.m10)*2;t.w=(r.m08-r.m02)/i;t.x=(r.m01+r.m04)/i;t.y=.25*i;t.z=(r.m06+r.m09)/i}else{i=Math.sqrt(1+r.m10-r.m00-r.m05)*2;t.w=(r.m01-r.m04)/i;t.x=(r.m08+r.m02)/i;t.y=(r.m06+r.m09)/i;t.z=.25*i}return t};Bt.fromRTS=function e(t,r,n,i){var a=r.x,o=r.y,s=r.z,l=r.w;var u=a+a;var h=o+o;var c=s+s;var f=a*u;var p=a*h;var d=a*c;var v=o*h;var m=o*c;var _=s*c;var g=l*u;var y=l*h;var x=l*c;var b=i.x;var w=i.y;var T=i.z;t.m00=(1-(v+_))*b;t.m01=(p+x)*b;t.m02=(d-y)*b;t.m03=0;t.m04=(p-x)*w;t.m05=(1-(f+_))*w;t.m06=(m+g)*w;t.m07=0;t.m08=(d+y)*T;t.m09=(m-g)*T;t.m10=(1-(f+v))*T;t.m11=0;t.m12=n.x;t.m13=n.y;t.m14=n.z;t.m15=1;return t};Bt.fromRTSOrigin=function e(t,r,n,i,a){var o=r.x,s=r.y,l=r.z,u=r.w;var h=o+o;var c=s+s;var f=l+l;var p=o*h;var d=o*c;var v=o*f;var m=s*c;var _=s*f;var g=l*f;var y=u*h;var x=u*c;var b=u*f;var w=i.x;var T=i.y;var E=i.z;var S=a.x;var M=a.y;var A=a.z;t.m00=(1-(m+g))*w;t.m01=(d+b)*w;t.m02=(v-x)*w;t.m03=0;t.m04=(d-b)*T;t.m05=(1-(p+g))*T;t.m06=(_+y)*T;t.m07=0;t.m08=(v+x)*E;t.m09=(_-y)*E;t.m10=(1-(p+m))*E;t.m11=0;t.m12=n.x+S-(t.m00*S+t.m04*M+t.m08*A);t.m13=n.y+M-(t.m01*S+t.m05*M+t.m09*A);t.m14=n.z+A-(t.m02*S+t.m06*M+t.m10*A);t.m15=1;return t};Bt.fromQuat=function e(t,r){var n=r.x,i=r.y,a=r.z,o=r.w;var s=n+n;var l=i+i;var u=a+a;var h=n*s;var c=i*s;var f=i*l;var p=a*s;var d=a*l;var v=a*u;var m=o*s;var _=o*l;var g=o*u;t.m00=1-f-v;t.m01=c+g;t.m02=p-_;t.m03=0;t.m04=c-g;t.m05=1-h-v;t.m06=d+m;t.m07=0;t.m08=p+_;t.m09=d-m;t.m10=1-h-f;t.m11=0;t.m12=0;t.m13=0;t.m14=0;t.m15=1;return t};Bt.frustum=function e(t,r,n,i,a,o,s){var l=1/(n-r);var u=1/(a-i);var h=1/(o-s);t.m00=o*2*l;t.m01=0;t.m02=0;t.m03=0;t.m04=0;t.m05=o*2*u;t.m06=0;t.m07=0;t.m08=(n+r)*l;t.m09=(a+i)*u;t.m10=(s+o)*h;t.m11=-1;t.m12=0;t.m13=0;t.m14=s*o*2*h;t.m15=0;return t};Bt.perspective=function e(t,r,n,i,a){var o=1/Math.tan(r/2);var s=1/(i-a);t.m00=o/n;t.m01=0;t.m02=0;t.m03=0;t.m04=0;t.m05=o;t.m06=0;t.m07=0;t.m08=0;t.m09=0;t.m10=(a+i)*s;t.m11=-1;t.m12=0;t.m13=0;t.m14=2*a*i*s;t.m15=0;return t};Bt.perspectiveFromFieldOfView=function e(t,r,n,i){var a=Math.tan(r.upDegrees*Math.PI/180);var o=Math.tan(r.downDegrees*Math.PI/180);var s=Math.tan(r.leftDegrees*Math.PI/180);var l=Math.tan(r.rightDegrees*Math.PI/180);var u=2/(s+l);var h=2/(a+o);t.m00=u;t.m01=0;t.m02=0;t.m03=0;t.m04=0;t.m05=h;t.m06=0;t.m07=0;t.m08=-((s-l)*u*.5);t.m09=(a-o)*h*.5;t.m10=i/(n-i);t.m11=-1;t.m12=0;t.m13=0;t.m14=i*n/(n-i);t.m15=0;return t};Bt.ortho=function e(t,r,n,i,a,o,s){var l=1/(r-n);var u=1/(i-a);var h=1/(o-s);t.m00=-2*l;t.m01=0;t.m02=0;t.m03=0;t.m04=0;t.m05=-2*u;t.m06=0;t.m07=0;t.m08=0;t.m09=0;t.m10=2*h;t.m11=0;t.m12=(r+n)*l;t.m13=(a+i)*u;t.m14=(s+o)*h;t.m15=1;return t};Bt.lookAt=function e(t,r,n,i){var a,o,s,l,u,h,c,f,p,d;var v=r.x;var m=r.y;var _=r.z;var g=i.x;var y=i.y;var x=i.z;var b=n.x;var w=n.y;var T=n.z;c=v-b;f=m-w;p=_-T;d=1/Math.sqrt(c*c+f*f+p*p);c*=d;f*=d;p*=d;a=y*p-x*f;o=x*c-g*p;s=g*f-y*c;d=1/Math.sqrt(a*a+o*o+s*s);a*=d;o*=d;s*=d;l=f*s-p*o;u=p*a-c*s;h=c*o-f*a;t.m00=a;t.m01=l;t.m02=c;t.m03=0;t.m04=o;t.m05=u;t.m06=f;t.m07=0;t.m08=s;t.m09=h;t.m10=p;t.m11=0;t.m12=-(a*v+o*m+s*_);t.m13=-(l*v+u*m+h*_);t.m14=-(c*v+f*m+p*_);t.m15=1;return t};Bt.str=function e(t){return"mat4("+t.m00+", "+t.m01+", "+t.m02+", "+t.m03+", "+t.m04+", "+t.m05+", "+t.m06+", "+t.m07+", "+t.m08+", "+t.m09+", "+t.m10+", "+t.m11+", "+t.m12+", "+t.m13+", "+t.m14+", "+t.m15+")"};Bt.array=function e(t,r){t[0]=r.m00;t[1]=r.m01;t[2]=r.m02;t[3]=r.m03;t[4]=r.m04;t[5]=r.m05;t[6]=r.m06;t[7]=r.m07;t[8]=r.m08;t[9]=r.m09;t[10]=r.m10;t[11]=r.m11;t[12]=r.m12;t[13]=r.m13;t[14]=r.m14;t[15]=r.m15;return t};Bt.frob=function e(t){return Math.sqrt(Math.pow(t.m00,2)+Math.pow(t.m01,2)+Math.pow(t.m02,2)+Math.pow(t.m03,2)+Math.pow(t.m04,2)+Math.pow(t.m05,2)+Math.pow(t.m06,2)+Math.pow(t.m07,2)+Math.pow(t.m08,2)+Math.pow(t.m09,2)+Math.pow(t.m10,2)+Math.pow(t.m11,2)+Math.pow(t.m12,2)+Math.pow(t.m13,2)+Math.pow(t.m14,2)+Math.pow(t.m15,2))};Bt.add=function e(t,r,n){t.m00=r.m00+n.m00;t.m01=r.m01+n.m01;t.m02=r.m02+n.m02;t.m03=r.m03+n.m03;t.m04=r.m04+n.m04;t.m05=r.m05+n.m05;t.m06=r.m06+n.m06;t.m07=r.m07+n.m07;t.m08=r.m08+n.m08;t.m09=r.m09+n.m09;t.m10=r.m10+n.m10;t.m11=r.m11+n.m11;t.m12=r.m12+n.m12;t.m13=r.m13+n.m13;t.m14=r.m14+n.m14;t.m15=r.m15+n.m15;return t};Bt.subtract=function e(t,r,n){t.m00=r.m00-n.m00;t.m01=r.m01-n.m01;t.m02=r.m02-n.m02;t.m03=r.m03-n.m03;t.m04=r.m04-n.m04;t.m05=r.m05-n.m05;t.m06=r.m06-n.m06;t.m07=r.m07-n.m07;t.m08=r.m08-n.m08;t.m09=r.m09-n.m09;t.m10=r.m10-n.m10;t.m11=r.m11-n.m11;t.m12=r.m12-n.m12;t.m13=r.m13-n.m13;t.m14=r.m14-n.m14;t.m15=r.m15-n.m15;return t};Bt.sub=function e(t,r,n){return Bt.subtract(t,r,n)};Bt.multiplyScalar=function e(t,r,n){t.m00=r.m00*n;t.m01=r.m01*n;t.m02=r.m02*n;t.m03=r.m03*n;t.m04=r.m04*n;t.m05=r.m05*n;t.m06=r.m06*n;t.m07=r.m07*n;t.m08=r.m08*n;t.m09=r.m09*n;t.m10=r.m10*n;t.m11=r.m11*n;t.m12=r.m12*n;t.m13=r.m13*n;t.m14=r.m14*n;t.m15=r.m15*n;return t};Bt.multiplyScalarAndAdd=function e(t,r,n,i){t.m00=r.m00+n.m00*i;t.m01=r.m01+n.m01*i;t.m02=r.m02+n.m02*i;t.m03=r.m03+n.m03*i;t.m04=r.m04+n.m04*i;t.m05=r.m05+n.m05*i;t.m06=r.m06+n.m06*i;t.m07=r.m07+n.m07*i;t.m08=r.m08+n.m08*i;t.m09=r.m09+n.m09*i;t.m10=r.m10+n.m10*i;t.m11=r.m11+n.m11*i;t.m12=r.m12+n.m12*i;t.m13=r.m13+n.m13*i;t.m14=r.m14+n.m14*i;t.m15=r.m15+n.m15*i;return t};Bt.exactEquals=function e(t,r){return t.m00===r.m00&&t.m01===r.m01&&t.m02===r.m02&&t.m03===r.m03&&t.m04===r.m04&&t.m05===r.m05&&t.m06===r.m06&&t.m07===r.m07&&t.m08===r.m08&&t.m09===r.m09&&t.m10===r.m10&&t.m11===r.m11&&t.m12===r.m12&&t.m13===r.m13&&t.m14===r.m14&&t.m15===r.m15};Bt.equals=function e(t,r){var n=t.m00,i=t.m01,a=t.m02,o=t.m03,s=t.m04,l=t.m05,u=t.m06,h=t.m07,c=t.m08,f=t.m09,p=t.m10,d=t.m11,v=t.m12,m=t.m13,_=t.m14,g=t.m15;var y=r.m00,x=r.m01,b=r.m02,w=r.m03,T=r.m04,E=r.m05,S=r.m06,M=r.m07,A=r.m08,R=r.m09,L=r.m10,C=r.m11,I=r.m12,U=r.m13,D=r.m14,O=r.m15;return Math.abs(n-y)<=Ve*Math.max(1,Math.abs(n),Math.abs(y))&&Math.abs(i-x)<=Ve*Math.max(1,Math.abs(i),Math.abs(x))&&Math.abs(a-b)<=Ve*Math.max(1,Math.abs(a),Math.abs(b))&&Math.abs(o-w)<=Ve*Math.max(1,Math.abs(o),Math.abs(w))&&Math.abs(s-T)<=Ve*Math.max(1,Math.abs(s),Math.abs(T))&&Math.abs(l-E)<=Ve*Math.max(1,Math.abs(l),Math.abs(E))&&Math.abs(u-S)<=Ve*Math.max(1,Math.abs(u),Math.abs(S))&&Math.abs(h-M)<=Ve*Math.max(1,Math.abs(h),Math.abs(M))&&Math.abs(c-A)<=Ve*Math.max(1,Math.abs(c),Math.abs(A))&&Math.abs(f-R)<=Ve*Math.max(1,Math.abs(f),Math.abs(R))&&Math.abs(p-L)<=Ve*Math.max(1,Math.abs(p),Math.abs(L))&&Math.abs(d-C)<=Ve*Math.max(1,Math.abs(d),Math.abs(C))&&Math.abs(v-I)<=Ve*Math.max(1,Math.abs(v),Math.abs(I))&&Math.abs(m-U)<=Ve*Math.max(1,Math.abs(m),Math.abs(U))&&Math.abs(_-D)<=Ve*Math.max(1,Math.abs(_),Math.abs(D))&&Math.abs(g-O)<=Ve*Math.max(1,Math.abs(g),Math.abs(O))};var Pt=function e(t,r,n){this.r=t;this.g=r;this.b=n};Pt.new=function e(t,r,n){return new Pt(t,r,n)};Pt.create=function e(){return new Pt(1,1,1)};Pt.clone=function e(t){return new Pt(t.r,t.g,t.b)};Pt.copy=function e(t,r){t.r=r.r;t.g=r.g;t.b=r.b;return t};Pt.set=function e(t,r,n,i){t.r=r;t.g=n;t.b=i;return t};Pt.fromHex=function e(t,r){var n=(r>>16)/255;var i=(r>>8&255)/255;var a=(r&255)/255;t.r=n;t.g=i;t.b=a;return t};Pt.add=function e(t,r,n){t.r=r.r+n.r;t.g=r.g+n.g;t.b=r.b+n.b;return t};Pt.subtract=function e(t,r,n){t.r=r.r-n.r;t.g=r.g-n.g;t.b=r.b-n.b;return t};Pt.sub=function e(t,r,n){return Pt.subtract(t,r,n)};Pt.multiply=function e(t,r,n){t.r=r.r*n.r;t.g=r.g*n.g;t.b=r.b*n.b;return t};Pt.mul=function e(t,r,n){return Pt.multiply(t,r,n)};Pt.divide=function e(t,r,n){t.r=r.r/n.r;t.g=r.g/n.g;t.b=r.b/n.b;return t};Pt.div=function e(t,r,n){return Pt.divide(t,r,n)};Pt.scale=function e(t,r,n){t.r=r.r*n;t.g=r.g*n;t.b=r.b*n;return t};Pt.lerp=function e(t,r,n,i){var a=r.r,o=r.g,s=r.b;t.r=a+i*(n.r-a);t.g=o+i*(n.g-o);t.b=s+i*(n.b-s);return t};Pt.str=function e(t){return"color3("+t.r+", "+t.g+", "+t.b+")"};Pt.array=function e(t,r){t[0]=r.r;t[1]=r.g;t[2]=r.b;return t};Pt.exactEquals=function e(t,r){return t.r===r.r&&t.g===r.g&&t.b===r.b};Pt.equals=function e(t,r){var n=t.r,i=t.g,a=t.b;var o=r.r,s=r.g,l=r.b;return Math.abs(n-o)<=Ve*Math.max(1,Math.abs(n),Math.abs(o))&&Math.abs(i-s)<=Ve*Math.max(1,Math.abs(i),Math.abs(s))&&Math.abs(a-l)<=Ve*Math.max(1,Math.abs(a),Math.abs(l))};Pt.hex=function e(t){return t.r*255<<16|t.g*255<<8|t.b*255};var Ft=function e(t,r,n,i){this.r=t;this.g=r;this.b=n;this.a=i};Ft.new=function e(t,r,n,i){return new Ft(t,r,n,i)};Ft.create=function e(){return new Ft(1,1,1,1)};Ft.clone=function e(t){return new Ft(t.r,t.g,t.b,t.a)};Ft.copy=function e(t,r){t.r=r.r;t.g=r.g;t.b=r.b;t.a=r.a;return t};Ft.set=function e(t,r,n,i,a){t.r=r;t.g=n;t.b=i;t.a=a;return t};Ft.fromHex=function e(t,r){var n=(r>>24)/255;var i=(r>>16&255)/255;var a=(r>>8&255)/255;var o=(r&255)/255;t.r=n;t.g=i;t.b=a;t.a=o;return t};Ft.add=function e(t,r,n){t.r=r.r+n.r;t.g=r.g+n.g;t.b=r.b+n.b;t.a=r.a+n.a;return t};Ft.subtract=function e(t,r,n){t.r=r.r-n.r;t.g=r.g-n.g;t.b=r.b-n.b;t.a=r.a-n.a;return t};Ft.sub=function e(t,r,n){return Ft.subtract(t,r,n)};Ft.multiply=function e(t,r,n){t.r=r.r*n.r;t.g=r.g*n.g;t.b=r.b*n.b;t.a=r.a*n.a;return t};Ft.mul=function e(t,r,n){return Ft.multiply(t,r,n)};Ft.divide=function e(t,r,n){t.r=r.r/n.r;t.g=r.g/n.g;t.b=r.b/n.b;t.a=r.a/n.a;return t};Ft.div=function e(t,r,n){return Ft.divide(t,r,n)};Ft.scale=function e(t,r,n){t.r=r.r*n;t.g=r.g*n;t.b=r.b*n;t.a=r.a*n;return t};Ft.lerp=function e(t,r,n,i){var a=r.r,o=r.g,s=r.b,l=r.a;t.r=a+i*(n.r-a);t.g=o+i*(n.g-o);t.b=s+i*(n.b-s);t.a=l+i*(n.a-l);return t};Ft.str=function e(t){return"color4("+t.r+", "+t.g+", "+t.b+", "+t.a+")"};Ft.array=function e(t,r){t[0]=r.r;t[1]=r.g;t[2]=r.b;t[3]=r.a;return t};Ft.exactEquals=function e(t,r){return t.r===r.r&&t.g===r.g&&t.b===r.b&&t.a===r.a};Ft.equals=function e(t,r){var n=t.r,i=t.g,a=t.b,o=t.a;var s=r.r,l=r.g,u=r.b,h=r.a;return Math.abs(n-s)<=Ve*Math.max(1,Math.abs(n),Math.abs(s))&&Math.abs(i-l)<=Ve*Math.max(1,Math.abs(i),Math.abs(l))&&Math.abs(a-u)<=Ve*Math.max(1,Math.abs(a),Math.abs(u))&&Math.abs(o-h)<=Ve*Math.max(1,Math.abs(o),Math.abs(h))};Ft.hex=function e(t){return(t.r*255<<24|t.g*255<<16|t.b*255<<8|t.a*255)>>>0};var zt=At;var Nt=Object.freeze({bits:zt,vec2:Rt,vec3:Lt,vec4:Ct,quat:Ut,mat2:Dt,mat23:Ot,mat3:It,mat4:Bt,color3:Pt,color4:Ft,EPSILON:Ve,equals:Ge,approx:We,clamp:He,clamp01:je,lerp:qe,toRadian:Xe,toDegree:Ye,random:Ke,randomRange:Ze,randomRangeInt:Qe,pseudoRandom:Je,pseudoRandomRange:$e,pseudoRandomRangeInt:et,nextPow2:tt,repeat:rt,pingPong:nt,inverseLerp:it});function kt(e,t){return Lt.dot(t.n,e)-t.d}function Vt(e,t,r){var n=kt(t,r);return Lt.sub(e,t,Lt.scale(e,r.n,n))}var Gt={point_plane:kt,pt_point_plane:Vt};var Wt=function(){var e=Lt.zero();return function(t,r,n){Gt.pt_point_plane(e,t.o,r);var i=Lt.dot(e,r.n)/Lt.dot(t.d,r.n);var a=i>=0;if(n&&a){Lt.scale(n,t.d,i);Lt.add(n,n,t.o)}return a}}();var Ht=function(){var e=Lt.zero();return function(t,r,n){Lt.sub(e,t.e,t.s);var i=(r.d-Lt.dot(t.s,r.n))/Lt.dot(e,r.n);var a=i>=0&&i<=1;if(n&&a){Lt.scale(n,e,i);Lt.add(n,n,t.s)}return a}}();var jt=function(){var e=Lt.zero();var t=Lt.zero();var r=Lt.zero();var n=Lt.zero();var i=Lt.zero();return function(a,o,s){Lt.sub(e,o.b,o.a);Lt.sub(t,o.c,o.a);Lt.cross(r,a.d,t);var l=Lt.dot(e,r);if(l<=0){return false}Lt.sub(n,a.o,o.a);var u=Lt.dot(n,r);if(u<0||u>l){return false}Lt.cross(i,n,e);var h=Lt.dot(a.d,i);if(h<0||u+h>l){return false}if(s){var c=Lt.dot(t,i)/l;Lt.scaleAndAdd(s,a.o,a.d,c)}return true}}();var qt=function(){var e=Lt.zero();var t=Lt.zero();var r=Lt.zero();var n=Lt.zero();var i=Lt.zero();var a=Lt.zero();return function(o,s,l){Lt.sub(e,s.b,s.a);Lt.sub(t,s.c,s.a);Lt.sub(r,o.s,o.e);Lt.cross(i,e,t);var u=Lt.dot(r,i);if(u<=0){return false}Lt.sub(n,o.s,s.a);var h=Lt.dot(n,i);if(h<0||h>u){return false}Lt.cross(a,r,n);var c=Lt.dot(t,a);if(c<0||c>u){return false}var f=-Lt.dot(e,a);if(f<0||c+f>u){return false}if(l){var p=1/u;c*=p;f*=p;var d=1-c-f;Lt.set(l,s.a.x*d+s.b.x*c+s.c.x*f,s.a.y*d+s.b.y*c+s.c.y*f,s.a.z*d+s.b.z*c+s.c.z*f)}return true}}();var Xt=function(){var e=Lt.zero();var t=Lt.zero();var r=Lt.zero();var n=Lt.zero();var i=Lt.zero();var a=Lt.zero();var o=Lt.zero();return function(s,l,u,h,c,f,p){Lt.sub(e,l,s);Lt.sub(t,u,s);Lt.sub(r,h,s);Lt.sub(n,c,s);Lt.cross(a,n,e);var d=Lt.dot(t,a);if(d>=0){var v=-Lt.dot(r,a);if(v<0){return false}var m=Lt.dot(Lt.cross(o,e,r),t);if(m<0){return false}if(p){var _=1/(v+d+m);v*=_;d*=_;m*=_;Lt.set(p,u.x*v+h.x*d+c.x*m,u.y*v+h.y*d+c.y*m,u.z*v+h.z*d+c.z*m)}}else{Lt.sub(i,f,s);var g=Lt.dot(i,a);if(g<0){return false}var y=Lt.dot(Lt.cross(o,e,t),i);if(y<0){return false}if(p){d=-d;var x=1/(g+d+y);g*=x;d*=x;y*=x;Lt.set(p,u.x*g+f.x*d+c.x*y,u.y*g+f.y*d+c.y*y,u.z*g+f.z*d+c.z*y)}}return true}}();var Yt=function(){var e=Lt.zero();var t=Lt.zero();var r=Lt.zero();var n=Lt.zero();return function(i,a,o){var s=a.r;t=a.c;r=i.o;n=i.d;Lt.sub(e,t,r);var l=Lt.magnitude(e);var u=Lt.dot(e,n)/Lt.magnitude(n);var h=Math.sqrt(a.r*a.r-(l*l-u*u));var c=u-h;if(h<0||c<0||l<a.r){return false}Lt.scale(o,e,(l-s)/l);return true}}();var Kt=function(){var e=Lt.zero();var t=Lt.zero();var r=Lt.zero();var n=Lt.zero();var i=Lt.zero();var a=Lt.zero();var o=Lt.zero();var s=Lt.zero();var l=new Array(3);var u=new Array(3);var h=new Array(3);var c=new Array(6);return function(f,p,d){l[0]=p.size.x;l[1]=p.size.y;l[2]=p.size.z;e=p.center;t=f.o;r=f.d;Lt.set(n,p.orientation.m00,p.orientation.m01,p.orientation.m02);Lt.set(i,p.orientation.m03,p.orientation.m04,p.orientation.m05);Lt.set(a,p.orientation.m06,p.orientation.m07,p.orientation.m08);Lt.sub(o,e,t);u[0]=Lt.dot(n,r);u[1]=Lt.dot(i,r);u[2]=Lt.dot(a,r);h[0]=Lt.dot(n,o);h[1]=Lt.dot(i,o);h[2]=Lt.dot(a,o);for(var v=0;v<3;++v){if(u[v]===0){if(-h[v]-l[v]>0||-h[v]+l[v]<0){return false}u[v]=1e-7}c[v*2+0]=(h[v]+l[v])/u[v];c[v*2+1]=(h[v]-l[v])/u[v]}var m=Math.max(Math.max(Math.min(c[0],c[1]),Math.min(c[2],c[3])),Math.min(c[4],c[5]));var _=Math.min(Math.min(Math.max(c[0],c[1]),Math.max(c[2],c[3])),Math.max(c[4],c[5]));if(_<0||m>_||m<0){return false}Lt.set(s,m*u[0]+t.x,m*u[1]+t.y,m*u[2]+t.z);Lt.transformMat3(d,s,p.orientation);return true}}();var Zt=function(){var e=Lt.zero(),t=It.create();var r=function(e,t){return Math.abs(e.x)<t.x&&Math.abs(e.y)<t.y&&Math.abs(e.z)<t.z};return function(n,i){Lt.sub(e,i,n.center);Lt.transformMat3(e,e,It.transpose(t,n.orientation));return r(e,n.size)}}();var Qt=function(){var e=function(e,t,r,n){return Math.abs(e.x*t+e.y*r+e.z*n)};return function(t,r){var n=t.size.x*e(r.n,t.orientation.m00,t.orientation.m01,t.orientation.m02)+t.size.y*e(r.n,t.orientation.m03,t.orientation.m04,t.orientation.m05)+t.size.z*e(r.n,t.orientation.m06,t.orientation.m07,t.orientation.m08);var i=Lt.dot(r.n,t.center);if(i+n<r.d){return 1}else if(i-n>r.d){return 0}return-1}}();var Jt=function(e,t){for(var r=0;r<t.planes.length;r++){if(Qt(e,t.planes[r])==1){return false}}return true};var $t=function(){var e=new Array(8),t=0,r=0,n=0;for(var i=0;i<e.length;i++){e[i]=Lt.zero()}var a=function(e,t,r,n){return e.x*t+e.y*r+e.z*n};return function(i,o){var s=0,l=false;for(var u=0;u<o.planes.length;u++){s=Qt(i,o.planes[u]);if(s==1){return false}else if(s==-1){l=true}}if(!l){return true}for(var h=0;h<o.vertices.length;h++){Lt.sub(e[h],o.vertices[h],i.center)}r=0,n=0;for(var c=0;c<o.vertices.length;c++){t=a(e[c],i.orientation.m00,i.orientation.m01,i.orientation.m02);if(t>i.size.x){r++}else if(t<-i.size.x){n++}}if(r==o.vertices.length||n==o.vertices.length){return false}r=0;n=0;for(var f=0;f<o.vertices.length;f++){t=a(e[f],i.orientation.m03,i.orientation.m04,i.orientation.m05);if(t>i.size.y){r++}else if(t<-i.size.y){n++}}if(r==o.vertices.length||n==o.vertices.length){return false}r=0;n=0;for(var p=0;p<o.vertices.length;p++){t=a(e[p],i.orientation.m06,i.orientation.m07,i.orientation.m08);if(t>i.size.z){r++}else if(t<-i.size.z){n++}}if(r==o.vertices.length||n==o.vertices.length){return false}return true}}();var er=function(){var e=new Array(15);for(var t=0;t<15;t++){e[t]=Lt.zero()}var r=new Array(8);for(var n=0;n<8;n++){r[n]=Lt.zero()}var i=Lt.zero();var a=Lt.zero();var o=Lt.zero();var s=Lt.zero();return function(t,n){Lt.set(e[0],t.orientation.m00,t.orientation.m01,t.orientation.m02);Lt.set(e[1],t.orientation.m03,t.orientation.m04,t.orientation.m05);Lt.set(e[2],t.orientation.m06,t.orientation.m07,t.orientation.m08);Lt.set(e[3],n.orientation.m00,n.orientation.m01,n.orientation.m02);Lt.set(e[4],n.orientation.m03,n.orientation.m04,n.orientation.m05);Lt.set(e[5],n.orientation.m06,n.orientation.m07,n.orientation.m08);for(var l=0;l<3;++l){Lt.cross(e[6+l*3+0],e[l],e[0]);Lt.cross(e[6+l*3+1],e[l],e[1]);Lt.cross(e[6+l*3+1],e[l],e[2])}for(var u=0;u<15;++u){if(!h(t,n,e[u])){return false}}return true;function h(e,t,r){var n=0;var i=1;var a=c(e,r);var o=c(t,r);return o[n]<=a[i]&&a[n]<=o[i]}function c(e,t){Lt.add(o,e.center,e.size);Lt.sub(s,e.center,e.size);Lt.set(i,Math.min(o.x,s.x),Math.min(o.y,s.y),Math.min(o.z,s.z));Lt.set(a,Math.max(o.x,s.x),Math.max(o.y,s.y),Math.max(o.z,s.z));Lt.set(r[0],i.x,a.y,a.z);Lt.set(r[1],i.x,a.y,i.z);Lt.set(r[2],i.x,i.y,a.z);Lt.set(r[3],i.x,i.y,i.z);Lt.set(r[4],a.x,a.y,a.z);Lt.set(r[5],a.x,a.y,i.z);Lt.set(r[6],a.x,i.y,a.z);Lt.set(r[7],a.x,i.y,i.z);var n=0;var l=0;n=l=Lt.dot(t,r[0]);for(var u=1;u<8;++u){var h=Lt.dot(t,r[u]);n=h<n?h:n;l=h>l?h:l}var c=[n,l];return c}}}();var tr=function(e,t){var r=Lt.dot(t.n,e.c);var n=e.r*Lt.magnitude(t.n);if(r+n<t.d){return 1}else if(r-n>t.d){return 0}return-1};var rr=function(e,t){for(var r=0;r<t.planes.length;r++){if(tr(e,t.planes[r])==1){return false}}return true};var nr=function(){var e=Lt.zero(),t=[1,-1,1,-1,1,-1];var r=[],n=[];return function(i,a){var o=false;r.length=0;n.length=0;for(var s=0;s<a.planes.length;s++){var l=Lt.dot(a.planes[s].n,i.c);var u=Lt.magnitude(a.planes[s].n);var h=i.r*u;n.push(1/u);if(l+h<a.planes[s].d){return false}else if(l-h<a.planes[s].d){o=true;r.push(s)}}if(!o){return true}for(var c=0;c<r.length;c++){Lt.scale(e,a.planes[r[c]].n,i.r*n[r[c]]);Lt.add(e,i.c,e);for(var f=0;f<a.planes.length;f++){if(f==r[c]||f==r[c]+t[f]){continue}if(Lt.dot(a.planes[f].n,e)<a.planes[f].d){return false}}}return true}}();var ir=function(){var e=Lt.zero();var t=Lt.zero();return function(r,n){var i=r.r;var a=n.r;e=r.c;t=n.c;var o=Lt.distance(e,t);if(o>i+a){return false}else{return true}}}();var ar=function(){var e=Lt.zero();var t=Lt.zero();var r=Lt.zero();var n=Lt.zero();var i=Lt.zero();var a=new Array(3);var o=new Array(3);return function(s,l){Lt.set(e,l.orientation.m00,l.orientation.m01,l.orientation.m02);Lt.set(t,l.orientation.m03,l.orientation.m04,l.orientation.m05);Lt.set(r,l.orientation.m06,l.orientation.m07,l.orientation.m08);a[0]=e;a[1]=t;a[2]=r;o[0]=l.size.x;o[1]=l.size.y;o[2]=l.size.z;Lt.sub(n,s.c,l.center);Lt.set(i,l.center.x,l.center.y,l.center.z);for(var u=0;u<3;u++){var h=Lt.dot(n,a[u]);if(h>o[u]){h=o[u]}if(h<-o[u]){h=-o[u]}i.x+=h*a[u].x;i.y+=h*a[u].y;i.z+=h*a[u].z}var c=Lt.distance(i,s.c);return c<s.r}}();var or={ray_plane:Wt,line_plane:Ht,ray_triangle:jt,line_triangle:qt,line_quad:Xt,ray_sphere:Yt,ray_box:Kt,box_point:Zt,box_plane:Qt,box_frustum:Jt,box_frustum_accurate:$t,box_box:er,sphere_plane:tr,sphere_frustum:rr,sphere_frustum_accurate:nr,sphere_sphere:ir,sphere_box:ar};var sr=function e(t,r,n,i,a,o){this.s=Lt.new(t,r,n);this.e=Lt.new(i,a,o)};sr.create=function e(){return new sr(0,0,0,0,0,-1)};sr.new=function e(t,r,n,i,a,o){return new sr(t,r,n,i,a,o)};sr.clone=function e(t){return new sr(t.s.x,t.s.y,t.s.z,t.e.x,t.e.y,t.e.z)};sr.copy=function e(t,r){t.s.x=r.s.x;t.s.y=r.s.y;t.s.z=r.s.z;t.e.x=r.e.x;t.e.y=r.e.y;t.e.z=r.e.z;return t};sr.set=function e(t,r,n,i,a,o,s){t.s.x=r;t.s.y=n;t.s.z=i;t.e.x=a;t.e.y=o;t.e.z=s;return t};sr.magnitude=function e(t){return Lt.distance(t.s,t.e)};sr.mag=function e(t){return t.magnitude(t)};var lr=function e(t,r,n,i){this.n=Lt.new(t,r,n);this.d=i};lr.create=function e(){return new lr(0,1,0,0)};lr.new=function e(t,r,n,i){return new lr(t,r,n,i)};lr.clone=function e(t){return new lr(t.n.x,t.n.y,t.n.z,t.d)};lr.copy=function e(t,r){t.n.x=r.n.x;t.n.y=r.n.y;t.n.z=r.n.z;t.d=r.d;return t};lr.set=function e(t,r,n,i,a){t.n.x=r;t.n.y=n;t.n.z=i;t.d=a;return t};lr.fromNormalAndPoint=function e(t,r,n){Lt.copy(t.n,r);t.d=Lt.dot(r,n);return t};lr.normalize=function e(t,r){var n=Lt.magnitude(r.n);Lt.normalize(t.n,r.n);if(n>0){t.d=r.d/n}return t};lr.fromPoints=function(){var e=Lt.zero();var t=Lt.zero();return function(r,n,i,a){Lt.sub(e,i,n);Lt.sub(t,a,n);Lt.normalize(r.n,Lt.cross(r.n,e,t));r.d=Lt.dot(r.n,n);return r}}();var ur=function e(t,r,n,i,a,o){this.o=Lt.new(t,r,n);this.d=Lt.new(i,a,o)};ur.create=function e(){return new ur(0,0,0,0,0,-1)};ur.new=function e(t,r,n,i,a,o){return new ur(t,r,n,i,a,o)};ur.clone=function e(t){return new ur(t.o.x,t.o.y,t.o.z,t.d.x,t.d.y,t.d.z)};ur.copy=function e(t,r){t.o.x=r.o.x;t.o.y=r.o.y;t.o.z=r.o.z;t.d.x=r.d.x;t.d.y=r.d.y;t.d.z=r.d.z;return t};ur.set=function e(t,r,n,i,a,o,s){t.o.x=r;t.o.y=n;t.o.z=i;t.d.x=a;t.d.y=o;t.d.z=s;return t};ur.fromPoints=function e(t,r,n){Lt.copy(t.o,r);Lt.normalize(t.d,Lt.sub(t.d,n,r));return t};var hr=function e(t,r,n,i,a,o,s,l,u){this.a=Lt.new(t,r,n);this.b=Lt.new(i,a,o);this.c=Lt.new(s,l,u)};hr.create=function e(){return new hr(0,0,0,1,0,0,0,1,0)};hr.new=function e(t,r,n,i,a,o,s,l,u){return new hr(t,r,n,i,a,o,s,l,u)};hr.clone=function e(t){return new hr(t.a.x,t.a.y,t.a.z,t.b.x,t.b.y,t.b.z,t.c.x,t.c.y,t.c.z)};hr.copy=function e(t,r){t.a.x=r.a.x;t.a.y=r.a.y;t.a.z=r.a.z;t.b.x=r.b.x;t.b.y=r.b.y;t.b.z=r.b.z;t.c.x=r.c.x;t.c.y=r.c.y;t.c.z=r.c.z;return t};hr.set=function e(t,r,n,i,a,o,s,l,u,h){t.a.x=r;t.a.y=n;t.a.z=i;t.b.x=a;t.b.y=o;t.b.z=s;t.c.x=l;t.c.y=u;t.c.z=h;return t};var cr=function e(t,r,n,i){this.c=Lt.new(t,r,n);this.r=i};cr.create=function e(){return new cr(0,0,0,1)};cr.new=function e(t,r,n,i){return new cr(t,r,n,i)};cr.clone=function e(t){return new cr(t.c.x,t.c.y,t.c.z,t.r)};cr.copy=function e(t,r){t.c.x=r.c.x;t.c.y=r.c.y;t.c.z=r.c.z;t.r=r.r;return t};cr.set=function e(t,r,n,i,a){t.c.x=r;t.c.y=n;t.c.z=i;t.r=a;return t};var fr=function e(t,r,n,i,a,o,s,l,u,h,c,f,p,d,v){this.center=Lt.new(t,r,n);this.size=Lt.new(i,a,o);this.orientation=It.new(s,l,u,h,c,f,p,d,v)};fr.create=function e(){return new fr(0,0,0,0,0,0,1,0,0,0,1,0,0,0,1)};fr.new=function e(t,r,n,i,a,o,s,l,u,h,c,f,p,d,v){return new fr(t,r,n,i,a,o,s,l,u,h,c,f,p,d,v)};fr.setTransform=function e(t,r,n,i,a){if(a===void 0)a=null;Lt.copy(t.center,r);It.fromQuat(t.orientation,n);Lt.copy(t.size,i);if(a){Lt.add(t.center,t.center,a.center);It.mul(t.orientation,t.orientation,a.orientation);Lt.mul(t.size,t.size,a.size)}return t};fr.clone=function e(t){return new fr(t.center.x,t.center.y,t.center.z,t.size.x,t.size.y,t.size.z,t.orientation.m00,t.orientation.m01,t.orientation.m02,t.orientation.m03,t.orientation.m04,t.orientation.m05,t.orientation.m06,t.orientation.m07,t.orientation.m08)};fr.copy=function e(t,r){t.center=r.center;t.size=r.size;t.orientation=r.orientation;return t};fr.set=function e(t,r,n,i,a,o,s,l,u,h,c,f,p,d,v,m){Lt.set(t.center,r,n,i);Lt.set(t.size,a,o,s);It.set(t.orientation,l,u,h,c,f,p,d,v,m);return t};fr.fromPoints=function(){var e=Lt.zero();var t=Lt.zero();return function(r,n){Lt.scale(e,Lt.add(e,r,n),.5);Lt.scale(t,Lt.sub(t,n,r),.5);return new fr(e.x,e.y,e.z,t.x,t.y,t.z,1,0,0,0,1,0,0,0,1)}}();var pr=function e(){};pr.schema={time:{type:"number",default:0},value:{type:"number",default:0},inTangent:{type:"number",default:0},outTangent:{type:"number",default:0}};var dr=function e(t){this._keyFrames=t};dr.prototype.addKey=function e(t){if(this._keyFrames===null){this._keyFrames=[]}this._keyFrames.push(t)};dr.prototype.evaluate=function e(t){var r=this;var n=t;var i=t<0?this._preWrapMode:this._postWrapMode;var a=this._keyFrames[0].time;var o=this._keyFrames[this._keyFrames.length-1].time;switch(i){case"loop":n=rt(t-a,o-a)+a;break;case"pingPong":n=nt(t-a,o-a)+a;break;case"clampForever":n=He(t,a,o);break}var s=0;if(n>this._keyFrames[0].time){if(n>=this._keyFrames[this._keyFrames.length-1].time){s=this._keyFrames.length-2}else{for(var l=0;l<this._keyFrames.length-1;l++){if(n>=r._keyFrames[0].time&&n<=r._keyFrames[l+1].time){s=l;break}}}}var u=this._keyFrames[s];var h=this._keyFrames[s+1];var c=it(u.time,h.time,n);var f=h.time-u.time;var p=u.outTangent*f;var d=h.inTangent*f;var v=c*c;var m=v*c;var _=2*m-3*v+1;var g=m-2*v+c;var y=m-v;var x=-2*m+3*v;return _*u.value+g*p+y*d+x*h.value};dr.schema={keyFrames:{type:"Keyframe",default:null,array:true},preWrapMode:{type:"enums",default:"default",options:["default","once","loop","pingPong","clampForever"]},postWrapMode:{type:"enums",default:"default",options:["default","once","loop","pingPong","clampForever"]}};var vr=Object.freeze({distance:Gt,intersect:or,line:sr,plane:lr,ray:ur,triangle:hr,sphere:cr,box:fr,Keyframe:pr,AnimationCurve:dr});var mr=Bt.create();var _r=Lt.zero();var gr=0;var yr=function e(){var t=this;this._id=gr++;this._priority=0;this._rect={x:0,y:0,w:1,h:1};this._color=Ft.new(.3,.3,.3,1);this._depth=1;this._stencil=0;this._clearFlags=Ae.CLEAR_COLOR|Ae.CLEAR_DEPTH;this._clearModel=null;this._matView=Bt.create();this._matProj=Bt.create();this._matViewProj=Bt.create();this._matInvViewProj=Bt.create();this._stages=[];this._cullingByID=false;this._framebuffer=null;this._shadowLight=null;this._frustum={};this._frustum.fullUpdate=false;this._frustum.planes=new Array(6);for(var r=0;r<6;++r){t._frustum.planes[r]=lr.create()}this._frustum.vertices=new Array(8);for(var n=0;n<8;++n){t._frustum.vertices[n]=Lt.zero()}};var xr={fullUpdate:{configurable:true}};xr.fullUpdate.set=function(e){this._frustum.fullUpdate=e};yr.prototype.getForward=function e(t){return Lt.set(t,-this._matView.m02,-this._matView.m06,-this._matView.m10)};yr.prototype.getPosition=function e(t){Bt.invert(mr,this._matView);return Bt.getTranslation(t,mr)};yr.prototype.updateFrustum=function e(){var t=this._matViewProj;Lt.set(this._frustum.planes[0].n,t.m03+t.m00,t.m07+t.m04,t.m11+t.m08);this._frustum.planes[0].d=-(t.m15+t.m12);Lt.set(this._frustum.planes[1].n,t.m03-t.m00,t.m07-t.m04,t.m11-t.m08);this._frustum.planes[1].d=-(t.m15-t.m12);Lt.set(this._frustum.planes[2].n,t.m03+t.m01,t.m07+t.m05,t.m11+t.m09);this._frustum.planes[2].d=-(t.m15+t.m13);Lt.set(this._frustum.planes[3].n,t.m03-t.m01,t.m07-t.m05,t.m11-t.m09);this._frustum.planes[3].d=-(t.m15-t.m13);Lt.set(this._frustum.planes[4].n,t.m03+t.m02,t.m07+t.m06,t.m11+t.m10);this._frustum.planes[4].d=-(t.m15+t.m14);Lt.set(this._frustum.planes[5].n,t.m03-t.m02,t.m07-t.m06,t.m11-t.m10);this._frustum.planes[5].d=-(t.m15-t.m14);if(!this._frustum.fullUpdate){return}Lt.set(_r,1,1,1);Lt.transformMat4(this._frustum.vertices[0],_r,this._matInvViewProj);Lt.set(_r,-1,1,1);Lt.transformMat4(this._frustum.vertices[1],_r,this._matInvViewProj);Lt.set(_r,-1,-1,1);Lt.transformMat4(this._frustum.vertices[2],_r,this._matInvViewProj);Lt.set(_r,1,-1,1);Lt.transformMat4(this._frustum.vertices[3],_r,this._matInvViewProj);Lt.set(_r,1,1,-1);Lt.transformMat4(this._frustum.vertices[4],_r,this._matInvViewProj);Lt.set(_r,-1,1,-1);Lt.transformMat4(this._frustum.vertices[5],_r,this._matInvViewProj);Lt.set(_r,-1,-1,-1);Lt.transformMat4(this._frustum.vertices[6],_r,this._matInvViewProj);Lt.set(_r,1,-1,-1);Lt.transformMat4(this._frustum.vertices[7],_r,this._matInvViewProj)};Object.defineProperties(yr.prototype,xr);var br=Lt.new(0,0,-1);var wr=Bt.create();var Tr=It.create();var Er=Lt.zero();function Sr(e,t,r){e._node.getWorldRT(t);Bt.invert(t,t);Bt.perspective(r,e._spotAngle*e._spotAngleScale,1,e._shadowMinDepth,e._shadowMaxDepth)}function Mr(e,t,r){e._node.getWorldRT(t);Bt.invert(t,t);var n=e._shadowFrustumSize/2;Bt.ortho(r,-n,n,-n,n,e._shadowMinDepth,e._shadowMaxDepth)}function Ar(e,t,r){e._node.getWorldRT(t);Bt.invert(t,t);Bt.perspective(r,Xe(179),1,e._shadowMinDepth,e._shadowMaxDepth)}var Rr=function e(){this._poolID=-1;this._node=null;this._type=Ae.LIGHT_DIRECTIONAL;this._color=Pt.new(1,1,1);this._intensity=1;this._range=1;this._spotAngle=Xe(60);this._spotExp=1;this._directionUniform=new Float32Array(3);this._positionUniform=new Float32Array(3);this._colorUniform=new Float32Array([this._color.r*this._intensity,this._color.g*this._intensity,this._color.b*this._intensity]);this._spotUniform=new Float32Array([Math.cos(this._spotAngle*.5),this._spotExp]);this._shadowType=Ae.SHADOW_NONE;this._shadowFrameBuffer=null;this._shadowMap=null;this._shadowMapDirty=false;this._shadowDepthBuffer=null;this._shadowResolution=1024;this._shadowBias=5e-4;this._shadowDarkness=1;this._shadowMinDepth=1;this._shadowMaxDepth=1e3;this._shadowDepthScale=50;this._frustumEdgeFalloff=0;this._viewProjMatrix=Bt.create();this._spotAngleScale=1;this._shadowFrustumSize=50};var Lr={color:{configurable:true},intensity:{configurable:true},type:{configurable:true},spotAngle:{configurable:true},spotExp:{configurable:true},range:{configurable:true},shadowType:{configurable:true},shadowMap:{configurable:true},viewProjMatrix:{configurable:true},shadowResolution:{configurable:true},shadowBias:{configurable:true},shadowDarkness:{configurable:true},shadowMinDepth:{configurable:true},shadowMaxDepth:{configurable:true},shadowDepthScale:{configurable:true},frustumEdgeFalloff:{configurable:true},shadowFrustumSize:{configurable:true}};Rr.prototype.setNode=function e(t){this._node=t};Rr.prototype.setColor=function e(t,r,n){Pt.set(this._color,t,r,n);this._colorUniform[0]=t*this._intensity;this._colorUniform[1]=r*this._intensity;this._colorUniform[2]=n*this._intensity};Lr.color.get=function(){return this._color};Rr.prototype.setIntensity=function e(t){this._intensity=t;this._colorUniform[0]=t*this._color.r;this._colorUniform[1]=t*this._color.g;this._colorUniform[2]=t*this._color.b};Lr.intensity.get=function(){return this._intensity};Rr.prototype.setType=function e(t){this._type=t};Lr.type.get=function(){return this._type};Rr.prototype.setSpotAngle=function e(t){this._spotAngle=t;this._spotUniform[0]=Math.cos(this._spotAngle*.5)};Lr.spotAngle.get=function(){return this._spotAngle};Rr.prototype.setSpotExp=function e(t){this._spotExp=t;this._spotUniform[1]=t};Lr.spotExp.get=function(){return this._spotExp};Rr.prototype.setRange=function e(t){this._range=t};Lr.range.get=function(){return this._range};Rr.prototype.setShadowType=function e(t){if(this._shadowType===Ae.SHADOW_NONE&&t!==Ae.SHADOW_NONE){this._shadowMapDirty=true}this._shadowType=t};Lr.shadowType.get=function(){return this._shadowType};Lr.shadowMap.get=function(){return this._shadowMap};Lr.viewProjMatrix.get=function(){return this._viewProjMatrix};Rr.prototype.setShadowResolution=function e(t){if(this._shadowResolution!==t){this._shadowMapDirty=true}this._shadowResolution=t};Lr.shadowResolution.get=function(){return this._shadowResolution};Rr.prototype.setShadowBias=function e(t){this._shadowBias=t};Lr.shadowBias.get=function(){return this._shadowBias};Rr.prototype.setShadowDarkness=function e(t){this._shadowDarkness=t};Lr.shadowDarkness.get=function(){return this._shadowDarkness};Rr.prototype.setShadowMinDepth=function e(t){this._shadowMinDepth=t};Lr.shadowMinDepth.get=function(){if(this._type===Ae.LIGHT_DIRECTIONAL){return 1}return this._shadowMinDepth};Rr.prototype.setShadowMaxDepth=function e(t){this._shadowMaxDepth=t};Lr.shadowMaxDepth.get=function(){if(this._type===Ae.LIGHT_DIRECTIONAL){return 1}return this._shadowMaxDepth};Rr.prototype.setShadowDepthScale=function e(t){this._shadowDepthScale=t};Lr.shadowDepthScale.get=function(){return this._shadowDepthScale};Rr.prototype.setFrustumEdgeFalloff=function e(t){this._frustumEdgeFalloff=t};Lr.frustumEdgeFalloff.get=function(){return this._frustumEdgeFalloff};Rr.prototype.setShadowFrustumSize=function e(t){this._shadowFrustumSize=t};Lr.shadowFrustumSize.get=function(){return this._shadowFrustumSize};Rr.prototype.extractView=function e(t,r){t._shadowLight=this;t._priority=-1;t._rect.x=0;t._rect.y=0;t._rect.w=this._shadowResolution;t._rect.h=this._shadowResolution;Ft.set(t._color,1,1,1,1);t._depth=1;t._stencil=1;t._clearFlags=Ae.CLEAR_COLOR|Ae.CLEAR_DEPTH;t._stages=r;t._framebuffer=this._shadowFrameBuffer;switch(this._type){case Ae.LIGHT_SPOT:Sr(this,t._matView,t._matProj);break;case Ae.LIGHT_DIRECTIONAL:Mr(this,t._matView,t._matProj);break;case Ae.LIGHT_POINT:Ar(this,t._matView,t._matProj);break;default:console.warn("shadow of this light type is not supported")}Bt.mul(t._matViewProj,t._matProj,t._matView);this._viewProjMatrix=t._matViewProj;Bt.invert(t._matInvViewProj,t._matViewProj);t.updateFrustum()};Rr.prototype._updateLightPositionAndDirection=function e(){this._node.getWorldMatrix(wr);It.fromMat4(Tr,wr);Lt.transformMat3(Er,br,Tr);Lt.array(this._directionUniform,Er);var t=this._positionUniform;t[0]=wr.m12;t[1]=wr.m13;t[2]=wr.m14};Rr.prototype._generateShadowMap=function e(t){this._shadowMap=new Me.Texture2D(t,{width:this._shadowResolution,height:this._shadowResolution,format:Me.TEXTURE_FMT_RGBA8,wrapS:Me.WRAP_CLAMP,wrapT:Me.WRAP_CLAMP});this._shadowDepthBuffer=new Me.RenderBuffer(t,Me.RB_FMT_D16,this._shadowResolution,this._shadowResolution);this._shadowFrameBuffer=new Me.FrameBuffer(t,this._shadowResolution,this._shadowResolution,{colors:[this._shadowMap],depth:this._shadowDepthBuffer})};Rr.prototype._destroyShadowMap=function e(){if(this._shadowMap){this._shadowMap.destroy();this._shadowDepthBuffer.destroy();this._shadowFrameBuffer.destroy();this._shadowMap=null;this._shadowDepthBuffer=null;this._shadowFrameBuffer=null}};Rr.prototype.update=function e(t){this._updateLightPositionAndDirection();if(this._shadowType===Ae.SHADOW_NONE){this._destroyShadowMap()}else if(this._shadowMapDirty){this._destroyShadowMap();this._generateShadowMap(t);this._shadowMapDirty=false}};Object.defineProperties(Rr.prototype,Lr);var Cr=Bt.create();var Ir=Bt.create();var Ur=Bt.create();var Dr=Bt.create();var Or=Lt.zero();var Br=Lt.zero();var Pr=Lt.zero();var Fr=function e(){this._poolID=-1;this._node=null;this._projection=Ae.PROJ_PERSPECTIVE;this._priority=0;this._color=Ft.new(.2,.3,.47,1);this._depth=1;this._stencil=0;this._clearFlags=Ae.CLEAR_COLOR|Ae.CLEAR_DEPTH;this._clearModel=null;this._stages=[];this._framebuffer=null;this._near=.01;this._far=1e3;this._fov=Math.PI/4;this._rect={x:0,y:0,w:1,h:1};this._orthoHeight=10};Fr.prototype.getNode=function e(){return this._node};Fr.prototype.setNode=function e(t){this._node=t};Fr.prototype.getType=function e(){return this._projection};Fr.prototype.setType=function e(t){this._projection=t};Fr.prototype.getPriority=function e(){return this._priority};Fr.prototype.setPriority=function e(t){this._priority=t};Fr.prototype.getOrthoHeight=function e(){return this._orthoHeight};Fr.prototype.setOrthoHeight=function e(t){this._orthoHeight=t};Fr.prototype.getFov=function e(){return this._fov};Fr.prototype.setFov=function e(t){this._fov=t};Fr.prototype.getNear=function e(){return this._near};Fr.prototype.setNear=function e(t){this._near=t};Fr.prototype.getFar=function e(){return this._far};Fr.prototype.setFar=function e(t){this._far=t};Fr.prototype.getColor=function e(t){return Ft.copy(t,this._color)};Fr.prototype.setColor=function e(t,r,n,i){Ft.set(this._color,t,r,n,i)};Fr.prototype.getDepth=function e(){return this._depth};Fr.prototype.setDepth=function e(t){this._depth=t};Fr.prototype.getStencil=function e(){return this._stencil};Fr.prototype.setStencil=function e(t){this._stencil=t};Fr.prototype.getClearFlags=function e(){return this._clearFlags};Fr.prototype.setClearFlags=function e(t){this._clearFlags=t};Fr.prototype.getRect=function e(t){t.x=this._rect.x;t.y=this._rect.y;t.w=this._rect.w;t.h=this._rect.h;return t};Fr.prototype.setRect=function e(t,r,n,i){this._rect.x=t;this._rect.y=r;this._rect.w=n;this._rect.h=i};Fr.prototype.getStages=function e(){return this._stages};Fr.prototype.setStages=function e(t){this._stages=t};Fr.prototype.getFramebuffer=function e(){return this._framebuffer};Fr.prototype.setFramebuffer=function e(t){this._framebuffer=t};Fr.prototype.extractView=function e(t,r,n){t._priority=this._priority;t._rect.x=this._rect.x*r;t._rect.y=this._rect.y*n;t._rect.w=this._rect.w*r;t._rect.h=this._rect.h*n;t._color=this._color;t._depth=this._depth;t._stencil=this._stencil;t._clearFlags=this._clearFlags;t._clearModel=this._clearModel;t._stages=this._stages;t._framebuffer=this._framebuffer;this._node.getWorldRT(t._matView);Bt.invert(t._matView,t._matView);var i=r/n;if(this._projection===Ae.PROJ_PERSPECTIVE){Bt.perspective(t._matProj,this._fov,i,this._near,this._far)}else{var a=this._orthoHeight*i;var o=this._orthoHeight;Bt.ortho(t._matProj,-a,a,-o,o,this._near,this._far)}Bt.mul(t._matViewProj,t._matProj,t._matView);Bt.invert(t._matInvViewProj,t._matViewProj);t.updateFrustum()};Fr.prototype.screenToWorld=function e(t,r,n,i){var a=n/i;var o=this._rect.x*n;var s=this._rect.y*i;var l=this._rect.w*n;var u=this._rect.h*i;this._node.getWorldRT(Cr);Bt.invert(Cr,Cr);if(this._projection===Ae.PROJ_PERSPECTIVE){Bt.perspective(Ir,this._fov,a,this._near,this._far)}else{var h=this._orthoHeight*a;var c=this._orthoHeight;Bt.ortho(Ir,-h,h,-c,c,this._near,this._far)}Bt.mul(Ur,Ir,Cr);Bt.invert(Dr,Ur);if(this._projection===Ae.PROJ_PERSPECTIVE){Lt.set(t,(r.x-o)*2/l-1,(r.y-s)*2/u-1,1);Lt.transformMat4(t,t,Dr);this._node.getWorldPos(Or);Lt.lerp(t,Or,t,r.z/this._far)}else{var f=this._farClip-this._nearClip;Lt.set(t,(r.x-o)*2/l-1,(r.y-s)*2/u-1,(this._far-r.z)/f*2-1);Lt.transformMat4(t,t,Dr)}return t};Fr.prototype.screenPointToRay=function e(t,r,n){this._node.getWorldPos(Pr);this.screenToWorld(Br,t,r,n);Lt.sub(Br,Br,Pr);return ur.new(Pr.x,Pr.y,Pr.z,Br.x,Br.y,Br.z)};Fr.prototype.worldToScreen=function e(t,r,n,i){var a=n/i;var o=this._rect.x*n;var s=this._rect.y*i;var l=this._rect.w*n;var u=this._rect.h*i;this._node.getWorldRT(Cr);Bt.invert(Cr,Cr);if(this._projection===Ae.PROJ_PERSPECTIVE){Bt.perspective(Ir,this._fov,a,this._near,this._far)}else{var h=this._orthoHeight*a;var c=this._orthoHeight;Bt.ortho(Ir,-h,h,-c,c,this._near,this._far)}Bt.mul(Ur,Ir,Cr);var f=r.x*Ur.m03+r.y*Ur.m07+r.z*Ur.m11+Ur.m15;Lt.transformMat4(t,r,Ur);t.x=o+(t.x/f+1)*.5*l;t.y=s+(t.y/f+1)*.5*u;return t};var zr=function e(){this._type="default";this._poolID=-1;this._node=null;this._inputAssembler=null;this._effect=null;this._defines={};this._dependencies={};this._viewID=-1;this._cameraID=-1;this._userKey=-1;this._castShadow=false;this._boundingBox=null};zr.prototype.setNode=function e(t){this._node=t};zr.prototype.setInputAssembler=function e(t){this._inputAssembler=t};zr.prototype.setEffect=function e(t){if(t){this._effect=t;this._defines=t.extractDefines(Object.create(null));this._dependencies=t.extractDependencies(Object.create(null))}else{this._effect=null;this._defines=Object.create(null);this._dependencies=Object.create(null)}};zr.prototype.setUserKey=function e(t){this._userKey=t};zr.prototype.extractDrawItem=function e(t){t.model=this;t.node=this._node;t.ia=this._inputAssembler;t.effect=this._effect;t.defines=this._effect.extractDefines(this._defines);t.dependencies=this._effect.extractDependencies(this._dependencies)};zr.prototype.createBoundingBox=function e(t,r){if(t===null||t===undefined||r===null||r===undefined){return}this._bbModelSpace=fr.fromPoints(t,r);this._boundingBox=fr.clone(this._bbModelSpace)};var Nr=function e(t,r){var n=this;this._cursor=0;this._data=new Array(r);for(var i=0;i<r;++i){n._data[i]=t()}};Nr.prototype.request=function e(){var t=this._data[this._cursor];this._cursor=(this._cursor+1)%this._data.length;return t};var kr=32;var Vr=7;var Gr=256;var Wr=[1,10,100,1e3,1e4,1e5,1e6,1e7,1e8,1e9];function Hr(e){if(e<1e5){if(e<100){return e<10?0:1}if(e<1e4){return e<1e3?2:3}return 4}if(e<1e7){return e<1e6?5:6}if(e<1e9){return e<1e8?7:8}return 9}function jr(e,t){if(e===t){return 0}if(~~e===e&&~~t===t){if(e===0||t===0){return e<t?-1:1}if(e<0||t<0){if(t>=0){return-1}if(e>=0){return 1}e=-e;t=-t}var r=Hr(e);var n=Hr(t);var i=0;if(r<n){e*=Wr[n-r-1];t/=10;i=-1}else if(r>n){t*=Wr[r-n-1];e/=10;i=1}if(e===t){return i}return e<t?-1:1}var a=String(e);var o=String(t);if(a===o){return 0}return a<o?-1:1}function qr(e){var t=0;while(e>=kr){t|=e&1;e>>=1}return e+t}function Xr(e,t,r,n){var i=t+1;if(i===r){return 1}if(n(e[i++],e[t])<0){while(i<r&&n(e[i],e[i-1])<0){i++}Yr(e,t,i)}else{while(i<r&&n(e[i],e[i-1])>=0){i++}}return i-t}function Yr(e,t,r){r--;while(t<r){var n=e[t];e[t++]=e[r];e[r--]=n}}function Kr(e,t,r,n,i){if(n===t){n++}for(;n<r;n++){var a=e[n];var o=t;var s=n;while(o<s){var l=o+s>>>1;if(i(a,e[l])<0){s=l}else{o=l+1}}var u=n-o;switch(u){case 3:e[o+3]=e[o+2];case 2:e[o+2]=e[o+1];case 1:e[o+1]=e[o];break;default:while(u>0){e[o+u]=e[o+u-1];u--}}e[o]=a}}function Zr(e,t,r,n,i,a){var o=0;var s=0;var l=1;if(a(e,t[r+i])>0){s=n-i;while(l<s&&a(e,t[r+i+l])>0){o=l;l=(l<<1)+1;if(l<=0){l=s}}if(l>s){l=s}o+=i;l+=i}else{s=i+1;while(l<s&&a(e,t[r+i-l])<=0){o=l;l=(l<<1)+1;if(l<=0){l=s}}if(l>s){l=s}var u=o;o=i-l;l=i-u}o++;while(o<l){var h=o+(l-o>>>1);if(a(e,t[r+h])>0){o=h+1}else{l=h}}return l}function Qr(e,t,r,n,i,a){var o=0;var s=0;var l=1;if(a(e,t[r+i])<0){s=i+1;while(l<s&&a(e,t[r+i-l])<0){o=l;l=(l<<1)+1;if(l<=0){l=s}}if(l>s){l=s}var u=o;o=i-l;l=i-u}else{s=n-i;while(l<s&&a(e,t[r+i+l])>=0){o=l;l=(l<<1)+1;if(l<=0){l=s}}if(l>s){l=s}o+=i;l+=i}o++;while(o<l){var h=o+(l-o>>>1);if(a(e,t[r+h])<0){l=h}else{o=h+1}}return l}var Jr=function e(t,r){this.array=t;this.compare=r;this.minGallop=Vr;this.length=t.length;this.tmpStorageLength=Gr;if(this.length<2*Gr){this.tmpStorageLength=this.length>>>1}this.tmp=new Array(this.tmpStorageLength);this.stackLength=this.length<120?5:this.length<1542?10:this.length<119151?19:40;this.runStart=new Array(this.stackLength);this.runLength=new Array(this.stackLength);this.stackSize=0};Jr.prototype.pushRun=function e(t,r){this.runStart[this.stackSize]=t;this.runLength[this.stackSize]=r;this.stackSize+=1};Jr.prototype.mergeRuns=function e(){var t=this;while(this.stackSize>1){var r=t.stackSize-2;if(r>=1&&t.runLength[r-1]<=t.runLength[r]+t.runLength[r+1]||r>=2&&t.runLength[r-2]<=t.runLength[r]+t.runLength[r-1]){if(t.runLength[r-1]<t.runLength[r+1]){r--}}else if(t.runLength[r]>t.runLength[r+1]){break}t.mergeAt(r)}};Jr.prototype.forceMergeRuns=function e(){var t=this;while(this.stackSize>1){var r=t.stackSize-2;if(r>0&&t.runLength[r-1]<t.runLength[r+1]){r--}t.mergeAt(r)}};Jr.prototype.mergeAt=function e(t){var r=this.compare;var n=this.array;var i=this.runStart[t];var a=this.runLength[t];var o=this.runStart[t+1];var s=this.runLength[t+1];this.runLength[t]=a+s;if(t===this.stackSize-3){this.runStart[t+1]=this.runStart[t+2];this.runLength[t+1]=this.runLength[t+2]}this.stackSize--;var l=Qr(n[o],n,i,a,0,r);i+=l;a-=l;if(a===0){return}s=Zr(n[i+a-1],n,o,s,s-1,r);if(s===0){return}if(a<=s){this.mergeLow(i,a,o,s)}else{this.mergeHigh(i,a,o,s)}};Jr.prototype.mergeLow=function e(t,r,n,i){var a=this.compare;var o=this.array;var s=this.tmp;var l=0;for(l=0;l<r;l++){s[l]=o[t+l]}var u=0;var h=n;var c=t;o[c++]=o[h++];if(--i===0){for(l=0;l<r;l++){o[c+l]=s[u+l]}return}if(r===1){for(l=0;l<i;l++){o[c+l]=o[h+l]}o[c+i]=s[u];return}var f=this.minGallop;while(true){var p=0;var d=0;var v=false;do{if(a(o[h],s[u])<0){o[c++]=o[h++];d++;p=0;if(--i===0){v=true;break}}else{o[c++]=s[u++];p++;d=0;if(--r===1){v=true;break}}}while((p|d)<f);if(v){break}do{p=Qr(o[h],s,u,r,0,a);if(p!==0){for(l=0;l<p;l++){o[c+l]=s[u+l]}c+=p;u+=p;r-=p;if(r<=1){v=true;break}}o[c++]=o[h++];if(--i===0){v=true;break}d=Zr(s[u],o,h,i,0,a);if(d!==0){for(l=0;l<d;l++){o[c+l]=o[h+l]}c+=d;h+=d;i-=d;if(i===0){v=true;break}}o[c++]=s[u++];if(--r===1){v=true;break}f--}while(p>=Vr||d>=Vr);if(v){break}if(f<0){f=0}f+=2}this.minGallop=f;if(f<1){this.minGallop=1}if(r===1){for(l=0;l<i;l++){o[c+l]=o[h+l]}o[c+i]=s[u]}else if(r===0){throw new Error("mergeLow preconditions were not respected")}else{for(l=0;l<r;l++){o[c+l]=s[u+l]}}};Jr.prototype.mergeHigh=function e(t,r,n,i){var a=this.compare;var o=this.array;var s=this.tmp;var l=0;for(l=0;l<i;l++){s[l]=o[n+l]}var u=t+r-1;var h=i-1;var c=n+i-1;var f=0;var p=0;o[c--]=o[u--];if(--r===0){f=c-(i-1);for(l=0;l<i;l++){o[f+l]=s[l]}return}if(i===1){c-=r;u-=r;p=c+1;f=u+1;for(l=r-1;l>=0;l--){o[p+l]=o[f+l]}o[c]=s[h];return}var d=this.minGallop;while(true){var v=0;var m=0;var _=false;do{if(a(s[h],o[u])<0){o[c--]=o[u--];v++;m=0;if(--r===0){_=true;break}}else{o[c--]=s[h--];m++;v=0;if(--i===1){_=true;break}}}while((v|m)<d);if(_){break}do{v=r-Qr(s[h],o,t,r,r-1,a);if(v!==0){c-=v;u-=v;r-=v;p=c+1;f=u+1;for(l=v-1;l>=0;l--){o[p+l]=o[f+l]}if(r===0){_=true;break}}o[c--]=s[h--];if(--i===1){_=true;break}m=i-Zr(o[u],s,0,i,i-1,a);if(m!==0){c-=m;h-=m;i-=m;p=c+1;f=h+1;for(l=0;l<m;l++){o[p+l]=s[f+l]}if(i<=1){_=true;break}}o[c--]=o[u--];if(--r===0){_=true;break}d--}while(v>=Vr||m>=Vr);if(_){break}if(d<0){d=0}d+=2}this.minGallop=d;if(d<1){this.minGallop=1}if(i===1){c-=r;u-=r;p=c+1;f=u+1;for(l=r-1;l>=0;l--){o[p+l]=o[f+l]}o[c]=s[h]}else if(i===0){throw new Error("mergeHigh preconditions were not respected")}else{f=c-(i-1);for(l=0;l<i;l++){o[f+l]=s[l]}}};function $r(e,t,r,n){if(!Array.isArray(e)){throw new TypeError("Can only sort arrays")}if(t===undefined){t=0}if(r===undefined){r=e.length}if(n===undefined){n=jr}var i=r-t;if(i<2){return}var a=0;if(i<kr){a=Xr(e,t,r,n);Kr(e,t,r,t+a,n);return}var o=new Jr(e,n);var s=qr(i);do{a=Xr(e,t,r,n);if(a<s){var l=i;if(l>s){l=s}Kr(e,t,t+l,t+a,n);a=l}o.pushRun(t,a);o.mergeRuns();i-=a;t+=a}while(i!==0);o.forceMergeRuns()}var en=function e(t){this._count=0;this._data=new Array(t)};var tn={length:{configurable:true},data:{configurable:true}};en.prototype._resize=function e(t){var r=this;if(t>this._data.length){for(var n=this._data.length;n<t;++n){r._data[n]=undefined}}};tn.length.get=function(){return this._count};tn.data.get=function(){return this._data};en.prototype.reset=function e(){var t=this;for(var r=0;r<this._count;++r){t._data[r]=undefined}this._count=0};en.prototype.push=function e(t){if(this._count>=this._data.length){this._resize(this._data.length*2)}this._data[this._count]=t;++this._count};en.prototype.pop=function e(){--this._count;if(this._count<0){this._count=0}var t=this._data[this._count];this._data[this._count]=undefined;return t};en.prototype.fastRemove=function e(t){if(t>=this._count){return}var r=this._count-1;this._data[t]=this._data[r];this._data[r]=undefined;this._count-=1};en.prototype.indexOf=function e(t){var r=this._data.indexOf(t);if(r>=this._count){return-1}return r};en.prototype.sort=function e(t){return $r(this._data,0,this._count,t)};Object.defineProperties(en.prototype,tn);var rn=function e(t,r){var n=this;this._fn=t;this._idx=r-1;this._frees=new Array(r);for(var i=0;i<r;++i){n._frees[i]=t()}};rn.prototype._expand=function e(t){var r=this;var n=this._frees;this._frees=new Array(t);var i=t-n.length;for(var a=0;a<i;++a){r._frees[a]=r._fn()}for(var o=i,s=0;o<t;++o,++s){r._frees[o]=n[s]}this._idx+=i};rn.prototype.alloc=function e(){if(this._idx<0){this._expand(Math.round(this._frees.length*1.2)+1)}var t=this._frees[this._idx];this._frees[this._idx]=null;--this._idx;return t};rn.prototype.free=function e(t){++this._idx;this._frees[this._idx]=t};var nn=function e(t,r){this._fn=t;this._count=0;this._head=null;this._tail=null;this._pool=new rn(t,r)};var an={head:{configurable:true},tail:{configurable:true},length:{configurable:true}};an.head.get=function(){return this._head};an.tail.get=function(){return this._tail};an.length.get=function(){return this._count};nn.prototype.add=function e(){var t=this._pool.alloc();if(!this._tail){this._head=t}else{this._tail._next=t;t._prev=this._tail}this._tail=t;this._count+=1;return t};nn.prototype.remove=function e(t){if(t._prev){t._prev._next=t._next}else{this._head=t._next}if(t._next){t._next._prev=t._prev}else{this._tail=t._prev}t._next=null;t._prev=null;this._pool.free(t);this._count-=1};nn.prototype.forEach=function e(t,r){var n=this;var i=this._head;if(!i){return}if(r){t=t.bind(r)}var a=0;var o=i;while(i){o=i._next;t(i,a,n);i=o;++a}};Object.defineProperties(nn.prototype,an);var on=function e(t,r){var n=this;this._fn=t;this._count=0;this._data=new Array(r);for(var i=0;i<r;++i){n._data[i]=t()}};var sn={length:{configurable:true},data:{configurable:true}};sn.length.get=function(){return this._count};sn.data.get=function(){return this._data};on.prototype.reset=function e(){this._count=0};on.prototype.resize=function e(t){var r=this;if(t>this._data.length){for(var n=this._data.length;n<t;++n){r._data[n]=r._fn()}}};on.prototype.add=function e(){if(this._count>=this._data.length){this.resize(this._data.length*2)}return this._data[this._count++]};on.prototype.remove=function e(t){if(t>=this._count){return}var r=this._count-1;var n=this._data[t];this._data[t]=this._data[r];this._data[r]=n;this._count-=1};on.prototype.sort=function e(t){return $r(this._data,0,this._count,t)};Object.defineProperties(on.prototype,sn);var ln=Array(8);for(var un=0;un<8;++un){ln[un]=[]}function hn(e){for(var t=16;t<=1<<28;t*=16){if(e<=t){return t}}return 0}function cn(e){var t,r;t=(e>65535)<<4;e>>>=t;r=(e>255)<<3;e>>>=r;t|=r;r=(e>15)<<2;e>>>=r;t|=r;r=(e>3)<<1;e>>>=r;t|=r;return t|e>>1}function fn(e){var t=hn(e);var r=ln[cn(t)>>2];if(r.length>0){return r.pop()}return new ArrayBuffer(t)}function pn(e){ln[cn(e.byteLength)>>2].push(e)}var dn={alloc_int8:function e(t){var r=new Int8Array(fn(t),0,t);if(r.length!==t){return r.subarray(0,t)}return r},alloc_uint8:function e(t){var r=new Uint8Array(fn(t),0,t);if(r.length!==t){return r.subarray(0,t)}return r},alloc_int16:function e(t){var r=new Int16Array(fn(2*t),0,t);if(r.length!==t){return r.subarray(0,t)}return r},alloc_uint16:function e(t){var r=new Uint16Array(fn(2*t),0,t);if(r.length!==t){return r.subarray(0,t)}return r},alloc_int32:function e(t){var r=new Int32Array(fn(4*t),0,t);if(r.length!==t){return r.subarray(0,t)}return r},alloc_uint32:function e(t){var r=new Uint32Array(fn(4*t),0,t);if(r.length!==t){return r.subarray(0,t)}return r},alloc_float32:function e(t){var r=new Float32Array(fn(4*t),0,t);if(r.length!==t){return r.subarray(0,t)}return r},alloc_float64:function e(t){var r=new Float64Array(fn(8*t),0,t);if(r.length!==t){return r.subarray(0,t)}return r},alloc_dataview:function e(t){var r=new DataView(fn(t),0,t);if(r.length!==t){return r.subarray(0,t)}return r},free:function e(t){pn(t.buffer)},reset:function e(){var t=Array(8);for(var r=0;r<8;++r){t[r]=[]}}};var vn=Object.freeze({CircularPool:Nr,FixedArray:en,LinkedArray:nn,Pool:rn,RecyclePool:on,TypedArrayPool:dn});function mn(e){return e?(e^Math.random()*16>>e/4).toString(16):([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,mn)}var _n=function e(){};_n.addLayer=function e(t){if(_n._nextAvailable>31){return new Error("maximum layers reached.")}_n[t]=1<<_n._nextAvailable++;return _n[t]};_n.makeInclusiveMask=function e(t){var r=0;for(var n=0;n<t.length;n++){r|=t[n]}return r};_n.makeExclusiveMask=function e(t){return~_n.makeInclusiveMask(t)};_n.check=function e(t,r){return(t&r)==t};_n._nextAvailable=8;_n.Default=1<<0;_n.IgnoreRaycast=1<<1;_n.RaycastMask=_n.makeExclusiveMask([_n.IgnoreRaycast]);var gn=Lt.zero();var yn=Ut.create();var xn=It.create();var bn=It.create();var wn=Bt.create();var Tn=function e(t){this._id=mn();this._parent=null;this._children=[];this.name=t||"";this.lpos=Lt.new(0,0,0);this.lscale=Lt.new(1,1,1);this.lrot=Ut.new(0,0,0,1);this.layer=_n.Default};var En={id:{configurable:true},parent:{configurable:true},children:{configurable:true}};Tn.mixin=function e(t){Object.getOwnPropertyNames(Tn.prototype).forEach(function(e){if(t.prototype.hasOwnProperty(e)===false){Object.defineProperty(t.prototype,e,Object.getOwnPropertyDescriptor(Tn.prototype,e))}});t.prototype.__initNode=function(){this._id=mn();this._parent=null;this._children=[];this.name="";this.lpos=Lt.new(0,0,0);this.lscale=Lt.new(1,1,1);this.lrot=Ut.new(0,0,0,1);this.layer=_n.Default}};En.id.get=function(){return this._id};En.parent.get=function(){return this._parent};En.children.get=function(){return this._children};Tn.prototype.setParent=function e(t){var r=this;var n=this._parent;if(n===t){return false}var i=t;while(i){if(i===r){return false}i=i._parent}if(n){var a=n._children.length;for(var o=0;o<a;++o){if(n._children[o]===r){n._children.splice(o,1);break}}}this._parent=t;if(t){t._children.push(this)}if(this._onParentChanged){this._onParentChanged(n,t)}return true};Tn.prototype.insertAt=function e(t,r){var n=this;if(!r){return false}var i=this;while(i){if(i===r){return false}i=i._parent}var a=r._parent;var o=this._children.length;t=t<0?0:t>o?o:t;if(a){o=a._children.length;for(var s=0;s<o;++s){if(a._children[s]===r){if(a===n){if(s===t||s===t-1){return false}if(s<t-1){t=t-1}}a._children.splice(s,1);break}}}r._parent=this;this._children.splice(t,0,r);if(r._onParentChanged&&r._parent!==this){r._onParentChanged(a,this)}return true};Tn.prototype.append=function e(t){var r=this;if(!t){return false}var n=this;while(n){if(n===t){return false}n=n._parent}var i=t._parent;if(i){var a=i._children.length;for(var o=0;o<a;++o){if(i._children[o]===t){if(i===r&&o===a-1){return false}i._children.splice(o,1);break}}}t._parent=this;this._children.push(t);if(t._onParentChanged&&t._parent!==this){t._onParentChanged(i,this)}return true};Tn.prototype.remove=function e(){if(this._parent){this._parent.removeChild(this)}};Tn.prototype.removeChild=function e(t){var r=this;var n=this._children.length;for(var i=0;i<n;++i){if(r._children[i]===t){r._children.splice(i,1);t._parent=null;if(t._onParentChanged){t._onParentChanged(r,null)}return true}}return false};Tn.prototype.lookAt=function e(t,r){this.getWorldPos(gn);Lt.sub(gn,gn,t);Lt.normalize(gn,gn);Ut.fromViewUp(yn,gn,r);this.setWorldRot(yn)};Tn.prototype.getWorldPos=function e(t){Lt.copy(t,this.lpos);var r=this._parent;while(r){Lt.mul(t,t,r.lscale);Lt.transformQuat(t,t,r.lrot);Lt.add(t,t,r.lpos);r=r._parent}return t};Tn.prototype.setWorldPos=function e(t){if(this._parent){this._parent.invTransformPoint(this.lpos,t);return}Lt.copy(this.lpos,t)};Tn.prototype.getWorldRot=function e(t){Ut.copy(t,this.lrot);var r=this._parent;while(r){Ut.mul(t,r.lrot,t);r=r._parent}return t};Tn.prototype.setWorldRot=function e(t){if(this._parent){this._parent.getWorldRot(this.lrot);Ut.conjugate(this.lrot,this.lrot);Ut.mul(this.lrot,this.lrot,t);return}Ut.copy(this.lrot,t)};Tn.prototype.getWorldScale=function e(t){Lt.copy(t,this.lscale);var r=this._parent;while(r){Lt.mul(t,r.lscale,t);r=r._parent}return t};Tn.prototype.invTransformPoint=function e(t,r){if(this._parent){this._parent.invTransformPoint(t,r)}else{Lt.copy(t,r)}Lt.sub(t,t,this.lpos);Ut.conjugate(yn,this.lrot);Lt.transformQuat(t,t,yn);Lt.inverseSafe(gn,this.lscale);Lt.mul(t,t,gn);return t};Tn.prototype.getLocalMatrix=function e(t){Bt.fromRTS(t,this.lrot,this.lpos,this.lscale);return t};Tn.prototype.getWorldMatrix=function e(t){this.getLocalMatrix(t);var r=this._parent;while(r){r.getLocalMatrix(wn);Bt.mul(t,wn,t);r=r._parent}return t};Tn.prototype.getWorldRT=function e(t){this._getWorldPosAndRot(gn,yn);Bt.fromRT(t,yn,gn);return t};Tn.prototype.getWorldRS=function e(t){It.set(xn,this.lscale.x,0,0,0,this.lscale.y,0,0,0,this.lscale.z);It.fromQuat(bn,this.lrot);if(this._parent){this._parent.getWorldRS(t);It.mul(t,t,bn);It.mul(t,t,xn)}else{It.mul(t,bn,xn)}return t};Tn.prototype._getWorldPosAndRot=function e(t,r){Lt.copy(t,this.lpos);Ut.copy(r,this.lrot);var n=this._parent;while(n){Lt.mul(t,t,n.lscale);Lt.transformQuat(t,t,n.lrot);Lt.add(t,t,n.lpos);Ut.mul(r,n.lrot,r);n=n._parent}};Tn.prototype._getWorldPRS=function e(t,r,n){Lt.copy(t,this.lpos);Ut.copy(r,this.lrot);Lt.copy(n,this.lscale);var i=this._parent;while(i){Lt.mul(t,t,i.lscale);Lt.transformQuat(t,t,i.lrot);Lt.add(t,t,i.lpos);Ut.mul(r,i.lrot,r);Lt.mul(n,i.lscale,n);i=i._parent}};Object.defineProperties(Tn.prototype,En);function Sn(e,t,r){if(r===void 0)r=0;r+=1;var n=e.children.length;for(var i=0;i<n;++i){var a=e.children[i];var o=t(a,e,r);if(o===false){break}Sn(a,t,r)}}function Mn(e,t,r,n){if(n===void 0)n=0;n+=1;var i=e.children.length;for(var a=0;a<i;++a){var o=e.children[a];var s=t(o,e,n);if(s===false){r(o,e,n);break}Mn(o,t,r,n);r(o,e,n)}}function An(e,t,r){if(r===void 0)r=0;r+=1;var n=e.children.length;for(var i=0;i<n;++i){var a=e.children[i];var o=t(a,e,r);if(o!==false){An(a,t,r)}}}function Rn(e){var t=[];t.push(e);Sn(e,function(e){t.push(e)});return t}function Ln(e,t){t.remove();var r=e._parent;if(!r){return}e._parent=null;t._parent=r;var n=r._children.length;for(var i=0;i<n;++i){if(r._children[i]===e){r._children[i]=t;return}}}function Cn(e,t,r){if(t===void 0)t=Tn;if(r===void 0)r=null;var n=new t;n.name=e.name;Lt.copy(n.lpos,e.lpos);Lt.copy(n.lscale,e.lscale);Ut.copy(n.lrot,e.lrot);if(r){r(n,e)}return n}function In(e,t,r){if(t===void 0)t=Tn;if(r===void 0)r=null;var n=Cn(e,t,r);n._children=new Array(e._children.length);for(var i=0;i<e._children.length;++i){var a=e._children[i];var o=In(a,t,r);n._children[i]=o;o._parent=n}return n}function Un(e,t){var r=t.split("/");function n(e,t){var i=e.children.length;var a=r[t];for(var o=0;o<i;++o){var s=e.children[o];if(s.name!==a){continue}if(t===r.length-1){return s}else{return n(s,t+1)}}return null}return n(e,0)}var Dn={walk:Sn,walk2:Mn,walkSibling:An,flat:Rn,replace:Ln,clone:Cn,deepClone:In,find:Un};var On=function e(){this._lights=new en(16);this._models=new en(16);this._cameras=new en(16);this._debugCamera=null;this._views=[]};On.prototype._add=function e(t,r){if(r._poolID!==-1){return}t.push(r);r._poolID=t.length-1};On.prototype._remove=function e(t,r){if(r._poolID===-1){return}t.data[t.length-1]._poolID=r._poolID;t.fastRemove(r._poolID);r._poolID=-1};On.prototype.reset=function e(){var t=this;for(var r=0;r<this._models.length;++r){var n=t._models.data[r];n._viewID=-1}};On.prototype.setDebugCamera=function e(t){this._debugCamera=t};On.prototype.getCameraCount=function e(){return this._cameras.length};On.prototype.getCamera=function e(t){return this._cameras.data[t]};On.prototype.addCamera=function e(t){this._add(this._cameras,t)};On.prototype.removeCamera=function e(t){this._remove(this._cameras,t)};On.prototype.getModelCount=function e(){return this._models.length};On.prototype.getModel=function e(t){return this._models.data[t]};On.prototype.addModel=function e(t){this._add(this._models,t)};On.prototype.removeModel=function e(t){this._remove(this._models,t)};On.prototype.raycast=function e(t,r,n){var i=this;if(n===void 0)n=Infinity;var a=Infinity,o=a;var s=Lt.zero();for(var l=0;l<this.getModelCount();l++){var u=i.getModel(l);if(!_n.check(u._node.layer,_n.RaycastMask)){continue}if(!or.ray_box(r,u._boundingBox,s)){continue}o=Lt.sqrDist(s,r.o);if(o>n*n||o>a){continue}a=o;t.entity=u._node}return a<Infinity};On.prototype.getLightCount=function e(){return this._lights.length};On.prototype.getLight=function e(t){return this._lights.data[t]};On.prototype.addLight=function e(t){this._add(this._lights,t)};On.prototype.removeLight=function e(t){this._remove(this._lights,t)};On.prototype.addView=function e(t){if(this._views.indexOf(t)===-1){this._views.push(t)}};On.prototype.removeView=function e(t){var r=this._views.indexOf(t);if(r!==-1){this._views.splice(r,1)}};var Bn=function(e){function t(){e.call(this);this._type="line-batch";this._lines=new on(function(){return{start:Lt.zero(),end:Lt.zero(),color:Pt.create(),normal:Lt.zero()}},2e3)}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;var r={vertCount:{configurable:true},lineCount:{configurable:true}};r.vertCount.get=function(){return this._lines.length*2};r.lineCount.get=function(){return this._lines.length};t.prototype.getLine=function e(t){return this._lines.data[t]};t.prototype.addLine=function e(t,r,n,i){var a=this._lines.add();Lt.copy(a.start,t);Lt.copy(a.end,r);if(n){Pt.copy(a.color,n)}if(i){Lt.copy(a.normal,i)}return a};t.prototype.clear=function e(){this._lines.reset()};Object.defineProperties(t.prototype,r);return t}(zr);var Pn=function(e){function t(){e.call(this);this._type="sprite-batch";this._sprites=new on(function(){return{refPositions:null,refUVs:null,refColor:null,refIndices:null}},2e3);this._vertCount=0;this._indexCount=0}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;var r={vertCount:{configurable:true},indexCount:{configurable:true},spriteCount:{configurable:true}};r.vertCount.get=function(){return this._vertCount};r.indexCount.get=function(){return this._indexCount};r.spriteCount.get=function(){return this._sprites.length};t.prototype.getSprite=function e(t){return this._sprites.data[t]};t.prototype.addSprite=function e(t,r,n,i){var a=this._sprites.add();a.refPositions=t;a.refUVs=r;a.refColor=n;a.refIndices=i;this._vertCount+=t.length;this._indexCount+=i.length;return a};t.prototype.clear=function e(){this._sprites.reset();this._vertCount=0;this._indexCount=0};Object.defineProperties(t.prototype,r);return t}(zr);function Fn(e){var t=new Me.VertexBuffer(e._device,new Me.VertexFormat(e._vertAttrs),Me.USAGE_DYNAMIC,null,e._capacity*4);var r=new Array(e._capacity);var n=0;for(var i=0;i<e._capacity;++i){var a=4*i;r[n++]=a;r[n++]=a+1;r[n++]=a+2;r[n++]=a+3;r[n++]=a+2;r[n++]=a+1}var o=new Me.IndexBuffer(e._device,Me.INDEX_FMT_UINT16,Me.USAGE_STATIC,new Uint16Array(r),r.length);e._ia=new Re(t,o)}var zn=function(e){function t(t,r,n){if(n===void 0)n=[{name:Me.ATTR_POSITION,type:Me.ATTR_TYPE_FLOAT32,num:3},{name:Me.ATTR_UV,type:Me.ATTR_TYPE_FLOAT32,num:3},{name:Me.ATTR_UV0,type:Me.ATTR_TYPE_FLOAT32,num:2},{name:Me.ATTR_COLOR,type:Me.ATTR_TYPE_FLOAT32,num:4}];e.call(this);this._type="particle-batch";this._device=t;this._vertAttrs=n;this._capacity=r;Fn(this);this._vertAttrsSize=this._ia._vertexBuffer._format._bytes/4;this._vdataF32=new Float32Array(r*4*this._vertAttrsSize)}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.setVertexAttributes=function e(t){this._vertAttrs=t;Fn(this);this._vertAttrsSize=this._ia._vertexBuffer._format._bytes/4;this._vdataF32=new Float32Array(this._capacity*4*this._vertAttrsSize)};t.prototype.enableStretchedBillboard=function e(){if(this._vertAttrs.find(function(e){return e.name===Me.ATTR_COLOR0})===undefined){this._vertAttrs.push({name:Me.ATTR_COLOR0,type:Me.ATTR_TYPE_FLOAT32,num:3});this.setVertexAttributes(this._vertAttrs)}};t.prototype.disableStretchedBillboard=function e(){if(this._vertAttrs.find(function(e){return e.name===Me.ATTR_COLOR0})!==undefined){this._vertAttrs.pop();this.setVertexAttributes(this._vertAttrs)}};t.prototype.addParticleVertexData=function e(t,r){var n=this;if(r.length!==this._vertAttrs.length){console.error("particle vertex stream data not match.")}var i=t*this._vertAttrsSize;for(var a=0;a<this._vertAttrs.length;++a){var o=n._vertAttrs[a];if(o.num===1){n._vdataF32[i]=r[a];i++}else if(o.num===2){n._vdataF32[i]=r[a].x;n._vdataF32[i+1]=r[a].y;i+=2}else if(o.num===3){n._vdataF32[i]=r[a].x;n._vdataF32[i+1]=r[a].y;n._vdataF32[i+2]=r[a].z;i+=3}else if(o.num===4){n._vdataF32[i]=r[a].x;n._vdataF32[i+1]=r[a].y;n._vdataF32[i+2]=r[a].z;n._vdataF32[i+3]=r[a].w;i+=4}else{console.error("particle vertex attribute format not support")}}};t.prototype.updateIA=function e(t){this._ia._count=t;this._ia._vertexBuffer.update(0,this._vdataF32)};t.prototype.clear=function e(){this._ia._count=0};t.prototype.destroy=function e(){this._vdataF32=null;this._ia._vertexBuffer.destroy();this._ia._indexBuffer.destroy()};return t}(zr);var Nn=function(e){function t(){e.call(this);this._type="skinning";this._jointsTexture=null}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.setJointsTexture=function e(t){this._jointsTexture=t};return t}(zr);var kn={"common.frag":"\n#define PI 3.14159265359\n#define PI2 6.28318530718\n#define EPSILON 1e-6\n#define LOG2 1.442695\n#define saturate(a) clamp( a, 0.0, 1.0 )","gamma-correction.frag":"\nvec3 gammaToLinearSpaceRGB(vec3 sRGB) { \n  return sRGB * (sRGB * (sRGB * 0.305306011 + 0.682171111) + 0.012522878);\n}\nvec3 linearToGammaSpaceRGB(vec3 RGB) { \n  vec3 S1 = sqrt(RGB);\n  vec3 S2 = sqrt(S1);\n  vec3 S3 = sqrt(S2);\n  return 0.585122381 * S1 + 0.783140355 * S2 - 0.368262736 * S3;\n}\nvec4 gammaToLinearSpaceRGBA(vec4 sRGBA) {\n  return vec4(gammaToLinearSpaceRGB(sRGBA.rgb), sRGBA.a);\n}\nvec4 linearToGammaSpaceRGBA(vec4 RGBA) {\n  return vec4(linearToGammaSpaceRGB(RGBA.rgb), RGBA.a);\n}\nfloat gammaToLinearSpaceExact(float val) {\n  if (val <= 0.04045) {\n    return val / 12.92;\n  } else if (val < 1.0) {\n    return pow((val + 0.055) / 1.055, 2.4);\n  } else {\n    return pow(val, 2.2);\n  }\n}\nfloat linearToGammaSpaceExact(float val) {\n  if (val <= 0.0) {\n    return 0.0;\n  } else if (val <= 0.0031308) {\n    return 12.92 * val;\n  } else if (val < 1.0) {\n    return 1.055 * pow(val, 0.4166667) - 0.055;\n  } else {\n    return pow(val, 0.45454545);\n  }\n}","packing.frag":"\nvec4 packDepthToRGBA(float depth) {\n  vec4 ret = vec4(1.0, 255.0, 65025.0, 160581375.0) * depth;\n  ret = fract(ret);\n  ret -= ret.yzww * vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0, 0.0);\n  return ret;\n}\nfloat unpackRGBAToDepth(vec4 color) {\n  return dot(color, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n}","pbr-lighting.frag":"\nstruct LightInfo {\n  vec3 lightDir;\n  vec3 radiance;\n};\n#if NUM_DIR_LIGHTS > 0\n  #pragma for id in range(0, NUM_DIR_LIGHTS)\n    uniform vec3 dir_light{id}_direction;\n    uniform vec3 dir_light{id}_color;\n  #pragma endFor\n#endif\n#if NUM_POINT_LIGHTS > 0\n  #pragma for id in range(0, NUM_POINT_LIGHTS)\n    uniform vec3 point_light{id}_position;\n    uniform vec3 point_light{id}_color;\n    uniform float point_light{id}_range;\n  #pragma endFor\n#endif\n#if NUM_SPOT_LIGHTS > 0\n  #pragma for id in range(0, NUM_SPOT_LIGHTS)\n    uniform vec3 spot_light{id}_position;\n    uniform vec3 spot_light{id}_direction;\n    uniform vec3 spot_light{id}_color;\n    uniform vec2 spot_light{id}_spot;\n    uniform float spot_light{id}_range;\n  #pragma endFor\n#endif\nLightInfo computeDirectionalLighting(\n  vec3 lightDirection,\n  vec3 lightColor\n) {\n  LightInfo ret;\n  ret.lightDir = -normalize(lightDirection);\n  ret.radiance = lightColor;\n  return ret;\n}\nLightInfo computePointLighting(\n  vec3 lightPosition,\n  vec3 positionW,\n  vec3 lightColor,\n  float lightRange\n) {\n  LightInfo ret;\n  vec3 lightDir = lightPosition - positionW;\n  float attenuation = max(0.0, 1.0 - length(lightDir) / lightRange);\n  ret.lightDir = normalize(lightDir);\n  ret.radiance = lightColor * attenuation;\n  return ret;\n}\nLightInfo computeSpotLighting(\n  vec3 lightPosition,\n  vec3 positionW,\n  vec3 lightDirection,\n  vec3 lightColor,\n  vec2 lightSpot,\n  float lightRange\n) {\n  LightInfo ret;\n  vec3 lightDir = lightPosition - positionW;\n  float attenuation = max(0., 1.0 - length(lightDir) / lightRange);\n  float cosConeAngle = max(0., dot(lightDirection, -lightDir));\n  cosConeAngle = cosConeAngle < lightSpot.x ? 0.0 : cosConeAngle;\n  cosConeAngle = pow(cosConeAngle,lightSpot.y);\n  ret.lightDir = normalize(lightDir);\n  ret.radiance = lightColor * attenuation * cosConeAngle;\n  return ret;\n}","phong-lighting.frag":"\nstruct LightInfo {\n  vec3 diffuse;\n  vec3 specular;\n};\nLightInfo computeDirectionalLighting(\n  vec3 lightDirection,\n  vec3 lightColor,\n  vec3 normal,\n  vec3 viewDirection,\n  float glossiness\n) {\n  LightInfo lightingResult;\n  float ndl = 0.0;\n  float ndh = 0.0;\n  vec3 lightDir = -normalize(lightDirection);\n  ndl = max(0.0, dot(normal, lightDir));\n  lightingResult.diffuse = lightColor * ndl;\n  vec3 dirH = normalize(viewDirection + lightDir);\n  ndh = max(0.0, dot(normal, dirH));\n  ndh = (ndl == 0.0) ? 0.0: ndh;\n  ndh = pow(ndh, max(1.0, glossiness * 128.0));\n  lightingResult.specular = lightColor * ndh;\n  return lightingResult;\n}\nLightInfo computePointLighting(\n  vec3 lightPosition,\n  vec3 lightColor,\n  float lightRange,\n  vec3 normal,\n  vec3 positionW,\n  vec3 viewDirection,\n  float glossiness\n) {\n  LightInfo lightingResult;\n  float ndl = 0.0;\n  float ndh = 0.0;\n  vec3 lightDir = vec3(0, 0, 0);\n  float attenuation = 1.0;\n  lightDir = lightPosition - positionW;\n  attenuation = max(0., 1.0 - length(lightDir) / lightRange);\n  lightDir = normalize(lightDir);\n  ndl = max(0.0, dot(normal, lightDir));\n  lightingResult.diffuse = lightColor * ndl * attenuation;\n  vec3 dirH = normalize(viewDirection + lightDir);\n  ndh = max(0.0, dot(normal, dirH));\n  ndh = (ndl == 0.0) ? 0.0: ndh;\n  ndh = pow(ndh, max(1.0, glossiness * 128.0));\n  lightingResult.specular = lightColor * ndh * attenuation;\n  return lightingResult;\n}\nLightInfo computeSpotLighting(\n  vec3 lightPosition,\n  vec3 lightDirection,\n  vec3 lightColor,\n  float lightRange,\n  vec2 lightSpot,\n  vec3 normal,\n  vec3 positionW,\n  vec3 viewDirection,\n  float glossiness\n) {\n  LightInfo lightingResult;\n  float ndl = 0.0;\n  float ndh = 0.0;\n  vec3 lightDir = vec3(0, 0, 0);\n  float attenuation = 1.0;\n  float cosConeAngle = 1.0;\n  lightDir = lightPosition - positionW;\n  attenuation = max(0., 1.0 - length(lightDir) / lightRange);\n  lightDir = normalize(lightDir);\n  cosConeAngle = max(0., dot(lightDirection, -lightDir));\n  cosConeAngle = cosConeAngle < lightSpot.x ? 0.0 : cosConeAngle;\n  cosConeAngle = pow(cosConeAngle,lightSpot.y);\n  ndl = max(0.0, dot(normal, lightDir));\n  lightingResult.diffuse = lightColor * ndl * attenuation * cosConeAngle;\n  vec3 dirH = normalize(viewDirection + lightDir);\n  ndh = max(0.0, dot(normal, dirH));\n  ndh = (ndl == 0.0) ? 0.0: ndh;\n  ndh = pow(ndh, max(1.0, glossiness * 128.0));\n  lightingResult.specular = lightColor * ndh * attenuation * cosConeAngle;\n  return lightingResult;\n}\n#if NUM_DIR_LIGHTS > 0\n  #pragma for id in range(0, NUM_DIR_LIGHTS)\n    uniform vec3 dir_light{id}_direction;\n    uniform vec3 dir_light{id}_color;\n  #pragma endFor\n#endif\n#if NUM_POINT_LIGHTS > 0\n  #pragma for id in range(0, NUM_POINT_LIGHTS)\n    uniform vec3 point_light{id}_position;\n    uniform vec3 point_light{id}_color;\n    uniform float point_light{id}_range;\n  #pragma endFor\n#endif\n#if NUM_SPOT_LIGHTS > 0\n  #pragma for id in range(0, NUM_SPOT_LIGHTS)\n    uniform vec3 spot_light{id}_position;\n    uniform vec3 spot_light{id}_direction;\n    uniform vec3 spot_light{id}_color;\n    uniform float spot_light{id}_range;\n    uniform vec2 spot_light{id}_spot;\n  #pragma endFor\n#endif\nLightInfo getPhongLighting(\n  vec3 normal,\n  vec3 positionW,\n  vec3 viewDirection,\n  float glossiness\n) {\n  LightInfo result;\n  result.diffuse = vec3(0, 0, 0);\n  result.specular = vec3(0, 0, 0);\n  LightInfo dirLighting;\n  #if NUM_DIR_LIGHTS > 0\n    #pragma for id in range(0, NUM_DIR_LIGHTS)\n      dirLighting = computeDirectionalLighting(dir_light{id}_direction,dir_light{id}_color,normal, viewDirection, glossiness);\n      result.diffuse += dirLighting.diffuse;\n      result.specular += dirLighting.specular;\n    #pragma endFor\n  #endif\n  LightInfo pointLighting;\n  #if NUM_POINT_LIGHTS > 0\n    #pragma for id in range(0, NUM_POINT_LIGHTS)\n      pointLighting = computePointLighting(point_light{id}_position, point_light{id}_color, point_light{id}_range,\n                                          normal, positionW, viewDirection, glossiness);\n      result.diffuse += pointLighting.diffuse;\n      result.specular += pointLighting.specular;\n    #pragma endFor\n  #endif\n  LightInfo spotLighting;\n  #if NUM_SPOT_LIGHTS > 0\n    #pragma for id in range(0, NUM_SPOT_LIGHTS)\n      spotLighting = computeSpotLighting(spot_light{id}_position, spot_light{id}_direction, spot_light{id}_color,\n                      spot_light{id}_range, spot_light{id}_spot,normal, positionW, viewDirection, glossiness);\n      result.diffuse += spotLighting.diffuse;\n      result.specular += spotLighting.specular;\n    #pragma endFor\n  #endif\n  return result;\n}\n","shadow-mapping.frag":"\n#if NUM_SHADOW_LIGHTS > 0\n  #pragma for id in range(0, NUM_SHADOW_LIGHTS)\n    uniform sampler2D shadowMap_{id};\n    uniform float darkness_{id};\n    uniform float depthScale_{id};\n    uniform float frustumEdgeFalloff_{id};\n    uniform float bias_{id};\n    uniform vec2 texelSize_{id};\n    varying vec4 pos_lightspace_{id};\n    varying float vDepth_{id};\n  #pragma endFor\n#endif\nfloat computeShadow(sampler2D shadowMap, vec4 pos_lightspace, float bias) {\n  vec3 projCoords = pos_lightspace.xyz / pos_lightspace.w;\n  projCoords = projCoords * 0.5 + 0.5;\n  float closestDepth = unpackRGBAToDepth(texture2D(shadowMap, projCoords.xy));\n  float currentDepth = projCoords.z;\n  float shadow = (currentDepth - bias > closestDepth) ? 0.0 : 1.0;\n  return shadow;\n}\nfloat computeFallOff(float esm, vec2 coords, float frustumEdgeFalloff) {\n  float mask = smoothstep(1.0 - frustumEdgeFalloff, 1.0, clamp(dot(coords, coords), 0.0, 1.0));\n  return mix(esm, 1.0, mask);\n}\nfloat computeShadowESM(sampler2D shadowMap, vec4 pos_lightspace, float vDepth, float depthScale, float darkness, float frustumEdgeFalloff) {\n  vec2 projCoords = pos_lightspace.xy / pos_lightspace.w;\n  vec2 shadowUV = projCoords * 0.5 + vec2(0.5);\n  if (shadowUV.x < 0.0 || shadowUV.x > 1.0 || shadowUV.y < 0.0 || shadowUV.y > 1.0) {\n    return 1.0;\n  }\n  float currentDepth = clamp(vDepth, 0.0, 1.0);\n  float closestDepth = unpackRGBAToDepth(texture2D(shadowMap, shadowUV));\n  \n  float esm = clamp(exp(-depthScale * (currentDepth - closestDepth)), 1.0 - darkness, 1.0);\n  return computeFallOff(esm, projCoords, frustumEdgeFalloff);\n}\nfloat computeShadowPCF(sampler2D shadowMap, vec4 pos_lightspace, float vDepth, float darkness, vec2 texelSize, float frustumEdgeFalloff) {\n  vec2 projCoords = pos_lightspace.xy / pos_lightspace.w;\n  vec2 shadowUV = projCoords * 0.5 + vec2(0.5);\n  if (shadowUV.x < 0.0 || shadowUV.x > 1.0 || shadowUV.y < 0.0 || shadowUV.y > 1.0) {\n    return 1.0;\n  }\n  float currentDepth = clamp(vDepth, 0.0, 1.0);\n  float visibility = 1.0;\n  vec2 poissonDisk[4];\n  poissonDisk[0] = vec2(-0.94201624, -0.39906216);\n  poissonDisk[1] = vec2(0.94558609, -0.76890725);\n  poissonDisk[2] = vec2(-0.094184101, -0.92938870);\n  poissonDisk[3] = vec2(0.34495938, 0.29387760);\n  if (unpackRGBAToDepth(texture2D(shadowMap, shadowUV + poissonDisk[0] * texelSize)) < currentDepth) visibility -= 0.25;\n  if (unpackRGBAToDepth(texture2D(shadowMap, shadowUV + poissonDisk[1] * texelSize)) < currentDepth) visibility -= 0.25;\n  if (unpackRGBAToDepth(texture2D(shadowMap, shadowUV + poissonDisk[2] * texelSize)) < currentDepth) visibility -= 0.25;\n  if (unpackRGBAToDepth(texture2D(shadowMap, shadowUV + poissonDisk[3] * texelSize)) < currentDepth) visibility -= 0.25;\n  return computeFallOff(min(1.0, visibility + 1.0 - darkness), projCoords, frustumEdgeFalloff);\n}","skinning.vert":"\nattribute vec4 a_weights;\nattribute vec4 a_joints;\nuniform sampler2D u_jointsTexture;\nuniform float u_jointsTextureSize;\nmat4 getBoneMatrix(const in float i) {\n  float size = u_jointsTextureSize;\n  float j = i * 4.0;\n  float x = mod(j, size);\n  float y = floor(j / size);\n  float dx = 1.0 / size;\n  float dy = 1.0 / size;\n  y = dy * (y + 0.5);\n  vec4 v1 = texture2D(u_jointsTexture, vec2(dx * (x + 0.5), y));\n  vec4 v2 = texture2D(u_jointsTexture, vec2(dx * (x + 1.5), y));\n  vec4 v3 = texture2D(u_jointsTexture, vec2(dx * (x + 2.5), y));\n  vec4 v4 = texture2D(u_jointsTexture, vec2(dx * (x + 3.5), y));\n  return mat4(v1, v2, v3, v4);\n}\nmat4 skinMatrix() {\n  return\n    getBoneMatrix(a_joints.x) * a_weights.x +\n    getBoneMatrix(a_joints.y) * a_weights.y +\n    getBoneMatrix(a_joints.z) * a_weights.z +\n    getBoneMatrix(a_joints.w) * a_weights.w\n    ;\n}","unpack.frag":"\nvec3 unpackNormal(vec4 nmap) {\n  return nmap.xyz * 2.0 - 1.0;\n}\nvec3 unpackRGBE(vec4 rgbe) {\n    return rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}"};var Vn=[{name:"gaussian-blur",vert:"\nattribute vec2 a_position;\nattribute vec2 a_uv0;\nvarying vec2 uv;\nvoid main() {\n  uv = a_uv0;\n  gl_Position = vec4(a_position.x, a_position.y, 0.0, 1.0);\n}",frag:"\nvarying vec2 uv;\nuniform sampler2D texture;\nuniform vec2 pixelSize;\n\nvec4 packDepthToRGBA(float depth) {\n  vec4 ret = vec4(1.0, 255.0, 65025.0, 160581375.0) * depth;\n  ret = fract(ret);\n  ret -= ret.yzww * vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0, 0.0);\n  return ret;\n}\nfloat unpackRGBAToDepth(vec4 color) {\n  return dot(color, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n}\nfloat kGaussianBlur[10];\nfloat log_conv(float x0, float X, float y0, float Y) {\n  return ( X + log( x0 + (y0 * exp(Y - X) ) ) );\n}\nvoid main() {\n  kGaussianBlur[0] = 0.0882357;\n  kGaussianBlur[1] = 0.0957407;\n  kGaussianBlur[2] = 0.101786;\n  kGaussianBlur[3] = 0.106026;\n  kGaussianBlur[4] = 0.108212;\n  kGaussianBlur[5] = 0.108212;\n  kGaussianBlur[6] = 0.106026;\n  kGaussianBlur[7] = 0.101786;\n  kGaussianBlur[8] = 0.0957407;\n  kGaussianBlur[9] = 0.0882357;\n  float sample[10];\n  for (int i = 0; i < 10; ++i) {\n    float offset = float(i) - 4.5;\n    vec2 texCoord = vec2( uv.x + offset * pixelSize.x, uv.y + offset * pixelSize.y);\n    sample[i] = unpackRGBAToDepth(texture2D(texture, texCoord));\n  }\n  float sum = log_conv(kGaussianBlur[0], sample[0], kGaussianBlur[1], sample[1]);\n  for (int i = 2; i < 10; ++i) {\n    sum = log_conv(1.0, sum, kGaussianBlur[i], sample[i]);\n  }\n  gl_FragColor = packDepthToRGBA(sum);\n}\n",defines:[]},{name:"grid",vert:"\nattribute vec2 a_uv0;\nattribute vec3 a_position;\nattribute vec3 a_normal;\nuniform mat4 model;\nuniform mat4 viewProj;\nvarying vec2 uv0;\nvarying vec4 pos_w;\n#if USE_WORLD_POS\n  uniform mat3 normalMatrix;\n  varying vec3 normal_w;\n#endif\nvoid main () {\n  uv0 = a_uv0;\n  pos_w = model * vec4(a_position, 1);\n  #if USE_WORLD_POS\n    normal_w = normalMatrix * a_normal;\n  #endif\n  gl_Position = viewProj * pos_w;\n}",frag:"\nvarying vec2 uv0;\nvarying vec4 pos_w;\n#if USE_WORLD_POS\n  varying vec3 normal_w;\n#endif\nuniform vec2 tiling;\nuniform vec3 baseColorWhite;\nuniform vec3 baseColorBlack;\nuniform sampler2D basePattern;\nuniform vec2 basePatternTiling;\nuniform vec2 basePatternOffset;\nuniform vec4 subPatternColor;\nuniform sampler2D subPattern;\nuniform vec2 subPatternTiling;\nuniform vec2 subPatternOffset;\nuniform vec4 subPatternColor2;\nuniform sampler2D subPattern2;\nuniform vec2 subPattern2Tiling;\nuniform vec2 subPattern2Offset;\nvoid main () {\n  vec2 uv = uv0 * tiling;\n  vec2 uvBase = uv * basePatternTiling + basePatternOffset;\n  vec2 uvSub = uv * subPatternTiling + subPatternOffset;\n  vec2 uvSub2 = uv * subPattern2Tiling + subPattern2Offset;\n  #if USE_WORLD_POS\n    vec3 dnormal_w = normalize(normal_w);\n    if (abs(dnormal_w.x)>0.5) { \n      uvBase = (pos_w.zy * tiling * basePatternTiling) + basePatternOffset;\n      uvSub = (pos_w.zy * tiling * subPatternTiling) + subPatternOffset;\n      uvSub2 = (pos_w.zy * tiling * subPattern2Tiling) + subPattern2Offset;\n    } else if (abs(dnormal_w.z)>0.5) { \n      uvBase = (pos_w.xy * tiling * basePatternTiling) + basePatternOffset;\n      uvSub = (pos_w.xy * tiling * subPatternTiling) + subPatternOffset;\n      uvSub2 = (pos_w.xy * tiling * subPattern2Tiling) + subPattern2Offset;\n    } else { \n      uvBase = (pos_w.xz * tiling * basePatternTiling) + basePatternOffset;\n      uvSub = (pos_w.xz * tiling * subPatternTiling) + subPatternOffset;\n      uvSub2 = (pos_w.xz * tiling * subPattern2Tiling) + subPattern2Offset;\n    }\n  #endif\n  vec4 texColBase = texture2D(basePattern, uvBase);\n  vec4 texColSub = texture2D(subPattern, uvSub);\n  vec4 texColSub2 = texture2D(subPattern2, uvSub2);\n  \n  \n  \n  vec4 color = vec4(baseColorWhite,1) * texColBase + vec4(baseColorBlack,1) * (1.0-texColBase);\n  color =\n    color * (1.0 - texColSub) +\n    (subPatternColor * subPatternColor.a + color * (1.0-subPatternColor.a)) * texColSub\n    ;\n  color =\n    color * (1.0 - texColSub2) +\n    (subPatternColor2 * subPatternColor2.a + color * (1.0-subPatternColor2.a)) * texColSub2\n    ;\n  \n  \n  gl_FragColor = color;\n}",defines:[{name:"USE_WORLD_POS"}]},{name:"line",vert:"\nattribute vec3 a_position;\nattribute vec3 a_color;\nuniform mat4 model;\nuniform mat4 viewProj;\nvarying vec3 color;\nvoid main () {\n  vec4 pos = viewProj * model * vec4(a_position, 1);\n  \n  \n  \n  \n  \n  \n  \n  \n  \n  \n  \n  \n  \n  \n  \n  \n  color = a_color;\n  gl_Position = pos;\n}",frag:"\nvarying vec3 color;\nvoid main () {\n  gl_FragColor = vec4(color, 1.0);\n}",defines:[]},{name:"matcap",vert:"\nattribute vec3 a_position;\nattribute vec3 a_normal;\nuniform   mat4 model;\nuniform   mat4 viewProj;\nuniform   mat3 normalMatrix;\nvarying   vec2 matcapUV;\n#if USE_MAIN_TEX\n  attribute vec2 a_uv0;\n  varying   vec2 uv0;\n#endif\n#if USE_SKINNING\n  \nattribute vec4 a_weights;\nattribute vec4 a_joints;\nuniform sampler2D u_jointsTexture;\nuniform float u_jointsTextureSize;\nmat4 getBoneMatrix(const in float i) {\n  float size = u_jointsTextureSize;\n  float j = i * 4.0;\n  float x = mod(j, size);\n  float y = floor(j / size);\n  float dx = 1.0 / size;\n  float dy = 1.0 / size;\n  y = dy * (y + 0.5);\n  vec4 v1 = texture2D(u_jointsTexture, vec2(dx * (x + 0.5), y));\n  vec4 v2 = texture2D(u_jointsTexture, vec2(dx * (x + 1.5), y));\n  vec4 v3 = texture2D(u_jointsTexture, vec2(dx * (x + 2.5), y));\n  vec4 v4 = texture2D(u_jointsTexture, vec2(dx * (x + 3.5), y));\n  return mat4(v1, v2, v3, v4);\n}\nmat4 skinMatrix() {\n  return\n    getBoneMatrix(a_joints.x) * a_weights.x +\n    getBoneMatrix(a_joints.y) * a_weights.y +\n    getBoneMatrix(a_joints.z) * a_weights.z +\n    getBoneMatrix(a_joints.w) * a_weights.w\n    ;\n}\n#endif\nvoid main(void){\n  #if USE_MAIN_TEX\n    uv0 = a_uv0;\n  #endif\n  vec4 pos = vec4(a_position, 1);\n  #if USE_SKINNING\n    mat4 skinMat = skinMatrix();\n    pos = skinMat * pos;\n  #endif\n  pos = viewProj * model * pos;\n  gl_Position = pos;\n  vec4 normal = vec4(a_normal, 0);\n  #if USE_SKINNING\n    normal = skinMat * normal;\n  #endif\n  normal = vec4(normalize(normalMatrix * normal.xyz), 0);\n  matcapUV = normal.xy;\n  matcapUV = matcapUV * 0.5 + 0.5;\n}",frag:"\nprecision mediump float;\nuniform sampler2D matcapTex;\nuniform float colorFactor;\nuniform vec4 color;\nvarying vec2 matcapUV;\n#if USE_MAIN_TEX\n  varying vec2 uv0;\n  uniform sampler2D mainTex;\n#endif\nvoid main(void){\n  vec4 col = vec4(1, 1, 1, 1);\n  col *= color;\n  #if USE_MAIN_TEX\n    col *= texture2D(mainTex, uv0);\n  #endif\n  vec4 matcapColor = texture2D(matcapTex, matcapUV);\n  gl_FragColor = col * colorFactor + matcapColor * (1.0 - colorFactor);\n}",defines:[{name:"USE_MAIN_TEX"},{name:"USE_SKINNING"}]},{name:"particle-add-multiply",vert:"\nattribute vec3 a_position; \nattribute vec3 a_uv;  \nattribute vec2 a_uv0; \nattribute vec4 a_color;\n#if USE_STRETCHED_BILLBOARD\nattribute vec3 a_color0; \n#endif\nuniform vec2 frameTile; \nuniform vec2 mainTiling;\nuniform vec2 mainOffset;\nuniform mat4 model;\nuniform mat4 viewProj;\n#if USE_BILLBOARD || USE_VERTICAL_BILLBOARD\n  uniform mat4 view;\n#endif\n#if USE_STRETCHED_BILLBOARD\n  uniform vec3 eye;\n  uniform float velocityScale;\n  uniform float lengthScale;\n#endif\nvarying vec2 uv;\nvarying vec4 color;\nvoid main () {\n  vec4 pos = vec4(a_position, 1);\n#if USE_STRETCHED_BILLBOARD\n  vec4 velocity = vec4(a_color0.xyz,0);\n#endif\n#if USE_WORLD_SPACE\n  \n#else\n  pos = model * pos;\n  #if USE_STRETCHED_BILLBOARD\n  velocity = model * velocity;\n  #endif\n#endif\n  vec2 cornerOffset = vec2((a_uv.x - 0.5) * a_uv0.x, (a_uv.y - 0.5) * a_uv0.x); \n#if USE_STRETCHED_BILLBOARD\n  \n#else\n  \n  vec2 rotatedOffset;\n  rotatedOffset.x = cos(a_uv0.y) * cornerOffset.x - sin(a_uv0.y) * cornerOffset.y;\n  rotatedOffset.y = sin(a_uv0.y) * cornerOffset.x + cos(a_uv0.y) * cornerOffset.y;\n#endif\n#if USE_BILLBOARD\n  vec3 camRight = normalize(vec3(view[0][0], view[1][0], view[2][0]));\n  vec3 camUp = normalize(vec3(view[0][1], view[1][1], view[2][1]));\n  pos.xyz += (camRight * rotatedOffset.x) + (camUp * rotatedOffset.y);\n#elif USE_STRETCHED_BILLBOARD\n  vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz));\n  vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * a_uv0.x;\n  pos.xyz += (camRight * abs(cornerOffset.x) * sign(cornerOffset.y)) - camUp * a_uv.x;\n#elif USE_HORIZONTAL_BILLBOARD\n  vec3 camRight = vec3(1, 0, 0);\n  vec3 camUp = vec3(0, 0, -1);\n  pos.xyz += (camRight * rotatedOffset.x) + (camUp * rotatedOffset.y);\n#elif USE_VERTICAL_BILLBOARD\n  vec3 camRight = normalize(vec3(view[0][0], view[1][0], view[2][0]));\n  vec3 camUp = vec3(0, 1, 0);\n  pos.xyz += (camRight * rotatedOffset.x) + (camUp * rotatedOffset.y);\n#else\n  pos.x += rotatedOffset.x;\n  pos.y += rotatedOffset.y;\n#endif\n  pos = viewProj * pos;\n  vec2 aniUV = vec2(0, floor(a_uv.z * frameTile.y));\n  aniUV.x = floor(a_uv.z * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n  aniUV.y = frameTile.y - aniUV.y - 1.0;\n  aniUV = (aniUV.xy + a_uv.xy) / vec2(frameTile.x, frameTile.y);\n  uv = aniUV * mainTiling + mainOffset;\n  color = a_color;\n  gl_Position = pos;\n}",frag:"\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvarying vec2 uv;\nvarying vec4 color;\nvoid main () {\n  \n  vec4 col;\n  vec4 texColor = texture2D(mainTexture, uv);\n  col.rgb = tintColor.rgb * texColor.rgb * color.rgb * vec3(2.0);\n  col.a = (1.0 - texColor.a) * (tintColor.a * color.a * 2.0);\n  gl_FragColor = col;\n}",defines:[{name:"USE_SOFT_PARTICLE"},{name:"USE_BILLBOARD"},{name:"USE_STRETCHED_BILLBOARD"},{name:"USE_HORIZONTAL_BILLBOARD"},{name:"USE_VERTICAL_BILLBOARD"},{name:"USE_WORLD_SPACE"}]},{name:"particle-add-smooth",vert:"\nattribute vec3 a_position; \nattribute vec3 a_uv;  \nattribute vec2 a_uv0; \nattribute vec4 a_color;\n#if USE_STRETCHED_BILLBOARD\nattribute vec3 a_color0; \n#endif\nuniform vec2 frameTile;\nuniform vec2 mainTiling;\nuniform vec2 mainOffset;\nuniform mat4 model;\nuniform mat4 viewProj;\n#if USE_BILLBOARD || USE_VERTICAL_BILLBOARD\n  uniform mat4 view;\n#endif\n#if USE_STRETCHED_BILLBOARD\n  uniform vec3 eye;\n  uniform float velocityScale;\n  uniform float lengthScale;\n#endif\nvarying vec2 uv;\nvarying vec4 color;\nvoid main () {\n  vec4 pos = vec4(a_position, 1);\n#if USE_STRETCHED_BILLBOARD\n  vec4 velocity = vec4(a_color0.xyz,0);\n#endif\n#if USE_WORLD_SPACE\n  \n#else\n  pos = model * pos;\n  #if USE_STRETCHED_BILLBOARD\n  velocity = model * velocity;\n  #endif\n#endif\n  vec2 cornerOffset = vec2((a_uv.x - 0.5) * a_uv0.x, (a_uv.y - 0.5) * a_uv0.x);\n#if USE_STRETCHED_BILLBOARD\n  \n#else\n  \n  vec2 rotatedOffset;\n  rotatedOffset.x = cos(a_uv0.y) * cornerOffset.x - sin(a_uv0.y) * cornerOffset.y;\n  rotatedOffset.y = sin(a_uv0.y) * cornerOffset.x + cos(a_uv0.y) * cornerOffset.y;\n#endif\n#if USE_BILLBOARD\n  vec3 camRight = normalize(vec3(view[0][0], view[1][0], view[2][0]));\n  vec3 camUp = normalize(vec3(view[0][1], view[1][1], view[2][1]));\n  pos.xyz += (camRight * rotatedOffset.x) + (camUp * rotatedOffset.y);\n#elif USE_STRETCHED_BILLBOARD\n  vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz));\n  vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * a_uv0.x;\n  pos.xyz += (camRight * abs(cornerOffset.x) * sign(cornerOffset.y)) - camUp * a_uv.x;\n#elif USE_HORIZONTAL_BILLBOARD\n  vec3 camRight = vec3(1, 0, 0);\n  vec3 camUp = vec3(0, 0, -1);\n  pos.xyz += (camRight * rotatedOffset.x) + (camUp * rotatedOffset.y);\n#elif USE_VERTICAL_BILLBOARD\n  vec3 camRight = normalize(vec3(view[0][0], view[1][0], view[2][0]));\n  vec3 camUp = vec3(0, 1, 0);\n  pos.xyz += (camRight * rotatedOffset.x) + (camUp * rotatedOffset.y);\n#else\n  pos.x += rotatedOffset.x;\n  pos.y += rotatedOffset.y;\n#endif\n  pos = viewProj * pos;\n  vec2 aniUV = vec2(0, floor(a_uv.z * frameTile.y));\n  aniUV.x = floor(a_uv.z * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n  aniUV.y = frameTile.y - aniUV.y - 1.0;\n  aniUV = (aniUV.xy + a_uv.xy) / vec2(frameTile.x, frameTile.y);\n  uv = aniUV * mainTiling + mainOffset;\n  color = a_color;\n  gl_Position = pos;\n}",frag:"\nuniform sampler2D mainTexture;\nvarying vec2 uv;\nvarying vec4 color;\nvoid main () {\n  \n  vec4 col = color * texture2D(mainTexture, uv);\n  col.rgb *= col.a;\n  gl_FragColor = col;\n}",defines:[{name:"USE_SOFT_PARTICLE"},{name:"USE_BILLBOARD"},{name:"USE_STRETCHED_BILLBOARD"},{name:"USE_HORIZONTAL_BILLBOARD"},{name:"USE_VERTICAL_BILLBOARD"},{name:"USE_WORLD_SPACE"}]},{name:"particle-add",vert:"\nattribute vec3 a_position; \nattribute vec3 a_uv;  \nattribute vec2 a_uv0; \nattribute vec4 a_color;\n#if USE_STRETCHED_BILLBOARD\nattribute vec3 a_color0; \n#endif\nuniform vec2 frameTile;\nuniform vec2 mainTiling;\nuniform vec2 mainOffset;\nuniform mat4 model;\nuniform mat4 viewProj;\n#if USE_BILLBOARD || USE_VERTICAL_BILLBOARD\n  uniform mat4 view;\n#endif\n#if USE_STRETCHED_BILLBOARD\n  uniform vec3 eye;\n  uniform float velocityScale;\n  uniform float lengthScale;\n#endif\nvarying vec2 uv;\nvarying vec4 color;\nvoid main () {\n  vec4 pos = vec4(a_position, 1);\n#if USE_STRETCHED_BILLBOARD\n  vec4 velocity = vec4(a_color0.xyz,0);\n#endif\n#if USE_WORLD_SPACE\n  \n#else\n  pos = model * pos;\n  #if USE_STRETCHED_BILLBOARD\n  velocity = model * velocity;\n  #endif\n#endif\n  vec2 cornerOffset = vec2((a_uv.x - 0.5) * a_uv0.x, (a_uv.y - 0.5) * a_uv0.x);\n#if USE_STRETCHED_BILLBOARD\n  \n#else\n  \n  vec2 rotatedOffset;\n  rotatedOffset.x = cos(a_uv0.y) * cornerOffset.x - sin(a_uv0.y) * cornerOffset.y;\n  rotatedOffset.y = sin(a_uv0.y) * cornerOffset.x + cos(a_uv0.y) * cornerOffset.y;\n#endif\n#if USE_BILLBOARD\n  vec3 camRight = normalize(vec3(view[0][0], view[1][0], view[2][0]));\n  vec3 camUp = normalize(vec3(view[0][1], view[1][1], view[2][1]));\n  pos.xyz += (camRight * rotatedOffset.x) + (camUp * rotatedOffset.y);\n#elif USE_STRETCHED_BILLBOARD\n  vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz));\n  vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * a_uv0.x;\n  pos.xyz += (camRight * abs(cornerOffset.x) * sign(cornerOffset.y)) - camUp * a_uv.x;\n#elif USE_HORIZONTAL_BILLBOARD\n  vec3 camRight = vec3(1, 0, 0);\n  vec3 camUp = vec3(0, 0, -1);\n  pos.xyz += (camRight * rotatedOffset.x) + (camUp * rotatedOffset.y);\n#elif USE_VERTICAL_BILLBOARD\n  vec3 camRight = normalize(vec3(view[0][0], view[1][0], view[2][0]));\n  vec3 camUp = vec3(0, 1, 0);\n  pos.xyz += (camRight * rotatedOffset.x) + (camUp * rotatedOffset.y);\n#else\n  pos.x += rotatedOffset.x;\n  pos.y += rotatedOffset.y;\n#endif\n  pos = viewProj * pos;\n  vec2 aniUV = vec2(0, floor(a_uv.z * frameTile.y));\n  aniUV.x = floor(a_uv.z * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n  aniUV.y = frameTile.y - aniUV.y - 1.0;\n  aniUV = (aniUV.xy + a_uv.xy) / vec2(frameTile.x, frameTile.y);\n  uv = aniUV * mainTiling + mainOffset;\n  color = a_color;\n  gl_Position = pos;\n}",frag:"\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvarying vec2 uv;\nvarying vec4 color;\nvoid main () {\n  \n  gl_FragColor = 2.0 * color * tintColor * texture2D(mainTexture, uv);\n}",defines:[{name:"USE_SOFT_PARTICLE"},{name:"USE_BILLBOARD"},{name:"USE_STRETCHED_BILLBOARD"},{name:"USE_HORIZONTAL_BILLBOARD"},{name:"USE_VERTICAL_BILLBOARD"},{name:"USE_WORLD_SPACE"}]},{name:"particle-alpha-blend",vert:"\nattribute vec3 a_position; \nattribute vec3 a_uv;  \nattribute vec2 a_uv0; \nattribute vec4 a_color;\n#if USE_STRETCHED_BILLBOARD\nattribute vec3 a_color0; \n#endif\nuniform vec2 frameTile;\nuniform vec2 mainTiling;\nuniform vec2 mainOffset;\nuniform mat4 model;\nuniform mat4 viewProj;\n#if USE_BILLBOARD || USE_VERTICAL_BILLBOARD\n  uniform mat4 view;\n#endif\n#if USE_STRETCHED_BILLBOARD\n  uniform vec3 eye;\n  uniform float velocityScale;\n  uniform float lengthScale;\n#endif\nvarying vec2 uv;\nvarying vec4 color;\nvoid main () {\n  vec4 pos = vec4(a_position, 1);\n#if USE_STRETCHED_BILLBOARD\n  vec4 velocity = vec4(a_color0.xyz,0);\n#endif\n#if USE_WORLD_SPACE\n  \n#else\n  pos = model * pos;\n  #if USE_STRETCHED_BILLBOARD\n  velocity = model * velocity;\n  #endif\n#endif\n  vec2 cornerOffset = vec2((a_uv.x - 0.5) * a_uv0.x, (a_uv.y - 0.5) * a_uv0.x); \n#if USE_STRETCHED_BILLBOARD\n  \n#else\n  \n  vec2 rotatedOffset;\n  rotatedOffset.x = cos(a_uv0.y) * cornerOffset.x - sin(a_uv0.y) * cornerOffset.y;\n  rotatedOffset.y = sin(a_uv0.y) * cornerOffset.x + cos(a_uv0.y) * cornerOffset.y;\n#endif\n#if USE_BILLBOARD\n  vec3 camRight = normalize(vec3(view[0][0], view[1][0], view[2][0]));\n  vec3 camUp = normalize(vec3(view[0][1], view[1][1], view[2][1]));\n  pos.xyz += (camRight * rotatedOffset.x) + (camUp * rotatedOffset.y);\n#elif USE_STRETCHED_BILLBOARD\n  vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz));\n  vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * a_uv0.x;\n  pos.xyz += (camRight * abs(cornerOffset.x) * sign(cornerOffset.y)) - camUp * a_uv.x;\n#elif USE_HORIZONTAL_BILLBOARD\n  vec3 camRight = vec3(1, 0, 0);\n  vec3 camUp = vec3(0, 0, -1);\n  pos.xyz += (camRight * rotatedOffset.x) + (camUp * rotatedOffset.y);\n#elif USE_VERTICAL_BILLBOARD\n  vec3 camRight = normalize(vec3(view[0][0], view[1][0], view[2][0]));\n  vec3 camUp = vec3(0, 1, 0);\n  pos.xyz += (camRight * rotatedOffset.x) + (camUp * rotatedOffset.y);\n#else\n  pos.x += rotatedOffset.x;\n  pos.y += rotatedOffset.y;\n#endif\n  pos = viewProj * pos;\n  vec2 aniUV = vec2(0, floor(a_uv.z * frameTile.y));\n  aniUV.x = floor(a_uv.z * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n  aniUV.y = frameTile.y - aniUV.y - 1.0;\n  aniUV = (aniUV.xy + a_uv.xy) / vec2(frameTile.x, frameTile.y);\n  uv = aniUV * mainTiling + mainOffset;\n  color = a_color;\n  gl_Position = pos;\n}",frag:"\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvarying vec2 uv;\nvarying vec4 color;\nvoid main () {\n  \n  gl_FragColor = 2.0 * color * tintColor * texture2D(mainTexture, uv);\n}",defines:[{name:"USE_SOFT_PARTICLE"},{name:"USE_BILLBOARD"},{name:"USE_STRETCHED_BILLBOARD"},{name:"USE_HORIZONTAL_BILLBOARD"},{name:"USE_VERTICAL_BILLBOARD"},{name:"USE_WORLD_SPACE"}]},{name:"particle-premultiply-blend",vert:"\nattribute vec3 a_position; \nattribute vec3 a_uv;  \nattribute vec2 a_uv0; \nattribute vec4 a_color;\n#if USE_STRETCHED_BILLBOARD\nattribute vec3 a_color0; \n#endif\nuniform vec2 frameTile;\nuniform vec2 mainTiling;\nuniform vec2 mainOffset;\nuniform mat4 model;\nuniform mat4 viewProj;\n#if USE_BILLBOARD || USE_VERTICAL_BILLBOARD\n  uniform mat4 view;\n#endif\n#if USE_STRETCHED_BILLBOARD\n  uniform vec3 eye;\n  uniform float velocityScale;\n  uniform float lengthScale;\n#endif\nvarying vec2 uv;\nvarying vec4 color;\nvoid main () {\n  vec4 pos = vec4(a_position, 1);\n#if USE_STRETCHED_BILLBOARD\n  vec4 velocity = vec4(a_color0.xyz,0);\n#endif\n#if USE_WORLD_SPACE\n  \n#else\n  pos = model * pos;\n  #if USE_STRETCHED_BILLBOARD\n  velocity = model * velocity;\n  #endif\n#endif\n  vec2 cornerOffset = vec2((a_uv.x - 0.5) * a_uv0.x, (a_uv.y - 0.5) * a_uv0.x);\n#if USE_STRETCHED_BILLBOARD\n  \n#else\n  \n  vec2 rotatedOffset;\n  rotatedOffset.x = cos(a_uv0.y) * cornerOffset.x - sin(a_uv0.y) * cornerOffset.y;\n  rotatedOffset.y = sin(a_uv0.y) * cornerOffset.x + cos(a_uv0.y) * cornerOffset.y;\n#endif\n#if USE_BILLBOARD\n  vec3 camRight = normalize(vec3(view[0][0], view[1][0], view[2][0]));\n  vec3 camUp = normalize(vec3(view[0][1], view[1][1], view[2][1]));\n  pos.xyz += (camRight * rotatedOffset.x) + (camUp * rotatedOffset.y);\n#elif USE_STRETCHED_BILLBOARD\n  vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz));\n  vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * a_uv0.x;\n  pos.xyz += (camRight * abs(cornerOffset.x) * sign(cornerOffset.y)) - camUp * a_uv.x;\n#elif USE_HORIZONTAL_BILLBOARD\n  vec3 camRight = vec3(1, 0, 0);\n  vec3 camUp = vec3(0, 0, -1);\n  pos.xyz += (camRight * rotatedOffset.x) + (camUp * rotatedOffset.y);\n#elif USE_VERTICAL_BILLBOARD\n  vec3 camRight = normalize(vec3(view[0][0], view[1][0], view[2][0]));\n  vec3 camUp = vec3(0, 1, 0);\n  pos.xyz += (camRight * rotatedOffset.x) + (camUp * rotatedOffset.y);\n#else\n  pos.x += rotatedOffset.x;\n  pos.y += rotatedOffset.y;\n#endif\n  pos = viewProj * pos;\n  vec2 aniUV = vec2(0, floor(a_uv.z * frameTile.y));\n  aniUV.x = floor(a_uv.z * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n  aniUV.y = frameTile.y - aniUV.y - 1.0;\n  aniUV = (aniUV.xy + a_uv.xy) / vec2(frameTile.x, frameTile.y);\n  uv = aniUV * mainTiling + mainOffset;\n  color = a_color;\n  gl_Position = pos;\n}",frag:"\nuniform sampler2D mainTexture;\nvarying vec2 uv;\nvarying vec4 color;\nvoid main () {\n  \n  gl_FragColor = color * texture2D(mainTexture, uv) * color.a;\n}",defines:[{name:"USE_SOFT_PARTICLE"},{name:"USE_BILLBOARD"},{name:"USE_STRETCHED_BILLBOARD"},{name:"USE_HORIZONTAL_BILLBOARD"},{name:"USE_VERTICAL_BILLBOARD"},{name:"USE_WORLD_SPACE"}]},{name:"pbr",vert:"\nattribute vec3 a_position;\nattribute vec3 a_normal;\nvarying vec3 pos_w;\nvarying vec3 normal_w;\nuniform mat4 model;\nuniform mat4 viewProj;\nuniform mat3 normalMatrix;\n#if USE_NORMAL_TEXTURE || USE_ALBEDO_TEXTURE || USE_MRA_TEXTURE || USE_METALLIC_TEXTURE || USE_ROUGHNESS_TEXTURE || USE_AO_TEXTURE || USE_EMISSIVE_TEXTURE\n  attribute vec2 a_uv0;\n  uniform vec2 mainTiling;\n  uniform vec2 mainOffset;\n  varying vec2 uv0;\n#endif\n#if USE_SKINNING\n  \nattribute vec4 a_weights;\nattribute vec4 a_joints;\nuniform sampler2D u_jointsTexture;\nuniform float u_jointsTextureSize;\nmat4 getBoneMatrix(const in float i) {\n  float size = u_jointsTextureSize;\n  float j = i * 4.0;\n  float x = mod(j, size);\n  float y = floor(j / size);\n  float dx = 1.0 / size;\n  float dy = 1.0 / size;\n  y = dy * (y + 0.5);\n  vec4 v1 = texture2D(u_jointsTexture, vec2(dx * (x + 0.5), y));\n  vec4 v2 = texture2D(u_jointsTexture, vec2(dx * (x + 1.5), y));\n  vec4 v3 = texture2D(u_jointsTexture, vec2(dx * (x + 2.5), y));\n  vec4 v4 = texture2D(u_jointsTexture, vec2(dx * (x + 3.5), y));\n  return mat4(v1, v2, v3, v4);\n}\nmat4 skinMatrix() {\n  return\n    getBoneMatrix(a_joints.x) * a_weights.x +\n    getBoneMatrix(a_joints.y) * a_weights.y +\n    getBoneMatrix(a_joints.z) * a_weights.z +\n    getBoneMatrix(a_joints.w) * a_weights.w\n    ;\n}\n#endif\n#if USE_SHADOW_MAP\n  #if NUM_SHADOW_LIGHTS > 0\n    #pragma for id in range(0, NUM_SHADOW_LIGHTS)\n      uniform mat4 lightViewProjMatrix_{id};\n      uniform float minDepth_{id};\n      uniform float maxDepth_{id};\n      varying vec4 pos_lightspace_{id};\n      varying float vDepth_{id};\n    #pragma endFor\n  #endif\n#endif\nvoid main () {\n  vec4 pos = vec4(a_position, 1);\n  #if USE_SKINNING\n    mat4 skinMat = skinMatrix();\n    pos = skinMat * pos;\n  #endif\n  pos_w = (model * pos).xyz;\n  pos = viewProj * model * pos;\n  #if USE_NORMAL_TEXTURE || USE_ALBEDO_TEXTURE || USE_MRA_TEXTURE || USE_METALLIC_TEXTURE || USE_ROUGHNESS_TEXTURE || USE_AO_TEXTURE || USE_EMISSIVE_TEXTURE\n    uv0 = a_uv0 * mainTiling + mainOffset;\n  #endif\n  vec4 normal = vec4(a_normal, 0);\n  #if USE_SKINNING\n    normal = skinMat * normal;\n  #endif\n  normal_w = normalMatrix * normal.xyz;\n  #if USE_SHADOW_MAP\n    #if NUM_SHADOW_LIGHTS > 0\n      #pragma for id in range(0, NUM_SHADOW_LIGHTS)\n        pos_lightspace_{id} = lightViewProjMatrix_{id} * vec4(pos_w, 1.0);\n        vDepth_{id} = (pos_lightspace_{id}.z + minDepth_{id}) / (minDepth_{id} + maxDepth_{id});\n      #pragma endFor\n    #endif\n  #endif\n  gl_Position = pos;\n}",frag:"\n#if USE_NORMAL_TEXTURE\n#extension GL_OES_standard_derivatives : enable\n#endif\n#if USE_TEX_LOD\n#extension GL_EXT_shader_texture_lod: enable\n#endif\n\n#define PI 3.14159265359\n#define PI2 6.28318530718\n#define EPSILON 1e-6\n#define LOG2 1.442695\n#define saturate(a) clamp( a, 0.0, 1.0 )\n\nvec3 gammaToLinearSpaceRGB(vec3 sRGB) { \n  return sRGB * (sRGB * (sRGB * 0.305306011 + 0.682171111) + 0.012522878);\n}\nvec3 linearToGammaSpaceRGB(vec3 RGB) { \n  vec3 S1 = sqrt(RGB);\n  vec3 S2 = sqrt(S1);\n  vec3 S3 = sqrt(S2);\n  return 0.585122381 * S1 + 0.783140355 * S2 - 0.368262736 * S3;\n}\nvec4 gammaToLinearSpaceRGBA(vec4 sRGBA) {\n  return vec4(gammaToLinearSpaceRGB(sRGBA.rgb), sRGBA.a);\n}\nvec4 linearToGammaSpaceRGBA(vec4 RGBA) {\n  return vec4(linearToGammaSpaceRGB(RGBA.rgb), RGBA.a);\n}\nfloat gammaToLinearSpaceExact(float val) {\n  if (val <= 0.04045) {\n    return val / 12.92;\n  } else if (val < 1.0) {\n    return pow((val + 0.055) / 1.055, 2.4);\n  } else {\n    return pow(val, 2.2);\n  }\n}\nfloat linearToGammaSpaceExact(float val) {\n  if (val <= 0.0) {\n    return 0.0;\n  } else if (val <= 0.0031308) {\n    return 12.92 * val;\n  } else if (val < 1.0) {\n    return 1.055 * pow(val, 0.4166667) - 0.055;\n  } else {\n    return pow(val, 0.45454545);\n  }\n}\n\nstruct LightInfo {\n  vec3 lightDir;\n  vec3 radiance;\n};\n#if NUM_DIR_LIGHTS > 0\n  #pragma for id in range(0, NUM_DIR_LIGHTS)\n    uniform vec3 dir_light{id}_direction;\n    uniform vec3 dir_light{id}_color;\n  #pragma endFor\n#endif\n#if NUM_POINT_LIGHTS > 0\n  #pragma for id in range(0, NUM_POINT_LIGHTS)\n    uniform vec3 point_light{id}_position;\n    uniform vec3 point_light{id}_color;\n    uniform float point_light{id}_range;\n  #pragma endFor\n#endif\n#if NUM_SPOT_LIGHTS > 0\n  #pragma for id in range(0, NUM_SPOT_LIGHTS)\n    uniform vec3 spot_light{id}_position;\n    uniform vec3 spot_light{id}_direction;\n    uniform vec3 spot_light{id}_color;\n    uniform vec2 spot_light{id}_spot;\n    uniform float spot_light{id}_range;\n  #pragma endFor\n#endif\nLightInfo computeDirectionalLighting(\n  vec3 lightDirection,\n  vec3 lightColor\n) {\n  LightInfo ret;\n  ret.lightDir = -normalize(lightDirection);\n  ret.radiance = lightColor;\n  return ret;\n}\nLightInfo computePointLighting(\n  vec3 lightPosition,\n  vec3 positionW,\n  vec3 lightColor,\n  float lightRange\n) {\n  LightInfo ret;\n  vec3 lightDir = lightPosition - positionW;\n  float attenuation = max(0.0, 1.0 - length(lightDir) / lightRange);\n  ret.lightDir = normalize(lightDir);\n  ret.radiance = lightColor * attenuation;\n  return ret;\n}\nLightInfo computeSpotLighting(\n  vec3 lightPosition,\n  vec3 positionW,\n  vec3 lightDirection,\n  vec3 lightColor,\n  vec2 lightSpot,\n  float lightRange\n) {\n  LightInfo ret;\n  vec3 lightDir = lightPosition - positionW;\n  float attenuation = max(0., 1.0 - length(lightDir) / lightRange);\n  float cosConeAngle = max(0., dot(lightDirection, -lightDir));\n  cosConeAngle = cosConeAngle < lightSpot.x ? 0.0 : cosConeAngle;\n  cosConeAngle = pow(cosConeAngle,lightSpot.y);\n  ret.lightDir = normalize(lightDir);\n  ret.radiance = lightColor * attenuation * cosConeAngle;\n  return ret;\n}\n\nvec3 unpackNormal(vec4 nmap) {\n  return nmap.xyz * 2.0 - 1.0;\n}\nvec3 unpackRGBE(vec4 rgbe) {\n    return rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\n#if USE_SHADOW_MAP\n  \nvec4 packDepthToRGBA(float depth) {\n  vec4 ret = vec4(1.0, 255.0, 65025.0, 160581375.0) * depth;\n  ret = fract(ret);\n  ret -= ret.yzww * vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0, 0.0);\n  return ret;\n}\nfloat unpackRGBAToDepth(vec4 color) {\n  return dot(color, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n}\n  \n#if NUM_SHADOW_LIGHTS > 0\n  #pragma for id in range(0, NUM_SHADOW_LIGHTS)\n    uniform sampler2D shadowMap_{id};\n    uniform float darkness_{id};\n    uniform float depthScale_{id};\n    uniform float frustumEdgeFalloff_{id};\n    uniform float bias_{id};\n    uniform vec2 texelSize_{id};\n    varying vec4 pos_lightspace_{id};\n    varying float vDepth_{id};\n  #pragma endFor\n#endif\nfloat computeShadow(sampler2D shadowMap, vec4 pos_lightspace, float bias) {\n  vec3 projCoords = pos_lightspace.xyz / pos_lightspace.w;\n  projCoords = projCoords * 0.5 + 0.5;\n  float closestDepth = unpackRGBAToDepth(texture2D(shadowMap, projCoords.xy));\n  float currentDepth = projCoords.z;\n  float shadow = (currentDepth - bias > closestDepth) ? 0.0 : 1.0;\n  return shadow;\n}\nfloat computeFallOff(float esm, vec2 coords, float frustumEdgeFalloff) {\n  float mask = smoothstep(1.0 - frustumEdgeFalloff, 1.0, clamp(dot(coords, coords), 0.0, 1.0));\n  return mix(esm, 1.0, mask);\n}\nfloat computeShadowESM(sampler2D shadowMap, vec4 pos_lightspace, float vDepth, float depthScale, float darkness, float frustumEdgeFalloff) {\n  vec2 projCoords = pos_lightspace.xy / pos_lightspace.w;\n  vec2 shadowUV = projCoords * 0.5 + vec2(0.5);\n  if (shadowUV.x < 0.0 || shadowUV.x > 1.0 || shadowUV.y < 0.0 || shadowUV.y > 1.0) {\n    return 1.0;\n  }\n  float currentDepth = clamp(vDepth, 0.0, 1.0);\n  float closestDepth = unpackRGBAToDepth(texture2D(shadowMap, shadowUV));\n  \n  float esm = clamp(exp(-depthScale * (currentDepth - closestDepth)), 1.0 - darkness, 1.0);\n  return computeFallOff(esm, projCoords, frustumEdgeFalloff);\n}\nfloat computeShadowPCF(sampler2D shadowMap, vec4 pos_lightspace, float vDepth, float darkness, vec2 texelSize, float frustumEdgeFalloff) {\n  vec2 projCoords = pos_lightspace.xy / pos_lightspace.w;\n  vec2 shadowUV = projCoords * 0.5 + vec2(0.5);\n  if (shadowUV.x < 0.0 || shadowUV.x > 1.0 || shadowUV.y < 0.0 || shadowUV.y > 1.0) {\n    return 1.0;\n  }\n  float currentDepth = clamp(vDepth, 0.0, 1.0);\n  float visibility = 1.0;\n  vec2 poissonDisk[4];\n  poissonDisk[0] = vec2(-0.94201624, -0.39906216);\n  poissonDisk[1] = vec2(0.94558609, -0.76890725);\n  poissonDisk[2] = vec2(-0.094184101, -0.92938870);\n  poissonDisk[3] = vec2(0.34495938, 0.29387760);\n  if (unpackRGBAToDepth(texture2D(shadowMap, shadowUV + poissonDisk[0] * texelSize)) < currentDepth) visibility -= 0.25;\n  if (unpackRGBAToDepth(texture2D(shadowMap, shadowUV + poissonDisk[1] * texelSize)) < currentDepth) visibility -= 0.25;\n  if (unpackRGBAToDepth(texture2D(shadowMap, shadowUV + poissonDisk[2] * texelSize)) < currentDepth) visibility -= 0.25;\n  if (unpackRGBAToDepth(texture2D(shadowMap, shadowUV + poissonDisk[3] * texelSize)) < currentDepth) visibility -= 0.25;\n  return computeFallOff(min(1.0, visibility + 1.0 - darkness), projCoords, frustumEdgeFalloff);\n}\n#endif\nuniform vec3 eye;\nvarying vec3 pos_w;\nvarying vec3 normal_w;\n#if USE_NORMAL_TEXTURE || USE_ALBEDO_TEXTURE || USE_MRA_TEXTURE || USE_METALLIC_TEXTURE || USE_ROUGHNESS_TEXTURE || USE_AO_TEXTURE || USE_EMISSIVE_TEXTURE\n  varying vec2 uv0;\n#endif\n#if USE_IBL\n  uniform samplerCube diffuseEnvTexture;\n  uniform samplerCube specularEnvTexture;\n  uniform sampler2D brdfLUT;\n  #if USE_TEX_LOD\n    uniform float maxReflectionLod;\n  #endif\n#endif\nuniform vec4 albedo;\n#if USE_ALBEDO_TEXTURE\n  uniform sampler2D albedo_texture;\n#endif\n#if USE_MRA_TEXTURE\n  uniform vec2 sampler2D mra_texture;\n#endif\nuniform float metallic;\n#if USE_METALLIC_TEXTURE\n  uniform sampler2D metallic_texture;\n#endif\nuniform float roughness;\n#if USE_ROUGHNESS_TEXTURE\n  uniform sampler2D roughness_texture;\n#endif\nuniform float ao;\n#if USE_AO_TEXTURE\n  uniform sampler2D ao_texture;\n#endif\n#if USE_EMISSIVE\n  uniform vec3 emissive;\n  #if USE_EMISSIVE_TEXTURE\n    uniform sampler2D emissive_texture;\n  #endif\n#endif\n#if USE_ALPHA_TEST\n  uniform float alphaTestThreshold;\n#endif\n#if USE_NORMAL_TEXTURE\n  uniform sampler2D normal_texture;\n  \n  vec3 getNormalFromTexture() {\n    vec3 tangentNormal = texture2D(normal_texture, uv0).rgb * 2.0 - 1.0;\n    vec3 q1  = dFdx(pos_w);\n    vec3 q2  = dFdy(pos_w);\n    vec2 st1 = dFdx(uv0);\n    vec2 st2 = dFdy(uv0);\n    vec3 N   = normalize(normal_w);\n    vec3 T   = normalize(q1*st2.t - q2*st1.t);\n    vec3 B   = -normalize(cross(N, T));\n    mat3 TBN = mat3(T, B, N);\n    return normalize(TBN * tangentNormal);\n  }\n#endif\nfloat distributionGGX(vec3 N, vec3 H, float roughness) {\n  float a = roughness * roughness;\n  float a2 = a * a;\n  float NdotH = max(dot(N, H), 0.0);\n  float NdotH2 = NdotH * NdotH;\n  float nom   = a2;\n  float denom = (NdotH2 * (a2 - 1.0) + 1.0);\n  denom = PI * denom * denom;\n  return nom / denom;\n}\nfloat geometrySchlickGGX(float NdotV, float roughness) {\n  float r = (roughness + 1.0);\n  float k = (r * r) / 8.0;\n  float nom   = NdotV;\n  float denom = NdotV * (1.0 - k) + k;\n  return nom / denom;\n}\nfloat geometrySmith(vec3 N, vec3 V, vec3 L, float roughness) {\n  float NdotV = max(dot(N, V), 0.0);\n  float NdotL = max(dot(N, L), 0.0);\n  float ggx2 = geometrySchlickGGX(NdotV, roughness);\n  float ggx1 = geometrySchlickGGX(NdotL, roughness);\n  return ggx1 * ggx2;\n}\nvec3 fresnelSchlick(float cosTheta, vec3 F0) {\n  float fresnel = exp2((-5.55473 * cosTheta - 6.98316) * cosTheta);\n  return F0 + (1.0 - F0) * fresnel;\n}\nvec3 fresnelSchlickRoughness(float cosTheta, vec3 F0, float roughness) {\n  float fresnel = exp2((-5.55473 * cosTheta - 6.98316) * cosTheta);\n  return F0 + (max(vec3(1.0 - roughness), F0) - F0) * fresnel;\n}\nvec3 brdf(LightInfo lightInfo, vec3 N, vec3 V, vec3 F0, vec3 albedo, float metallic, float roughness) {\n  vec3 H = normalize(V + lightInfo.lightDir);\n  float NDF = distributionGGX(N, H, roughness);\n  float G   = geometrySmith(N, V, lightInfo.lightDir, roughness);\n  vec3 F    = fresnelSchlick(max(dot(H, V), 0.0), F0);\n  vec3 nominator    = NDF * G * F;\n  float denominator = 4.0 * max(dot(N, V), 0.0) * max(dot(N, lightInfo.lightDir), 0.0) + 0.001; \n  vec3 specular = nominator / denominator;\n  \n  vec3 kS = F;\n  \n  \n  \n  vec3 kD = vec3(1.0) - kS;\n  \n  \n  \n  kD *= 1.0 - metallic;\n  float NdotL = max(dot(N, lightInfo.lightDir), 0.0);\n  return (kD * albedo / PI + specular) * lightInfo.radiance * NdotL;\n}\nvoid main() {\n  float opacity = 1.0;\n  #if USE_ALBEDO_TEXTURE\n    vec4 baseColor = albedo * gammaToLinearSpaceRGBA(texture2D(albedo_texture, uv0));\n    vec3 albedo = baseColor.rgb;\n    opacity = baseColor.a;\n  #else\n    opacity = albedo.a;\n    vec3 albedo = albedo.rgb;\n  #endif\n  #if USE_ALPHA_TEST\n    if(opacity < alphaTestThreshold) discard;\n  #endif\n  #if USE_MRA_TEXTURE\n    vec3 metalRoughness = texture2D(mra_texture, uv0).rgb;\n    float metallic = metalRoughness.r;\n    float roughness = metalRoughness.g;\n    float ao = metalRoughness.b;\n  #else\n    #if USE_METALLIC_TEXTURE\n      float metallic  = texture2D(metallic_texture, uv0).r;\n    #endif\n    #if USE_ROUGHNESS_TEXTURE\n      float roughness  = texture2D(roughness_texture, uv0).r;\n    #endif\n    #if USE_AO_TEXTURE\n      float ao  = texture2D(ao_texture, uv0).r;\n    #endif\n  #endif\n  vec3 N = normalize(normal_w);\n  #if USE_NORMAL_TEXTURE\n    N = getNormalFromTexture();\n  #endif\n  vec3 V = normalize(eye - pos_w);\n  \n  \n  vec3 F0 = vec3(0.04);\n  F0 = mix(F0, albedo, metallic);\n  \n  vec3 Lo = vec3(0.0);\n  \n  #if NUM_POINT_LIGHTS > 0\n    #pragma for id in range(0, NUM_POINT_LIGHTS)\n      LightInfo pointLight{id};\n      pointLight{id} = computePointLighting(point_light{id}_position, pos_w, point_light{id}_color, point_light{id}_range);\n      Lo += brdf(pointLight{id}, N, V, F0, albedo, metallic, roughness);\n    #pragma endFor\n  #endif\n  #if NUM_DIR_LIGHTS > 0\n    #pragma for id in range(0, NUM_DIR_LIGHTS)\n      LightInfo directionalLight{id};\n      directionalLight{id} = computeDirectionalLighting(dir_light{id}_direction, dir_light{id}_color);\n      Lo += brdf(directionalLight{id}, N, V, F0, albedo, metallic, roughness);\n    #pragma endFor\n  #endif\n  #if NUM_SPOT_LIGHTS > 0\n    #pragma for id in range(0, NUM_SPOT_LIGHTS)\n      LightInfo spotLight{id};\n      spotLight{id} = computeSpotLighting(spot_light{id}_position, pos_w, spot_light{id}_direction, spot_light{id}_color, spot_light{id}_spot, spot_light{id}_range);\n      Lo += brdf(spotLight{id}, N, V, F0, albedo, metallic, roughness);\n    #pragma endFor\n  #endif\n  #if USE_EMISSIVE\n    vec3 emissiveColor = gammaToLinearSpaceRGB(emissive);\n    #if USE_EMISSIVE_TEXTURE\n      emissiveColor *= gammaToLinearSpaceRGB(texture2D(emissive_texture, uv0).rgb);\n    #endif\n    Lo += emissiveColor;\n  #endif\n  \n  vec3 ambient = vec3(0.03) * albedo * ao;\n  #if USE_IBL\n    \n    vec3 F = fresnelSchlickRoughness(max(dot(N, V), 0.0), F0, roughness);\n    vec3 kS = F;\n    vec3 kD = vec3(1.0) - kS;\n    kD *= 1.0 - metallic;\n    #if USE_RGBE_HDR_IBL_DIFFUSE\n      vec3 diffuseEnv = unpackRGBE(textureCube(diffuseEnvTexture, N));\n    #else\n      vec3 diffuseEnv = textureCube(diffuseEnvTexture, N).rgb;\n    #endif\n    vec3 diffuse = diffuseEnv * albedo;\n    \n    vec3 R = reflect(-V, N);\n    #if USE_TEX_LOD\n      #if USE_RGBE_HDR_IBL_SPECULAR\n        vec3 specularEnv = unpackRGBE(textureCubeLodEXT(specularEnvTexture, R, roughness * maxReflectionLod));\n      #else\n        vec3 specularEnv = textureCubeLodEXT(specularEnvTexture, R, roughness * maxReflectionLod).rgb;\n      #endif\n    #else\n      #if USE_RGBE_HDR_IBL_SPECULAR\n        vec3 specularEnv = unpackRGBE(textureCube(specularEnvTexture, R));\n      #else\n        vec3 specularEnv = textureCube(specularEnvTexture, R).rgb;\n      #endif\n    #endif\n    vec2 brdf  = texture2D(brdfLUT, vec2(max(dot(N, V), 0.0), roughness)).rg;\n    vec3 specular = specularEnv * (F * brdf.x + brdf.y);\n    ambient = (kD * diffuse + specular) * ao;\n  #endif\n  #if USE_SHADOW_MAP\n    float shadow = 1.0;\n    #if NUM_SHADOW_LIGHTS > 0\n      #pragma for id in range(0, NUM_SHADOW_LIGHTS)\n        shadow *= computeShadowESM(shadowMap_{id}, pos_lightspace_{id}, vDepth_{id}, depthScale_{id}, darkness_{id}, frustumEdgeFalloff_{id});\n      #pragma endFor\n    #endif\n    vec3 color = (ambient + Lo) * shadow;\n  #else\n    vec3 color = ambient + Lo;\n  #endif\n  \n  color = color / (color + vec3(1.0));\n  \n  vec4 finalColor = vec4(color, opacity);\n  gl_FragColor = linearToGammaSpaceRGBA(finalColor);\n}",defines:[{name:"USE_NORMAL_TEXTURE"},{name:"USE_ALBEDO_TEXTURE"},{name:"USE_METALLIC_ROUGHNESS_TEXTURE"},{name:"USE_METALLIC_TEXTURE"},{name:"USE_ROUGHNESS_TEXTURE"},{name:"USE_AO_TEXTURE"},{name:"USE_EMISSIVE"},{name:"USE_EMISSIVE_TEXTURE"},{name:"USE_IBL"},{name:"USE_TEX_LOD"},{name:"USE_ALPHA_TEST"},{name:"USE_SHADOW_MAP"},{name:"USE_SKINNING"},{name:"NUM_DIR_LIGHTS",min:0,max:4},{name:"NUM_POINT_LIGHTS",min:0,max:4},{name:"NUM_SPOT_LIGHTS",min:0,max:4},{name:"NUM_SHADOW_LIGHTS",min:0,max:4}]},{name:"phong",vert:"\nattribute vec3 a_position;\nattribute vec3 a_normal;\nuniform mat4 model;\nuniform mat4 viewProj;\nuniform mat3 normalMatrix;\nvarying vec3 normal_w;\nvarying vec3 pos_w;\n#if USE_NORMAL_TEXTURE || USE_DIFFUSE_TEXTURE || USE_EMISSIVE_TEXTURE\n  attribute vec2 a_uv0;\n  uniform vec2 mainTiling;\n  uniform vec2 mainOffset;\n  varying vec2 uv0;\n#endif\n#if USE_SKINNING\n  \nattribute vec4 a_weights;\nattribute vec4 a_joints;\nuniform sampler2D u_jointsTexture;\nuniform float u_jointsTextureSize;\nmat4 getBoneMatrix(const in float i) {\n  float size = u_jointsTextureSize;\n  float j = i * 4.0;\n  float x = mod(j, size);\n  float y = floor(j / size);\n  float dx = 1.0 / size;\n  float dy = 1.0 / size;\n  y = dy * (y + 0.5);\n  vec4 v1 = texture2D(u_jointsTexture, vec2(dx * (x + 0.5), y));\n  vec4 v2 = texture2D(u_jointsTexture, vec2(dx * (x + 1.5), y));\n  vec4 v3 = texture2D(u_jointsTexture, vec2(dx * (x + 2.5), y));\n  vec4 v4 = texture2D(u_jointsTexture, vec2(dx * (x + 3.5), y));\n  return mat4(v1, v2, v3, v4);\n}\nmat4 skinMatrix() {\n  return\n    getBoneMatrix(a_joints.x) * a_weights.x +\n    getBoneMatrix(a_joints.y) * a_weights.y +\n    getBoneMatrix(a_joints.z) * a_weights.z +\n    getBoneMatrix(a_joints.w) * a_weights.w\n    ;\n}\n#endif\n#if USE_SHADOW_MAP\n  #if NUM_SHADOW_LIGHTS > 0\n    #pragma for id in range(0, NUM_SHADOW_LIGHTS)\n      uniform mat4 lightViewProjMatrix_{id};\n      uniform float minDepth_{id};\n      uniform float maxDepth_{id};\n      varying vec4 pos_lightspace_{id};\n      varying float vDepth_{id};\n    #pragma endFor\n  #endif\n#endif\nvoid main () {\n  vec4 pos = vec4(a_position, 1);\n  #if USE_SKINNING\n    mat4 skinMat = skinMatrix();\n    pos = skinMat * pos;\n  #endif\n  pos_w = (model * pos).xyz;\n  pos = viewProj * model * pos;\n  #if USE_NORMAL_TEXTURE || USE_DIFFUSE_TEXTURE || USE_EMISSIVE_TEXTURE\n    uv0 = a_uv0 * mainTiling + mainOffset;\n  #endif\n  vec4 normal = vec4(a_normal, 0);\n  #if USE_SKINNING\n    normal = skinMat * normal;\n  #endif\n  normal_w = normalMatrix * normal.xyz;\n  #if USE_SHADOW_MAP\n    #if NUM_SHADOW_LIGHTS > 0\n      #pragma for id in range(0, NUM_SHADOW_LIGHTS)\n        pos_lightspace_{id} = lightViewProjMatrix_{id} * vec4(pos_w, 1.0);\n        vDepth_{id} = (pos_lightspace_{id}.z + minDepth_{id}) / (minDepth_{id} + maxDepth_{id});\n      #pragma endFor\n    #endif\n  #endif\n  gl_Position = pos;\n}",frag:"\n#if USE_NORMAL_TEXTURE\n#extension GL_OES_standard_derivatives : enable\n#endif\n\n#define PI 3.14159265359\n#define PI2 6.28318530718\n#define EPSILON 1e-6\n#define LOG2 1.442695\n#define saturate(a) clamp( a, 0.0, 1.0 )\n\nvec3 gammaToLinearSpaceRGB(vec3 sRGB) { \n  return sRGB * (sRGB * (sRGB * 0.305306011 + 0.682171111) + 0.012522878);\n}\nvec3 linearToGammaSpaceRGB(vec3 RGB) { \n  vec3 S1 = sqrt(RGB);\n  vec3 S2 = sqrt(S1);\n  vec3 S3 = sqrt(S2);\n  return 0.585122381 * S1 + 0.783140355 * S2 - 0.368262736 * S3;\n}\nvec4 gammaToLinearSpaceRGBA(vec4 sRGBA) {\n  return vec4(gammaToLinearSpaceRGB(sRGBA.rgb), sRGBA.a);\n}\nvec4 linearToGammaSpaceRGBA(vec4 RGBA) {\n  return vec4(linearToGammaSpaceRGB(RGBA.rgb), RGBA.a);\n}\nfloat gammaToLinearSpaceExact(float val) {\n  if (val <= 0.04045) {\n    return val / 12.92;\n  } else if (val < 1.0) {\n    return pow((val + 0.055) / 1.055, 2.4);\n  } else {\n    return pow(val, 2.2);\n  }\n}\nfloat linearToGammaSpaceExact(float val) {\n  if (val <= 0.0) {\n    return 0.0;\n  } else if (val <= 0.0031308) {\n    return 12.92 * val;\n  } else if (val < 1.0) {\n    return 1.055 * pow(val, 0.4166667) - 0.055;\n  } else {\n    return pow(val, 0.45454545);\n  }\n}\n\nstruct LightInfo {\n  vec3 diffuse;\n  vec3 specular;\n};\nLightInfo computeDirectionalLighting(\n  vec3 lightDirection,\n  vec3 lightColor,\n  vec3 normal,\n  vec3 viewDirection,\n  float glossiness\n) {\n  LightInfo lightingResult;\n  float ndl = 0.0;\n  float ndh = 0.0;\n  vec3 lightDir = -normalize(lightDirection);\n  ndl = max(0.0, dot(normal, lightDir));\n  lightingResult.diffuse = lightColor * ndl;\n  vec3 dirH = normalize(viewDirection + lightDir);\n  ndh = max(0.0, dot(normal, dirH));\n  ndh = (ndl == 0.0) ? 0.0: ndh;\n  ndh = pow(ndh, max(1.0, glossiness * 128.0));\n  lightingResult.specular = lightColor * ndh;\n  return lightingResult;\n}\nLightInfo computePointLighting(\n  vec3 lightPosition,\n  vec3 lightColor,\n  float lightRange,\n  vec3 normal,\n  vec3 positionW,\n  vec3 viewDirection,\n  float glossiness\n) {\n  LightInfo lightingResult;\n  float ndl = 0.0;\n  float ndh = 0.0;\n  vec3 lightDir = vec3(0, 0, 0);\n  float attenuation = 1.0;\n  lightDir = lightPosition - positionW;\n  attenuation = max(0., 1.0 - length(lightDir) / lightRange);\n  lightDir = normalize(lightDir);\n  ndl = max(0.0, dot(normal, lightDir));\n  lightingResult.diffuse = lightColor * ndl * attenuation;\n  vec3 dirH = normalize(viewDirection + lightDir);\n  ndh = max(0.0, dot(normal, dirH));\n  ndh = (ndl == 0.0) ? 0.0: ndh;\n  ndh = pow(ndh, max(1.0, glossiness * 128.0));\n  lightingResult.specular = lightColor * ndh * attenuation;\n  return lightingResult;\n}\nLightInfo computeSpotLighting(\n  vec3 lightPosition,\n  vec3 lightDirection,\n  vec3 lightColor,\n  float lightRange,\n  vec2 lightSpot,\n  vec3 normal,\n  vec3 positionW,\n  vec3 viewDirection,\n  float glossiness\n) {\n  LightInfo lightingResult;\n  float ndl = 0.0;\n  float ndh = 0.0;\n  vec3 lightDir = vec3(0, 0, 0);\n  float attenuation = 1.0;\n  float cosConeAngle = 1.0;\n  lightDir = lightPosition - positionW;\n  attenuation = max(0., 1.0 - length(lightDir) / lightRange);\n  lightDir = normalize(lightDir);\n  cosConeAngle = max(0., dot(lightDirection, -lightDir));\n  cosConeAngle = cosConeAngle < lightSpot.x ? 0.0 : cosConeAngle;\n  cosConeAngle = pow(cosConeAngle,lightSpot.y);\n  ndl = max(0.0, dot(normal, lightDir));\n  lightingResult.diffuse = lightColor * ndl * attenuation * cosConeAngle;\n  vec3 dirH = normalize(viewDirection + lightDir);\n  ndh = max(0.0, dot(normal, dirH));\n  ndh = (ndl == 0.0) ? 0.0: ndh;\n  ndh = pow(ndh, max(1.0, glossiness * 128.0));\n  lightingResult.specular = lightColor * ndh * attenuation * cosConeAngle;\n  return lightingResult;\n}\n#if NUM_DIR_LIGHTS > 0\n  #pragma for id in range(0, NUM_DIR_LIGHTS)\n    uniform vec3 dir_light{id}_direction;\n    uniform vec3 dir_light{id}_color;\n  #pragma endFor\n#endif\n#if NUM_POINT_LIGHTS > 0\n  #pragma for id in range(0, NUM_POINT_LIGHTS)\n    uniform vec3 point_light{id}_position;\n    uniform vec3 point_light{id}_color;\n    uniform float point_light{id}_range;\n  #pragma endFor\n#endif\n#if NUM_SPOT_LIGHTS > 0\n  #pragma for id in range(0, NUM_SPOT_LIGHTS)\n    uniform vec3 spot_light{id}_position;\n    uniform vec3 spot_light{id}_direction;\n    uniform vec3 spot_light{id}_color;\n    uniform float spot_light{id}_range;\n    uniform vec2 spot_light{id}_spot;\n  #pragma endFor\n#endif\nLightInfo getPhongLighting(\n  vec3 normal,\n  vec3 positionW,\n  vec3 viewDirection,\n  float glossiness\n) {\n  LightInfo result;\n  result.diffuse = vec3(0, 0, 0);\n  result.specular = vec3(0, 0, 0);\n  LightInfo dirLighting;\n  #if NUM_DIR_LIGHTS > 0\n    #pragma for id in range(0, NUM_DIR_LIGHTS)\n      dirLighting = computeDirectionalLighting(dir_light{id}_direction,dir_light{id}_color,normal, viewDirection, glossiness);\n      result.diffuse += dirLighting.diffuse;\n      result.specular += dirLighting.specular;\n    #pragma endFor\n  #endif\n  LightInfo pointLighting;\n  #if NUM_POINT_LIGHTS > 0\n    #pragma for id in range(0, NUM_POINT_LIGHTS)\n      pointLighting = computePointLighting(point_light{id}_position, point_light{id}_color, point_light{id}_range,\n                                          normal, positionW, viewDirection, glossiness);\n      result.diffuse += pointLighting.diffuse;\n      result.specular += pointLighting.specular;\n    #pragma endFor\n  #endif\n  LightInfo spotLighting;\n  #if NUM_SPOT_LIGHTS > 0\n    #pragma for id in range(0, NUM_SPOT_LIGHTS)\n      spotLighting = computeSpotLighting(spot_light{id}_position, spot_light{id}_direction, spot_light{id}_color,\n                      spot_light{id}_range, spot_light{id}_spot,normal, positionW, viewDirection, glossiness);\n      result.diffuse += spotLighting.diffuse;\n      result.specular += spotLighting.specular;\n    #pragma endFor\n  #endif\n  return result;\n}\n\n#if USE_SHADOW_MAP\n  \nvec4 packDepthToRGBA(float depth) {\n  vec4 ret = vec4(1.0, 255.0, 65025.0, 160581375.0) * depth;\n  ret = fract(ret);\n  ret -= ret.yzww * vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0, 0.0);\n  return ret;\n}\nfloat unpackRGBAToDepth(vec4 color) {\n  return dot(color, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n}\n  \n#if NUM_SHADOW_LIGHTS > 0\n  #pragma for id in range(0, NUM_SHADOW_LIGHTS)\n    uniform sampler2D shadowMap_{id};\n    uniform float darkness_{id};\n    uniform float depthScale_{id};\n    uniform float frustumEdgeFalloff_{id};\n    uniform float bias_{id};\n    uniform vec2 texelSize_{id};\n    varying vec4 pos_lightspace_{id};\n    varying float vDepth_{id};\n  #pragma endFor\n#endif\nfloat computeShadow(sampler2D shadowMap, vec4 pos_lightspace, float bias) {\n  vec3 projCoords = pos_lightspace.xyz / pos_lightspace.w;\n  projCoords = projCoords * 0.5 + 0.5;\n  float closestDepth = unpackRGBAToDepth(texture2D(shadowMap, projCoords.xy));\n  float currentDepth = projCoords.z;\n  float shadow = (currentDepth - bias > closestDepth) ? 0.0 : 1.0;\n  return shadow;\n}\nfloat computeFallOff(float esm, vec2 coords, float frustumEdgeFalloff) {\n  float mask = smoothstep(1.0 - frustumEdgeFalloff, 1.0, clamp(dot(coords, coords), 0.0, 1.0));\n  return mix(esm, 1.0, mask);\n}\nfloat computeShadowESM(sampler2D shadowMap, vec4 pos_lightspace, float vDepth, float depthScale, float darkness, float frustumEdgeFalloff) {\n  vec2 projCoords = pos_lightspace.xy / pos_lightspace.w;\n  vec2 shadowUV = projCoords * 0.5 + vec2(0.5);\n  if (shadowUV.x < 0.0 || shadowUV.x > 1.0 || shadowUV.y < 0.0 || shadowUV.y > 1.0) {\n    return 1.0;\n  }\n  float currentDepth = clamp(vDepth, 0.0, 1.0);\n  float closestDepth = unpackRGBAToDepth(texture2D(shadowMap, shadowUV));\n  \n  float esm = clamp(exp(-depthScale * (currentDepth - closestDepth)), 1.0 - darkness, 1.0);\n  return computeFallOff(esm, projCoords, frustumEdgeFalloff);\n}\nfloat computeShadowPCF(sampler2D shadowMap, vec4 pos_lightspace, float vDepth, float darkness, vec2 texelSize, float frustumEdgeFalloff) {\n  vec2 projCoords = pos_lightspace.xy / pos_lightspace.w;\n  vec2 shadowUV = projCoords * 0.5 + vec2(0.5);\n  if (shadowUV.x < 0.0 || shadowUV.x > 1.0 || shadowUV.y < 0.0 || shadowUV.y > 1.0) {\n    return 1.0;\n  }\n  float currentDepth = clamp(vDepth, 0.0, 1.0);\n  float visibility = 1.0;\n  vec2 poissonDisk[4];\n  poissonDisk[0] = vec2(-0.94201624, -0.39906216);\n  poissonDisk[1] = vec2(0.94558609, -0.76890725);\n  poissonDisk[2] = vec2(-0.094184101, -0.92938870);\n  poissonDisk[3] = vec2(0.34495938, 0.29387760);\n  if (unpackRGBAToDepth(texture2D(shadowMap, shadowUV + poissonDisk[0] * texelSize)) < currentDepth) visibility -= 0.25;\n  if (unpackRGBAToDepth(texture2D(shadowMap, shadowUV + poissonDisk[1] * texelSize)) < currentDepth) visibility -= 0.25;\n  if (unpackRGBAToDepth(texture2D(shadowMap, shadowUV + poissonDisk[2] * texelSize)) < currentDepth) visibility -= 0.25;\n  if (unpackRGBAToDepth(texture2D(shadowMap, shadowUV + poissonDisk[3] * texelSize)) < currentDepth) visibility -= 0.25;\n  return computeFallOff(min(1.0, visibility + 1.0 - darkness), projCoords, frustumEdgeFalloff);\n}\n#endif\nuniform vec3 eye;\nuniform vec3 sceneAmbient;\nvarying vec3 normal_w;\nvarying vec3 pos_w;\n#if USE_NORMAL_TEXTURE || USE_DIFFUSE_TEXTURE || USE_EMISSIVE_TEXTURE\n  varying vec2 uv0;\n#endif\nstruct phongMaterial\n{\n  vec3 diffuse;\n  vec3 emissive;\n  vec3 specular;\n  float glossiness;\n  float opacity;\n};\nuniform vec4 diffuseColor;\n#if USE_DIFFUSE_TEXTURE\n  uniform sampler2D diffuse_texture;\n#endif\n#if USE_EMISSIVE\n  uniform vec3 emissiveColor;\n  #if USE_EMISSIVE_TEXTURE\n    uniform sampler2D emissive_texture;\n  #endif\n#endif\n#if USE_SPECULAR\n  uniform vec3 specularColor;\n  uniform float glossiness;\n  #if USE_SPECULAR_TEXTURE\n    uniform sampler2D specular_texture;\n  #endif\n#endif\n#if USE_NORMAL_TEXTURE\n  uniform sampler2D normal_texture;\n  uniform float normalScale;  \n  vec3 getNormal(vec3 pos, vec3 normal) {\n    vec3 q0 = vec3( dFdx( pos.x ), dFdx( pos.y ), dFdx( pos.z ) );\n    vec3 q1 = vec3( dFdy( pos.x ), dFdy( pos.y ), dFdy( pos.z ) );\n    vec2 st0 = dFdx( uv0.st );\n    vec2 st1 = dFdy( uv0.st );\n    vec3 S = normalize( q0 * st1.t - q1 * st0.t );\n    vec3 T = normalize( -q0 * st1.s + q1 * st0.s );\n    vec3 N = normal;\n    vec3 mapN = texture2D(normal_texture, uv0).rgb * 2.0 - 1.0;\n    mapN.xy = 1.0 * mapN.xy;\n    mat3 tsn = mat3( S, T, N );\n    return normalize( tsn * mapN );\n  }\n#endif\n#if USE_ALPHA_TEST\n  uniform float alphaTestThreshold;\n#endif\nphongMaterial getPhongMaterial() {\n  phongMaterial result;\n  #if USE_DIFFUSE_TEXTURE\n    vec4 baseColor = diffuseColor * gammaToLinearSpaceRGBA(texture2D(diffuse_texture, uv0));\n    result.diffuse = baseColor.rgb;\n    result.opacity = baseColor.a;\n  #else\n    result.diffuse = diffuseColor.rgb;\n    result.opacity = diffuseColor.a;\n  #endif\n  #if USE_EMISSIVE\n    result.emissive = gammaToLinearSpaceRGB(emissiveColor);\n    #if USE_EMISSIVE_TEXTURE\n      result.emissive *= gammaToLinearSpaceRGB(texture2D(emissive_texture, uv0).rgb);\n    #endif\n  #endif\n  #if USE_SPECULAR\n    result.specular = gammaToLinearSpaceRGB(specularColor);\n    #if USE_SPECULAR_TEXTURE\n      result.specular = gammaToLinearSpaceRGB(texture2D(specular_texture, uv0).rgb);\n    #endif\n    result.glossiness = glossiness;\n  #endif\n  return result;\n}\nvec4 composePhongShading(LightInfo lighting, phongMaterial mtl, float shadow)\n{\n  vec4 o = vec4(0.0, 0.0, 0.0, 1.0);\n  \n  o.xyz = lighting.diffuse * mtl.diffuse;\n  #if USE_EMISSIVE\n    o.xyz += mtl.emissive;\n  #endif\n  #if USE_SPECULAR\n    o.xyz += lighting.specular * mtl.specular;\n  #endif\n  o.xyz *= shadow;\n  o.w = mtl.opacity;\n  return o;\n}\nvoid main () {\n  LightInfo phongLighting;\n  vec3 viewDirection = normalize(eye - pos_w);\n  phongMaterial mtl = getPhongMaterial();\n  #if USE_ALPHA_TEST\n    if(mtl.opacity < alphaTestThreshold) discard;\n  #endif\n  vec3 normal = normalize(normal_w);\n  #if USE_NORMAL_TEXTURE\n    normal = getNormal(pos_w, normal);\n  #endif\n  phongLighting = getPhongLighting(normal, pos_w, viewDirection, mtl.glossiness);\n  phongLighting.diffuse += sceneAmbient;\n  #if USE_SHADOW_MAP\n    float shadow = 1.0;\n    #if NUM_SHADOW_LIGHTS > 0\n      #pragma for id in range(0, NUM_SHADOW_LIGHTS)\n        shadow *= computeShadowESM(shadowMap_{id}, pos_lightspace_{id}, vDepth_{id}, depthScale_{id}, darkness_{id}, frustumEdgeFalloff_{id});\n      #pragma endFor\n    #endif\n    vec4 finalColor = composePhongShading(phongLighting, mtl, shadow);\n  #else\n    vec4 finalColor = composePhongShading(phongLighting, mtl, 1.0);\n  #endif\n  gl_FragColor = linearToGammaSpaceRGBA(finalColor);\n}",defines:[{name:"USE_NORMAL_TEXTURE"},{name:"USE_DIFFUSE_TEXTURE"},{name:"USE_SPECULAR"},{name:"USE_SPECULAR_TEXTURE"},{name:"USE_EMISSIVE"},{name:"USE_EMISSIVE_TEXTURE"},{name:"USE_ALPHA_TEST"},{name:"USE_SKINNING"},{name:"USE_SHADOW_MAP"},{name:"NUM_DIR_LIGHTS",min:0,max:4},{name:"NUM_POINT_LIGHTS",min:0,max:4},{name:"NUM_SPOT_LIGHTS",min:0,max:4},{name:"NUM_SHADOW_LIGHTS",min:0,max:4}]},{name:"shadow-depth",vert:"\nattribute vec3 a_position;\nuniform mat4 model;\nuniform mat4 lightViewProjMatrix;\nuniform float minDepth;\nuniform float maxDepth;\nuniform float bias;\nvarying float vDepth;\n#if USE_SKINNING\n  \nattribute vec4 a_weights;\nattribute vec4 a_joints;\nuniform sampler2D u_jointsTexture;\nuniform float u_jointsTextureSize;\nmat4 getBoneMatrix(const in float i) {\n  float size = u_jointsTextureSize;\n  float j = i * 4.0;\n  float x = mod(j, size);\n  float y = floor(j / size);\n  float dx = 1.0 / size;\n  float dy = 1.0 / size;\n  y = dy * (y + 0.5);\n  vec4 v1 = texture2D(u_jointsTexture, vec2(dx * (x + 0.5), y));\n  vec4 v2 = texture2D(u_jointsTexture, vec2(dx * (x + 1.5), y));\n  vec4 v3 = texture2D(u_jointsTexture, vec2(dx * (x + 2.5), y));\n  vec4 v4 = texture2D(u_jointsTexture, vec2(dx * (x + 3.5), y));\n  return mat4(v1, v2, v3, v4);\n}\nmat4 skinMatrix() {\n  return\n    getBoneMatrix(a_joints.x) * a_weights.x +\n    getBoneMatrix(a_joints.y) * a_weights.y +\n    getBoneMatrix(a_joints.z) * a_weights.z +\n    getBoneMatrix(a_joints.w) * a_weights.w\n    ;\n}\n#endif\nvoid main() {\n  vec4 pos = vec4(a_position, 1);\n  #if USE_SKINNING\n    mat4 skinMat = skinMatrix();\n    pos = skinMat * pos;\n  #endif\n  gl_Position = lightViewProjMatrix * model * pos;\n  \n  vDepth = ((gl_Position.z + minDepth) / (minDepth + maxDepth)) + bias;\n}",frag:"\nuniform float depthScale;\nvarying float vDepth;\n\nvec4 packDepthToRGBA(float depth) {\n  vec4 ret = vec4(1.0, 255.0, 65025.0, 160581375.0) * depth;\n  ret = fract(ret);\n  ret -= ret.yzww * vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0, 0.0);\n  return ret;\n}\nfloat unpackRGBAToDepth(vec4 color) {\n  return dot(color, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n}\nvoid main() {\n  \n  \n  gl_FragColor = packDepthToRGBA(vDepth);\n  \n  \n}",defines:[{name:"USE_SKINNING"}]},{name:"simple",vert:"\nattribute vec3 a_position;\nuniform mat4 model;\nuniform mat4 viewProj;\n#if USE_TEXTURE\n  attribute vec2 a_uv0;\n  varying vec2 uv0;\n#endif\nvoid main () {\n  vec4 pos = viewProj * model * vec4(a_position, 1);\n  #if USE_TEXTURE\n    uv0 = a_uv0;\n  #endif\n  gl_Position = pos;\n}",frag:"\n#if USE_TEXTURE\n  uniform sampler2D texture;\n  varying vec2 uv0;\n#endif\n#if USE_COLOR\n  uniform vec4 color;\n#endif\nvoid main () {\n  vec4 o = vec4(1, 1, 1, 1);\n  #if USE_TEXTURE\n    o *= texture2D(texture, uv0);\n  #endif\n  #if USE_COLOR\n    o *= color;\n  #endif\n  if (!gl_FrontFacing) {\n    o.rgb *= 0.5;\n  }\n  gl_FragColor = o;\n}",defines:[{name:"USE_TEXTURE"},{name:"USE_COLOR"}]},{name:"skybox",vert:"\nattribute vec3 a_position;\nuniform mat4 view;\nuniform mat4 proj;\nvarying vec3 viewDir;\nvoid main() {\n  mat4 rotView = mat4(mat3(view));\n  vec4 clipPos = proj * rotView * vec4(a_position, 1.0);\n  gl_Position = clipPos.xyww;\n  viewDir = a_position;\n}\n",frag:"\nvarying vec3 viewDir;\nuniform samplerCube cubeMap;\n\nvec3 gammaToLinearSpaceRGB(vec3 sRGB) { \n  return sRGB * (sRGB * (sRGB * 0.305306011 + 0.682171111) + 0.012522878);\n}\nvec3 linearToGammaSpaceRGB(vec3 RGB) { \n  vec3 S1 = sqrt(RGB);\n  vec3 S2 = sqrt(S1);\n  vec3 S3 = sqrt(S2);\n  return 0.585122381 * S1 + 0.783140355 * S2 - 0.368262736 * S3;\n}\nvec4 gammaToLinearSpaceRGBA(vec4 sRGBA) {\n  return vec4(gammaToLinearSpaceRGB(sRGBA.rgb), sRGBA.a);\n}\nvec4 linearToGammaSpaceRGBA(vec4 RGBA) {\n  return vec4(linearToGammaSpaceRGB(RGBA.rgb), RGBA.a);\n}\nfloat gammaToLinearSpaceExact(float val) {\n  if (val <= 0.04045) {\n    return val / 12.92;\n  } else if (val < 1.0) {\n    return pow((val + 0.055) / 1.055, 2.4);\n  } else {\n    return pow(val, 2.2);\n  }\n}\nfloat linearToGammaSpaceExact(float val) {\n  if (val <= 0.0) {\n    return 0.0;\n  } else if (val <= 0.0031308) {\n    return 12.92 * val;\n  } else if (val < 1.0) {\n    return 1.055 * pow(val, 0.4166667) - 0.055;\n  } else {\n    return pow(val, 0.45454545);\n  }\n}\n\nvec3 unpackNormal(vec4 nmap) {\n  return nmap.xyz * 2.0 - 1.0;\n}\nvec3 unpackRGBE(vec4 rgbe) {\n    return rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvoid main() {\n#if USE_RGBE_HDR\n    vec3 c = unpackRGBE(textureCube(cubeMap, viewDir));\n    c = linearToGammaSpaceRGB(c / (1.0 + c));\n    gl_FragColor = vec4(c, 1.0);\n#else\n    gl_FragColor = textureCube(cubeMap, viewDir);\n#endif\n}",defines:[]},{name:"sprite",vert:"\nattribute vec3 a_position;\nuniform mat4 model;\nuniform mat4 viewProj;\nattribute vec2 a_uv0;\nattribute vec4 a_color;\nvarying vec2 uv0;\nvarying vec4 color;\nvoid main () {\n  vec4 pos = vec4(a_position, 1);\n  pos = viewProj * model * pos;\n  uv0 = a_uv0;\n  color = a_color;\n  gl_Position = pos;\n}",frag:"\nuniform sampler2D mainTexture;\nvarying vec2 uv0;\nvarying vec4 color;\nvoid main () {\n  vec4 o = vec4(1, 1, 1, 1);\n  o *= texture2D(mainTexture, uv0);\n  o *= color;\n  gl_FragColor = o;\n}",defines:[]},{name:"unlit",vert:"\nattribute vec3 a_position;\nuniform mat4 model;\nuniform mat4 viewProj;\n#if USE_TEXTURE\n  attribute vec2 a_uv0;\n  uniform vec2 mainTiling;\n  uniform vec2 mainOffset;\n  varying vec2 uv0;\n#endif\n#if USE_SKINNING\n  \nattribute vec4 a_weights;\nattribute vec4 a_joints;\nuniform sampler2D u_jointsTexture;\nuniform float u_jointsTextureSize;\nmat4 getBoneMatrix(const in float i) {\n  float size = u_jointsTextureSize;\n  float j = i * 4.0;\n  float x = mod(j, size);\n  float y = floor(j / size);\n  float dx = 1.0 / size;\n  float dy = 1.0 / size;\n  y = dy * (y + 0.5);\n  vec4 v1 = texture2D(u_jointsTexture, vec2(dx * (x + 0.5), y));\n  vec4 v2 = texture2D(u_jointsTexture, vec2(dx * (x + 1.5), y));\n  vec4 v3 = texture2D(u_jointsTexture, vec2(dx * (x + 2.5), y));\n  vec4 v4 = texture2D(u_jointsTexture, vec2(dx * (x + 3.5), y));\n  return mat4(v1, v2, v3, v4);\n}\nmat4 skinMatrix() {\n  return\n    getBoneMatrix(a_joints.x) * a_weights.x +\n    getBoneMatrix(a_joints.y) * a_weights.y +\n    getBoneMatrix(a_joints.z) * a_weights.z +\n    getBoneMatrix(a_joints.w) * a_weights.w\n    ;\n}\n#endif\nvoid main () {\n  vec4 pos = vec4(a_position, 1);\n  #if USE_SKINNING\n    pos = skinMatrix() * pos;\n  #endif\n  pos = viewProj * model * pos;\n  #if USE_TEXTURE\n    uv0 = a_uv0 * mainTiling + mainOffset;\n  #endif\n  gl_Position = pos;\n}",frag:"\n#if USE_TEXTURE\n  uniform sampler2D mainTexture;\n  varying vec2 uv0;\n#endif\n#if USE_COLOR\n  uniform vec4 color;\n#endif\nvoid main () {\n  vec4 o = vec4(1, 1, 1, 1);\n  #if USE_TEXTURE\n    o *= texture2D(mainTexture, uv0);\n  #endif\n  #if USE_COLOR\n    o *= color;\n  #endif\n  gl_FragColor = o;\n}",defines:[{name:"USE_TEXTURE"},{name:"USE_COLOR"},{name:"USE_SKINNING"}]},{name:"wireframe",vert:"\nattribute vec3 a_position;\nattribute vec3 a_normal;\nuniform mat4 model, viewProj;\nuniform mat3 normalMatrix;\nvarying vec3 position_w;\nvarying vec3 normal_w;\nvoid main () {\n  vec4 pos = vec4(a_position, 1);\n  position_w = (model * pos).xyz;\n  pos = viewProj * model * pos;\n  normal_w = normalMatrix * a_normal.xyz;\n  gl_Position = pos;\n}",frag:"\nuniform vec3 eye;\nuniform vec3 color;\nvarying vec3 position_w;\nvarying vec3 normal_w;\nvoid main () {\n  gl_FragColor = vec4(color, 1.0);\n  vec3 e2p = normalize(eye - position_w);\n  if (dot (normal_w, e2p) <= 0.0) {\n    gl_FragColor.rgb *= 0.6;\n  }\n}",defines:[]}];var Gn=0;function Wn(e,t,r){var n=[];for(var i in t){if(r[i]===undefined){if(t[i]===true){n.push("#define "+i+" 1")}else if(t[i]===false){n.push("#define "+i+" 0")}}else{if(e.ext(r[i])&&t[i]===true){n.push("#define "+i+" 1")}else{n.push("#define "+i+" 0")}}}return n.join("\n")}function Hn(e,t){var r={};var n=e;for(var i in t){if(Number.isInteger(t[i])){r[i]=t[i]}}for(var a in r){var o=new RegExp(a,"g");n=n.replace(o,r[a])}return n}function jn(e){var t=/#pragma for (\w+) in range\(\s*(\d+)\s*,\s*(\d+)\s*\)([\s\S]+?)#pragma endFor/g;function r(e,t,r,n,i){var a="";var o=parseInt(r);var s=parseInt(n);if(o.isNaN||s.isNaN){console.error("Unroll For Loops Error: begin and end of range must be an int num.")}for(var l=o;l<s;++l){a+=i.replace(new RegExp("{"+t+"}","g"),l)}return a}return e.replace(t,r)}var qn=function e(t,r,n){var i=this;if(r===void 0)r=[];if(n===void 0)n={};this._device=t;this._precision="precision highp float;\n";this._templates={};for(var a=0;a<r.length;++a){var o=r[a];i.define(o.name,o.vert,o.frag,o.defines)}this._chunks={};Object.assign(this._chunks,n);this._cache={}};qn.prototype.define=function e(t,r,n,i){if(this._templates[t]){console.warn("Failed to define shader "+t+": already exists.");return}var a=++Gn;var o=0;for(var s=0;s<i.length;++s){var l=i[s];var u=1;if(l.min!==undefined&&l.max!==undefined){u=Math.ceil((l.max-l.min)*.5);l._map=function(e){return e-this.min<<this._offset}.bind(l)}else{l._map=function(e){if(e){return 1<<this._offset}return 0}.bind(l)}o+=u;l._offset=o}r=this._precision+r;n=this._precision+n;this._templates[t]={id:a,name:t,vert:r,frag:n,defines:i}};qn.prototype.hasProgram=function e(t){return this._templates[t]!==undefined};qn.prototype.getKey=function e(t,r){var n=this._templates[t];var i=0;for(var a=0;a<n.defines.length;++a){var o=n.defines[a];var s=r[o.name];if(s===undefined){continue}i|=o._map(s)}return i<<8|n.id};qn.prototype.getProgram=function e(t,r,n){var i=this.getKey(t,r);var a=this._cache[i];if(a){return a}var o=this._templates[t];var s=Wn(this._device,r,n)+"\n";var l=Hn(o.vert,r);l=s+jn(l);var u=Hn(o.frag,r);u=s+jn(u);a=new Me.Program(this._device,{vert:l,frag:u});a.link();this._cache[i]=a;return a};var Xn=It.create();var Yn=Bt.create();var Kn=Lt.zero();var Zn=Lt.zero();var Qn=Ut.create();var Jn=new on(function(){return{stage:null,items:null}},8);var $n=new on(function(){return new Float32Array(2)},8);var ei=new on(function(){return new Float32Array(3)},8);var ti=new on(function(){return new Float32Array(4)},8);var ri=new on(function(){return new Float32Array(9)},8);var ni=new on(function(){return new Float32Array(16)},8);var ii=new on(function(){return new Float32Array(64)},8);var ai=new on(function(){return new Int32Array(2)},8);var oi=new on(function(){return new Int32Array(3)},8);var si=new on(function(){return new Int32Array(4)},8);var li=new on(function(){return new Int32Array(64)},8);var ui={};ui[Ae.PARAM_INT]=function(e){return e};ui[Ae.PARAM_INT2]=function(e){return Rt.array(ai.add(),e)};ui[Ae.PARAM_INT3]=function(e){return Lt.array(oi.add(),e)};ui[Ae.PARAM_INT4]=function(e){return Ct.array(si.add(),e)};ui[Ae.PARAM_FLOAT]=function(e){return e};ui[Ae.PARAM_FLOAT2]=function(e){return Rt.array($n.add(),e)};ui[Ae.PARAM_FLOAT3]=function(e){return Lt.array(ei.add(),e)};ui[Ae.PARAM_FLOAT4]=function(e){return Ct.array(ti.add(),e)};ui[Ae.PARAM_COLOR3]=function(e){return Pt.array(ei.add(),e)};ui[Ae.PARAM_COLOR4]=function(e){return Ft.array(ti.add(),e)};ui[Ae.PARAM_MAT2]=function(e){return Dt.array(ti.add(),e)};ui[Ae.PARAM_MAT3]=function(e){return It.array(ri.add(),e)};ui[Ae.PARAM_MAT4]=function(e){return Bt.array(ni.add(),e)};var hi={};hi[Ae.PARAM_INT]={func:function e(t){var r=li.add();for(var n=0;n<t.length;++n){r[n]=t[n]}return r},size:1};hi[Ae.PARAM_INT2]={func:function e(t){var r=li.add();for(var n=0;n<t.length;++n){r[2*n]=t[n].x;r[2*n+1]=t[n].y}return r},size:2};hi[Ae.PARAM_INT3]={func:undefined,size:3};hi[Ae.PARAM_INT4]={func:function e(t){var r=li.add();for(var n=0;n<t.length;++n){var i=t[n];r[4*n]=i.x;r[4*n+1]=i.y;r[4*n+2]=i.z;r[4*n+3]=i.w}return r},size:4};hi[Ae.PARAM_FLOAT]={func:function e(t){var r=ii.add();for(var n=0;n<t.length;++n){r[n]=t[n]}return r},size:1};hi[Ae.PARAM_FLOAT2]={func:function e(t){var r=ii.add();for(var n=0;n<t.length;++n){r[2*n]=t[n].x;r[2*n+1]=t[n].y}return r},size:2};hi[Ae.PARAM_FLOAT3]={func:undefined,size:3};hi[Ae.PARAM_FLOAT4]={func:function e(t){var r=ii.add();for(var n=0;n<t.length;++n){var i=t[n];r[4*n]=i.x;r[4*n+1]=i.y;r[4*n+2]=i.z;r[4*n+3]=i.w}return r},size:4};hi[Ae.PARAM_COLOR3]={func:undefined,size:3};hi[Ae.PARAM_COLOR4]={func:function e(t){var r=ii.add();for(var n=0;n<t.length;++n){var i=t[n];r[4*n]=i.r;r[4*n+1]=i.g;r[4*n+2]=i.b;r[4*n+3]=i.a}return r},size:4};hi[Ae.PARAM_MAT2]={func:function e(t){var r=ii.add();for(var n=0;n<t.length;++n){var i=t[n];r[4*n]=i.m00;r[4*n+1]=i.m01;r[4*n+2]=i.m02;r[4*n+3]=i.m03}return r},size:4};hi[Ae.PARAM_MAT3]={func:undefined,size:9};hi[Ae.PARAM_MAT4]={func:function e(t){var r=ii.add();for(var n=0;n<t.length;++n){var i=t[n];r[16*n]=i.m00;r[16*n+1]=i.m01;r[16*n+2]=i.m02;r[16*n+3]=i.m03;r[16*n+4]=i.m04;r[16*n+5]=i.m05;r[16*n+6]=i.m06;r[16*n+7]=i.m07;r[16*n+8]=i.m08;r[16*n+9]=i.m09;r[16*n+10]=i.m10;r[16*n+11]=i.m11;r[16*n+12]=i.m12;r[16*n+13]=i.m13;r[16*n+14]=i.m14;r[16*n+15]=i.m15}return r},size:16};var ci=function e(t,r){var n;this._device=t;this._programLib=new qn(t,Vn,kn);this._opts=r;this._type2defaultValue=(n={},n[Ae.PARAM_INT]=0,n[Ae.PARAM_INT2]=Rt.new(0,0),n[Ae.PARAM_INT3]=Lt.new(0,0,0),n[Ae.PARAM_INT4]=Ct.new(0,0,0,0),n[Ae.PARAM_FLOAT]=0,n[Ae.PARAM_FLOAT2]=Rt.new(0,0),n[Ae.PARAM_FLOAT3]=Lt.new(0,0,0),n[Ae.PARAM_FLOAT4]=Ct.new(0,0,0,0),n[Ae.PARAM_COLOR3]=Pt.new(0,0,0),n[Ae.PARAM_COLOR4]=Ft.new(0,0,0,1),n[Ae.PARAM_MAT2]=Dt.create(),n[Ae.PARAM_MAT3]=It.create(),n[Ae.PARAM_MAT4]=Bt.create(),n[Ae.PARAM_TEXTURE_2D]=r.defaultTexture,n[Ae.PARAM_TEXTURE_CUBE]=r.defaultTextureCube,n);this._stage2fn={};this._modelType2fn={};this._usedTextureUnits=0;this.frustum_test_func=or.box_frustum;this._accurateFrustumCulling=false;this._viewPools=new on(function(){return new yr},8);this._drawItemsPools=new on(function(){return{model:null,node:null,ia:null,effect:null,defines:null,dependencies:null}},100);this._stageItemsPools=new on(function(){return new on(function(){return{model:null,node:null,ia:null,effect:null,defines:null,dependencies:null,technique:null,sortKey:-1}},100)},16)};var fi={accurateFrustumCulling:{configurable:true}};ci.prototype._resetTextureUnit=function e(){this._usedTextureUnits=0};ci.prototype._allocTextureUnit=function e(){var t=this._device;var r=this._usedTextureUnits;if(r>=t._caps.maxTextureUnits){console.warn("Trying to use "+r+" texture units while this GPU supports only "+t._caps.maxTextureUnits)}this._usedTextureUnits+=1;return r};ci.prototype._registerStage=function e(t,r){this._stage2fn[t]=r};ci.prototype._registerModel=function e(t,r){this._modelType2fn[t]=r};ci.prototype._reset=function e(){this._viewPools.reset();this._stageItemsPools.reset()};ci.prototype._requestView=function e(){var t=this._viewPools.add();t.fullUpdate=this._accurateFrustumCulling;return t};fi.accurateFrustumCulling.set=function(e){this._accurateFrustumCulling=e;if(!e){this.frustum_test_func=or.box_frustum}else{this.frustum_test_func=or.box_frustum_accurate}};ci.prototype._render=function e(t,r){var n=this;var i=this._device;i.setFrameBuffer(t._framebuffer);i.setViewport(t._rect.x,t._rect.y,t._rect.w,t._rect.h);var a={};if(t._clearFlags&Ae.CLEAR_COLOR){a.color=[t._color.r,t._color.g,t._color.b,t._color.a]}if(t._clearFlags&Ae.CLEAR_DEPTH){a.depth=t._depth}if(t._clearFlags&Ae.CLEAR_STENCIL){a.stencil=t._stencil}i.clear(a);this._drawItemsPools.reset();if(t._clearFlags&Ae.CLEAR_SKYBOX&&t._clearModel!=null){var o=this._drawItemsPools.add();t._clearModel.extractDrawItem(o)}for(var s=0;s<r._models.length;++s){var l=r._models.data[s];if(t._cullingByID){if(l._viewID!==t._id){continue}}else{if(l._viewID!==-1){continue}}if(l._boundingBox!==null){l._node._getWorldPRS(Kn,Qn,Zn);fr.setTransform(l._boundingBox,Kn,Qn,Zn,l._bbModelSpace);if(!n.frustum_test_func(l._boundingBox,t._frustum)){continue}}var u=n._drawItemsPools.add();l.extractDrawItem(u)}Jn.reset();for(var h=0;h<t._stages.length;++h){var c=t._stages[h];var f=n._stageItemsPools.add();f.reset();for(var p=0;p<this._drawItemsPools.length;++p){var d=n._drawItemsPools.data[p];var v=d.effect.getTechnique(c);if(v){var m=f.add();m.model=d.model;m.node=d.node;m.ia=d.ia;m.effect=d.effect;m.defines=d.defines;m.dependencies=d.dependencies;m.technique=v;m.sortKey=-1}}var _=Jn.add();_.stage=c;_.items=f}for(var g=0;g<Jn.length;++g){var y=Jn.data[g];var x=n._stage2fn[y.stage];x(t,y.items)}};ci.prototype._drawModel=function e(t){var r=t.model;var n=this._modelType2fn[r._type];if(!n){return}n(t)};ci.prototype._draw=function e(t){var r=this;var n=this._device;var i=this._programLib;var a=t.node;var o=t.ia;var s=t.effect;var l=t.technique;var u=t.defines;var h=t.dependencies;$n.reset();ei.reset();ti.reset();ri.reset();ni.reset();ii.reset();ai.reset();oi.reset();si.reset();li.reset();a.getWorldMatrix(Yn);n.setUniform("model",Bt.array(ni.add(),Yn));It.normalFromMat4(Xn,Yn);n.setUniform("normalMatrix",It.array(ri.add(),Xn));for(var c=0;c<l._parameters.length;++c){var f=l._parameters[c];var p=s.getProperty(f.name);if(p===undefined||p===null){p=f.val}if(p===undefined||p===null){p=r._type2defaultValue[f.type]}if(p===undefined||p===null){console.warn("Failed to set technique property "+f.name+", value not found.");continue}if(f.type===Ae.PARAM_TEXTURE_2D||f.type===Ae.PARAM_TEXTURE_CUBE){if(u["USE_"+f.name.toUpperCase()]==false){continue}if(f.size!==undefined){if(f.size!==p.length){console.error("The length of texture array ("+p.length+") is not corrent(expect "+f.size+").");continue}var d=li.add();for(var v=0;v<p.length;++v){d[v]=r._allocTextureUnit()}n.setTextureArray(f.name,p,d)}else{n.setTexture(f.name,p,r._allocTextureUnit())}}else{var m=void 0;if(f.size!==undefined){var _=hi[f.type];if(_.func===undefined){console.error("Uniform array of color3/int3/float3/mat3 can not be supportted!");continue}if(f.size*_.size>64){console.error("Uniform array is too long!");continue}m=_.func(p)}else{var g=ui[f.type];m=g(p)}n.setUniform(f.name,m)}}for(var y=0;y<l._passes.length;++y){var x=l._passes[y];var b=o.count;n.setVertexBuffer(0,o._vertexBuffer);if(o._indexBuffer){n.setIndexBuffer(o._indexBuffer)}n.setPrimitiveType(o._primitiveType);var w=i.getProgram(x._programName,u,h);n.setProgram(w);n.setCullMode(x._cullMode);if(x._blend){n.enableBlend();n.setBlendFuncSep(x._blendSrc,x._blendDst,x._blendSrcAlpha,x._blendDstAlpha);n.setBlendEqSep(x._blendEq,x._blendAlphaEq);n.setBlendColor32(x._blendColor)}if(x._depthTest){n.enableDepthTest();n.setDepthFunc(x._depthFunc)}if(x._depthWrite){n.enableDepthWrite()}if(x._stencilTest){n.enableStencilTest();n.setStencilFuncFront(x._stencilFuncFront,x._stencilRefFront,x._stencilMaskFront);n.setStencilOpFront(x._stencilFailOpFront,x._stencilZFailOpFront,x._stencilZPassOpFront,x._stencilWriteMaskFront);n.setStencilFuncBack(x._stencilFuncBack,x._stencilRefBack,x._stencilMaskBack);n.setStencilOpBack(x._stencilFailOpBack,x._stencilZFailOpBack,x._stencilZPassOpBack,x._stencilWriteMaskBack)}n.draw(o._start,b);r._resetTextureUnit()}};Object.defineProperties(ci.prototype,fi);function pi(e,t,r,n){e[r]=new n(e._data);Object.defineProperty(e,t,{get:function e(){return this[r]}})}var di=function e(t,r){var n=this;this._data=new ArrayBuffer(t);for(var i=0;i<r.length;++i){var a=r[i];if(a===Ae.BUFFER_VIEW_INT8){pi(n,"int8View","_int8View",Int8Array)}else if(a===Ae.BUFFER_VIEW_UINT8){pi(n,"uint8View","_uint8View",Uint8Array)}else if(a===Ae.BUFFER_VIEW_INT16){pi(n,"int16View","_int16View",Int16Array)}else if(a===Ae.BUFFER_VIEW_UINT16){pi(n,"uint16View","_uint16View",Uint16Array)}else if(a===Ae.BUFFER_VIEW_INT32){pi(n,"int32View","_int32View",Int32Array)}else if(a===Ae.BUFFER_VIEW_UINT32){pi(n,"uint32View","_uint32View",Uint32Array)}else if(a===Ae.BUFFER_VIEW_FLOAT32){pi(n,"float32View","_float32View",Float32Array)}}};var vi=512e3;var mi=64;var _i=zt.log2(mi);var gi=function e(t,r){var n=this;if(t===void 0)t=vi;if(r===void 0)r=[Ae.BUFFER_VIEW_FLOAT32];this._buffers=[];this._maxBytes=zt.nextPow2(t);this._maxLog=zt.log2(this._maxBytes);for(var i=_i;i<=this._maxLog;++i){n._buffers.push(new di(1<<i,r))}};var yi={maxBytes:{configurable:true}};yi.maxBytes.get=function(){return this._maxBytes};gi.prototype.request=function e(t){var r=zt.nextPow2(t);var n=zt.log2(r);if(n>this._maxLog){return this._buffers[this._maxLog-_i]}else if(n<_i){return this._buffers[0]}else{return this._buffers[n-_i]}};Object.defineProperties(gi.prototype,yi);var xi={};xi[Me.ATTR_TYPE_INT8]=Ae.BUFFER_VIEW_INT8;xi[Me.ATTR_TYPE_UINT8]=Ae.BUFFER_VIEW_UINT8;xi[Me.ATTR_TYPE_INT16]=Ae.BUFFER_VIEW_INT16;xi[Me.ATTR_TYPE_UINT16]=Ae.BUFFER_VIEW_UINT16;xi[Me.ATTR_TYPE_INT32]=Ae.BUFFER_VIEW_INT32;xi[Me.ATTR_TYPE_UINT32]=Ae.BUFFER_VIEW_UINT32;xi[Me.ATTR_TYPE_FLOAT32]=Ae.BUFFER_VIEW_FLOAT32;var bi=function e(t,r,n,i,a,o,s){var l=this;if(o===void 0)o=Me.INDEX_FMT_UINT16;if(s===void 0)s=-1;var u=[];for(var h=0;h<i._elements.length;++h){var c=i._elements[h].type;var f=xi[c];if(u.indexOf(f)===-1){u.push(f)}}this._bytesPerVeretx=i._bytes;this._vdataPool=new gi(this._bytesPerVeretx*a,u);if(s!==-1){var p=-1;if(o===Me.INDEX_FMT_UINT8){p=Ae.BUFFER_VIEW_UINT8;this._bytesPerIndex=1}else if(o===Me.INDEX_FMT_UINT16){p=Ae.BUFFER_VIEW_UINT16;this._bytesPerIndex=2}else if(o===Me.INDEX_FMT_UINT32){p=Ae.BUFFER_VIEW_UINT32;this._bytesPerIndex=4}this._idataPool=new gi(this._bytesPerIndex*s,[p])}this._maxVerts=a;this._maxIndices=s;this._IAs=new Nr(function(){return new Re(new Me.VertexBuffer(t,i,Me.USAGE_DYNAMIC,null,Math.ceil(l._vdataPool.maxBytes/l._bytesPerVeretx)),s===-1?null:new Me.IndexBuffer(t,o,Me.USAGE_DYNAMIC,null,Math.ceil(l._idataPool.maxBytes/l._bytesPerIndex)),n)},r)};var wi={maxVerts:{configurable:true},maxIndices:{configurable:true}};wi.maxVerts.get=function(){return this._maxVerts};wi.maxIndices.get=function(){return this._maxIndices};bi.prototype.requestIA=function e(){return this._IAs.request()};bi.prototype.requestVData=function e(t){return this._vdataPool.request(t*this._bytesPerVeretx)};bi.prototype.requestIData=function e(t){return this._idataPool.request(t*this._bytesPerIndex)};Object.defineProperties(bi.prototype,wi);var Ti=Lt.zero();var Ei=Lt.zero();var Si=Lt.zero();var Mi=new Float32Array(16);var Ai=new Float32Array(16);var Ri=new Float32Array(16);var Li=new Float32Array(16);var Ci=new Float32Array(3);var Ii=function(e){function t(t,r){e.call(this,t,r);this._directionalLights=[];this._pointLights=[];this._spotLights=[];this._shadowLights=[];this._sceneAmbient=new Float32Array([.5,.5,.5]);this._registerStage("shadowcast",this._shadowStage.bind(this));this._registerStage("opaque",this._opaqueStage.bind(this));this._registerStage("transparent",this._transparentStage.bind(this));this._registerStage("ui",this._uiStage.bind(this));this._registerModel("default",this._draw.bind(this));this._registerModel("line-batch",this._drawLineBatch.bind(this));this._registerModel("sprite-batch",this._drawSpriteBatch.bind(this));this._registerModel("particle-batch",this._drawParticleBatch.bind(this));this._registerModel("skinning",this._drawSkinning.bind(this));this._lineIAs=new bi(t,2,Me.PT_LINES,new Me.VertexFormat([{name:Me.ATTR_POSITION,type:Me.ATTR_TYPE_FLOAT32,num:3},{name:Me.ATTR_COLOR,type:Me.ATTR_TYPE_FLOAT32,num:3}]),2e3);this._spriteIAs=new bi(t,2,Me.PT_TRIANGLES,new Me.VertexFormat([{name:Me.ATTR_POSITION,type:Me.ATTR_TYPE_FLOAT32,num:3},{name:Me.ATTR_UV0,type:Me.ATTR_TYPE_FLOAT32,num:2},{name:Me.ATTR_COLOR,type:Me.ATTR_TYPE_FLOAT32,num:4}]),2e3,Me.INDEX_FMT_UINT16,2e3)}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.updateLights=function e(t){var r=this;this._directionalLights.length=0;this._pointLights.length=0;this._spotLights.length=0;this._shadowLights.length=0;var n=t._lights;for(var i=0;i<n.length;++i){var a=n.data[i];a.update(r._device);if(a.shadowType!==Ae.SHADOW_NONE){r._shadowLights.push(a);var o=r._requestView();a.extractView(o,["shadowcast"])}if(a._type===Ae.LIGHT_DIRECTIONAL){r._directionalLights.push(a)}else if(a._type===Ae.LIGHT_POINT){r._pointLights.push(a)}else{r._spotLights.push(a)}}};t.prototype.render=function e(t){var r=this;this._reset();var n=this._device._gl.canvas;this.updateLights(t);if(t._debugCamera){var i=this._requestView();t._debugCamera.extractView(i,n.width,n.height)}else{for(var a=0;a<t._cameras.length;++a){var o=r._requestView();t._cameras.data[a].extractView(o,n.width,n.height)}}this._viewPools.sort(function(e,t){return e._priority-t._priority});t._views.sort(function(e,t){return e._priority-t._priority});for(var s=0;s<this._viewPools.length;++s){var l=r._viewPools.data[s];r._render(l,t)}for(var u=0;u<t._views.length;++u){var h=t._views[u];r._render(h,t)}};t.prototype._submitLightUniforms=function e(){var t=this;this._device.setUniform("sceneAmbient",this._sceneAmbient);if(this._directionalLights.length>0){for(var r=0;r<this._directionalLights.length;++r){var n=t._directionalLights[r];t._device.setUniform("dir_light"+r+"_direction",n._directionUniform);t._device.setUniform("dir_light"+r+"_color",n._colorUniform)}}if(this._pointLights.length>0){for(var i=0;i<this._pointLights.length;++i){var a=t._pointLights[i];t._device.setUniform("point_light"+i+"_position",a._positionUniform);t._device.setUniform("point_light"+i+"_color",a._colorUniform);t._device.setUniform("point_light"+i+"_range",a._range)}}if(this._spotLights.length>0){for(var o=0;o<this._spotLights.length;++o){var s=t._spotLights[o];t._device.setUniform("spot_light"+o+"_position",s._positionUniform);t._device.setUniform("spot_light"+o+"_direction",s._directionUniform);t._device.setUniform("spot_light"+o+"_color",s._colorUniform);t._device.setUniform("spot_light"+o+"_range",s._range);t._device.setUniform("spot_light"+o+"_spot",s._spotUniform)}}};t.prototype._submitShadowStageUniforms=function e(t){var r=t._shadowLight;this._device.setUniform("minDepth",r.shadowMinDepth);this._device.setUniform("maxDepth",r.shadowMaxDepth);this._device.setUniform("bias",r.shadowBias);this._device.setUniform("depthScale",r.shadowDepthScale)};t.prototype._submitOtherStagesUniforms=function e(){var t=this;for(var r=0;r<this._shadowLights.length;++r){var n=t._shadowLights[r];t._device.setUniform("lightViewProjMatrix_"+r,Bt.array(Li,n.viewProjMatrix));t._device.setUniform("minDepth_"+r,n.shadowMinDepth);t._device.setUniform("maxDepth_"+r,n.shadowMaxDepth);t._device.setUniform("bias_"+r,n.shadowBias);t._device.setUniform("depthScale_"+r,n.shadowDepthScale);t._device.setUniform("darkness_"+r,n.shadowDarkness);t._device.setUniform("frustumEdgeFalloff_"+r,n.frustumEdgeFalloff);t._device.setUniform("texelSize_"+r,new Float32Array([1/n.shadowResolution,1/n.shadowResolution]))}};t.prototype._updateShaderDefines=function e(t){var r=this;for(var n=0;n<t.length;++n){var i=t.data[n];var a=i.defines;a.NUM_DIR_LIGHTS=Math.min(4,r._directionalLights.length);a.NUM_POINT_LIGHTS=Math.min(4,r._pointLights.length);a.NUM_SPOT_LIGHTS=Math.min(4,r._spotLights.length);a.NUM_SHADOW_LIGHTS=Math.min(4,r._shadowLights.length)}};t.prototype._uiStage=function e(t,r){var n=this;this._device.setUniform("view",Bt.array(Mi,t._matView));this._device.setUniform("proj",Bt.array(Ai,t._matProj));this._device.setUniform("viewProj",Bt.array(Ri,t._matViewProj));r.sort(function(e,t){return e.model._userKey-t.model._userKey});for(var i=0;i<r.length;++i){var a=r.data[i];n._drawModel(a)}};t.prototype._shadowStage=function e(t,r){var n=this;var i=this._programLib;this._device.setUniform("lightViewProjMatrix",Bt.array(Ri,t._matViewProj));this._submitLightUniforms();this._submitShadowStageUniforms(t);this._updateShaderDefines(r);for(var a=0;a<r.length;++a){var o=r.data[a];o.sortKey=i.getKey(o.technique._passes[0]._programName,o.defines)}r.sort(function(e,t){var r=e.technique;var n=t.technique;if(r._layer!==n._layer){return r._layer-n._layer}if(r._passes.length!==n._passes.length){return r._passes.length-n._passes.length}return e.sortKey-t.sortKey});for(var s=0;s<r.length;++s){var l=r.data[s];if(l.model._castShadow){n._drawModel(l)}}};t.prototype._opaqueStage=function e(t,r){var n=this;var i=this._programLib;t.getPosition(Ti);this._device.setUniform("view",Bt.array(Mi,t._matView));this._device.setUniform("proj",Bt.array(Ai,t._matProj));this._device.setUniform("viewProj",Bt.array(Ri,t._matViewProj));this._device.setUniform("eye",Lt.array(Ci,Ti));this._submitLightUniforms();this._submitOtherStagesUniforms();this._updateShaderDefines(r);for(var a=0;a<r.length;++a){var o=r.data[a];o.sortKey=i.getKey(o.technique._passes[0]._programName,o.defines)}r.sort(function(e,t){var r=e.technique;var n=t.technique;if(r._layer!==n._layer){return r._layer-n._layer}if(r._passes.length!==n._passes.length){return r._passes.length-n._passes.length}return e.sortKey-t.sortKey});for(var s=0;s<r.length;++s){var l=r.data[s];for(var u=0;u<this._shadowLights.length;++u){var h=n._shadowLights[u];n._device.setTexture("shadowMap_"+u,h.shadowMap,n._allocTextureUnit())}n._drawModel(l)}};t.prototype._transparentStage=function e(t,r){var n=this;t.getPosition(Ti);t.getForward(Ei);this._device.setUniform("view",Bt.array(Mi,t._matView));this._device.setUniform("proj",Bt.array(Ai,t._matProj));this._device.setUniform("viewProj",Bt.array(Ri,t._matViewProj));this._device.setUniform("eye",Lt.array(Ci,Ti));for(var i=0;i<r.length;++i){var a=r.data[i];a.node.getWorldPos(Si);Lt.sub(Si,Si,Ti);a.sortKey=Lt.dot(Si,Ei)}this._submitLightUniforms();this._submitOtherStagesUniforms();this._updateShaderDefines(r);r.sort(function(e,t){if(e.technique._layer!==t.technique._layer){return e.technique._layer-t.technique._layer}return t.sortKey-e.sortKey});for(var o=0;o<r.length;++o){var s=r.data[o];for(var l=0;l<this._shadowLights.length;++l){var u=n._shadowLights[l];n._device.setTexture("shadowMap_"+l,u.shadowMap,n._allocTextureUnit())}n._drawModel(s)}};t.prototype._drawSkinning=function e(t){var r=t.model;var n=t.defines;n.USE_SKINNING=true;this._device.setTexture("u_jointsTexture",r._jointsTexture,this._allocTextureUnit());this._device.setUniform("u_jointsTextureSize",r._jointsTexture._width);this._draw(t)};t.prototype._drawLineBatch=function e(t){var r=this;var n=t.model;var i=0;var a=this._lineIAs.requestVData(n.vertCount);var o=a.float32View;for(var s=n.lineCount-1;s>=0;--s){var l=n.getLine(s);if(i+2>=r._lineIAs.maxVerts){var u=r._lineIAs.requestIA();u._vertexBuffer.update(0,o);u._start=0;u._count=i;t.ia=u;r._draw(t);i=0}var h=i*6;o[h]=l.start.x;o[h+1]=l.start.y;o[h+2]=l.start.z;o[h+3]=l.color.r;o[h+4]=l.color.g;o[h+5]=l.color.b;o[h+6]=l.end.x;o[h+7]=l.end.y;o[h+8]=l.end.z;o[h+9]=l.color.r;o[h+10]=l.color.g;o[h+11]=l.color.b;i+=2}if(i>0){var c=this._lineIAs.requestIA();c._vertexBuffer.update(0,o);c._start=0;c._count=i;t.ia=c;this._draw(t)}};t.prototype._drawSpriteBatch=function e(t){var r=this;var n=t.model;var i=0;var a=0;var o=0;var s=this._spriteIAs.requestVData(n.vertCount);var l=this._spriteIAs.requestIData(n.indexCount);var u=s.float32View;var h=l.uint16View;for(var c=0;c<n.spriteCount;++c){var f=n.getSprite(c);var p=f.refPositions.length;var d=f.refIndices.length;if(a+p>=r._spriteIAs.maxVerts||o+d>=r._spriteIAs.maxIndices){var v=r._spriteIAs.requestIA();v._vertexBuffer.update(0,u);v._indexBuffer.update(0,h);v._start=0;v._count=o;t.ia=v;r._draw(t);i=0;a=0;o=0}for(var m=0;m<p;++m){var _=a*9;u[_]=f.refPositions[m].x;u[_+1]=f.refPositions[m].y;u[_+2]=f.refPositions[m].z;u[_+3]=f.refUVs[m].x;u[_+4]=f.refUVs[m].y;u[_+5]=f.refColor.r;u[_+6]=f.refColor.g;u[_+7]=f.refColor.b;u[_+8]=f.refColor.a;a+=1}for(var g=0;g<d;++g){var y=o;h[y]=i+f.refIndices[g];o+=1}i+=p}if(o>0){var x=this._spriteIAs.requestIA();x._vertexBuffer.update(0,u);x._indexBuffer.update(0,h);x._start=0;x._count=o;t.ia=x;this._draw(t)}};t.prototype._drawParticleBatch=function e(t){t.ia=t.model._ia;this._draw(t)};return t}(ci);var Ui={addStage:De.addStage,createIA:ze,Pass:Ce,Technique:Be,Effect:Fe,InputAssembler:Re,View:yr,Light:Rr,Camera:Fr,Model:zr,Scene:On,LineBatchModel:Bn,SpriteBatchModel:Pn,ParticleBatchModel:zn,SkinningModel:Nn,ForwardRenderer:Ii};Object.assign(Ui,Ae);var Di={KEY_NONE:0,KEY_DOWN:1,KEY_PRESSING:2,KEY_UP:3,TOUCH_START:0,TOUCH_PRESSING:1,TOUCH_END:2,TOUCH_CANCEL:3,LOCK_NEVER:0,LOCK_WHEN_PRESSED:1,LOCK_ALWAYS:2};var Oi=null;var Bi=["start","pressing","end","cancel"];var Pi=["none","down","pressing","up"];var Fi=function e(t,r){var n=this;r=r||{};if(!Oi&&r.useMask){Oi=document.createElement("div");Oi.classList.add("drag-mask");Oi.style.position="fixed";Oi.style.zIndex="9999";Oi.style.top="0";Oi.style.right="0";Oi.style.bottom="0";Oi.style.left="0";Oi.oncontextmenu=function(){return false}}this._element=t||document.body;this._element.requestPointerLock=this._element.requestPointerLock||this._element.mozRequestPointerLock;this._element.exitPointerLock=this._element.exitPointerLock||this._element.mozExitPointerLock;this._enabled=true;if(r.enabled!==undefined){this._enabled=r.enabled}this._lock=Di.LOCK_NEVER;if(r.lock!==undefined){this._lock=r.lock}this._useMask=false;if(r.useMask!==undefined){this._useMask=r.useMask}this._maskCursor="default";if(r.maskCursor!==undefined){this._maskCursor=r.maskCursor}this._invertY=false;if(r.invertY!==undefined){this._invertY=r.invertY}var i=navigator.userAgent.toLowerCase();if(/mobile|android|iphone|ipad|phone/i.test(i)){this._hasTouch=true}this._globalEventInstalled=false;this._pointerLocked=false;this._mouseGrabbed=false;this._bcr=t.getBoundingClientRect();this._mouse={x:0,y:0,dx:0,dy:0,prevX:0,prevY:0,scrollX:0,scrollY:0,left:Di.KEY_NONE,right:Di.KEY_NONE,middle:Di.KEY_NONE};this._keys=new nn(function(){return{_next:null,_prev:null,_state:0,key:"",get state(){return Pi[this._state]}}},100);this._touches=new on(function(){return{id:-1,x:0,y:0,dx:0,dy:0,prevX:0,prevY:0,get phase(){return Bi[this._phase]},_phase:-1}},16);this._mousemoveHandle=function(e){e.preventDefault();e.stopPropagation();n._mouse.dx=e.movementX;n._mouse.dy=e.movementY;if(n._pointerLocked){n._mouse.x+=e.movementX;if(n._invertY){n._mouse.y-=e.movementY}else{n._mouse.y+=e.movementY}}else{n._mouse.x=n._calcOffsetX(e.clientX);n._mouse.y=n._calcOffsetY(e.clientY)}};this._mousewheelHandle=function(e){e.preventDefault();e.stopPropagation();n._mouse.scrollX=e.deltaX;n._mouse.scrollY=e.deltaY};this._domMouseWheelHandle=function(e){e.preventDefault();e.stopPropagation();n._mouse.scrollX=0;n._mouse.scrollY=e.detail/3};this._mousedownHandle=function(e){e.preventDefault();e.stopPropagation();if(n._lock){n._lockPointer(true)}n._installGlobalEvents();n._element.focus();switch(e.button){case 0:if(n._mouse.left!==Di.KEY_PRESSING){n._mouse.left=Di.KEY_DOWN}break;case 1:if(n._mouse.middle!==Di.KEY_PRESSING){n._mouse.middle=Di.KEY_DOWN}break;case 2:if(n._mouse.right!==Di.KEY_PRESSING){n._mouse.right=Di.KEY_DOWN}break}};this._mouseupHandle=function(e){e.preventDefault();e.stopPropagation();n._mouse.dx=e.movementX;n._mouse.dy=e.movementY;n._mouse.prevX=n._mouse.x=n._calcOffsetX(e.clientX);n._mouse.prevY=n._mouse.y=n._calcOffsetY(e.clientY);switch(e.button){case 0:n._mouse.left=Di.KEY_UP;break;case 1:n._mouse.middle=Di.KEY_UP;break;case 2:n._mouse.right=Di.KEY_UP;break}};this._mouseenterHandle=function(e){e.preventDefault();e.stopPropagation();n._mouse.dx=0;n._mouse.dy=0;n._mouse.prevX=n._mouse.x=n._calcOffsetX(e.clientX);n._mouse.prevY=n._mouse.y=n._calcOffsetY(e.clientY)};this._mouseleaveHandle=function(e){e.preventDefault();e.stopPropagation();if(n._mouseGrabbed){return}n._uninstallGlobalEvents();n._mouse.dx=e.movementX;n._mouse.dy=e.movementY;n._mouse.prevX=n._mouse.x=n._calcOffsetX(e.clientX);n._mouse.prevY=n._mouse.y=n._calcOffsetY(e.clientY)};this._keydownHandle=function(e){e.stopPropagation();var t=n._keys.head;while(t){if(t.key===e.key){break}t=t._next}if(t&&t._state===Di.KEY_PRESSING){return}if(!t){t=n._keys.add()}t.key=e.key;t._state=Di.KEY_DOWN};this._keyupHandle=function(e){e.stopPropagation();var t=n._keys.head;while(t){if(t.key===e.key){break}t=t._next}if(t){n._keys.remove(t)}t=n._keys.add();t.key=e.key;t._state=Di.KEY_UP};this._touchstartHandle=function(e){e.preventDefault();for(var t=0;t<e.changedTouches.length;t++){var r=e.changedTouches[t];var i=n._touches.add();i.id=r.identifier;i._phase=Di.TOUCH_START;i.x=n._calcOffsetX(r.clientX);i.y=n._calcOffsetY(r.clientY);i.dx=0;i.dy=0;i.prevX=0;i.prevY=0}};this._touchmoveHandle=function(e){e.preventDefault();for(var t=0;t<n._touches.length;t++){for(var r=0;r<e.changedTouches.length;r++){var i=n._touches.data[t];var a=e.changedTouches[r];if(i.id===a.identifier){i._phase=Di.TOUCH_PRESSING;i.x=n._calcOffsetX(a.clientX);i.y=n._calcOffsetY(a.clientY);i.dx=i.x-i.prevX;i.dy=i.y-i.prevY}}}};this._touchendHandle=function(e){e.preventDefault();for(var t=0;t<n._touches.length;t++){for(var r=0;r<e.changedTouches.length;r++){var i=n._touches.data[t];var a=e.changedTouches[r];if(i.id===a.identifier){i._phase=Di.TOUCH_END;i.prevX=i.x=n._calcOffsetX(a.clientX);i.prevY=i.y=n._calcOffsetY(a.clientY);i.dx=0;i.dy=0}}}};this._touchcancelHandle=function(e){e.preventDefault();for(var t=0;t<n._touches.length;t++){for(var r=0;r<e.changedTouches.length;r++){var i=n._touches.data[t];var a=e.changedTouches[r];if(i.id===a.identifier){i._phase=Di.TOUCH_CANCEL;i.prevX=i.x=n._calcOffsetX(a.clientX);i.prevY=i.y=n._calcOffsetY(a.clientY);i.dx=0;i.dy=0}}}};this._contextmenuHandle=function(e){e.preventDefault();e.stopPropagation()};this._lockChangeHandle=function(){if(document.pointerLockElement===n._element||document.mozPointerLockElement===n._element){n._pointerLocked=true}else{n._pointerLocked=false}};if(this._enabled){this._registerEvents()}};var zi={enabled:{configurable:true},hasTouch:{configurable:true},mouseX:{configurable:true},mouseY:{configurable:true},mouseDeltaX:{configurable:true},mouseDeltaY:{configurable:true},mousePrevX:{configurable:true},mousePrevY:{configurable:true},mouseScrollX:{configurable:true},mouseScrollY:{configurable:true},mouseButtons:{configurable:true},touchCount:{configurable:true},hasKeyDown:{configurable:true},hasKeyUp:{configurable:true},hasMouseDown:{configurable:true},hasMouseUp:{configurable:true}};Fi.prototype._registerMousewheelEvent=function e(){this._element.addEventListener("mousewheel",this._mousewheelHandle,{passive:false});this._element.addEventListener("DOMMouseScroll",this._domMouseWheelHandle,{passive:false})};Fi.prototype._unregisterMousewheelEvent=function e(){this._element.removeEventListener("mousewheel",this._mousewheelHandle,{passive:true});this._element.removeEventListener("DOMMouseScroll",this._domMouseWheelHandle,{passive:true})};Fi.prototype.destroy=function e(){this._element.removeEventListener("mousedown",this._mousedownHandle);this._element.removeEventListener("mouseenter",this._mouseenterHandle);this._element.removeEventListener("mouseleave",this._mouseleaveHandle);this._element.removeEventListener("mousemove",this._mousemoveHandle);this._unregisterMousewheelEvent();this._element.removeEventListener("keydown",this._keydownHandle);this._element.removeEventListener("keyup",this._keyupHandle);this._element.removeEventListener("touchstart",this._touchstartHandle);this._element.removeEventListener("touchend",this._touchendHandle);this._element.removeEventListener("touchcancel",this._touchcancelHandle);this._element.removeEventListener("touchmove",this._touchmoveHandle);this._element.removeEventListener("contextmenu",this._contextmenuHandle);document.removeEventListener("pointerlockchange",this._lockChangeHandle);this._uninstallGlobalEvents()};Fi.prototype._registerEvents=function e(){this._element.addEventListener("mousedown",this._mousedownHandle);this._element.addEventListener("mouseenter",this._mouseenterHandle);this._element.addEventListener("mouseleave",this._mouseleaveHandle);this._element.addEventListener("mousemove",this._mousemoveHandle);this._registerMousewheelEvent();this._element.addEventListener("keydown",this._keydownHandle);this._element.addEventListener("keyup",this._keyupHandle);this._element.addEventListener("touchstart",this._touchstartHandle,false);this._element.addEventListener("touchend",this._touchendHandle,false);this._element.addEventListener("touchcancel",this._touchcancelHandle,false);this._element.addEventListener("touchmove",this._touchmoveHandle,false);this._element.addEventListener("contextmenu",this._contextmenuHandle);document.addEventListener("pointerlockchange",this._lockChangeHandle,false)};Fi.prototype._installGlobalEvents=function e(){if(this._globalEventInstalled){return}document.addEventListener("mouseup",this._mouseupHandle);document.addEventListener("mousemove",this._mousemoveHandle);document.addEventListener("mousewheel",this._mousewheelHandle,{passive:true});if(this._useMask){Oi.style.cursor=this._maskCursor||"default";document.body.appendChild(Oi)}this._globalEventInstalled=true};Fi.prototype._uninstallGlobalEvents=function e(){if(!this._globalEventInstalled){return}if(this._mouse.left!==Di.KEY_NONE&&this._mouse.left!==Di.KEY_UP||this._mouse.right!==Di.KEY_NONE&&this._mouse.right!==Di.KEY_UP||this._mouse.middle!==Di.KEY_NONE&&this._mouse.middle!==Di.KEY_UP){return}if(this._lock===Di.LOCK_WHEN_PRESSED){this._lockPointer(false)}if(this._mouseGrabbed){return}document.removeEventListener("mouseup",this._mouseupHandle);document.removeEventListener("mousemove",this._mousemoveHandle);document.removeEventListener("mousewheel",this._mousewheelHandle,{passive:true});if(this._useMask){Oi.remove()}this._globalEventInstalled=false};Fi.prototype._lockPointer=function e(t){if(t){if(this._pointerLocked){return}if(this._element.requestPointerLock){this._element.requestPointerLock();this._pointerLocked=true}return}else{if(!this._pointerLocked){return}if(document.exitPointerLock){document.exitPointerLock();this._pointerLocked=false}}};Fi.prototype._calcOffsetX=function e(t){return t-this._bcr.left};Fi.prototype._calcOffsetY=function e(t){if(this._invertY){return this._bcr.height-(t-this._bcr.top)}return t-this._bcr.top};zi.enabled.get=function(){return this._enabled};zi.enabled.set=function(e){if(this._enabled!==e){this._enabled=e;if(this._enabled){this._registerEvents();if(this._mouseGrabbed){this._installGlobalEvents()}}else{this.destroy()}}};zi.hasTouch.get=function(){return this._hasTouch};zi.mouseX.get=function(){return this._mouse.x};zi.mouseY.get=function(){return this._mouse.y};zi.mouseDeltaX.get=function(){return this._mouse.dx};zi.mouseDeltaY.get=function(){return this._mouse.dy};zi.mousePrevX.get=function(){return this._mouse.prevX};zi.mousePrevY.get=function(){return this._mouse.prevY};zi.mouseScrollX.get=function(){return this._mouse.scrollX};zi.mouseScrollY.get=function(){return this._mouse.scrollY};zi.mouseButtons.get=function(){var e=0;var t=this._mouse.left;if(t===Di.KEY_DOWN||t===Di.KEY_PRESSING){e|=1}t=this._mouse.right;if(t===Di.KEY_DOWN||t===Di.KEY_PRESSING){e|=2}t=this._mouse.middle;if(t===Di.KEY_DOWN||t===Di.KEY_PRESSING){e|=4}return e};zi.touchCount.get=function(){return this._touches.length};zi.hasKeyDown.get=function(){var e=this._keys.head;while(e){if(e._state===Di.KEY_DOWN){return true}}return false};zi.hasKeyUp.get=function(){var e=this._keys.head;while(e){if(e._state===Di.KEY_UP){return true}}return false};zi.hasMouseDown.get=function(){if(this._mouse.left===Di.KEY_DOWN||this._mouse.middle===Di.KEY_DOWN||this._mouse.right===Di.KEY_DOWN){return true}return false};zi.hasMouseUp.get=function(){if(this._mouse.left===Di.KEY_UP||this._mouse.middle===Di.KEY_UP||this._mouse.right===Di.KEY_UP){return true}return false};Fi.prototype.getTouchInfo=function e(t){return this._touches.data[t]};Fi.prototype.reset=function e(){var t=this;if(this._enabled===false){return}this._mouse.prevX=this._mouse.x;this._mouse.prevY=this._mouse.y;this._mouse.dx=0;this._mouse.dy=0;this._mouse.scrollX=0;this._mouse.scrollY=0;if(this._mouse.left===Di.KEY_DOWN){this._mouse.left=Di.KEY_PRESSING}else if(this._mouse.left===Di.KEY_UP){this._mouse.left=Di.KEY_NONE}if(this._mouse.middle===Di.KEY_DOWN){this._mouse.middle=Di.KEY_PRESSING}else if(this._mouse.middle===Di.KEY_UP){this._mouse.middle=Di.KEY_NONE}if(this._mouse.right===Di.KEY_DOWN){this._mouse.right=Di.KEY_PRESSING}else if(this._mouse.right===Di.KEY_UP){this._mouse.right=Di.KEY_NONE}var r=this._keys.head;var n=r;while(n){r=n;n=r._next;if(r._state===Di.KEY_DOWN){r._state=Di.KEY_PRESSING}else if(r._state===Di.KEY_UP){t._keys.remove(r)}}for(var i=0;i<this._touches.length;i++){t._touches.data[i].prevX=t._touches.data[i].x;t._touches.data[i].prevY=t._touches.data[i].y;t._touches.data[i].dx=0;t._touches.data[i].dy=0;if(t._touches.data[i]._phase===Di.TOUCH_START){t._touches.data[i]._phase=Di.TOUCH_PRESSING}if(t._touches.data[i]._phase===Di.TOUCH_END||t._touches.data[i]._phase===Di.TOUCH_CANCEL){t._touches.remove(i)}}this._uninstallGlobalEvents()};Fi.prototype.resize=function e(){this._bcr=this._element.getBoundingClientRect()};Fi.prototype.grabMouse=function e(t){this._mouseGrabbed=t;if(this._enabled===false){return}if(t){this._installGlobalEvents()}else{this._uninstallGlobalEvents()}};Fi.prototype.mousedown=function e(t){var r=this._mouse[t];if(r!==undefined){return r===Di.KEY_DOWN}return false};Fi.prototype.mousepress=function e(t){var r=this._mouse[t];if(r!==undefined){return r===Di.KEY_DOWN||r===Di.KEY_PRESSING}return false};Fi.prototype.mouseup=function e(t){var r=this._mouse[t];if(r!==undefined){return r===Di.KEY_UP}return false};Fi.prototype.keydown=function e(t){var r=this._keys.head;while(r){if(r.key===t&&r._state===Di.KEY_DOWN){return true}r=r._next}return false};Fi.prototype.keyup=function e(t){var r=this._keys.head;while(r){if(r.key===t&&r._state===Di.KEY_UP){return true}r=r._next}return false};Fi.prototype.keypress=function e(t){var r=this._keys.head;while(r){if(r.key===t&&(r._state===Di.KEY_DOWN||r._state===Di.KEY_PRESSING)){return true}r=r._next}return false};Object.defineProperties(Fi.prototype,zi);Object.assign(Fi,Di);var Ni=function e(t,r){if(r===void 0)r={};this.name=t;this.detail=r.detail;this.bubbles=!!r.bubbles;this.target=null;this._stopped=false};Ni.prototype.stop=function e(){this._stopped=true};var ki=Object.prototype.hasOwnProperty;function Vi(){var e=Object.create(null);e.__tmp__=undefined;delete e.__tmp__;return e}function Gi(e,t,r){this.fn=e;this.context=t;this.once=r||false}function Wi(e,t,r,n,i){var a=new Gi(r,n||e,i);if(!e._events[t]){e._events[t]=a;e._eventsCount++}else if(!e._events[t].fn){e._events[t].push(a)}else{e._events[t]=[e._events[t],a]}return e}function Hi(e,t){if(--e._eventsCount===0){e._events=Vi()}else{delete e._events[t]}}function ji(e){var t=e.target;while(t){t.emit(e.name,e);if(!e.bubbles||e._stopped){break}t=t.parent}}var qi=function e(){this._events=Vi();this._eventsCount=0};qi.mixin=function e(t){Object.getOwnPropertyNames(qi.prototype).forEach(function(e){if(t.prototype.hasOwnProperty(e)===false){Object.defineProperty(t.prototype,e,Object.getOwnPropertyDescriptor(qi.prototype,e))}});t.prototype.__initEventEmitter=function(){this._events=Vi();this._eventsCount=0}};qi.prototype.eventNames=function e(){var t=this;var r=[],n,i;if(this._eventsCount===0){return r}for(i in n=t._events){if(ki.call(n,i)){r.push(i)}}if(Object.getOwnPropertySymbols){return r.concat(Object.getOwnPropertySymbols(n))}return r};qi.prototype.listeners=function e(t,r){var n=this._events[t];if(r){return!!n}if(!n){return[]}if(n.fn){return[n.fn]}var i=n.length;var a=new Array(i);for(var o=0;o<i;++o){a[o]=n[o].fn}return a};qi.prototype.emit=function e(t,r,n,i,a,o){var s=arguments;var l=this;if(!this._events[t]){return false}var u=this._events[t],h=arguments.length,c,f;if(u.fn){if(u.once){this.off(t,u.fn,undefined,true)}switch(h){case 1:return u.fn.call(u.context),true;case 2:return u.fn.call(u.context,r),true;case 3:return u.fn.call(u.context,r,n),true;case 4:return u.fn.call(u.context,r,n,i),true;case 5:return u.fn.call(u.context,r,n,i,a),true;case 6:return u.fn.call(u.context,r,n,i,a,o),true}for(f=1,c=new Array(h-1);f<h;f++){c[f-1]=s[f]}u.fn.apply(u.context,c)}else{var p=u.length,d;for(f=0;f<p;f++){if(u[f].once){l.off(t,u[f].fn,undefined,true)}switch(h){case 1:u[f].fn.call(u[f].context);break;case 2:u[f].fn.call(u[f].context,r);break;case 3:u[f].fn.call(u[f].context,r,n);break;case 4:u[f].fn.call(u[f].context,r,n,i);break;default:if(!c){for(d=1,c=new Array(h-1);d<h;d++){c[d-1]=s[d]}}u[f].fn.apply(u[f].context,c)}}}return true};qi.prototype.on=function e(t,r,n){return Wi(this,t,r,n,false)};qi.prototype.once=function e(t,r,n){return Wi(this,t,r,n,true)};qi.prototype.off=function e(t,r,n,i){if(!this._events[t]){return this}if(!r){Hi(this,t);return this}var a=this._events[t];if(a.fn){if(a.fn===r&&(!i||a.once)&&(!n||a.context===n)){Hi(this,t)}}else{var o=[];for(var s=0,l=a.length;s<l;s++){if(a[s].fn!==r||i&&!a[s].once||n&&a[s].context!==n){o.push(a[s])}}if(o.length){this._events[t]=o.length===1?o[0]:o}else{Hi(this,t)}}return this};qi.prototype.removeAllListeners=function e(t){if(t){if(this._events[t]){Hi(this,t)}}else{this._events=Vi();this._eventsCount=0}return this};qi.prototype.dispatch=function e(t,r){var n=t;if(typeof t==="string"){n=new Ni(t,r)}n.target=this;ji(n)};var Xi=function(e){function t(t,r){e.call(this,t,r);this.component=null}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;return t}(Ni);var Yi=function e(){this._enabled=true;this._destroyed=false;this._inited=false;this._app=null;this._system=null;this._entity=null};var Ki={enabled:{configurable:true},destroyed:{configurable:true},system:{configurable:true},entity:{configurable:true}};Ki.enabled.get=function(){return this._entity.activeInHierarchy&&this._enabled};Ki.enabled.set=function(e){if(this._enabled!==e){this._enabled=e;if(this._entity.activeInHierarchy){if(this._enabled){this.onEnable&&this.onEnable()}else{this.onDisable&&this.onDisable()}}}};Yi.prototype._onEntityActiveChanged=function e(t){if(!this._inited){this._inited=true;if(this.onInit){this.onInit()}}if(this._enabled){if(t){this.onEnable&&this.onEnable()}else{this.onDisable&&this.onDisable()}}};Yi.prototype._onComponentNeedDestroy=function e(){if(this._inited){this.onDestroy&&this.onDestroy();this._inited=false}};Ki.destroyed.get=function(){return this._entity.destroyed||this._destroyed};Ki.system.get=function(){return this._system};Ki.entity.get=function(){return this._entity};Yi.prototype.dispatch=function e(t,r){var n=t;if(typeof t==="string"){n=new Xi(t,r)}n.target=this._entity;n.component=this;this._entity.dispatch(n)};Yi.prototype.destroy=function e(){if(this._destroyed){return}this._destroyed=true;var t=this._entity;if(this.enabled){this.onDisable&&this.onDisable()}this._app._destroyComp(this)};Object.defineProperties(Yi.prototype,Ki);var Zi=function e(t){this.__initNode();this.__initEventEmitter();this.name=t||"";this._active=false;this._ancestorActive=false;this._destroyed=false;this._comps=[];this._app=null;this._poolID=-1};var Qi={active:{configurable:true},activeInHierarchy:{configurable:true},destroyed:{configurable:true}};Qi.active.get=function(){return this._active};Qi.active.set=function(e){e=!!e;if(this._active!==e){if(e){this.activate()}else{this.deactivate()}}};Qi.activeInHierarchy.get=function(){return this._active&&this._ancestorActive};Qi.destroyed.get=function(){return this._destroyed};Zi.prototype.activate=function e(){if(this._active===true){return}this._active=true;if(this._ancestorActive){this._notifyComponents(true);this._notifyChildren(true)}};Zi.prototype.deactivate=function e(){if(this._active===false){return}this._active=false;if(this._ancestorActive){this._notifyComponents(false);this._notifyChildren(false)}};Zi.prototype._notifyComponents=function e(t){var r=this;this.emit(t?"active":"inactive");for(var n=0;n<this._comps.length;++n){var i=r._comps[n];i._onEntityActiveChanged(t)}};Zi.prototype._notifyChildren=function e(t){var r=this;for(var n=0;n<this._children.length;++n){var i=r._children[n];i._ancestorActive=t;if(i.active){i._notifyComponents(t);i._notifyChildren(t)}}};Zi.prototype.destroy=function e(){var t=this;if(this._destroyed){return}this._destroyed=true;for(var r=0;r<this._children.length;++r){var n=t._children[r];n.destroy()}for(var i=0;i<this._comps.length;++i){var a=t._comps[i];a.destroy()}if(this.activeInHierarchy){this.emit("inactive")}this._app._destroyEntity(this)};Zi.prototype._onParentChanged=function e(t,r){var n=!!(t&&t.activeInHierarchy);this._ancestorActive=!!(r&&r.activeInHierarchy);if(this._active&&this._ancestorActive!==n){this._notifyComponents(this._ancestorActive);this._notifyChildren(this._ancestorActive)}this.emit("parent-changed",t,r)};Zi.prototype.clone=function e(){return this._app.cloneEntity(this)};Zi.prototype.deepClone=function e(){return this._app.deepCloneEntity(this)};Zi.prototype.getComp=function e(t){var r=this;var n=this._app.getClass(t);for(var i=0;i<this._comps.length;++i){var a=r._comps[i];if(a instanceof n){return a}}return null};Zi.prototype.getComps=function e(t){var r=this;var n=this._app.getClass(t);var i=[];for(var a=0;a<this._comps.length;++a){var o=r._comps[a];if(o instanceof n){i.push(o)}}return i};Zi.prototype.getCompsInChildren=function e(t){var r=this._app.getClass(t);var n=[];Dn.walk(this,function(e){for(var t=0;t<e._comps.length;++t){var i=e._comps[t];if(i instanceof r){n.push(i)}}});return n};Zi.prototype.addComp=function e(t,r){var n=this._app.getClass(t);if(!n.multiple){if(this.getComp(t)){return null}}var i=this._app._createComp(n,this,r);this._comps.push(i);if(this.activeInHierarchy){i._onEntityActiveChanged(true)}return i};Zi.prototype._removeComp=function e(t){var r=this;for(var n=0;n<this._comps.length;++n){var i=r._comps[n];if(i===t){r._comps.splice(n,1);return true}}return false};Object.defineProperties(Zi.prototype,Qi);Tn.mixin(Zi);qi.mixin(Zi);var Ji=function(e){function t(t){e.call(this,t)}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.addComp=function e(){console.warn("Can not add component in level")};t.prototype.setParent=function e(){console.error("Can not set parent to level")};t.prototype.activate=function t(){if(this._active===true&&this._ancestorActive===true){return}this._ancestorActive=true;e.prototype.activate.call(this)};t.prototype.deactivate=function t(){if(this._active===false&&this._ancestorActive===false){return}this._ancestorActive=false;e.prototype.deactivate.call(this)};return t}(Zi);var $i=function e(){this._enabled=true;this._id="";this._app=null;this._priority=0;this._componentCls=null};$i.prototype.init=function e(){};$i.prototype.add=function e(){};$i.prototype.remove=function e(){};$i.prototype.tick=function e(){};$i.prototype.postTick=function e(){};function ea(e){return function(t,r,n,i){var a=t.getClass(e);if(a===undefined){console.warn("Can not find class "+e+".");return null}r=r||{};if(r instanceof a){return r}if(r.constructor&&r.constructor.__classname__){console.warn("Invalid class instance, it is not instanceof "+e+".");return null}var o=new a;oa(t,o,r,i);return o}}function ta(e){if(e){return function(t,r,n,i){if(r===null){return[]}var a=new Array(r.length);for(var o=0;o<r.length;++o){a[o]=e(t,r[o],n,i)}return a}}return function(e,t){return t}}function ra(e,t){if(t.parse){return t.parse}var r=null;var n=e.getType(t.type);if(n){r=n.parse||null}else{r=ea(t.type)}if(t.array){return ta(r)}return r}function na(e,t,r,n){if(n){if(r.set){return function(t){r.set.call(this,n(e,t,r))}}return function(i){this[t]=n(e,i,r)}}if(r.set){return r.set}return function(e){this[t]=e}}function ia(e,t,r){if(r.get){return r.get}return function(){return this[t]}}function aa(e,t){var r={};for(var n in t){var i=t[n];if(i.type===undefined&&i.default===undefined){console.warn("Invalid property "+n+": you must provide 'default' or 'type'.");continue}if(i.array===undefined){i.array=false}if(i.array&&i.type===undefined){console.warn("Invalid property "+n+": array value must have a 'type'.");continue}var a=i.type;if(a===undefined){i.type=typeof i.default}if(i.default===undefined){var o=e.getType(i.type);if(o){i.default=o.default}else{i.default=null}}var s=ra(e,i);var l="_"+n;var u=ia(e,l,i);var h=na(e,l,i,s);r[n]={configurable:true,enumerable:true,get:u,set:h}}return r}function oa(e,t,r,n){var i=t.constructor;while(i.__classname__!==undefined){if(i.hasOwnProperty("schema")===false){i=Object.getPrototypeOf(i);continue}for(var a in i.schema){var o="_"+a;if(t[o]!==undefined){continue}var s=i.schema[a];var l=ra(e,s);var u=r&&r[a];if(u===undefined){u=s.default}if(l){var h=l(e,u,s,n);t[o]=h}else{t[o]=u}}i=Object.getPrototypeOf(i)}}var sa={createPrototypeAccessors:aa,parse:oa};var la=function e(t){var r=this;if(t===void 0)t={};var n=t.poolSize||100;this._types={};this._classes={};this._systems=[];this._activeLevel=new Ji;this._activeLevel._app=this;this._activeLevel.activate();this._entities=new en(n);this._deadComponents=new en(n);this._deadEntities=new en(n);if(t.systems){for(var i=0;i<t.systems.length;++i){var a=t.systems[i];r.registerSystem(a.id,a.system,a.component,a.priority)}}this._sortSystems()};var ua={activeLevel:{configurable:true}};ua.activeLevel.get=function(){return this._activeLevel};la.prototype.registerType=function e(t,r){this._types[t]=r};la.prototype.registerClass=function e(t,r){r.__classname__=t;var n=null;if(r.hasOwnProperty("schema")){n=r.schema}if(n){var i=sa.createPrototypeAccessors(this,n);Object.defineProperties(r.prototype,i)}this._classes[t]=r};la.prototype.registerSystem=function e(t,r,n,i){if(i===void 0)i=0;var a=new r;a._id=t;a._app=this;a._priority=i;a._componentCls=this.getClass(n);if(!a._componentCls){console.warn("Failed to get class "+n+", please register it first.")}a.init();this._systems.push(a);return a};la.prototype.getType=function e(t){return this._types[t]};la.prototype.getClass=function e(t){return this._classes[t]};la.prototype.getClassName=function e(t){if(typeof t==="function"){return t.__classname__}return t.constructor.__classname__};la.prototype.createObject=function e(t,r){var n=this.getClass(t);var i=new n;sa.parse(this,i,r||{});return i};la.prototype.createEntity=function e(t,r){if(r===void 0)r=null;var n=new Zi(t);n._app=this;n._active=true;this._entities.push(n);var i=r||this._activeLevel;if(i){n.setParent(i)}return n};la.prototype.cloneEntity=function e(t){var r=this;return Dn.clone(t,Zi,function(e,t){e._app=r;e._active=t._active;for(var n=0;n<t._comps.length;++n){var i=t._comps[n];if(i._destroyed){continue}var a=r._createComp(i.constructor,e,i);a._enabled=i._enabled;if(a.onClone){a.onClone(i)}e._comps.push(a)}r._entities.push(e)})};la.prototype.deepCloneEntity=function e(t){var r=this;return Dn.deepClone(t,Zi,function(e,t){e._app=r;e._active=t._active;for(var n=0;n<t._comps.length;++n){var i=t._comps[n];if(i._destroyed){continue}var a=r._createComp(i.constructor,e,i);a._enabled=i._enabled;if(a.onClone){a.onClone(i)}e._comps.push(a)}r._entities.push(e)})};la.prototype.loadLevel=function e(t){if(this._activeLevel){Dn.walk(this._activeLevel,function(e){e.destroy()})}this._activeLevel=t;this._activeLevel._app=this;this._activeLevel.activate()};la.prototype.tick=function e(){var t=this;for(var r=0;r<this._systems.length;++r){var n=t._systems[r];n.tick()}for(var i=0;i<this._systems.length;++i){var a=t._systems[i];a.postTick()}for(var o=0;o<this._deadComponents.length;++o){var s=t._deadComponents.data[o];s._onComponentNeedDestroy();s._entity._removeComp(s);for(var l=0;l<s.__events__.length;++l){var u=s.__events__[l];s._entity.off(u.name,u.fn)}s._app=null;s._system=null;s._entity=null}for(var h=0;h<this._deadEntities.length;++h){var c=t._deadEntities.data[h];c.emit("destroy");if(c._parent&&c._parent._destroyed===false){c.setParent(null)}var f=t._entities.data[t._entities.length-1];t._entities.fastRemove(c._poolID);f._poolID=c._poolID;c._poolID=-1;c._app=null;c._parent=null;c._children.length=0;c._comps.length=0}this._deadComponents.reset();this._deadEntities.reset()};la.prototype.system=function e(t){var r=this;for(var n=0;n<this._systems.length;++n){var i=r._systems[n];if(i._id===t){return i}}return null};la.prototype._getSystem=function e(t){var r=this;for(var n=0;n<this._systems.length;++n){var i=r._systems[n];if(t instanceof i._componentCls){return i}}return null};la.prototype._destroyEntity=function e(t){this._deadEntities.push(t)};la.prototype._finalizeComp=function e(t,r,n){var i=t._entity;var a=t.constructor;while(a.__classname__!==undefined){if(a.hasOwnProperty("events")){for(var o in a.events){var s=a.events[o];var l=t[s];if(l){l=l.bind(t);i.on(o,l);t.__events__.push({name:o,fn:l})}}}a=Object.getPrototypeOf(a)}sa.parse(this,t,r,n)};la.prototype._createComp=function e(t,r,n){if(n===void 0)n={};var i=new t;i._app=this;i._system=this._getSystem(i);i._entity=r;i.__events__=[];this._finalizeComp(i,n,null);return i};la.prototype._destroyComp=function e(t){this._deadComponents.push(t)};la.prototype._sortSystems=function e(){this._systems.sort(function(e,t){return e._priority-t._priority})};Object.defineProperties(la.prototype,ua);var ha=[];var ca=[];var fa=[];var pa=[];var da={registerLoader:function e(t,r){ha.push({id:t,def:r})},registerType:function e(t,r){fa.push({id:t,def:r})},registerClass:function e(t,r){ca.push({id:t,def:r})},registerSystem:function e(t,r,n,i){pa.push({id:t,system:r,component:n,priority:i})},_init:function e(t){for(var r=0;r<ha.length;++r){var n=ha[r];t._assetMng.registerLoader(n.id,n.def)}for(var i=0;i<fa.length;++i){var a=fa[i];t.registerType(a.id,a.def)}for(var o=0;o<ca.length;++o){var s=ca[o];t.registerClass(s.id,s.def)}for(var l=0;l<pa.length;++l){var u=pa[l];t.registerSystem(u.id,u.system,u.component,u.priority)}}};var va=["manifest","onDone","onProgress","onError"];var ma=["type","src","stream","credentials","parser"];var _a=["onData","onDone"];var ga=-1;var ya=0;var xa=1;function ba(e){throw new Error("resl: "+e)}function wa(e,t,r){Object.keys(e).forEach(function(e){if(t.indexOf(e)<0){ba('invalid parameter "'+e+'" in '+r)}})}function Ta(e,t){this.state=ya;this.ready=false;this.progress=0;this.name=e;this.cancel=t}function Ea(e){if(typeof e!=="object"||!e){ba("invalid or missing configuration")}wa(e,va,"config");var t=e.manifest;if(typeof t!=="object"||!t){ba("missing manifest")}function r(t){if(t in e){var r=e[t];if(typeof r!=="function"){ba('invalid callback "'+t+'"')}return r}return null}var n=r("onDone");if(!n){ba("missing onDone() callback")}var i=r("onProgress");var a=r("onError");var o={};var s=ya;function l(e){var t=e.name;var r=e.stream;var n=e.type==="binary";var i=e.parser;var a=new XMLHttpRequest;var s=null;var l=new Ta(t,h);if(r){a.onreadystatechange=u}else{a.onreadystatechange=function(){if(a.readyState===4){u()}}}if(n){a.responseType="arraybuffer"}function u(){if(a.readyState<2||l.state===xa||l.state===ga){return}if(a.status!==200){return f('error loading resource "'+e.name+'"')}if(a.readyState>2&&l.state===ya){var r;if(e.type==="binary"){r=a.response}else{r=a.responseText}if(i.data){try{s=i.data(r)}catch(e){return f(e)}}else{s=r}}if(a.readyState>3&&l.state===ya){if(i.done){try{s=i.done()}catch(e){return f(e)}}l.state=xa}o[t]=s;l.progress=.75*l.progress+.25;l.ready=e.stream&&!!s||l.state===xa;p()}function h(){if(l.state===xa||l.state===ga){return}a.onreadystatechange=null;a.abort();l.state=ga}if(e.credentials){a.withCredentials=true}a.open("GET",e.src,true);a.send();return l}function u(e,t){var r=e.name;var n=e.parser;var i=new Ta(r,m);var a=t;function s(){if(i.state===ya){if(n.data){try{a=n.data(t)}catch(e){return f(e)}}else{a=t}}}function l(e){s();o[r]=a;if(e.lengthComputable){i.progress=Math.max(i.progress,e.loaded/e.total)}else{i.progress=.75*i.progress+.25}p(r)}function u(){s();if(i.state===ya){if(n.done){try{a=n.done()}catch(e){return f(e)}}i.state=xa}i.progress=1;i.ready=true;o[r]=a;v();p("finish "+r)}function h(){f('error loading asset "'+r+'"')}if(e.stream){t.addEventListener("progress",l)}if(e.type==="image"){t.addEventListener("load",u)}else{var c=false;var d=false;t.addEventListener("loadedmetadata",function(){d=true;if(c){u()}});t.addEventListener("canplay",function(){c=true;if(d){u()}})}t.addEventListener("error",h);function v(){if(e.stream){t.removeEventListener("progress",l)}if(e.type==="image"){t.addEventListener("load",u)}else{t.addEventListener("canplay",u)}t.removeEventListener("error",h)}function m(){if(i.state===xa||i.state===ga){return}i.state=ga;v();t.src=""}if(e.credentials){t.crossOrigin="use-credentials"}else{t.crossOrigin="anonymous"}t.src=e.src;return i}var h={text:l,binary:function(e){return l(e)},image:function(e){return u(e,document.createElement("img"))},video:function(e){return u(e,document.createElement("video"))},audio:function(e){return u(e,document.createElement("audio"))}};var c=Object.keys(t).map(function(e){var r=t[e];if(typeof r==="string"){r={src:r}}else if(typeof r!=="object"||!r){ba('invalid asset definition "'+e+'"')}wa(r,ma,'asset "'+e+'"');function n(t,n,i){var a=i;if(t in r){a=r[t]}if(n.indexOf(a)<0){ba("invalid "+t+' "'+a+'" for asset "'+e+'", possible values: '+n)}return a}function i(t,n,i){var a=i;if(t in r){a=r[t]}else if(n){ba("missing "+t+' for asset "'+e+'"')}if(typeof a!=="string"){ba("invalid "+t+' for asset "'+e+'", must be a string')}return a}function a(e,t){if(e in r.parser){var n=r.parser[e];if(typeof n!=="function"){ba("invalid parser callback "+e+' for asset "'+e+'"')}return n}else{return t}}var o={};if("parser"in r){if(typeof r.parser==="function"){o={data:r.parser}}else if(typeof r.parser==="object"&&r.parser){wa(r.parser,_a,'parser for asset "'+e+'"');if(!("onData"in r.parser)){ba('missing onData callback for parser in asset "'+e+'"')}o={data:a("onData"),done:a("onDone")}}else{ba('invalid parser for asset "'+e+'"')}}return{name:e,type:n("type",Object.keys(h),"text"),stream:!!r.stream,credentials:!!r.credentials,src:i("src",true,""),parser:o}}).map(function(e){return h[e.type](e)});function f(e){if(s===ga||s===xa){return}s=ga;c.forEach(function(e){e.cancel()});if(a){if(typeof e==="string"){a(new Error("resl: "+e))}else{a(e)}}else{console.error("resl error:",e)}}function p(e){if(s===ga||s===xa){return}var t=0;var r=0;c.forEach(function(e){if(e.ready){r+=1}t+=e.progress});if(r===c.length){s=xa;n(o)}else{if(i){i(t/c.length,e)}}}if(c.length===0){setTimeout(function(){p("done")},1)}}var Sa=-1;var Ma=function e(){++Sa;this._uuid="internal-"+Sa;this._name="";this._loaded=false};var Aa={uuid:{configurable:true},name:{configurable:true}};Aa.uuid.get=function(){return this._uuid};Aa.name.get=function(){return this._name};Ma.prototype.subAsset=function e(){return null};Ma.prototype.unload=function e(){this._loaded=false};Ma.prototype.reload=function e(){};Ma.prototype.clone=function e(){};Object.defineProperties(Ma.prototype,Aa);var Ra=function(e){function t(){e.call(this);this._subMeshes=null;this._skinning=null;this._minPos=null;this._maxPos=null}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;var r={skinning:{configurable:true},subMeshCount:{configurable:true}};t.prototype.unload=function t(){var r=this;if(!this._loaded){return}this._subMeshes[0]._vertexBuffer.destroy();for(var n=0;n<this._subMeshes.length;++n){var i=r._subMeshes[n];i._indexBuffer.destroy()}this._subMeshes=null;e.prototype.unload.call(this)};r.skinning.get=function(){return this._skinning};r.subMeshCount.get=function(){return this._subMeshes.length};t.prototype.getSubMesh=function e(t){return this._subMeshes[t]};Object.defineProperties(t.prototype,r);return t}(Ma);var La=function(e){function t(t){e.call(this);this._device=t;this._texture=null}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;return t}(Ma);var Ca={linear:Me.FILTER_LINEAR,nearest:Me.FILTER_NEAREST};var Ia={repeat:Me.WRAP_REPEAT,clamp:Me.WRAP_CLAMP,mirror:Me.WRAP_MIRROR};var Ua={"rgb-dxt1":Me.TEXTURE_FMT_RGB_DXT1,"rgba-dxt1":Me.TEXTURE_FMT_RGBA_DXT1,"rgba-dxt3":Me.TEXTURE_FMT_RGBA_DXT3,"rgba-dxt5":Me.TEXTURE_FMT_RGBA_DXT5,"rgb-etc1":Me.TEXTURE_FMT_RGB_ETC1,"rgb-pvrtc-2bppv1":Me.TEXTURE_FMT_RGB_PVRTC_2BPPV1,"rgba-pvrtc-2bppv1":Me.TEXTURE_FMT_RGBA_PVRTC_2BPPV1,"rgb-pvrtc-4bppv1":Me.TEXTURE_FMT_RGB_PVRTC_4BPPV1,"rgba-pvrtc-4bppv1":Me.TEXTURE_FMT_RGBA_PVRTC_4BPPV1,a8:Me.TEXTURE_FMT_A8,l8:Me.TEXTURE_FMT_L8,"l8-a8":Me.TEXTURE_FMT_L8_A8,"r5-g6-b5":Me.TEXTURE_FMT_R5_G6_B5,"r5-g5-b5-a1":Me.TEXTURE_FMT_R5_G5_B5_A1,"r4-g4-b4-a4":Me.TEXTURE_FMT_R4_G4_B4_A4,rgb8:Me.TEXTURE_FMT_RGB8,rgba8:Me.TEXTURE_FMT_RGBA8,rgb16f:Me.TEXTURE_FMT_RGB16F,rgba16f:Me.TEXTURE_FMT_RGBA16F,rgb32f:Me.TEXTURE_FMT_RGB32F,rgba32f:Me.TEXTURE_FMT_RGBA32F,r32f:Me.TEXTURE_FMT_R32F,"111110f":Me.TEXTURE_FMT_111110F,srgb:Me.TEXTURE_FMT_SRGB,srgba:Me.TEXTURE_FMT_SRGBA,d16:Me.TEXTURE_FMT_D16,d32:Me.TEXTURE_FMT_D32,d24s8:Me.TEXTURE_FMT_D24S8};var Da={images:[],mipmap:true,width:2,height:2,format:Me.TEXTURE_FMT_RGBA8,anisotropy:1,wrapS:Me.WRAP_REPEAT,wrapT:Me.WRAP_REPEAT,minFilter:Me.FILTER_LINEAR,magFilter:Me.FILTER_LINEAR,mipFilter:Me.FILTER_LINEAR,premultiplyAlpha:false};function Oa(e,t){if(t._writable){e.images=[t._data]}else{e.images=t._images}e.mipmap=t._mipmap;e.width=t._width;e.height=t._height;e.format=Ua[t._format];e.anisotropy=t._anisotropy;e.wrapS=Ia[t._wrapS];e.wrapT=Ia[t._wrapT];e.minFilter=Ca[t._minFilter];e.magFilter=Ca[t._magFilter];e.mipFilter=Ca[t._mipFilter];e.premultiplyAlpha=t._premultiplyAlpha}function Ba(e){if(e._format==="a8"){return new Uint8Array(e._width*e._height)}else if(e._format==="rgb8"){return new Uint8Array(e._width*e._height*3)}else if(e._format==="rgba8"){return new Uint8Array(e._width*e._height*4)}else if(e._format==="rgba32f"){return new Float32Array(e._width*e._height*4)}return null}var Pa=function(e){function t(t,r,n,i){if(r===void 0)r=2;if(n===void 0)n=2;if(i===void 0)i="rgba8";e.call(this,t);this._writable=false;this._data=null;this._images=[];this._mipmap=true;this._width=r;this._height=n;this._format=i;this._anisotropy=1;this._wrapS="repeat";this._wrapT="repeat";this._minFilter="linear";this._magFilter="linear";this._mipFilter="linear";this._premultiplyAlpha=false}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;var r={width:{configurable:true},height:{configurable:true},format:{configurable:true},data:{configurable:true},writable:{configurable:true},mipmap:{configurable:true},anisotropy:{configurable:true},wrapS:{configurable:true},wrapT:{configurable:true},minFilter:{configurable:true},magFilter:{configurable:true},mipFilter:{configurable:true},premultiplyAlpha:{configurable:true}};t.prototype.unload=function t(){if(!this._loaded){return}this._texture.destroy();e.prototype.unload.call(this)};t.prototype.setImage=function e(t,r){if(r instanceof HTMLCanvasElement||r instanceof HTMLImageElement||r instanceof HTMLVideoElement){this._images[t]=r;if(t===0){this.resize(r.width,r.height)}}};t.prototype.setImages=function e(t){this._images=t;this.resize(t[0].width,t[0].height)};t.prototype.resize=function e(t,r){this._width=t;this._height=r;if(this._writable){this._data=Ba(this)}};r.width.get=function(){return this._width};r.height.get=function(){return this._height};r.format.get=function(){return this._format};r.data.get=function(){return this._data};r.writable.set=function(e){this._writable=e;if(this._writable){this._data=Ba(this)}else{this._data=null}};r.writable.get=function(){return this._writable};r.mipmap.set=function(e){this._mipmap=e};r.mipmap.get=function(){return this._mipmap};r.anisotropy.set=function(e){this._anisotropy=e};r.anisotropy.get=function(){return this._anisotropy};r.wrapS.set=function(e){this._wrapS=e};r.wrapS.get=function(){return this._wrapS};r.wrapT.set=function(e){this._wrapT=e};r.wrapT.get=function(){return this._wrapT};r.minFilter.set=function(e){this._minFilter=e};r.minFilter.get=function(){return this._minFilter};r.magFilter.set=function(e){this._magFilter=e};r.magFilter.get=function(){return this._magFilter};r.mipFilter.set=function(e){this._mipFilter=e};r.mipFilter.get=function(){return this._mipFilter};r.premultiplyAlpha.set=function(e){this._premultiplyAlpha=e};r.premultiplyAlpha.get=function(){return this._premultiplyAlpha};t.prototype.commit=function e(){Oa(Da,this);if(!this._texture){this._texture=new Me.Texture2D(this._device,Da)}else{this._texture.update(Da)}this._images=[]};Object.defineProperties(t.prototype,r);return t}(La);function Fa(e,t){var r=e.length;if(r===0){t(null)}var n=0;for(var i=0;i<e.length;++i){var a=e[i];a(function(e){if(e){t(e)}else if(++n===r){t(null)}})}}var za={parallel:Fa};function Na(e,t){for(var r=0;r<t.length;r++){var n=t[r];var i=e.entities[n.entity];var a=n.property.split(".");if(a.length===1){i[n.property]=n.value;continue}var o=null;for(var s=0;s<i.components.length;s++){var l=a[0];var u=i.components[s];if(u.type===l){o=u;break}}if(o===null){console.warn("Failed to apply modification for entity "+i.name+": component "+a[0]+" not found.");continue}var h=a[1];var c=h.match(/(.*)\[(\d+)\]/);if(c){var f=c[1];var p=parseInt(c[2]);o.properties[f][p]=n.value}else{if(a[1]==="enabled"){o[a[1]]=n.value}else{o.properties[a[1]]=n.value}}}return e}function ka(e,t,r){var n=e.getClass(r.type);if(!n){var i=new Yi;i._app=e;i._system=null;i._entity=t;i.__events__=[];if(r.enabled!==undefined){i._enabled=r.enabled}console.error("component type "+r.type+" not found.");return i}var a=new n;a._app=e;a._system=e._getSystem(a);a._entity=t;a.__events__=[];if(r.enabled!==undefined){a._enabled=r.enabled}return a}function Va(e,t,r){var n=e.createEntity(t.name,r);if(t.enabled!==undefined){n._active=t.enabled}if(!t.components){return n}n._comps=new Array(t.components.length);for(var i=0;i<t.components.length;++i){var a=t.components[i];n._comps[i]=ka(e,n,a)}return n}function Ga(e,t,r,n){if(r){t=JSON.parse(JSON.stringify(t));t=Na(t,r)}var i=t.entities;var a=new Array(t.entities.length);for(var o=0;o<i.length;++o){var s=i[o];if(s.prefab){console.warn("nested prefab have not implemented.")}else{a[o]=Va(e,s,n)}}Ha(e,a,i);return a[0]}function Wa(e,t,r){var n={};var i=t.preloads;var a=[];var o=function(t){var r=i[t];a.push(function(t){e.assets.load(r,function(e,i){if(e){console.error(e);t();return}n[r]=i;t()})})};for(var s=0;s<i.length;++s)o(s);za.parallel(a,function(e){r(e,n)})}function Ha(e,t,r){for(var n=0;n<r.length;++n){var i=t[n];var a=r[n];if(!i){continue}if(a.translation){Lt.set(i.lpos,a.translation[0],a.translation[1],a.translation[2])}else{Lt.set(i.lpos,0,0,0)}if(a.rotation){Ut.set(i.lrot,a.rotation[0],a.rotation[1],a.rotation[2],a.rotation[3])}else{Ut.set(i.lrot,0,0,0,1)}if(a.scale){Lt.set(i.lscale,a.scale[0],a.scale[1],a.scale[2])}else{Lt.set(i.lscale,1,1,1)}if(a.children){for(var o=0;o<a.children.length;++o){var s=a.children[o];i.append(t[s])}}if(a.components){for(var l=0;l<a.components.length;++l){var u=i._comps[l];var h=a.components[l];e._finalizeComp(u,h.properties,t)}}}}var ja={createComponent:ka,createEntity:Va,createPrefab:Ga,preloadAssets:Wa,finalize:Ha};function qa(e,t,r){ja.preloadAssets(e,t,function(){var n=t.entities;var i=new Array(t.entities.length);var a=new Ji;for(var o=0;o<n.length;++o){var s=n[o];if(s.prefab){var l=e.assets.get(s.prefab);if(!l){console.error("Failed to load prefab "+s.prefab);continue}i[o]=l.instantiate(s.modifications,a)}else{i[o]=ja.createEntity(e,s,a)}console.log(s.name+" loaded")}ja.finalize(e,i,t.entities);for(var u=0;u<t.children.length;++u){var h=t.children[u];a.append(i[h])}if(r){r(null,a)}})}function Xa(e,t){var r=t.jointIndices.length;var n;if(r>256){n=64}else if(r>64){n=32}else if(r>16){n=16}else{n=8}var i=new Pa(e.device,n,n,"rgba32f");i.minFilter="nearest";i.magFilter="nearest";i.wrapS="clamp";i.wrapT="clamp";i.mipmap=false;i.writable=true;i.commit();return i}function Ya(e,t){var r=Ui.createIA(e.device,t);var n=new Ra;n._subMeshes=[r];n._minPos=t.minPos;n._maxPos=t.maxPos;return n}var Ka={createJointsTexture:Xa,createMesh:Ya,parseLevel:qa,walk:Dn.walk,flat:Dn.flat,find:Dn.find,Layers:_n};function Za(){var e=Object.create(null);e.__tmp__=undefined;delete e.__tmp__;return e}function Qa(e,t){return function(r,n){if(r){if(t){t(r)}return}if(t){if(e){n=n.subAsset(e);if(!n){t(new Error("subasset "+e+" not found."));return}}t(null,n)}}}var Ja=function(e){function t(){e.call(this)}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.run=function e(t,r,n){var i=this;t.loadUrls(n.type,n.urls,function(e,n){delete t._loadings[r];if(e){i.emit("loaded",e);return}n._uuid=r;n._loaded=true;t.add(r,n);i.emit("loaded",null,n)})};return t}(qi);var $a=function e(t){this._app=t;this._loaders=Za();this._assetInfos=Za();this._assets=Za();this._loadings=Za();this._levelInfos=Za()};$a.prototype.registerLoader=function e(t,r){this._loaders[t]=r};$a.prototype.registerAsset=function e(t,r){if(this._assetInfos[t]){console.warn("asset "+t+" already registerred.");return}this._assetInfos[t]=r};$a.prototype.registerLevel=function e(t,r){if(this._levelInfos[t]){console.warn("level "+t+" is already registerred.");return}this._levelInfos[t]=r};$a.prototype.loadLevel=function e(t,r){if(!this._levelInfos[t]){console.error("Cannot load scene "+t);r&&r(new Error("loadFail"),null)}else{var n=this._app;Ea({manifest:{sceneJson:{type:"text",parser:JSON.parse,src:this._levelInfos[t]}},onDone:function e(t){Ka.parseLevel(n,t.sceneJson,function(e,t){r&&r(e,t)})},onError:function e(t){r&&r(t,null)}})}};$a.prototype.add=function e(t,r){if(this._assets[t]){console.warn("Failed to add asset "+t+", already exists.");return}this._assets[t]=r};$a.prototype.get=function e(t){var r=t.indexOf("@");if(r===-1){return this._assets[t]}var n=t.substring(0,r);t=t.substring(r+1);var i=this._assets[t];if(i&&n){return i.subAsset(n)}return null};$a.prototype.load=function e(t,r){var n=t.indexOf("@");var i;if(n!==-1){i=t.substring(0,n);t=t.substring(n+1)}var a=this._assets[t];if(a){if(r){if(i){a=a.subAsset(i);if(!a){r(new Error("subasset "+i+" not found."));return}}r(null,a)}return}var o=this._loadings[t];var s=Qa(i,r);if(o){o.once("loaded",s);return}var l=this._assetInfos[t];if(!l){if(r){r(new Error("asset info "+t+" not found, please add it first."))}return}o=new Ja(this);this._loadings[t]=o;o.once("loaded",Qa(i,r));o.run(this,t,l)};$a.prototype.loadUrls=function e(t,r,n){var i=this._loaders[t];if(!i){if(n){n(new Error("can not find loader for asset type "+t+", please register it first."))}return}i(this._app,r,n)};var eo=10;var to=10;var ro=Lt.new(0,0,-1);var no=Lt.new(1,0,0);var io=Lt.new(0,1,0);var ao=It.create();var oo=Lt.zero();var so=Lt.zero();var lo=Lt.new(0,1,0);var uo=Lt.zero();var ho=Lt.zero();var co=function e(t){this._input=t;this._node=new Tn("debug-camera");Lt.set(this._node.lpos,10,10,10);this._node.lookAt(Lt.new(0,0,0));this._df=0;this._dr=0;this._panX=0;this._panY=0;this._panZ=0;this._rotX=0;this._rotY=0;this._curRot=Ut.create();this._destRot=Ut.create();this._curEye=Lt.zero();this._destEye=Lt.zero();this._node.getWorldRot(this._curRot);this._destRot=Ut.clone(this._curRot);this._node.getWorldPos(this._curEye);this._destEye=Lt.clone(this._curEye)};co.prototype.reset=function e(){this._df=0;this._dr=0;this._du=0;this._panX=0;this._panY=0;this._panZ=0;this._rotX=0;this._rotY=0;this._node.getWorldRot(this._curRot);this._destRot=Ut.clone(this._curRot);this._node.getWorldPos(this._curEye);this._destEye=Lt.clone(this._curEye)};co.prototype.tick=function e(t){var r=this._input;this._handleMouseAndKeyboard();if(r.hasTouch){this._handleTouches()}this._lerp(t)};co.prototype._handleMouseAndKeyboard=function e(){var t=this._input;this._df=0;this._dr=0;this._du=0;this._panX=0;this._panY=0;this._panZ=0;this._rotX=0;this._rotY=0;if(t.mousepress("left")&&t.mousepress("right")){var r=t.mouseDeltaX;var n=t.mouseDeltaY;this._panX=r;this._panY=-n}else if(t.mousepress("left")){var i=t.mouseDeltaX;var a=t.mouseDeltaY;this._rotY=-i*.002;this._panZ=-a}else if(t.mousepress("right")){var o=t.mouseDeltaX;var s=t.mouseDeltaY;this._rotY=-o*.002;this._rotX=-s*.002}if(t.keypress("w")){this._df+=1}if(t.keypress("s")){this._df-=1}if(t.keypress("a")){this._dr-=1}if(t.keypress("d")){this._dr+=1}if(t.keypress("q")){this._du-=1}if(t.keypress("e")){this._du+=1}if(t.mouseScrollY){this._df-=t.mouseScrollY*.05}};co.prototype._handleTouches=function e(){var t=this._input;this._df=0;this._dr=0;this._panX=0;this._panY=0;this._panZ=0;this._rotX=0;this._rotY=0;if(t.touchCount===1){var r=t.getTouchInfo(0);var n=r.dx;var i=r.dy;if(r.prevX===0&&r.prevY===0){n=0;i=0}this._rotY=-n*.002;this._rotX=i*.002}else if(t.touchCount===2){var a=t.getTouchInfo(0);var o=t.getTouchInfo(1);var s=Math.sqrt((a.x-o.x)*(a.x-o.x)+(a.y-o.y)*(a.y-o.y));var l=Math.sqrt((a.prevX-o.prevX)*(a.prevX-o.prevX)+(a.prevY-o.prevY)*(a.prevY-o.prevY));var u=Math.abs(s-l);if((a.dx!=0||a.dy!=0)&&(o.dx!=0||o.dy!=0)&&u<100){if(s>l){this._df+=u}else{this._df-=u}}if(o.phase===2||a.phase===2){t.touchCount=2}}else if(t.touchCount===3){var h=t.getTouchInfo(0);var c=h.dx;var f=h.dy;if(c<100&&f<100){this._rotY=-c*.002;this._panZ=-f}}};co.prototype._lerp=function e(t){var r=this._panX;var n=this._panY;var i=this._panZ;var a=this._destEye;var o=this._destRot;Ut.rotateX(o,o,this._rotX);Ut.rotateAround(o,o,io,this._rotY);Ut.slerp(this._curRot,this._curRot,o,t*eo);It.fromQuat(ao,this._curRot);Lt.transformMat3(oo,ro,ao);Lt.transformMat3(so,no,ao);if(this._df!==0){Lt.scaleAndAdd(a,a,oo,this._df*t*to)}if(this._dr!==0){Lt.scaleAndAdd(a,a,so,this._dr*t*to)}if(this._du!==0){Lt.scaleAndAdd(a,a,lo,this._du*t*to)}if(i!==0){Lt.copy(uo,oo);uo.y=0;Lt.normalize(uo,uo);Lt.scaleAndAdd(a,a,uo,i*t*to)}if(r!==0){Lt.copy(ho,so);ho.y=0;Lt.normalize(ho,ho);Lt.scaleAndAdd(a,a,ho,r*t*to)}if(n!==0){Lt.scaleAndAdd(a,a,io,n*t*to)}Lt.lerp(this._curEye,this._curEye,a,t*eo);this._node.setWorldPos(this._curEye);this._node.setWorldRot(this._curRot)};function fo(e){var t=[[0,1],[1,2],[2,0]];var r=[];var n={};for(var i=0;i<e.length;i+=3){for(var a=0;a<3;++a){var o=e[i+t[a][0]];var s=e[i+t[a][1]];var l=o>s?s<<16|o:o<<16|s;if(n[l]===undefined){n[l]=0;r.push(o,s)}}}return r}function po(e,t,r){if(r===void 0)r=1;var n=new Array(2*e.length);for(var i=0;i<e.length/3;++i){var a=3*i;var o=6*i;n[o+0]=e[a+0];n[o+1]=e[a+1];n[o+2]=e[a+2];n[o+3]=e[a+0]+t[a+0]*r;n[o+4]=e[a+1]+t[a+1]*r;n[o+5]=e[a+2]+t[a+2]*r}return n}var vo=Lt.zero();var mo=Lt.zero();var _o=Lt.zero();var go=Lt.zero();var yo=Lt.zero();var xo=Lt.zero();var bo=Lt.zero();var wo=Lt.zero();var To=Lt.zero();var Eo=Lt.zero();var So=Lt.zero();var Mo=Lt.zero();function Ao(e,t,r,n){if(e===void 0)e=2;if(t===void 0)t=2;if(r===void 0)r=2;if(n===void 0)n={};var i=n.widthSegments!==undefined?n.widthSegments:1;var a=n.heightSegments!==undefined?n.heightSegments:1;var o=n.lengthSegments!==undefined?n.lengthSegments:1;var s=n.invWinding!==undefined?n.invWinding:false;var l=e*.5;var u=t*.5;var h=r*.5;var c=[Lt.set(yo,-l,-u,h),Lt.set(xo,l,-u,h),Lt.set(bo,l,u,h),Lt.set(wo,-l,u,h),Lt.set(To,l,-u,-h),Lt.set(Eo,-l,-u,-h),Lt.set(So,-l,u,-h),Lt.set(Mo,l,u,-h)];var f=[[0,1,3],[4,5,7],[3,2,6],[1,0,4],[1,4,2],[5,0,6]];var p=[[0,0,1],[0,0,-1],[0,1,0],[0,-1,0],[1,0,0],[-1,0,0]];var d=[];var v=[];var m=[];var _=[];var g=Lt.new(-l,-u,-h);var y=Lt.new(l,u,h);function x(e,t,r){var n,i;var a,o;var l=d.length/3;var u=f[e];var h=p[e];for(o=0;o<=r;o++){for(a=0;a<=t;a++){n=a/t;i=o/r;Lt.lerp(vo,c[u[0]],c[u[1]],n);Lt.lerp(mo,c[u[0]],c[u[2]],i);Lt.sub(_o,mo,c[u[0]]);Lt.add(go,vo,_o);d.push(go.x,go.y,go.z);v.push(h[0],h[1],h[2]);m.push(n,i);if(a<t&&o<r){var g=t+1;var y=a+o*g;var x=a+(o+1)*g;var b=a+1+(o+1)*g;var w=a+1+o*g;if(s){_.push(l+y,l+x,l+w);_.push(l+w,l+x,l+b)}else{_.push(l+y,l+w,l+x);_.push(l+x,l+w,l+b)}}}}}x(0,i,a);x(4,o,a);x(1,i,a);x(5,o,a);x(3,i,o);x(2,i,o);return{positions:d,normals:v,uvs:m,indices:_,minPos:g,maxPos:y}}var Ro=Lt.zero();var Lo=Lt.zero();function Co(e,t,r,n){if(e===void 0)e=.5;if(t===void 0)t=.5;if(r===void 0)r=2;if(n===void 0)n={};var i=r*.5;var a=n.radialSegments||8;var o=n.heightSegments||1;var s=n.capped!==undefined?n.capped:true;var l=n.arc||2*Math.PI;var u=0;if(!s){if(e>0){u++}if(t>0){u++}}var h=(a+1)*(o+1);if(s){h+=(a+1)*u+a*u}var c=a*o*2*3;if(s){c+=a*u*3}var f=new Array(c);var p=new Array(h*3);var d=new Array(h*3);var v=new Array(h*2);var m=Math.max(e,t);var _=Lt.new(-m,-i,-m);var g=Lt.new(m,i,m);var y=0;var x=0;b();if(s){if(t>0){w(false)}if(e>0){w(true)}}return{positions:p,normals:d,uvs:v,indices:f,minPos:_,maxPos:g};function b(){var n=[];var s=(e-t)/r;for(var u=0;u<=o;u++){var h=[];var c=u/o;var m=c*(e-t)+t;for(var _=0;_<=a;++_){var g=_/a;var b=g*l;var w=Math.sin(b);var T=Math.cos(b);p[3*y]=m*w;p[3*y+1]=c*r-i;p[3*y+2]=m*T;Lt.normalize(Ro,Lt.set(Lo,w,-s,T));d[3*y]=Ro.x;d[3*y+1]=Ro.y;d[3*y+2]=Ro.z;v[2*y]=g;v[2*y+1]=c;h.push(y);++y}n.push(h)}for(var E=0;E<o;++E){for(var S=0;S<a;++S){var M=n[E][S];var A=n[E+1][S];var R=n[E+1][S+1];var L=n[E][S+1];f[x]=M;++x;f[x]=L;++x;f[x]=A;++x;f[x]=L;++x;f[x]=R;++x;f[x]=A;++x}}}function w(r){var n,o;var s=r?e:t;var u=r?1:-1;n=y;for(var h=1;h<=a;++h){p[3*y]=0;p[3*y+1]=i*u;p[3*y+2]=0;d[3*y]=0;d[3*y+1]=u;d[3*y+2]=0;v[2*y]=.5;v[2*y+1]=.5;++y}o=y;for(var c=0;c<=a;++c){var m=c/a;var _=m*l;var g=Math.cos(_);var b=Math.sin(_);p[3*y]=s*b;p[3*y+1]=i*u;p[3*y+2]=s*g;d[3*y]=0;d[3*y+1]=u;d[3*y+2]=0;v[2*y]=.5-g*.5;v[2*y+1]=b*.5*u+.5;++y}for(var w=0;w<a;++w){var T=n+w;var E=o+w;if(r){f[x]=E+1;++x;f[x]=T;++x;f[x]=E;++x}else{f[x]=T;++x;f[x]=E+1;++x;f[x]=E;++x}}}}function Io(e,t,r){if(e===void 0)e=.5;if(t===void 0)t=1;if(r===void 0)r={};return Co(0,e,t,r)}var Uo=Lt.zero();var Do=Lt.zero();var Oo=Lt.zero();var Bo=Lt.zero();var Po=Lt.zero();var Fo=Lt.zero();var zo=Lt.zero();function No(e,t,r){if(r===void 0)r={};var n=r.widthSegments!==undefined?r.widthSegments:5;var i=r.lengthSegments!==undefined?r.lengthSegments:5;var a=e*.5;var o=t*.5;var s=[];var l=[];var u=[];var h=[];var c=Lt.new(-a,0,-o);var f=Lt.new(a,0,o);Lt.set(Po,-a,0,o);Lt.set(Fo,a,0,o);Lt.set(zo,-a,0,-o);for(var p=0;p<=i;p++){for(var d=0;d<=n;d++){var v=d/n;var m=p/i;Lt.lerp(Uo,Po,Fo,v);Lt.lerp(Do,Po,zo,m);Lt.sub(Oo,Do,Po);Lt.add(Bo,Uo,Oo);s.push(Bo.x,Bo.y,Bo.z);l.push(0,1,0);u.push(v,m);if(d<n&&p<i){var _=n+1;var g=d+p*_;var y=d+(p+1)*_;var x=d+1+(p+1)*_;var b=d+1+p*_;h.push(g,b,y);h.push(b,x,y)}}}return{positions:s,normals:l,uvs:u,indices:h,minPos:c,maxPos:f}}var ko=[-.5,-.5,0,-.5,.5,0,.5,.5,0,.5,-.5,0];var Vo=[0,0,1,0,0,1,0,0,1,0,0,1];var Go=[0,0,0,1,1,1,1,0];var Wo=[0,3,1,3,2,1];var Ho=Lt.new(-.5,-.5,0);var jo=Lt.new(.5,.5,0);function qo(){return{positions:ko,indices:Wo,normals:Vo,uvs:Go,minPos:Ho,maxPos:jo}}function Xo(e,t){if(e===void 0)e=1;if(t===void 0)t={};var r=t.segments!==undefined?t.segments:16;var n=[];var i=[];var a=[];var o=[];var s=Lt.new(-e,-e,-e);var l=Lt.new(e,e,e);for(var u=0;u<=r;++u){var h=u*Math.PI/r;var c=Math.sin(h);var f=-Math.cos(h);for(var p=0;p<=r;++p){var d=p*2*Math.PI/r-Math.PI/2;var v=Math.sin(d);var m=Math.cos(d);var _=v*c;var g=f;var y=m*c;var x=p/r;var b=u/r;n.push(_*e,g*e,y*e);i.push(_,g,y);a.push(x,b);if(u<r&&p<r){var w=r+1;var T=w*u+p;var E=w*(u+1)+p;var S=w*(u+1)+p+1;var M=w*u+p+1;o.push(T,M,E);o.push(M,S,E)}}}return{positions:n,indices:o,normals:i,uvs:a,minPos:s,maxPos:l}}function Yo(e,t,r){if(e===void 0)e=.5;if(t===void 0)t=.2;if(r===void 0)r={};var n=r.radialSegments||30;var i=r.tubularSegments||20;var a=r.arc||2*Math.PI;var o=[];var s=[];var l=[];var u=[];var h=Lt.new(-e-t,-t,-e-t);var c=Lt.new(e+t,t,e+t);for(var f=0;f<=n;f++){for(var p=0;p<=i;p++){var d=p/i;var v=f/n;var m=d*a;var _=v*Math.PI*2;var g=(e+t*Math.cos(_))*Math.sin(m);var y=t*Math.sin(_);var x=(e+t*Math.cos(_))*Math.cos(m);var b=Math.sin(m)*Math.cos(_);var w=Math.sin(_);var T=Math.cos(m)*Math.cos(_);o.push(g,y,x);s.push(b,w,T);l.push(d,v);if(p<i&&f<n){var E=i+1;var S=E*f+p;var M=E*(f+1)+p;var A=E*(f+1)+p+1;var R=E*f+p+1;u.push(S,R,M);u.push(R,A,M)}}}return{positions:o,normals:s,uvs:l,indices:u,minPos:h,maxPos:c}}var Ko=Lt.zero();var Zo=Lt.zero();function Qo(e,t,r,n){if(e===void 0)e=.5;if(t===void 0)t=.5;if(r===void 0)r=2;if(n===void 0)n={};var i=r-e-t;var a=n.sides||16;var o=n.heightSegments||10;var s=t/r;var l=i/r;var u=e/r;var h=Math.floor(o*s);var c=Math.floor(o*u);var f=Math.floor(o*l);var p=i+t-r/2;var d=t-r/2;var v=t-r/2;var m=n.arc||2*Math.PI;var _=[];var g=[];var y=[];var x=[];var b=Math.max(e,t);var w=Lt.new(-b,-r/2,-b);var T=Lt.new(b,r/2,b);var E=0;var S=[];A();M();R();return{positions:_,normals:g,uvs:y,indices:x,minPos:w,maxPos:T};function M(){var r=(e-t)/i;for(var n=0;n<=f;n++){var o=[];var u=n/f;var h=u*(e-t)+t;for(var c=0;c<=a;++c){var p=c/a;var v=u*l+s;var b=p*m-m/4;var w=Math.sin(b);var T=Math.cos(b);_.push(h*w);_.push(u*i+d);_.push(h*T);Lt.normalize(Ko,Lt.set(Zo,w,-r,T));g.push(Ko.x);g.push(Ko.y);g.push(Ko.z);y.push(p,v);o.push(E);++E}S.push(o)}for(var M=0;M<f;++M){for(var A=0;A<a;++A){var R=S[M][A];var L=S[M+1][A];var C=S[M+1][A+1];var I=S[M][A+1];x.push(R);x.push(I);x.push(L);x.push(I);x.push(C);x.push(L)}}}function A(){for(var e=0;e<=h;++e){var r=e*Math.PI/h/2;var n=Math.sin(r);var i=-Math.cos(r);for(var s=0;s<=a;++s){var l=s*2*Math.PI/a-Math.PI/2;var u=Math.sin(l);var c=Math.cos(l);var f=u*n;var p=i;var d=c*n;var m=s/a;var b=e/o;_.push(f*t,p*t+v,d*t);g.push(f,p,d);y.push(m,b);if(e<h&&s<a){var w=a+1;var T=w*e+s;var S=w*(e+1)+s;var M=w*(e+1)+s+1;var A=w*e+s+1;x.push(T,A,S);x.push(A,M,S)}++E}}}function R(){for(var t=0;t<=c;++t){var r=t*Math.PI/c/2+Math.PI/2;var n=Math.sin(r);var i=-Math.cos(r);for(var s=0;s<=a;++s){var l=s*2*Math.PI/a-Math.PI/2;var h=Math.sin(l);var d=Math.cos(l);var v=h*n;var m=i;var b=d*n;var w=s/a;var T=t/o+(1-u);_.push(v*e,m*e+p,b*e);g.push(v,m,b);y.push(w,T);if(t<c&&s<a){var E=a+1;var M=E*t+s+S[f][a]+1;var A=E*(t+1)+s+S[f][a]+1;var R=E*(t+1)+s+1+S[f][a]+1;var L=E*t+s+1+S[f][a]+1;x.push(M,L,A);x.push(L,R,A)}}}}}var Jo=Object.freeze({box:Ao,cone:Io,cylinder:Co,plane:No,quad:qo,sphere:Xo,torus:Yo,capsule:Qo,wireframe:fo,normals:po});var $o=Lt.new(1,0,0);var es=Lt.new(0,1,0);var ts=Lt.new(0,0,1);var rs=Lt.zero();var ns=Lt.zero();var is=Pt.create();var as=function e(t){this._app=t;this._view2D=new Ui.View;this._view2D._clearFlags=0;this._view2D._cullingByID=true;this._view2D._stages=["opaque"];this._lines=new nn(function(){return{start:Lt.zero(),end:Lt.zero(),color:Pt.create(),duration:0,depthTest:false,timer:0,is2D:false,_prev:null,_next:null}},2e3);this._rects=new nn(function(){return{x:0,y:0,w:1,h:1,color:Pt.create(),duration:0,timer:0,_prev:null,_next:null}},2e3);this._axesList=new nn(function(){return{pos:Lt.zero(),up:Lt.zero(),right:Lt.zero(),forward:Lt.zero(),duration:0,depthTest:false,timer:0,is2D:false,_prev:null,_next:null}},2e3);var r=new Ui.Pass("wireframe");r.setDepth(true,true);var n=new Ui.Technique(["opaque"],[{name:"color",type:Ui.PARAM_COLOR3}],[r]);var i=new Ui.Effect([n],{},[]);i.setProperty("color",Pt.new(1,1,1));this._primitives=new nn(function(){return{model:function(){var e=new Ui.Model;var t=new Tn;e.setNode(t);e.setEffect(i);return e}(),duration:0,depthTest:false,timer:0,_prev:null,_next:null}},2e3);var a=new Ui.Pass("line");a.setDepth(true,true);var o=new Ui.Technique(["opaque"],[],[a]);var s=new Ui.Effect([o],{},[]);var l=new Ui.LineBatchModel;l.setNode(new Tn("debug-lines"));l.setEffect(s);var u=new Ui.LineBatchModel;u.setNode(new Tn("debug-lines-2d"));u.setEffect(s);var h=Xo(1,{segments:20});h.uvs=null;h.indices=fo(h.indices);this._sphereIA=Ui.createIA(t.device,h);this._sphereIA._primitiveType=Me.PT_LINES;this._lineBatchModel=l;this._lineBatchModel2D=u};as.prototype.start=function e(){this._app.scene.addView(this._view2D);this._app.scene.addModel(this._lineBatchModel);this._app.scene.addModel(this._lineBatchModel2D)};as.prototype.stop=function e(){var t=this;this._app.scene.removeView(this._view2D);this._app.scene.removeModel(this._lineBatchModel);this._app.scene.removeModel(this._lineBatchModel2D);this._primitives.forEach(function(e){e.model.setInputAssembler(null);t._app.scene.removeModel(e.model);t._primitives.remove(e)})};as.prototype.tick=function e(){var t=this;var r=this._app.deltaTime;var n=this._app._canvas.width;var i=this._app._canvas.height;Bt.ortho(this._view2D._matProj,0,n,0,i,-100,100);Bt.copy(this._view2D._matViewProj,this._view2D._matProj);Bt.invert(this._view2D._matInvViewProj,this._view2D._matProj);this._view2D._rect.x=this._view2D._rect.y=0;this._view2D._rect.w=n;this._view2D._rect.h=i;this._lineBatchModel.clear();this._lineBatchModel2D.clear();this._lineBatchModel2D._viewID=this._view2D._id;this._lines.forEach(function(e){if(e.timer>e.duration){t._lines.remove(e);return}if(e.is2D){t._lineBatchModel2D.addLine(e.start,e.end,e.color)}else if(e.depthTest){t._lineBatchModel.addLine(e.start,e.end,e.color)}else{console.warn("We have not support it yet")}e.timer+=r});this._rects.forEach(function(e){if(e.timer>e.duration){t._rects.remove(e);return}t._lineBatchModel2D.addLine(Lt.set(rs,e.x,e.y,0),Lt.set(ns,e.x,e.y+e.h,0),e.color);t._lineBatchModel2D.addLine(Lt.set(rs,e.x,e.y+e.h,0),Lt.set(ns,e.x+e.w,e.y+e.h,0),e.color);t._lineBatchModel2D.addLine(Lt.set(rs,e.x+e.w,e.y+e.h,0),Lt.set(ns,e.x+e.w,e.y,0),e.color);t._lineBatchModel2D.addLine(Lt.set(rs,e.x+e.w,e.y,0),Lt.set(ns,e.x,e.y,0),e.color);e.timer+=r});this._axesList.forEach(function(e){if(e.timer>e.duration){t._axesList.remove(e);return}if(e.is2D){t._lineBatchModel2D.addLine(e.pos,e.up,Pt.set(is,1,0,0));t._lineBatchModel2D.addLine(e.pos,e.right,Pt.set(is,0,1,0));t._lineBatchModel2D.addLine(e.pos,e.forward,Pt.set(is,0,0,1))}else if(e.depthTest){t._lineBatchModel.addLine(e.pos,e.up,Pt.set(is,1,0,0));t._lineBatchModel.addLine(e.pos,e.right,Pt.set(is,0,1,0));t._lineBatchModel.addLine(e.pos,e.forward,Pt.set(is,0,0,1))}else{console.warn("We have not support it yet")}e.timer+=r});this._primitives.forEach(function(e){if(e.timer>e.duration){e.model.setInputAssembler(null);t._app.scene.removeModel(e.model);t._primitives.remove(e);return}e.timer+=r})};as.prototype.addLine=function e(t,r,n,i,a,o){if(i===void 0)i=0;if(a===void 0)a=true;if(o===void 0)o=false;var s=this._lines.add();Lt.copy(s.start,t);Lt.copy(s.end,r);Pt.copy(s.color,n);s.duration=i;s.depthTest=a;s.timer=0;s.is2D=o;if(o){s.start.z=0;s.end.z=0}};as.prototype.addRect2D=function e(t,r,n,i,a,o){if(o===void 0)o=0;var s=this._rects.add();s.x=t;s.y=r;s.w=n;s.h=i;Pt.copy(s.color,a);s.duration=o;s.timer=0};as.prototype.addAxes=function e(t,r,n,i,a,o){if(i===void 0)i=0;if(a===void 0)a=true;if(o===void 0)o=false;var s=this._axesList.add();Lt.copy(s.pos,t);Lt.transformQuat(rs,$o,r);Lt.scaleAndAdd(rs,t,rs,n),Lt.copy(s.right,rs);Lt.transformQuat(rs,es,r);Lt.scaleAndAdd(rs,t,rs,n),Lt.copy(s.up,rs);Lt.transformQuat(rs,ts,r);Lt.scaleAndAdd(rs,t,rs,n),Lt.copy(s.forward,rs);s.duration=i;s.depthTest=a;s.timer=0;s.is2D=o};as.prototype.addSphere=function e(t,r,n,i,a){if(i===void 0)i=0;if(a===void 0)a=true;var o=this._primitives.add();o.model.setInputAssembler(this._sphereIA);Lt.copy(o.model._node.lpos,t);Lt.set(o.model._node.lscale,r,r,r);o.duration=i;o.depthTest=a;o.timer=0;this._app.scene.addModel(o.model)};function os(e,t,r,n){var i=[];var a=t*.5;var o=r*.5;var s=t/n;var l=r/n;for(var u=-a;u<=a;u+=s){i.push(u,0,-o);i.push(u,0,o)}for(var h=-o;h<=o;h+=l){i.push(-a,0,h);i.push(a,0,h)}var c=Ui.createIA(e.device,{positions:i});c._primitiveType=Me.PT_LINES;var f=new Ui.Pass("simple");f.setDepth(true,true);var p=new Ui.Technique(["opaque"],[{name:"color",type:Ui.PARAM_COLOR4}],[f]);var d=new Ui.Effect([p],{},[{name:"USE_TEXTURE",value:false},{name:"USE_COLOR",value:true}]);d.define("USE_COLOR",true);d.setProperty("color",Ft.new(.4,.4,.4,1));var v=new Ui.Model;v.setInputAssembler(c);v.setEffect(d);v.setNode(new Tn("debug-grid"));return v}var ss=function e(t){this._state="sleep";this._app=t;this._drawMng=new as(t);this._debugInput=new Fi(t._canvas,{lock:Fi.LOCK_WHEN_PRESSED,invertY:true,enabled:false});this._orbit=new co(this._debugInput);this._camera=new Ui.Camera;this._camera.setColor(.3,.3,.3,1);this._camera.setNode(this._orbit._node);this._camera.setStages(["opaque","transparent"]);this._grid=os(t,100,100,100)};ss.prototype.start=function e(){if(this._state!=="sleep"){return}this._state="enter"};ss.prototype.stop=function e(){if(this._state==="sleep"){return}this._state="fade2normal"};ss.prototype.tick=function e(){if(this._state==="sleep"){return}var t="_"+this._state;var r=this[t];if(!r){console.warn("Unknown state "+this._state);return}this[t]()};ss.prototype.postTick=function e(){this._drawMng.tick()};ss.prototype.drawLine=function e(t,r,n,i,a){if(this._state!=="debug"){return}this._drawMng.addLine(t,r,n,i,a,false)};ss.prototype.drawLine2D=function e(t,r,n,i){if(this._state!=="debug"){return}this._drawMng.addLine(t,r,n,i,false,true)};ss.prototype.drawRect=function e(t,r,n,i,a,o){if(this._state!=="debug"){return}this._drawMng.addRect2D(t,r,n,i,a,o)};ss.prototype.drawAxes=function e(t,r,n,i,a){if(this._state!=="debug"){return}this._drawMng.addAxes(t,r,n,i,a,false)};ss.prototype.drawAxes2D=function e(t,r,n,i){if(this._state!=="debug"){return}this._drawMng.addAxes(t,r,n,i,false,true)};ss.prototype.drawSphere=function e(t,r,n,i,a){if(this._state!=="debug"){return}this._drawMng.addSphere(t,r,n,i,a)};ss.prototype._enter=function e(){var t=null;Ka.walk(this._app.activeLevel,function(e){t=e.getComp("Camera");if(t){return false}return true});if(!t){return}this._app.input.enabled=false;this._debugInput.enabled=true;Lt.copy(this._orbit._node.lpos,t._entity.lpos);Ut.copy(this._orbit._node.lrot,t._entity.lrot);Lt.copy(this._orbit._node.lscale,t._entity.lscale);this._orbit.reset();this._app.scene.setDebugCamera(this._camera);this._app.scene.addModel(this._grid);this._drawMng.start();this._state="fade2debug"};ss.prototype._fade2debug=function e(){this._state="debug"};ss.prototype._debug=function e(){var t=this._app.deltaTime;this._orbit.tick(t);this._debugInput.reset()};ss.prototype._fade2normal=function e(){this._state="exit"};ss.prototype._exit=function e(){this._debugInput.enabled=false;this._app.input.enabled=true;this._app.scene.removeModel(this._grid);this._app.scene.setDebugCamera(null);this._drawMng.stop();this._state="sleep"};function ls(e){return e.map(function(e){return Object.assign({},e)})}var us=function(e){function t(){e.call(this);this._props={};this._effectInst=null;this._effect=null}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;var r={effect:{configurable:true},effectInst:{configurable:true}};t.prototype._updateEffectInst=function e(){var t=this;var r=this._effect.techniques.length;var n=new Array(r);var i={};for(var a=0;a<r;++a){var o=t._effect.techniques[a];for(var s=0;s<o.params.length;++s){var l=o.params[s];switch(l.type){case Ui.PARAM_FLOAT:i[l.name]=l.value;break;case Ui.PARAM_FLOAT2:i[l.name]=Rt.new(l.value[0],l.value[1]);break;case Ui.PARAM_FLOAT3:i[l.name]=Lt.new(l.value[0],l.value[1],l.value[2]);break;case Ui.PARAM_FLOAT4:i[l.name]=Ct.new(l.value[0],l.value[1],l.value[2],l.value[3]);break;case Ui.PARAM_COLOR3:i[l.name]=Pt.new(l.value[0],l.value[1],l.value[2]);break;case Ui.PARAM_COLOR4:i[l.name]=Ft.new(l.value[0],l.value[1],l.value[2],l.value[3]);break;case Ui.PARAM_TEXTURE_2D:case Ui.PARAM_TEXTURE_CUBE:i[l.name]=null;break;default:console.warn("unsupport param type in effect json.")}}var u=o.passes.length;var h=new Array(u);for(var c=0;c<u;++c){var f=o.passes[c];h[c]=new Ui.Pass(f.program);if(f.depthTest!==undefined&&f.depthWrite!==undefined){h[c].setDepth(f.depthTest,f.depthWrite)}if(f.cullMode!==undefined){h[c].setCullMode(f.cullMode)}if(f.blend===true){h[c].setBlend(f.blendEq,f.blendSrc,f.blendDst,f.blendAlphaEq,f.blendSrcAlpha,f.blendDstAlpha)}}n[a]=new Ui.Technique(o.stages,o.params,h,o.layer)}for(var p in i){t._props[p]=i[p]}var d=ls(this._effect.defines);var v=ls(this._effect.dependencies);if(this._effectInst){this._effectInst.clear();this._effectInst._techniques=n;this._effectInst._properties=i;this._effectInst._defines=d;this._effectInst._dependencies=v}else{this._effectInst=new Ui.Effect(n,i,d,v)}};r.effect.get=function(){return this._effect};r.effect.set=function(e){if(this._effect!==e){this._effect=e;this._updateEffectInst()}};r.effectInst.get=function(){return this._effectInst};t.prototype.copy=function e(t){var r=this;if(this._effect!==t._effect){this._effect=t._effect;this._updateEffectInst()}this._effectInst._defines=ls(t._effectInst._defines);this._effectInst._dependencies=ls(t._effectInst._dependencies);for(var n in t._props){r.setProperty(n,t._props[n])}};t.prototype.setProperty=function e(t,r){this._props[t]=r;if(r instanceof La){this._effectInst.setProperty(t,r._texture)}else{this._effectInst.setProperty(t,r)}};t.prototype.define=function e(t,r){this._effectInst.define(t,r)};t.prototype.unload=function t(){if(!this._loaded){return}e.prototype.unload.call(this)};Object.defineProperties(t.prototype,r);return t}(Ma);var hs={images:[],mipmap:true,width:2,height:2,format:Me.TEXTURE_FMT_RGBA8,anisotropy:1,wrapS:Me.WRAP_REPEAT,wrapT:Me.WRAP_REPEAT,minFilter:Me.FILTER_LINEAR,magFilter:Me.FILTER_LINEAR,mipFilter:Me.FILTER_LINEAR};function cs(e,t){e.images=t._images;e.mipmap=t._mipmap;e.width=t._width;e.height=t._height;e.format=Ua[t._format];e.anisotropy=t._anisotropy;e.wrapS=Ia[t._wrapS];e.wrapT=Ia[t._wrapT];e.minFilter=Ca[t._minFilter];e.magFilter=Ca[t._magFilter];e.mipFilter=Ca[t._mipFilter]}var fs=function(e){function t(t,r,n,i){if(r===void 0)r=2;if(n===void 0)n=2;if(i===void 0)i="rgba8";e.call(this,t);this._images=[];this._mipmap=true;this._width=r;this._height=n;this._format=i;this._anisotropy=1;this._wrapS="repeat";this._wrapT="repeat";this._minFilter="linear";this._magFilter="linear";this._mipFilter="linear"}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;var r={width:{configurable:true},height:{configurable:true},mipmap:{configurable:true},anisotropy:{configurable:true},wrapS:{configurable:true},wrapT:{configurable:true},minFilter:{configurable:true},magFilter:{configurable:true},mipFilter:{configurable:true}};t.prototype.unload=function t(){if(!this._loaded){return}this._texture.destroy();e.prototype.unload.call(this)};t.prototype.setImages=function e(t){this._images=t;this.resize(t[0][0].width,t[0][0].height)};t.prototype.resize=function e(t,r){this._width=t;this._height=r};r.width.get=function(){return this._width};r.height.get=function(){return this._height};r.mipmap.set=function(e){this._mipmap=e};r.mipmap.get=function(){return this._mipmap};r.anisotropy.set=function(e){this._anisotropy=e};r.anisotropy.get=function(){return this._anisotropy};r.wrapS.set=function(e){this._wrapS=e};r.wrapS.get=function(){return this._wrapS};r.wrapT.set=function(e){this._wrapT=e};r.wrapT.get=function(){return this._wrapT};r.minFilter.set=function(e){this._minFilter=e};r.minFilter.get=function(){return this._minFilter};r.magFilter.set=function(e){this._magFilter=e};r.magFilter.get=function(){return this._magFilter};r.mipFilter.set=function(e){this._mipFilter=e};r.mipFilter.get=function(){return this._mipFilter};t.prototype.commit=function e(){cs(hs,this);if(!this._texture){this._texture=new Me.TextureCube(this._device,hs)}else{this._texture.update(hs)}this._images=[]};Object.defineProperties(t.prototype,r);return t}(La);var ps=function(e){function t(){e.call(this);this._techniques=[];this._properties={};this._defines=[];this._dependencies=[]}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;var r={techniques:{configurable:true},properties:{configurable:true},defines:{configurable:true},dependencies:{configurable:true}};r.techniques.set=function(e){this._techniques=e};r.techniques.get=function(){return this._techniques};r.properties.set=function(e){this._properties=e};r.properties.get=function(){return this._properties};r.defines.set=function(e){this._defines=e};r.defines.get=function(){return this._defines};r.dependencies.set=function(e){this._dependencies=e};r.dependencies.get=function(){return this._dependencies};t.prototype.unload=function t(){if(!this._loaded){return}e.prototype.unload.call(this)};Object.defineProperties(t.prototype,r);return t}(Ma);var ds=Lt.zero();var vs=Lt.zero();var ms=Bt.create();var _s=Bt.create();var gs=function(e){function t(){var t=this;e.call(this);this._texture=null;this._x=0;this._y=0;this._width=64;this._height=64;this._rotated=false;this._left=0;this._right=0;this._top=0;this._bottom=0;this._uvs=new Array(16);for(var r=0;r<16;++r){t._uvs[r]=Lt.zero()}}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;var r={texture:{configurable:true},x:{configurable:true},y:{configurable:true},width:{configurable:true},height:{configurable:true},rotated:{configurable:true},left:{configurable:true},right:{configurable:true},top:{configurable:true},bottom:{configurable:true},uvs:{configurable:true}};r.texture.get=function(){return this._texture};r.texture.set=function(e){this._texture=e};r.x.get=function(){return this._x};r.x.set=function(e){this._x=e};r.y.get=function(){return this._y};r.y.set=function(e){this._y=e};r.width.get=function(){return this._width};r.width.set=function(e){this._width=e};r.height.get=function(){return this._height};r.height.set=function(e){this._height=e};r.rotated.get=function(){return this._rotated};r.rotated.set=function(e){this._rotated=e};r.left.get=function(){return this._left};r.left.set=function(e){this._left=e};r.right.get=function(){return this._right};r.right.set=function(e){this._right=e};r.top.get=function(){return this._top};r.top.set=function(e){this._top=e};r.bottom.get=function(){return this._bottom};r.bottom.set=function(e){this._bottom=e};r.uvs.get=function(){return this._uvs};t.prototype.commit=function e(){var t=this;var r=this._texture.width;var n=this._texture.height;if(this._rotated){Lt.set(vs,this._width,this._height,1);Bt.fromScaling(_s,vs);Bt.fromZRotation(ms,-Math.PI/2);Bt.multiply(_s,ms,_s);Lt.set(ds,this._x,n-this._y,0);Bt.fromTranslation(ms,ds);Bt.multiply(_s,ms,_s);Lt.set(vs,1/r,1/n,1);Bt.fromScaling(ms,vs);Bt.multiply(_s,ms,_s)}else{Lt.set(vs,this._width,this._height,1);Bt.fromScaling(_s,vs);Lt.set(ds,this._x,n-(this._y+this._height),0);Bt.fromTranslation(ms,ds);Bt.multiply(_s,ms,_s);Lt.set(vs,1/r,1/n,1);Bt.fromScaling(ms,vs);Bt.multiply(_s,ms,_s)}var i=this._uvs;i[0].x=i[4].x=i[8].x=i[12].x=0;i[1].x=i[5].x=i[9].x=i[13].x=this._left/this._width;i[2].x=i[6].x=i[10].x=i[14].x=1-this._right/this._width;i[3].x=i[7].x=i[11].x=i[15].x=1;i[0].y=i[1].y=i[2].y=i[3].y=0;i[4].y=i[5].y=i[6].y=i[7].y=this._bottom/this._height;i[8].y=i[9].y=i[10].y=i[11].y=1-this._top/this._height;i[12].y=i[13].y=i[14].y=i[15].y=1;for(var a=0;a<this._uvs.length;++a){Lt.transformMat4(t._uvs[a],t._uvs[a],_s)}};Object.defineProperties(t.prototype,r);return t}(Ma);var ys=[{name:"font",techniques:[{stages:["ui"],params:[{name:"mainTexture",type:13,value:null}],passes:[{program:"sprite",depthTest:true,depthWrite:false,blend:true,blendEq:32774,blendSrc:1,blendDst:771,blendAlphaEq:32774,blendSrcAlpha:1,blendDstAlpha:771}],layer:0}],properties:{},defines:[],dependencies:undefined},{name:"grid",techniques:[{stages:["opaque"],params:[{name:"tiling",type:5,value:[1,1]},{name:"baseColorWhite",type:8,value:[1,1,1]},{name:"baseColorBlack",type:8,value:[0,0,0]},{name:"basePattern",type:13,value:null},{name:"basePatternTiling",type:5,value:[1,1]},{name:"basePatternOffset",type:5,value:[0,0]},{name:"subPatternColor",type:9,value:[1,1,1,1]},{name:"subPattern",type:13,value:null},{name:"subPatternTiling",type:5,value:[1,1]},{name:"subPatternOffset",type:5,value:[0,0]},{name:"subPatternColor2",type:9,value:[1,1,1,1]},{name:"subPattern2",type:13,value:null},{name:"subPattern2Tiling",type:5,value:[1,1]},{name:"subPattern2Offset",type:5,value:[0,0]}],passes:[{program:"grid"}],layer:0}],properties:{},defines:[{name:"USE_WORLD_POS",value:false}],dependencies:undefined},{name:"line",techniques:[{stages:["opaque"],params:[],passes:[{program:"line",depthTest:true,depthWrite:true}],layer:0}],properties:{},defines:[],dependencies:undefined},{name:"matcap",techniques:[{stages:["opaque"],params:[{name:"mainTex",type:13,value:null},{name:"matcapTex",type:13,value:null},{name:"colorFactor",type:4,value:.5},{name:"color",type:9,value:[1,1,1,1]}],passes:[{program:"matcap",depthTest:true,depthWrite:true}],layer:0}],properties:{},defines:[{name:"USE_MAIN_TEX",value:false},{name:"USE_SKINNING",value:false}],dependencies:undefined},{name:"particle-add-multiply",techniques:[{stages:["transparent"],params:[{name:"mainTexture",type:13,value:null},{name:"mainTiling",type:5,value:[1,1]},{name:"mainOffset",type:5,value:[0,0]},{name:"tintColor",type:9,value:[.5,.5,.5,.5]},{name:"frameTile",type:5,value:[1,1]},{name:"velocityScale",type:4,value:0},{name:"lengthScale",type:4,value:0}],passes:[{program:"particle-add-multiply",cullMode:0,depthTest:true,depthWrite:false,blend:true,blendEq:32774,blendSrc:1,blendDst:771,blendAlphaEq:32774,blendSrcAlpha:1,blendDstAlpha:771}],layer:0}],properties:{},defines:[{name:"USE_SOFT_PARTICLE",value:false},{name:"USE_BILLBOARD",value:false},{name:"USE_STRETCHED_BILLBOARD",value:false},{name:"USE_HORIZONTAL_BILLBOARD",value:false},{name:"USE_VERTICAL_BILLBOARD",value:false},{name:"USE_WORLD_SPACE",value:false}],dependencies:undefined},{name:"particle-add-smooth",techniques:[{stages:["transparent"],params:[{name:"mainTexture",type:13,value:null},{name:"mainTiling",type:5,value:[1,1]},{name:"mainOffset",type:5,value:[0,0]},{name:"frameTile",type:5,value:[1,1]},{name:"velocityScale",type:4,value:0},{name:"lengthScale",type:4,value:0}],passes:[{program:"particle-add-smooth",cullMode:0,depthTest:true,depthWrite:false,blend:true,blendEq:32774,blendSrc:1,blendDst:769,blendAlphaEq:32774,blendSrcAlpha:1,blendDstAlpha:769}],layer:0}],properties:{},defines:[{name:"USE_SOFT_PARTICLE",value:false},{name:"USE_BILLBOARD",value:false},{name:"USE_STRETCHED_BILLBOARD",value:false},{name:"USE_HORIZONTAL_BILLBOARD",value:false},{name:"USE_VERTICAL_BILLBOARD",value:false},{name:"USE_WORLD_SPACE",value:false}],dependencies:undefined},{name:"particle-add",techniques:[{stages:["transparent"],params:[{name:"mainTexture",type:13,value:null},{name:"mainTiling",type:5,value:[1,1]},{name:"mainOffset",type:5,value:[0,0]},{name:"tintColor",type:9,value:[.5,.5,.5,.5]},{name:"frameTile",type:5,value:[1,1]},{name:"velocityScale",type:4,value:0},{name:"lengthScale",type:4,value:0}],passes:[{program:"particle-add",cullMode:0,depthTest:true,depthWrite:false,blend:true,blendEq:32774,blendSrc:770,blendDst:1,blendAlphaEq:32774,blendSrcAlpha:770,blendDstAlpha:1}],layer:0}],properties:{},defines:[{name:"USE_SOFT_PARTICLE",value:false},{name:"USE_BILLBOARD",value:false},{name:"USE_STRETCHED_BILLBOARD",value:false},{name:"USE_HORIZONTAL_BILLBOARD",value:false},{name:"USE_VERTICAL_BILLBOARD",value:false},{name:"USE_WORLD_SPACE",value:false}],dependencies:undefined},{name:"particle-alpha-blend",techniques:[{stages:["transparent"],params:[{name:"mainTexture",type:13,value:null},{name:"mainTiling",type:5,value:[1,1]},{name:"mainOffset",type:5,value:[0,0]},{name:"tintColor",type:9,value:[.5,.5,.5,.5]},{name:"frameTile",type:5,value:[1,1]},{name:"velocityScale",type:4,value:0},{name:"lengthScale",type:4,value:0}],passes:[{program:"particle-alpha-blend",cullMode:0,depthTest:true,depthWrite:false,blend:true,blendEq:32774,blendSrc:770,blendDst:771,blendAlphaEq:32774,blendSrcAlpha:770,blendDstAlpha:771}],layer:0}],properties:{},defines:[{name:"USE_SOFT_PARTICLE",value:false},{name:"USE_BILLBOARD",value:false},{name:"USE_STRETCHED_BILLBOARD",value:false},{name:"USE_HORIZONTAL_BILLBOARD",value:false},{name:"USE_VERTICAL_BILLBOARD",value:false},{name:"USE_WORLD_SPACE",value:false}],dependencies:undefined},{name:"particle-premultiply-blend",techniques:[{stages:["transparent"],params:[{name:"mainTexture",type:13,value:null},{name:"mainTiling",type:5,value:[1,1]},{name:"mainOffset",type:5,value:[0,0]},{name:"frameTile",type:5,value:[1,1]},{name:"velocityScale",type:4,value:0},{name:"lengthScale",type:4,value:0}],passes:[{program:"particle-premultiply-blend",cullMode:0,depthTest:true,depthWrite:false,blend:true,blendEq:32774,blendSrc:1,blendDst:771,blendAlphaEq:32774,blendSrcAlpha:1,blendDstAlpha:771}],layer:0}],properties:{},defines:[{name:"USE_SOFT_PARTICLE",value:false},{name:"USE_BILLBOARD",value:false},{name:"USE_STRETCHED_BILLBOARD",value:false},{name:"USE_HORIZONTAL_BILLBOARD",value:false},{name:"USE_VERTICAL_BILLBOARD",value:false},{name:"USE_WORLD_SPACE",value:false}],dependencies:undefined},{name:"pbr-transparent",techniques:[{stages:["transparent"],params:[{name:"albedo",type:9,value:[1,1,1,1]},{name:"mainTiling",type:5,value:[1,1]},{name:"mainOffset",type:5,value:[0,0]},{name:"albedo_texture",type:13,value:null},{name:"metallic",type:4,value:1},{name:"metallic_texture",type:13,value:null},{name:"roughness",type:4,value:.5},{name:"roughness_texture",type:13,value:null},{name:"ao",type:4,value:.2},{name:"ao_texture",type:13,value:null},{name:"emissive",type:8,value:[0,0,0]},{name:"emissive_texture",type:13,value:null},{name:"normal_texture",type:13,value:null},{name:"diffuseEnvTexture",type:14,value:null},{name:"specularEnvTexture",type:14,value:null},{name:"brdfLUT",type:13,value:null},{name:"maxReflectionLod",type:4,value:9},{name:"alphaTestThreshold",type:4,value:0}],passes:[{program:"pbr",cullMode:1029,depthTest:true,depthWrite:false,blend:true,blendEq:32774,blendSrc:770,blendDst:771,blendAlphaEq:32774,blendSrcAlpha:1,blendDstAlpha:771}],layer:0},{stages:["shadowcast"],params:[],passes:[{program:"shadow-depth",cullMode:1029,blendMode:0,depthTest:true,depthWrite:true}],layer:0}],properties:{},defines:[{name:"USE_NORMAL_TEXTURE",value:false},{name:"USE_ALBEDO_TEXTURE",value:false},{name:"USE_MRA_TEXTURE",value:false},{name:"USE_METALLIC_TEXTURE",value:false},{name:"USE_ROUGHNESS_TEXTURE",value:false},{name:"USE_AO_TEXTURE",value:false},{name:"USE_EMISSIVE",value:false},{name:"USE_EMISSIVE_TEXTURE",value:false},{name:"USE_IBL",value:false},{name:"USE_TEX_LOD",value:false},{name:"USE_ALPHA_TEST",value:false},{name:"USE_SHADOW_MAP",value:false},{name:"USE_SKINNING",value:false},{name:"NUM_DIR_LIGHTS",value:0},{name:"NUM_POINT_LIGHTS",value:0},{name:"NUM_SPOT_LIGHTS",value:0},{name:"NUM_SHADOW_LIGHTS",value:0}],dependencies:[{define:"USE_NORMAL_TEXTURE",extension:"OES_standard_derivatives"},{define:"USE_TEX_LOD",extension:"EXT_shader_texture_lod"}]},{name:"pbr",techniques:[{stages:["opaque"],params:[{name:"albedo",type:9,value:[1,1,1,1]},{name:"mainTiling",type:5,value:[1,1]},{name:"mainOffset",type:5,value:[0,0]},{name:"albedo_texture",type:13,value:null},{name:"metallic",type:4,value:1},{name:"metallic_texture",type:13,value:null},{name:"roughness",type:4,value:.5},{name:"roughness_texture",type:13,value:null},{name:"ao",type:4,value:.2},{name:"ao_texture",type:13,value:null},{name:"emissive",type:8,value:[0,0,0]},{name:"emissive_texture",type:13,value:null},{name:"normal_texture",type:13,value:null},{name:"diffuseEnvTexture",type:14,value:null},{name:"specularEnvTexture",type:14,value:null},{name:"brdfLUT",type:13,value:null},{name:"maxReflectionLod",type:4,value:9},{name:"alphaTestThreshold",type:4,value:0}],passes:[{program:"pbr",cullMode:1029,depthTest:true,depthWrite:true}],layer:0},{stages:["shadowcast"],params:[],passes:[{program:"shadow-depth",cullMode:1029,blendMode:0,depthTest:true,depthWrite:true}],layer:0}],properties:{},defines:[{name:"USE_NORMAL_TEXTURE",value:false},{name:"USE_ALBEDO_TEXTURE",value:false},{name:"USE_MRA_TEXTURE",value:false},{name:"USE_METALLIC_TEXTURE",value:false},{name:"USE_ROUGHNESS_TEXTURE",value:false},{name:"USE_AO_TEXTURE",value:false},{name:"USE_EMISSIVE",value:false},{name:"USE_EMISSIVE_TEXTURE",value:false},{name:"USE_IBL",value:false},{name:"USE_TEX_LOD",value:false},{name:"USE_ALPHA_TEST",value:false},{name:"USE_SHADOW_MAP",value:false},{name:"USE_SKINNING",value:false},{name:"NUM_DIR_LIGHTS",value:0},{name:"NUM_POINT_LIGHTS",value:0},{name:"NUM_SPOT_LIGHTS",value:0},{name:"NUM_SHADOW_LIGHTS",value:0},{name:"USE_RGBE_HDR_IBL_SPECULAR",value:false},{name:"USE_RGBE_HDR_IBL_DIFFUSE",value:false}],dependencies:[{define:"USE_NORMAL_TEXTURE",extension:"OES_standard_derivatives"},{define:"USE_TEX_LOD",extension:"EXT_shader_texture_lod"}]},{name:"phong-transparent",techniques:[{stages:["transparent"],params:[{name:"diffuseColor",type:9,value:[.8,.8,.8,1]},{name:"mainTiling",type:5,value:[1,1]},{name:"mainOffset",type:5,value:[0,0]},{name:"diffuse_texture",type:13,value:null},{name:"specularColor",type:8,value:[0,0,0]},{name:"specular_texture",type:13,value:null},{name:"emissiveColor",type:8,value:[0,0,0]},{name:"emissive_texture",type:13,value:null},{name:"glossiness",type:4,value:10},{name:"normal_texture",type:13,value:null},{name:"alphaTestThreshold",type:4,value:0}],passes:[{program:"phong",cullMode:1029,depthTest:true,depthWrite:false,blend:true,blendEq:32774,blendSrc:770,blendDst:771,blendAlphaEq:32774,blendSrcAlpha:1,blendDstAlpha:771}],layer:0},{stages:["shadowcast"],params:[],passes:[{program:"shadow-depth",cullMode:1029,depthTest:true,depthWrite:true}],layer:0}],properties:{},defines:[{name:"USE_NORMAL_TEXTURE",value:false},{name:"USE_DIFFUSE_TEXTURE",value:false},{name:"USE_SPECULAR",value:false},{name:"USE_SPECULAR_TEXTURE",value:false},{name:"USE_EMISSIVE",value:false},{name:"USE_EMISSIVE_TEXTURE",value:false},{name:"USE_ALPHA_TEST",value:false},{name:"USE_SKINNING",value:false},{name:"USE_SHADOW_MAP",value:false},{name:"NUM_DIR_LIGHTS",value:0},{name:"NUM_POINT_LIGHTS",value:0},{name:"NUM_SPOT_LIGHTS",value:0},{name:"NUM_SHADOW_LIGHTS",value:0}],dependencies:[{define:"USE_NORMAL_TEXTURE",extension:"OES_standard_derivatives"}]},{name:"phong",techniques:[{stages:["opaque"],params:[{name:"diffuseColor",type:9,value:[.8,.8,.8,1]},{name:"mainTiling",type:5,value:[1,1]},{name:"mainOffset",type:5,value:[0,0]},{name:"diffuse_texture",type:13,value:null},{name:"specularColor",type:8,value:[0,0,0]},{name:"specular_texture",type:13,value:null},{name:"emissiveColor",type:8,value:[0,0,0]},{name:"emissive_texture",type:13,value:null},{name:"glossiness",type:4,value:10},{name:"normal_texture",type:13,value:null},{name:"alphaTestThreshold",type:4,value:0}],passes:[{program:"phong",cullMode:1029,depthTest:true,depthWrite:true}],layer:0},{stages:["shadowcast"],params:[],passes:[{program:"shadow-depth",cullMode:1029,depthTest:true,depthWrite:true}],layer:0}],properties:{},defines:[{name:"USE_NORMAL_TEXTURE",value:false},{name:"USE_DIFFUSE_TEXTURE",value:false},{name:"USE_SPECULAR",value:false},{name:"USE_SPECULAR_TEXTURE",value:false},{name:"USE_EMISSIVE",value:false},{name:"USE_EMISSIVE_TEXTURE",value:false},{name:"USE_ALPHA_TEST",value:false},{name:"USE_SKINNING",value:false},{name:"USE_SHADOW_MAP",value:false},{name:"NUM_DIR_LIGHTS",value:0},{name:"NUM_POINT_LIGHTS",value:0},{name:"NUM_SPOT_LIGHTS",value:0},{name:"NUM_SHADOW_LIGHTS",value:0}],dependencies:[{define:"USE_NORMAL_TEXTURE",extension:"OES_standard_derivatives"}]},{name:"simple",techniques:[{stages:["opaque"],params:[{name:"color",type:9,value:[.4,.4,.4,1]}],passes:[{program:"simple",depthTest:true,depthWrite:true}],layer:0}],properties:{},defines:[{name:"USE_TEXTURE",value:false},{name:"USE_COLOR",value:false}],dependencies:undefined},{name:"skybox",techniques:[{stages:["opaque"],params:[{name:"cubeMap",type:14,value:null}],passes:[{program:"skybox",cullMode:0}],layer:-1}],properties:{},defines:[{name:"USE_RGBE_HDR",value:false}],dependencies:undefined},{name:"sprite",techniques:[{stages:["ui"],params:[{name:"mainTexture",type:13,value:null}],passes:[{program:"sprite",depthTest:true,depthWrite:false,blend:true,blendEq:32774,blendSrc:770,blendDst:771,blendAlphaEq:32774,blendSrcAlpha:1,blendDstAlpha:771}],layer:0}],properties:{},defines:[],dependencies:undefined},{name:"unlit-transparent",techniques:[{stages:["transparent"],params:[{name:"color",type:9,value:[1,1,1,1]},{name:"mainTiling",type:5,value:[1,1]},{name:"mainOffset",type:5,value:[0,0]},{name:"mainTexture",type:13,value:null}],passes:[{program:"unlit",cullMode:1029,depthTest:true,depthWrite:true,blend:true,blendEq:32774,blendSrc:770,blendDst:771,blendAlphaEq:32774,blendSrcAlpha:1,blendDstAlpha:771}],layer:0}],properties:{},defines:[{name:"USE_TEXTURE",value:false},{name:"USE_COLOR",value:false},{name:"USE_SKINNING",value:false}],dependencies:undefined},{name:"unlit",techniques:[{stages:["opaque"],params:[{name:"color",type:9,value:[1,1,1,1]},{name:"mainTiling",type:5,value:[1,1]},{name:"mainOffset",type:5,value:[0,0]},{name:"mainTexture",type:13,value:null}],passes:[{program:"unlit",cullMode:1029,depthTest:true,depthWrite:true}],layer:0}],properties:{},defines:[{name:"USE_TEXTURE",value:false},{name:"USE_COLOR",value:false},{name:"USE_SKINNING",value:false}],dependencies:undefined},{name:"wireframe",techniques:[{stages:["opaque"],params:[{name:"color",type:8,value:[1,1,1]}],passes:[{program:"wireframe",depthTest:true,depthWrite:true}],layer:0}],properties:{},defines:[],dependencies:undefined}];function xs(e){var t;var r=document.createElement("canvas");var n=r.getContext("2d");r.width=r.height=128;n.fillStyle="#ddd";n.fillRect(0,0,128,128);n.fillStyle="#555";n.fillRect(0,0,64,64);n.fillStyle="#555";n.fillRect(64,64,64,64);var i=new Pa(e);i.mipmap=true;i.wrapS="repeat";i.wrapT="repeat";i.setImage(0,r);i.commit();i._uuid="default-texture";i._loaded=true;var a=new fs(e);a.setImages([[r,r,r,r,r,r]]);a.commit();a._uuid="default-texture-cube";a._loaded=true;r.width=r.height=2;n.fillStyle="#000";n.fillRect(0,0,2,2);var o=new Pa(e);o.mipmap=false;o.wrapS="repeat";o.wrapT="repeat";o.minFilter="nearest";o.magFilter="nearest";o.setImage(0,r);o.commit();o._uuid="black-texture";o._loaded=true;r.width=r.height=2;n.fillStyle="#fff";n.fillRect(0,0,2,2);var s=new Pa(e);s.mipmap=false;s.wrapS="repeat";s.wrapT="repeat";s.minFilter="nearest";s.magFilter="nearest";s.setImage(0,r);s.commit();s._uuid="white-texture";s._loaded=true;var l=new gs;l._texture=s;l.width=s.width;l.height=s.height;l.commit();l._uuid="default-sprite";l._loaded=true;var u=new Ra;u._subMeshes=new Array(1);var h=Ao(1,1,1,{widthSegments:1,heightSegments:1,lengthSegments:1});u._subMeshes[0]=Ui.createIA(e,h);u._uuid="builtin-cube";u._loaded=true;u._minPos=Lt.clone(h.minPos);u._maxPos=Lt.clone(h.maxPos);var c=new Ra;c._subMeshes=new Array(1);var f=Xo(.5,{segments:64});c._subMeshes[0]=Ui.createIA(e,f);c._uuid="builtin-sphere";c._loaded=true;c._minPos=Lt.clone(f.minPos);c._maxPos=Lt.clone(f.maxPos);var p=new Ra;p._subMeshes=new Array(1);var d=Co(.5,.5,2,{radialSegments:20,capped:true});p._subMeshes[0]=Ui.createIA(e,d);p._uuid="builtin-cylinder";p._loaded=true;p._minPos=Lt.clone(d.minPos);p._maxPos=Lt.clone(d.maxPos);var v=new Ra;v._subMeshes=new Array(1);var m=No(10,10,{uSegments:10,vSegments:10});v._subMeshes[0]=Ui.createIA(e,m);v._uuid="builtin-plane";v._loaded=true;v._minPos=Lt.clone(m.minPos);v._maxPos=Lt.clone(m.maxPos);var _=new Ra;_._subMeshes=new Array(1);var g=Qo(.5,.5,2,{heightSegments:30,sides:20});_._subMeshes[0]=Ui.createIA(e,g);_._uuid="builtin-capsule";_._loaded=true;_._minPos=Lt.clone(g.minPos);_._maxPos=Lt.clone(g.maxPos);var y={};for(var x=0;x<ys.length;++x){var b=ys[x];var w=new ps;w._name=b.name;w._uuid="builtin-effect-"+b.name;w._loaded=true;w.techniques=b.techniques;w.properties=b.properties;w.defines=b.defines;w.dependencies=b.dependencies?b.dependencies:[];y[w._uuid]=w}var T={};["sprite","font"].forEach(function(e){var t=new us;t.effect=y["builtin-effect-"+e];t._uuid="builtin-material-"+e;t._loaded=true;T[t._uuid]=t});return Object.assign((t={},t[i._uuid]=i,t[a._uuid]=a,t[o._uuid]=o,t[s._uuid]=s,t[l._uuid]=l,t[u._uuid]=u,t[c._uuid]=c,t[p._uuid]=p,t[v._uuid]=v,t[_._uuid]=_,t),y,T)}var bs={int:{default:0,parse:function e(t,r,n){var i=r;if(typeof r==="string"){i=parseInt(r)}if(n.min!==undefined){i=Math.max(n.min,i)}if(n.max!==undefined){i=Math.min(n.max,i)}return i}},number:{default:0,parse:function e(t,r,n){var i=r;if(typeof r==="string"){i=parseFloat(r)}if(n.min!==undefined){i=Math.max(n.min,i)}if(n.max!==undefined){i=Math.min(n.max,i)}return i}},string:{default:"",parse:function e(t,r){return r}},boolean:{default:true,parse:function e(t,r){return!!r}},object:{default:null,parse:function e(t,r){return r}},enums:{default:"",parse:function e(t,r,n){if(n.options.indexOf(r)===-1){console.log("Invalid option: "+r);if(n.default!==undefined){return n.default}return""}return r}},color3:{default:[1,1,1],parse:function e(t,r){if(Array.isArray(r)){return Pt.new(r[0],r[1],r[2])}return r}},color4:{default:[1,1,1,1],parse:function e(t,r){if(Array.isArray(r)){return Ft.new(r[0],r[1],r[2],r[3])}return r}},vec2:{default:[0,0],parse:function e(t,r){if(Array.isArray(r)){return Rt.new(r[0],r[1])}return r}},vec3:{default:[0,0,0],parse:function e(t,r){if(Array.isArray(r)){return Lt.new(r[0],r[1],r[2])}return r}},vec4:{default:[0,0,0,0],parse:function e(t,r){if(Array.isArray(r)){return Ct.new(r[0],r[1],r[2],r[3])}return r}},quat:{default:[0,0,0,1],parse:function e(t,r){if(Array.isArray(r)){return Ut.new(r[0],r[1],r[2],r[3])}return r}},mat3:{default:[1,0,0,0,1,0,0,0,1],parse:function e(t,r){if(Array.isArray(r)){return It.new(r[0],r[1],r[2],r[3],r[4],r[5],r[6],r[7],r[8])}return r}},mat4:{default:[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],parse:function e(t,r){if(Array.isArray(r)){return Bt.new(r[0],r[1],r[2],r[3],r[4],r[5],r[6],r[7],r[8],r[9],r[10],r[11],r[12],r[13],r[14],r[15])}return r}},asset:{default:null,parse:function e(t,r){if(typeof r==="string"){return t.assets.get(r)}return r}},rect:{default:[0,0,1,1],parse:function e(t,r){if(Array.isArray(r)){return r}return[r.x,r.y,r.w,r.h]}},entity:{default:null,parse:function e(t,r,n,i){if(typeof r==="string"){var a=r.match(/e(\d+)/);if(a){var o=parseInt(a[1]);return i[o]}}return r}},component:{default:null,parse:function e(t,r,n,i){if(typeof r==="string"){var a=r.match(/e(\d+)c(\d+)/);if(a){var o=parseInt(a[0]);var s=parseInt(a[1]);var l=i[o];var u=l._comps[s];return u}}return r}}};function ws(e,t){var r=0;var n=e.length-1;var i;while(r<=n){i=r+n>>1;var a=e[i];if(a<t){r=i+1}else if(a>t){n=i-1}else{return i}}return r}var Ts=function(e){function t(){e.call(this);this._framesList=null;this._length=0}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;var r={length:{configurable:true}};r.length.get=function(){return this._length};t.prototype.sample=function e(t,r){var n=this;He(r,0,this._length);for(var i=0;i<this._framesList.length;++i){var a=n._framesList[i];if(a.times.length===1){for(var o=0;o<a.joints.length;++o){var s=a.joints[o];var l=t._joints[s.id];if(s.translations){Lt.copy(l.lpos,s.translations[0])}if(s.rotations){Ut.copy(l.lrot,s.rotations[0])}if(s.scales){Lt.copy(l.lscale,s.scales[0])}}}else{var u=ws(a.times,r);if(u===0){for(var h=0;h<a.joints.length;++h){var c=a.joints[h];var f=t._joints[c.id];if(c.translations){Lt.copy(f.lpos,c.translations[0])}if(c.rotations){Ut.copy(f.lrot,c.rotations[0])}if(c.scales){Lt.copy(f.lscale,c.scales[0])}}return}var p=Math.max(u-1,0);var d=Math.min(u,a.times.length);var v=(r-a.times[p])/(a.times[d]-a.times[p]);for(var m=0;m<a.joints.length;++m){var _=a.joints[m];var g=t._joints[_.id];if(_.translations){var y=_.translations[p];var x=_.translations[d];Lt.lerp(g.lpos,y,x,v)}if(_.rotations){var b=_.rotations[p];var w=_.rotations[d];Ut.slerp(g.lrot,b,w,v)}if(_.scales){var T=_.scales[p];var E=_.scales[d];Lt.lerp(g.lscale,T,E,v)}}}}t.updateMatrices()};Object.defineProperties(t.prototype,r);return t}(Ma);var Es=function e(){this._root=null;this._joints=null;this._matrices=null};Es.prototype.setRoot=function e(t){var r=this;this._root=t;this._joints=Dn.flat(this._root);this._matrices=new Array(this._joints.length);for(var n=0;n<this._joints.length;++n){r._matrices[n]=Bt.create()}this.updateMatrices()};Es.prototype.blend=function e(t,r,n){var i=this;for(var a=0;a<this._joints.length;++a){var o=i._joints[a];var s=t._joints[a];var l=r._joints[a];Lt.lerp(o.lpos,s.lpos,l.lpos,n);Lt.lerp(o.lscale,s.lscale,l.lscale,n);Ut.slerp(o.lrot,s.lrot,l.lrot,n)}};Es.prototype.updateMatrices=function e(){var t=this;for(var r=0;r<this._joints.length;++r){t._joints[r].getWorldMatrix(t._matrices[r])}};Es.prototype.getWorldMatrix=function e(t){return this._matrices[t]};Es.prototype.clone=function e(){var t=new Es;t.setRoot(Dn.deepClone(this._root));return t};var Ss=function(e){function t(){e.call(this);this._nodes=null}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.instantiate=function e(){var t=Bs.createNodes(this._nodes);var r=new Es;r.setRoot(t[0]);return r};return t}(Ma);var Ms={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16};var As={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5124:Int32Array,5125:Uint32Array,5126:Float32Array};function Rs(e,t,r){var n=e.accessors[r];var i=e.bufferViews[n.bufferView];var a=Ms[n.type];var o=As[n.componentType];var s=new o(t,i.byteOffset+n.byteOffset,n.count*a);return s}function Ls(e){var t=new Array(e.length);for(var r=0;r<e.length;++r){var n=e[r];var i=new Tn(n.name);if(n.translation){Lt.set(i.lpos,n.translation[0],n.translation[1],n.translation[2])}if(n.rotation){Ut.set(i.lrot,n.rotation[0],n.rotation[1],n.rotation[2],n.rotation[3])}if(n.scale){Lt.set(i.lscale,n.scale[0],n.scale[1],n.scale[2])}t[r]=i}for(var a=0;a<e.length;++a){var o=e[a];var s=t[a];if(o.children){for(var l=0;l<o.children.length;++l){var u=o.children[l];s.append(t[u])}}}return t}function Cs(e,t){var r=new Array(t.length);for(var n=0;n<t.length;++n){var i=t[n];var a=e.createEntity(i.name);if(i.translation){Lt.set(a.lpos,i.translation[0],i.translation[1],i.translation[2])}if(i.rotation){Ut.set(a.lrot,i.rotation[0],i.rotation[1],i.rotation[2],i.rotation[3])}if(i.scale){Lt.set(a.lscale,i.scale[0],i.scale[1],i.scale[2])}r[n]=a}for(var o=0;o<t.length;++o){var s=t[o];var l=r[o];if(s.children){for(var u=0;u<s.children.length;++u){var h=s.children[u];l.append(r[h])}}}return r}function Is(e,t,r,n){if(n>=t.meshes.length){return null}var i=t.meshes[n];var a=t.accessors;var o=i.primitives[0].attributes;var s=null;var l=new Ra;l._name=i.name;l._subMeshes=new Array(i.primitives.length);var u=[];var h=0;if(o.POSITION!==undefined){var c=a[o.POSITION];u.push({name:Me.ATTR_POSITION,type:c.componentType,num:Ms[c.type]});h=c.count;s=t.bufferViews[c.bufferView];l._minPos=Lt.new(c.min[0],c.min[1],c.min[2]);l._maxPos=Lt.new(c.max[0],c.max[1],c.max[2])}if(o.NORMAL!==undefined){var f=a[o.NORMAL];u.push({name:Me.ATTR_NORMAL,type:f.componentType,num:Ms[f.type]})}if(o.TANGENT!==undefined){var p=a[o.TANGENT];u.push({name:Me.ATTR_TANGENT,type:p.componentType,num:Ms[p.type]})}if(o.COLOR_0!==undefined){var d=a[o.COLOR_0];u.push({name:Me.ATTR_COLOR0,type:d.componentType,num:Ms[d.type]})}if(o.TEXCOORD_0!==undefined){var v=a[o.TEXCOORD_0];u.push({name:Me.ATTR_UV0,type:v.componentType,num:Ms[v.type]})}if(o.TEXCOORD_1!==undefined){var m=a[o.TEXCOORD_1];u.push({name:Me.ATTR_UV1,type:m.componentType,num:Ms[m.type]})}if(o.TEXCOORD_2!==undefined){var _=a[o.TEXCOORD_2];u.push({name:Me.ATTR_UV2,type:_.componentType,num:Ms[_.type]})}if(o.TEXCOORD_3!==undefined){var g=a[o.TEXCOORD_3];u.push({name:Me.ATTR_UV3,type:g.componentType,num:Ms[g.type]})}if(o.JOINTS_0!==undefined){var y=a[o.JOINTS_0];u.push({name:Me.ATTR_JOINTS,type:y.componentType,num:Ms[y.type]})}if(o.WEIGHTS_0!==undefined){var x=a[o.WEIGHTS_0];u.push({name:Me.ATTR_WEIGHTS,type:x.componentType,num:Ms[x.type]})}var b=new Uint8Array(r,s.byteOffset,s.byteLength);var w=new Me.VertexBuffer(e.device,new Me.VertexFormat(u),Me.USAGE_STATIC,b,h);for(var T=0;T<i.primitives.length;++T){var E=i.primitives[T];var S=null;if(E.indices!==undefined){var M=a[E.indices];var A=t.bufferViews[M.bufferView];var R=new Uint8Array(r,A.byteOffset,A.byteLength);S=new Me.IndexBuffer(e.device,M.componentType,Me.USAGE_STATIC,R,M.count)}l._subMeshes[T]=new Ui.InputAssembler(w,S)}if(t.skins){for(var L=0;L<t.skins.length;++L){if(t.skins[L].name===i.name){l._skinning=Us(t,r,L)}}}return l}function Us(e,t,r){if(r>=e.skins.length){return null}var n=e.skins[r];var i=e.accessors[n.inverseBindMatrices];var a=e.bufferViews[i.bufferView];var o=new Float32Array(t,a.byteOffset+i.byteOffset,i.count*16);var s=new Array(i.count);for(var l=0;l<i.count;++l){s[l]=Bt.new(o[16*l+0],o[16*l+1],o[16*l+2],o[16*l+3],o[16*l+4],o[16*l+5],o[16*l+6],o[16*l+7],o[16*l+8],o[16*l+9],o[16*l+10],o[16*l+11],o[16*l+12],o[16*l+13],o[16*l+14],o[16*l+15])}return{jointIndices:n.joints,bindposes:s}}function Ds(e,t,r){if(r>=e.animations.length){return null}var n=e.animations[r];var i=[];var a=-1;for(var o=0;o<n.channels.length;++o){var s=n.channels[o];var l=e.accessors[s.input];var u=void 0;for(var h=0;h<i.length;++h){if(i[h].name===l.name){u=i[h];break}}if(!u){var c=Rs(e,t,s.input);var f=new Array(c.length);for(var p=0;p<c.length;++p){var d=c[p];f[p]=d;if(a<d){a=d}}u={name:l.name,times:f,joints:[]};i.push(u)}var v=void 0;for(var m=0;m<u.joints.length;++m){if(u.joints[m].id===s.node){v=u.joints[m];break}}if(!v){v={id:s.node};u.joints.push(v)}var _=Rs(e,t,s.output);if(s.path==="translation"){var g=_.length/3;v.translations=new Array(g);for(var y=0;y<g;++y){v.translations[y]=Lt.new(_[3*y+0],_[3*y+1],_[3*y+2])}}else if(s.path==="rotation"){var x=_.length/4;v.rotations=new Array(x);for(var b=0;b<x;++b){v.rotations[b]=Ut.new(_[4*b+0],_[4*b+1],_[4*b+2],_[4*b+3])}}else if(s.path==="scale"){var w=_.length/3;v.scales=new Array(w);for(var T=0;T<w;++T){v.scales[T]=Lt.new(_[3*T+0],_[3*T+1],_[3*T+2])}}}var E=new Ts;E._name=n.name;E._framesList=i;E._length=a;return E}function Os(e){var t=new Ss;t._name=e.joints[0].name;t._nodes=e.joints;return t}var Bs={createArray:Rs,createNodes:Ls,createEntities:Cs,createMesh:Is,createSkinning:Us,createAnimationClip:Ds,createJoints:Os};function Ps(e,t,r){Ea({manifest:{mesh:{type:"text",parser:JSON.parse,src:t.mesh},bin:{type:"binary",src:t.bin}},onDone:function t(n){var i=n.mesh;var a=n.bin;if(!i.meshes.length){r(new Error("No mesh in the gltf."));return}var o=Bs.createMesh(e,i,a,0);r(null,o)}})}function Fs(e,t,r){Ea({manifest:{json:{type:"text",parser:JSON.parse,src:t.json}},onDone:function t(n){var i=n.json;var a=new us;var o=i.properties;if(i.type==="unlit"){a.effect=e.assets.get("builtin-effect-unlit");if(o.color){a.setProperty("color",Ft.new(o.color[0],o.color[1],o.color[2],o.color[3]))}if(o.mainTiling){a.setProperty("mainTiling",Rt.new(o.mainTiling[0],o.mainTiling[1]))}if(o.mainOffset){a.setProperty("mainOffset",Rt.new(o.mainOffset[0],o.mainOffset[1]))}var s=[];if(o.mainTexture){s.push(function(t){e.assets.load(o.mainTexture,function(e,r){a.setProperty("mainTexture",r);a.define("USE_TEXTURE",true);t()})})}za.parallel(s,function(e){if(e){console.error(e)}r(null,a)})}else if(i.type==="phong"){a.effect=e.assets.get("builtin-effect-phong");if(o.diffuseColor){a.setProperty("diffuseColor",Ft.new(o.diffuseColor[0],o.diffuseColor[1],o.diffuseColor[2],o.diffuseColor[3]))}if(o.mainTiling){a.setProperty("mainTiling",Rt.new(o.mainTiling[0],o.mainTiling[1]))}if(o.mainOffset){a.setProperty("mainOffset",Rt.new(o.mainOffset[0],o.mainOffset[1]))}a.define("USE_SPECULAR",o.USE_SPECULAR);if(o.specularColor){a.setProperty("specularColor",Ft.new(o.specularColor[0],o.specularColor[1],o.specularColor[2],o.specularColor[3]))}a.define("USE_EMISSIVE",o.USE_EMISSIVE);if(o.emissiveColor){a.setProperty("emissiveColor",Pt.new(o.emissiveColor[0],o.emissiveColor[1],o.emissiveColor[2]))}if(o.glossiness){a.setProperty("glossiness",o.glossiness)}var l=[];a.define("USE_DIFFUSE_TEXTURE",o.USE_DIFFUSE_TEXTURE);if(o.diffuse_texture){l.push(function(t){e.assets.load(o.diffuse_texture,function(e,r){a.setProperty("diffuse_texture",r);t()})})}a.define("USE_SPECULAR_TEXTURE",o.USE_SPECULAR_TEXTURE);if(o.specular_texture){l.push(function(t){e.assets.load(o.specular_texture,function(e,r){a.setProperty("specular_texture",r);t()})})}a.define("USE_EMISSIVE_TEXTURE",o.USE_EMISSIVE_TEXTURE);if(o.emissive_texture){l.push(function(t){e.assets.load(o.emissive_texture,function(e,r){a.setProperty("emissive_texture",r);t()})})}a.define("USE_NORMAL_TEXTURE",o.USE_NORMAL_TEXTURE);if(o.normal_texture){l.push(function(t){e.assets.load(o.normal_texture,function(e,r){a.setProperty("normal_texture",r);t()})})}za.parallel(l,function(e){if(e){console.error(e)}r(null,a)})}else if(i.type==="grid"){a.effect=e.assets.get("builtin-effect-grid");a.define("USE_WORLD_POS",o.useWorldPos);a.setProperty("tiling",Rt.new(o.tilingX,o.tilingY));a.setProperty("baseColorBlack",Ft.new(o.baseColorBlack[0],o.baseColorBlack[1],o.baseColorBlack[2],o.baseColorBlack[3]));a.setProperty("baseColorWhite",Ft.new(o.baseColorWhite[0],o.baseColorWhite[1],o.baseColorWhite[2],o.baseColorWhite[3]));a.setProperty("subPatternColor",Ft.new(o.subPatternColor[0],o.subPatternColor[1],o.subPatternColor[2],o.subPatternColor[3]));a.setProperty("subPatternColor2",Ft.new(o.subPatternColor2[0],o.subPatternColor2[1],o.subPatternColor2[2],o.subPatternColor2[3]));a.setProperty("basePatternTiling",Rt.new(o.basePatternTiling[0],o.basePatternTiling[1]));a.setProperty("basePatternOffset",Rt.new(o.basePatternOffset[0],o.basePatternOffset[1]));a.setProperty("subPatternTiling",Rt.new(o.subPatternTiling[0],o.subPatternTiling[1]));a.setProperty("subPatternOffset",Rt.new(o.subPatternOffset[0],o.subPatternOffset[1]));a.setProperty("subPattern2Tiling",Rt.new(o.subPattern2Tiling[0],o.subPattern2Tiling[1]));a.setProperty("subPattern2Offset",Rt.new(o.subPattern2Offset[0],o.subPattern2Offset[1]));e.assets.load("black-texture",function(e,t){a.setProperty("basePattern",t);a.setProperty("subPattern",t);a.setProperty("subPattern2",t)});var u=[];if(o.basePattern){u.push(function(t){e.assets.load(o.basePattern,function(e,r){a.setProperty("basePattern",r);t()})})}if(o.subPattern){u.push(function(t){e.assets.load(o.subPattern,function(e,r){a.setProperty("subPattern",r);t()})})}if(o.subPattern2){u.push(function(t){e.assets.load(o.subPattern2,function(e,r){a.setProperty("subPattern2",r);t()})})}za.parallel(u,function(e){if(e){console.error(e)}r(null,a)})}else if(i.type==="matcap"){a.effect=e.assets.get("builtin-effect-matcap");if(o.colorFactor){a.setProperty("colorFactor",o.colorFactor)}if(o.color){a.setProperty("color",Ft.new(o.color[0],o.color[1],o.color[2],o.color[3]))}var h=[];if(o.mainTex){h.push(function(t){e.assets.load(o.mainTex,function(e,r){a.setProperty("mainTex",r);a.define("USE_MAIN_TEX",true);t()})})}if(o.matcapTex){h.push(function(t){e.assets.load(o.matcapTex,function(e,r){a.setProperty("matcapTex",r);t()})})}za.parallel(h,function(e){if(e){console.error(e)}r(null,a)})}else if(i.type==="pbr"){a.effect=e.assets.get("builtin-effect-pbr");a.setProperty("albedo",Ft.new(o.albedo[0],o.albedo[1],o.albedo[2],o.albedo[3]));if(o.mainTiling){a.setProperty("mainTiling",Rt.new(o.mainTiling[0],o.mainTiling[1]))}if(o.mainOffset){a.setProperty("mainOffset",Rt.new(o.mainOffset[0],o.mainOffset[1]))}if(o.metallic){a.setProperty("metallic",o.metallic)}if(o.roughness){a.setProperty("roughness",o.roughness)}if(o.ao){a.setProperty("ao",o.ao)}a.define("USE_EMISSIVE",o.USE_EMISSIVE);if(o.emissive){a.setProperty("emissive",Pt.new(o.emissive[0],o.emissive[1],o.emissive[2]))}var c=[];a.define("USE_ALBEDO_TEXTURE",o.USE_ALBEDO_TEXTURE);if(o.albedo_texture){c.push(function(t){e.assets.load(o.albedo_texture,function(e,r){a.setProperty("albedo_texture",r);t()})})}a.define("USE_METALLIC_TEXTURE",o.USE_METALLIC_TEXTURE);if(o.metallic_texture){c.push(function(t){e.assets.load(o.metallic_texture,function(e,r){a.setProperty("metallic_texture",r);t()})})}a.define("USE_ROUGHNESS_TEXTURE",o.USE_ROUGHNESS_TEXTURE);if(o.roughness_texture){c.push(function(t){e.assets.load(o.roughness_texture,function(e,r){a.setProperty("roughness_texture",r);t()})})}a.define("USE_NORMAL_TEXTURE",o.USE_NORMAL_TEXTURE);if(o.normal_texture){c.push(function(t){e.assets.load(o.normal_texture,function(e,r){a.setProperty("normal_texture",r);t()})})}a.define("USE_AO_TEXTURE",o.USE_AO_TEXTURE);if(o.ao_texture){c.push(function(t){e.assets.load(o.ao_texture,function(e,r){a.setProperty("ao_texture",r);t()})})}a.define("USE_EMISSIVE_TEXTURE",o.USE_EMISSIVE_TEXTURE);if(o.emissive_texture){c.push(function(t){e.assets.load(o.emissive_texture,function(e,r){a.setProperty("emissive_texture",r);t()})})}za.parallel(c,function(e){if(e){console.error(e)}r(null,a)})}else if(i.type.startsWith("particle")){a.effect=e.assets.get("builtin-effect-"+i.type);if(o.tintColor){a.setProperty("tintColor",Ft.new(o.tintColor[0],o.tintColor[1],o.tintColor[2],o.tintColor[3]))}if(o.mainTiling){a.setProperty("mainTiling",Rt.new(o.mainTiling[0],o.mainTiling[1]))}if(o.mainOffset){a.setProperty("mainOffset",Rt.new(o.mainOffset[0],o.mainOffset[1]))}var f=[];if(o.mainTexture){f.push(function(t){e.assets.load(o.mainTexture,function(e,r){a.setProperty("mainTexture",r);t()})})}za.parallel(f,function(e){if(e){console.error(e)}r(null,a)})}else{console.error("unsupported material loading")}}})}var zs=function(e){function t(t){e.call(this,t);this._sprites={}}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;var r={sprites:{configurable:true}};r.sprites.get=function(){return this._sprites};t.prototype.unload=function t(){var r=this;if(!this._loaded){return}for(var n in r._sprites){r._sprites[n].unload()}e.prototype.unload.call(this)};t.prototype.subAsset=function e(t){var r=this._sprites[t];return r||null};Object.defineProperties(t.prototype,r);return t}(Pa);function Ns(e,t,r){var n=new Pa(e);if(r){n.mipmap=r.mipmap;n.anisotropy=r.anisotropy;n.minFilter=r.minFilter;n.magFilter=r.magFilter;n.mipFilter=r.mipFilter;n.wrapS=r.wrapS;n.wrapT=r.wrapT}n.setImages(t);n.commit();return n}function ks(e,t,r){var n=new fs(e);if(r){n.mipmap=r.mipmap;n.anisotropy=r.anisotropy;n.minFilter=r.minFilter;n.magFilter=r.magFilter;n.mipFilter=r.mipFilter;n.wrapS=r.wrapS;n.wrapT=r.wrapT}n.setImages(t);n.commit();return n}function Vs(e,t,r){var n=new zs(e);if(r){n.mipmap=r.mipmap;n.anisotropy=r.anisotropy;n.minFilter=r.minFilter;n.magFilter=r.magFilter;n.mipFilter=r.mipFilter;n.wrapS=r.wrapS;n.wrapT=r.wrapT}n.setImages(t);n.commit();if(r&&r.sprites){for(var i in r.sprites){var a=r.sprites[i];var o=new gs;o._name=i;o._rotated=a.rotated;o._x=a.x;o._y=a.y;o._width=a.width;o._height=a.height;o._left=a.left||0;o._right=a.right||0;o._top=a.top||0;o._bottom=a.bottom||0;o._texture=n;o.commit();n._sprites[i]=o}}return n}function Gs(e,t,r){var n={};var i=0;for(var a in t){if(a.indexOf("image")===0){var o=parseInt(a.split("@")[1]);if(o>i){i=o}n[a]={type:"image",src:t[a]}}}i+=1;if(t.json){n.json={type:"text",parser:JSON.parse,src:t.json}}Ea({manifest:n,onDone:function t(n){var a=n.json;var o=[];var s;var l=a?a.type:"2d";if(l==="2d"||l==="sprite"){for(var u=0;u<i;++u){if(u===0){o.push(n.image)}else{o.push(n["image@"+u])}}if(l==="2d"){s=Ns(e.device,o,a)}else if(l==="sprite"){s=Vs(e.device,o,a)}}else if(l==="cube"){for(var h=0;h<i;++h){if(h===0){o.push([n.imagePosX,n.imageNegX,n.imagePosY,n.imageNegY,n.imagePosZ,n.imageNegZ])}else{o.push([n["imagePosX@"+h],n["imageNegX@"+h],n["imagePosY@"+h],n["imageNegY@"+h],n["imagePosZ@"+h],n["imageNegZ@"+h]])}}s=ks(e.device,o,a)}r(null,s)}})}var Ws=function(e){function t(){e.call(this);this._app=null;this._json=null;this._assets=null}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.unload=function t(){if(!this._loaded){return}e.prototype.unload.call(this)};t.prototype.instantiate=function e(t,r){if(r===void 0)r=null;return ja.createPrefab(this._app,this._json,t,r)};return t}(Ma);function Hs(e,t,r){Ea({manifest:{json:{type:"text",parser:JSON.parse,src:t.json}},onDone:function t(n){ja.preloadAssets(e,n.json,function(t,i){var a=new Ws;a._app=e;a._json=n.json;a._assets=i;if(t){r(t);return}r(null,a)})}})}var js=function(e){function t(){e.call(this);this._nodes=null;this._meshes=null;this._joints=null}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.subAsset=function e(t){var r=parseInt(t.substring(1));if(t[0]==="m"){return this._meshes[r]}if(t==="joints"){return this._joints}return null};return t}(Ma);function qs(e,t,r){Ea({manifest:{gltf:{type:"text",parser:JSON.parse,src:t.gltf},bin:{type:"binary",src:t.bin}},onDone:function t(n){var i=n.gltf;var a=n.bin;var o=new js;o._nodes=i.nodes;if(i.meshes){o._meshes=new Array(i.meshes.length);for(var s=0;s<i.meshes.length;++s){o._meshes[s]=Bs.createMesh(e,i,a,s)}}if(i.joints){o._joints=Bs.createJoints(i)}r(null,o)}})}function Xs(e,t,r){Ea({manifest:{anim:{type:"text",parser:JSON.parse,src:t.anim},bin:{type:"binary",src:t.bin}},onDone:function e(t){var n=t.anim;var i=t.bin;if(!n.animations.length){r(new Error("No animation in the gltf."));return}var a=Bs.createAnimationClip(n,i,0);r(null,a)}})}var Ys={WEB_AUDIO:0,DOM_AUDIO:1};var Ks=function(e){function t(){e.call(this);this.__initEventEmitter();this._audio=null;this.loadMode=Ys.WEB_AUDIO}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;var r={nativeAsset:{configurable:true}};r.nativeAsset.get=function(){return this._audio};r.nativeAsset.set=function(e){this._audio=e;if(e){this._loaded=true}};Object.defineProperties(t.prototype,r);return t}(Ma);qi.mixin(Ks);Object.assign(Ks,Ys);var Zs=null;function Qs(e,t,r){Zs=e.system("audio");if(Zs.__audioSupport.format.length===0){return new Error("no audio file format available.")}var n=Zs.getIDByURL(t.bin);if(n){Zs._getClipByID(n).once("load",function(){r(null,Zs._getClipByID(n))});return}var i=null;if(!Zs.__audioSupport.WEB_AUDIO){i=Js}else{i=$s}t.url=t.bin;i(t,r)}function Js(e,t){var r=document.createElement("audio");r.src=e.url;var n=function(){clearTimeout(i);r.removeEventListener("canplaythrough",o,false);r.removeEventListener("error",s,false);if(Zs.__audioSupport.USE_LOADER_EVENT){r.removeEventListener(Zs.__audioSupport.USE_LOADER_EVENT,o,false)}};var i=setTimeout(function(){if(r.readyState===0){s()}else{o()}},8e3);var a=new Ks;a.url=e.url;Zs.addClip(e.url,a);var o=function(){n();a.nativeAsset=r;a.loadMode=Ks.DOM_AUDIO;a.emit("load");t(null,a)};var s=function(){n();var r="load audio failure - "+e.url;console.log(r);Zs.removeClip(e.url);t(r)};r.addEventListener("canplaythrough",o,false);r.addEventListener("error",s,false);if(Zs.__audioSupport.USE_LOADER_EVENT){r.addEventListener(Zs.__audioSupport.USE_LOADER_EVENT,o,false)}}function $s(e,t){if(!Zs.__audioSupport.context){t(new Error("audio context not found."))}var r=el();r.open("GET",e.url,true);r.responseType="arraybuffer";var n=new Ks;n.url=e.url;Zs.addClip(e.url,n);r.onload=function(){Zs.__audioSupport.context["decodeAudioData"](r.response,function(e){n.nativeAsset=e;n.emit("load");t(null,n)},function(){Zs.removeClip(e.url);t("decode error",null)})};r.onerror=function(){Zs.removeClip(e.url);t("request error",null)};r.send()}function el(){return window.XMLHttpRequest?new window.XMLHttpRequest:new window.ActiveXObject("MSXML2.XMLHTTP")}var tl=function(e){function t(){e.call(this);this._size=32;this._type="unknow";this._glyphs={};this._lineHeight=32;this._useKerning=false}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;var r={size:{configurable:true},lineHeight:{configurable:true},type:{configurable:true}};r.size.get=function(){return this._size};r.lineHeight.get=function(){return this._lineHeight};r.type.get=function(){return this._type};Object.defineProperties(t.prototype,r);return t}(Ma);var rl=function(e){function t(){e.call(this);this._texture=null;this._face="";this._defaultGlyph={char:" ",x:0,y:0,width:16,height:16,xoffset:0,yoffset:0,xadvance:16,uvs:[Rt.new(0,0),Rt.new(0,0),Rt.new(0,0),Rt.new(0,0)]};this._type="bitmap"}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;var r={texture:{configurable:true},face:{configurable:true}};r.texture.get=function(){return this._texture};r.face.get=function(){return this._face};Object.defineProperties(t.prototype,r);return t}(tl);function nl(e,t,r){Ea({manifest:{json:{type:"text",parser:JSON.parse,src:t.json}},onDone:function t(n){var i=n.json;var a=new rl;e.assets.load(i.texture,function(e,t){if(e){console.error(e);r(e,null);return}var n=t._texture._width;var o=t._texture._height;a._texture=t;a._face=i.face;a._size=i.size;a._lineHeight=i.lineHeight;for(var s in i.chars){var l=i.chars[s];var u=l.x/n;var h=(l.x+l.width)/n;var c=1-(l.y+l.height)/o;var f=1-l.y/o;a._glyphs[s]={char:String.fromCharCode(s),x:l.x,y:l.y,width:l.width,height:l.height,xoffset:l.xoffset,yoffset:l.yoffset,xadvance:l.xadvance};a._glyphs[s].uvs=[Rt.new(u,c),Rt.new(h,c),Rt.new(u,f),Rt.new(h,f)]}r(null,a)})}})}var il=0;var al=-3;function ol(){this.table=new Uint16Array(16);this.trans=new Uint16Array(288)}function sl(e,t){this.source=e;this.sourceIndex=0;this.tag=0;this.bitcount=0;this.dest=t;this.destLen=0;this.ltree=new ol;this.dtree=new ol}var ll=new ol;var ul=new ol;var hl=new Uint8Array(30);var cl=new Uint16Array(30);var fl=new Uint8Array(30);var pl=new Uint16Array(30);var dl=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]);var vl=new ol;var ml=new Uint8Array(288+32);function _l(e,t,r,n){var i,a;for(i=0;i<r;++i){e[i]=0}for(i=0;i<30-r;++i){e[i+r]=i/r|0}for(a=n,i=0;i<30;++i){t[i]=a;a+=1<<e[i]}}function gl(e,t){var r;for(r=0;r<7;++r){e.table[r]=0}e.table[7]=24;e.table[8]=152;e.table[9]=112;for(r=0;r<24;++r){e.trans[r]=256+r}for(r=0;r<144;++r){e.trans[24+r]=r}for(r=0;r<8;++r){e.trans[24+144+r]=280+r}for(r=0;r<112;++r){e.trans[24+144+8+r]=144+r}for(r=0;r<5;++r){t.table[r]=0}t.table[5]=32;for(r=0;r<32;++r){t.trans[r]=r}}var yl=new Uint16Array(16);function xl(e,t,r,n){var i,a;for(i=0;i<16;++i){e.table[i]=0}for(i=0;i<n;++i){e.table[t[r+i]]++}e.table[0]=0;for(a=0,i=0;i<16;++i){yl[i]=a;a+=e.table[i]}for(i=0;i<n;++i){if(t[r+i]){e.trans[yl[t[r+i]]++]=i}}}function bl(e){if(!e.bitcount--){e.tag=e.source[e.sourceIndex++];e.bitcount=7}var t=e.tag&1;e.tag>>>=1;return t}function wl(e,t,r){if(!t){return r}while(e.bitcount<24){e.tag|=e.source[e.sourceIndex++]<<e.bitcount;e.bitcount+=8}var n=e.tag&65535>>>16-t;e.tag>>>=t;e.bitcount-=t;return n+r}function Tl(e,t){while(e.bitcount<24){e.tag|=e.source[e.sourceIndex++]<<e.bitcount;e.bitcount+=8}var r=0,n=0,i=0;var a=e.tag;do{n=2*n+(a&1);a>>>=1;++i;r+=t.table[i];n-=t.table[i]}while(n>=0);e.tag=a;e.bitcount-=i;return t.trans[r+n]}function El(e,t,r){var n,i,a;var o,s,l;n=wl(e,5,257);i=wl(e,5,1);a=wl(e,4,4);for(o=0;o<19;++o){ml[o]=0}for(o=0;o<a;++o){var u=wl(e,3,0);ml[dl[o]]=u}xl(vl,ml,0,19);for(s=0;s<n+i;){var h=Tl(e,vl);switch(h){case 16:var c=ml[s-1];for(l=wl(e,2,3);l;--l){ml[s++]=c}break;case 17:for(l=wl(e,3,3);l;--l){ml[s++]=0}break;case 18:for(l=wl(e,7,11);l;--l){ml[s++]=0}break;default:ml[s++]=h;break}}xl(t,ml,0,n);xl(r,ml,n,i)}function Sl(e,t,r){while(1){var n=Tl(e,t);if(n===256){return il}if(n<256){e.dest[e.destLen++]=n}else{var i,a,o;var s;n-=257;i=wl(e,hl[n],cl[n]);a=Tl(e,r);o=e.destLen-wl(e,fl[a],pl[a]);for(s=o;s<o+i;++s){e.dest[e.destLen++]=e.dest[s]}}}}function Ml(e){var t,r;var n;while(e.bitcount>8){e.sourceIndex--;e.bitcount-=8}t=e.source[e.sourceIndex+1];t=256*t+e.source[e.sourceIndex];r=e.source[e.sourceIndex+3];r=256*r+e.source[e.sourceIndex+2];if(t!==(~r&65535)){return al}e.sourceIndex+=4;for(n=t;n;--n){e.dest[e.destLen++]=e.source[e.sourceIndex++]}e.bitcount=0;return il}function Al(e,t){var r=new sl(e,t);var n,i,a;do{n=bl(r);i=wl(r,2,0);switch(i){case 0:a=Ml(r);break;case 1:a=Sl(r,ll,ul);break;case 2:El(r,r.ltree,r.dtree);a=Sl(r,r.ltree,r.dtree);break;default:a=al}if(a!==il){throw new Error("Data error")}}while(!n);if(r.destLen<r.dest.length){if(typeof r.dest.slice==="function"){return r.dest.slice(0,r.destLen)}else{return r.dest.subarray(0,r.destLen)}}return r.dest}gl(ll,ul);_l(hl,cl,4,3);_l(fl,pl,2,1);hl[28]=0;cl[28]=258;var Rl=Al;function Ll(e,t,r,n,i){return Math.pow(1-i,3)*e+3*Math.pow(1-i,2)*i*t+3*(1-i)*Math.pow(i,2)*r+Math.pow(i,3)*n}function Cl(){this.x1=Number.NaN;this.y1=Number.NaN;this.x2=Number.NaN;this.y2=Number.NaN}Cl.prototype.isEmpty=function(){return isNaN(this.x1)||isNaN(this.y1)||isNaN(this.x2)||isNaN(this.y2)};Cl.prototype.addPoint=function(e,t){if(typeof e==="number"){if(isNaN(this.x1)||isNaN(this.x2)){this.x1=e;this.x2=e}if(e<this.x1){this.x1=e}if(e>this.x2){this.x2=e}}if(typeof t==="number"){if(isNaN(this.y1)||isNaN(this.y2)){this.y1=t;this.y2=t}if(t<this.y1){this.y1=t}if(t>this.y2){this.y2=t}}};Cl.prototype.addX=function(e){this.addPoint(e,null)};Cl.prototype.addY=function(e){this.addPoint(null,e)};Cl.prototype.addBezier=function(e,t,r,n,i,a,o,s){var l=this;var u=[e,t];var h=[r,n];var c=[i,a];var f=[o,s];this.addPoint(e,t);this.addPoint(o,s);for(var p=0;p<=1;p++){var d=6*u[p]-12*h[p]+6*c[p];var v=-3*u[p]+9*h[p]-9*c[p]+3*f[p];var m=3*h[p]-3*u[p];if(v===0){if(d===0){continue}var _=-m/d;if(0<_&&_<1){if(p===0){l.addX(Ll(u[p],h[p],c[p],f[p],_))}if(p===1){l.addY(Ll(u[p],h[p],c[p],f[p],_))}}continue}var g=Math.pow(d,2)-4*m*v;if(g<0){continue}var y=(-d+Math.sqrt(g))/(2*v);if(0<y&&y<1){if(p===0){l.addX(Ll(u[p],h[p],c[p],f[p],y))}if(p===1){l.addY(Ll(u[p],h[p],c[p],f[p],y))}}var x=(-d-Math.sqrt(g))/(2*v);if(0<x&&x<1){if(p===0){l.addX(Ll(u[p],h[p],c[p],f[p],x))}if(p===1){l.addY(Ll(u[p],h[p],c[p],f[p],x))}}}};Cl.prototype.addQuad=function(e,t,r,n,i,a){var o=e+2/3*(r-e);var s=t+2/3*(n-t);var l=o+1/3*(i-e);var u=s+1/3*(a-t);this.addBezier(e,t,o,s,l,u,i,a)};function Il(){this.commands=[];this.fill="black";this.stroke=null;this.strokeWidth=1}Il.prototype.moveTo=function(e,t){this.commands.push({type:"M",x:e,y:t})};Il.prototype.lineTo=function(e,t){this.commands.push({type:"L",x:e,y:t})};Il.prototype.curveTo=Il.prototype.bezierCurveTo=function(e,t,r,n,i,a){this.commands.push({type:"C",x1:e,y1:t,x2:r,y2:n,x:i,y:a})};Il.prototype.quadTo=Il.prototype.quadraticCurveTo=function(e,t,r,n){this.commands.push({type:"Q",x1:e,y1:t,x:r,y:n})};Il.prototype.close=Il.prototype.closePath=function(){this.commands.push({type:"Z"})};Il.prototype.extend=function(e){if(e.commands){e=e.commands}else if(e instanceof Cl){var t=e;this.moveTo(t.x1,t.y1);this.lineTo(t.x2,t.y1);this.lineTo(t.x2,t.y2);this.lineTo(t.x1,t.y2);this.close();return}Array.prototype.push.apply(this.commands,e)};Il.prototype.getBoundingBox=function(){var e=this;var t=new Cl;var r=0;var n=0;var i=0;var a=0;for(var o=0;o<this.commands.length;o++){var s=e.commands[o];switch(s.type){case"M":t.addPoint(s.x,s.y);r=i=s.x;n=a=s.y;break;case"L":t.addPoint(s.x,s.y);i=s.x;a=s.y;break;case"Q":t.addQuad(i,a,s.x1,s.y1,s.x,s.y);i=s.x;a=s.y;break;case"C":t.addBezier(i,a,s.x1,s.y1,s.x2,s.y2,s.x,s.y);i=s.x;a=s.y;break;case"Z":i=r;a=n;break;default:throw new Error("Unexpected path command "+s.type)}}if(t.isEmpty()){t.addPoint(0,0)}return t};Il.prototype.draw=function(e){var t=this;e.beginPath();for(var r=0;r<this.commands.length;r+=1){var n=t.commands[r];if(n.type==="M"){e.moveTo(n.x,n.y)}else if(n.type==="L"){e.lineTo(n.x,n.y)}else if(n.type==="C"){e.bezierCurveTo(n.x1,n.y1,n.x2,n.y2,n.x,n.y)}else if(n.type==="Q"){e.quadraticCurveTo(n.x1,n.y1,n.x,n.y)}else if(n.type==="Z"){e.closePath()}}if(this.fill){e.fillStyle=this.fill;e.fill()}if(this.stroke){e.strokeStyle=this.stroke;e.lineWidth=this.strokeWidth;e.stroke()}};Il.prototype.toPathData=function(e){var t=this;e=e!==undefined?e:2;function r(t){if(Math.round(t)===t){return""+Math.round(t)}else{return t.toFixed(e)}}function n(){var e=arguments;var t="";for(var n=0;n<arguments.length;n+=1){var i=e[n];if(i>=0&&n>0){t+=" "}t+=r(i)}return t}var i="";for(var a=0;a<this.commands.length;a+=1){var o=t.commands[a];if(o.type==="M"){i+="M"+n(o.x,o.y)}else if(o.type==="L"){i+="L"+n(o.x,o.y)}else if(o.type==="C"){i+="C"+n(o.x1,o.y1,o.x2,o.y2,o.x,o.y)}else if(o.type==="Q"){i+="Q"+n(o.x1,o.y1,o.x,o.y)}else if(o.type==="Z"){i+="Z"}}return i};Il.prototype.toSVG=function(e){var t='<path d="';t+=this.toPathData(e);t+='"';if(this.fill&&this.fill!=="black"){if(this.fill===null){t+=' fill="none"'}else{t+=' fill="'+this.fill+'"'}}if(this.stroke){t+=' stroke="'+this.stroke+'" stroke-width="'+this.strokeWidth+'"'}t+="/>";return t};Il.prototype.toDOMElement=function(e){var t=this.toPathData(e);var r=document.createElementNS("http://www.w3.org/2000/svg","path");r.setAttribute("d",t);return r};function Ul(e){throw new Error(e)}function Dl(e,t){if(!e){Ul(t)}}var Ol={fail:Ul,argument:Dl,assert:Dl};var Bl=32768;var Pl=2147483648;var Fl={};var zl={};var Nl={};function kl(e){return function(){return e}}zl.BYTE=function(e){Ol.argument(e>=0&&e<=255,"Byte value should be between 0 and 255.");return[e]};Nl.BYTE=kl(1);zl.CHAR=function(e){return[e.charCodeAt(0)]};Nl.CHAR=kl(1);zl.CHARARRAY=function(e){var t=[];for(var r=0;r<e.length;r+=1){t[r]=e.charCodeAt(r)}return t};Nl.CHARARRAY=function(e){return e.length};zl.USHORT=function(e){return[e>>8&255,e&255]};Nl.USHORT=kl(2);zl.SHORT=function(e){if(e>=Bl){e=-(2*Bl-e)}return[e>>8&255,e&255]};Nl.SHORT=kl(2);zl.UINT24=function(e){return[e>>16&255,e>>8&255,e&255]};Nl.UINT24=kl(3);zl.ULONG=function(e){return[e>>24&255,e>>16&255,e>>8&255,e&255]};Nl.ULONG=kl(4);zl.LONG=function(e){if(e>=Pl){e=-(2*Pl-e)}return[e>>24&255,e>>16&255,e>>8&255,e&255]};Nl.LONG=kl(4);zl.FIXED=zl.ULONG;Nl.FIXED=Nl.ULONG;zl.FWORD=zl.SHORT;Nl.FWORD=Nl.SHORT;zl.UFWORD=zl.USHORT;Nl.UFWORD=Nl.USHORT;zl.LONGDATETIME=function(e){return[0,0,0,0,e>>24&255,e>>16&255,e>>8&255,e&255]};Nl.LONGDATETIME=kl(8);zl.TAG=function(e){Ol.argument(e.length===4,"Tag should be exactly 4 ASCII characters.");return[e.charCodeAt(0),e.charCodeAt(1),e.charCodeAt(2),e.charCodeAt(3)]};Nl.TAG=kl(4);zl.Card8=zl.BYTE;Nl.Card8=Nl.BYTE;zl.Card16=zl.USHORT;Nl.Card16=Nl.USHORT;zl.OffSize=zl.BYTE;Nl.OffSize=Nl.BYTE;zl.SID=zl.USHORT;Nl.SID=Nl.USHORT;zl.NUMBER=function(e){if(e>=-107&&e<=107){return[e+139]}else if(e>=108&&e<=1131){e=e-108;return[(e>>8)+247,e&255]}else if(e>=-1131&&e<=-108){e=-e-108;return[(e>>8)+251,e&255]}else if(e>=-32768&&e<=32767){return zl.NUMBER16(e)}else{return zl.NUMBER32(e)}};Nl.NUMBER=function(e){return zl.NUMBER(e).length};zl.NUMBER16=function(e){return[28,e>>8&255,e&255]};Nl.NUMBER16=kl(3);zl.NUMBER32=function(e){return[29,e>>24&255,e>>16&255,e>>8&255,e&255]};Nl.NUMBER32=kl(5);zl.REAL=function(e){var t=e.toString();var r=/\.(\d*?)(?:9{5,20}|0{5,20})\d{0,2}(?:e(.+)|$)/.exec(t);if(r){var n=parseFloat("1e"+((r[2]?+r[2]:0)+r[1].length));t=(Math.round(e*n)/n).toString()}var i="";for(var a=0,o=t.length;a<o;a+=1){var s=t[a];if(s==="e"){i+=t[++a]==="-"?"c":"b"}else if(s==="."){i+="a"}else if(s==="-"){i+="e"}else{i+=s}}i+=i.length&1?"f":"ff";var l=[30];for(var u=0,h=i.length;u<h;u+=2){l.push(parseInt(i.substr(u,2),16))}return l};Nl.REAL=function(e){return zl.REAL(e).length};zl.NAME=zl.CHARARRAY;Nl.NAME=Nl.CHARARRAY;zl.STRING=zl.CHARARRAY;Nl.STRING=Nl.CHARARRAY;Fl.UTF8=function(e,t,r){var n=[];var i=r;for(var a=0;a<i;a++,t+=1){n[a]=e.getUint8(t)}return String.fromCharCode.apply(null,n)};Fl.UTF16=function(e,t,r){var n=[];var i=r/2;for(var a=0;a<i;a++,t+=2){n[a]=e.getUint16(t)}return String.fromCharCode.apply(null,n)};zl.UTF16=function(e){var t=[];for(var r=0;r<e.length;r+=1){var n=e.charCodeAt(r);t[t.length]=n>>8&255;t[t.length]=n&255}return t};Nl.UTF16=function(e){return e.length*2};var Vl={"x-mac-croatian":"ÄÅÇÉÑÖÜáàâäãåçéèêëíìîïñóòôöõúùûü†°¢£§•¶ß®Š™´¨≠ŽØ∞±≤≥∆µ∂∑∏š∫ªºΩžø"+"¿¡¬√ƒ≈Ć«Č… ÀÃÕŒœĐ—“”‘’÷◊©⁄€‹›Æ»–·‚„‰ÂćÁčÈÍÎÏÌÓÔđÒÚÛÙıˆ˜¯πË˚¸Êæˇ","x-mac-cyrillic":"АБВГДЕЖЗИЙКЛМНОПРСТУФХЦЧШЩЪЫЬЭЮЯ†°Ґ£§•¶І®©™Ђђ≠Ѓѓ∞±≤≥іµґЈЄєЇїЉљЊњ"+"јЅ¬√ƒ≈∆«»… ЋћЌќѕ–—“”‘’÷„ЎўЏџ№Ёёяабвгдежзийклмнопрстуфхцчшщъыьэю","x-mac-gaelic":"ÄÅÇÉÑÖÜáàâäãåçéèêëíìîïñóòôöõúùûü†°¢£§•¶ß®©™´¨≠ÆØḂ±≤≥ḃĊċḊḋḞḟĠġṀæø"+"ṁṖṗɼƒſṠ«»… ÀÃÕŒœ–—“”‘’ṡẛÿŸṪ€‹›Ŷŷṫ·Ỳỳ⁊ÂÊÁËÈÍÎÏÌÓÔ♣ÒÚÛÙıÝýŴŵẄẅẀẁẂẃ","x-mac-greek":"Ä¹²É³ÖÜ΅àâä΄¨çéèêë£™îï•½‰ôö¦€ùûü†ΓΔΘΛΞΠß®©ΣΪ§≠°·Α±≤≥¥ΒΕΖΗΙΚΜΦΫΨΩ"+"άΝ¬ΟΡ≈Τ«»… ΥΧΆΈœ–―“”‘’÷ΉΊΌΎέήίόΏύαβψδεφγηιξκλμνοπώρστθωςχυζϊϋΐΰ­","x-mac-icelandic":"ÄÅÇÉÑÖÜáàâäãåçéèêëíìîïñóòôöõúùûüÝ°¢£§•¶ß®©™´¨≠ÆØ∞±≤≥¥µ∂∑∏π∫ªºΩæø"+"¿¡¬√ƒ≈∆«»… ÀÃÕŒœ–—“”‘’÷◊ÿŸ⁄€ÐðÞþý·‚„‰ÂÊÁËÈÍÎÏÌÓÔÒÚÛÙıˆ˜¯˘˙˚¸˝˛ˇ","x-mac-inuit":"ᐃᐄᐅᐆᐊᐋᐱᐲᐳᐴᐸᐹᑉᑎᑏᑐᑑᑕᑖᑦᑭᑮᑯᑰᑲᑳᒃᒋᒌᒍᒎᒐᒑ°ᒡᒥᒦ•¶ᒧ®©™ᒨᒪᒫᒻᓂᓃᓄᓅᓇᓈᓐᓯᓰᓱᓲᓴᓵᔅᓕᓖᓗ"+"ᓘᓚᓛᓪᔨᔩᔪᔫᔭ… ᔮᔾᕕᕖᕗ–—“”‘’ᕘᕙᕚᕝᕆᕇᕈᕉᕋᕌᕐᕿᖀᖁᖂᖃᖄᖅᖏᖐᖑᖒᖓᖔᖕᙱᙲᙳᙴᙵᙶᖖᖠᖡᖢᖣᖤᖥᖦᕼŁł","x-mac-ce":"ÄĀāÉĄÖÜáąČäčĆćéŹźĎíďĒēĖóėôöõúĚěü†°Ę£§•¶ß®©™ę¨≠ģĮįĪ≤≥īĶ∂∑łĻļĽľĹĺŅ"+"ņŃ¬√ńŇ∆«»… ňŐÕőŌ–—“”‘’÷◊ōŔŕŘ‹›řŖŗŠ‚„šŚśÁŤťÍŽžŪÓÔūŮÚůŰűŲųÝýķŻŁżĢˇ",macintosh:"ÄÅÇÉÑÖÜáàâäãåçéèêëíìîïñóòôöõúùûü†°¢£§•¶ß®©™´¨≠ÆØ∞±≤≥¥µ∂∑∏π∫ªºΩæø"+"¿¡¬√ƒ≈∆«»… ÀÃÕŒœ–—“”‘’÷◊ÿŸ⁄€‹›ﬁﬂ‡·‚„‰ÂÊÁËÈÍÎÏÌÓÔÒÚÛÙıˆ˜¯˘˙˚¸˝˛ˇ","x-mac-romanian":"ÄÅÇÉÑÖÜáàâäãåçéèêëíìîïñóòôöõúùûü†°¢£§•¶ß®©™´¨≠ĂȘ∞±≤≥¥µ∂∑∏π∫ªºΩăș"+"¿¡¬√ƒ≈∆«»… ÀÃÕŒœ–—“”‘’÷◊ÿŸ⁄€‹›Țț‡·‚„‰ÂÊÁËÈÍÎÏÌÓÔÒÚÛÙıˆ˜¯˘˙˚¸˝˛ˇ","x-mac-turkish":"ÄÅÇÉÑÖÜáàâäãåçéèêëíìîïñóòôöõúùûü†°¢£§•¶ß®©™´¨≠ÆØ∞±≤≥¥µ∂∑∏π∫ªºΩæø"+"¿¡¬√ƒ≈∆«»… ÀÃÕŒœ–—“”‘’÷◊ÿŸĞğİıŞş‡·‚„‰ÂÊÁËÈÍÎÏÌÓÔÒÚÛÙˆ˜¯˘˙˚¸˝˛ˇ"};Fl.MACSTRING=function(e,t,r,n){var i=Vl[n];if(i===undefined){return undefined}var a="";for(var o=0;o<r;o++){var s=e.getUint8(t+o);if(s<=127){a+=String.fromCharCode(s)}else{a+=i[s&127]}}return a};var Gl=typeof WeakMap==="function"&&new WeakMap;var Wl;var Hl=function(e){if(!Wl){Wl={};for(var t in Vl){Wl[t]=new String(t)}}var r=Wl[e];if(r===undefined){return undefined}if(Gl){var n=Gl.get(r);if(n!==undefined){return n}}var i=Vl[e];if(i===undefined){return undefined}var a={};for(var o=0;o<i.length;o++){a[i.charCodeAt(o)]=o+128}if(Gl){Gl.set(r,a)}return a};zl.MACSTRING=function(e,t){var r=Hl(t);if(r===undefined){return undefined}var n=[];for(var i=0;i<e.length;i++){var a=e.charCodeAt(i);if(a>=128){a=r[a];if(a===undefined){return undefined}}n[i]=a}return n};Nl.MACSTRING=function(e,t){var r=zl.MACSTRING(e,t);if(r!==undefined){return r.length}else{return 0}};function jl(e){return e>=-128&&e<=127}function ql(e,t,r){var n=0;var i=e.length;while(t<i&&n<64&&e[t]===0){++t;++n}r.push(128|n-1);return t}function Xl(e,t,r){var n=0;var i=e.length;var a=t;while(a<i&&n<64){var o=e[a];if(!jl(o)){break}if(o===0&&a+1<i&&e[a+1]===0){break}++a;++n}r.push(n-1);for(var s=t;s<a;++s){r.push(e[s]+256&255)}return a}function Yl(e,t,r){var n=0;var i=e.length;var a=t;while(a<i&&n<64){var o=e[a];if(o===0){break}if(jl(o)&&a+1<i&&jl(e[a+1])){break}++a;++n}r.push(64|n-1);for(var s=t;s<a;++s){var l=e[s];r.push(l+65536>>8&255,l+256&255)}return a}zl.VARDELTAS=function(e){var t=0;var r=[];while(t<e.length){var n=e[t];if(n===0){t=ql(e,t,r)}else if(n>=-128&&n<=127){t=Xl(e,t,r)}else{t=Yl(e,t,r)}}return r};zl.INDEX=function(e){var t=1;var r=[t];var n=[];for(var i=0;i<e.length;i+=1){var a=zl.OBJECT(e[i]);Array.prototype.push.apply(n,a);t+=a.length;r.push(t)}if(n.length===0){return[0,0]}var o=[];var s=1+Math.floor(Math.log(t)/Math.log(2))/8|0;var l=[undefined,zl.BYTE,zl.USHORT,zl.UINT24,zl.ULONG][s];for(var u=0;u<r.length;u+=1){var h=l(r[u]);Array.prototype.push.apply(o,h)}return Array.prototype.concat(zl.Card16(e.length),zl.OffSize(s),o,n)};Nl.INDEX=function(e){return zl.INDEX(e).length};zl.DICT=function(e){var t=[];var r=Object.keys(e);var n=r.length;for(var i=0;i<n;i+=1){var a=parseInt(r[i],0);var o=e[a];t=t.concat(zl.OPERAND(o.value,o.type));t=t.concat(zl.OPERATOR(a))}return t};Nl.DICT=function(e){return zl.DICT(e).length};zl.OPERATOR=function(e){if(e<1200){return[e]}else{return[12,e-1200]}};zl.OPERAND=function(e,t){var r=[];if(Array.isArray(t)){for(var n=0;n<t.length;n+=1){Ol.argument(e.length===t.length,"Not enough arguments given for type"+t);r=r.concat(zl.OPERAND(e[n],t[n]))}}else{if(t==="SID"){r=r.concat(zl.NUMBER(e))}else if(t==="offset"){r=r.concat(zl.NUMBER32(e))}else if(t==="number"){r=r.concat(zl.NUMBER(e))}else if(t==="real"){r=r.concat(zl.REAL(e))}else{throw new Error("Unknown operand type "+t)}}return r};zl.OP=zl.BYTE;Nl.OP=Nl.BYTE;var Kl=typeof WeakMap==="function"&&new WeakMap;zl.CHARSTRING=function(e){if(Kl){var t=Kl.get(e);if(t!==undefined){return t}}var r=[];var n=e.length;for(var i=0;i<n;i+=1){var a=e[i];r=r.concat(zl[a.type](a.value))}if(Kl){Kl.set(e,r)}return r};Nl.CHARSTRING=function(e){return zl.CHARSTRING(e).length};zl.OBJECT=function(e){var t=zl[e.type];Ol.argument(t!==undefined,"No encoding function for type "+e.type);return t(e.value)};Nl.OBJECT=function(e){var t=Nl[e.type];Ol.argument(t!==undefined,"No sizeOf function for type "+e.type);return t(e.value)};zl.TABLE=function(e){var t=[];var r=e.fields.length;var n=[];var i=[];for(var a=0;a<r;a+=1){var o=e.fields[a];var s=zl[o.type];Ol.argument(s!==undefined,"No encoding function for field type "+o.type+" ("+o.name+")");var l=e[o.name];if(l===undefined){l=o.value}var u=s(l);if(o.type==="TABLE"){i.push(t.length);t=t.concat([0,0]);n.push(u)}else{t=t.concat(u)}}for(var h=0;h<n.length;h+=1){var c=i[h];var f=t.length;Ol.argument(f<65536,"Table "+e.tableName+" too big.");t[c]=f>>8;t[c+1]=f&255;t=t.concat(n[h])}return t};Nl.TABLE=function(e){var t=0;var r=e.fields.length;for(var n=0;n<r;n+=1){var i=e.fields[n];var a=Nl[i.type];Ol.argument(a!==undefined,"No sizeOf function for field type "+i.type+" ("+i.name+")");var o=e[i.name];if(o===undefined){o=i.value}t+=a(o);if(i.type==="TABLE"){t+=2}}return t};zl.RECORD=zl.TABLE;Nl.RECORD=Nl.TABLE;zl.LITERAL=function(e){return e};Nl.LITERAL=function(e){return e.length};function Zl(e,t,r){var n=this;for(var i=0;i<t.length;i+=1){var a=t[i];n[a.name]=a.value}this.tableName=e;this.fields=t;if(r){var o=Object.keys(r);for(var s=0;s<o.length;s+=1){var l=o[s];var u=r[l];if(n[l]!==undefined){n[l]=u}}}}Zl.prototype.encode=function(){return zl.TABLE(this)};Zl.prototype.sizeOf=function(){return Nl.TABLE(this)};function Ql(e,t,r){if(r===undefined){r=t.length}var n=new Array(t.length+1);n[0]={name:e+"Count",type:"USHORT",value:r};for(var i=0;i<t.length;i++){n[i+1]={name:e+i,type:"USHORT",value:t[i]}}return n}function Jl(e,t,r){var n=t.length;var i=new Array(n+1);i[0]={name:e+"Count",type:"USHORT",value:n};for(var a=0;a<n;a++){i[a+1]={name:e+a,type:"TABLE",value:r(t[a],a)}}return i}function $l(e,t,r){var n=t.length;var i=[];i[0]={name:e+"Count",type:"USHORT",value:n};for(var a=0;a<n;a++){i=i.concat(r(t[a],a))}return i}function eu(e){if(e.format===1){Zl.call(this,"coverageTable",[{name:"coverageFormat",type:"USHORT",value:1}].concat(Ql("glyph",e.glyphs)))}else{Ol.assert(false,"Can't create coverage table format 2 yet.")}}eu.prototype=Object.create(Zl.prototype);eu.prototype.constructor=eu;function tu(e){Zl.call(this,"scriptListTable",$l("scriptRecord",e,function(e,t){var r=e.script;var n=r.defaultLangSys;Ol.assert(!!n,"Unable to write GSUB: script "+e.tag+" has no default language system.");return[{name:"scriptTag"+t,type:"TAG",value:e.tag},{name:"script"+t,type:"TABLE",value:new Zl("scriptTable",[{name:"defaultLangSys",type:"TABLE",value:new Zl("defaultLangSys",[{name:"lookupOrder",type:"USHORT",value:0},{name:"reqFeatureIndex",type:"USHORT",value:n.reqFeatureIndex}].concat(Ql("featureIndex",n.featureIndexes)))}].concat($l("langSys",r.langSysRecords,function(e,t){var r=e.langSys;return[{name:"langSysTag"+t,type:"TAG",value:e.tag},{name:"langSys"+t,type:"TABLE",value:new Zl("langSys",[{name:"lookupOrder",type:"USHORT",value:0},{name:"reqFeatureIndex",type:"USHORT",value:r.reqFeatureIndex}].concat(Ql("featureIndex",r.featureIndexes)))}]})))}]}))}tu.prototype=Object.create(Zl.prototype);tu.prototype.constructor=tu;function ru(e){Zl.call(this,"featureListTable",$l("featureRecord",e,function(e,t){var r=e.feature;return[{name:"featureTag"+t,type:"TAG",value:e.tag},{name:"feature"+t,type:"TABLE",value:new Zl("featureTable",[{name:"featureParams",type:"USHORT",value:r.featureParams}].concat(Ql("lookupListIndex",r.lookupListIndexes)))}]}))}ru.prototype=Object.create(Zl.prototype);ru.prototype.constructor=ru;function nu(e,t){Zl.call(this,"lookupListTable",Jl("lookup",e,function(e){var r=t[e.lookupType];Ol.assert(!!r,"Unable to write GSUB lookup type "+e.lookupType+" tables.");return new Zl("lookupTable",[{name:"lookupType",type:"USHORT",value:e.lookupType},{name:"lookupFlag",type:"USHORT",value:e.lookupFlag}].concat(Jl("subtable",e.subtables,r)))}))}nu.prototype=Object.create(Zl.prototype);nu.prototype.constructor=nu;var iu={Table:Zl,Record:Zl,Coverage:eu,ScriptList:tu,FeatureList:ru,LookupList:nu,ushortList:Ql,tableList:Jl,recordList:$l};function au(e,t){return e.getUint8(t)}function ou(e,t){return e.getUint16(t,false)}function su(e,t){return e.getInt16(t,false)}function lu(e,t){return e.getUint32(t,false)}function uu(e,t){var r=e.getInt16(t,false);var n=e.getUint16(t+2,false);return r+n/65535}function hu(e,t){var r="";for(var n=t;n<t+4;n+=1){r+=String.fromCharCode(e.getInt8(n))}return r}function cu(e,t,r){var n=0;for(var i=0;i<r;i+=1){n<<=8;n+=e.getUint8(t+i)}return n}function fu(e,t,r){var n=[];for(var i=t;i<r;i+=1){n.push(e.getUint8(i))}return n}function pu(e){var t="";for(var r=0;r<e.length;r+=1){t+=String.fromCharCode(e[r])}return t}var du={byte:1,uShort:2,short:2,uLong:4,fixed:4,longDateTime:8,tag:4};function vu(e,t){this.data=e;this.offset=t;this.relativeOffset=0}vu.prototype.parseByte=function(){var e=this.data.getUint8(this.offset+this.relativeOffset);this.relativeOffset+=1;return e};vu.prototype.parseChar=function(){var e=this.data.getInt8(this.offset+this.relativeOffset);this.relativeOffset+=1;return e};vu.prototype.parseCard8=vu.prototype.parseByte;vu.prototype.parseUShort=function(){var e=this.data.getUint16(this.offset+this.relativeOffset);this.relativeOffset+=2;return e};vu.prototype.parseCard16=vu.prototype.parseUShort;vu.prototype.parseSID=vu.prototype.parseUShort;vu.prototype.parseOffset16=vu.prototype.parseUShort;vu.prototype.parseShort=function(){var e=this.data.getInt16(this.offset+this.relativeOffset);this.relativeOffset+=2;return e};vu.prototype.parseF2Dot14=function(){var e=this.data.getInt16(this.offset+this.relativeOffset)/16384;this.relativeOffset+=2;return e};vu.prototype.parseULong=function(){var e=lu(this.data,this.offset+this.relativeOffset);this.relativeOffset+=4;return e};vu.prototype.parseFixed=function(){var e=uu(this.data,this.offset+this.relativeOffset);this.relativeOffset+=4;return e};vu.prototype.parseString=function(e){var t=this.data;var r=this.offset+this.relativeOffset;var n="";this.relativeOffset+=e;for(var i=0;i<e;i++){n+=String.fromCharCode(t.getUint8(r+i))}return n};vu.prototype.parseTag=function(){return this.parseString(4)};vu.prototype.parseLongDateTime=function(){var e=lu(this.data,this.offset+this.relativeOffset+4);e-=2082844800;this.relativeOffset+=8;return e};vu.prototype.parseVersion=function(){var e=ou(this.data,this.offset+this.relativeOffset);var t=ou(this.data,this.offset+this.relativeOffset+2);this.relativeOffset+=4;return e+t/4096/10};vu.prototype.skip=function(e,t){if(t===undefined){t=1}this.relativeOffset+=du[e]*t};vu.prototype.parseOffset16List=vu.prototype.parseUShortList=function(e){if(e===undefined){e=this.parseUShort()}var t=new Array(e);var r=this.data;var n=this.offset+this.relativeOffset;for(var i=0;i<e;i++){t[i]=r.getUint16(n);n+=2}this.relativeOffset+=e*2;return t};vu.prototype.parseShortList=function(e){var t=new Array(e);var r=this.data;var n=this.offset+this.relativeOffset;for(var i=0;i<e;i++){t[i]=r.getInt16(n);n+=2}this.relativeOffset+=e*2;return t};vu.prototype.parseByteList=function(e){var t=new Array(e);var r=this.data;var n=this.offset+this.relativeOffset;for(var i=0;i<e;i++){t[i]=r.getUint8(n++)}this.relativeOffset+=e;return t};vu.prototype.parseList=function(e,t){var r=this;if(!t){t=e;e=this.parseUShort()}var n=new Array(e);for(var i=0;i<e;i++){n[i]=t.call(r)}return n};vu.prototype.parseRecordList=function(e,t){var r=this;if(!t){t=e;e=this.parseUShort()}var n=new Array(e);var i=Object.keys(t);for(var a=0;a<e;a++){var o={};for(var s=0;s<i.length;s++){var l=i[s];var u=t[l];o[l]=u.call(r)}n[a]=o}return n};vu.prototype.parseStruct=function(e){var t=this;if(typeof e==="function"){return e.call(this)}else{var r=Object.keys(e);var n={};for(var i=0;i<r.length;i++){var a=r[i];var o=e[a];n[a]=o.call(t)}return n}};vu.prototype.parsePointer=function(e){var t=this.parseOffset16();if(t>0){return new vu(this.data,this.offset+t).parseStruct(e)}return undefined};vu.prototype.parseListOfLists=function(e){var t=this;var r=this.parseOffset16List();var n=r.length;var i=this.relativeOffset;var a=new Array(n);for(var o=0;o<n;o++){var s=r[o];if(s===0){a[o]=undefined;continue}t.relativeOffset=s;if(e){var l=t.parseOffset16List();var u=new Array(l.length);for(var h=0;h<l.length;h++){t.relativeOffset=s+l[h];u[h]=e.call(t)}a[o]=u}else{a[o]=t.parseUShortList()}}this.relativeOffset=i;return a};vu.prototype.parseCoverage=function(){var e=this;var t=this.offset+this.relativeOffset;var r=this.parseUShort();var n=this.parseUShort();if(r===1){return{format:1,glyphs:this.parseUShortList(n)}}else if(r===2){var i=new Array(n);for(var a=0;a<n;a++){i[a]={start:e.parseUShort(),end:e.parseUShort(),index:e.parseUShort()}}return{format:2,ranges:i}}throw new Error("0x"+t.toString(16)+": Coverage format must be 1 or 2.")};vu.prototype.parseClassDef=function(){var e=this.offset+this.relativeOffset;var t=this.parseUShort();if(t===1){return{format:1,startGlyph:this.parseUShort(),classes:this.parseUShortList()}}else if(t===2){return{format:2,ranges:this.parseRecordList({start:vu.uShort,end:vu.uShort,classId:vu.uShort})}}throw new Error("0x"+e.toString(16)+": ClassDef format must be 1 or 2.")};vu.list=function(e,t){return function(){return this.parseList(e,t)}};vu.recordList=function(e,t){return function(){return this.parseRecordList(e,t)}};vu.pointer=function(e){return function(){return this.parsePointer(e)}};vu.tag=vu.prototype.parseTag;vu.byte=vu.prototype.parseByte;vu.uShort=vu.offset16=vu.prototype.parseUShort;vu.uShortList=vu.prototype.parseUShortList;vu.struct=vu.prototype.parseStruct;vu.coverage=vu.prototype.parseCoverage;vu.classDef=vu.prototype.parseClassDef;var mu={reserved:vu.uShort,reqFeatureIndex:vu.uShort,featureIndexes:vu.uShortList};vu.prototype.parseScriptList=function(){return this.parsePointer(vu.recordList({tag:vu.tag,script:vu.pointer({defaultLangSys:vu.pointer(mu),langSysRecords:vu.recordList({tag:vu.tag,langSys:vu.pointer(mu)})})}))};vu.prototype.parseFeatureList=function(){return this.parsePointer(vu.recordList({tag:vu.tag,feature:vu.pointer({featureParams:vu.offset16,lookupListIndexes:vu.uShortList})}))};vu.prototype.parseLookupList=function(e){return this.parsePointer(vu.list(vu.pointer(function(){var t=this.parseUShort();Ol.argument(1<=t&&t<=8,"GSUB lookup type "+t+" unknown.");var r=this.parseUShort();var n=r&16;return{lookupType:t,lookupFlag:r,subtables:this.parseList(vu.pointer(e[t])),markFilteringSet:n?this.parseUShort():undefined}})))};var _u={getByte:au,getCard8:au,getUShort:ou,getCard16:ou,getShort:su,getULong:lu,getFixed:uu,getTag:hu,getOffset:cu,getBytes:fu,bytesToString:pu,Parser:vu};function gu(e,t){t.parseUShort();e.length=t.parseULong();e.language=t.parseULong();var r;e.groupCount=r=t.parseULong();e.glyphIndexMap={};for(var n=0;n<r;n+=1){var i=t.parseULong();var a=t.parseULong();var o=t.parseULong();for(var s=i;s<=a;s+=1){e.glyphIndexMap[s]=o;o++}}}function yu(e,t,r,n,i){e.length=t.parseUShort();e.language=t.parseUShort();var a;e.segCount=a=t.parseUShort()>>1;t.skip("uShort",3);e.glyphIndexMap={};var o=new _u.Parser(r,n+i+14);var s=new _u.Parser(r,n+i+16+a*2);var l=new _u.Parser(r,n+i+16+a*4);var u=new _u.Parser(r,n+i+16+a*6);var h=n+i+16+a*8;for(var c=0;c<a-1;c+=1){var f=void 0;var p=o.parseUShort();var d=s.parseUShort();var v=l.parseShort();var m=u.parseUShort();for(var _=d;_<=p;_+=1){if(m!==0){h=u.offset+u.relativeOffset-2;h+=m;h+=(_-d)*2;f=_u.getUShort(r,h);if(f!==0){f=f+v&65535}}else{f=_+v&65535}e.glyphIndexMap[_]=f}}}function xu(e,t){var r={};r.version=_u.getUShort(e,t);Ol.argument(r.version===0,"cmap table version should be 0.");r.numTables=_u.getUShort(e,t+2);var n=-1;for(var i=r.numTables-1;i>=0;i-=1){var a=_u.getUShort(e,t+4+i*8);var o=_u.getUShort(e,t+4+i*8+2);if(a===3&&(o===0||o===1||o===10)){n=_u.getULong(e,t+4+i*8+4);break}}if(n===-1){throw new Error("No valid cmap sub-tables found.")}var s=new _u.Parser(e,t+n);r.format=s.parseUShort();if(r.format===12){gu(r,s)}else if(r.format===4){yu(r,s,e,t,n)}else{throw new Error("Only format 4 and 12 cmap tables are supported (found format "+r.format+").")}return r}function bu(e,t,r){e.segments.push({end:t,start:t,delta:-(t-r),offset:0})}function wu(e){e.segments.push({end:65535,start:65535,delta:1,offset:0})}function Tu(e){var t=new iu.Table("cmap",[{name:"version",type:"USHORT",value:0},{name:"numTables",type:"USHORT",value:1},{name:"platformID",type:"USHORT",value:3},{name:"encodingID",type:"USHORT",value:1},{name:"offset",type:"ULONG",value:12},{name:"format",type:"USHORT",value:4},{name:"length",type:"USHORT",value:0},{name:"language",type:"USHORT",value:0},{name:"segCountX2",type:"USHORT",value:0},{name:"searchRange",type:"USHORT",value:0},{name:"entrySelector",type:"USHORT",value:0},{name:"rangeShift",type:"USHORT",value:0}]);t.segments=[];for(var r=0;r<e.length;r+=1){var n=e.get(r);for(var i=0;i<n.unicodes.length;i+=1){bu(t,n.unicodes[i],r)}t.segments=t.segments.sort(function(e,t){return e.start-t.start})}wu(t);var a;a=t.segments.length;t.segCountX2=a*2;t.searchRange=Math.pow(2,Math.floor(Math.log(a)/Math.log(2)))*2;t.entrySelector=Math.log(t.searchRange/2)/Math.log(2);t.rangeShift=t.segCountX2-t.searchRange;var o=[];var s=[];var l=[];var u=[];var h=[];for(var c=0;c<a;c+=1){var f=t.segments[c];o=o.concat({name:"end_"+c,type:"USHORT",value:f.end});s=s.concat({name:"start_"+c,type:"USHORT",value:f.start});l=l.concat({name:"idDelta_"+c,type:"SHORT",value:f.delta});u=u.concat({name:"idRangeOffset_"+c,type:"USHORT",value:f.offset});if(f.glyphId!==undefined){h=h.concat({name:"glyph_"+c,type:"USHORT",value:f.glyphId})}}t.fields=t.fields.concat(o);t.fields.push({name:"reservedPad",type:"USHORT",value:0});t.fields=t.fields.concat(s);t.fields=t.fields.concat(l);t.fields=t.fields.concat(u);t.fields=t.fields.concat(h);t.length=14+o.length*2+2+s.length*2+l.length*2+u.length*2+h.length*2;return t}var Eu={parse:xu,make:Tu};var Su=[".notdef","space","exclam","quotedbl","numbersign","dollar","percent","ampersand","quoteright","parenleft","parenright","asterisk","plus","comma","hyphen","period","slash","zero","one","two","three","four","five","six","seven","eight","nine","colon","semicolon","less","equal","greater","question","at","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","bracketleft","backslash","bracketright","asciicircum","underscore","quoteleft","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","braceleft","bar","braceright","asciitilde","exclamdown","cent","sterling","fraction","yen","florin","section","currency","quotesingle","quotedblleft","guillemotleft","guilsinglleft","guilsinglright","fi","fl","endash","dagger","daggerdbl","periodcentered","paragraph","bullet","quotesinglbase","quotedblbase","quotedblright","guillemotright","ellipsis","perthousand","questiondown","grave","acute","circumflex","tilde","macron","breve","dotaccent","dieresis","ring","cedilla","hungarumlaut","ogonek","caron","emdash","AE","ordfeminine","Lslash","Oslash","OE","ordmasculine","ae","dotlessi","lslash","oslash","oe","germandbls","onesuperior","logicalnot","mu","trademark","Eth","onehalf","plusminus","Thorn","onequarter","divide","brokenbar","degree","thorn","threequarters","twosuperior","registered","minus","eth","multiply","threesuperior","copyright","Aacute","Acircumflex","Adieresis","Agrave","Aring","Atilde","Ccedilla","Eacute","Ecircumflex","Edieresis","Egrave","Iacute","Icircumflex","Idieresis","Igrave","Ntilde","Oacute","Ocircumflex","Odieresis","Ograve","Otilde","Scaron","Uacute","Ucircumflex","Udieresis","Ugrave","Yacute","Ydieresis","Zcaron","aacute","acircumflex","adieresis","agrave","aring","atilde","ccedilla","eacute","ecircumflex","edieresis","egrave","iacute","icircumflex","idieresis","igrave","ntilde","oacute","ocircumflex","odieresis","ograve","otilde","scaron","uacute","ucircumflex","udieresis","ugrave","yacute","ydieresis","zcaron","exclamsmall","Hungarumlautsmall","dollaroldstyle","dollarsuperior","ampersandsmall","Acutesmall","parenleftsuperior","parenrightsuperior","266 ff","onedotenleader","zerooldstyle","oneoldstyle","twooldstyle","threeoldstyle","fouroldstyle","fiveoldstyle","sixoldstyle","sevenoldstyle","eightoldstyle","nineoldstyle","commasuperior","threequartersemdash","periodsuperior","questionsmall","asuperior","bsuperior","centsuperior","dsuperior","esuperior","isuperior","lsuperior","msuperior","nsuperior","osuperior","rsuperior","ssuperior","tsuperior","ff","ffi","ffl","parenleftinferior","parenrightinferior","Circumflexsmall","hyphensuperior","Gravesmall","Asmall","Bsmall","Csmall","Dsmall","Esmall","Fsmall","Gsmall","Hsmall","Ismall","Jsmall","Ksmall","Lsmall","Msmall","Nsmall","Osmall","Psmall","Qsmall","Rsmall","Ssmall","Tsmall","Usmall","Vsmall","Wsmall","Xsmall","Ysmall","Zsmall","colonmonetary","onefitted","rupiah","Tildesmall","exclamdownsmall","centoldstyle","Lslashsmall","Scaronsmall","Zcaronsmall","Dieresissmall","Brevesmall","Caronsmall","Dotaccentsmall","Macronsmall","figuredash","hypheninferior","Ogoneksmall","Ringsmall","Cedillasmall","questiondownsmall","oneeighth","threeeighths","fiveeighths","seveneighths","onethird","twothirds","zerosuperior","foursuperior","fivesuperior","sixsuperior","sevensuperior","eightsuperior","ninesuperior","zeroinferior","oneinferior","twoinferior","threeinferior","fourinferior","fiveinferior","sixinferior","seveninferior","eightinferior","nineinferior","centinferior","dollarinferior","periodinferior","commainferior","Agravesmall","Aacutesmall","Acircumflexsmall","Atildesmall","Adieresissmall","Aringsmall","AEsmall","Ccedillasmall","Egravesmall","Eacutesmall","Ecircumflexsmall","Edieresissmall","Igravesmall","Iacutesmall","Icircumflexsmall","Idieresissmall","Ethsmall","Ntildesmall","Ogravesmall","Oacutesmall","Ocircumflexsmall","Otildesmall","Odieresissmall","OEsmall","Oslashsmall","Ugravesmall","Uacutesmall","Ucircumflexsmall","Udieresissmall","Yacutesmall","Thornsmall","Ydieresissmall","001.000","001.001","001.002","001.003","Black","Bold","Book","Light","Medium","Regular","Roman","Semibold"];var Mu=["","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","space","exclam","quotedbl","numbersign","dollar","percent","ampersand","quoteright","parenleft","parenright","asterisk","plus","comma","hyphen","period","slash","zero","one","two","three","four","five","six","seven","eight","nine","colon","semicolon","less","equal","greater","question","at","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","bracketleft","backslash","bracketright","asciicircum","underscore","quoteleft","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","braceleft","bar","braceright","asciitilde","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","exclamdown","cent","sterling","fraction","yen","florin","section","currency","quotesingle","quotedblleft","guillemotleft","guilsinglleft","guilsinglright","fi","fl","","endash","dagger","daggerdbl","periodcentered","","paragraph","bullet","quotesinglbase","quotedblbase","quotedblright","guillemotright","ellipsis","perthousand","","questiondown","","grave","acute","circumflex","tilde","macron","breve","dotaccent","dieresis","","ring","cedilla","","hungarumlaut","ogonek","caron","emdash","","","","","","","","","","","","","","","","","AE","","ordfeminine","","","","","Lslash","Oslash","OE","ordmasculine","","","","","","ae","","","","dotlessi","","","lslash","oslash","oe","germandbls"];var Au=["","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","space","exclamsmall","Hungarumlautsmall","","dollaroldstyle","dollarsuperior","ampersandsmall","Acutesmall","parenleftsuperior","parenrightsuperior","twodotenleader","onedotenleader","comma","hyphen","period","fraction","zerooldstyle","oneoldstyle","twooldstyle","threeoldstyle","fouroldstyle","fiveoldstyle","sixoldstyle","sevenoldstyle","eightoldstyle","nineoldstyle","colon","semicolon","commasuperior","threequartersemdash","periodsuperior","questionsmall","","asuperior","bsuperior","centsuperior","dsuperior","esuperior","","","isuperior","","","lsuperior","msuperior","nsuperior","osuperior","","","rsuperior","ssuperior","tsuperior","","ff","fi","fl","ffi","ffl","parenleftinferior","","parenrightinferior","Circumflexsmall","hyphensuperior","Gravesmall","Asmall","Bsmall","Csmall","Dsmall","Esmall","Fsmall","Gsmall","Hsmall","Ismall","Jsmall","Ksmall","Lsmall","Msmall","Nsmall","Osmall","Psmall","Qsmall","Rsmall","Ssmall","Tsmall","Usmall","Vsmall","Wsmall","Xsmall","Ysmall","Zsmall","colonmonetary","onefitted","rupiah","Tildesmall","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","exclamdownsmall","centoldstyle","Lslashsmall","","","Scaronsmall","Zcaronsmall","Dieresissmall","Brevesmall","Caronsmall","","Dotaccentsmall","","","Macronsmall","","","figuredash","hypheninferior","","","Ogoneksmall","Ringsmall","Cedillasmall","","","","onequarter","onehalf","threequarters","questiondownsmall","oneeighth","threeeighths","fiveeighths","seveneighths","onethird","twothirds","","","zerosuperior","onesuperior","twosuperior","threesuperior","foursuperior","fivesuperior","sixsuperior","sevensuperior","eightsuperior","ninesuperior","zeroinferior","oneinferior","twoinferior","threeinferior","fourinferior","fiveinferior","sixinferior","seveninferior","eightinferior","nineinferior","centinferior","dollarinferior","periodinferior","commainferior","Agravesmall","Aacutesmall","Acircumflexsmall","Atildesmall","Adieresissmall","Aringsmall","AEsmall","Ccedillasmall","Egravesmall","Eacutesmall","Ecircumflexsmall","Edieresissmall","Igravesmall","Iacutesmall","Icircumflexsmall","Idieresissmall","Ethsmall","Ntildesmall","Ogravesmall","Oacutesmall","Ocircumflexsmall","Otildesmall","Odieresissmall","OEsmall","Oslashsmall","Ugravesmall","Uacutesmall","Ucircumflexsmall","Udieresissmall","Yacutesmall","Thornsmall","Ydieresissmall"];var Ru=[".notdef",".null","nonmarkingreturn","space","exclam","quotedbl","numbersign","dollar","percent","ampersand","quotesingle","parenleft","parenright","asterisk","plus","comma","hyphen","period","slash","zero","one","two","three","four","five","six","seven","eight","nine","colon","semicolon","less","equal","greater","question","at","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","bracketleft","backslash","bracketright","asciicircum","underscore","grave","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","braceleft","bar","braceright","asciitilde","Adieresis","Aring","Ccedilla","Eacute","Ntilde","Odieresis","Udieresis","aacute","agrave","acircumflex","adieresis","atilde","aring","ccedilla","eacute","egrave","ecircumflex","edieresis","iacute","igrave","icircumflex","idieresis","ntilde","oacute","ograve","ocircumflex","odieresis","otilde","uacute","ugrave","ucircumflex","udieresis","dagger","degree","cent","sterling","section","bullet","paragraph","germandbls","registered","copyright","trademark","acute","dieresis","notequal","AE","Oslash","infinity","plusminus","lessequal","greaterequal","yen","mu","partialdiff","summation","product","pi","integral","ordfeminine","ordmasculine","Omega","ae","oslash","questiondown","exclamdown","logicalnot","radical","florin","approxequal","Delta","guillemotleft","guillemotright","ellipsis","nonbreakingspace","Agrave","Atilde","Otilde","OE","oe","endash","emdash","quotedblleft","quotedblright","quoteleft","quoteright","divide","lozenge","ydieresis","Ydieresis","fraction","currency","guilsinglleft","guilsinglright","fi","fl","daggerdbl","periodcentered","quotesinglbase","quotedblbase","perthousand","Acircumflex","Ecircumflex","Aacute","Edieresis","Egrave","Iacute","Icircumflex","Idieresis","Igrave","Oacute","Ocircumflex","apple","Ograve","Uacute","Ucircumflex","Ugrave","dotlessi","circumflex","tilde","macron","breve","dotaccent","ring","cedilla","hungarumlaut","ogonek","caron","Lslash","lslash","Scaron","scaron","Zcaron","zcaron","brokenbar","Eth","eth","Yacute","yacute","Thorn","thorn","minus","multiply","onesuperior","twosuperior","threesuperior","onehalf","onequarter","threequarters","franc","Gbreve","gbreve","Idotaccent","Scedilla","scedilla","Cacute","cacute","Ccaron","ccaron","dcroat"];function Lu(e){this.font=e}Lu.prototype.charToGlyphIndex=function(e){var t=e.charCodeAt(0);var r=this.font.glyphs;if(r){for(var n=0;n<r.length;n+=1){var i=r.get(n);for(var a=0;a<i.unicodes.length;a+=1){if(i.unicodes[a]===t){return n}}}}return null};function Cu(e){this.cmap=e}Cu.prototype.charToGlyphIndex=function(e){return this.cmap.glyphIndexMap[e.charCodeAt(0)]||0};function Iu(e,t){this.encoding=e;this.charset=t}Iu.prototype.charToGlyphIndex=function(e){var t=e.charCodeAt(0);var r=this.encoding[t];return this.charset.indexOf(r)};function Uu(e){var t=this;switch(e.version){case 1:this.names=Ru.slice();break;case 2:this.names=new Array(e.numberOfGlyphs);for(var r=0;r<e.numberOfGlyphs;r++){if(e.glyphNameIndex[r]<Ru.length){t.names[r]=Ru[e.glyphNameIndex[r]]}else{t.names[r]=e.names[e.glyphNameIndex[r]-Ru.length]}}break;case 2.5:this.names=new Array(e.numberOfGlyphs);for(var n=0;n<e.numberOfGlyphs;n++){t.names[n]=Ru[n+e.glyphNameIndex[n]]}break;case 3:this.names=[];break;default:this.names=[];break}}Uu.prototype.nameToGlyphIndex=function(e){return this.names.indexOf(e)};Uu.prototype.glyphIndexToName=function(e){return this.names[e]};function Du(e){var t;var r=e.tables.cmap.glyphIndexMap;var n=Object.keys(r);for(var i=0;i<n.length;i+=1){var a=n[i];var o=r[a];t=e.glyphs.get(o);t.addUnicode(parseInt(a))}for(var s=0;s<e.glyphs.length;s+=1){t=e.glyphs.get(s);if(e.cffEncoding){if(e.isCIDFont){t.name="gid"+s}else{t.name=e.cffEncoding.charset[s]}}else if(e.glyphNames.names){t.name=e.glyphNames.glyphIndexToName(s)}}}function Ou(e,t,r,n,i){e.beginPath();e.moveTo(t,r);e.lineTo(n,i);e.stroke()}var Bu={line:Ou};function Pu(e,t,r,n,i){var a;if((t&n)>0){a=e.parseByte();if((t&i)===0){a=-a}a=r+a}else{if((t&i)>0){a=r}else{a=r+e.parseShort()}}return a}function Fu(e,t,r){var n=new _u.Parser(t,r);e.numberOfContours=n.parseShort();e._xMin=n.parseShort();e._yMin=n.parseShort();e._xMax=n.parseShort();e._yMax=n.parseShort();var i;var a;if(e.numberOfContours>0){var o=e.endPointIndices=[];for(var s=0;s<e.numberOfContours;s+=1){o.push(n.parseUShort())}e.instructionLength=n.parseUShort();e.instructions=[];for(var l=0;l<e.instructionLength;l+=1){e.instructions.push(n.parseByte())}var u=o[o.length-1]+1;i=[];for(var h=0;h<u;h+=1){a=n.parseByte();i.push(a);if((a&8)>0){var c=n.parseByte();for(var f=0;f<c;f+=1){i.push(a);h+=1}}}Ol.argument(i.length===u,"Bad flags.");if(o.length>0){var p=[];var d;if(u>0){for(var v=0;v<u;v+=1){a=i[v];d={};d.onCurve=!!(a&1);d.lastPointOfContour=o.indexOf(v)>=0;p.push(d)}var m=0;for(var _=0;_<u;_+=1){a=i[_];d=p[_];d.x=Pu(n,a,m,2,16);m=d.x}var g=0;for(var y=0;y<u;y+=1){a=i[y];d=p[y];d.y=Pu(n,a,g,4,32);g=d.y}}e.points=p}else{e.points=[]}}else if(e.numberOfContours===0){e.points=[]}else{e.isComposite=true;e.points=[];e.components=[];var x=true;while(x){i=n.parseUShort();var b={glyphIndex:n.parseUShort(),xScale:1,scale01:0,scale10:0,yScale:1,dx:0,dy:0};if((i&1)>0){if((i&2)>0){b.dx=n.parseShort();b.dy=n.parseShort()}else{b.matchedPoints=[n.parseUShort(),n.parseUShort()]}}else{if((i&2)>0){b.dx=n.parseChar();b.dy=n.parseChar()}else{b.matchedPoints=[n.parseByte(),n.parseByte()]}}if((i&8)>0){b.xScale=b.yScale=n.parseF2Dot14()}else if((i&64)>0){b.xScale=n.parseF2Dot14();b.yScale=n.parseF2Dot14()}else if((i&128)>0){b.xScale=n.parseF2Dot14();b.scale01=n.parseF2Dot14();b.scale10=n.parseF2Dot14();b.yScale=n.parseF2Dot14()}e.components.push(b);x=!!(i&32)}if(i&256){e.instructionLength=n.parseUShort();e.instructions=[];for(var w=0;w<e.instructionLength;w+=1){e.instructions.push(n.parseByte())}}}}function zu(e,t){var r=[];for(var n=0;n<e.length;n+=1){var i=e[n];var a={x:t.xScale*i.x+t.scale01*i.y+t.dx,y:t.scale10*i.x+t.yScale*i.y+t.dy,onCurve:i.onCurve,lastPointOfContour:i.lastPointOfContour};r.push(a)}return r}function Nu(e){var t=[];var r=[];for(var n=0;n<e.length;n+=1){var i=e[n];r.push(i);if(i.lastPointOfContour){t.push(r);r=[]}}Ol.argument(r.length===0,"There are still points left in the current contour.");return t}function ku(e){var t=new Il;if(!e){return t}var r=Nu(e);for(var n=0;n<r.length;++n){var i=r[n];var a=null;var o=i[i.length-1];var s=i[0];if(o.onCurve){t.moveTo(o.x,o.y)}else{if(s.onCurve){t.moveTo(s.x,s.y)}else{var l={x:(o.x+s.x)*.5,y:(o.y+s.y)*.5};t.moveTo(l.x,l.y)}}for(var u=0;u<i.length;++u){a=o;o=s;s=i[(u+1)%i.length];if(o.onCurve){t.lineTo(o.x,o.y)}else{var h=a;var c=s;if(!a.onCurve){h={x:(o.x+a.x)*.5,y:(o.y+a.y)*.5};t.lineTo(h.x,h.y)}if(!s.onCurve){c={x:(o.x+s.x)*.5,y:(o.y+s.y)*.5}}t.lineTo(h.x,h.y);t.quadraticCurveTo(o.x,o.y,c.x,c.y)}}t.closePath()}return t}function Vu(e,t){if(t.isComposite){for(var r=0;r<t.components.length;r+=1){var n=t.components[r];var i=e.get(n.glyphIndex);i.getPath();if(i.points){var a=void 0;if(n.matchedPoints===undefined){a=zu(i.points,n)}else{if(n.matchedPoints[0]>t.points.length-1||n.matchedPoints[1]>i.points.length-1){throw Error("Matched points out of range in "+t.name)}var o=t.points[n.matchedPoints[0]];var s=i.points[n.matchedPoints[1]];var l={xScale:n.xScale,scale01:n.scale01,scale10:n.scale10,yScale:n.yScale,dx:0,dy:0};s=zu([s],l)[0];l.dx=o.x-s.x;l.dy=o.y-s.y;a=zu(i.points,l)}t.points=t.points.concat(a)}}}return ku(t.points)}function Gu(e,t,r,n){var i=new Qu.GlyphSet(n);for(var a=0;a<r.length-1;a+=1){var o=r[a];var s=r[a+1];if(o!==s){i.push(a,Qu.ttfGlyphLoader(n,a,Fu,e,t+o,Vu))}else{i.push(a,Qu.glyphLoader(n,a))}}return i}var Wu={getPath:ku,parse:Gu};function Hu(e,t){var r=t||{commands:[]};return{configurable:true,get:function(){if(typeof r==="function"){r=r()}return r},set:function(e){r=e}}}function ju(e){this.bindConstructorValues(e)}ju.prototype.bindConstructorValues=function(e){this.index=e.index||0;this.name=e.name||null;this.unicode=e.unicode||undefined;this.unicodes=e.unicodes||e.unicode!==undefined?[e.unicode]:[];if(e.xMin){this.xMin=e.xMin}if(e.yMin){this.yMin=e.yMin}if(e.xMax){this.xMax=e.xMax}if(e.yMax){this.yMax=e.yMax}if(e.advanceWidth){this.advanceWidth=e.advanceWidth}Object.defineProperty(this,"path",Hu(this,e.path))};ju.prototype.addUnicode=function(e){if(this.unicodes.length===0){this.unicode=e}this.unicodes.push(e)};ju.prototype.getBoundingBox=function(){return this.path.getBoundingBox()};ju.prototype.getPath=function(e,t,r,n,i){e=e!==undefined?e:0;t=t!==undefined?t:0;r=r!==undefined?r:72;var a;var o;if(!n){n={}}var s=n.xScale;var l=n.yScale;if(n.hinting&&i&&i.hinting){o=this.path&&i.hinting.exec(this,r)}if(o){a=Wu.getPath(o).commands;e=Math.round(e);t=Math.round(t);s=l=1}else{a=this.path.commands;var u=1/this.path.unitsPerEm*r;if(s===undefined){s=u}if(l===undefined){l=u}}var h=new Il;for(var c=0;c<a.length;c+=1){var f=a[c];if(f.type==="M"){h.moveTo(e+f.x*s,t+-f.y*l)}else if(f.type==="L"){h.lineTo(e+f.x*s,t+-f.y*l)}else if(f.type==="Q"){h.quadraticCurveTo(e+f.x1*s,t+-f.y1*l,e+f.x*s,t+-f.y*l)}else if(f.type==="C"){h.curveTo(e+f.x1*s,t+-f.y1*l,e+f.x2*s,t+-f.y2*l,e+f.x*s,t+-f.y*l)}else if(f.type==="Z"){h.closePath()}}return h};ju.prototype.getContours=function(){var e=this;if(this.points===undefined){return[]}var t=[];var r=[];for(var n=0;n<this.points.length;n+=1){var i=e.points[n];r.push(i);if(i.lastPointOfContour){t.push(r);r=[]}}Ol.argument(r.length===0,"There are still points left in the current contour.");return t};ju.prototype.getMetrics=function(){var e=this.path.commands;var t=[];var r=[];for(var n=0;n<e.length;n+=1){var i=e[n];if(i.type!=="Z"){t.push(i.x);r.push(i.y)}if(i.type==="Q"||i.type==="C"){t.push(i.x1);r.push(i.y1)}if(i.type==="C"){t.push(i.x2);r.push(i.y2)}}var a={xMin:Math.min.apply(null,t),yMin:Math.min.apply(null,r),xMax:Math.max.apply(null,t),yMax:Math.max.apply(null,r),leftSideBearing:this.leftSideBearing};if(!isFinite(a.xMin)){a.xMin=0}if(!isFinite(a.xMax)){a.xMax=this.advanceWidth}if(!isFinite(a.yMin)){a.yMin=0}if(!isFinite(a.yMax)){a.yMax=0}a.rightSideBearing=this.advanceWidth-a.leftSideBearing-(a.xMax-a.xMin);return a};ju.prototype.draw=function(e,t,r,n,i){this.getPath(t,r,n,i).draw(e)};ju.prototype.drawPoints=function(e,t,r,n){function i(t,r,n,i){var a=Math.PI*2;e.beginPath();for(var o=0;o<t.length;o+=1){e.moveTo(r+t[o].x*i,n+t[o].y*i);e.arc(r+t[o].x*i,n+t[o].y*i,2,0,a,false)}e.closePath();e.fill()}t=t!==undefined?t:0;r=r!==undefined?r:0;n=n!==undefined?n:24;var a=1/this.path.unitsPerEm*n;var o=[];var s=[];var l=this.path;for(var u=0;u<l.commands.length;u+=1){var h=l.commands[u];if(h.x!==undefined){o.push({x:h.x,y:-h.y})}if(h.x1!==undefined){s.push({x:h.x1,y:-h.y1})}if(h.x2!==undefined){s.push({x:h.x2,y:-h.y2})}}e.fillStyle="blue";i(o,t,r,a);e.fillStyle="red";i(s,t,r,a)};ju.prototype.drawMetrics=function(e,t,r,n){var i;t=t!==undefined?t:0;r=r!==undefined?r:0;n=n!==undefined?n:24;i=1/this.path.unitsPerEm*n;e.lineWidth=1;e.strokeStyle="black";Bu.line(e,t,-1e4,t,1e4);Bu.line(e,-1e4,r,1e4,r);var a=this.xMin||0;var o=this.yMin||0;var s=this.xMax||0;var l=this.yMax||0;var u=this.advanceWidth||0;e.strokeStyle="blue";Bu.line(e,t+a*i,-1e4,t+a*i,1e4);Bu.line(e,t+s*i,-1e4,t+s*i,1e4);Bu.line(e,-1e4,r+-o*i,1e4,r+-o*i);Bu.line(e,-1e4,r+-l*i,1e4,r+-l*i);e.strokeStyle="green";Bu.line(e,t+u*i,-1e4,t+u*i,1e4)};function qu(e,t,r){Object.defineProperty(e,t,{get:function(){e.path;return e[r]},set:function(t){e[r]=t},enumerable:true,configurable:true})}function Xu(e,t){var r=this;this.font=e;this.glyphs={};if(Array.isArray(t)){for(var n=0;n<t.length;n++){r.glyphs[n]=t[n]}}this.length=t&&t.length||0}Xu.prototype.get=function(e){if(typeof this.glyphs[e]==="function"){this.glyphs[e]=this.glyphs[e]()}return this.glyphs[e]};Xu.prototype.push=function(e,t){this.glyphs[e]=t;this.length++};function Yu(e,t){return new ju({index:t,font:e})}function Ku(e,t,r,n,i,a){return function(){var o=new ju({index:t,font:e});o.path=function(){r(o,n,i);var t=a(e.glyphs,o);t.unitsPerEm=e.unitsPerEm;return t};qu(o,"xMin","_xMin");qu(o,"xMax","_xMax");qu(o,"yMin","_yMin");qu(o,"yMax","_yMax");return o}}function Zu(e,t,r,n){return function(){var i=new ju({index:t,font:e});i.path=function(){var t=r(e,i,n);t.unitsPerEm=e.unitsPerEm;return t};return i}}var Qu={GlyphSet:Xu,glyphLoader:Yu,ttfGlyphLoader:Ku,cffGlyphLoader:Zu};function Ju(e,t){if(e===t){return true}else if(Array.isArray(e)&&Array.isArray(t)){if(e.length!==t.length){return false}for(var r=0;r<e.length;r+=1){if(!Ju(e[r],t[r])){return false}}return true}else{return false}}function $u(e){var t;if(e.length<1240){t=107}else if(e.length<33900){t=1131}else{t=32768}return t}function eh(e,t,r){var n=[];var i=[];var a=_u.getCard16(e,t);var o;var s;if(a!==0){var l=_u.getByte(e,t+2);o=t+(a+1)*l+2;var u=t+3;for(var h=0;h<a+1;h+=1){n.push(_u.getOffset(e,u,l));u+=l}s=o+n[a]}else{s=t+2}for(var c=0;c<n.length-1;c+=1){var f=_u.getBytes(e,o+n[c],o+n[c+1]);if(r){f=r(f)}i.push(f)}return{objects:i,startOffset:t,endOffset:s}}function th(e){var t="";var r=15;var n=["0","1","2","3","4","5","6","7","8","9",".","E","E-",null,"-"];while(true){var i=e.parseByte();var a=i>>4;var o=i&15;if(a===r){break}t+=n[a];if(o===r){break}t+=n[o]}return parseFloat(t)}function rh(e,t){var r;var n;var i;var a;if(t===28){r=e.parseByte();n=e.parseByte();return r<<8|n}if(t===29){r=e.parseByte();n=e.parseByte();i=e.parseByte();a=e.parseByte();return r<<24|n<<16|i<<8|a}if(t===30){return th(e)}if(t>=32&&t<=246){return t-139}if(t>=247&&t<=250){r=e.parseByte();return(t-247)*256+r+108}if(t>=251&&t<=254){r=e.parseByte();return-(t-251)*256-r-108}throw new Error("Invalid b0 "+t)}function nh(e){var t={};for(var r=0;r<e.length;r+=1){var n=e[r][0];var i=e[r][1];var a=void 0;if(i.length===1){a=i[0]}else{a=i}if(t.hasOwnProperty(n)&&!isNaN(t[n])){throw new Error("Object "+t+" already has key "+n)}t[n]=a}return t}function ih(e,t,r){t=t!==undefined?t:0;var n=new _u.Parser(e,t);var i=[];var a=[];r=r!==undefined?r:e.length;while(n.relativeOffset<r){var o=n.parseByte();if(o<=21){if(o===12){o=1200+n.parseByte()}i.push([o,a]);a=[]}else{a.push(rh(n,o))}}return nh(i)}function ah(e,t){if(t<=390){t=Su[t]}else{t=e[t-391]}return t}function oh(e,t,r){var n={};var i;for(var a=0;a<t.length;a+=1){var o=t[a];if(Array.isArray(o.type)){var s=[];s.length=o.type.length;for(var l=0;l<o.type.length;l++){i=e[o.op]!==undefined?e[o.op][l]:undefined;if(i===undefined){i=o.value!==undefined&&o.value[l]!==undefined?o.value[l]:null}if(o.type[l]==="SID"){i=ah(r,i)}s[l]=i}n[o.name]=s}else{i=e[o.op];if(i===undefined){i=o.value!==undefined?o.value:null}if(o.type==="SID"){i=ah(r,i)}n[o.name]=i}}return n}function sh(e,t){var r={};r.formatMajor=_u.getCard8(e,t);r.formatMinor=_u.getCard8(e,t+1);r.size=_u.getCard8(e,t+2);r.offsetSize=_u.getCard8(e,t+3);r.startOffset=t;r.endOffset=t+4;return r}var lh=[{name:"version",op:0,type:"SID"},{name:"notice",op:1,type:"SID"},{name:"copyright",op:1200,type:"SID"},{name:"fullName",op:2,type:"SID"},{name:"familyName",op:3,type:"SID"},{name:"weight",op:4,type:"SID"},{name:"isFixedPitch",op:1201,type:"number",value:0},{name:"italicAngle",op:1202,type:"number",value:0},{name:"underlinePosition",op:1203,type:"number",value:-100},{name:"underlineThickness",op:1204,type:"number",value:50},{name:"paintType",op:1205,type:"number",value:0},{name:"charstringType",op:1206,type:"number",value:2},{name:"fontMatrix",op:1207,type:["real","real","real","real","real","real"],value:[.001,0,0,.001,0,0]},{name:"uniqueId",op:13,type:"number"},{name:"fontBBox",op:5,type:["number","number","number","number"],value:[0,0,0,0]},{name:"strokeWidth",op:1208,type:"number",value:0},{name:"xuid",op:14,type:[],value:null},{name:"charset",op:15,type:"offset",value:0},{name:"encoding",op:16,type:"offset",value:0},{name:"charStrings",op:17,type:"offset",value:0},{name:"private",op:18,type:["number","offset"],value:[0,0]},{name:"ros",op:1230,type:["SID","SID","number"]},{name:"cidFontVersion",op:1231,type:"number",value:0},{name:"cidFontRevision",op:1232,type:"number",value:0},{name:"cidFontType",op:1233,type:"number",value:0},{name:"cidCount",op:1234,type:"number",value:8720},{name:"uidBase",op:1235,type:"number"},{name:"fdArray",op:1236,type:"offset"},{name:"fdSelect",op:1237,type:"offset"},{name:"fontName",op:1238,type:"SID"}];var uh=[{name:"subrs",op:19,type:"offset",value:0},{name:"defaultWidthX",op:20,type:"number",value:0},{name:"nominalWidthX",op:21,type:"number",value:0}];function hh(e,t){var r=ih(e,0,e.byteLength);return oh(r,lh,t)}function ch(e,t,r,n){var i=ih(e,t,r);return oh(i,uh,n)}function fh(e,t,r,n){var i=[];for(var a=0;a<r.length;a+=1){var o=new DataView(new Uint8Array(r[a]).buffer);var s=hh(o,n);s._subrs=[];s._subrsBias=0;var l=s.private[0];var u=s.private[1];if(l!==0&&u!==0){var h=ch(e,u+t,l,n);s._defaultWidthX=h.defaultWidthX;s._nominalWidthX=h.nominalWidthX;if(h.subrs!==0){var c=u+h.subrs;var f=eh(e,c+t);s._subrs=f.objects;s._subrsBias=$u(s._subrs)}s._privateDict=h}i.push(s)}return i}function ph(e,t,r,n){var i;var a;var o=new _u.Parser(e,t);r-=1;var s=[".notdef"];var l=o.parseCard8();if(l===0){for(var u=0;u<r;u+=1){i=o.parseSID();s.push(ah(n,i))}}else if(l===1){while(s.length<=r){i=o.parseSID();a=o.parseCard8();for(var h=0;h<=a;h+=1){s.push(ah(n,i));i+=1}}}else if(l===2){while(s.length<=r){i=o.parseSID();a=o.parseCard16();for(var c=0;c<=a;c+=1){s.push(ah(n,i));i+=1}}}else{throw new Error("Unknown charset format "+l)}return s}function dh(e,t,r){var n;var i={};var a=new _u.Parser(e,t);var o=a.parseCard8();if(o===0){var s=a.parseCard8();for(var l=0;l<s;l+=1){n=a.parseCard8();i[n]=l}}else if(o===1){var u=a.parseCard8();n=1;for(var h=0;h<u;h+=1){var c=a.parseCard8();var f=a.parseCard8();for(var p=c;p<=c+f;p+=1){i[p]=n;n+=1}}}else{throw new Error("Unknown encoding format "+o)}return new Iu(i,r)}function vh(e,t,r){var n;var i;var a;var o;var s=new Il;var l=[];var u=0;var h=false;var c=false;var f=0;var p=0;var d;var v;var m;var _;if(e.isCIDFont){var g=e.tables.cff.topDict._fdSelect[t.index];var y=e.tables.cff.topDict._fdArray[g];d=y._subrs;v=y._subrsBias;m=y._defaultWidthX;_=y._nominalWidthX}else{d=e.tables.cff.topDict._subrs;v=e.tables.cff.topDict._subrsBias;m=e.tables.cff.topDict._defaultWidthX;_=e.tables.cff.topDict._nominalWidthX}var x=m;function b(e,t){if(c){s.closePath()}s.moveTo(e,t);c=true}function w(){var e;e=l.length%2!==0;if(e&&!h){x=l.shift()+_}u+=l.length>>1;l.length=0;h=true}function T(r){var m;var g;var y;var E;var S;var M;var A;var R;var L;var C;var I;var U;var D=0;while(D<r.length){var O=r[D];D+=1;switch(O){case 1:w();break;case 3:w();break;case 4:if(l.length>1&&!h){x=l.shift()+_;h=true}p+=l.pop();b(f,p);break;case 5:while(l.length>0){f+=l.shift();p+=l.shift();s.lineTo(f,p)}break;case 6:while(l.length>0){f+=l.shift();s.lineTo(f,p);if(l.length===0){break}p+=l.shift();s.lineTo(f,p)}break;case 7:while(l.length>0){p+=l.shift();s.lineTo(f,p);if(l.length===0){break}f+=l.shift();s.lineTo(f,p)}break;case 8:while(l.length>0){n=f+l.shift();i=p+l.shift();a=n+l.shift();o=i+l.shift();f=a+l.shift();p=o+l.shift();s.curveTo(n,i,a,o,f,p)}break;case 10:S=l.pop()+v;M=d[S];if(M){T(M)}break;case 11:return;case 12:O=r[D];D+=1;switch(O){case 35:n=f+l.shift();i=p+l.shift();a=n+l.shift();o=i+l.shift();A=a+l.shift();R=o+l.shift();L=A+l.shift();C=R+l.shift();I=L+l.shift();U=C+l.shift();f=I+l.shift();p=U+l.shift();l.shift();s.curveTo(n,i,a,o,A,R);s.curveTo(L,C,I,U,f,p);break;case 34:n=f+l.shift();i=p;a=n+l.shift();o=i+l.shift();A=a+l.shift();R=o;L=A+l.shift();C=o;I=L+l.shift();U=p;f=I+l.shift();s.curveTo(n,i,a,o,A,R);s.curveTo(L,C,I,U,f,p);break;case 36:n=f+l.shift();i=p+l.shift();a=n+l.shift();o=i+l.shift();A=a+l.shift();R=o;L=A+l.shift();C=o;I=L+l.shift();U=C+l.shift();f=I+l.shift();s.curveTo(n,i,a,o,A,R);s.curveTo(L,C,I,U,f,p);break;case 37:n=f+l.shift();i=p+l.shift();a=n+l.shift();o=i+l.shift();A=a+l.shift();R=o+l.shift();L=A+l.shift();C=R+l.shift();I=L+l.shift();U=C+l.shift();if(Math.abs(I-f)>Math.abs(U-p)){f=I+l.shift()}else{p=U+l.shift()}s.curveTo(n,i,a,o,A,R);s.curveTo(L,C,I,U,f,p);break;default:console.log("Glyph "+t.index+": unknown operator "+1200+O);l.length=0}break;case 14:if(l.length>0&&!h){x=l.shift()+_;h=true}if(c){s.closePath();c=false}break;case 18:w();break;case 19:case 20:w();D+=u+7>>3;break;case 21:if(l.length>2&&!h){x=l.shift()+_;h=true}p+=l.pop();f+=l.pop();b(f,p);break;case 22:if(l.length>1&&!h){x=l.shift()+_;h=true}f+=l.pop();b(f,p);break;case 23:w();break;case 24:while(l.length>2){n=f+l.shift();i=p+l.shift();a=n+l.shift();o=i+l.shift();f=a+l.shift();p=o+l.shift();s.curveTo(n,i,a,o,f,p)}f+=l.shift();p+=l.shift();s.lineTo(f,p);break;case 25:while(l.length>6){f+=l.shift();p+=l.shift();s.lineTo(f,p)}n=f+l.shift();i=p+l.shift();a=n+l.shift();o=i+l.shift();f=a+l.shift();p=o+l.shift();s.curveTo(n,i,a,o,f,p);break;case 26:if(l.length%2){f+=l.shift()}while(l.length>0){n=f;i=p+l.shift();a=n+l.shift();o=i+l.shift();f=a;p=o+l.shift();s.curveTo(n,i,a,o,f,p)}break;case 27:if(l.length%2){p+=l.shift()}while(l.length>0){n=f+l.shift();i=p;a=n+l.shift();o=i+l.shift();f=a+l.shift();p=o;s.curveTo(n,i,a,o,f,p)}break;case 28:m=r[D];g=r[D+1];l.push((m<<24|g<<16)>>16);D+=2;break;case 29:S=l.pop()+e.gsubrsBias;M=e.gsubrs[S];if(M){T(M)}break;case 30:while(l.length>0){n=f;i=p+l.shift();a=n+l.shift();o=i+l.shift();f=a+l.shift();p=o+(l.length===1?l.shift():0);s.curveTo(n,i,a,o,f,p);if(l.length===0){break}n=f+l.shift();i=p;a=n+l.shift();o=i+l.shift();p=o+l.shift();f=a+(l.length===1?l.shift():0);s.curveTo(n,i,a,o,f,p)}break;case 31:while(l.length>0){n=f+l.shift();i=p;a=n+l.shift();o=i+l.shift();p=o+l.shift();f=a+(l.length===1?l.shift():0);s.curveTo(n,i,a,o,f,p);if(l.length===0){break}n=f;i=p+l.shift();a=n+l.shift();o=i+l.shift();f=a+l.shift();p=o+(l.length===1?l.shift():0);s.curveTo(n,i,a,o,f,p)}break;default:if(O<32){console.log("Glyph "+t.index+": unknown operator "+O)}else if(O<247){l.push(O-139)}else if(O<251){m=r[D];D+=1;l.push((O-247)*256+m+108)}else if(O<255){m=r[D];D+=1;l.push(-(O-251)*256-m-108)}else{m=r[D];g=r[D+1];y=r[D+2];E=r[D+3];D+=4;l.push((m<<24|g<<16|y<<8|E)/65536)}}}}T(r);t.advanceWidth=x;return s}function mh(e,t,r,n){var i=[];var a;var o=new _u.Parser(e,t);var s=o.parseCard8();if(s===0){for(var l=0;l<r;l++){a=o.parseCard8();if(a>=n){throw new Error("CFF table CID Font FDSelect has bad FD index value "+a+" (FD count "+n+")")}i.push(a)}}else if(s===3){var u=o.parseCard16();var h=o.parseCard16();if(h!==0){throw new Error("CFF Table CID Font FDSelect format 3 range has bad initial GID "+h)}var c;for(var f=0;f<u;f++){a=o.parseCard8();c=o.parseCard16();if(a>=n){throw new Error("CFF table CID Font FDSelect has bad FD index value "+a+" (FD count "+n+")")}if(c>r){throw new Error("CFF Table CID Font FDSelect format 3 range has bad GID "+c)}for(;h<c;h++){i.push(a)}h=c}if(c!==r){throw new Error("CFF Table CID Font FDSelect format 3 range has bad final GID "+c)}}else{throw new Error("CFF Table CID Font FDSelect table has unsupported format "+s)}return i}function _h(e,t,r){r.tables.cff={};var n=sh(e,t);var i=eh(e,n.endOffset,_u.bytesToString);var a=eh(e,i.endOffset);var o=eh(e,a.endOffset,_u.bytesToString);var s=eh(e,o.endOffset);r.gsubrs=s.objects;r.gsubrsBias=$u(r.gsubrs);var l=fh(e,t,a.objects,o.objects);if(l.length!==1){throw new Error("CFF table has too many fonts in 'FontSet' - count of fonts NameIndex.length = "+l.length)}var u=l[0];r.tables.cff.topDict=u;if(u._privateDict){r.defaultWidthX=u._privateDict.defaultWidthX;r.nominalWidthX=u._privateDict.nominalWidthX}if(u.ros[0]!==undefined&&u.ros[1]!==undefined){r.isCIDFont=true}if(r.isCIDFont){var h=u.fdArray;var c=u.fdSelect;if(h===0||c===0){throw new Error("Font is marked as a CID font, but FDArray and/or FDSelect information is missing")}h+=t;var f=eh(e,h);var p=fh(e,t,f.objects,o.objects);u._fdArray=p;c+=t;u._fdSelect=mh(e,c,r.numGlyphs,p.length)}var d=t+u.private[1];var v=ch(e,d,u.private[0],o.objects);r.defaultWidthX=v.defaultWidthX;r.nominalWidthX=v.nominalWidthX;if(v.subrs!==0){var m=d+v.subrs;var _=eh(e,m);r.subrs=_.objects;r.subrsBias=$u(r.subrs)}else{r.subrs=[];r.subrsBias=0}var g=eh(e,t+u.charStrings);r.nGlyphs=g.objects.length;var y=ph(e,t+u.charset,r.nGlyphs,o.objects);if(u.encoding===0){r.cffEncoding=new Iu(Mu,y)}else if(u.encoding===1){r.cffEncoding=new Iu(Au,y)}else{r.cffEncoding=dh(e,t+u.encoding,y)}r.encoding=r.encoding||r.cffEncoding;r.glyphs=new Qu.GlyphSet(r);for(var x=0;x<r.nGlyphs;x+=1){var b=g.objects[x];r.glyphs.push(x,Qu.cffGlyphLoader(r,x,vh,b))}}function gh(e,t){var r;var n=Su.indexOf(e);if(n>=0){r=n}n=t.indexOf(e);if(n>=0){r=n+Su.length}else{r=Su.length+t.length;t.push(e)}return r}function yh(){return new iu.Record("Header",[{name:"major",type:"Card8",value:1},{name:"minor",type:"Card8",value:0},{name:"hdrSize",type:"Card8",value:4},{name:"major",type:"Card8",value:1}])}function xh(e){var t=new iu.Record("Name INDEX",[{name:"names",type:"INDEX",value:[]}]);t.names=[];for(var r=0;r<e.length;r+=1){t.names.push({name:"name_"+r,type:"NAME",value:e[r]})}return t}function bh(e,t,r){var n={};for(var i=0;i<e.length;i+=1){var a=e[i];var o=t[a.name];if(o!==undefined&&!Ju(o,a.value)){if(a.type==="SID"){o=gh(o,r)}n[a.op]={name:a.name,type:a.type,value:o}}}return n}function wh(e,t){var r=new iu.Record("Top DICT",[{name:"dict",type:"DICT",value:{}}]);r.dict=bh(lh,e,t);return r}function Th(e){var t=new iu.Record("Top DICT INDEX",[{name:"topDicts",type:"INDEX",value:[]}]);t.topDicts=[{name:"topDict_0",type:"TABLE",value:e}];return t}function Eh(e){var t=new iu.Record("String INDEX",[{name:"strings",type:"INDEX",value:[]}]);t.strings=[];for(var r=0;r<e.length;r+=1){t.strings.push({name:"string_"+r,type:"STRING",value:e[r]})}return t}function Sh(){return new iu.Record("Global Subr INDEX",[{name:"subrs",type:"INDEX",value:[]}])}function Mh(e,t){var r=new iu.Record("Charsets",[{name:"format",type:"Card8",value:0}]);for(var n=0;n<e.length;n+=1){var i=e[n];var a=gh(i,t);r.fields.push({name:"glyph_"+n,type:"SID",value:a})}return r}function Ah(e){var t=[];var r=e.path;t.push({name:"width",type:"NUMBER",value:e.advanceWidth});var n=0;var i=0;for(var a=0;a<r.commands.length;a+=1){var o=void 0;var s=void 0;var l=r.commands[a];if(l.type==="Q"){var u=1/3;var h=2/3;l={type:"C",x:l.x,y:l.y,x1:u*n+h*l.x1,y1:u*i+h*l.y1,x2:u*l.x+h*l.x1,y2:u*l.y+h*l.y1}}if(l.type==="M"){o=Math.round(l.x-n);s=Math.round(l.y-i);t.push({name:"dx",type:"NUMBER",value:o});t.push({name:"dy",type:"NUMBER",value:s});t.push({name:"rmoveto",type:"OP",value:21});n=Math.round(l.x);i=Math.round(l.y)}else if(l.type==="L"){o=Math.round(l.x-n);s=Math.round(l.y-i);t.push({name:"dx",type:"NUMBER",value:o});t.push({name:"dy",type:"NUMBER",value:s});t.push({name:"rlineto",type:"OP",value:5});n=Math.round(l.x);i=Math.round(l.y)}else if(l.type==="C"){var c=Math.round(l.x1-n);var f=Math.round(l.y1-i);var p=Math.round(l.x2-l.x1);var d=Math.round(l.y2-l.y1);o=Math.round(l.x-l.x2);s=Math.round(l.y-l.y2);t.push({name:"dx1",type:"NUMBER",value:c});t.push({name:"dy1",type:"NUMBER",value:f});t.push({name:"dx2",type:"NUMBER",value:p});t.push({name:"dy2",type:"NUMBER",value:d});t.push({name:"dx",type:"NUMBER",value:o});t.push({name:"dy",type:"NUMBER",value:s});t.push({name:"rrcurveto",type:"OP",value:8});n=Math.round(l.x);i=Math.round(l.y)}}t.push({name:"endchar",type:"OP",value:14});return t}function Rh(e){var t=new iu.Record("CharStrings INDEX",[{name:"charStrings",type:"INDEX",value:[]}]);for(var r=0;r<e.length;r+=1){var n=e.get(r);var i=Ah(n);t.charStrings.push({name:n.name,type:"CHARSTRING",value:i})}return t}function Lh(e,t){var r=new iu.Record("Private DICT",[{name:"dict",type:"DICT",value:{}}]);r.dict=bh(uh,e,t);return r}function Ch(e,t){var r=new iu.Table("CFF ",[{name:"header",type:"RECORD"},{name:"nameIndex",type:"RECORD"},{name:"topDictIndex",type:"RECORD"},{name:"stringIndex",type:"RECORD"},{name:"globalSubrIndex",type:"RECORD"},{name:"charsets",type:"RECORD"},{name:"charStringsIndex",type:"RECORD"},{name:"privateDict",type:"RECORD"}]);var n=1/t.unitsPerEm;var i={version:t.version,fullName:t.fullName,familyName:t.familyName,weight:t.weightName,fontBBox:t.fontBBox||[0,0,0,0],fontMatrix:[n,0,0,n,0,0],charset:999,encoding:0,charStrings:999,private:[0,999]};var a={};var o=[];var s;for(var l=1;l<e.length;l+=1){s=e.get(l);o.push(s.name)}var u=[];r.header=yh();r.nameIndex=xh([t.postScriptName]);var h=wh(i,u);r.topDictIndex=Th(h);r.globalSubrIndex=Sh();r.charsets=Mh(o,u);r.charStringsIndex=Rh(e);r.privateDict=Lh(a,u);r.stringIndex=Eh(u);var c=r.header.sizeOf()+r.nameIndex.sizeOf()+r.topDictIndex.sizeOf()+r.stringIndex.sizeOf()+r.globalSubrIndex.sizeOf();i.charset=c;i.encoding=0;i.charStrings=i.charset+r.charsets.sizeOf();i.private[1]=i.charStrings+r.charStringsIndex.sizeOf();h=wh(i,u);r.topDictIndex=Th(h);return r}var Ih={parse:_h,make:Ch};function Uh(e,t){var r={};var n=new _u.Parser(e,t);r.version=n.parseVersion();r.fontRevision=Math.round(n.parseFixed()*1e3)/1e3;r.checkSumAdjustment=n.parseULong();r.magicNumber=n.parseULong();Ol.argument(r.magicNumber===1594834165,"Font header has wrong magic number.");r.flags=n.parseUShort();r.unitsPerEm=n.parseUShort();r.created=n.parseLongDateTime();r.modified=n.parseLongDateTime();r.xMin=n.parseShort();r.yMin=n.parseShort();r.xMax=n.parseShort();r.yMax=n.parseShort();r.macStyle=n.parseUShort();r.lowestRecPPEM=n.parseUShort();r.fontDirectionHint=n.parseShort();r.indexToLocFormat=n.parseShort();r.glyphDataFormat=n.parseShort();return r}function Dh(e){var t=Math.round((new Date).getTime()/1e3)+2082844800;var r=t;if(e.createdTimestamp){r=e.createdTimestamp+2082844800}return new iu.Table("head",[{name:"version",type:"FIXED",value:65536},{name:"fontRevision",type:"FIXED",value:65536},{name:"checkSumAdjustment",type:"ULONG",value:0},{name:"magicNumber",type:"ULONG",value:1594834165},{name:"flags",type:"USHORT",value:0},{name:"unitsPerEm",type:"USHORT",value:1e3},{name:"created",type:"LONGDATETIME",value:r},{name:"modified",type:"LONGDATETIME",value:t},{name:"xMin",type:"SHORT",value:0},{name:"yMin",type:"SHORT",value:0},{name:"xMax",type:"SHORT",value:0},{name:"yMax",type:"SHORT",value:0},{name:"macStyle",type:"USHORT",value:0},{name:"lowestRecPPEM",type:"USHORT",value:0},{name:"fontDirectionHint",type:"SHORT",value:2},{name:"indexToLocFormat",type:"SHORT",value:0},{name:"glyphDataFormat",type:"SHORT",value:0}],e)}var Oh={parse:Uh,make:Dh};function Bh(e,t){var r={};var n=new _u.Parser(e,t);r.version=n.parseVersion();r.ascender=n.parseShort();r.descender=n.parseShort();r.lineGap=n.parseShort();r.advanceWidthMax=n.parseUShort();r.minLeftSideBearing=n.parseShort();r.minRightSideBearing=n.parseShort();r.xMaxExtent=n.parseShort();r.caretSlopeRise=n.parseShort();r.caretSlopeRun=n.parseShort();r.caretOffset=n.parseShort();n.relativeOffset+=8;r.metricDataFormat=n.parseShort();r.numberOfHMetrics=n.parseUShort();return r}function Ph(e){return new iu.Table("hhea",[{name:"version",type:"FIXED",value:65536},{name:"ascender",type:"FWORD",value:0},{name:"descender",type:"FWORD",value:0},{name:"lineGap",type:"FWORD",value:0},{name:"advanceWidthMax",type:"UFWORD",value:0},{name:"minLeftSideBearing",type:"FWORD",value:0},{name:"minRightSideBearing",type:"FWORD",value:0},{name:"xMaxExtent",type:"FWORD",value:0},{name:"caretSlopeRise",type:"SHORT",value:1},{name:"caretSlopeRun",type:"SHORT",value:0},{name:"caretOffset",type:"SHORT",value:0},{name:"reserved1",type:"SHORT",value:0},{name:"reserved2",type:"SHORT",value:0},{name:"reserved3",type:"SHORT",value:0},{name:"reserved4",type:"SHORT",value:0},{name:"metricDataFormat",type:"SHORT",value:0},{name:"numberOfHMetrics",type:"USHORT",value:0}],e)}var Fh={parse:Bh,make:Ph};function zh(e,t,r,n,i){var a;var o;var s=new _u.Parser(e,t);for(var l=0;l<n;l+=1){if(l<r){a=s.parseUShort();o=s.parseShort()}var u=i.get(l);u.advanceWidth=a;u.leftSideBearing=o}}function Nh(e){var t=new iu.Table("hmtx",[]);for(var r=0;r<e.length;r+=1){var n=e.get(r);var i=n.advanceWidth||0;var a=n.leftSideBearing||0;t.fields.push({name:"advanceWidth_"+r,type:"USHORT",value:i});t.fields.push({name:"leftSideBearing_"+r,type:"SHORT",value:a})}return t}var kh={parse:zh,make:Nh};function Vh(e){var t=new iu.Table("ltag",[{name:"version",type:"ULONG",value:1},{name:"flags",type:"ULONG",value:0},{name:"numTags",type:"ULONG",value:e.length}]);var r="";var n=12+e.length*4;for(var i=0;i<e.length;++i){var a=r.indexOf(e[i]);if(a<0){a=r.length;r+=e[i]}t.fields.push({name:"offset "+i,type:"USHORT",value:n+a});t.fields.push({name:"length "+i,type:"USHORT",value:e[i].length})}t.fields.push({name:"stringPool",type:"CHARARRAY",value:r});return t}function Gh(e,t){var r=new _u.Parser(e,t);var n=r.parseULong();Ol.argument(n===1,"Unsupported ltag table version.");r.skip("uLong",1);var i=r.parseULong();var a=[];for(var o=0;o<i;o++){var s="";var l=t+r.parseUShort();var u=r.parseUShort();for(var h=l;h<l+u;++h){s+=String.fromCharCode(e.getInt8(h))}a.push(s)}return a}var Wh={make:Vh,parse:Gh};function Hh(e,t){var r={};var n=new _u.Parser(e,t);r.version=n.parseVersion();r.numGlyphs=n.parseUShort();if(r.version===1){r.maxPoints=n.parseUShort();r.maxContours=n.parseUShort();r.maxCompositePoints=n.parseUShort();r.maxCompositeContours=n.parseUShort();r.maxZones=n.parseUShort();r.maxTwilightPoints=n.parseUShort();r.maxStorage=n.parseUShort();r.maxFunctionDefs=n.parseUShort();r.maxInstructionDefs=n.parseUShort();r.maxStackElements=n.parseUShort();r.maxSizeOfInstructions=n.parseUShort();r.maxComponentElements=n.parseUShort();r.maxComponentDepth=n.parseUShort()}return r}function jh(e){return new iu.Table("maxp",[{name:"version",type:"FIXED",value:20480},{name:"numGlyphs",type:"USHORT",value:e}])}var qh={parse:Hh,make:jh};var Xh=["copyright","fontFamily","fontSubfamily","uniqueID","fullName","version","postScriptName","trademark","manufacturer","designer","description","manufacturerURL","designerURL","license","licenseURL","reserved","preferredFamily","preferredSubfamily","compatibleFullName","sampleText","postScriptFindFontName","wwsFamily","wwsSubfamily"];var Yh={0:"en",1:"fr",2:"de",3:"it",4:"nl",5:"sv",6:"es",7:"da",8:"pt",9:"no",10:"he",11:"ja",12:"ar",13:"fi",14:"el",15:"is",16:"mt",17:"tr",18:"hr",19:"zh-Hant",20:"ur",21:"hi",22:"th",23:"ko",24:"lt",25:"pl",26:"hu",27:"es",28:"lv",29:"se",30:"fo",31:"fa",32:"ru",33:"zh",34:"nl-BE",35:"ga",36:"sq",37:"ro",38:"cz",39:"sk",40:"si",41:"yi",42:"sr",43:"mk",44:"bg",45:"uk",46:"be",47:"uz",48:"kk",49:"az-Cyrl",50:"az-Arab",51:"hy",52:"ka",53:"mo",54:"ky",55:"tg",56:"tk",57:"mn-CN",58:"mn",59:"ps",60:"ks",61:"ku",62:"sd",63:"bo",64:"ne",65:"sa",66:"mr",67:"bn",68:"as",69:"gu",70:"pa",71:"or",72:"ml",73:"kn",74:"ta",75:"te",76:"si",77:"my",78:"km",79:"lo",80:"vi",81:"id",82:"tl",83:"ms",84:"ms-Arab",85:"am",86:"ti",87:"om",88:"so",89:"sw",90:"rw",91:"rn",92:"ny",93:"mg",94:"eo",128:"cy",129:"eu",130:"ca",131:"la",132:"qu",133:"gn",134:"ay",135:"tt",136:"ug",137:"dz",138:"jv",139:"su",140:"gl",141:"af",142:"br",143:"iu",144:"gd",145:"gv",146:"ga",147:"to",148:"el-polyton",149:"kl",150:"az",151:"nn"};var Kh={0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:5,11:1,12:4,13:0,14:6,15:0,16:0,17:0,18:0,19:2,20:4,21:9,22:21,23:3,24:29,25:29,26:29,27:29,28:29,29:0,30:0,31:4,32:7,33:25,34:0,35:0,36:0,37:0,38:29,39:29,40:0,41:5,42:7,43:7,44:7,45:7,46:7,47:7,48:7,49:7,50:4,51:24,52:23,53:7,54:7,55:7,56:7,57:27,58:7,59:4,60:4,61:4,62:4,63:26,64:9,65:9,66:9,67:13,68:13,69:11,70:10,71:12,72:17,73:16,74:14,75:15,76:18,77:19,78:20,79:22,80:30,81:0,82:0,83:0,84:4,85:28,86:28,87:28,88:0,89:0,90:0,91:0,92:0,93:0,94:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:7,136:4,137:26,138:0,139:0,140:0,141:0,142:0,143:28,144:0,145:0,146:0,147:0,148:6,149:0,150:0,151:0};var Zh={1078:"af",1052:"sq",1156:"gsw",1118:"am",5121:"ar-DZ",15361:"ar-BH",3073:"ar",2049:"ar-IQ",11265:"ar-JO",13313:"ar-KW",12289:"ar-LB",4097:"ar-LY",6145:"ary",8193:"ar-OM",16385:"ar-QA",1025:"ar-SA",10241:"ar-SY",7169:"aeb",14337:"ar-AE",9217:"ar-YE",1067:"hy",1101:"as",2092:"az-Cyrl",1068:"az",1133:"ba",1069:"eu",1059:"be",2117:"bn",1093:"bn-IN",8218:"bs-Cyrl",5146:"bs",1150:"br",1026:"bg",1027:"ca",3076:"zh-HK",5124:"zh-MO",2052:"zh",4100:"zh-SG",1028:"zh-TW",1155:"co",1050:"hr",4122:"hr-BA",1029:"cs",1030:"da",1164:"prs",1125:"dv",2067:"nl-BE",1043:"nl",3081:"en-AU",10249:"en-BZ",4105:"en-CA",9225:"en-029",16393:"en-IN",6153:"en-IE",8201:"en-JM",17417:"en-MY",5129:"en-NZ",13321:"en-PH",18441:"en-SG",7177:"en-ZA",11273:"en-TT",2057:"en-GB",1033:"en",12297:"en-ZW",1061:"et",1080:"fo",1124:"fil",1035:"fi",2060:"fr-BE",3084:"fr-CA",1036:"fr",5132:"fr-LU",6156:"fr-MC",4108:"fr-CH",1122:"fy",1110:"gl",1079:"ka",3079:"de-AT",1031:"de",5127:"de-LI",4103:"de-LU",2055:"de-CH",1032:"el",1135:"kl",1095:"gu",1128:"ha",1037:"he",1081:"hi",1038:"hu",1039:"is",1136:"ig",1057:"id",1117:"iu",2141:"iu-Latn",2108:"ga",1076:"xh",1077:"zu",1040:"it",2064:"it-CH",1041:"ja",1099:"kn",1087:"kk",1107:"km",1158:"quc",1159:"rw",1089:"sw",1111:"kok",1042:"ko",1088:"ky",1108:"lo",1062:"lv",1063:"lt",2094:"dsb",1134:"lb",1071:"mk",2110:"ms-BN",1086:"ms",1100:"ml",1082:"mt",1153:"mi",1146:"arn",1102:"mr",1148:"moh",1104:"mn",2128:"mn-CN",1121:"ne",1044:"nb",2068:"nn",1154:"oc",1096:"or",1123:"ps",1045:"pl",1046:"pt",2070:"pt-PT",1094:"pa",1131:"qu-BO",2155:"qu-EC",3179:"qu",1048:"ro",1047:"rm",1049:"ru",9275:"smn",4155:"smj-NO",5179:"smj",3131:"se-FI",1083:"se",2107:"se-SE",8251:"sms",6203:"sma-NO",7227:"sms",1103:"sa",7194:"sr-Cyrl-BA",3098:"sr",6170:"sr-Latn-BA",2074:"sr-Latn",1132:"nso",1074:"tn",1115:"si",1051:"sk",1060:"sl",11274:"es-AR",16394:"es-BO",13322:"es-CL",9226:"es-CO",5130:"es-CR",7178:"es-DO",12298:"es-EC",17418:"es-SV",4106:"es-GT",18442:"es-HN",2058:"es-MX",19466:"es-NI",6154:"es-PA",15370:"es-PY",10250:"es-PE",20490:"es-PR",3082:"es",1034:"es",21514:"es-US",14346:"es-UY",8202:"es-VE",2077:"sv-FI",1053:"sv",1114:"syr",1064:"tg",2143:"tzm",1097:"ta",1092:"tt",1098:"te",1054:"th",1105:"bo",1055:"tr",1090:"tk",1152:"ug",1058:"uk",1070:"hsb",1056:"ur",2115:"uz-Cyrl",1091:"uz",1066:"vi",1106:"cy",1160:"wo",1157:"sah",1144:"ii",1130:"yo"};function Qh(e,t,r){switch(e){case 0:if(t===65535){return"und"}else if(r){return r[t]}break;case 1:return Yh[t];case 3:return Zh[t]}return undefined}var Jh="utf-16";var $h={0:"macintosh",1:"x-mac-japanese",2:"x-mac-chinesetrad",3:"x-mac-korean",6:"x-mac-greek",7:"x-mac-cyrillic",9:"x-mac-devanagai",10:"x-mac-gurmukhi",11:"x-mac-gujarati",12:"x-mac-oriya",13:"x-mac-bengali",14:"x-mac-tamil",15:"x-mac-telugu",16:"x-mac-kannada",17:"x-mac-malayalam",18:"x-mac-sinhalese",19:"x-mac-burmese",20:"x-mac-khmer",21:"x-mac-thai",22:"x-mac-lao",23:"x-mac-georgian",24:"x-mac-armenian",25:"x-mac-chinesesimp",26:"x-mac-tibetan",27:"x-mac-mongolian",28:"x-mac-ethiopic",29:"x-mac-ce",30:"x-mac-vietnamese",31:"x-mac-extarabic"};var ec={15:"x-mac-icelandic",17:"x-mac-turkish",18:"x-mac-croatian",24:"x-mac-ce",25:"x-mac-ce",26:"x-mac-ce",27:"x-mac-ce",28:"x-mac-ce",30:"x-mac-icelandic",37:"x-mac-romanian",38:"x-mac-ce",39:"x-mac-ce",40:"x-mac-ce",143:"x-mac-inuit",146:"x-mac-gaelic"};function tc(e,t,r){switch(e){case 0:return Jh;case 1:return ec[r]||$h[t];case 3:if(t===1||t===10){return Jh}break}return undefined}function rc(e,t,r){var n={};var i=new _u.Parser(e,t);var a=i.parseUShort();var o=i.parseUShort();var s=i.offset+i.parseUShort();for(var l=0;l<o;l++){var u=i.parseUShort();var h=i.parseUShort();var c=i.parseUShort();var f=i.parseUShort();var p=Xh[f]||f;var d=i.parseUShort();var v=i.parseUShort();var m=Qh(u,c,r);var _=tc(u,h,c);if(_!==undefined&&m!==undefined){var g=void 0;if(_===Jh){g=Fl.UTF16(e,s+v,d)}else{g=Fl.MACSTRING(e,s+v,d,_)}if(g){var y=n[p];if(y===undefined){y=n[p]={}}y[m]=g}}}var x=0;if(a===1){x=i.parseUShort()}return n}function nc(e){var t={};for(var r in e){t[e[r]]=parseInt(r)}return t}function ic(e,t,r,n,i,a){return new iu.Record("NameRecord",[{name:"platformID",type:"USHORT",value:e},{name:"encodingID",type:"USHORT",value:t},{name:"languageID",type:"USHORT",value:r},{name:"nameID",type:"USHORT",value:n},{name:"length",type:"USHORT",value:i},{name:"offset",type:"USHORT",value:a}])}function ac(e,t){var r=e.length;var n=t.length-r+1;e:for(var i=0;i<n;i++){for(;i<n;i++){for(var a=0;a<r;a++){if(t[i+a]!==e[a]){continue e}}return i}}return-1}function oc(e,t){var r=ac(e,t);if(r<0){r=t.length;var n=0;var i=e.length;for(;n<i;++n){t.push(e[n])}}return r}function sc(e,t){var r;var n=[];var i={};var a=nc(Xh);for(var o in e){var s=a[o];if(s===undefined){s=o}r=parseInt(s);if(isNaN(r)){throw new Error('Name table entry "'+o+'" does not exist, see nameTableNames for complete list.')}i[r]=e[o];n.push(r)}var l=nc(Yh);var u=nc(Zh);var h=[];var c=[];for(var f=0;f<n.length;f++){r=n[f];var p=i[r];for(var d in p){var v=p[d];var m=1;var _=l[d];var g=Kh[_];var y=tc(m,g,_);var x=zl.MACSTRING(v,y);if(x===undefined){m=0;_=t.indexOf(d);if(_<0){_=t.length;t.push(d)}g=4;x=zl.UTF16(v)}var b=oc(x,c);h.push(ic(m,g,_,r,x.length,b));var w=u[d];if(w!==undefined){var T=zl.UTF16(v);var E=oc(T,c);h.push(ic(3,1,w,r,T.length,E))}}}h.sort(function(e,t){return e.platformID-t.platformID||e.encodingID-t.encodingID||e.languageID-t.languageID||e.nameID-t.nameID});var S=new iu.Table("name",[{name:"format",type:"USHORT",value:0},{name:"count",type:"USHORT",value:h.length},{name:"stringOffset",type:"USHORT",value:6+h.length*12}]);for(var M=0;M<h.length;M++){S.fields.push({name:"record_"+M,type:"RECORD",value:h[M]})}S.fields.push({name:"strings",type:"LITERAL",value:c});return S}var lc={parse:rc,make:sc};var uc=[{begin:0,end:127},{begin:128,end:255},{begin:256,end:383},{begin:384,end:591},{begin:592,end:687},{begin:688,end:767},{begin:768,end:879},{begin:880,end:1023},{begin:11392,end:11519},{begin:1024,end:1279},{begin:1328,end:1423},{begin:1424,end:1535},{begin:42240,end:42559},{begin:1536,end:1791},{begin:1984,end:2047},{begin:2304,end:2431},{begin:2432,end:2559},{begin:2560,end:2687},{begin:2688,end:2815},{begin:2816,end:2943},{begin:2944,end:3071},{begin:3072,end:3199},{begin:3200,end:3327},{begin:3328,end:3455},{begin:3584,end:3711},{begin:3712,end:3839},{begin:4256,end:4351},{begin:6912,end:7039},{begin:4352,end:4607},{begin:7680,end:7935},{begin:7936,end:8191},{begin:8192,end:8303},{begin:8304,end:8351},{begin:8352,end:8399},{begin:8400,end:8447},{begin:8448,end:8527},{begin:8528,end:8591},{begin:8592,end:8703},{begin:8704,end:8959},{begin:8960,end:9215},{begin:9216,end:9279},{begin:9280,end:9311},{begin:9312,end:9471},{begin:9472,end:9599},{begin:9600,end:9631},{begin:9632,end:9727},{begin:9728,end:9983},{begin:9984,end:10175},{begin:12288,end:12351},{begin:12352,end:12447},{begin:12448,end:12543},{begin:12544,end:12591},{begin:12592,end:12687},{begin:43072,end:43135},{begin:12800,end:13055},{begin:13056,end:13311},{begin:44032,end:55215},{begin:55296,end:57343},{begin:67840,end:67871},{begin:19968,end:40959},{begin:57344,end:63743},{begin:12736,end:12783},{begin:64256,end:64335},{begin:64336,end:65023},{begin:65056,end:65071},{begin:65040,end:65055},{begin:65104,end:65135},{begin:65136,end:65279},{begin:65280,end:65519},{begin:65520,end:65535},{begin:3840,end:4095},{begin:1792,end:1871},{begin:1920,end:1983},{begin:3456,end:3583},{begin:4096,end:4255},{begin:4608,end:4991},{begin:5024,end:5119},{begin:5120,end:5759},{begin:5760,end:5791},{begin:5792,end:5887},{begin:6016,end:6143},{begin:6144,end:6319},{begin:10240,end:10495},{begin:40960,end:42127},{begin:5888,end:5919},{begin:66304,end:66351},{begin:66352,end:66383},{begin:66560,end:66639},{begin:118784,end:119039},{begin:119808,end:120831},{begin:1044480,end:1048573},{begin:65024,end:65039},{begin:917504,end:917631},{begin:6400,end:6479},{begin:6480,end:6527},{begin:6528,end:6623},{begin:6656,end:6687},{begin:11264,end:11359},{begin:11568,end:11647},{begin:19904,end:19967},{begin:43008,end:43055},{begin:65536,end:65663},{begin:65856,end:65935},{begin:66432,end:66463},{begin:66464,end:66527},{begin:66640,end:66687},{begin:66688,end:66735},{begin:67584,end:67647},{begin:68096,end:68191},{begin:119552,end:119647},{begin:73728,end:74751},{begin:119648,end:119679},{begin:7040,end:7103},{begin:7168,end:7247},{begin:7248,end:7295},{begin:43136,end:43231},{begin:43264,end:43311},{begin:43312,end:43359},{begin:43520,end:43615},{begin:65936,end:65999},{begin:66e3,end:66047},{begin:66208,end:66271},{begin:127024,end:127135}];function hc(e){for(var t=0;t<uc.length;t+=1){var r=uc[t];if(e>=r.begin&&e<r.end){return t}}return-1}function cc(e,t){var r={};var n=new _u.Parser(e,t);r.version=n.parseUShort();r.xAvgCharWidth=n.parseShort();r.usWeightClass=n.parseUShort();r.usWidthClass=n.parseUShort();r.fsType=n.parseUShort();r.ySubscriptXSize=n.parseShort();r.ySubscriptYSize=n.parseShort();r.ySubscriptXOffset=n.parseShort();r.ySubscriptYOffset=n.parseShort();r.ySuperscriptXSize=n.parseShort();r.ySuperscriptYSize=n.parseShort();r.ySuperscriptXOffset=n.parseShort();r.ySuperscriptYOffset=n.parseShort();r.yStrikeoutSize=n.parseShort();r.yStrikeoutPosition=n.parseShort();r.sFamilyClass=n.parseShort();r.panose=[];for(var i=0;i<10;i++){r.panose[i]=n.parseByte()}r.ulUnicodeRange1=n.parseULong();r.ulUnicodeRange2=n.parseULong();r.ulUnicodeRange3=n.parseULong();r.ulUnicodeRange4=n.parseULong();r.achVendID=String.fromCharCode(n.parseByte(),n.parseByte(),n.parseByte(),n.parseByte());r.fsSelection=n.parseUShort();r.usFirstCharIndex=n.parseUShort();r.usLastCharIndex=n.parseUShort();r.sTypoAscender=n.parseShort();r.sTypoDescender=n.parseShort();r.sTypoLineGap=n.parseShort();r.usWinAscent=n.parseUShort();r.usWinDescent=n.parseUShort();if(r.version>=1){r.ulCodePageRange1=n.parseULong();r.ulCodePageRange2=n.parseULong()}if(r.version>=2){r.sxHeight=n.parseShort();r.sCapHeight=n.parseShort();r.usDefaultChar=n.parseUShort();r.usBreakChar=n.parseUShort();r.usMaxContent=n.parseUShort()}return r}function fc(e){return new iu.Table("OS/2",[{name:"version",type:"USHORT",value:3},{name:"xAvgCharWidth",type:"SHORT",value:0},{name:"usWeightClass",type:"USHORT",value:0},{name:"usWidthClass",type:"USHORT",value:0},{name:"fsType",type:"USHORT",value:0},{name:"ySubscriptXSize",type:"SHORT",value:650},{name:"ySubscriptYSize",type:"SHORT",value:699},{name:"ySubscriptXOffset",type:"SHORT",value:0},{name:"ySubscriptYOffset",type:"SHORT",value:140},{name:"ySuperscriptXSize",type:"SHORT",value:650},{name:"ySuperscriptYSize",type:"SHORT",value:699},{name:"ySuperscriptXOffset",type:"SHORT",value:0},{name:"ySuperscriptYOffset",type:"SHORT",value:479},{name:"yStrikeoutSize",type:"SHORT",value:49},{name:"yStrikeoutPosition",type:"SHORT",value:258},{name:"sFamilyClass",type:"SHORT",value:0},{name:"bFamilyType",type:"BYTE",value:0},{name:"bSerifStyle",type:"BYTE",value:0},{name:"bWeight",type:"BYTE",value:0},{name:"bProportion",type:"BYTE",value:0},{name:"bContrast",type:"BYTE",value:0},{name:"bStrokeVariation",type:"BYTE",value:0},{name:"bArmStyle",type:"BYTE",value:0},{name:"bLetterform",type:"BYTE",value:0},{name:"bMidline",type:"BYTE",value:0},{name:"bXHeight",type:"BYTE",value:0},{name:"ulUnicodeRange1",type:"ULONG",value:0},{name:"ulUnicodeRange2",type:"ULONG",value:0},{name:"ulUnicodeRange3",type:"ULONG",value:0},{name:"ulUnicodeRange4",type:"ULONG",value:0},{name:"achVendID",type:"CHARARRAY",value:"XXXX"},{name:"fsSelection",type:"USHORT",value:0},{name:"usFirstCharIndex",type:"USHORT",value:0},{name:"usLastCharIndex",type:"USHORT",value:0},{name:"sTypoAscender",type:"SHORT",value:0},{name:"sTypoDescender",type:"SHORT",value:0},{name:"sTypoLineGap",type:"SHORT",value:0},{name:"usWinAscent",type:"USHORT",value:0},{name:"usWinDescent",type:"USHORT",value:0},{name:"ulCodePageRange1",type:"ULONG",value:0},{name:"ulCodePageRange2",type:"ULONG",value:0},{name:"sxHeight",type:"SHORT",value:0},{name:"sCapHeight",type:"SHORT",value:0},{name:"usDefaultChar",type:"USHORT",value:0},{name:"usBreakChar",type:"USHORT",value:0},{name:"usMaxContext",type:"USHORT",value:0}],e)}var pc={parse:cc,make:fc,unicodeRanges:uc,getUnicodeRange:hc};function dc(e,t){var r={};var n=new _u.Parser(e,t);r.version=n.parseVersion();r.italicAngle=n.parseFixed();r.underlinePosition=n.parseShort();r.underlineThickness=n.parseShort();r.isFixedPitch=n.parseULong();r.minMemType42=n.parseULong();r.maxMemType42=n.parseULong();r.minMemType1=n.parseULong();r.maxMemType1=n.parseULong();switch(r.version){case 1:r.names=Ru.slice();break;case 2:r.numberOfGlyphs=n.parseUShort();r.glyphNameIndex=new Array(r.numberOfGlyphs);for(var i=0;i<r.numberOfGlyphs;i++){r.glyphNameIndex[i]=n.parseUShort()}r.names=[];for(var a=0;a<r.numberOfGlyphs;a++){if(r.glyphNameIndex[a]>=Ru.length){var o=n.parseChar();r.names.push(n.parseString(o))}}break;case 2.5:r.numberOfGlyphs=n.parseUShort();r.offset=new Array(r.numberOfGlyphs);for(var s=0;s<r.numberOfGlyphs;s++){r.offset[s]=n.parseChar()}break}return r}function vc(){return new iu.Table("post",[{name:"version",type:"FIXED",value:196608},{name:"italicAngle",type:"FIXED",value:0},{name:"underlinePosition",type:"FWORD",value:0},{name:"underlineThickness",type:"FWORD",value:0},{name:"isFixedPitch",type:"ULONG",value:0},{name:"minMemType42",type:"ULONG",value:0},{name:"maxMemType42",type:"ULONG",value:0},{name:"minMemType1",type:"ULONG",value:0},{name:"maxMemType1",type:"ULONG",value:0}])}var mc={parse:dc,make:vc};var _c=new Array(9);_c[1]=function e(){var t=this.offset+this.relativeOffset;var r=this.parseUShort();if(r===1){return{substFormat:1,coverage:this.parsePointer(vu.coverage),deltaGlyphId:this.parseUShort()}}else if(r===2){return{substFormat:2,coverage:this.parsePointer(vu.coverage),substitute:this.parseOffset16List()}}Ol.assert(false,"0x"+t.toString(16)+": lookup type 1 format must be 1 or 2.")};_c[2]=function e(){var t=this.parseUShort();Ol.argument(t===1,"GSUB Multiple Substitution Subtable identifier-format must be 1");return{substFormat:t,coverage:this.parsePointer(vu.coverage),sequences:this.parseListOfLists()}};_c[3]=function e(){var t=this.parseUShort();Ol.argument(t===1,"GSUB Alternate Substitution Subtable identifier-format must be 1");return{substFormat:t,coverage:this.parsePointer(vu.coverage),alternateSets:this.parseListOfLists()}};_c[4]=function e(){var t=this.parseUShort();Ol.argument(t===1,"GSUB ligature table identifier-format must be 1");return{substFormat:t,coverage:this.parsePointer(vu.coverage),ligatureSets:this.parseListOfLists(function(){return{ligGlyph:this.parseUShort(),components:this.parseUShortList(this.parseUShort()-1)}})}};var gc={sequenceIndex:vu.uShort,lookupListIndex:vu.uShort};_c[5]=function e(){var t=this.offset+this.relativeOffset;var r=this.parseUShort();if(r===1){return{substFormat:r,coverage:this.parsePointer(vu.coverage),ruleSets:this.parseListOfLists(function(){var e=this.parseUShort();var t=this.parseUShort();return{input:this.parseUShortList(e-1),lookupRecords:this.parseRecordList(t,gc)}})}}else if(r===2){return{substFormat:r,coverage:this.parsePointer(vu.coverage),classDef:this.parsePointer(vu.classDef),classSets:this.parseListOfLists(function(){var e=this.parseUShort();var t=this.parseUShort();return{classes:this.parseUShortList(e-1),lookupRecords:this.parseRecordList(t,gc)}})}}else if(r===3){var n=this.parseUShort();var i=this.parseUShort();return{substFormat:r,coverages:this.parseList(n,vu.pointer(vu.coverage)),lookupRecords:this.parseRecordList(i,gc)}}Ol.assert(false,"0x"+t.toString(16)+": lookup type 5 format must be 1, 2 or 3.")};_c[6]=function e(){var t=this.offset+this.relativeOffset;var r=this.parseUShort();if(r===1){return{substFormat:1,coverage:this.parsePointer(vu.coverage),chainRuleSets:this.parseListOfLists(function(){return{backtrack:this.parseUShortList(),input:this.parseUShortList(this.parseShort()-1),lookahead:this.parseUShortList(),lookupRecords:this.parseRecordList(gc)}})}}else if(r===2){return{substFormat:2,coverage:this.parsePointer(vu.coverage),backtrackClassDef:this.parsePointer(vu.classDef),inputClassDef:this.parsePointer(vu.classDef),lookaheadClassDef:this.parsePointer(vu.classDef),chainClassSet:this.parseListOfLists(function(){return{backtrack:this.parseUShortList(),input:this.parseUShortList(this.parseShort()-1),lookahead:this.parseUShortList(),lookupRecords:this.parseRecordList(gc)}})}}else if(r===3){return{substFormat:3,backtrackCoverage:this.parseList(vu.pointer(vu.coverage)),inputCoverage:this.parseList(vu.pointer(vu.coverage)),lookaheadCoverage:this.parseList(vu.pointer(vu.coverage)),lookupRecords:this.parseRecordList(gc)}}Ol.assert(false,"0x"+t.toString(16)+": lookup type 6 format must be 1, 2 or 3.")};_c[7]=function e(){var t=this.parseUShort();Ol.argument(t===1,"GSUB Extension Substitution subtable identifier-format must be 1");var r=this.parseUShort();var n=new vu(this.data,this.offset+this.parseULong());return{substFormat:1,lookupType:r,extension:_c[r].call(n)}};_c[8]=function e(){var t=this.parseUShort();Ol.argument(t===1,"GSUB Reverse Chaining Contextual Single Substitution Subtable identifier-format must be 1");return{substFormat:t,coverage:this.parsePointer(vu.coverage),backtrackCoverage:this.parseList(vu.pointer(vu.coverage)),lookaheadCoverage:this.parseList(vu.pointer(vu.coverage)),substitutes:this.parseUShortList()}};function yc(e,t){t=t||0;var r=new vu(e,t);var n=r.parseVersion();Ol.argument(n===1,"Unsupported GSUB table version.");return{version:n,scripts:r.parseScriptList(),features:r.parseFeatureList(),lookups:r.parseLookupList(_c)}}var xc=new Array(9);xc[1]=function e(t){if(t.substFormat===1){return new iu.Table("substitutionTable",[{name:"substFormat",type:"USHORT",value:1},{name:"coverage",type:"TABLE",value:new iu.Coverage(t.coverage)},{name:"deltaGlyphID",type:"USHORT",value:t.deltaGlyphId}])}else{return new iu.Table("substitutionTable",[{name:"substFormat",type:"USHORT",value:2},{name:"coverage",type:"TABLE",value:new iu.Coverage(t.coverage)}].concat(iu.ushortList("substitute",t.substitute)))}Ol.fail("Lookup type 1 substFormat must be 1 or 2.")};xc[3]=function e(t){Ol.assert(t.substFormat===1,"Lookup type 3 substFormat must be 1.");return new iu.Table("substitutionTable",[{name:"substFormat",type:"USHORT",value:1},{name:"coverage",type:"TABLE",value:new iu.Coverage(t.coverage)}].concat(iu.tableList("altSet",t.alternateSets,function(e){return new iu.Table("alternateSetTable",iu.ushortList("alternate",e))})))};xc[4]=function e(t){Ol.assert(t.substFormat===1,"Lookup type 4 substFormat must be 1.");return new iu.Table("substitutionTable",[{name:"substFormat",type:"USHORT",value:1},{name:"coverage",type:"TABLE",value:new iu.Coverage(t.coverage)}].concat(iu.tableList("ligSet",t.ligatureSets,function(e){return new iu.Table("ligatureSetTable",iu.tableList("ligature",e,function(e){return new iu.Table("ligatureTable",[{name:"ligGlyph",type:"USHORT",value:e.ligGlyph}].concat(iu.ushortList("component",e.components,e.components.length+1)))}))})))};function bc(e){return new iu.Table("GSUB",[{name:"version",type:"ULONG",value:65536},{name:"scripts",type:"TABLE",value:new iu.ScriptList(e.scripts)},{name:"features",type:"TABLE",value:new iu.FeatureList(e.features)},{name:"lookups",type:"TABLE",value:new iu.LookupList(e.lookups,xc)}])}var wc={parse:yc,make:bc};function Tc(e,t){var r=new _u.Parser(e,t);var n=r.parseULong();Ol.argument(n===1,"Unsupported META table version.");r.parseULong();r.parseULong();var i=r.parseULong();var a={};for(var o=0;o<i;o++){var s=r.parseTag();var l=r.parseULong();var u=r.parseULong();var h=Fl.UTF8(e,t+l,u);a[s]=h}return a}function Ec(e){var t=Object.keys(e).length;var r="";var n=16+t*12;var i=new iu.Table("meta",[{name:"version",type:"ULONG",value:1},{name:"flags",type:"ULONG",value:0},{name:"offset",type:"ULONG",value:n},{name:"numTags",type:"ULONG",value:t}]);for(var a in e){var o=r.length;r+=e[a];i.fields.push({name:"tag "+a,type:"TAG",value:a});i.fields.push({name:"offset "+a,type:"ULONG",value:n+o});i.fields.push({name:"length "+a,type:"ULONG",value:e[a].length})}i.fields.push({name:"stringPool",type:"CHARARRAY",value:r});return i}var Sc={parse:Tc,make:Ec};function Mc(e){return Math.log(e)/Math.log(2)|0}function Ac(e){while(e.length%4!==0){e.push(0)}var t=0;for(var r=0;r<e.length;r+=4){t+=(e[r]<<24)+(e[r+1]<<16)+(e[r+2]<<8)+e[r+3]}t%=Math.pow(2,32);return t}function Rc(e,t,r,n){return new iu.Record("Table Record",[{name:"tag",type:"TAG",value:e!==undefined?e:""},{name:"checkSum",type:"ULONG",value:t!==undefined?t:0},{name:"offset",type:"ULONG",value:r!==undefined?r:0},{name:"length",type:"ULONG",value:n!==undefined?n:0}])}function Lc(e){var t=new iu.Table("sfnt",[{name:"version",type:"TAG",value:"OTTO"},{name:"numTables",type:"USHORT",value:0},{name:"searchRange",type:"USHORT",value:0},{name:"entrySelector",type:"USHORT",value:0},{name:"rangeShift",type:"USHORT",value:0}]);t.tables=e;t.numTables=e.length;var r=Math.pow(2,Mc(t.numTables));t.searchRange=16*r;t.entrySelector=Mc(r);t.rangeShift=t.numTables*16-t.searchRange;var n=[];var i=[];var a=t.sizeOf()+Rc().sizeOf()*t.numTables;while(a%4!==0){a+=1;i.push({name:"padding",type:"BYTE",value:0})}for(var o=0;o<e.length;o+=1){var s=e[o];Ol.argument(s.tableName.length===4,"Table name"+s.tableName+" is invalid.");var l=s.sizeOf();var u=Rc(s.tableName,Ac(s.encode()),a,l);n.push({name:u.tag+" Table Record",type:"RECORD",value:u});i.push({name:s.tableName+" table",type:"RECORD",value:s});a+=l;Ol.argument(!isNaN(a),"Something went wrong calculating the offset.");while(a%4!==0){a+=1;i.push({name:"padding",type:"BYTE",value:0})}}n.sort(function(e,t){if(e.value.tag>t.value.tag){return 1}else{return-1}});t.fields=t.fields.concat(n);t.fields=t.fields.concat(i);return t}function Cc(e,t,r){for(var n=0;n<t.length;n+=1){var i=e.charToGlyphIndex(t[n]);if(i>0){var a=e.glyphs.get(i);return a.getMetrics()}}return r}function Ic(e){var t=0;for(var r=0;r<e.length;r+=1){t+=e[r]}return t/e.length}function Uc(e){var t=[];var r=[];var n=[];var i=[];var a=[];var o=[];var s=[];var l;var u=0;var h=0;var c=0;var f=0;var p=0;for(var d=0;d<e.glyphs.length;d+=1){var v=e.glyphs.get(d);var m=v.unicode|0;if(isNaN(v.advanceWidth)){throw new Error("Glyph "+v.name+" ("+d+"): advanceWidth is not a number.")}if(l>m||l===undefined){if(m>0){l=m}}if(u<m){u=m}var _=pc.getUnicodeRange(m);if(_<32){h|=1<<_}else if(_<64){c|=1<<_-32}else if(_<96){f|=1<<_-64}else if(_<123){p|=1<<_-96}else{throw new Error("Unicode ranges bits > 123 are reserved for internal usage")}if(v.name===".notdef"){continue}var g=v.getMetrics();t.push(g.xMin);r.push(g.yMin);n.push(g.xMax);i.push(g.yMax);o.push(g.leftSideBearing);s.push(g.rightSideBearing);a.push(v.advanceWidth)}var y={xMin:Math.min.apply(null,t),yMin:Math.min.apply(null,r),xMax:Math.max.apply(null,n),yMax:Math.max.apply(null,i),advanceWidthMax:Math.max.apply(null,a),advanceWidthAvg:Ic(a),minLeftSideBearing:Math.min.apply(null,o),maxLeftSideBearing:Math.max.apply(null,o),minRightSideBearing:Math.min.apply(null,s)};y.ascender=e.ascender;y.descender=e.descender;var x=Oh.make({flags:3,unitsPerEm:e.unitsPerEm,xMin:y.xMin,yMin:y.yMin,xMax:y.xMax,yMax:y.yMax,lowestRecPPEM:3,createdTimestamp:e.createdTimestamp});var b=Fh.make({ascender:y.ascender,descender:y.descender,advanceWidthMax:y.advanceWidthMax,minLeftSideBearing:y.minLeftSideBearing,minRightSideBearing:y.minRightSideBearing,xMaxExtent:y.maxLeftSideBearing+(y.xMax-y.xMin),numberOfHMetrics:e.glyphs.length});var w=qh.make(e.glyphs.length);var T=pc.make({xAvgCharWidth:Math.round(y.advanceWidthAvg),usWeightClass:e.tables.os2.usWeightClass,usWidthClass:e.tables.os2.usWidthClass,usFirstCharIndex:l,usLastCharIndex:u,ulUnicodeRange1:h,ulUnicodeRange2:c,ulUnicodeRange3:f,ulUnicodeRange4:p,fsSelection:e.tables.os2.fsSelection,sTypoAscender:y.ascender,sTypoDescender:y.descender,sTypoLineGap:0,usWinAscent:y.yMax,usWinDescent:Math.abs(y.yMin),ulCodePageRange1:1,sxHeight:Cc(e,"xyvw",{yMax:Math.round(y.ascender/2)}).yMax,sCapHeight:Cc(e,"HIKLEFJMNTZBDPRAGOQSUVWXY",y).yMax,usDefaultChar:e.hasChar(" ")?32:0,usBreakChar:e.hasChar(" ")?32:0});var E=kh.make(e.glyphs);var S=Eu.make(e.glyphs);var M=e.getEnglishName("fontFamily");var A=e.getEnglishName("fontSubfamily");var R=M+" "+A;var L=e.getEnglishName("postScriptName");if(!L){L=M.replace(/\s/g,"")+"-"+A}var C={};for(var I in e.names){C[I]=e.names[I]}if(!C.uniqueID){C.uniqueID={en:e.getEnglishName("manufacturer")+":"+R}}if(!C.postScriptName){C.postScriptName={en:L}}if(!C.preferredFamily){C.preferredFamily=e.names.fontFamily}if(!C.preferredSubfamily){C.preferredSubfamily=e.names.fontSubfamily}var U=[];var D=lc.make(C,U);var O=U.length>0?Wh.make(U):undefined;var B=mc.make();var P=Ih.make(e.glyphs,{version:e.getEnglishName("version"),fullName:R,familyName:M,weightName:A,postScriptName:L,unitsPerEm:e.unitsPerEm,fontBBox:[0,y.yMin,y.ascender,y.advanceWidthMax]});var F=e.metas&&Object.keys(e.metas).length>0?Sc.make(e.metas):undefined;var z=[x,b,w,T,D,S,B,P,E];if(O){z.push(O)}if(e.tables.gsub){z.push(wc.make(e.tables.gsub))}if(F){z.push(F)}var N=Lc(z);var k=N.encode();var V=Ac(k);var G=N.fields;var W=false;for(var H=0;H<G.length;H+=1){if(G[H].name==="head table"){G[H].value.checkSumAdjustment=2981146554-V;W=true;break}}if(!W){throw new Error("Could not find head table with checkSum to adjust.")}return N}var Dc={make:Lc,fontToTable:Uc,computeCheckSum:Ac};function Oc(e,t){var r=0;var n=e.length-1;while(r<=n){var i=r+n>>>1;var a=e[i].tag;if(a===t){return i}else if(a<t){r=i+1}else{n=i-1}}return-r-1}function Bc(e,t){var r=0;var n=e.length-1;while(r<=n){var i=r+n>>>1;var a=e[i];if(a===t){return i}else if(a<t){r=i+1}else{n=i-1}}return-r-1}function Pc(e,t){this.font=e;this.tableName=t}Pc.prototype={searchTag:Oc,binSearch:Bc,getTable:function(e){var t=this.font.tables[this.tableName];if(!t&&e){t=this.font.tables[this.tableName]=this.createDefaultTable()}return t},getScriptNames:function(){var e=this.getTable();if(!e){return[]}return e.scripts.map(function(e){return e.tag})},getDefaultScriptName:function(){var e=this.getTable();if(!e){return}var t=false;for(var r=0;r<e.scripts.length;r++){var n=e.scripts[r].tag;if(n==="DFLT"){return n}if(n==="latn"){t=true}}if(t){return"latn"}},getScriptTable:function(e,t){var r=this.getTable(t);if(r){e=e||"DFLT";var n=r.scripts;var i=Oc(r.scripts,e);if(i>=0){return n[i].script}else if(t){var a={tag:e,script:{defaultLangSys:{reserved:0,reqFeatureIndex:65535,featureIndexes:[]},langSysRecords:[]}};n.splice(-1-i,0,a);return a.script}}},getLangSysTable:function(e,t,r){var n=this.getScriptTable(e,r);if(n){if(!t||t==="dflt"||t==="DFLT"){return n.defaultLangSys}var i=Oc(n.langSysRecords,t);if(i>=0){return n.langSysRecords[i].langSys}else if(r){var a={tag:t,langSys:{reserved:0,reqFeatureIndex:65535,featureIndexes:[]}};n.langSysRecords.splice(-1-i,0,a);return a.langSys}}},getFeatureTable:function(e,t,r,n){var i=this.getLangSysTable(e,t,n);if(i){var a;var o=i.featureIndexes;var s=this.font.tables[this.tableName].features;for(var l=0;l<o.length;l++){a=s[o[l]];if(a.tag===r){return a.feature}}if(n){var u=s.length;Ol.assert(u===0||r>=s[u-1].tag,"Features must be added in alphabetical order.");a={tag:r,feature:{params:0,lookupListIndexes:[]}};s.push(a);o.push(u);return a.feature}}},getLookupTables:function(e,t,r,n,i){var a=this.getFeatureTable(e,t,r,i);var o=[];if(a){var s;var l=a.lookupListIndexes;var u=this.font.tables[this.tableName].lookups;for(var h=0;h<l.length;h++){s=u[l[h]];if(s.lookupType===n){o.push(s)}}if(o.length===0&&i){s={lookupType:n,lookupFlag:0,subtables:[],markFilteringSet:undefined};var c=u.length;u.push(s);l.push(c);return[s]}}return o},expandCoverage:function(e){if(e.format===1){return e.glyphs}else{var t=[];var r=e.ranges;for(var n=0;n<r.length;n++){var i=r[n];var a=i.start;var o=i.end;for(var s=a;s<=o;s++){t.push(s)}}return t}}};function Fc(e){Pc.call(this,e,"gsub")}function zc(e,t){var r=e.length;if(r!==t.length){return false}for(var n=0;n<r;n++){if(e[n]!==t[n]){return false}}return true}function Nc(e,t,r){var n=e.subtables;for(var i=0;i<n.length;i++){var a=n[i];if(a.substFormat===t){return a}}if(r){n.push(r);return r}return undefined}Fc.prototype=Pc.prototype;Fc.prototype.createDefaultTable=function(){return{version:1,scripts:[{tag:"DFLT",script:{defaultLangSys:{reserved:0,reqFeatureIndex:65535,featureIndexes:[]},langSysRecords:[]}}],features:[],lookups:[]}};Fc.prototype.getSingle=function(e,t,r){var n=this;var i=[];var a=this.getLookupTables(t,r,e,1);for(var o=0;o<a.length;o++){var s=a[o].subtables;for(var l=0;l<s.length;l++){var u=s[l];var h=n.expandCoverage(u.coverage);var c=void 0;if(u.substFormat===1){var f=u.deltaGlyphId;for(c=0;c<h.length;c++){var p=h[c];i.push({sub:p,by:p+f})}}else{var d=u.substitute;for(c=0;c<h.length;c++){i.push({sub:h[c],by:d[c]})}}}}return i};Fc.prototype.getAlternates=function(e,t,r){var n=this;var i=[];var a=this.getLookupTables(t,r,e,3);for(var o=0;o<a.length;o++){var s=a[o].subtables;for(var l=0;l<s.length;l++){var u=s[l];var h=n.expandCoverage(u.coverage);var c=u.alternateSets;for(var f=0;f<h.length;f++){i.push({sub:h[f],by:c[f]})}}}return i};Fc.prototype.getLigatures=function(e,t,r){var n=this;var i=[];var a=this.getLookupTables(t,r,e,4);for(var o=0;o<a.length;o++){var s=a[o].subtables;for(var l=0;l<s.length;l++){var u=s[l];var h=n.expandCoverage(u.coverage);var c=u.ligatureSets;for(var f=0;f<h.length;f++){var p=h[f];var d=c[f];for(var v=0;v<d.length;v++){var m=d[v];i.push({sub:[p].concat(m.components),by:m.ligGlyph})}}}}return i};Fc.prototype.addSingle=function(e,t,r,n){var i=this.getLookupTables(r,n,e,1,true)[0];var a=Nc(i,2,{substFormat:2,coverage:{format:1,glyphs:[]},substitute:[]});Ol.assert(a.coverage.format===1,"Ligature: unable to modify coverage table format "+a.coverage.format);var o=t.sub;var s=this.binSearch(a.coverage.glyphs,o);if(s<0){s=-1-s;a.coverage.glyphs.splice(s,0,o);a.substitute.splice(s,0,0)}a.substitute[s]=t.by};Fc.prototype.addAlternate=function(e,t,r,n){var i=this.getLookupTables(r,n,e,3,true)[0];var a=Nc(i,1,{substFormat:1,coverage:{format:1,glyphs:[]},alternateSets:[]});Ol.assert(a.coverage.format===1,"Ligature: unable to modify coverage table format "+a.coverage.format);var o=t.sub;var s=this.binSearch(a.coverage.glyphs,o);if(s<0){s=-1-s;a.coverage.glyphs.splice(s,0,o);a.alternateSets.splice(s,0,0)}a.alternateSets[s]=t.by};Fc.prototype.addLigature=function(e,t,r,n){var i=this.getLookupTables(r,n,e,4,true)[0];var a=i.subtables[0];if(!a){a={substFormat:1,coverage:{format:1,glyphs:[]},ligatureSets:[]};i.subtables[0]=a}Ol.assert(a.coverage.format===1,"Ligature: unable to modify coverage table format "+a.coverage.format);var o=t.sub[0];var s=t.sub.slice(1);var l={ligGlyph:t.by,components:s};var u=this.binSearch(a.coverage.glyphs,o);if(u>=0){var h=a.ligatureSets[u];for(var c=0;c<h.length;c++){if(zc(h[c].components,s)){return}}h.push(l)}else{u=-1-u;a.coverage.glyphs.splice(u,0,o);a.ligatureSets.splice(u,0,[l])}};Fc.prototype.getFeature=function(e,t,r){if(/ss\d\d/.test(e)){return this.getSingle(e,t,r)}switch(e){case"aalt":case"salt":return this.getSingle(e,t,r).concat(this.getAlternates(e,t,r));case"dlig":case"liga":case"rlig":return this.getLigatures(e,t,r)}return undefined};Fc.prototype.add=function(e,t,r,n){if(/ss\d\d/.test(e)){return this.addSingle(e,t,r,n)}switch(e){case"aalt":case"salt":if(typeof t.by==="number"){return this.addSingle(e,t,r,n)}return this.addAlternate(e,t,r,n);case"dlig":case"liga":case"rlig":return this.addLigature(e,t,r,n)}return undefined};function kc(){return typeof window!=="undefined"}function Vc(e){var t=new Buffer(e.byteLength);var r=new Uint8Array(e);for(var n=0;n<t.length;++n){t[n]=r[n]}return t}function Gc(e,t){if(!e){throw t}}var Wc;var Hc;var jc;var qc;function Xc(e){this.font=e;this._fpgmState=this._prepState=undefined;this._errorState=0}function Yc(e){return e}function Kc(e){return Math.sign(e)*Math.round(Math.abs(e))}function Zc(e){return Math.sign(e)*Math.round(Math.abs(e*2))/2}function Qc(e){return Math.sign(e)*(Math.round(Math.abs(e)+.5)-.5)}function Jc(e){return Math.sign(e)*Math.ceil(Math.abs(e))}function $c(e){return Math.sign(e)*Math.floor(Math.abs(e))}var ef=function(e){var t=this.srPeriod;var r=this.srPhase;var n=this.srThreshold;var i=1;if(e<0){e=-e;i=-1}e+=n-r;e=Math.trunc(e/t)*t;e+=r;if(i>0&&e<0){return r}if(i<0&&e>0){return-r}return e*i};var tf={x:1,y:0,axis:"x",distance:function(e,t,r,n){return(r?e.xo:e.x)-(n?t.xo:t.x)},interpolate:function(e,t,r,n){var i;var a;var o;var s;var l;var u;var h;if(!n||n===this){i=e.xo-t.xo;a=e.xo-r.xo;l=t.x-t.xo;u=r.x-r.xo;o=Math.abs(i);s=Math.abs(a);h=o+s;if(h===0){e.x=e.xo+(l+u)/2;return}e.x=e.xo+(l*s+u*o)/h;return}i=n.distance(e,t,true,true);a=n.distance(e,r,true,true);l=n.distance(t,t,false,true);u=n.distance(r,r,false,true);o=Math.abs(i);s=Math.abs(a);h=o+s;if(h===0){tf.setRelative(e,e,(l+u)/2,n,true);return}tf.setRelative(e,e,(l*s+u*o)/h,n,true)},normalSlope:Number.NEGATIVE_INFINITY,setRelative:function(e,t,r,n,i){if(!n||n===this){e.x=(i?t.xo:t.x)+r;return}var a=i?t.xo:t.x;var o=i?t.yo:t.y;var s=a+r*n.x;var l=o+r*n.y;e.x=s+(e.y-l)/n.normalSlope},slope:0,touch:function(e){e.xTouched=true},touched:function(e){return e.xTouched},untouch:function(e){e.xTouched=false}};var rf={x:0,y:1,axis:"y",distance:function(e,t,r,n){return(r?e.yo:e.y)-(n?t.yo:t.y)},interpolate:function(e,t,r,n){var i;var a;var o;var s;var l;var u;var h;if(!n||n===this){i=e.yo-t.yo;a=e.yo-r.yo;l=t.y-t.yo;u=r.y-r.yo;o=Math.abs(i);s=Math.abs(a);h=o+s;if(h===0){e.y=e.yo+(l+u)/2;return}e.y=e.yo+(l*s+u*o)/h;return}i=n.distance(e,t,true,true);a=n.distance(e,r,true,true);l=n.distance(t,t,false,true);u=n.distance(r,r,false,true);o=Math.abs(i);s=Math.abs(a);h=o+s;if(h===0){rf.setRelative(e,e,(l+u)/2,n,true);return}rf.setRelative(e,e,(l*s+u*o)/h,n,true)},normalSlope:0,setRelative:function(e,t,r,n,i){if(!n||n===this){e.y=(i?t.yo:t.y)+r;return}var a=i?t.xo:t.x;var o=i?t.yo:t.y;var s=a+r*n.x;var l=o+r*n.y;e.y=l+n.normalSlope*(e.x-s)},slope:Number.POSITIVE_INFINITY,touch:function(e){e.yTouched=true},touched:function(e){return e.yTouched},untouch:function(e){e.yTouched=false}};Object.freeze(tf);Object.freeze(rf);function nf(e,t){this.x=e;this.y=t;this.axis=undefined;this.slope=t/e;this.normalSlope=-e/t;Object.freeze(this)}nf.prototype.distance=function(e,t,r,n){return this.x*tf.distance(e,t,r,n)+this.y*rf.distance(e,t,r,n)};nf.prototype.interpolate=function(e,t,r,n){var i;var a;var o;var s;var l;var u;var h;o=n.distance(e,t,true,true);s=n.distance(e,r,true,true);i=n.distance(t,t,false,true);a=n.distance(r,r,false,true);l=Math.abs(o);u=Math.abs(s);h=l+u;if(h===0){this.setRelative(e,e,(i+a)/2,n,true);return}this.setRelative(e,e,(i*u+a*l)/h,n,true)};nf.prototype.setRelative=function(e,t,r,n,i){n=n||this;var a=i?t.xo:t.x;var o=i?t.yo:t.y;var s=a+r*n.x;var l=o+r*n.y;var u=n.normalSlope;var h=this.slope;var c=e.x;var f=e.y;e.x=(h*c-u*s+l-f)/(h-u);e.y=h*(e.x-c)+f};nf.prototype.touch=function(e){e.xTouched=true;e.yTouched=true};function af(e,t){var r=Math.sqrt(e*e+t*t);e/=r;t/=r;if(e===1&&t===0){return tf}else if(e===0&&t===1){return rf}else{return new nf(e,t)}}function of(e,t,r,n){this.x=this.xo=Math.round(e*64)/64;this.y=this.yo=Math.round(t*64)/64;this.lastPointOfContour=r;this.onCurve=n;this.prevPointOnContour=undefined;this.nextPointOnContour=undefined;this.xTouched=false;this.yTouched=false;Object.preventExtensions(this)}of.prototype.nextTouched=function(e){var t=this.nextPointOnContour;while(!e.touched(t)&&t!==this){t=t.nextPointOnContour}return t};of.prototype.prevTouched=function(e){var t=this.prevPointOnContour;while(!e.touched(t)&&t!==this){t=t.prevPointOnContour}return t};var sf=Object.freeze(new of(0,0));var lf={cvCutIn:17/16,deltaBase:9,deltaShift:.125,loop:1,minDis:1,autoFlip:true};function uf(e,t){this.env=e;this.stack=[];this.prog=t;switch(e){case"glyf":this.zp0=this.zp1=this.zp2=1;this.rp0=this.rp1=this.rp2=0;case"prep":this.fv=this.pv=this.dpv=tf;this.round=Kc}}Xc.prototype.exec=function(e,t){if(typeof t!=="number"){throw new Error("Point size is not a number!")}if(this._errorState>2){return}var r=this.font;var n=this._prepState;if(!n||n.ppem!==t){var i=this._fpgmState;if(!i){uf.prototype=lf;i=this._fpgmState=new uf("fpgm",r.tables.fpgm);i.funcs=[];i.font=r;if(exports.DEBUG){console.log("---EXEC FPGM---");i.step=-1}try{Hc(i)}catch(e){console.log("Hinting error in FPGM:"+e);this._errorState=3;return}}uf.prototype=i;n=this._prepState=new uf("prep",r.tables.prep);n.ppem=t;var a=r.tables.cvt;if(a){var o=n.cvt=new Array(a.length);var s=t/r.unitsPerEm;for(var l=0;l<a.length;l++){o[l]=a[l]*s}}else{n.cvt=[]}if(exports.DEBUG){console.log("---EXEC PREP---");n.step=-1}try{Hc(n)}catch(e){if(this._errorState<2){console.log("Hinting error in PREP:"+e)}this._errorState=2}}if(this._errorState>1){return}try{return jc(e,n)}catch(e){if(this._errorState<1){console.log("Hinting error:"+e);console.log("Note: further hinting errors are silenced")}this._errorState=1;return undefined}};jc=function(e,t){var r=t.ppem/t.font.unitsPerEm;var n=r;var i=e.components;var a;var o;var s;uf.prototype=t;if(!i){s=new uf("glyf",e.instructions);if(exports.DEBUG){console.log("---EXEC GLYPH---");s.step=-1}qc(e,s,r,n);o=s.gZone}else{var l=t.font;o=[];a=[];for(var u=0;u<i.length;u++){var h=i[u];var c=l.glyphs.get(h.glyphIndex);s=new uf("glyf",c.instructions);if(exports.DEBUG){console.log("---EXEC COMP "+u+"---");s.step=-1}qc(c,s,r,n);var f=Math.round(h.dx*r);var p=Math.round(h.dy*n);var d=s.gZone;var v=s.contours;for(var m=0;m<d.length;m++){var _=d[m];_.xTouched=_.yTouched=false;_.xo=_.x=_.x+f;_.yo=_.y=_.y+p}var g=o.length;o.push.apply(o,d);for(var y=0;y<v.length;y++){a.push(v[y]+g)}}if(e.instructions&&!s.inhibitGridFit){s=new uf("glyf",e.instructions);s.gZone=s.z0=s.z1=s.z2=o;s.contours=a;o.push(new of(0,0),new of(Math.round(e.advanceWidth*r),0));if(exports.DEBUG){console.log("---EXEC COMPOSITE---");s.step=-1}Hc(s);o.length-=2}}return o};qc=function(e,t,r,n){var i=e.points||[];var a=i.length;var o=t.gZone=t.z0=t.z1=t.z2=[];var s=t.contours=[];var l;for(var u=0;u<a;u++){l=i[u];o[u]=new of(l.x*r,l.y*n,l.lastPointOfContour,l.onCurve)}var h;var c;for(var f=0;f<a;f++){l=o[f];if(!h){h=l;s.push(f)}if(l.lastPointOfContour){l.nextPointOnContour=h;h.prevPointOnContour=l;h=undefined}else{c=o[f+1];l.nextPointOnContour=c;c.prevPointOnContour=l}}if(t.inhibitGridFit){return}o.push(new of(0,0),new of(Math.round(e.advanceWidth*r),0));Hc(t);o.length-=2;if(exports.DEBUG){console.log("FINISHED GLYPH",t.stack);for(var p=0;p<a;p++){console.log(p,o[p].x,o[p].y)}}};Hc=function(e){var t=e.prog;if(!t){return}var r=t.length;var n;for(e.ip=0;e.ip<r;e.ip++){if(exports.DEBUG){e.step++}n=Wc[t[e.ip]];if(!n){throw new Error("unknown instruction: 0x"+Number(t[e.ip]).toString(16))}n(e)}};function hf(e){var t=e.tZone=new Array(e.gZone.length);for(var r=0;r<t.length;r++){t[r]=new of(0,0)}}function cf(e,t){var r=e.prog;var n=e.ip;var i=1;var a;do{a=r[++n];if(a===88){i++}else if(a===89){i--}else if(a===64){n+=r[n+1]+1}else if(a===65){n+=2*r[n+1]+1}else if(a>=176&&a<=183){n+=a-176+1}else if(a>=184&&a<=191){n+=(a-184+1)*2}else if(t&&i===1&&a===27){break}}while(i>0);e.ip=n}function ff(e,t){if(exports.DEBUG){console.log(t.step,"SVTCA["+e.axis+"]")}t.fv=t.pv=t.dpv=e}function pf(e,t){if(exports.DEBUG){console.log(t.step,"SPVTCA["+e.axis+"]")}t.pv=t.dpv=e}function df(e,t){if(exports.DEBUG){console.log(t.step,"SFVTCA["+e.axis+"]")}t.fv=e}function vf(e,t){var r=t.stack;var n=r.pop();var i=r.pop();var a=t.z2[n];var o=t.z1[i];if(exports.DEBUG){console.log("SPVTL["+e+"]",n,i)}var s;var l;if(!e){s=o.x-a.x;l=o.y-a.y}else{s=a.y-o.y;l=o.x-a.x}t.pv=t.dpv=af(s,l)}function mf(e,t){var r=t.stack;var n=r.pop();var i=r.pop();var a=t.z2[n];var o=t.z1[i];if(exports.DEBUG){console.log("SFVTL["+e+"]",n,i)}var s;var l;if(!e){s=o.x-a.x;l=o.y-a.y}else{s=a.y-o.y;l=o.x-a.x}t.fv=af(s,l)}function _f(e){var t=e.stack;var r=t.pop();var n=t.pop();if(exports.DEBUG){console.log(e.step,"SPVFS[]",r,n)}e.pv=e.dpv=af(n,r)}function gf(e){var t=e.stack;var r=t.pop();var n=t.pop();if(exports.DEBUG){console.log(e.step,"SPVFS[]",r,n)}e.fv=af(n,r)}function yf(e){var t=e.stack;var r=e.pv;if(exports.DEBUG){console.log(e.step,"GPV[]")}t.push(r.x*16384);t.push(r.y*16384)}function xf(e){var t=e.stack;var r=e.fv;if(exports.DEBUG){console.log(e.step,"GFV[]")}t.push(r.x*16384);t.push(r.y*16384)}function bf(e){e.fv=e.pv;if(exports.DEBUG){console.log(e.step,"SFVTPV[]")}}function wf(e){var t=e.stack;var r=t.pop();var n=t.pop();var i=t.pop();var a=t.pop();var o=t.pop();var s=e.z0;var l=e.z1;var u=s[r];var h=s[n];var c=l[i];var f=l[a];var p=e.z2[o];if(exports.DEBUG){console.log("ISECT[], ",r,n,i,a,o)}var d=u.x;var v=u.y;var m=h.x;var _=h.y;var g=c.x;var y=c.y;var x=f.x;var b=f.y;var w=(d-m)*(y-b)-(v-_)*(g-x);var T=d*_-v*m;var E=g*b-y*x;p.x=(T*(g-x)-E*(d-m))/w;p.y=(T*(y-b)-E*(v-_))/w}function Tf(e){e.rp0=e.stack.pop();if(exports.DEBUG){console.log(e.step,"SRP0[]",e.rp0)}}function Ef(e){e.rp1=e.stack.pop();if(exports.DEBUG){console.log(e.step,"SRP1[]",e.rp1)}}function Sf(e){e.rp2=e.stack.pop();if(exports.DEBUG){console.log(e.step,"SRP2[]",e.rp2)}}function Mf(e){var t=e.stack.pop();if(exports.DEBUG){console.log(e.step,"SZP0[]",t)}e.zp0=t;switch(t){case 0:if(!e.tZone){hf(e)}e.z0=e.tZone;break;case 1:e.z0=e.gZone;break;default:throw new Error("Invalid zone pointer")}}function Af(e){var t=e.stack.pop();if(exports.DEBUG){console.log(e.step,"SZP1[]",t)}e.zp1=t;switch(t){case 0:if(!e.tZone){hf(e)}e.z1=e.tZone;break;case 1:e.z1=e.gZone;break;default:throw new Error("Invalid zone pointer")}}function Rf(e){var t=e.stack.pop();if(exports.DEBUG){console.log(e.step,"SZP2[]",t)}e.zp2=t;switch(t){case 0:if(!e.tZone){hf(e)}e.z2=e.tZone;break;case 1:e.z2=e.gZone;break;default:throw new Error("Invalid zone pointer")}}function Lf(e){var t=e.stack.pop();if(exports.DEBUG){console.log(e.step,"SZPS[]",t)}e.zp0=e.zp1=e.zp2=t;switch(t){case 0:if(!e.tZone){hf(e)}e.z0=e.z1=e.z2=e.tZone;break;case 1:e.z0=e.z1=e.z2=e.gZone;break;default:throw new Error("Invalid zone pointer")}}function Cf(e){e.loop=e.stack.pop();if(exports.DEBUG){console.log(e.step,"SLOOP[]",e.loop)}}function If(e){if(exports.DEBUG){console.log(e.step,"RTG[]")}e.round=Kc}function Uf(e){if(exports.DEBUG){console.log(e.step,"RTHG[]")}e.round=Qc}function Df(e){var t=e.stack.pop();if(exports.DEBUG){console.log(e.step,"SMD[]",t)}e.minDis=t/64}function Of(e){if(exports.DEBUG){console.log(e.step,"ELSE[]")}cf(e,false)}function Bf(e){var t=e.stack.pop();if(exports.DEBUG){console.log(e.step,"JMPR[]",t)}e.ip+=t-1}function Pf(e){var t=e.stack.pop();if(exports.DEBUG){console.log(e.step,"SCVTCI[]",t)}e.cvCutIn=t/64}function Ff(e){var t=e.stack;if(exports.DEBUG){console.log(e.step,"DUP[]")}t.push(t[t.length-1])}function zf(e){if(exports.DEBUG){console.log(e.step,"POP[]")}e.stack.pop()}function Nf(e){if(exports.DEBUG){console.log(e.step,"CLEAR[]")}e.stack.length=0}function kf(e){var t=e.stack;var r=t.pop();var n=t.pop();if(exports.DEBUG){console.log(e.step,"SWAP[]")}t.push(r);t.push(n)}function Vf(e){var t=e.stack;if(exports.DEBUG){console.log(e.step,"DEPTH[]")}t.push(t.length)}function Gf(e){var t=e.stack;var r=t.pop();var n=t.pop();if(exports.DEBUG){console.log(e.step,"LOOPCALL[]",r,n)}var i=e.ip;var a=e.prog;e.prog=e.funcs[r];for(var o=0;o<n;o++){Hc(e);if(exports.DEBUG){console.log(++e.step,o+1<n?"next loopcall":"done loopcall",o)}}e.ip=i;e.prog=a}function Wf(e){var t=e.stack.pop();if(exports.DEBUG){console.log(e.step,"CALL[]",t)}var r=e.ip;var n=e.prog;e.prog=e.funcs[t];Hc(e);e.ip=r;e.prog=n;if(exports.DEBUG){console.log(++e.step,"returning from",t)}}function Hf(e){var t=e.stack;var r=t.pop();if(exports.DEBUG){console.log(e.step,"CINDEX[]",r)}t.push(t[t.length-r])}function jf(e){var t=e.stack;var r=t.pop();if(exports.DEBUG){console.log(e.step,"MINDEX[]",r)}t.push(t.splice(t.length-r,1)[0])}function qf(e){if(e.env!=="fpgm"){throw new Error("FDEF not allowed here")}var t=e.stack;var r=e.prog;var n=e.ip;var i=t.pop();var a=n;if(exports.DEBUG){console.log(e.step,"FDEF[]",i)}while(r[++n]!==45){}e.ip=n;e.funcs[i]=r.slice(a+1,n)}function Xf(e,t){var r=t.stack.pop();var n=t.z0[r];var i=t.fv;var a=t.pv;if(exports.DEBUG){console.log(t.step,"MDAP["+e+"]",r)}var o=a.distance(n,sf);if(e){o=t.round(o)}i.setRelative(n,sf,o,a);i.touch(n);t.rp0=t.rp1=r}function Yf(e,t){var r=t.z2;var n=r.length-2;var i;var a;var o;if(exports.DEBUG){console.log(t.step,"IUP["+e.axis+"]")}for(var s=0;s<n;s++){i=r[s];if(e.touched(i)){continue}a=i.prevTouched(e);if(a===i){continue}o=i.nextTouched(e);if(a===o){e.setRelative(i,i,e.distance(a,a,false,true),e,true)}e.interpolate(i,a,o,e)}}function Kf(e,t){var r=t.stack;var n=e?t.rp1:t.rp2;var i=(e?t.z0:t.z1)[n];var a=t.fv;var o=t.pv;var s=t.loop;var l=t.z2;while(s--){var u=r.pop();var h=l[u];var c=o.distance(i,i,false,true);a.setRelative(h,h,c,o);a.touch(h);if(exports.DEBUG){console.log(t.step,(t.loop>1?"loop "+(t.loop-s)+": ":"")+"SHP["+(e?"rp1":"rp2")+"]",u)}}t.loop=1}function Zf(e,t){var r=t.stack;var n=e?t.rp1:t.rp2;var i=(e?t.z0:t.z1)[n];var a=t.fv;var o=t.pv;var s=r.pop();var l=t.z2[t.contours[s]];var u=l;if(exports.DEBUG){console.log(t.step,"SHC["+e+"]",s)}var h=o.distance(i,i,false,true);do{if(u!==i){a.setRelative(u,u,h,o)}u=u.nextPointOnContour}while(u!==l)}function Qf(e,t){var r=t.stack;var n=e?t.rp1:t.rp2;var i=(e?t.z0:t.z1)[n];var a=t.fv;var o=t.pv;var s=r.pop();if(exports.DEBUG){console.log(t.step,"SHZ["+e+"]",s)}var l;switch(s){case 0:l=t.tZone;break;case 1:l=t.gZone;break;default:throw new Error("Invalid zone")}var u;var h=o.distance(i,i,false,true);var c=l.length-2;for(var f=0;f<c;f++){u=l[f];if(u!==i){a.setRelative(u,u,h,o)}}}function Jf(e){var t=e.stack;var r=e.loop;var n=e.fv;var i=t.pop()/64;var a=e.z2;while(r--){var o=t.pop();var s=a[o];if(exports.DEBUG){console.log(e.step,(e.loop>1?"loop "+(e.loop-r)+": ":"")+"SHPIX[]",o,i)}n.setRelative(s,s,i);n.touch(s)}e.loop=1}function $f(e){var t=e.stack;var r=e.rp1;var n=e.rp2;var i=e.loop;var a=e.z0[r];var o=e.z1[n];var s=e.fv;var l=e.dpv;var u=e.z2;while(i--){var h=t.pop();var c=u[h];if(exports.DEBUG){console.log(e.step,(e.loop>1?"loop "+(e.loop-i)+": ":"")+"IP[]",h,r,"<->",n)}s.interpolate(c,a,o,l);s.touch(c)}e.loop=1}function ep(e,t){var r=t.stack;var n=r.pop()/64;var i=r.pop();var a=t.z1[i];var o=t.z0[t.rp0];var s=t.fv;var l=t.pv;s.setRelative(a,o,n,l);s.touch(a);if(exports.DEBUG){console.log(t.step,"MSIRP["+e+"]",n,i)}t.rp1=t.rp0;t.rp2=i;if(e){t.rp0=i}}function tp(e){var t=e.stack;var r=e.rp0;var n=e.z0[r];var i=e.loop;var a=e.fv;var o=e.pv;var s=e.z1;while(i--){var l=t.pop();var u=s[l];if(exports.DEBUG){console.log(e.step,(e.loop>1?"loop "+(e.loop-i)+": ":"")+"ALIGNRP[]",l)}a.setRelative(u,n,0,o);a.touch(u)}e.loop=1}function rp(e){if(exports.DEBUG){console.log(e.step,"RTDG[]")}e.round=Zc}function np(e,t){var r=t.stack;var n=r.pop();var i=r.pop();var a=t.z0[i];var o=t.fv;var s=t.pv;var l=t.cvt[n];if(e){l=t.round(l)}if(exports.DEBUG){console.log(t.step,"MIAP["+e+"]",n,"(",l,")",i)}o.setRelative(a,sf,l,s);if(t.zp0===0){a.xo=a.x;a.yo=a.y}o.touch(a);t.rp0=t.rp1=i}function ip(e){var t=e.prog;var r=e.ip;var n=e.stack;var i=t[++r];if(exports.DEBUG){console.log(e.step,"NPUSHB[]",i)}for(var a=0;a<i;a++){n.push(t[++r])}e.ip=r}function ap(e){var t=e.ip;var r=e.prog;var n=e.stack;var i=r[++t];if(exports.DEBUG){console.log(e.step,"NPUSHW[]",i)}for(var a=0;a<i;a++){var o=r[++t]<<8|r[++t];if(o&32768){o=-((o^65535)+1)}n.push(o)}e.ip=t}function op(e){var t=e.stack;var r=e.store;if(!r){r=e.store=[]}var n=t.pop();var i=t.pop();if(exports.DEBUG){console.log(e.step,"WS",n,i)}r[i]=n}function sp(e){var t=e.stack;var r=e.store;var n=t.pop();if(exports.DEBUG){console.log(e.step,"RS",n)}var i=r&&r[n]||0;t.push(i)}function lp(e){var t=e.stack;var r=t.pop();var n=t.pop();if(exports.DEBUG){console.log(e.step,"WCVTP",r,n)}e.cvt[n]=r/64}function up(e){var t=e.stack;var r=t.pop();if(exports.DEBUG){console.log(e.step,"RCVT",r)}t.push(e.cvt[r]*64)}function hp(e,t){var r=t.stack;var n=r.pop();var i=t.z2[n];if(exports.DEBUG){console.log(t.step,"GC["+e+"]",n)}r.push(t.dpv.distance(i,sf,e,false)*64)}function cp(e,t){var r=t.stack;var n=r.pop();var i=r.pop();var a=t.z1[n];var o=t.z0[i];var s=t.dpv.distance(o,a,e,e);if(exports.DEBUG){console.log(t.step,"MD["+e+"]",n,i,"->",s)}t.stack.push(Math.round(s*64))}function fp(e){if(exports.DEBUG){console.log(e.step,"MPPEM[]")}e.stack.push(e.ppem)}function pp(e){if(exports.DEBUG){console.log(e.step,"FLIPON[]")}e.autoFlip=true}function dp(e){var t=e.stack;var r=t.pop();var n=t.pop();if(exports.DEBUG){console.log(e.step,"LT[]",r,n)}t.push(n<r?1:0)}function vp(e){var t=e.stack;var r=t.pop();var n=t.pop();if(exports.DEBUG){console.log(e.step,"LTEQ[]",r,n)}t.push(n<=r?1:0)}function mp(e){var t=e.stack;var r=t.pop();var n=t.pop();if(exports.DEBUG){console.log(e.step,"GT[]",r,n)}t.push(n>r?1:0)}function _p(e){var t=e.stack;var r=t.pop();var n=t.pop();if(exports.DEBUG){console.log(e.step,"GTEQ[]",r,n)}t.push(n>=r?1:0)}function gp(e){var t=e.stack;var r=t.pop();var n=t.pop();if(exports.DEBUG){console.log(e.step,"EQ[]",r,n)}t.push(r===n?1:0)}function yp(e){var t=e.stack;var r=t.pop();var n=t.pop();if(exports.DEBUG){console.log(e.step,"NEQ[]",r,n)}t.push(r!==n?1:0)}function xp(e){var t=e.stack;var r=t.pop();if(exports.DEBUG){console.log(e.step,"ODD[]",r)}t.push(Math.trunc(r)%2?1:0)}function bp(e){var t=e.stack;var r=t.pop();if(exports.DEBUG){console.log(e.step,"EVEN[]",r)}t.push(Math.trunc(r)%2?0:1)}function wp(e){var t=e.stack.pop();var r;if(exports.DEBUG){console.log(e.step,"IF[]",t)}if(!t){cf(e,true);if(exports.DEBUG){console.log(e.step,r===27?"ELSE[]":"EIF[]")}}}function Tp(e){if(exports.DEBUG){console.log(e.step,"EIF[]")}}function Ep(e){var t=e.stack;var r=t.pop();var n=t.pop();if(exports.DEBUG){console.log(e.step,"AND[]",r,n)}t.push(r&&n?1:0)}function Sp(e){var t=e.stack;var r=t.pop();var n=t.pop();if(exports.DEBUG){console.log(e.step,"OR[]",r,n)}t.push(r||n?1:0)}function Mp(e){var t=e.stack;var r=t.pop();if(exports.DEBUG){console.log(e.step,"NOT[]",r)}t.push(r?0:1)}function Ap(e,t){var r=t.stack;var n=r.pop();var i=t.fv;var a=t.pv;var o=t.ppem;var s=t.deltaBase+(e-1)*16;var l=t.deltaShift;var u=t.z0;if(exports.DEBUG){console.log(t.step,"DELTAP["+e+"]",n,r)}for(var h=0;h<n;h++){var c=r.pop();var f=r.pop();var p=s+((f&240)>>4);if(p!==o){continue}var d=(f&15)-8;if(d>=0){d++}if(exports.DEBUG){console.log(t.step,"DELTAPFIX",c,"by",d*l)}var v=u[c];i.setRelative(v,v,d*l,a)}}function Rp(e){var t=e.stack;var r=t.pop();if(exports.DEBUG){console.log(e.step,"SDB[]",r)}e.deltaBase=r}function Lp(e){var t=e.stack;var r=t.pop();if(exports.DEBUG){console.log(e.step,"SDS[]",r)}e.deltaShift=Math.pow(.5,r)}function Cp(e){var t=e.stack;var r=t.pop();var n=t.pop();if(exports.DEBUG){console.log(e.step,"ADD[]",r,n)}t.push(n+r)}function Ip(e){var t=e.stack;var r=t.pop();var n=t.pop();if(exports.DEBUG){console.log(e.step,"SUB[]",r,n)}t.push(n-r)}function Up(e){var t=e.stack;var r=t.pop();var n=t.pop();if(exports.DEBUG){console.log(e.step,"DIV[]",r,n)}t.push(n*64/r)}function Dp(e){var t=e.stack;var r=t.pop();var n=t.pop();if(exports.DEBUG){console.log(e.step,"MUL[]",r,n)}t.push(n*r/64)}function Op(e){var t=e.stack;var r=t.pop();if(exports.DEBUG){console.log(e.step,"ABS[]",r)}t.push(Math.abs(r))}function Bp(e){var t=e.stack;var r=t.pop();if(exports.DEBUG){console.log(e.step,"NEG[]",r)}t.push(-r)}function Pp(e){var t=e.stack;var r=t.pop();if(exports.DEBUG){console.log(e.step,"FLOOR[]",r)}t.push(Math.floor(r/64)*64)}function Fp(e){var t=e.stack;var r=t.pop();if(exports.DEBUG){console.log(e.step,"CEILING[]",r)}t.push(Math.ceil(r/64)*64)}function zp(e,t){var r=t.stack;var n=r.pop();if(exports.DEBUG){console.log(t.step,"ROUND[]")}r.push(t.round(n/64)*64)}function Np(e){var t=e.stack;var r=t.pop();var n=t.pop();if(exports.DEBUG){console.log(e.step,"WCVTF[]",r,n)}e.cvt[n]=r*e.ppem/e.font.unitsPerEm}function kp(e,t){var r=t.stack;var n=r.pop();var i=t.ppem;var a=t.deltaBase+(e-1)*16;var o=t.deltaShift;if(exports.DEBUG){console.log(t.step,"DELTAC["+e+"]",n,r)}for(var s=0;s<n;s++){var l=r.pop();var u=r.pop();var h=a+((u&240)>>4);if(h!==i){continue}var c=(u&15)-8;if(c>=0){c++}var f=c*o;if(exports.DEBUG){console.log(t.step,"DELTACFIX",l,"by",f)}t.cvt[l]+=f}}function Vp(e){var t=e.stack.pop();if(exports.DEBUG){console.log(e.step,"SROUND[]",t)}e.round=ef;var r;switch(t&192){case 0:r=.5;break;case 64:r=1;break;case 128:r=2;break;default:throw new Error("invalid SROUND value")}e.srPeriod=r;switch(t&48){case 0:e.srPhase=0;break;case 16:e.srPhase=.25*r;break;case 32:e.srPhase=.5*r;break;case 48:e.srPhase=.75*r;break;default:throw new Error("invalid SROUND value")}t&=15;if(t===0){e.srThreshold=0}else{e.srThreshold=(t/8-.5)*r}}function Gp(e){var t=e.stack.pop();if(exports.DEBUG){console.log(e.step,"S45ROUND[]",t)}e.round=ef;var r;switch(t&192){case 0:r=Math.sqrt(2)/2;break;case 64:r=Math.sqrt(2);break;case 128:r=2*Math.sqrt(2);break;default:throw new Error("invalid S45ROUND value")}e.srPeriod=r;switch(t&48){case 0:e.srPhase=0;break;case 16:e.srPhase=.25*r;break;case 32:e.srPhase=.5*r;break;case 48:e.srPhase=.75*r;break;default:throw new Error("invalid S45ROUND value")}t&=15;if(t===0){e.srThreshold=0}else{e.srThreshold=(t/8-.5)*r}}function Wp(e){if(exports.DEBUG){console.log(e.step,"ROFF[]")}e.round=Yc}function Hp(e){if(exports.DEBUG){console.log(e.step,"RUTG[]")}e.round=Jc}function jp(e){if(exports.DEBUG){console.log(e.step,"RDTG[]")}e.round=$c}function qp(e){var t=e.stack.pop();if(exports.DEBUG){console.log(e.step,"SCANCTRL[]",t)}}function Xp(e,t){var r=t.stack;var n=r.pop();var i=r.pop();var a=t.z2[n];var o=t.z1[i];if(exports.DEBUG){console.log("SDPVTL["+e+"]",n,i)}var s;var l;if(!e){s=o.x-a.x;l=o.y-a.y}else{s=a.y-o.y;l=o.x-a.x}t.dpv=af(s,l)}function Yp(e){var t=e.stack;var r=t.pop();var n=0;if(exports.DEBUG){console.log(e.step,"GETINFO[]",r)}if(r&1){n=35}if(r&32){n|=4096}t.push(n)}function Kp(e){var t=e.stack;var r=t.pop();var n=t.pop();var i=t.pop();if(exports.DEBUG){console.log(e.step,"ROLL[]")}t.push(n);t.push(r);t.push(i)}function Zp(e){var t=e.stack;var r=t.pop();var n=t.pop();if(exports.DEBUG){console.log(e.step,"MAX[]",r,n)}t.push(Math.max(n,r))}function Qp(e){var t=e.stack;var r=t.pop();var n=t.pop();if(exports.DEBUG){console.log(e.step,"MIN[]",r,n)}t.push(Math.min(n,r))}function Jp(e){var t=e.stack.pop();if(exports.DEBUG){console.log(e.step,"SCANTYPE[]",t)}}function $p(e){var t=e.stack.pop();var r=e.stack.pop();if(exports.DEBUG){console.log(e.step,"INSTCTRL[]",t,r)}switch(t){case 1:e.inhibitGridFit=!!r;return;case 2:e.ignoreCvt=!!r;return;default:throw new Error("invalid INSTCTRL[] selector")}}function ed(e,t){var r=t.stack;var n=t.prog;var i=t.ip;if(exports.DEBUG){console.log(t.step,"PUSHB["+e+"]")}for(var a=0;a<e;a++){r.push(n[++i])}t.ip=i}function td(e,t){var r=t.ip;var n=t.prog;var i=t.stack;if(exports.DEBUG){console.log(t.ip,"PUSHW["+e+"]")}for(var a=0;a<e;a++){var o=n[++r]<<8|n[++r];if(o&32768){o=-((o^65535)+1)}i.push(o)}t.ip=r}function rd(e,t,r,n,i,a){var o=a.stack;var s=e&&o.pop();var l=o.pop();var u=a.rp0;var h=a.z0[u];var c=a.z1[l];var f=a.minDis;var p=a.fv;var d=a.dpv;var v;var m;var _;var g;m=v=d.distance(c,h,true,true);_=m>=0?1:-1;m=Math.abs(m);if(e){g=a.cvt[s];if(n&&Math.abs(m-g)<a.cvCutIn){m=g}}if(r&&m<f){m=f}if(n){m=a.round(m)}p.setRelative(c,h,_*m,d);p.touch(c);if(exports.DEBUG){console.log(a.step,(e?"MIRP[":"MDRP[")+(t?"M":"m")+(r?">":"_")+(n?"R":"_")+(i===0?"Gr":i===1?"Bl":i===2?"Wh":"")+"]",e?s+"("+a.cvt[s]+","+g+")":"",l,"(d =",v,"->",_*m,")")}a.rp1=a.rp0;a.rp2=l;if(t){a.rp0=l}}Wc=[ff.bind(undefined,rf),ff.bind(undefined,tf),pf.bind(undefined,rf),pf.bind(undefined,tf),df.bind(undefined,rf),df.bind(undefined,tf),vf.bind(undefined,0),vf.bind(undefined,1),mf.bind(undefined,0),mf.bind(undefined,1),_f,gf,yf,xf,bf,wf,Tf,Ef,Sf,Mf,Af,Rf,Lf,Cf,If,Uf,Df,Of,Bf,Pf,undefined,undefined,Ff,zf,Nf,kf,Vf,Hf,jf,undefined,undefined,undefined,Gf,Wf,qf,undefined,Xf.bind(undefined,0),Xf.bind(undefined,1),Yf.bind(undefined,rf),Yf.bind(undefined,tf),Kf.bind(undefined,0),Kf.bind(undefined,1),Zf.bind(undefined,0),Zf.bind(undefined,1),Qf.bind(undefined,0),Qf.bind(undefined,1),Jf,$f,ep.bind(undefined,0),ep.bind(undefined,1),tp,rp,np.bind(undefined,0),np.bind(undefined,1),ip,ap,op,sp,lp,up,hp.bind(undefined,0),hp.bind(undefined,1),undefined,cp.bind(undefined,0),cp.bind(undefined,1),fp,undefined,pp,undefined,undefined,dp,vp,mp,_p,gp,yp,xp,bp,wp,Tp,Ep,Sp,Mp,Ap.bind(undefined,1),Rp,Lp,Cp,Ip,Up,Dp,Op,Bp,Pp,Fp,zp.bind(undefined,0),zp.bind(undefined,1),zp.bind(undefined,2),zp.bind(undefined,3),undefined,undefined,undefined,undefined,Np,Ap.bind(undefined,2),Ap.bind(undefined,3),kp.bind(undefined,1),kp.bind(undefined,2),kp.bind(undefined,3),Vp,Gp,undefined,undefined,Wp,undefined,Hp,jp,zf,zf,undefined,undefined,undefined,undefined,undefined,qp,Xp.bind(undefined,0),Xp.bind(undefined,1),Yp,undefined,Kp,Zp,Qp,Jp,$p,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,ed.bind(undefined,1),ed.bind(undefined,2),ed.bind(undefined,3),ed.bind(undefined,4),ed.bind(undefined,5),ed.bind(undefined,6),ed.bind(undefined,7),ed.bind(undefined,8),td.bind(undefined,1),td.bind(undefined,2),td.bind(undefined,3),td.bind(undefined,4),td.bind(undefined,5),td.bind(undefined,6),td.bind(undefined,7),td.bind(undefined,8),rd.bind(undefined,0,0,0,0,0),rd.bind(undefined,0,0,0,0,1),rd.bind(undefined,0,0,0,0,2),rd.bind(undefined,0,0,0,0,3),rd.bind(undefined,0,0,0,1,0),rd.bind(undefined,0,0,0,1,1),rd.bind(undefined,0,0,0,1,2),rd.bind(undefined,0,0,0,1,3),rd.bind(undefined,0,0,1,0,0),rd.bind(undefined,0,0,1,0,1),rd.bind(undefined,0,0,1,0,2),rd.bind(undefined,0,0,1,0,3),rd.bind(undefined,0,0,1,1,0),rd.bind(undefined,0,0,1,1,1),rd.bind(undefined,0,0,1,1,2),rd.bind(undefined,0,0,1,1,3),rd.bind(undefined,0,1,0,0,0),rd.bind(undefined,0,1,0,0,1),rd.bind(undefined,0,1,0,0,2),rd.bind(undefined,0,1,0,0,3),rd.bind(undefined,0,1,0,1,0),rd.bind(undefined,0,1,0,1,1),rd.bind(undefined,0,1,0,1,2),rd.bind(undefined,0,1,0,1,3),rd.bind(undefined,0,1,1,0,0),rd.bind(undefined,0,1,1,0,1),rd.bind(undefined,0,1,1,0,2),rd.bind(undefined,0,1,1,0,3),rd.bind(undefined,0,1,1,1,0),rd.bind(undefined,0,1,1,1,1),rd.bind(undefined,0,1,1,1,2),rd.bind(undefined,0,1,1,1,3),rd.bind(undefined,1,0,0,0,0),rd.bind(undefined,1,0,0,0,1),rd.bind(undefined,1,0,0,0,2),rd.bind(undefined,1,0,0,0,3),rd.bind(undefined,1,0,0,1,0),rd.bind(undefined,1,0,0,1,1),rd.bind(undefined,1,0,0,1,2),rd.bind(undefined,1,0,0,1,3),rd.bind(undefined,1,0,1,0,0),rd.bind(undefined,1,0,1,0,1),rd.bind(undefined,1,0,1,0,2),rd.bind(undefined,1,0,1,0,3),rd.bind(undefined,1,0,1,1,0),rd.bind(undefined,1,0,1,1,1),rd.bind(undefined,1,0,1,1,2),rd.bind(undefined,1,0,1,1,3),rd.bind(undefined,1,1,0,0,0),rd.bind(undefined,1,1,0,0,1),rd.bind(undefined,1,1,0,0,2),rd.bind(undefined,1,1,0,0,3),rd.bind(undefined,1,1,0,1,0),rd.bind(undefined,1,1,0,1,1),rd.bind(undefined,1,1,0,1,2),rd.bind(undefined,1,1,0,1,3),rd.bind(undefined,1,1,1,0,0),rd.bind(undefined,1,1,1,0,1),rd.bind(undefined,1,1,1,0,2),rd.bind(undefined,1,1,1,0,3),rd.bind(undefined,1,1,1,1,0),rd.bind(undefined,1,1,1,1,1),rd.bind(undefined,1,1,1,1,2),rd.bind(undefined,1,1,1,1,3)];function nd(e){e=e||{};if(!e.empty){Gc(e.familyName,"When creating a new Font object, familyName is required.");Gc(e.styleName,"When creating a new Font object, styleName is required.");Gc(e.unitsPerEm,"When creating a new Font object, unitsPerEm is required.");Gc(e.ascender,"When creating a new Font object, ascender is required.");Gc(e.descender,"When creating a new Font object, descender is required.");Gc(e.descender<0,"Descender should be negative (e.g. -512).");this.names={fontFamily:{en:e.familyName||" "},fontSubfamily:{en:e.styleName||" "},fullName:{en:e.fullName||e.familyName+" "+e.styleName},postScriptName:{en:e.postScriptName||e.familyName+e.styleName},designer:{en:e.designer||" "},designerURL:{en:e.designerURL||" "},manufacturer:{en:e.manufacturer||" "},manufacturerURL:{en:e.manufacturerURL||" "},license:{en:e.license||" "},licenseURL:{en:e.licenseURL||" "},version:{en:e.version||"Version 0.1"},description:{en:e.description||" "},copyright:{en:e.copyright||" "},trademark:{en:e.trademark||" "}};this.unitsPerEm=e.unitsPerEm||1e3;this.ascender=e.ascender;this.descender=e.descender;this.createdTimestamp=e.createdTimestamp;this.tables={os2:{usWeightClass:e.weightClass||this.usWeightClasses.MEDIUM,usWidthClass:e.widthClass||this.usWidthClasses.MEDIUM,fsSelection:e.fsSelection||this.fsSelectionValues.REGULAR}}}this.supported=true;this.glyphs=new Qu.GlyphSet(this,e.glyphs||[]);this.encoding=new Lu(this);this.substitution=new Fc(this);this.tables=this.tables||{};Object.defineProperty(this,"hinting",{get:function(){if(this._hinting){return this._hinting}if(this.outlinesFormat==="truetype"){return this._hinting=new Xc(this)}}})}nd.prototype.hasChar=function(e){return this.encoding.charToGlyphIndex(e)!==null};nd.prototype.charToGlyphIndex=function(e){return this.encoding.charToGlyphIndex(e)};nd.prototype.charToGlyph=function(e){var t=this.charToGlyphIndex(e);var r=this.glyphs.get(t);if(!r){r=this.glyphs.get(0)}return r};nd.prototype.stringToGlyphs=function(e,t){var r=this;t=t||this.defaultRenderOptions;var n=[];for(var i=0;i<e.length;i+=1){var a=e[i];n.push(r.charToGlyphIndex(a))}var o=n.length;if(t.features){var s=t.script||this.substitution.getDefaultScriptName();var l=[];if(t.features.liga){l=l.concat(this.substitution.getFeature("liga",s,t.language))}if(t.features.rlig){l=l.concat(this.substitution.getFeature("rlig",s,t.language))}for(var u=0;u<o;u+=1){for(var h=0;h<l.length;h++){var c=l[h];var f=c.sub;var p=f.length;var d=0;while(d<p&&f[d]===n[u+d]){d++}if(d===p){n.splice(u,p,c.by);o=o-p+1}}}}var v=new Array(o);var m=this.glyphs.get(0);for(var _=0;_<o;_+=1){v[_]=r.glyphs.get(n[_])||m}return v};nd.prototype.nameToGlyphIndex=function(e){return this.glyphNames.nameToGlyphIndex(e)};nd.prototype.nameToGlyph=function(e){var t=this.nameToGlyphIndex(e);var r=this.glyphs.get(t);if(!r){r=this.glyphs.get(0)}return r};nd.prototype.glyphIndexToName=function(e){if(!this.glyphNames.glyphIndexToName){return""}return this.glyphNames.glyphIndexToName(e)};nd.prototype.getKerningValue=function(e,t){e=e.index||e;t=t.index||t;var r=this.getGposKerningValue;return r?r(e,t):this.kerningPairs[e+","+t]||0};nd.prototype.defaultRenderOptions={kerning:true,features:{liga:true,rlig:true}};nd.prototype.forEachGlyph=function(e,t,r,n,i,a){var o=this;t=t!==undefined?t:0;r=r!==undefined?r:0;n=n!==undefined?n:72;i=i||this.defaultRenderOptions;var s=1/this.unitsPerEm*n;var l=this.stringToGlyphs(e,i);for(var u=0;u<l.length;u+=1){var h=l[u];a.call(o,h,t,r,n,i);if(h.advanceWidth){t+=h.advanceWidth*s}if(i.kerning&&u<l.length-1){var c=o.getKerningValue(h,l[u+1]);t+=c*s}if(i.letterSpacing){t+=i.letterSpacing*n}else if(i.tracking){t+=i.tracking/1e3*n}}return t};nd.prototype.getPath=function(e,t,r,n,i){var a=new Il;this.forEachGlyph(e,t,r,n,i,function(e,t,r,n){var o=e.getPath(t,r,n,i,this);a.extend(o)});return a};nd.prototype.getPaths=function(e,t,r,n,i){var a=[];this.forEachGlyph(e,t,r,n,i,function(e,t,r,n){var o=e.getPath(t,r,n,i,this);a.push(o)});return a};nd.prototype.getAdvanceWidth=function(e,t,r){return this.forEachGlyph(e,0,0,t,r,function(){})};nd.prototype.draw=function(e,t,r,n,i,a){this.getPath(t,r,n,i,a).draw(e)};nd.prototype.drawPoints=function(e,t,r,n,i,a){this.forEachGlyph(t,r,n,i,a,function(t,r,n,i){t.drawPoints(e,r,n,i)})};nd.prototype.drawMetrics=function(e,t,r,n,i,a){this.forEachGlyph(t,r,n,i,a,function(t,r,n,i){t.drawMetrics(e,r,n,i)})};nd.prototype.getEnglishName=function(e){var t=this.names[e];if(t){return t.en}};nd.prototype.validate=function(){var e=[];var t=this;function r(t,r){if(!t){e.push(r)}}function n(e){var n=t.getEnglishName(e);r(n&&n.trim().length>0,"No English "+e+" specified.")}n("fontFamily");n("weightName");n("manufacturer");n("copyright");n("version");r(this.unitsPerEm>0,"No unitsPerEm specified.")};nd.prototype.toTables=function(){return Dc.fontToTable(this)};nd.prototype.toBuffer=function(){console.warn("Font.toBuffer is deprecated. Use Font.toArrayBuffer instead.");return this.toArrayBuffer()};nd.prototype.toArrayBuffer=function(){var e=this.toTables();var t=e.encode();var r=new ArrayBuffer(t.length);var n=new Uint8Array(r);for(var i=0;i<t.length;i++){n[i]=t[i]}return r};nd.prototype.download=function(e){var t=this.getEnglishName("fontFamily");var r=this.getEnglishName("fontSubfamily");e=e||t.replace(/\s/g,"")+"-"+r+".otf";var n=this.toArrayBuffer();if(kc()){window.requestFileSystem=window.requestFileSystem||window.webkitRequestFileSystem;window.requestFileSystem(window.TEMPORARY,n.byteLength,function(t){t.root.getFile(e,{create:true},function(e){e.createWriter(function(t){var r=new DataView(n);var i=new Blob([r],{type:"font/opentype"});t.write(i);t.addEventListener("writeend",function(){location.href=e.toURL()},false)})})},function(e){throw new Error(e.name+": "+e.message)})}else{var i=require("fs");var a=Vc(n);i.writeFileSync(e,a)}};nd.prototype.fsSelectionValues={ITALIC:1,UNDERSCORE:2,NEGATIVE:4,OUTLINED:8,STRIKEOUT:16,BOLD:32,REGULAR:64,USER_TYPO_METRICS:128,WWS:256,OBLIQUE:512};nd.prototype.usWidthClasses={ULTRA_CONDENSED:1,EXTRA_CONDENSED:2,CONDENSED:3,SEMI_CONDENSED:4,MEDIUM:5,SEMI_EXPANDED:6,EXPANDED:7,EXTRA_EXPANDED:8,ULTRA_EXPANDED:9};nd.prototype.usWeightClasses={THIN:100,EXTRA_LIGHT:200,LIGHT:300,NORMAL:400,MEDIUM:500,SEMI_BOLD:600,BOLD:700,EXTRA_BOLD:800,BLACK:900};function id(e,t){var r=JSON.stringify(e);var n=256;for(var i in t){var a=parseInt(i);if(!a||a<256){continue}if(JSON.stringify(t[i])===r){return a}if(n<=a){n=a+1}}t[n]=e;return n}function ad(e,t,r){var n=id(t.name,r);return[{name:"tag_"+e,type:"TAG",value:t.tag},{name:"minValue_"+e,type:"FIXED",value:t.minValue<<16},{name:"defaultValue_"+e,type:"FIXED",value:t.defaultValue<<16},{name:"maxValue_"+e,type:"FIXED",value:t.maxValue<<16},{name:"flags_"+e,type:"USHORT",value:0},{name:"nameID_"+e,type:"USHORT",value:n}]}function od(e,t,r){var n={};var i=new _u.Parser(e,t);n.tag=i.parseTag();n.minValue=i.parseFixed();n.defaultValue=i.parseFixed();n.maxValue=i.parseFixed();i.skip("uShort",1);n.name=r[i.parseUShort()]||{};return n}function sd(e,t,r,n){var i=id(t.name,n);var a=[{name:"nameID_"+e,type:"USHORT",value:i},{name:"flags_"+e,type:"USHORT",value:0}];for(var o=0;o<r.length;++o){var s=r[o].tag;a.push({name:"axis_"+e+" "+s,type:"FIXED",value:t.coordinates[s]<<16})}return a}function ld(e,t,r,n){var i={};var a=new _u.Parser(e,t);i.name=n[a.parseUShort()]||{};a.skip("uShort",1);i.coordinates={};for(var o=0;o<r.length;++o){i.coordinates[r[o].tag]=a.parseFixed()}return i}function ud(e,t){var r=new iu.Table("fvar",[{name:"version",type:"ULONG",value:65536},{name:"offsetToData",type:"USHORT",value:0},{name:"countSizePairs",type:"USHORT",value:2},{name:"axisCount",type:"USHORT",value:e.axes.length},{name:"axisSize",type:"USHORT",value:20},{name:"instanceCount",type:"USHORT",value:e.instances.length},{name:"instanceSize",type:"USHORT",value:4+e.axes.length*4}]);r.offsetToData=r.sizeOf();for(var n=0;n<e.axes.length;n++){r.fields=r.fields.concat(ad(n,e.axes[n],t))}for(var i=0;i<e.instances.length;i++){r.fields=r.fields.concat(sd(i,e.instances[i],e.axes,t))}return r}function hd(e,t,r){var n=new _u.Parser(e,t);var i=n.parseULong();Ol.argument(i===65536,"Unsupported fvar table version.");var a=n.parseOffset16();n.skip("uShort",1);var o=n.parseUShort();var s=n.parseUShort();var l=n.parseUShort();var u=n.parseUShort();var h=[];for(var c=0;c<o;c++){h.push(od(e,t+a+c*s,r))}var f=[];var p=t+a+o*s;for(var d=0;d<l;d++){f.push(ld(e,p+d*u,h,r))}return{axes:h,instances:f}}var cd={make:ud,parse:hd};function fd(e,t){var r=new _u.Parser(e,t);var n=r.parseUShort();var i=[];for(var a=0;a<n;a++){i[r.parseTag()]={offset:r.parseUShort()}}return i}function pd(e,t){var r=new _u.Parser(e,t);var n=r.parseUShort();var i=r.parseUShort();if(n===1){return r.parseUShortList(i)}else if(n===2){var a=[];for(;i--;){var o=r.parseUShort();var s=r.parseUShort();var l=r.parseUShort();for(var u=o;u<=s;u++){a[l++]=u}}return a}}function dd(e,t){var r=new _u.Parser(e,t);var n=r.parseUShort();if(n===1){var i=r.parseUShort();var a=r.parseUShort();var o=r.parseUShortList(a);return function(e){return o[e-i]||0}}else if(n===2){var s=r.parseUShort();var l=[];var u=[];var h=[];for(var c=0;c<s;c++){l[c]=r.parseUShort();u[c]=r.parseUShort();h[c]=r.parseUShort()}return function(e){var t=0;var r=l.length-1;while(t<r){var n=t+r+1>>1;if(e<l[n]){r=n-1}else{t=n}}if(l[t]<=e&&e<=u[t]){return h[t]||0}return 0}}}function vd(e,t){var r=new _u.Parser(e,t);var n=r.parseUShort();var i=r.parseUShort();var a=pd(e,t+i);var o=r.parseUShort();var s=r.parseUShort();var l;var u;if(o!==4||s!==0){return}var h={};if(n===1){var c=r.parseUShort();var f=[];var p=r.parseOffset16List(c);for(var d=0;d<c;d++){var v=p[d];var m=h[v];if(!m){m={};r.relativeOffset=v;var _=r.parseUShort();for(;_--;){var g=r.parseUShort();if(o){l=r.parseShort()}if(s){u=r.parseShort()}m[g]=l}}f[a[d]]=m}return function(e,t){var r=f[e];if(r){return r[t]}}}else if(n===2){var y=r.parseUShort();var x=r.parseUShort();var b=r.parseUShort();var w=r.parseUShort();var T=dd(e,t+y);var E=dd(e,t+x);var S=[];for(var M=0;M<b;M++){var A=S[M]=[];for(var R=0;R<w;R++){if(o){l=r.parseShort()}if(s){u=r.parseShort()}A[R]=l}}var L={};for(var C=0;C<a.length;C++){L[a[C]]=1}return function(e,t){if(!L[e]){return}var r=T(e);var n=E(t);var i=S[r];if(i){return i[n]}}}}function md(e,t){var r=new _u.Parser(e,t);var n=r.parseUShort();var i=r.parseUShort();var a=i&16;var o=r.parseUShort();var s=r.parseOffset16List(o);var l={lookupType:n,lookupFlag:i,markFilteringSet:a?r.parseUShort():-1};if(n===2){var u=[];for(var h=0;h<o;h++){var c=vd(e,t+s[h]);if(c){u.push(c)}}l.getKerningValue=function(e,t){for(var r=u.length;r--;){var n=u[r](e,t);if(n!==undefined){return n}}return 0}}return l}function _d(e,t,r){var n=new _u.Parser(e,t);var i=n.parseFixed();Ol.argument(i===1,"Unsupported GPOS table version.");fd(e,t+n.parseUShort());fd(e,t+n.parseUShort());var a=n.parseUShort();n.relativeOffset=a;var o=n.parseUShort();var s=n.parseOffset16List(o);var l=t+a;for(var u=0;u<o;u++){var h=md(e,l+s[u]);if(h.lookupType===2&&!r.getGposKerningValue){r.getGposKerningValue=h.getKerningValue}}}var gd={parse:_d};function yd(e){var t={};e.skip("uShort");var r=e.parseUShort();Ol.argument(r===0,"Unsupported kern sub-table version.");e.skip("uShort",2);var n=e.parseUShort();e.skip("uShort",3);for(var i=0;i<n;i+=1){var a=e.parseUShort();var o=e.parseUShort();var s=e.parseShort();t[a+","+o]=s}return t}function xd(e){var t={};e.skip("uShort");var r=e.parseULong();if(r>1){console.warn("Only the first kern subtable is supported.")}e.skip("uLong");var n=e.parseUShort();var i=n&255;e.skip("uShort");if(i===0){var a=e.parseUShort();e.skip("uShort",3);for(var o=0;o<a;o+=1){var s=e.parseUShort();var l=e.parseUShort();var u=e.parseShort();t[s+","+l]=u}}return t}function bd(e,t){var r=new _u.Parser(e,t);var n=r.parseUShort();if(n===0){return yd(r)}else if(n===1){return xd(r)}else{throw new Error("Unsupported kern table version ("+n+").")}}var wd={parse:bd};function Td(e,t,r,n){var i=new _u.Parser(e,t);var a=n?i.parseUShort:i.parseULong;var o=[];for(var s=0;s<r+1;s+=1){var l=a.call(i);if(n){l*=2}o.push(l)}return o}var Ed={parse:Td};function Sd(e,t){var r=[];var n=12;for(var i=0;i<t;i+=1){var a=_u.getTag(e,n);var o=_u.getULong(e,n+4);var s=_u.getULong(e,n+8);var l=_u.getULong(e,n+12);r.push({tag:a,checksum:o,offset:s,length:l,compression:false});n+=16}return r}function Md(e,t){var r=[];var n=44;for(var i=0;i<t;i+=1){var a=_u.getTag(e,n);var o=_u.getULong(e,n+4);var s=_u.getULong(e,n+8);var l=_u.getULong(e,n+12);var u=void 0;if(s<l){u="WOFF"}else{u=false}r.push({tag:a,offset:o,compression:u,compressedLength:s,length:l});n+=20}return r}function Ad(e,t){if(t.compression==="WOFF"){var r=new Uint8Array(e.buffer,t.offset+2,t.compressedLength-2);var n=new Uint8Array(t.length);Rl(r,n);if(n.byteLength!==t.length){throw new Error("Decompression error: "+t.tag+" decompressed length doesn't match recorded length")}var i=new DataView(n.buffer,0);return{data:i,offset:0}}else{return{data:e,offset:t.offset}}}function Rd(e){var t;var r;var n=new nd({empty:true});var i=new DataView(e,0);var a;var o=[];var s=_u.getTag(i,0);if(s===String.fromCharCode(0,1,0,0)||s==="true"||s==="typ1"){n.outlinesFormat="truetype";a=_u.getUShort(i,4);o=Sd(i,a)}else if(s==="OTTO"){n.outlinesFormat="cff";a=_u.getUShort(i,4);o=Sd(i,a)}else if(s==="wOFF"){var l=_u.getTag(i,4);if(l===String.fromCharCode(0,1,0,0)){n.outlinesFormat="truetype"}else if(l==="OTTO"){n.outlinesFormat="cff"}else{throw new Error("Unsupported OpenType flavor "+s)}a=_u.getUShort(i,12);o=Md(i,a)}else{throw new Error("Unsupported OpenType signature "+s)}var u;var h;var c;var f;var p;var d;var v;var m;var _;var g;var y;for(var x=0;x<a;x+=1){var b=o[x];var w=void 0;switch(b.tag){case"cmap":w=Ad(i,b);n.tables.cmap=Eu.parse(w.data,w.offset);n.encoding=new Cu(n.tables.cmap);break;case"cvt ":w=Ad(i,b);y=new _u.Parser(w.data,w.offset);n.tables.cvt=y.parseShortList(b.length/2);break;case"fvar":h=b;break;case"fpgm":w=Ad(i,b);y=new _u.Parser(w.data,w.offset);n.tables.fpgm=y.parseByteList(b.length);break;case"head":w=Ad(i,b);n.tables.head=Oh.parse(w.data,w.offset);n.unitsPerEm=n.tables.head.unitsPerEm;t=n.tables.head.indexToLocFormat;break;case"hhea":w=Ad(i,b);n.tables.hhea=Fh.parse(w.data,w.offset);n.ascender=n.tables.hhea.ascender;n.descender=n.tables.hhea.descender;n.numberOfHMetrics=n.tables.hhea.numberOfHMetrics;break;case"hmtx":d=b;break;case"ltag":w=Ad(i,b);r=Wh.parse(w.data,w.offset);break;case"maxp":w=Ad(i,b);n.tables.maxp=qh.parse(w.data,w.offset);n.numGlyphs=n.tables.maxp.numGlyphs;break;case"name":_=b;break;case"OS/2":w=Ad(i,b);n.tables.os2=pc.parse(w.data,w.offset);break;case"post":w=Ad(i,b);n.tables.post=mc.parse(w.data,w.offset);n.glyphNames=new Uu(n.tables.post);break;case"prep":w=Ad(i,b);y=new _u.Parser(w.data,w.offset);n.tables.prep=y.parseByteList(b.length);break;case"glyf":c=b;break;case"loca":m=b;break;case"CFF ":u=b;break;case"kern":v=b;break;case"GPOS":f=b;break;case"GSUB":p=b;break;case"meta":g=b;break}}var T=Ad(i,_);n.tables.name=lc.parse(T.data,T.offset,r);n.names=n.tables.name;if(c&&m){var E=t===0;var S=Ad(i,m);var M=Ed.parse(S.data,S.offset,n.numGlyphs,E);var A=Ad(i,c);n.glyphs=Wu.parse(A.data,A.offset,M,n)}else if(u){var R=Ad(i,u);Ih.parse(R.data,R.offset,n)}else{throw new Error("Font doesn't contain TrueType or CFF outlines.")}var L=Ad(i,d);kh.parse(L.data,L.offset,n.numberOfHMetrics,n.numGlyphs,n.glyphs);Du(n);if(v){var C=Ad(i,v);n.kerningPairs=wd.parse(C.data,C.offset)}else{n.kerningPairs={}}if(f){var I=Ad(i,f);gd.parse(I.data,I.offset,n)}if(p){var U=Ad(i,p);n.tables.gsub=wc.parse(U.data,U.offset)}if(h){var D=Ad(i,h);n.tables.fvar=cd.parse(D.data,D.offset,n.names)}if(g){var O=Ad(i,g);n.tables.meta=Sc.parse(O.data,O.offset);n.metas=n.tables.meta}return n}function Ld(e,t,r){r=r||{};this.w=e||64;this.h=t||64;this.autoResize=!!r.autoResize;this.shelves=[];this.freebins=[];this.stats={};this.bins={};this.maxId=0}Ld.prototype.pack=function(e,t){var r=this;e=[].concat(e);t=t||{};var n=[],i,a,o,s;for(var l=0;l<e.length;l++){i=e[l].w||e[l].width;a=e[l].h||e[l].height;o=e[l].id;if(i&&a){s=r.packOne(i,a,o);if(!s){continue}if(t.inPlace){e[l].x=s.x;e[l].y=s.y;e[l].id=s.id}n.push(s)}}this.shrink();return n};Ld.prototype.packOne=function(e,t,r){var n=this;var i={freebin:-1,shelf:-1,waste:Infinity},a=0,o,s,l,u;if(typeof r==="string"||typeof r==="number"){o=this.getBin(r);if(o){this.ref(o);return o}if(typeof r==="number"){this.maxId=Math.max(r,this.maxId)}}else{r=++this.maxId}for(u=0;u<this.freebins.length;u++){o=n.freebins[u];if(t===o.maxh&&e===o.maxw){return n.allocFreebin(u,e,t,r)}if(t>o.maxh||e>o.maxw){continue}if(t<=o.maxh&&e<=o.maxw){l=o.maxw*o.maxh-e*t;if(l<i.waste){i.waste=l;i.freebin=u}}}for(u=0;u<this.shelves.length;u++){s=n.shelves[u];a+=s.h;if(e>s.free){continue}if(t===s.h){return n.allocShelf(u,e,t,r)}if(t>s.h){continue}if(t<s.h){l=(s.h-t)*e;if(l<i.waste){i.freebin=-1;i.waste=l;i.shelf=u}}}if(i.freebin!==-1){return this.allocFreebin(i.freebin,e,t,r)}if(i.shelf!==-1){return this.allocShelf(i.shelf,e,t,r)}if(t<=this.h-a&&e<=this.w){s=new Cd(a,this.w,t);return this.allocShelf(this.shelves.push(s)-1,e,t,r)}if(this.autoResize){var h,c,f,p;h=c=this.h;f=p=this.w;if(f<=h||e>f){p=Math.max(e,f)*2}if(h<f||t>h){c=Math.max(t,h)*2}this.resize(p,c);return this.packOne(e,t,r)}return null};Ld.prototype.allocFreebin=function(e,t,r,n){var i=this.freebins.splice(e,1)[0];i.id=n;i.w=t;i.h=r;i.refcount=0;this.bins[n]=i;this.ref(i);return i};Ld.prototype.allocShelf=function(e,t,r,n){var i=this.shelves[e];var a=i.alloc(t,r,n);this.bins[n]=a;this.ref(a);return a};Ld.prototype.shrink=function(){var e=this;if(this.shelves.length>0){var t=0;var r=0;for(var n=0;n<this.shelves.length;n++){var i=e.shelves[n];r+=i.h;t=Math.max(i.w-i.free,t)}this.resize(t,r)}};Ld.prototype.getBin=function(e){return this.bins[e]};Ld.prototype.ref=function(e){if(++e.refcount===1){var t=e.h;this.stats[t]=(this.stats[t]|0)+1}return e.refcount};Ld.prototype.unref=function(e){if(e.refcount===0){return 0}if(--e.refcount===0){this.stats[e.h]--;delete this.bins[e.id];this.freebins.push(e)}return e.refcount};Ld.prototype.clear=function(){this.shelves=[];this.freebins=[];this.stats={};this.bins={};this.maxId=0};Ld.prototype.resize=function(e,t){var r=this;this.w=e;this.h=t;for(var n=0;n<this.shelves.length;n++){r.shelves[n].resize(e)}return true};function Cd(e,t,r){this.x=0;this.y=e;this.w=this.free=t;this.h=r}Cd.prototype.alloc=function(e,t,r){if(e>this.free||t>this.h){return null}var n=this.x;this.x+=e;this.free-=e;return new Id(r,n,this.y,e,t,e,this.h)};Cd.prototype.resize=function(e){this.free+=e-this.w;this.w=e;return true};function Id(e,t,r,n,i,a,o){this.id=e;this.x=t;this.y=r;this.w=n;this.h=i;this.maxw=a||n;this.maxh=o||i;this.refcount=0}var Ud=function(e){function t(t,r,n){if(r===void 0)r=1024;if(n===void 0)n=1024;e.call(this);this._font=null;this._padding=2;this._fontScale=1;this._textCache={};this._packer=new Ld(r,n);this._packCanvas=document.createElement("canvas");this._packCanvas.width=r;this._packCanvas.height=n;this._fontAtlas=new Pa(t,r,n);this._fontAtlas.mipmap=false;this._fontAtlas.premultiplyAlpha=true;this._defaultGlyph={id:32,x:0,y:0,width:16,height:16,xoffset:0,yoffset:0,xadvance:16,uvs:[Rt.new(0,0),Rt.new(0,0),Rt.new(0,0),Rt.new(0,0)]};this._type="opentype"}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;var r={font:{configurable:true},texture:{configurable:true},size:{configurable:true},lineHeight:{configurable:true}};r.font.set=function(e){this._font=e;this._fontScale=this._size/this._font.unitsPerEm};r.font.get=function(){return this._font};r.texture.get=function(){return this._fontAtlas};r.size.set=function(e){if(this._size!==e){this._size=e;this.clear()}};r.lineHeight.set=function(e){if(this._lineHeight!==e){this._lineHeight=e;this.clear()}};t.prototype.addText=function e(t){if(this._textCache[t]===undefined){this._textCache[t]=t;this._addTextToFontAtlas(t)}};t.prototype.removeText=function e(t){if(this._textCache[t]===undefined){console.warn("can not remove text: '"+t+"' from font. not exists.")}else{this._removeTextFromFontAtlas(t);delete this._textCache[t]}};t.prototype.clear=function e(){this._packer.clear();var t=this._packCanvas.getContext("2d");t.clearRect(0,0,this._packCanvas.width,this._packCanvas.height);this._fontAtlas.setImages([this._packCanvas]);this._fontAtlas.commit()};t.prototype._addTextToFontAtlas=function e(t){var r=this;var n=this._packCanvas.getContext("2d");var i=false;for(var a=0;a<t.length;++a){var o=t[a];var s=t.charCodeAt(a);var l=r._font.charToGlyph(o);if(l.path.getBoundingBox===undefined){continue}var u=l.getBoundingBox();var h={id:s,x:0,y:0,width:0,height:0,xoffset:0,yoffset:0,xadvance:0};h.width=(u.x2-u.x1)*r._fontScale;h.height=(u.y2-u.y1)*r._fontScale;if(r._glyphs[s]!==undefined){r._packer.packOne(h.width,h.height,h.id)}else{i=true;h.xadvance=l.advanceWidth*r._fontScale;r._glyphs[s]=h;var c=r._packer.packOne(h.width+r._padding,h.height+r._padding,h.id);if(c!==null){h.xoffset=u.x1*r._fontScale;h.yoffset=r._size-u.y2*r._fontScale+r._font.descender*r._fontScale;var f=(c.x+r._padding/2)/r._packCanvas.width;var p=(c.x+r._padding/2+h.width)/r._packCanvas.width;var d=1-(c.y+r._padding/2+h.height)/r._packCanvas.height;var v=1-(c.y+r._padding/2)/r._packCanvas.height;h.uvs=[Rt.new(f,d),Rt.new(p,d),Rt.new(f,v),Rt.new(p,v)];var m=l.getPath(c.x-u.x1*r._fontScale+r._padding/2,c.y+u.y2*r._fontScale+r._padding/2,r._size,{xScale:r._fontScale,yScale:r._fontScale});m.fill="#FFFFFF";m.draw(n)}else{console.error("font glyph pack failed. font atlas size is not enough.")}}}if(i){this._fontAtlas.setImages([this._packCanvas]);this._fontAtlas.commit()}};t.prototype._removeTextFromFontAtlas=function e(t){var r=this;var n=this._packCanvas.getContext("2d");var i=false;for(var a=0;a<t.length;++a){var o=t.charCodeAt(a);if(r._glyphs[o]!==undefined){var s=r._packer.getBin(o);var l=r._packer.unref(s);if(l===0){delete r._glyphs[o];n.clearRect(s.x,s.y,s.w,s.h);i=true}}else{console.warn("try to remove a no exist glyph.")}}if(i){this._fontAtlas.setImages([this._packCanvas]);this._fontAtlas.commit()}};Object.defineProperties(t.prototype,r);return t}(tl);function Dd(e,t,r){var n={};n.bin={type:"binary",src:t.bin};if(t.json){n.json={type:"text",parser:JSON.parse,src:t.json}}Ea({manifest:n,onDone:function t(n){var i=n.bin;var a=n.json;var o=null;if(a&&a.width&&a.height){o=new Ud(e.device,a.width,a.height)}else{o=new Ud(e.device,512,512)}var s=Rd(i);o.font=s;o.size=a.size?a.size:32;o.lineHeight=a.lineHeight?a.lineHeight:32;r(null,o)}})}var Od={float:Ui.PARAM_FLOAT,float2:Ui.PARAM_FLOAT2,float3:Ui.PARAM_FLOAT3,float4:Ui.PARAM_FLOAT4,color3:Ui.PARAM_COLOR3,color4:Ui.PARAM_COLOR4,texture2d:Ui.PARAM_TEXTURE_2D,textureCube:Ui.PARAM_TEXTURE_CUBE};var Bd={back:Me.CULL_BACK,front:Me.CULL_FRONT,add:Me.BLEND_FUNC_ADD,subtract:Me.BLEND_FUNC_SUBTRACT,reverseSubtract:Me.BLEND_FUNC_REVERSE_SUBTRACT,zero:Me.BLEND_ZERO,one:Me.BLEND_ONE,srcColor:Me.BLEND_SRC_COLOR,oneMinusSrcColor:Me.BLEND_ONE_MINUS_SRC_COLOR,dstColor:Me.BLEND_DST_COLOR,oneMinusDstColor:Me.BLEND_ONE_MINUS_DST_COLOR,srcAlpha:Me.BLEND_SRC_ALPHA,oneMinusSrcAlpha:Me.BLEND_ONE_MINUS_SRC_ALPHA,dstAlpha:Me.BLEND_DST_ALPHA,oneMinusDstAlpha:Me.BLEND_ONE_MINUS_DST_ALPHA,constColor:Me.BLEND_CONSTANT_COLOR,oneMinusConstColor:Me.BLEND_ONE_MINUS_CONSTANT_COLOR,constAlpha:Me.BLEND_CONSTANT_ALPHA,oneMinusConstAlpha:Me.BLEND_ONE_MINUS_CONSTANT_ALPHA,srcAlphaSaturate:Me.BLEND_SRC_ALPHA_SATURATE};Bd[true]=true;Bd[false]=false;function Pd(e){var t=new ps;t._name=e.name;t._uuid="custom-effect-"+e.name;t._loaded=true;for(var r=0;r<e.techniques.length;++r){var n=e.techniques[r];for(var i=0;i<n.params.length;++i){var a=n.params[i];a.type=Od[a.type]}for(var o=0;o<n.passes.length;++o){var s=n.passes[o];for(var l in s){if(l==="program"){continue}s[l]=Bd[s[l]]}}}t.techniques=e.techniques;t.properties=e.properties;t.defines=e.defines;t.dependencies=e.dependencies?e.dependencies:[];return t}function Fd(e,t,r){Ea({manifest:{json:{type:"text",parser:JSON.parse,src:t.json}},onDone:function e(t){var n=t.json;var i=Pd(n);r(null,i)}})}function zd(e){return e.replace(/\/\/.*/g,"")}function Nd(e,t){var r=/#include +<([\w\d\-_.]+)>/gm;function n(e,r){var n=t[r];if(n===undefined){console.error("can not resolve #include <"+r+">")}return Nd(n)}return e.replace(r,n)}function kd(e,t,r,n){t=Nd(zd(t),n);r=Nd(zd(r),n);var i=[];for(var a in e){var o={name:a};if(e[a]&&e[a].min!==undefined){o.min=e[a].min}if(e[a]&&e[a].max!==undefined){o.max=e[a].max}i.push(o)}return{vert:t,frag:r,defines:i}}function Vd(e,t){Ea({manifest:{json:{type:"text",parser:JSON.parse,src:t.json},vert:{type:"text",src:t.vert},frag:{type:"text",src:t.frag}},onDone:function r(n){var i=n.json;var a=n.vert;var o=n.frag;var s=kd(i,a,o,e._forward._programLib._chunks);e._forward._programLib.define(t.name,s.vert,s.frag,s.defines)}})}var Gd=function(e){function t(){e.call(this);this._startedFlag=0}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.onInit=function e(){this._system.add(this)};t.prototype.onDestroy=function e(){this._system.remove(this)};t.prototype.awake=function e(){};t.prototype.start=function e(){};t.prototype.tick=function e(){};t.prototype.postTick=function e(){};t.prototype.end=function e(){};return t}(Yi);var Wd=function(e){function t(){e.call(this);this._camera=new Ui.Camera}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.onInit=function e(){this._camera.setStages(["opaque","transparent"]);this._camera.setNode(this._entity);this.projection=this._projection;this.priority=this._priority;this.fov=this._fov;this.orthoHeight=this._orthoHeight;this.near=this._near;this.far=this._far;this.color=this._color;this.depth=this._depth;this.stencil=this._stencil;this.clearFlags=this._clearFlags;this.rect=this._rect};t.prototype.onEnable=function e(){this._app.scene.addCamera(this._camera)};t.prototype.onDisable=function e(){this._app.scene.removeCamera(this._camera)};return t}(Yi);Wd.schema={projection:{type:"enums",default:"perspective",options:["ortho","perspective"],set:function e(t){this._projection=t;var r=Ui.PROJ_PERSPECTIVE;if(this._projection==="ortho"){r=Ui.PROJ_ORTHO}this._camera.setType(r)}},priority:{type:"number",default:0,set:function e(t){this._priority=t;this._camera.setPriority(t)}},fov:{type:"number",default:45,set:function e(t){this._fov=t;this._camera.setFov(Xe(t))}},orthoHeight:{type:"number",default:10,set:function e(t){this._orthoHeight=t;this._camera.setOrthoHeight(t)}},near:{type:"number",default:.01,set:function e(t){this._near=t;this._camera.setNear(t)}},far:{type:"number",default:1e3,set:function e(t){this._far=t;this._camera.setFar(t)}},color:{type:"color4",default:[.2,.3,.47,1],set:function e(t){this._color=t;this._camera.setColor(t.r,t.g,t.b,t.a)}},depth:{type:"number",default:1,set:function e(t){this._depth=t;this._camera.setDepth(t)}},stencil:{type:"number",default:0,set:function e(t){this._stencil=t;this._camera.setStencil(t)}},clearFlags:{type:"number",default:3,set:function e(t){this._clearFlags=t;this._camera.setClearFlags(t)}},rect:{type:"rect",default:[0,0,1,1],set:function e(t){this._rect=t;this._camera.setRect(t[0],t[1],t[2],t[3])}}};var Hd=function(e){function t(){e.call(this);this._light=new Ui.Light}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.onInit=function e(){this._light.setNode(this._entity);this.type=this._type;this.color=this._color;this.intensity=this._intensity;this.range=this._range;this.spotAngle=this._spotAngle;this.spotExp=this._spotExp;this.shadowType=this._shadowType;this.shadowResolution=this._shadowResolution;this.shadowDarkness=this._shadowDarkness;this.shadowMinDepth=this._shadowMinDepth;this.shadowMaxDepth=this._shadowMaxDepth;this.shadowDepthScale=this._shadowDepthScale;this.shadowFrustumSize=this._shadowFrustumSize;this.shadowBias=this._shadowBias};t.prototype.onEnable=function e(){this._app.scene.addLight(this._light)};t.prototype.onDisable=function e(){this._app.scene.removeLight(this._light)};return t}(Yi);Hd.schema={type:{type:"enums",default:"directional",options:["directional","point","spot"],set:function e(t){this._type=t;var r=Ui.LIGHT_DIRECTIONAL;if(this._type==="point"){r=Ui.LIGHT_POINT}else if(this._type==="spot"){r=Ui.LIGHT_SPOT}this._light.setType(r)}},color:{type:"color3",default:[1,1,1],set:function e(t){this._color=t;this._light.setColor(t.r,t.g,t.b)}},intensity:{type:"number",default:1,set:function e(t){this._intensity=t;this._light.setIntensity(t)}},range:{type:"number",default:1,set:function e(t){this._range=t;this._light.setRange(t)}},spotAngle:{type:"number",default:60,set:function e(t){this._spotAngle=t;this._light.setSpotAngle(Xe(t))}},spotExp:{type:"number",default:1,set:function e(t){this._spotExp=t;this._light.setSpotExp(t)}},shadowType:{type:"enums",default:"none",options:["none","hard","soft"],set:function e(t){this._shadowType=t;var r=Ui.SHADOW_NONE;if(t==="hard"){r=Ui.SHADOW_HARD}else if(t==="soft"){r=Ui.SHADOW_SOFT}this._light.setShadowType(r)}},shadowResolution:{type:"number",default:1024,set:function e(t){this._shadowResolution=t;this._light.setShadowResolution(t)}},shadowDarkness:{type:"number",default:.5,set:function e(t){this._shadowDarkness=t;this._light.setShadowDarkness(t)}},shadowMinDepth:{type:"number",default:1,set:function e(t){this._shadowMinDepth=t;this._light.setShadowMinDepth(t)}},shadowMaxDepth:{type:"number",default:1e3,set:function e(t){this._shadowMaxDepth=t;this._light.setShadowMaxDepth(t)}},shadowDepthScale:{type:"number",default:250,set:function e(t){this._shadowDepthScale=t;this._light.setShadowDepthScale(t)}},shadowFrustumSize:{type:"number",default:50,set:function e(t){this._shadowFrustumSize=t;this._light.setShadowFrustumSize(t)}},shadowBias:{type:"number",default:5e-4,set:function e(t){this._shadowBias=t;this._light.setShadowBias(t)}}};var jd=function(e){function t(){e.apply(this,arguments)}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;var r={material:{configurable:true}};t.prototype.onInit=function e(){this._models=[];this.materials=this._materials;this.mesh=this._mesh;this.shadowCastingMode=this._shadowCastingMode;this.receiveShadows=this._receiveShadows};t.prototype.onEnable=function e(){var t=this;for(var r=0;r<this._models.length;++r){t._app.scene.addModel(t._models[r])}};t.prototype.onDisable=function e(){var t=this;for(var r=0;r<this._models.length;++r){t._app.scene.removeModel(t._models[r])}};t.prototype.getMaterial=function e(t){if(this._materials.length===0){return null}if(t<this._materials.length){return this._materials[t]}return this._materials[this._materials.length-1]};r.material.get=function(){return this.getMaterial(0)};r.material.set=function(e){if(this._materials.length===1&&this._materials[0]===e){return}this._materials[0]=e;if(this._models.length>0){this._models[0].setEffect(e.effectInst)}};t.prototype._updateModels=function e(){var t=this;var r=this._mesh?this._mesh.subMeshCount:0;var n=this._models;this._models=new Array(r);for(var i=0;i<r;++i){var a=new Ui.Model;a.createBoundingBox(t._mesh._minPos,t._mesh._maxPos);t._models[i]=a}this._updateModelParams();if(this.enabled){for(var o=0;o<n.length;++o){t._app.scene.removeModel(n[o])}for(var s=0;s<this._models.length;++s){t._app.scene.addModel(t._models[s])}}};t.prototype._updateModelParams=function e(){var t=this;for(var r=0;r<this._models.length;++r){var n=t._models[r];var i=t.getMaterial(r);var a=t._mesh.getSubMesh(r);n.setInputAssembler(a);n.setEffect(i?i.effectInst:null);n.setNode(t._entity)}};t.prototype._updateCastShadow=function e(){var t=this;if(this._shadowCastingMode==="off"){for(var r=0;r<this._models.length;++r){var n=t._models[r];n._castShadow=false}}else if(this._shadowCastingMode==="on"){for(var i=0;i<this._models.length;++i){var a=t._models[i];a._castShadow=true}}else{console.warn("ShadowCastingMode "+this._shadowCastingMode+" is not supported.")}};t.prototype._updateReceiveShadow=function e(){var t=this;for(var r=0;r<this._models.length;++r){var n=t._models[r];if(n._defines["USE_SHADOW_MAP"]!=undefined){n._effect.define("USE_SHADOW_MAP",t._receiveShadows)}}};Object.defineProperties(t.prototype,r);return t}(Yi);jd.schema={materials:{type:"asset",default:[],array:true,set:function e(t){this._materials=t;this._updateModelParams()}},mesh:{type:"asset",default:null,set:function e(t){this._mesh=t;this._updateModels()}},shadowCastingMode:{type:"enums",default:"off",options:["off","on","twoSided","shadowsOnly"],set:function e(t){this._shadowCastingMode=t;this._updateCastShadow()}},receiveShadows:{type:"boolean",default:false,set:function e(t){this._receiveShadows=t;this._updateReceiveShadow()}}};var qd=Bt.create();var Xd=function(e){function t(){e.apply(this,arguments)}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.onInit=function e(){this._models=[];this._jointsTexture=null;this._refSkeleton=null;this._updateModels();this._updateCastShadow();this._updateReceiveShadow();var t=this._entity.parent;var r=t.getComp("Animation");if(r){this._refSkeleton=r.skeleton}else{console.warn("Can not find Animation component in root entity.")}this._system.add(this)};t.prototype.onDestroy=function e(){this._system.remove(this)};t.prototype._updateMatrices=function e(){var t=this;if(!this._mesh||!this._mesh.skinning){return}var r=this._jointsTexture;var n=this._mesh.skinning.jointIndices;var i=this._mesh.skinning.bindposes;for(var a=0;a<n.length;++a){var o=i[a];var s=n[a];var l=t._refSkeleton.getWorldMatrix(s);Bt.multiply(qd,l,o);r.data[16*a+0]=qd.m00;r.data[16*a+1]=qd.m01;r.data[16*a+2]=qd.m02;r.data[16*a+3]=qd.m03;r.data[16*a+4]=qd.m04;r.data[16*a+5]=qd.m05;r.data[16*a+6]=qd.m06;r.data[16*a+7]=qd.m07;r.data[16*a+8]=qd.m08;r.data[16*a+9]=qd.m09;r.data[16*a+10]=qd.m10;r.data[16*a+11]=qd.m11;r.data[16*a+12]=qd.m12;r.data[16*a+13]=qd.m13;r.data[16*a+14]=qd.m14;r.data[16*a+15]=qd.m15}r.commit()};t.prototype._updateModels=function e(){var t=this;if(this._mesh.skinning){if(this._jointsTexture){this._jointsTexture.unload();this._jointsTexture=null}this._jointsTexture=Ka.createJointsTexture(this._app,this._mesh.skinning)}var r=this._mesh?this._mesh.subMeshCount:0;var n=this._models;this._models=new Array(r);for(var i=0;i<r;++i){var a=new Ui.SkinningModel;a.createBoundingBox(t._mesh._minPos,t._mesh._maxPos);t._models[i]=a}this._updateModelParams();if(this.enabled){this._entity.emit("skinning-model-changed",this,"mesh",n)}};t.prototype._updateModelParams=function t(){var r=this;e.prototype._updateModelParams.call(this);for(var n=0;n<this._models.length;++n){r._models[n].setJointsTexture(r._jointsTexture._texture)}};return t}(jd);var Yd=function e(t){this.clip=t;this.blendMode="blend";this.wrapMode="loop";this.speed=1;this.time=0;this.weight=1};var Kd=function e(){this._current=null;this._next=null;this._blendTime=0;this._blendDuration=.3;this._skeleton=null;this._skelFrom=null;this._skelTo=null};Kd.prototype.setSkeleton=function e(t){this._skeleton=t;this._skelFrom=t.clone();this._skelTo=t.clone()};Kd.prototype.crossFade=function e(t,r){if(this._current&&r>0){this._next=t;this._blendTime=0;this._blendDuration=r}else{this._current=t;this._next=null}};Kd.prototype.tick=function e(t){if(this._current&&this._next){var r=this._getTime(this._current);var n=this._getTime(this._next);var i=this._blendTime/this._blendDuration;this._current.time+=t;this._next.time+=t;this._blendTime+=t;if(i>1){this._current=this._next;this._next=null;this._current.clip.sample(this._skeleton,n)}else{this._current.clip.sample(this._skelFrom,r);this._next.clip.sample(this._skelTo,n);this._skeleton.blend(this._skelFrom,this._skelTo,i);this._skeleton.updateMatrices()}return}if(this._current){var a=this._getTime(this._current);this._current.clip.sample(this._skeleton,a);this._current.time+=t}};Kd.prototype._getTime=function e(t){var r=t.time;var n=t.clip.length;if(t.wrapMode==="once"){if(r>n){r=0}}else if(t.wrapMode==="loop"){r%=n}else if(t.wrapMode==="ping-pong"){var i=Math.floor(r/n);if(i%2===1){r=n-r%n}}return r};var Zd=function(e){function t(){e.apply(this,arguments)}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;var r={skeleton:{configurable:true}};t.prototype.onInit=function e(){this._name2states={};this._animCtrl=new Kd;this.clips=this._clips;this.joints=this._joints;this._system.add(this)};t.prototype.onDestroy=function e(){this._system.remove(this)};r.skeleton.get=function(){return this._skeleton};t.prototype.addClip=function e(t,r){if(this._name2states[t]){console.warn("Failed to add clip "+t+", the name already exsits.");return}this._clips.push(r);this._name2states[t]=new Yd(r)};t.prototype.getState=function e(t){return this._name2states[t]};t.prototype.play=function e(t,r){if(r===void 0)r=.3;if(!this._name2states[t]){console.warn("Failed to play animation "+t+", not found.");return}var n=this._name2states[t];n.time=0;this._animCtrl.crossFade(n,r)};t.prototype._updateSkeleton=function e(){this.joints=this._joints};Object.defineProperties(t.prototype,r);return t}(Yi);Zd.schema={clips:{type:"asset",default:[],array:true,set:function e(t){var r=this;this._clips=t;for(var n=0;n<this._clips.length;++n){var i=r._clips[n];if(r._name2states[i.name]){console.warn("Failed to add clip "+i.name+", the name already exsits.");continue}r._name2states[i.name]=new Yd(i)}}},joints:{type:"asset",default:null,set:function e(t){this._joints=t;if(this._joints){this._skeleton=this._joints.instantiate();this._animCtrl.setSkeleton(this._skeleton)}else{this._skeleton=null}}}};var Qd=false;var Jd=false;var $d=false;var ev=[];var tv={};tv.State={ERROR:-1,INITIALZING:0,PLAYING:1,PAUSED:2};var rv=function(e){function t(){e.call(this);this._element=null;this._nextTime=0;this._state=tv.State.INITIALZING}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;var r={currentTime:{configurable:true},duration:{configurable:true},state:{configurable:true},paused:{configurable:true}};t.prototype.onInit=function e(){this._system.add(this);this.clip=this._clip;this.loop=this._loop;this.volume=this._volume;this.playOnAwake=this._playOnAwake};t.prototype.onDestroy=function e(){this._system.remove(this)};t.prototype.play=function e(){this._state=tv.State.PLAYING;if(!this._element){return}this._bindEnded();this._element.play();if(!(Jd||Qd)&&this._clip&&this._clip.loadMode===Ks.DOM_AUDIO&&this._element.paused){ev.push({instance:this,offset:0,audio:this._element})}if($d){return}$d=true;window.addEventListener("touchstart",function(){var e=ev.pop();while(e){e.audio.play(e.offset);e=ev.pop()}})};t.prototype.pause=function e(){if(!this._element){return}this._unbindEnded();this._element.pause();this._state=tv.State.PAUSED};t.prototype.resume=function e(){if(!this._element||this._state===tv.State.PLAYING){return}this._bindEnded();this._element.play();this._state=tv.State.PLAYING};t.prototype.stop=function e(){var t=this;if(!this._element){return}try{this._element.currentTime=0}catch(e){console.log(e)}this._element.pause();for(var r=0;r<ev.length;r++){if(ev[r].instance===t){ev.splice(r,1);break}}this._unbindEnded();this._state=tv.State.PAUSED};r.currentTime.set=function(e){if(this._element){this._nextTime=0}else{this._nextTime=e;return}this._unbindEnded();if(!(Jd||Qd)){this._bindEnded(function(){this._bindEnded()}.bind(this))}try{this._element.currentTime=e}catch(n){var t=this._element;if(t.addEventListener){var r=function(){t.removeEventListener("loadedmetadata",r);t.currentTime=e};t.addEventListener("loadedmetadata",r)}}};r.currentTime.get=function(){return this._element?this._element.currentTime:0};r.duration.get=function(){return this._element?this._element.duration:0};r.state.get=function(){if(!Qd){var e=this._element;if(e&&tv.State.PLAYING===this._state&&e.paused){this._state=tv.State.PAUSED}}return this._state};r.paused.get=function(){return this._element?this._element.paused:true};t.prototype._bindEnded=function e(t){t=t||this._onended;if(this._clip&&this._clip.loadMode===Ks.DOM_AUDIO){this._element.addEventListener("ended",t)}else{this._element.onended=t}};t.prototype._unbindEnded=function e(){if(this._clip&&this._clip.loadMode===Ks.DOM_AUDIO){this._element.removeEventListener("ended",this._onended)}else{this._element.onended=null}};t.prototype._onLoaded=function e(){var t=this._clip.nativeAsset;if(this._clip.loadMode===Ks.DOM_AUDIO||Jd||Qd){this._element=t}else{this._element=new nv(t,this)}this.volume=this._volume;this.loop=this._loop;if(this._nextTime!==0){this.setCurrentTime(this._nextTime)}if(this._state===tv.State.PLAYING||this._playOnAwake){this.play()}else{this._state=tv.State.INITIALZING}};Object.defineProperties(t.prototype,r);return t}(Yi);rv.schema={clip:{type:"asset",default:null,set:function e(t){if(t){this._clip=t;if(t._loaded){this._onLoaded()}else{t.once("load",function(){if(t===this._clip){this._onLoaded()}}.bind(this))}}else{this._clip=null;this._element=null;this._state=tv.State.INITIALZING}return t}},loop:{type:"boolean",default:false,set:function e(t){this._loop=t;if(this._element){this._element.loop=t}}},playOnAwake:{type:"boolean",default:true,set:function e(t){this._playOnAwake=t;if(t){this._state=tv.State.PLAYING}}},volume:{type:"number",default:1,set:function e(t){this._volume=t;if(this._element){this._element.volume=t}}}};var nv=function(e,t){this._audio=t;this._context=this._audio._system.__audioSupport.context;this._buffer=e;this._gainObj=this._context["createGain"]();this._volume=1;if(this._gainObj["gain"].setTargetAtTime){this._gainObj["gain"].setTargetAtTime(this._volume,this._context.currentTime,.01)}else{this._gainObj["gain"].value=this._volume}this._gainObj["connect"](this._context["destination"]);this._loop=false;this._startTime=-1;this._currentSource=null;this.playedLength=0;this._currextTimer=null;this._endCallback=function(){if(this.onended){this.onended(this)}}.bind(this)};(function(e){e.play=function(e){if(this._currentSource&&!this.paused){this._currentSource.onended=null;this._currentSource.stop(0);this.playedLength=0}var t=this._context["createBufferSource"]();t.buffer=this._buffer;t["connect"](this._gainObj);t.loop=this._loop;this._startTime=this._context.currentTime;e=e||this.playedLength;if(e){this._startTime-=e}var r=this._buffer.duration;var n=e;var i;if(this._loop){if(t.start){t.start(0,n)}else if(t["notoGrainOn"]){t["noteGrainOn"](0,n)}else{t["noteOn"](0,n)}}else{i=r-e;if(t.start){t.start(0,n,i)}else if(t["notoGrainOn"]){t["noteGrainOn"](0,n,i)}else{t["noteOn"](0,n,i)}}this._currentSource=t;t.onended=this._endCallback;if((!t.context.state||t.context.state==="suspended")&&this._context.currentTime===0){var a=this;clearTimeout(this._currextTimer);this._currextTimer=setTimeout(function(){if(!(Jd||Qd)&&a._context.currentTime===0){ev.push({instance:a._audio,offset:e,audio:a})}},10)}};e.pause=function(){clearTimeout(this._currextTimer);if(this.paused){return}this.playedLength=this._context.currentTime-this._startTime;this.playedLength%=this._buffer.duration;var e=this._currentSource;this._currentSource=null;this._startTime=-1;if(e){e.stop(0)}};e.__defineGetter__("paused",function(){if(this._currentSource&&this._currentSource.loop){return false}if(this._startTime===-1){return true}return this._context.currentTime-this._startTime>this._buffer.duration});e.__defineGetter__("loop",function(){return this._loop});e.__defineSetter__("loop",function(e){if(this._currentSource){this._currentSource.loop=e}return this._loop=e});e.__defineGetter__("volume",function(){return this._volume});e.__defineSetter__("volume",function(e){this._volume=e;if(this._gainObj["gain"].setTargetAtTime){this._gainObj["gain"].setTargetAtTime(this._volume,this._context.currentTime,.01)}else{this._volume["gain"].value=e}if(this._audio._system.os===this._audio._system.OS_IOS&&!this.paused&&this._currentSource){this._currentSource.onended=null;this.pause();this.play()}return e});e.__defineGetter__("currentTime",function(){if(this.paused){return this.playedLength}this.playedLength=this._context.currentTime-this._startTime;this.playedLength%=this._buffer.duration;return this.playedLength});e.__defineSetter__("currentTime",function(e){if(!this.paused){this.pause();this.playedLength=e;this.play()}else{this.playedLength=e}return e});e.__defineGetter__("duration",function(){return this._buffer.duration})})(nv.prototype);var iv=function e(){};iv.prototype.add=function e(t){};iv.prototype.onDestroy=function e(){};iv.prototype.step=function e(t){};function av(){throw new Error("Dynamic requires are not currently supported by rollup-plugin-commonjs")}function ov(e,t){return t={exports:{}},e(t,t.exports),t.exports}var sv=ov(function(e,t){!function(t){{e.exports=t()}}(function(){return function e(t,r,n){function i(o,s){if(!r[o]){if(!t[o]){var l=typeof av=="function"&&av;if(!s&&l){return l(o,!0)}if(a){return a(o,!0)}throw new Error("Cannot find module '"+o+"'")}var u=r[o]={exports:{}};t[o][0].call(u.exports,function(e){var r=t[o][1][e];return i(r?r:e)},u,u.exports,e,t,r,n)}return r[o].exports}var a=typeof av=="function"&&av;for(var o=0;o<n.length;o++){i(n[o])}return i}({1:[function(e,t,r){t.exports={name:"cannon",version:"0.6.2",description:"A lightweight 3D physics engine written in JavaScript.",homepage:"https://github.com/schteppe/cannon.js",author:"Stefan Hedman <schteppe@gmail.com> (http://steffe.se)",keywords:["cannon.js","cannon","physics","engine","3d"],main:"./build/cannon.js",engines:{node:"*"},repository:{type:"git",url:"https://github.com/schteppe/cannon.js.git"},bugs:{url:"https://github.com/schteppe/cannon.js/issues"},licenses:[{type:"MIT"}],devDependencies:{jshint:"latest","uglify-js":"latest",nodeunit:"^0.9.0",grunt:"~0.4.0","grunt-contrib-jshint":"~0.1.1","grunt-contrib-nodeunit":"^0.4.1","grunt-contrib-concat":"~0.1.3","grunt-contrib-uglify":"^0.5.1","grunt-browserify":"^2.1.4","grunt-contrib-yuidoc":"^0.5.2",browserify:"*"},dependencies:{}}},{}],2:[function(e,t,r){t.exports={version:e("../package.json").version,AABB:e("./collision/AABB"),ArrayCollisionMatrix:e("./collision/ArrayCollisionMatrix"),Body:e("./objects/Body"),Box:e("./shapes/Box"),Broadphase:e("./collision/Broadphase"),Constraint:e("./constraints/Constraint"),ContactEquation:e("./equations/ContactEquation"),Narrowphase:e("./world/Narrowphase"),ConeTwistConstraint:e("./constraints/ConeTwistConstraint"),ContactMaterial:e("./material/ContactMaterial"),ConvexPolyhedron:e("./shapes/ConvexPolyhedron"),Cylinder:e("./shapes/Cylinder"),DistanceConstraint:e("./constraints/DistanceConstraint"),Equation:e("./equations/Equation"),EventTarget:e("./utils/EventTarget"),FrictionEquation:e("./equations/FrictionEquation"),GSSolver:e("./solver/GSSolver"),GridBroadphase:e("./collision/GridBroadphase"),Heightfield:e("./shapes/Heightfield"),HingeConstraint:e("./constraints/HingeConstraint"),LockConstraint:e("./constraints/LockConstraint"),Mat3:e("./math/Mat3"),Material:e("./material/Material"),NaiveBroadphase:e("./collision/NaiveBroadphase"),ObjectCollisionMatrix:e("./collision/ObjectCollisionMatrix"),Pool:e("./utils/Pool"),Particle:e("./shapes/Particle"),Plane:e("./shapes/Plane"),PointToPointConstraint:e("./constraints/PointToPointConstraint"),Quaternion:e("./math/Quaternion"),Ray:e("./collision/Ray"),RaycastVehicle:e("./objects/RaycastVehicle"),RaycastResult:e("./collision/RaycastResult"),RigidVehicle:e("./objects/RigidVehicle"),RotationalEquation:e("./equations/RotationalEquation"),RotationalMotorEquation:e("./equations/RotationalMotorEquation"),SAPBroadphase:e("./collision/SAPBroadphase"),SPHSystem:e("./objects/SPHSystem"),Shape:e("./shapes/Shape"),Solver:e("./solver/Solver"),Sphere:e("./shapes/Sphere"),SplitSolver:e("./solver/SplitSolver"),Spring:e("./objects/Spring"),Trimesh:e("./shapes/Trimesh"),Vec3:e("./math/Vec3"),Vec3Pool:e("./utils/Vec3Pool"),World:e("./world/World")}},{"../package.json":1,"./collision/AABB":3,"./collision/ArrayCollisionMatrix":4,"./collision/Broadphase":5,"./collision/GridBroadphase":6,"./collision/NaiveBroadphase":7,"./collision/ObjectCollisionMatrix":8,"./collision/Ray":9,"./collision/RaycastResult":10,"./collision/SAPBroadphase":11,"./constraints/ConeTwistConstraint":12,"./constraints/Constraint":13,"./constraints/DistanceConstraint":14,"./constraints/HingeConstraint":15,"./constraints/LockConstraint":16,"./constraints/PointToPointConstraint":17,"./equations/ContactEquation":19,"./equations/Equation":20,"./equations/FrictionEquation":21,"./equations/RotationalEquation":22,"./equations/RotationalMotorEquation":23,"./material/ContactMaterial":24,"./material/Material":25,"./math/Mat3":27,"./math/Quaternion":28,"./math/Vec3":30,"./objects/Body":31,"./objects/RaycastVehicle":32,"./objects/RigidVehicle":33,"./objects/SPHSystem":34,"./objects/Spring":35,"./shapes/Box":37,"./shapes/ConvexPolyhedron":38,"./shapes/Cylinder":39,"./shapes/Heightfield":40,"./shapes/Particle":41,"./shapes/Plane":42,"./shapes/Shape":43,"./shapes/Sphere":44,"./shapes/Trimesh":45,"./solver/GSSolver":46,"./solver/Solver":47,"./solver/SplitSolver":48,"./utils/EventTarget":49,"./utils/Pool":51,"./utils/Vec3Pool":54,"./world/Narrowphase":55,"./world/World":56}],3:[function(e,t,r){var n=e("../math/Vec3");var i=e("../utils/Utils");t.exports=a;function a(e){e=e||{};this.lowerBound=new n;if(e.lowerBound){this.lowerBound.copy(e.lowerBound)}this.upperBound=new n;if(e.upperBound){this.upperBound.copy(e.upperBound)}}var o=new n;a.prototype.setFromPoints=function(e,t,r,n){var i=this.lowerBound,a=this.upperBound,s=r;i.copy(e[0]);if(s){s.vmult(i,i)}a.copy(i);for(var l=1;l<e.length;l++){var u=e[l];if(s){s.vmult(u,o);u=o}if(u.x>a.x){a.x=u.x}if(u.x<i.x){i.x=u.x}if(u.y>a.y){a.y=u.y}if(u.y<i.y){i.y=u.y}if(u.z>a.z){a.z=u.z}if(u.z<i.z){i.z=u.z}}if(t){t.vadd(i,i);t.vadd(a,a)}if(n){i.x-=n;i.y-=n;i.z-=n;a.x+=n;a.y+=n;a.z+=n}return this};a.prototype.copy=function(e){this.lowerBound.copy(e.lowerBound);this.upperBound.copy(e.upperBound);return this};a.prototype.clone=function(){return(new a).copy(this)};a.prototype.extend=function(e){var t=e.lowerBound.x;if(this.lowerBound.x>t){this.lowerBound.x=t}var r=e.upperBound.x;if(this.upperBound.x<r){this.upperBound.x=r}var t=e.lowerBound.y;if(this.lowerBound.y>t){this.lowerBound.y=t}var r=e.upperBound.y;if(this.upperBound.y<r){this.upperBound.y=r}var t=e.lowerBound.z;if(this.lowerBound.z>t){this.lowerBound.z=t}var r=e.upperBound.z;if(this.upperBound.z<r){this.upperBound.z=r}};a.prototype.overlaps=function(e){var t=this.lowerBound,r=this.upperBound,n=e.lowerBound,i=e.upperBound;return(n.x<=r.x&&r.x<=i.x||t.x<=i.x&&i.x<=r.x)&&(n.y<=r.y&&r.y<=i.y||t.y<=i.y&&i.y<=r.y)&&(n.z<=r.z&&r.z<=i.z||t.z<=i.z&&i.z<=r.z)};a.prototype.contains=function(e){var t=this.lowerBound,r=this.upperBound,n=e.lowerBound,i=e.upperBound;return t.x<=n.x&&r.x>=i.x&&(t.y<=n.y&&r.y>=i.y)&&(t.z<=n.z&&r.z>=i.z)};a.prototype.getCorners=function(e,t,r,n,i,a,o,s){var l=this.lowerBound,u=this.upperBound;e.copy(l);t.set(u.x,l.y,l.z);r.set(u.x,u.y,l.z);n.set(l.x,u.y,u.z);i.set(u.x,l.y,l.z);a.set(l.x,u.y,l.z);o.set(l.x,l.y,u.z);s.copy(u)};var s=[new n,new n,new n,new n,new n,new n,new n,new n];a.prototype.toLocalFrame=function(e,t){var r=s;var n=r[0];var i=r[1];var a=r[2];var o=r[3];var l=r[4];var u=r[5];var h=r[6];var c=r[7];this.getCorners(n,i,a,o,l,u,h,c);for(var f=0;f!==8;f++){var p=r[f];e.pointToLocal(p,p)}return t.setFromPoints(r)};a.prototype.toWorldFrame=function(e,t){var r=s;var n=r[0];var i=r[1];var a=r[2];var o=r[3];var l=r[4];var u=r[5];var h=r[6];var c=r[7];this.getCorners(n,i,a,o,l,u,h,c);for(var f=0;f!==8;f++){var p=r[f];e.pointToWorld(p,p)}return t.setFromPoints(r)}},{"../math/Vec3":30,"../utils/Utils":53}],4:[function(e,t,r){t.exports=n;function n(){this.matrix=[]}n.prototype.get=function(e,t){e=e.index;t=t.index;if(t>e){var r=t;t=e;e=r}return this.matrix[(e*(e+1)>>1)+t-1]};n.prototype.set=function(e,t,r){e=e.index;t=t.index;if(t>e){var n=t;t=e;e=n}this.matrix[(e*(e+1)>>1)+t-1]=r?1:0};n.prototype.reset=function(){var e=this;for(var t=0,r=this.matrix.length;t!==r;t++){e.matrix[t]=0}};n.prototype.setNumObjects=function(e){this.matrix.length=e*(e-1)>>1}},{}],5:[function(e,t,r){var n=e("../objects/Body");var i=e("../math/Vec3");var a=e("../math/Quaternion");var o=e("../shapes/Shape");var s=e("../shapes/Plane");t.exports=l;function l(){this.world=null;this.useBoundingBoxes=false;this.dirty=true}l.prototype.collisionPairs=function(e,t,r){throw new Error("collisionPairs not implemented for this BroadPhase class!")};var u=n.STATIC|n.KINEMATIC;l.prototype.needBroadphaseCollision=function(e,t){if((e.collisionFilterGroup&t.collisionFilterMask)===0||(t.collisionFilterGroup&e.collisionFilterMask)===0){return false}if(((e.type&u)!==0||e.sleepState===n.SLEEPING)&&((t.type&u)!==0||t.sleepState===n.SLEEPING)){return false}return true};l.prototype.intersectionTest=function(e,t,r,n){if(this.useBoundingBoxes){this.doBoundingBoxBroadphase(e,t,r,n)}else{this.doBoundingSphereBroadphase(e,t,r,n)}};var h=new i,c=new i,f=new a,p=new i;l.prototype.doBoundingSphereBroadphase=function(e,t,r,n){var i=h;t.position.vsub(e.position,i);var a=Math.pow(e.boundingRadius+t.boundingRadius,2);var o=i.norm2();if(o<a){r.push(e);n.push(t)}};l.prototype.doBoundingBoxBroadphase=function(e,t,r,n){if(e.aabbNeedsUpdate){e.computeAABB()}if(t.aabbNeedsUpdate){t.computeAABB()}if(e.aabb.overlaps(t.aabb)){r.push(e);n.push(t)}};var d={keys:[]},v=[],m=[];l.prototype.makePairsUnique=function(e,t){var r=d,n=v,i=m,a=e.length;for(var o=0;o!==a;o++){n[o]=e[o];i[o]=t[o]}e.length=0;t.length=0;for(var o=0;o!==a;o++){var s=n[o].id,l=i[o].id;var u=s<l?s+","+l:l+","+s;r[u]=o;r.keys.push(u)}for(var o=0;o!==r.keys.length;o++){var u=r.keys.pop(),h=r[u];e.push(n[h]);t.push(i[h]);delete r[u]}};l.prototype.setWorld=function(e){};var _=new i;l.boundingSphereCheck=function(e,t){var r=_;e.position.vsub(t.position,r);return Math.pow(e.shape.boundingSphereRadius+t.shape.boundingSphereRadius,2)>r.norm2()};l.prototype.aabbQuery=function(e,t,r){console.warn(".aabbQuery is not implemented in this Broadphase subclass.");return[]}},{"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Plane":42,"../shapes/Shape":43}],6:[function(e,t,r){t.exports=o;var n=e("./Broadphase");var i=e("../math/Vec3");var a=e("../shapes/Shape");function o(e,t,r,a,o){var s=this;n.apply(this);this.nx=r||10;this.ny=a||10;this.nz=o||10;this.aabbMin=e||new i(100,100,100);this.aabbMax=t||new i(-100,-100,-100);var l=this.nx*this.ny*this.nz;if(l<=0){throw"GridBroadphase: Each dimension's n must be >0"}this.bins=[];this.binLengths=[];this.bins.length=l;this.binLengths.length=l;for(var u=0;u<l;u++){s.bins[u]=[];s.binLengths[u]=0}}o.prototype=new n;o.prototype.constructor=o;var s=new i;var l=new i;o.prototype.collisionPairs=function(e,t,r){var n=this;var i=e.numObjects(),o=e.bodies;var l=this.aabbMax,u=this.aabbMin,h=this.nx,c=this.ny,f=this.nz;var p=c*f;var d=f;var v=1;var m=l.x,_=l.y,g=l.z,y=u.x,x=u.y,b=u.z;var w=h/(m-y),T=c/(_-x),E=f/(g-b);var S=(m-y)/h,M=(_-x)/c,A=(g-b)/f;var R=Math.sqrt(S*S+M*M+A*A)*.5;var L=a.types;var C=L.SPHERE,I=L.PLANE,U=L.BOX,D=L.COMPOUND,O=L.CONVEXPOLYHEDRON;var B=this.bins,P=this.binLengths,F=this.bins.length;for(var z=0;z!==F;z++){P[z]=0}var N=Math.ceil;var u=Math.min;var l=Math.max;function k(e,t,r,n,i,a,o){var s=(e-y)*w|0,l=(t-x)*T|0,u=(r-b)*E|0,m=N((n-y)*w),_=N((i-x)*T),g=N((a-b)*E);if(s<0){s=0}else if(s>=h){s=h-1}if(l<0){l=0}else if(l>=c){l=c-1}if(u<0){u=0}else if(u>=f){u=f-1}if(m<0){m=0}else if(m>=h){m=h-1}if(_<0){_=0}else if(_>=c){_=c-1}if(g<0){g=0}else if(g>=f){g=f-1}s*=p;l*=d;u*=v;m*=p;_*=d;g*=v;for(var S=s;S<=m;S+=p){for(var M=l;M<=_;M+=d){for(var A=u;A<=g;A+=v){var R=S+M+A;B[R][P[R]++]=o}}}}for(var z=0;z!==i;z++){var V=o[z];var G=V.shape;switch(G.type){case C:var W=V.position.x,H=V.position.y,j=V.position.z;var q=G.radius;k(W-q,H-q,j-q,W+q,H+q,j+q,V);break;case I:if(G.worldNormalNeedsUpdate){G.computeWorldNormal(V.quaternion)}var X=G.worldNormal;var Y=y+S*.5-V.position.x,K=x+M*.5-V.position.y,Z=b+A*.5-V.position.z;var Q=s;Q.set(Y,K,Z);for(var J=0,$=0;J!==h;J++,$+=p,Q.y=K,Q.x+=S){for(var ee=0,te=0;ee!==c;ee++,te+=d,Q.z=Z,Q.y+=M){for(var re=0,ne=0;re!==f;re++,ne+=v,Q.z+=A){if(Q.dot(X)<R){var ie=$+te+ne;B[ie][P[ie]++]=V}}}}break;default:if(V.aabbNeedsUpdate){V.computeAABB()}k(V.aabb.lowerBound.x,V.aabb.lowerBound.y,V.aabb.lowerBound.z,V.aabb.upperBound.x,V.aabb.upperBound.y,V.aabb.upperBound.z,V);break}}for(var z=0;z!==F;z++){var ae=P[z];if(ae>1){var oe=B[z];for(var J=0;J!==ae;J++){var V=oe[J];for(var ee=0;ee!==J;ee++){var se=oe[ee];if(n.needBroadphaseCollision(V,se)){n.intersectionTest(V,se,t,r)}}}}}this.makePairsUnique(t,r)}},{"../math/Vec3":30,"../shapes/Shape":43,"./Broadphase":5}],7:[function(e,t,r){t.exports=a;var n=e("./Broadphase");var i=e("./AABB");function a(){n.apply(this)}a.prototype=new n;a.prototype.constructor=a;a.prototype.collisionPairs=function(e,t,r){var n=this;var i=e.bodies,a=i.length,o,s,l,u;for(o=0;o!==a;o++){for(s=0;s!==o;s++){l=i[o];u=i[s];if(!n.needBroadphaseCollision(l,u)){continue}n.intersectionTest(l,u,t,r)}}};var o=new i;a.prototype.aabbQuery=function(e,t,r){r=r||[];for(var n=0;n<e.bodies.length;n++){var i=e.bodies[n];if(i.aabbNeedsUpdate){i.computeAABB()}if(i.aabb.overlaps(t)){r.push(i)}}return r}},{"./AABB":3,"./Broadphase":5}],8:[function(e,t,r){t.exports=n;function n(){this.matrix={}}n.prototype.get=function(e,t){e=e.id;t=t.id;if(t>e){var r=t;t=e;e=r}return e+"-"+t in this.matrix};n.prototype.set=function(e,t,r){e=e.id;t=t.id;if(t>e){var n=t;t=e;e=n}if(r){this.matrix[e+"-"+t]=true}else{delete this.matrix[e+"-"+t]}};n.prototype.reset=function(){this.matrix={}};n.prototype.setNumObjects=function(e){}},{}],9:[function(e,t,r){t.exports=c;var n=e("../math/Vec3");var i=e("../math/Quaternion");var a=e("../math/Transform");var o=e("../shapes/ConvexPolyhedron");var s=e("../shapes/Box");var l=e("../collision/RaycastResult");var u=e("../shapes/Shape");var h=e("../collision/AABB");function c(e,t){this.from=e?e.clone():new n;this.to=t?t.clone():new n;this._direction=new n;this.precision=1e-4;this.checkCollisionResponse=true;this.skipBackfaces=false;this.collisionFilterMask=-1;this.collisionFilterGroup=-1;this.mode=c.ANY;this.result=new l;this.hasHit=false;this.callback=function(e){}}c.prototype.constructor=c;c.CLOSEST=1;c.ANY=2;c.ALL=4;var f=new h;var p=[];c.prototype.intersectWorld=function(e,t){this.mode=t.mode||c.ANY;this.result=t.result||new l;this.skipBackfaces=!!t.skipBackfaces;this.collisionFilterMask=typeof t.collisionFilterMask!=="undefined"?t.collisionFilterMask:-1;this.collisionFilterGroup=typeof t.collisionFilterGroup!=="undefined"?t.collisionFilterGroup:-1;if(t.from){this.from.copy(t.from)}if(t.to){this.to.copy(t.to)}this.callback=t.callback||function(){};this.hasHit=false;this.result.reset();this._updateDirection();this.getAABB(f);p.length=0;e.broadphase.aabbQuery(e,f,p);this.intersectBodies(p);return this.hasHit};var d=new n,v=new n;c.pointInTriangle=m;function m(e,t,r,n){n.vsub(t,W);r.vsub(t,d);e.vsub(t,v);var i=W.dot(W);var a=W.dot(d);var o=W.dot(v);var s=d.dot(d);var l=d.dot(v);var u,h;return(u=s*o-a*l)>=0&&(h=i*l-a*o)>=0&&u+h<i*s-a*a}var _=new n;var g=new i;c.prototype.intersectBody=function(e,t){var r=this;if(t){this.result=t;this._updateDirection()}var n=this.checkCollisionResponse;if(n&&!e.collisionResponse){return}if((this.collisionFilterGroup&e.collisionFilterMask)===0||(e.collisionFilterGroup&this.collisionFilterMask)===0){return}var i=_;var a=g;for(var o=0,s=e.shapes.length;o<s;o++){var l=e.shapes[o];if(n&&!l.collisionResponse){continue}e.quaternion.mult(e.shapeOrientations[o],a);e.quaternion.vmult(e.shapeOffsets[o],i);i.vadd(e.position,i);r.intersectShape(l,a,i,e);if(r.result._shouldStop){break}}};c.prototype.intersectBodies=function(e,t){var r=this;if(t){this.result=t;this._updateDirection()}for(var n=0,i=e.length;!this.result._shouldStop&&n<i;n++){r.intersectBody(e[n])}};c.prototype._updateDirection=function(){this.to.vsub(this.from,this._direction);this._direction.normalize()};c.prototype.intersectShape=function(e,t,r,n){var i=this.from;var a=j(i,this._direction,r);if(a>e.boundingSphereRadius){return}var o=this[e.type];if(o){o.call(this,e,t,r,n)}};var y=new n;var x=new n;var b=new n;var w=new n;var T=new n;var E=new n;var S=new n;var M=new l;c.prototype.intersectBox=function(e,t,r,n){return this.intersectConvex(e.convexPolyhedronRepresentation,t,r,n)};c.prototype[u.types.BOX]=c.prototype.intersectBox;c.prototype.intersectPlane=function(e,t,r,i){var a=this.from;var o=this.to;var s=this._direction;var l=new n(0,0,1);t.vmult(l,l);var u=new n;a.vsub(r,u);var h=u.dot(l);o.vsub(r,u);var c=u.dot(l);if(h*c>0){return}if(a.distanceTo(o)<h){return}var f=l.dot(s);if(Math.abs(f)<this.precision){return}var p=new n;var d=new n;var v=new n;a.vsub(r,p);var m=-l.dot(p)/f;s.scale(m,d);a.vadd(d,v);this.reportIntersection(l,v,e,i,-1)};c.prototype[u.types.PLANE]=c.prototype.intersectPlane;c.prototype.getAABB=function(e){var t=this.to;var r=this.from;e.lowerBound.x=Math.min(t.x,r.x);e.lowerBound.y=Math.min(t.y,r.y);e.lowerBound.z=Math.min(t.z,r.z);e.upperBound.x=Math.max(t.x,r.x);e.upperBound.y=Math.max(t.y,r.y);e.upperBound.z=Math.max(t.z,r.z)};var A={faceList:[0]};c.prototype.intersectHeightfield=function(e,t,r,i){var o=this;var s=e.data,l=e.elementSize,u=new n;var h=new c(this.from,this.to);a.pointToLocalFrame(r,t,h.from,h.from);a.pointToLocalFrame(r,t,h.to,h.to);var f=[];var p=null;var d=null;var v=null;var m=null;var _=e.getIndexOfPosition(h.from.x,h.from.y,f,false);if(_){p=f[0];d=f[1];v=f[0];m=f[1]}_=e.getIndexOfPosition(h.to.x,h.to.y,f,false);if(_){if(p===null||f[0]<p){p=f[0]}if(v===null||f[0]>v){v=f[0]}if(d===null||f[1]<d){d=f[1]}if(m===null||f[1]>m){m=f[1]}}if(p===null){return}var g=[];e.getRectMinMax(p,d,v,m,g);for(var y=p;y<=v;y++){for(var x=d;x<=m;x++){if(o.result._shouldStop){return}e.getConvexTrianglePillar(y,x,false);a.pointToWorldFrame(r,t,e.pillarOffset,u);o.intersectConvex(e.pillarConvex,t,u,i,A);if(o.result._shouldStop){return}e.getConvexTrianglePillar(y,x,true);a.pointToWorldFrame(r,t,e.pillarOffset,u);o.intersectConvex(e.pillarConvex,t,u,i,A)}}};c.prototype[u.types.HEIGHTFIELD]=c.prototype.intersectHeightfield;var R=new n;var L=new n;c.prototype.intersectSphere=function(e,t,r,n){var i=this.from,a=this.to,o=e.radius;var s=Math.pow(a.x-i.x,2)+Math.pow(a.y-i.y,2)+Math.pow(a.z-i.z,2);var l=2*((a.x-i.x)*(i.x-r.x)+(a.y-i.y)*(i.y-r.y)+(a.z-i.z)*(i.z-r.z));var u=Math.pow(i.x-r.x,2)+Math.pow(i.y-r.y,2)+Math.pow(i.z-r.z,2)-Math.pow(o,2);var h=Math.pow(l,2)-4*s*u;var c=R;var f=L;if(h<0){return}else if(h===0){i.lerp(a,h,c);c.vsub(r,f);f.normalize();this.reportIntersection(f,c,e,n,-1)}else{var p=(-l-Math.sqrt(h))/(2*s);var d=(-l+Math.sqrt(h))/(2*s);if(p>=0&&p<=1){i.lerp(a,p,c);c.vsub(r,f);f.normalize();this.reportIntersection(f,c,e,n,-1)}if(this.result._shouldStop){return}if(d>=0&&d<=1){i.lerp(a,d,c);c.vsub(r,f);f.normalize();this.reportIntersection(f,c,e,n,-1)}}};c.prototype[u.types.SPHERE]=c.prototype.intersectSphere;var C=new n;var I=new n;var U=new n;var D=new n;c.prototype.intersectConvex=function e(t,r,n,i,a){var o=this;var s=C;var l=D;var u=a&&a.faceList||null;var h=t.faces,c=t.vertices,f=t.faceNormals;var p=this._direction;var d=this.from;var v=this.to;var _=d.distanceTo(v);var g=u?u.length:h.length;var y=this.result;for(var x=0;!y._shouldStop&&x<g;x++){var S=u?u[x]:x;var M=h[S];var A=f[S];var R=r;var L=n;l.copy(c[M[0]]);R.vmult(l,l);l.vadd(L,l);l.vsub(d,l);R.vmult(A,s);var I=p.dot(s);if(Math.abs(I)<o.precision){continue}var U=s.dot(l)/I;if(U<0){continue}p.mult(U,b);b.vadd(d,b);w.copy(c[M[0]]);R.vmult(w,w);L.vadd(w,w);for(var O=1;!y._shouldStop&&O<M.length-1;O++){T.copy(c[M[O]]);E.copy(c[M[O+1]]);R.vmult(T,T);R.vmult(E,E);L.vadd(T,T);L.vadd(E,E);var B=b.distanceTo(d);if(!(m(b,w,T,E)||m(b,T,w,E))||B>_){continue}o.reportIntersection(s,b,t,i,S)}}};c.prototype[u.types.CONVEXPOLYHEDRON]=c.prototype.intersectConvex;var O=new n;var B=new n;var P=new n;var F=new n;var z=new n;var N=new n;var k=new h;var V=[];var G=new a;c.prototype.intersectTrimesh=function e(t,r,n,i,o){var s=this;var l=O;var u=V;var h=G;var c=D;var f=B;var p=P;var d=F;var v=N;var _=z;var g=o&&o.faceList||null;var y=t.indices,x=t.vertices,S=t.faceNormals;var M=this.from;var A=this.to;var R=this._direction;h.position.copy(n);h.quaternion.copy(r);a.vectorToLocalFrame(n,r,R,f);a.pointToLocalFrame(n,r,M,p);a.pointToLocalFrame(n,r,A,d);var L=p.distanceSquared(d);t.tree.rayQuery(this,h,u);for(var C=0,I=u.length;!this.result._shouldStop&&C!==I;C++){var U=u[C];t.getNormal(U,l);t.getVertex(y[U*3],w);w.vsub(p,c);var k=f.dot(l);var W=l.dot(c)/k;if(W<0){continue}f.scale(W,b);b.vadd(p,b);t.getVertex(y[U*3+1],T);t.getVertex(y[U*3+2],E);var H=b.distanceSquared(p);if(!(m(b,T,w,E)||m(b,w,T,E))||H>L){continue}a.vectorToWorldFrame(r,l,_);a.pointToWorldFrame(n,r,b,v);s.reportIntersection(_,v,t,i,U)}u.length=0};c.prototype[u.types.TRIMESH]=c.prototype.intersectTrimesh;c.prototype.reportIntersection=function(e,t,r,n,i){var a=this.from;var o=this.to;var s=a.distanceTo(t);var l=this.result;if(this.skipBackfaces&&e.dot(this._direction)>0){return}l.hitFaceIndex=typeof i!=="undefined"?i:-1;switch(this.mode){case c.ALL:this.hasHit=true;l.set(a,o,e,t,r,n,s);l.hasHit=true;this.callback(l);break;case c.CLOSEST:if(s<l.distance||!l.hasHit){this.hasHit=true;l.hasHit=true;l.set(a,o,e,t,r,n,s)}break;case c.ANY:this.hasHit=true;l.hasHit=true;l.set(a,o,e,t,r,n,s);l._shouldStop=true;break}};var W=new n,H=new n;function j(e,t,r){r.vsub(e,W);var n=W.dot(t);t.mult(n,H);H.vadd(e,H);var i=r.distanceTo(H);return i}},{"../collision/AABB":3,"../collision/RaycastResult":10,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../shapes/Box":37,"../shapes/ConvexPolyhedron":38,"../shapes/Shape":43}],10:[function(e,t,r){var n=e("../math/Vec3");t.exports=i;function i(){this.rayFromWorld=new n;this.rayToWorld=new n;this.hitNormalWorld=new n;this.hitPointWorld=new n;this.hasHit=false;this.shape=null;this.body=null;this.hitFaceIndex=-1;this.distance=-1;this._shouldStop=false}i.prototype.reset=function(){this.rayFromWorld.setZero();this.rayToWorld.setZero();this.hitNormalWorld.setZero();this.hitPointWorld.setZero();this.hasHit=false;this.shape=null;this.body=null;this.hitFaceIndex=-1;this.distance=-1;this._shouldStop=false};i.prototype.abort=function(){this._shouldStop=true};i.prototype.set=function(e,t,r,n,i,a,o){this.rayFromWorld.copy(e);this.rayToWorld.copy(t);this.hitNormalWorld.copy(r);this.hitPointWorld.copy(n);this.shape=i;this.body=a;this.distance=o}},{"../math/Vec3":30}],11:[function(e,t,r){var n=e("../shapes/Shape");var i=e("../collision/Broadphase");t.exports=a;function a(e){i.apply(this);this.axisList=[];this.world=null;this.axisIndex=0;var t=this.axisList;this._addBodyHandler=function(e){t.push(e.body)};this._removeBodyHandler=function(e){var r=t.indexOf(e.body);if(r!==-1){t.splice(r,1)}};if(e){this.setWorld(e)}}a.prototype=new i;a.prototype.setWorld=function(e){var t=this;this.axisList.length=0;for(var r=0;r<e.bodies.length;r++){t.axisList.push(e.bodies[r])}e.removeEventListener("addBody",this._addBodyHandler);e.removeEventListener("removeBody",this._removeBodyHandler);e.addEventListener("addBody",this._addBodyHandler);e.addEventListener("removeBody",this._removeBodyHandler);this.world=e;this.dirty=true};a.insertionSortX=function(e){for(var t=1,r=e.length;t<r;t++){var n=e[t];for(var i=t-1;i>=0;i--){if(e[i].aabb.lowerBound.x<=n.aabb.lowerBound.x){break}e[i+1]=e[i]}e[i+1]=n}return e};a.insertionSortY=function(e){for(var t=1,r=e.length;t<r;t++){var n=e[t];for(var i=t-1;i>=0;i--){if(e[i].aabb.lowerBound.y<=n.aabb.lowerBound.y){break}e[i+1]=e[i]}e[i+1]=n}return e};a.insertionSortZ=function(e){for(var t=1,r=e.length;t<r;t++){var n=e[t];for(var i=t-1;i>=0;i--){if(e[i].aabb.lowerBound.z<=n.aabb.lowerBound.z){break}e[i+1]=e[i]}e[i+1]=n}return e};a.prototype.collisionPairs=function(e,t,r){var n=this;var i=this.axisList,o=i.length,s=this.axisIndex,l,u;if(this.dirty){this.sortList();this.dirty=false}for(l=0;l!==o;l++){var h=i[l];for(u=l+1;u<o;u++){var c=i[u];if(!n.needBroadphaseCollision(h,c)){continue}if(!a.checkBounds(h,c,s)){break}n.intersectionTest(h,c,t,r)}}};a.prototype.sortList=function(){var e=this.axisList;var t=this.axisIndex;var r=e.length;for(var n=0;n!==r;n++){var i=e[n];if(i.aabbNeedsUpdate){i.computeAABB()}}if(t===0){a.insertionSortX(e)}else if(t===1){a.insertionSortY(e)}else if(t===2){a.insertionSortZ(e)}};a.checkBounds=function(e,t,r){var n;var i;if(r===0){n=e.position.x;i=t.position.x}else if(r===1){n=e.position.y;i=t.position.y}else if(r===2){n=e.position.z;i=t.position.z}var a=e.boundingRadius,o=t.boundingRadius,s=n-a,l=n+a,u=i-o;return u<l};a.prototype.autoDetectAxis=function(){var e=0,t=0,r=0,n=0,i=0,a=0,o=this.axisList,s=o.length,l=1/s;for(var u=0;u!==s;u++){var h=o[u];var c=h.position.x;e+=c;t+=c*c;var f=h.position.y;r+=f;n+=f*f;var p=h.position.z;i+=p;a+=p*p}var d=t-e*e*l,v=n-r*r*l,m=a-i*i*l;if(d>v){if(d>m){this.axisIndex=0}else{this.axisIndex=2}}else if(v>m){this.axisIndex=1}else{this.axisIndex=2}};a.prototype.aabbQuery=function(e,t,r){r=r||[];if(this.dirty){this.sortList();this.dirty=false}var n=this.axisIndex,i="x";if(n===1){i="y"}if(n===2){i="z"}var a=this.axisList;var o=t.lowerBound[i];var s=t.upperBound[i];for(var l=0;l<a.length;l++){var u=a[l];if(u.aabbNeedsUpdate){u.computeAABB()}if(u.aabb.overlaps(t)){r.push(u)}}return r}},{"../collision/Broadphase":5,"../shapes/Shape":43}],12:[function(e,t,r){t.exports=u;var n=e("./Constraint");var i=e("./PointToPointConstraint");var a=e("../equations/ConeEquation");var o=e("../equations/RotationalEquation");var s=e("../equations/ContactEquation");var l=e("../math/Vec3");function u(e,t,r){r=r||{};var n=typeof r.maxForce!=="undefined"?r.maxForce:1e6;var s=r.pivotA?r.pivotA.clone():new l;var u=r.pivotB?r.pivotB.clone():new l;this.axisA=r.axisA?r.axisA.clone():new l;this.axisB=r.axisB?r.axisB.clone():new l;i.call(this,e,s,t,u,n);this.collideConnected=!!r.collideConnected;this.angle=typeof r.angle!=="undefined"?r.angle:0;var h=this.coneEquation=new a(e,t,r);var c=this.twistEquation=new o(e,t,r);this.twistAngle=typeof r.twistAngle!=="undefined"?r.twistAngle:0;h.maxForce=0;h.minForce=-n;c.maxForce=0;c.minForce=-n;this.equations.push(h,c)}u.prototype=new i;u.constructor=u;var h=new l;var c=new l;u.prototype.update=function(){var e=this.bodyA,t=this.bodyB,r=this.coneEquation,n=this.twistEquation;i.prototype.update.call(this);e.vectorToWorldFrame(this.axisA,r.axisA);t.vectorToWorldFrame(this.axisB,r.axisB);this.axisA.tangents(n.axisA,n.axisA);e.vectorToWorldFrame(n.axisA,n.axisA);this.axisB.tangents(n.axisB,n.axisB);t.vectorToWorldFrame(n.axisB,n.axisB);r.angle=this.angle;n.maxAngle=this.twistAngle}},{"../equations/ConeEquation":18,"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],13:[function(e,t,r){t.exports=i;var n=e("../utils/Utils");function i(e,t,r){r=n.defaults(r,{collideConnected:true,wakeUpBodies:true});this.equations=[];this.bodyA=e;this.bodyB=t;this.id=i.idCounter++;this.collideConnected=r.collideConnected;if(r.wakeUpBodies){if(e){e.wakeUp()}if(t){t.wakeUp()}}}i.prototype.update=function(){throw new Error("method update() not implmemented in this Constraint subclass!")};i.prototype.enable=function(){var e=this.equations;for(var t=0;t<e.length;t++){e[t].enabled=true}};i.prototype.disable=function(){var e=this.equations;for(var t=0;t<e.length;t++){e[t].enabled=false}};i.idCounter=0},{"../utils/Utils":53}],14:[function(e,t,r){t.exports=a;var n=e("./Constraint");var i=e("../equations/ContactEquation");function a(e,t,r,a){n.call(this,e,t);if(typeof r==="undefined"){r=e.position.distanceTo(t.position)}if(typeof a==="undefined"){a=1e6}this.distance=r;var o=this.distanceEquation=new i(e,t);this.equations.push(o);o.minForce=-a;o.maxForce=a}a.prototype=new n;a.prototype.update=function(){var e=this.bodyA;var t=this.bodyB;var r=this.distanceEquation;var n=this.distance*.5;var i=r.ni;t.position.vsub(e.position,i);i.normalize();i.mult(n,r.ri);i.mult(-n,r.rj)}},{"../equations/ContactEquation":19,"./Constraint":13}],15:[function(e,t,r){t.exports=u;var n=e("./Constraint");var i=e("./PointToPointConstraint");var a=e("../equations/RotationalEquation");var o=e("../equations/RotationalMotorEquation");var s=e("../equations/ContactEquation");var l=e("../math/Vec3");function u(e,t,r){r=r||{};var n=typeof r.maxForce!=="undefined"?r.maxForce:1e6;var s=r.pivotA?r.pivotA.clone():new l;var u=r.pivotB?r.pivotB.clone():new l;i.call(this,e,s,t,u,n);var h=this.axisA=r.axisA?r.axisA.clone():new l(1,0,0);h.normalize();var c=this.axisB=r.axisB?r.axisB.clone():new l(1,0,0);c.normalize();var f=this.rotationalEquation1=new a(e,t,r);var p=this.rotationalEquation2=new a(e,t,r);var d=this.motorEquation=new o(e,t,n);d.enabled=false;this.equations.push(f,p,d)}u.prototype=new i;u.constructor=u;u.prototype.enableMotor=function(){this.motorEquation.enabled=true};u.prototype.disableMotor=function(){this.motorEquation.enabled=false};u.prototype.setMotorSpeed=function(e){this.motorEquation.targetVelocity=e};u.prototype.setMotorMaxForce=function(e){this.motorEquation.maxForce=e;this.motorEquation.minForce=-e};var h=new l;var c=new l;u.prototype.update=function(){var e=this.bodyA,t=this.bodyB,r=this.motorEquation,n=this.rotationalEquation1,a=this.rotationalEquation2,o=h,s=c;var l=this.axisA;var u=this.axisB;i.prototype.update.call(this);e.quaternion.vmult(l,o);t.quaternion.vmult(u,s);o.tangents(n.axisA,a.axisA);n.axisB.copy(s);a.axisB.copy(s);if(this.motorEquation.enabled){e.quaternion.vmult(this.axisA,r.axisA);t.quaternion.vmult(this.axisB,r.axisB)}}},{"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../equations/RotationalMotorEquation":23,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],16:[function(e,t,r){t.exports=u;var n=e("./Constraint");var i=e("./PointToPointConstraint");var a=e("../equations/RotationalEquation");var o=e("../equations/RotationalMotorEquation");var s=e("../equations/ContactEquation");var l=e("../math/Vec3");function u(e,t,r){r=r||{};var n=typeof r.maxForce!=="undefined"?r.maxForce:1e6;var o=new l;var s=new l;var u=new l;e.position.vadd(t.position,u);u.scale(.5,u);t.pointToLocalFrame(u,s);e.pointToLocalFrame(u,o);i.call(this,e,o,t,s,n);var h=this.rotationalEquation1=new a(e,t,r);var c=this.rotationalEquation2=new a(e,t,r);var f=this.rotationalEquation3=new a(e,t,r);this.equations.push(h,c,f)}u.prototype=new i;u.constructor=u;var h=new l;var c=new l;u.prototype.update=function(){var e=this.bodyA,t=this.bodyB,r=this.motorEquation,n=this.rotationalEquation1,a=this.rotationalEquation2,o=this.rotationalEquation3;i.prototype.update.call(this);e.vectorToWorldFrame(l.UNIT_X,n.axisA);t.vectorToWorldFrame(l.UNIT_Y,n.axisB);e.vectorToWorldFrame(l.UNIT_Y,a.axisA);t.vectorToWorldFrame(l.UNIT_Z,a.axisB);e.vectorToWorldFrame(l.UNIT_Z,o.axisA);t.vectorToWorldFrame(l.UNIT_X,o.axisB)}},{"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../equations/RotationalMotorEquation":23,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],17:[function(e,t,r){t.exports=o;var n=e("./Constraint");var i=e("../equations/ContactEquation");var a=e("../math/Vec3");function o(e,t,r,o,s){n.call(this,e,r);s=typeof s!=="undefined"?s:1e6;this.pivotA=t?t.clone():new a;this.pivotB=o?o.clone():new a;var l=this.equationX=new i(e,r);var u=this.equationY=new i(e,r);var h=this.equationZ=new i(e,r);this.equations.push(l,u,h);l.minForce=u.minForce=h.minForce=-s;l.maxForce=u.maxForce=h.maxForce=s;l.ni.set(1,0,0);u.ni.set(0,1,0);h.ni.set(0,0,1)}o.prototype=new n;o.prototype.update=function(){var e=this.bodyA;var t=this.bodyB;var r=this.equationX;var n=this.equationY;var i=this.equationZ;e.quaternion.vmult(this.pivotA,r.ri);t.quaternion.vmult(this.pivotB,r.rj);n.ri.copy(r.ri);n.rj.copy(r.rj);i.ri.copy(r.ri);i.rj.copy(r.rj)}},{"../equations/ContactEquation":19,"../math/Vec3":30,"./Constraint":13}],18:[function(e,t,r){t.exports=o;var n=e("../math/Vec3");var i=e("../math/Mat3");var a=e("./Equation");function o(e,t,r){r=r||{};var i=typeof r.maxForce!=="undefined"?r.maxForce:1e6;a.call(this,e,t,-i,i);this.axisA=r.axisA?r.axisA.clone():new n(1,0,0);this.axisB=r.axisB?r.axisB.clone():new n(0,1,0);this.angle=typeof r.angle!=="undefined"?r.angle:0}o.prototype=new a;o.prototype.constructor=o;var s=new n;var l=new n;o.prototype.computeB=function(e){var t=this.a,r=this.b,n=this.axisA,i=this.axisB,a=s,o=l,u=this.jacobianElementA,h=this.jacobianElementB;n.cross(i,a);i.cross(n,o);u.rotational.copy(o);h.rotational.copy(a);var c=Math.cos(this.angle)-n.dot(i),f=this.computeGW(),p=this.computeGiMf();var d=-c*t-f*r-e*p;return d}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],19:[function(e,t,r){t.exports=o;var n=e("./Equation");var i=e("../math/Vec3");var a=e("../math/Mat3");function o(e,t,r){r=typeof r!=="undefined"?r:1e6;n.call(this,e,t,0,r);this.restitution=0;this.ri=new i;this.rj=new i;this.ni=new i}o.prototype=new n;o.prototype.constructor=o;var s=new i;var l=new i;var u=new i;o.prototype.computeB=function(e){var t=this.a,r=this.b,n=this.bi,i=this.bj,a=this.ri,o=this.rj,h=s,c=l,f=n.velocity,p=n.angularVelocity,d=n.force,v=n.torque,m=i.velocity,_=i.angularVelocity,g=i.force,y=i.torque,x=u,b=this.jacobianElementA,w=this.jacobianElementB,T=this.ni;a.cross(T,h);o.cross(T,c);T.negate(b.spatial);h.negate(b.rotational);w.spatial.copy(T);w.rotational.copy(c);x.copy(i.position);x.vadd(o,x);x.vsub(n.position,x);x.vsub(a,x);var E=T.dot(x);var S=this.restitution+1;var M=S*m.dot(T)-S*f.dot(T)+_.dot(c)-p.dot(h);var A=this.computeGiMf();var R=-E*t-M*r-e*A;return R};var h=new i;var c=new i;var f=new i;var p=new i;var d=new i;o.prototype.getImpactVelocityAlongNormal=function(){var e=h;var t=c;var r=f;var n=p;var i=d;this.bi.position.vadd(this.ri,r);this.bj.position.vadd(this.rj,n);this.bi.getVelocityAtWorldPoint(r,e);this.bj.getVelocityAtWorldPoint(n,t);e.vsub(t,i);return this.ni.dot(i)}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],20:[function(e,t,r){t.exports=a;var n=e("../math/JacobianElement"),i=e("../math/Vec3");function a(e,t,r,i){this.id=a.id++;this.minForce=typeof r==="undefined"?-1e6:r;this.maxForce=typeof i==="undefined"?1e6:i;this.bi=e;this.bj=t;this.a=0;this.b=0;this.eps=0;this.jacobianElementA=new n;this.jacobianElementB=new n;this.enabled=true;this.setSpookParams(1e7,4,1/60)}a.prototype.constructor=a;a.id=0;a.prototype.setSpookParams=function(e,t,r){var n=t,i=e,a=r;this.a=4/(a*(1+4*n));this.b=4*n/(1+4*n);this.eps=4/(a*a*i*(1+4*n))};a.prototype.computeB=function(e,t,r){var n=this.computeGW(),i=this.computeGq(),a=this.computeGiMf();return-i*e-n*t-a*r};a.prototype.computeGq=function(){var e=this.jacobianElementA,t=this.jacobianElementB,r=this.bi,n=this.bj,i=r.position,a=n.position;return e.spatial.dot(i)+t.spatial.dot(a)};var o=new i;a.prototype.computeGW=function(){var e=this.jacobianElementA,t=this.jacobianElementB,r=this.bi,n=this.bj,i=r.velocity,a=n.velocity,s=r.angularVelocity||o,l=n.angularVelocity||o;return e.multiplyVectors(i,s)+t.multiplyVectors(a,l)};a.prototype.computeGWlambda=function(){var e=this.jacobianElementA,t=this.jacobianElementB,r=this.bi,n=this.bj,i=r.vlambda,a=n.vlambda,s=r.wlambda||o,l=n.wlambda||o;return e.multiplyVectors(i,s)+t.multiplyVectors(a,l)};var s=new i,l=new i,u=new i,h=new i;a.prototype.computeGiMf=function(){var e=this.jacobianElementA,t=this.jacobianElementB,r=this.bi,n=this.bj,i=r.force,a=r.torque,o=n.force,c=n.torque,f=r.invMassSolve,p=n.invMassSolve;if(r.invInertiaWorldSolve){r.invInertiaWorldSolve.vmult(a,u)}else{u.set(0,0,0)}if(n.invInertiaWorldSolve){n.invInertiaWorldSolve.vmult(c,h)}else{h.set(0,0,0)}i.mult(f,s);o.mult(p,l);return e.multiplyVectors(s,u)+t.multiplyVectors(l,h)};var c=new i;a.prototype.computeGiMGt=function(){var e=this.jacobianElementA,t=this.jacobianElementB,r=this.bi,n=this.bj,i=r.invMassSolve,a=n.invMassSolve,o=r.invInertiaWorldSolve,s=n.invInertiaWorldSolve,l=i+a;if(o){o.vmult(e.rotational,c);l+=c.dot(e.rotational)}if(s){s.vmult(t.rotational,c);l+=c.dot(t.rotational)}return l};var f=new i,p=new i,d=new i,v=new i,m=new i,_=new i;a.prototype.addToWlambda=function(e){var t=this.jacobianElementA,r=this.jacobianElementB,n=this.bi,i=this.bj,a=f;t.spatial.mult(n.invMassSolve*e,a);n.vlambda.vadd(a,n.vlambda);r.spatial.mult(i.invMassSolve*e,a);i.vlambda.vadd(a,i.vlambda);if(n.invInertiaWorldSolve){n.invInertiaWorldSolve.vmult(t.rotational,a);a.mult(e,a);n.wlambda.vadd(a,n.wlambda)}if(i.invInertiaWorldSolve){i.invInertiaWorldSolve.vmult(r.rotational,a);a.mult(e,a);i.wlambda.vadd(a,i.wlambda)}};a.prototype.computeC=function(){return this.computeGiMGt()+this.eps}},{"../math/JacobianElement":26,"../math/Vec3":30}],21:[function(e,t,r){t.exports=o;var n=e("./Equation");var i=e("../math/Vec3");var a=e("../math/Mat3");function o(e,t,r){n.call(this,e,t,-r,r);this.ri=new i;this.rj=new i;this.t=new i}o.prototype=new n;o.prototype.constructor=o;var s=new i;var l=new i;o.prototype.computeB=function(e){var t=this.a,r=this.b,n=this.bi,i=this.bj,a=this.ri,o=this.rj,u=s,h=l,c=this.t;a.cross(c,u);o.cross(c,h);var f=this.jacobianElementA,p=this.jacobianElementB;c.negate(f.spatial);u.negate(f.rotational);p.spatial.copy(c);p.rotational.copy(h);var d=this.computeGW();var v=this.computeGiMf();var m=-d*r-e*v;return m}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],22:[function(e,t,r){t.exports=o;var n=e("../math/Vec3");var i=e("../math/Mat3");var a=e("./Equation");function o(e,t,r){r=r||{};var i=typeof r.maxForce!=="undefined"?r.maxForce:1e6;a.call(this,e,t,-i,i);this.axisA=r.axisA?r.axisA.clone():new n(1,0,0);this.axisB=r.axisB?r.axisB.clone():new n(0,1,0);this.maxAngle=Math.PI/2}o.prototype=new a;o.prototype.constructor=o;var s=new n;var l=new n;o.prototype.computeB=function(e){var t=this.a,r=this.b,n=this.axisA,i=this.axisB,a=s,o=l,u=this.jacobianElementA,h=this.jacobianElementB;n.cross(i,a);i.cross(n,o);u.rotational.copy(o);h.rotational.copy(a);var c=Math.cos(this.maxAngle)-n.dot(i),f=this.computeGW(),p=this.computeGiMf();var d=-c*t-f*r-e*p;return d}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],23:[function(e,t,r){t.exports=o;var n=e("../math/Vec3");var i=e("../math/Mat3");var a=e("./Equation");function o(e,t,r){r=typeof r!=="undefined"?r:1e6;a.call(this,e,t,-r,r);this.axisA=new n;this.axisB=new n;this.targetVelocity=0}o.prototype=new a;o.prototype.constructor=o;o.prototype.computeB=function(e){var t=this.a,r=this.b,n=this.bi,i=this.bj,a=this.axisA,o=this.axisB,s=this.jacobianElementA,l=this.jacobianElementB;s.rotational.copy(a);o.negate(l.rotational);var u=this.computeGW()-this.targetVelocity,h=this.computeGiMf();var c=-u*r-e*h;return c}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],24:[function(e,t,r){var n=e("../utils/Utils");t.exports=i;function i(e,t,r){r=n.defaults(r,{friction:.3,restitution:.3,contactEquationStiffness:1e7,contactEquationRelaxation:3,frictionEquationStiffness:1e7,frictionEquationRelaxation:3});this.id=i.idCounter++;this.materials=[e,t];this.friction=r.friction;this.restitution=r.restitution;this.contactEquationStiffness=r.contactEquationStiffness;this.contactEquationRelaxation=r.contactEquationRelaxation;this.frictionEquationStiffness=r.frictionEquationStiffness;this.frictionEquationRelaxation=r.frictionEquationRelaxation}i.idCounter=0},{"../utils/Utils":53}],25:[function(e,t,r){t.exports=n;function n(e){var t="";e=e||{};if(typeof e==="string"){t=e;e={}}else if(typeof e==="object"){t=""}this.name=t;this.id=n.idCounter++;this.friction=typeof e.friction!=="undefined"?e.friction:-1;this.restitution=typeof e.restitution!=="undefined"?e.restitution:-1}n.idCounter=0},{}],26:[function(e,t,r){t.exports=i;var n=e("./Vec3");function i(){this.spatial=new n;this.rotational=new n}i.prototype.multiplyElement=function(e){return e.spatial.dot(this.spatial)+e.rotational.dot(this.rotational)};i.prototype.multiplyVectors=function(e,t){return e.dot(this.spatial)+t.dot(this.rotational)}},{"./Vec3":30}],27:[function(e,t,r){t.exports=i;var n=e("./Vec3");function i(e){if(e){this.elements=e}else{this.elements=[0,0,0,0,0,0,0,0,0]}}i.prototype.identity=function(){var e=this.elements;e[0]=1;e[1]=0;e[2]=0;e[3]=0;e[4]=1;e[5]=0;e[6]=0;e[7]=0;e[8]=1};i.prototype.setZero=function(){var e=this.elements;e[0]=0;e[1]=0;e[2]=0;e[3]=0;e[4]=0;e[5]=0;e[6]=0;e[7]=0;e[8]=0};i.prototype.setTrace=function(e){var t=this.elements;t[0]=e.x;t[4]=e.y;t[8]=e.z};i.prototype.getTrace=function(e){var e=e||new n;var t=this.elements;e.x=t[0];e.y=t[4];e.z=t[8]};i.prototype.vmult=function(e,t){t=t||new n;var r=this.elements,i=e.x,a=e.y,o=e.z;t.x=r[0]*i+r[1]*a+r[2]*o;t.y=r[3]*i+r[4]*a+r[5]*o;t.z=r[6]*i+r[7]*a+r[8]*o;return t};i.prototype.smult=function(e){var t=this;for(var r=0;r<this.elements.length;r++){t.elements[r]*=e}};i.prototype.mmult=function(e,t){var r=this;var n=t||new i;for(var a=0;a<3;a++){for(var o=0;o<3;o++){var s=0;for(var l=0;l<3;l++){s+=e.elements[a+l*3]*r.elements[l+o*3]}n.elements[a+o*3]=s}}return n};i.prototype.scale=function(e,t){t=t||new i;var r=this.elements,n=t.elements;for(var a=0;a!==3;a++){n[3*a+0]=e.x*r[3*a+0];n[3*a+1]=e.y*r[3*a+1];n[3*a+2]=e.z*r[3*a+2]}return t};i.prototype.solve=function(e,t){var r=this;t=t||new n;var i=3;var a=4;var o=[];for(var s=0;s<i*a;s++){o.push(0)}var s,l;for(s=0;s<3;s++){for(l=0;l<3;l++){o[s+a*l]=r.elements[s+3*l]}}o[3+4*0]=e.x;o[3+4*1]=e.y;o[3+4*2]=e.z;var u=3,h=u,c;var f=4;var p;do{s=h-u;if(o[s+a*s]===0){for(l=s+1;l<h;l++){if(o[s+a*l]!==0){c=f;do{p=f-c;o[p+a*s]+=o[p+a*l]}while(--c);break}}}if(o[s+a*s]!==0){for(l=s+1;l<h;l++){var d=o[s+a*l]/o[s+a*s];c=f;do{p=f-c;o[p+a*l]=p<=s?0:o[p+a*l]-o[p+a*s]*d}while(--c)}}}while(--u);t.z=o[2*a+3]/o[2*a+2];t.y=(o[1*a+3]-o[1*a+2]*t.z)/o[1*a+1];t.x=(o[0*a+3]-o[0*a+2]*t.z-o[0*a+1]*t.y)/o[0*a+0];if(isNaN(t.x)||isNaN(t.y)||isNaN(t.z)||t.x===Infinity||t.y===Infinity||t.z===Infinity){throw"Could not solve equation! Got x=["+t.toString()+"], b=["+e.toString()+"], A=["+this.toString()+"]"}return t};i.prototype.e=function(e,t,r){if(r===undefined){return this.elements[t+3*e]}else{this.elements[t+3*e]=r}};i.prototype.copy=function(e){var t=this;for(var r=0;r<e.elements.length;r++){t.elements[r]=e.elements[r]}return this};i.prototype.toString=function(){var e=this;var t="";var r=",";for(var n=0;n<9;n++){t+=e.elements[n]+r}return t};i.prototype.reverse=function(e){var t=this;e=e||new i;var r=3;var n=6;var a=[];for(var o=0;o<r*n;o++){a.push(0)}var o,s;for(o=0;o<3;o++){for(s=0;s<3;s++){a[o+n*s]=t.elements[o+3*s]}}a[3+6*0]=1;a[3+6*1]=0;a[3+6*2]=0;a[4+6*0]=0;a[4+6*1]=1;a[4+6*2]=0;a[5+6*0]=0;a[5+6*1]=0;a[5+6*2]=1;var l=3,u=l,h;var c=n;var f;do{o=u-l;if(a[o+n*o]===0){for(s=o+1;s<u;s++){if(a[o+n*s]!==0){h=c;do{f=c-h;a[f+n*o]+=a[f+n*s]}while(--h);break}}}if(a[o+n*o]!==0){for(s=o+1;s<u;s++){var p=a[o+n*s]/a[o+n*o];h=c;do{f=c-h;a[f+n*s]=f<=o?0:a[f+n*s]-a[f+n*o]*p}while(--h)}}}while(--l);o=2;do{s=o-1;do{var p=a[o+n*s]/a[o+n*o];h=n;do{f=n-h;a[f+n*s]=a[f+n*s]-a[f+n*o]*p}while(--h)}while(s--)}while(--o);o=2;do{var p=1/a[o+n*o];h=n;do{f=n-h;a[f+n*o]=a[f+n*o]*p}while(--h)}while(o--);o=2;do{s=2;do{f=a[r+s+n*o];if(isNaN(f)||f===Infinity){throw"Could not reverse! A=["+t.toString()+"]"}e.e(o,s,f)}while(s--)}while(o--);return e};i.prototype.setRotationFromQuaternion=function(e){var t=e.x,r=e.y,n=e.z,i=e.w,a=t+t,o=r+r,s=n+n,l=t*a,u=t*o,h=t*s,c=r*o,f=r*s,p=n*s,d=i*a,v=i*o,m=i*s,_=this.elements;_[3*0+0]=1-(c+p);_[3*0+1]=u-m;_[3*0+2]=h+v;_[3*1+0]=u+m;_[3*1+1]=1-(l+p);_[3*1+2]=f-d;_[3*2+0]=h-v;_[3*2+1]=f+d;_[3*2+2]=1-(l+c);return this};i.prototype.transpose=function(e){e=e||new i;var t=e.elements,r=this.elements;for(var n=0;n!==3;n++){for(var a=0;a!==3;a++){t[3*n+a]=r[3*a+n]}}return e}},{"./Vec3":30}],28:[function(e,t,r){t.exports=i;var n=e("./Vec3");function i(e,t,r,n){this.x=e!==undefined?e:0;this.y=t!==undefined?t:0;this.z=r!==undefined?r:0;this.w=n!==undefined?n:1}i.prototype.set=function(e,t,r,n){this.x=e;this.y=t;this.z=r;this.w=n};i.prototype.toString=function(){return this.x+","+this.y+","+this.z+","+this.w};i.prototype.toArray=function(){return[this.x,this.y,this.z,this.w]};i.prototype.setFromAxisAngle=function(e,t){var r=Math.sin(t*.5);this.x=e.x*r;this.y=e.y*r;this.z=e.z*r;this.w=Math.cos(t*.5)};i.prototype.toAxisAngle=function(e){e=e||new n;this.normalize();var t=2*Math.acos(this.w);var r=Math.sqrt(1-this.w*this.w);if(r<.001){e.x=this.x;e.y=this.y;e.z=this.z}else{e.x=this.x/r;e.y=this.y/r;e.z=this.z/r}return[e,t]};var a=new n,o=new n;i.prototype.setFromVectors=function(e,t){if(e.isAntiparallelTo(t)){var r=a;var n=o;e.tangents(r,n);this.setFromAxisAngle(r,Math.PI)}else{var i=e.cross(t);this.x=i.x;this.y=i.y;this.z=i.z;this.w=Math.sqrt(Math.pow(e.norm(),2)*Math.pow(t.norm(),2))+e.dot(t);this.normalize()}};var s=new n;var l=new n;var u=new n;i.prototype.mult=function(e,t){t=t||new i;var r=this.w,n=s,a=l,o=u;n.set(this.x,this.y,this.z);a.set(e.x,e.y,e.z);t.w=r*e.w-n.dot(a);n.cross(a,o);t.x=r*a.x+e.w*n.x+o.x;t.y=r*a.y+e.w*n.y+o.y;t.z=r*a.z+e.w*n.z+o.z;return t};i.prototype.inverse=function(e){var t=this.x,r=this.y,n=this.z,a=this.w;e=e||new i;this.conjugate(e);var o=1/(t*t+r*r+n*n+a*a);e.x*=o;e.y*=o;e.z*=o;e.w*=o;return e};i.prototype.conjugate=function(e){e=e||new i;e.x=-this.x;e.y=-this.y;e.z=-this.z;e.w=this.w;return e};i.prototype.normalize=function(){var e=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);if(e===0){this.x=0;this.y=0;this.z=0;this.w=0}else{e=1/e;this.x*=e;this.y*=e;this.z*=e;this.w*=e}};i.prototype.normalizeFast=function(){var e=(3-(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w))/2;if(e===0){this.x=0;this.y=0;this.z=0;this.w=0}else{this.x*=e;this.y*=e;this.z*=e;this.w*=e}};i.prototype.vmult=function(e,t){t=t||new n;var r=e.x,i=e.y,a=e.z;var o=this.x,s=this.y,l=this.z,u=this.w;var h=u*r+s*a-l*i,c=u*i+l*r-o*a,f=u*a+o*i-s*r,p=-o*r-s*i-l*a;t.x=h*u+p*-o+c*-l-f*-s;t.y=c*u+p*-s+f*-o-h*-l;t.z=f*u+p*-l+h*-s-c*-o;return t};i.prototype.copy=function(e){this.x=e.x;this.y=e.y;this.z=e.z;this.w=e.w;return this};i.prototype.toEuler=function(e,t){t=t||"YZX";var r,n,i;var a=this.x,o=this.y,s=this.z,l=this.w;switch(t){case"YZX":var u=a*o+s*l;if(u>.499){r=2*Math.atan2(a,l);n=Math.PI/2;i=0}if(u<-.499){r=-2*Math.atan2(a,l);n=-Math.PI/2;i=0}if(isNaN(r)){var h=a*a;var c=o*o;var f=s*s;r=Math.atan2(2*o*l-2*a*s,1-2*c-2*f);n=Math.asin(2*u);i=Math.atan2(2*a*l-2*o*s,1-2*h-2*f)}break;default:throw new Error("Euler order "+t+" not supported yet.")}e.y=r;e.z=n;e.x=i};i.prototype.setFromEuler=function(e,t,r,n){n=n||"XYZ";var i=Math.cos(e/2);var a=Math.cos(t/2);var o=Math.cos(r/2);var s=Math.sin(e/2);var l=Math.sin(t/2);var u=Math.sin(r/2);if(n==="XYZ"){this.x=s*a*o+i*l*u;this.y=i*l*o-s*a*u;this.z=i*a*u+s*l*o;this.w=i*a*o-s*l*u}else if(n==="YXZ"){this.x=s*a*o+i*l*u;this.y=i*l*o-s*a*u;this.z=i*a*u-s*l*o;this.w=i*a*o+s*l*u}else if(n==="ZXY"){this.x=s*a*o-i*l*u;this.y=i*l*o+s*a*u;this.z=i*a*u+s*l*o;this.w=i*a*o-s*l*u}else if(n==="ZYX"){this.x=s*a*o-i*l*u;this.y=i*l*o+s*a*u;this.z=i*a*u-s*l*o;this.w=i*a*o+s*l*u}else if(n==="YZX"){this.x=s*a*o+i*l*u;this.y=i*l*o+s*a*u;this.z=i*a*u-s*l*o;this.w=i*a*o-s*l*u}else if(n==="XZY"){this.x=s*a*o-i*l*u;this.y=i*l*o-s*a*u;this.z=i*a*u+s*l*o;this.w=i*a*o+s*l*u}return this};i.prototype.clone=function(){return new i(this.x,this.y,this.z,this.w)}},{"./Vec3":30}],29:[function(e,t,r){var n=e("./Vec3");var i=e("./Quaternion");t.exports=a;function a(e){e=e||{};this.position=new n;if(e.position){this.position.copy(e.position)}this.quaternion=new i;if(e.quaternion){this.quaternion.copy(e.quaternion)}}var o=new i;a.pointToLocalFrame=function(e,t,r,i){var i=i||new n;r.vsub(e,i);t.conjugate(o);o.vmult(i,i);return i};a.prototype.pointToLocal=function(e,t){return a.pointToLocalFrame(this.position,this.quaternion,e,t)};a.pointToWorldFrame=function(e,t,r,i){var i=i||new n;t.vmult(r,i);i.vadd(e,i);return i};a.prototype.pointToWorld=function(e,t){return a.pointToWorldFrame(this.position,this.quaternion,e,t)};a.prototype.vectorToWorldFrame=function(e,t){var t=t||new n;this.quaternion.vmult(e,t);return t};a.vectorToWorldFrame=function(e,t,r){e.vmult(t,r);return r};a.vectorToLocalFrame=function(e,t,r,i){var i=i||new n;t.w*=-1;t.vmult(r,i);t.w*=-1;return i}},{"./Quaternion":28,"./Vec3":30}],30:[function(e,t,r){t.exports=i;var n=e("./Mat3");function i(e,t,r){this.x=e||0;this.y=t||0;this.z=r||0}i.ZERO=new i(0,0,0);i.UNIT_X=new i(1,0,0);i.UNIT_Y=new i(0,1,0);i.UNIT_Z=new i(0,0,1);i.prototype.cross=function(e,t){var r=e.x,n=e.y,a=e.z,o=this.x,s=this.y,l=this.z;t=t||new i;t.x=s*a-l*n;t.y=l*r-o*a;t.z=o*n-s*r;return t};i.prototype.set=function(e,t,r){this.x=e;this.y=t;this.z=r;return this};i.prototype.setZero=function(){this.x=this.y=this.z=0};i.prototype.vadd=function(e,t){if(t){t.x=e.x+this.x;t.y=e.y+this.y;t.z=e.z+this.z}else{return new i(this.x+e.x,this.y+e.y,this.z+e.z)}};i.prototype.vsub=function(e,t){if(t){t.x=this.x-e.x;t.y=this.y-e.y;t.z=this.z-e.z}else{return new i(this.x-e.x,this.y-e.y,this.z-e.z)}};i.prototype.crossmat=function(){return new n([0,-this.z,this.y,this.z,0,-this.x,-this.y,this.x,0])};i.prototype.normalize=function(){var e=this.x,t=this.y,r=this.z;var n=Math.sqrt(e*e+t*t+r*r);if(n>0){var i=1/n;this.x*=i;this.y*=i;this.z*=i}else{this.x=0;this.y=0;this.z=0}return n};i.prototype.unit=function(e){e=e||new i;var t=this.x,r=this.y,n=this.z;var a=Math.sqrt(t*t+r*r+n*n);if(a>0){a=1/a;e.x=t*a;e.y=r*a;e.z=n*a}else{e.x=1;e.y=0;e.z=0}return e};i.prototype.norm=function(){var e=this.x,t=this.y,r=this.z;return Math.sqrt(e*e+t*t+r*r)};i.prototype.length=i.prototype.norm;i.prototype.norm2=function(){return this.dot(this)};i.prototype.lengthSquared=i.prototype.norm2;i.prototype.distanceTo=function(e){var t=this.x,r=this.y,n=this.z;var i=e.x,a=e.y,o=e.z;return Math.sqrt((i-t)*(i-t)+(a-r)*(a-r)+(o-n)*(o-n))};i.prototype.distanceSquared=function(e){var t=this.x,r=this.y,n=this.z;var i=e.x,a=e.y,o=e.z;return(i-t)*(i-t)+(a-r)*(a-r)+(o-n)*(o-n)};i.prototype.mult=function(e,t){t=t||new i;var r=this.x,n=this.y,a=this.z;t.x=e*r;t.y=e*n;t.z=e*a;return t};i.prototype.scale=i.prototype.mult;i.prototype.dot=function(e){return this.x*e.x+this.y*e.y+this.z*e.z};i.prototype.isZero=function(){return this.x===0&&this.y===0&&this.z===0};i.prototype.negate=function(e){e=e||new i;e.x=-this.x;e.y=-this.y;e.z=-this.z;return e};var a=new i;var o=new i;i.prototype.tangents=function(e,t){var r=this.norm();if(r>0){var n=a;var i=1/r;n.set(this.x*i,this.y*i,this.z*i);var s=o;if(Math.abs(n.x)<.9){s.set(1,0,0);n.cross(s,e)}else{s.set(0,1,0);n.cross(s,e)}n.cross(e,t)}else{e.set(1,0,0);t.set(0,1,0)}};i.prototype.toString=function(){return this.x+","+this.y+","+this.z};i.prototype.toArray=function(){return[this.x,this.y,this.z]};i.prototype.copy=function(e){this.x=e.x;this.y=e.y;this.z=e.z;return this};i.prototype.lerp=function(e,t,r){var n=this.x,i=this.y,a=this.z;r.x=n+(e.x-n)*t;r.y=i+(e.y-i)*t;r.z=a+(e.z-a)*t};i.prototype.almostEquals=function(e,t){if(t===undefined){t=1e-6}if(Math.abs(this.x-e.x)>t||Math.abs(this.y-e.y)>t||Math.abs(this.z-e.z)>t){return false}return true};i.prototype.almostZero=function(e){if(e===undefined){e=1e-6}if(Math.abs(this.x)>e||Math.abs(this.y)>e||Math.abs(this.z)>e){return false}return true};var s=new i;i.prototype.isAntiparallelTo=function(e,t){this.negate(s);return s.almostEquals(e,t)};i.prototype.clone=function(){return new i(this.x,this.y,this.z)}},{"./Mat3":27}],31:[function(e,t,r){t.exports=c;var n=e("../utils/EventTarget");var i=e("../shapes/Shape");var a=e("../math/Vec3");var o=e("../math/Mat3");var s=e("../math/Quaternion");var l=e("../material/Material");var u=e("../collision/AABB");var h=e("../shapes/Box");function c(e){e=e||{};n.apply(this);this.id=c.idCounter++;this.world=null;this.preStep=null;this.postStep=null;this.vlambda=new a;this.collisionFilterGroup=typeof e.collisionFilterGroup==="number"?e.collisionFilterGroup:1;this.collisionFilterMask=typeof e.collisionFilterMask==="number"?e.collisionFilterMask:1;this.collisionResponse=true;this.position=new a;if(e.position){this.position.copy(e.position)}this.previousPosition=new a;this.initPosition=new a;this.velocity=new a;if(e.velocity){this.velocity.copy(e.velocity)}this.initVelocity=new a;this.force=new a;var t=typeof e.mass==="number"?e.mass:0;this.mass=t;this.invMass=t>0?1/t:0;this.material=e.material||null;this.linearDamping=typeof e.linearDamping==="number"?e.linearDamping:.01;this.type=t<=0?c.STATIC:c.DYNAMIC;if(typeof e.type===typeof c.STATIC){this.type=e.type}this.allowSleep=typeof e.allowSleep!=="undefined"?e.allowSleep:true;this.sleepState=0;this.sleepSpeedLimit=typeof e.sleepSpeedLimit!=="undefined"?e.sleepSpeedLimit:.1;this.sleepTimeLimit=typeof e.sleepTimeLimit!=="undefined"?e.sleepTimeLimit:1;this.timeLastSleepy=0;this._wakeUpAfterNarrowphase=false;this.torque=new a;this.quaternion=new s;if(e.quaternion){this.quaternion.copy(e.quaternion)}this.initQuaternion=new s;this.angularVelocity=new a;if(e.angularVelocity){this.angularVelocity.copy(e.angularVelocity)}this.initAngularVelocity=new a;this.interpolatedPosition=new a;this.interpolatedQuaternion=new s;this.shapes=[];this.shapeOffsets=[];this.shapeOrientations=[];this.inertia=new a;this.invInertia=new a;this.invInertiaWorld=new o;this.invMassSolve=0;this.invInertiaSolve=new a;this.invInertiaWorldSolve=new o;this.fixedRotation=typeof e.fixedRotation!=="undefined"?e.fixedRotation:false;this.angularDamping=typeof e.angularDamping!=="undefined"?e.angularDamping:.01;this.aabb=new u;this.aabbNeedsUpdate=true;this.wlambda=new a;if(e.shape){this.addShape(e.shape)}this.updateMassProperties()}c.prototype=new n;c.prototype.constructor=c;c.DYNAMIC=1;c.STATIC=2;c.KINEMATIC=4;c.AWAKE=0;c.SLEEPY=1;c.SLEEPING=2;c.idCounter=0;c.prototype.wakeUp=function(){var e=this.sleepState;this.sleepState=0;if(e===c.SLEEPING){this.dispatchEvent({type:"wakeup"})}};c.prototype.sleep=function(){this.sleepState=c.SLEEPING;this.velocity.set(0,0,0);this.angularVelocity.set(0,0,0)};c.sleepyEvent={type:"sleepy"};c.sleepEvent={type:"sleep"};c.prototype.sleepTick=function(e){if(this.allowSleep){var t=this.sleepState;var r=this.velocity.norm2()+this.angularVelocity.norm2();var n=Math.pow(this.sleepSpeedLimit,2);if(t===c.AWAKE&&r<n){this.sleepState=c.SLEEPY;this.timeLastSleepy=e;this.dispatchEvent(c.sleepyEvent)}else if(t===c.SLEEPY&&r>n){this.wakeUp()}else if(t===c.SLEEPY&&e-this.timeLastSleepy>this.sleepTimeLimit){this.sleep();this.dispatchEvent(c.sleepEvent)}}};c.prototype.updateSolveMassProperties=function(){if(this.sleepState===c.SLEEPING||this.type===c.KINEMATIC){this.invMassSolve=0;this.invInertiaSolve.setZero();this.invInertiaWorldSolve.setZero()}else{this.invMassSolve=this.invMass;this.invInertiaSolve.copy(this.invInertia);this.invInertiaWorldSolve.copy(this.invInertiaWorld)}};c.prototype.pointToLocalFrame=function(e,t){var t=t||new a;e.vsub(this.position,t);this.quaternion.conjugate().vmult(t,t);return t};c.prototype.vectorToLocalFrame=function(e,t){var t=t||new a;this.quaternion.conjugate().vmult(e,t);return t};c.prototype.pointToWorldFrame=function(e,t){var t=t||new a;this.quaternion.vmult(e,t);t.vadd(this.position,t);return t};c.prototype.vectorToWorldFrame=function(e,t){var t=t||new a;this.quaternion.vmult(e,t);return t};var f=new a;var p=new s;c.prototype.addShape=function(e,t,r){var n=new a;var i=new s;if(t){n.copy(t)}if(r){i.copy(r)}this.shapes.push(e);this.shapeOffsets.push(n);this.shapeOrientations.push(i);this.updateMassProperties();this.updateBoundingRadius();this.aabbNeedsUpdate=true;return this};c.prototype.updateBoundingRadius=function(){var e=this.shapes,t=this.shapeOffsets,r=e.length,n=0;for(var i=0;i!==r;i++){var a=e[i];a.updateBoundingSphereRadius();var o=t[i].norm(),s=a.boundingSphereRadius;if(o+s>n){n=o+s}}this.boundingRadius=n};var d=new u;c.prototype.computeAABB=function(){var e=this;var t=this.shapes,r=this.shapeOffsets,n=this.shapeOrientations,i=t.length,a=f,o=p,s=this.quaternion,l=this.aabb,u=d;for(var h=0;h!==i;h++){var c=t[h];n[h].mult(s,o);o.vmult(r[h],a);a.vadd(e.position,a);c.calculateWorldAABB(a,o,u.lowerBound,u.upperBound);if(h===0){l.copy(u)}else{l.extend(u)}}this.aabbNeedsUpdate=false};var v=new o,m=new o,_=new o;c.prototype.updateInertiaWorld=function(e){var t=this.invInertia;if(t.x===t.y&&t.y===t.z&&!e){}else{var r=v,n=m;r.setRotationFromQuaternion(this.quaternion);r.transpose(n);r.scale(t,r);r.mmult(n,this.invInertiaWorld)}};var g=new a;var y=new a;c.prototype.applyForce=function(e,t){if(this.type!==c.DYNAMIC){return}var r=g;t.vsub(this.position,r);var n=y;r.cross(e,n);this.force.vadd(e,this.force);this.torque.vadd(n,this.torque)};var x=new a;var b=new a;c.prototype.applyLocalForce=function(e,t){if(this.type!==c.DYNAMIC){return}var r=x;var n=b;this.vectorToWorldFrame(e,r);this.pointToWorldFrame(t,n);this.applyForce(r,n)};var w=new a;var T=new a;var E=new a;c.prototype.applyImpulse=function(e,t){if(this.type!==c.DYNAMIC){return}var r=w;t.vsub(this.position,r);var n=T;n.copy(e);n.mult(this.invMass,n);this.velocity.vadd(n,this.velocity);var i=E;r.cross(e,i);this.invInertiaWorld.vmult(i,i);this.angularVelocity.vadd(i,this.angularVelocity)};var S=new a;var M=new a;c.prototype.applyLocalImpulse=function(e,t){if(this.type!==c.DYNAMIC){return}var r=S;var n=M;this.vectorToWorldFrame(e,r);this.pointToWorldFrame(t,n);this.applyImpulse(r,n)};var A=new a;c.prototype.updateMassProperties=function(){var e=A;this.invMass=this.mass>0?1/this.mass:0;var t=this.inertia;var r=this.fixedRotation;this.computeAABB();e.set((this.aabb.upperBound.x-this.aabb.lowerBound.x)/2,(this.aabb.upperBound.y-this.aabb.lowerBound.y)/2,(this.aabb.upperBound.z-this.aabb.lowerBound.z)/2);h.calculateInertia(e,this.mass,t);this.invInertia.set(t.x>0&&!r?1/t.x:0,t.y>0&&!r?1/t.y:0,t.z>0&&!r?1/t.z:0);this.updateInertiaWorld(true)};c.prototype.getVelocityAtWorldPoint=function(e,t){var r=new a;e.vsub(this.position,r);this.angularVelocity.cross(r,t);this.velocity.vadd(t,t);return t}},{"../collision/AABB":3,"../material/Material":25,"../math/Mat3":27,"../math/Quaternion":28,"../math/Vec3":30,"../shapes/Box":37,"../shapes/Shape":43,"../utils/EventTarget":49}],32:[function(e,t,r){var n=e("./Body");var i=e("../math/Vec3");var a=e("../math/Quaternion");var o=e("../collision/RaycastResult");var s=e("../collision/Ray");var l=e("../objects/WheelInfo");t.exports=u;function u(e){this.chassisBody=e.chassisBody;this.wheelInfos=[];this.sliding=false;this.world=null;this.indexRightAxis=typeof e.indexRightAxis!=="undefined"?e.indexRightAxis:1;this.indexForwardAxis=typeof e.indexForwardAxis!=="undefined"?e.indexForwardAxis:0;this.indexUpAxis=typeof e.indexUpAxis!=="undefined"?e.indexUpAxis:2}var h=new i;var c=new i;var f=new i;var p=new i;var d=new i;var v=new i;var m=new s;u.prototype.addWheel=function(e){e=e||{};var t=new l(e);var r=this.wheelInfos.length;this.wheelInfos.push(t);return r};u.prototype.setSteeringValue=function(e,t){var r=this.wheelInfos[t];r.steering=e};var _=new i;u.prototype.applyEngineForce=function(e,t){this.wheelInfos[t].engineForce=e};u.prototype.setBrake=function(e,t){this.wheelInfos[t].brake=e};u.prototype.addToWorld=function(e){var t=this.constraints;e.add(this.chassisBody);var r=this;this.preStepCallback=function(){r.updateVehicle(e.dt)};e.addEventListener("preStep",this.preStepCallback);this.world=e};u.prototype.getVehicleAxisWorld=function(e,t){t.set(e===0?1:0,e===1?1:0,e===2?1:0);this.chassisBody.vectorToWorldFrame(t,t)};u.prototype.updateVehicle=function(e){var t=this;var r=this.wheelInfos;var n=r.length;var a=this.chassisBody;for(var o=0;o<n;o++){t.updateWheelTransform(o)}this.currentVehicleSpeedKmHour=3.6*a.velocity.norm();var s=new i;this.getVehicleAxisWorld(this.indexForwardAxis,s);if(s.dot(a.velocity)<0){this.currentVehicleSpeedKmHour*=-1}for(var o=0;o<n;o++){t.castRay(r[o])}this.updateSuspension(e);var l=new i;var u=new i;for(var o=0;o<n;o++){var h=r[o];var c=h.suspensionForce;if(c>h.maxSuspensionForce){c=h.maxSuspensionForce}h.raycastResult.hitNormalWorld.scale(c*e,l);h.raycastResult.hitPointWorld.vsub(a.position,u);a.applyImpulse(l,h.raycastResult.hitPointWorld)}this.updateFriction(e);var f=new i;var p=new i;var d=new i;for(o=0;o<n;o++){var h=r[o];a.getVelocityAtWorldPoint(h.chassisConnectionPointWorld,d);var v=1;switch(t.indexUpAxis){case 1:v=-1;break}if(h.isInContact){t.getVehicleAxisWorld(t.indexForwardAxis,p);var m=p.dot(h.raycastResult.hitNormalWorld);h.raycastResult.hitNormalWorld.scale(m,f);p.vsub(f,p);var _=p.dot(d);h.deltaRotation=v*_*e/h.radius}if((h.sliding||!h.isInContact)&&h.engineForce!==0&&h.useCustomSlidingRotationalSpeed){h.deltaRotation=(h.engineForce>0?1:-1)*h.customSlidingRotationalSpeed*e}if(Math.abs(h.brake)>Math.abs(h.engineForce)){h.deltaRotation=0}h.rotation+=h.deltaRotation;h.deltaRotation*=.99}};u.prototype.updateSuspension=function(e){var t=this.chassisBody;var r=t.mass;var n=this.wheelInfos;var i=n.length;for(var a=0;a<i;a++){var o=n[a];if(o.isInContact){var s;var l=o.suspensionRestLength;var u=o.suspensionLength;var h=l-u;s=o.suspensionStiffness*h*o.clippedInvContactDotSuspension;var c=o.suspensionRelativeVelocity;var f;if(c<0){f=o.dampingCompression}else{f=o.dampingRelaxation}s-=f*c;o.suspensionForce=s*r;if(o.suspensionForce<0){o.suspensionForce=0}}else{o.suspensionForce=0}}};u.prototype.removeFromWorld=function(e){var t=this.constraints;e.remove(this.chassisBody);e.removeEventListener("preStep",this.preStepCallback);this.world=null};var g=new i;var y=new i;u.prototype.castRay=function(e){var t=g;var r=y;this.updateWheelTransformWorld(e);var n=this.chassisBody;var a=-1;var o=e.suspensionRestLength+e.radius;e.directionWorld.scale(o,t);var s=e.chassisConnectionPointWorld;s.vadd(t,r);var l=e.raycastResult;l.reset();var u=n.collisionResponse;n.collisionResponse=false;this.world.rayTest(s,r,l);n.collisionResponse=u;var h=l.body;e.raycastResult.groundObject=0;if(h){a=l.distance;e.raycastResult.hitNormalWorld=l.hitNormalWorld;e.isInContact=true;var c=l.distance;e.suspensionLength=c-e.radius;var f=e.suspensionRestLength-e.maxSuspensionTravel;var p=e.suspensionRestLength+e.maxSuspensionTravel;if(e.suspensionLength<f){e.suspensionLength=f}if(e.suspensionLength>p){e.suspensionLength=p;e.raycastResult.reset()}var d=e.raycastResult.hitNormalWorld.dot(e.directionWorld);var v=new i;n.getVelocityAtWorldPoint(e.raycastResult.hitPointWorld,v);var m=e.raycastResult.hitNormalWorld.dot(v);if(d>=-.1){e.suspensionRelativeVelocity=0;e.clippedInvContactDotSuspension=1/.1}else{var _=-1/d;e.suspensionRelativeVelocity=m*_;e.clippedInvContactDotSuspension=_}}else{e.suspensionLength=e.suspensionRestLength+0*e.maxSuspensionTravel;e.suspensionRelativeVelocity=0;e.directionWorld.scale(-1,e.raycastResult.hitNormalWorld);e.clippedInvContactDotSuspension=1}return a};u.prototype.updateWheelTransformWorld=function(e){e.isInContact=false;var t=this.chassisBody;t.pointToWorldFrame(e.chassisConnectionPointLocal,e.chassisConnectionPointWorld);t.vectorToWorldFrame(e.directionLocal,e.directionWorld);t.vectorToWorldFrame(e.axleLocal,e.axleWorld)};u.prototype.updateWheelTransform=function(e){var t=p;var r=d;var n=v;var i=this.wheelInfos[e];this.updateWheelTransformWorld(i);i.directionLocal.scale(-1,t);r.copy(i.axleLocal);t.cross(r,n);n.normalize();r.normalize();var o=i.steering;var s=new a;s.setFromAxisAngle(t,o);var l=new a;l.setFromAxisAngle(r,i.rotation);var u=i.worldTransform.quaternion;this.chassisBody.quaternion.mult(s,u);u.mult(l,u);u.normalize();var h=i.worldTransform.position;h.copy(i.directionWorld);h.scale(i.suspensionLength,h);h.vadd(i.chassisConnectionPointWorld,h)};var x=[new i(1,0,0),new i(0,1,0),new i(0,0,1)];u.prototype.getWheelTransformWorld=function(e){return this.wheelInfos[e].worldTransform};var b=new i;var w=[];var T=[];var E=1;u.prototype.updateFriction=function(e){var t=this;var r=b;var n=this.wheelInfos;var a=n.length;var o=this.chassisBody;var s=T;var l=w;for(var u=0;u<a;u++){var h=n[u];var c=h.raycastResult.body;h.sideImpulse=0;h.forwardImpulse=0;if(!s[u]){s[u]=new i}if(!l[u]){l[u]=new i}}for(var u=0;u<a;u++){var h=n[u];var c=h.raycastResult.body;if(c){var f=l[u];var p=t.getWheelTransformWorld(u);p.vectorToWorldFrame(x[t.indexRightAxis],f);var d=h.raycastResult.hitNormalWorld;var v=f.dot(d);d.scale(v,r);f.vsub(r,f);f.normalize();d.cross(f,s[u]);s[u].normalize();h.sideImpulse=F(o,h.raycastResult.hitPointWorld,c,h.raycastResult.hitPointWorld,f);h.sideImpulse*=E}}var m=1;var _=.5;this.sliding=false;for(var u=0;u<a;u++){var h=n[u];var c=h.raycastResult.body;var g=0;h.slipInfo=1;if(c){var y=0;var S=h.brake?h.brake:y;g=R(o,c,h.raycastResult.hitPointWorld,s[u],S);g+=h.engineForce*e;var M=S/g;h.slipInfo*=M}h.forwardImpulse=0;h.skidInfo=1;if(c){h.skidInfo=1;var A=h.suspensionForce*e*h.frictionSlip;var L=A;var C=A*L;h.forwardImpulse=g;var I=h.forwardImpulse*_;var U=h.sideImpulse*m;var D=I*I+U*U;h.sliding=false;if(D>C){t.sliding=true;h.sliding=true;var M=A/Math.sqrt(D);h.skidInfo*=M}}}if(this.sliding){for(var u=0;u<a;u++){var h=n[u];if(h.sideImpulse!==0){if(h.skidInfo<1){h.forwardImpulse*=h.skidInfo;h.sideImpulse*=h.skidInfo}}}}for(var u=0;u<a;u++){var h=n[u];var O=new i;O.copy(h.raycastResult.hitPointWorld);if(h.forwardImpulse!==0){var B=new i;s[u].scale(h.forwardImpulse,B);o.applyImpulse(B,O)}if(h.sideImpulse!==0){var c=h.raycastResult.body;var P=new i;P.copy(h.raycastResult.hitPointWorld);var z=new i;l[u].scale(h.sideImpulse,z);o.pointToLocalFrame(O,O);O["xyz"[t.indexUpAxis]]*=h.rollInfluence;o.pointToWorldFrame(O,O);o.applyImpulse(z,O);z.scale(-1,z);c.applyImpulse(z,P)}}};var S=new i;var M=new i;var A=new i;function R(e,t,r,n,i){var a=0;var o=r;var s=S;var l=M;var u=A;e.getVelocityAtWorldPoint(o,s);t.getVelocityAtWorldPoint(o,l);s.vsub(l,u);var h=n.dot(u);var c=D(e,r,n);var f=D(t,r,n);var p=1;var d=p/(c+f);a=-h*d;if(i<a){a=i}if(a<-i){a=-i}return a}var L=new i;var C=new i;var I=new i;var U=new i;function D(e,t,r){var n=L;var i=C;var a=I;var o=U;t.vsub(e.position,n);n.cross(r,i);e.invInertiaWorld.vmult(i,o);o.cross(n,a);return e.invMass+r.dot(a)}var O=new i;var B=new i;var P=new i;function F(e,t,r,n,i,a){var o=i.norm2();if(o>1.1){return 0}var s=O;var l=B;var u=P;e.getVelocityAtWorldPoint(t,s);r.getVelocityAtWorldPoint(n,l);s.vsub(l,u);var h=i.dot(u);var c=.2;var f=1/(e.invMass+r.invMass);var a=-c*h*f;return a}},{"../collision/Ray":9,"../collision/RaycastResult":10,"../math/Quaternion":28,"../math/Vec3":30,"../objects/WheelInfo":36,"./Body":31}],33:[function(e,t,r){var n=e("./Body");var i=e("../shapes/Sphere");var a=e("../shapes/Box");var o=e("../math/Vec3");var s=e("../constraints/HingeConstraint");t.exports=l;function l(e){this.wheelBodies=[];this.coordinateSystem=typeof e.coordinateSystem==="undefined"?new o(1,2,3):e.coordinateSystem.clone();this.chassisBody=e.chassisBody;if(!this.chassisBody){var t=new a(new o(5,2,.5));this.chassisBody=new n(1,t)}this.constraints=[];this.wheelAxes=[];this.wheelForces=[]}l.prototype.addWheel=function(e){e=e||{};var t=e.body;if(!t){t=new n(1,new i(1.2))}this.wheelBodies.push(t);this.wheelForces.push(0);var r=new o;var a=typeof e.position!=="undefined"?e.position.clone():new o;var l=new o;this.chassisBody.pointToWorldFrame(a,l);t.position.set(l.x,l.y,l.z);var u=typeof e.axis!=="undefined"?e.axis.clone():new o(0,1,0);this.wheelAxes.push(u);var h=new s(this.chassisBody,t,{pivotA:a,axisA:u,pivotB:o.ZERO,axisB:u,collideConnected:false});this.constraints.push(h);return this.wheelBodies.length-1};l.prototype.setSteeringValue=function(e,t){var r=this.wheelAxes[t];var n=Math.cos(e),i=Math.sin(e),a=r.x,o=r.y;this.constraints[t].axisA.set(n*a-i*o,i*a+n*o,0)};l.prototype.setMotorSpeed=function(e,t){var r=this.constraints[t];r.enableMotor();r.motorTargetVelocity=e};l.prototype.disableMotor=function(e){var t=this.constraints[e];t.disableMotor()};var u=new o;l.prototype.setWheelForce=function(e,t){this.wheelForces[t]=e};l.prototype.applyWheelForce=function(e,t){var r=this.wheelAxes[t];var n=this.wheelBodies[t];var i=n.torque;r.scale(e,u);n.vectorToWorldFrame(u,u);i.vadd(u,i)};l.prototype.addToWorld=function(e){var t=this.constraints;var r=this.wheelBodies.concat([this.chassisBody]);for(var n=0;n<r.length;n++){e.add(r[n])}for(var n=0;n<t.length;n++){e.addConstraint(t[n])}e.addEventListener("preStep",this._update.bind(this))};l.prototype._update=function(){var e=this;var t=this.wheelForces;for(var r=0;r<t.length;r++){e.applyWheelForce(t[r],r)}};l.prototype.removeFromWorld=function(e){var t=this.constraints;var r=this.wheelBodies.concat([this.chassisBody]);for(var n=0;n<r.length;n++){e.remove(r[n])}for(var n=0;n<t.length;n++){e.removeConstraint(t[n])}};var h=new o;l.prototype.getWheelSpeed=function(e){var t=this.wheelAxes[e];var r=this.wheelBodies[e];var n=r.angularVelocity;this.chassisBody.vectorToWorldFrame(t,h);return n.dot(h)}},{"../constraints/HingeConstraint":15,"../math/Vec3":30,"../shapes/Box":37,"../shapes/Sphere":44,"./Body":31}],34:[function(e,t,r){t.exports=u;var n=e("../shapes/Shape");var i=e("../math/Vec3");var a=e("../math/Quaternion");var o=e("../shapes/Particle");var s=e("../objects/Body");var l=e("../material/Material");function u(){this.particles=[];this.density=1;this.smoothingRadius=1;this.speedOfSound=1;this.viscosity=.01;this.eps=1e-6;this.pressures=[];this.densities=[];this.neighbors=[]}u.prototype.add=function(e){this.particles.push(e);if(this.neighbors.length<this.particles.length){this.neighbors.push([])}};u.prototype.remove=function(e){var t=this.particles.indexOf(e);if(t!==-1){this.particles.splice(t,1);if(this.neighbors.length>this.particles.length){this.neighbors.pop()}}};var h=new i;u.prototype.getNeighbors=function(e,t){var r=this;var n=this.particles.length,i=e.id,a=this.smoothingRadius*this.smoothingRadius,o=h;for(var s=0;s!==n;s++){var l=r.particles[s];l.position.vsub(e.position,o);if(i!==l.id&&o.norm2()<a){t.push(l)}}};var c=new i,f=new i,p=new i,d=new i,v=new i,m=new i;u.prototype.update=function(){var e=this;var t=this.particles.length,r=c,n=this.speedOfSound,i=this.eps;for(var a=0;a!==t;a++){var o=e.particles[a];var s=e.neighbors[a];s.length=0;e.getNeighbors(o,s);s.push(e.particles[a]);var l=s.length;var u=0;for(var h=0;h!==l;h++){o.position.vsub(s[h].position,r);var _=r.norm();var g=e.w(_);u+=s[h].mass*g}e.densities[a]=u;e.pressures[a]=n*n*(e.densities[a]-e.density)}var y=f;var x=p;var b=d;var w=v;var T=m;for(var a=0;a!==t;a++){var E=e.particles[a];y.set(0,0,0);x.set(0,0,0);var S;var M;var s=e.neighbors[a];var l=s.length;for(var h=0;h!==l;h++){var A=s[h];E.position.vsub(A.position,w);var R=w.norm();S=-A.mass*(e.pressures[a]/(e.densities[a]*e.densities[a]+i)+e.pressures[h]/(e.densities[h]*e.densities[h]+i));e.gradw(w,b);b.mult(S,b);y.vadd(b,y);A.velocity.vsub(E.velocity,T);T.mult(1/(1e-4+e.densities[a]*e.densities[h])*e.viscosity*A.mass,T);M=e.nablaw(R);T.mult(M,T);x.vadd(T,x)}x.mult(E.mass,x);y.mult(E.mass,y);E.force.vadd(x,E.force);E.force.vadd(y,E.force)}};u.prototype.w=function(e){var t=this.smoothingRadius;return 315/(64*Math.PI*Math.pow(t,9))*Math.pow(t*t-e*e,3)};u.prototype.gradw=function(e,t){var r=e.norm(),n=this.smoothingRadius;e.mult(945/(32*Math.PI*Math.pow(n,9))*Math.pow(n*n-r*r,2),t)};u.prototype.nablaw=function(e){var t=this.smoothingRadius;var r=945/(32*Math.PI*Math.pow(t,9))*(t*t-e*e)*(7*e*e-3*t*t);return r}},{"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Particle":41,"../shapes/Shape":43}],35:[function(e,t,r){var n=e("../math/Vec3");t.exports=i;function i(e,t,r){r=r||{};this.restLength=typeof r.restLength==="number"?r.restLength:1;this.stiffness=r.stiffness||100;this.damping=r.damping||1;this.bodyA=e;this.bodyB=t;this.localAnchorA=new n;this.localAnchorB=new n;if(r.localAnchorA){this.localAnchorA.copy(r.localAnchorA)}if(r.localAnchorB){this.localAnchorB.copy(r.localAnchorB)}if(r.worldAnchorA){this.setWorldAnchorA(r.worldAnchorA)}if(r.worldAnchorB){this.setWorldAnchorB(r.worldAnchorB)}}i.prototype.setWorldAnchorA=function(e){this.bodyA.pointToLocalFrame(e,this.localAnchorA)};i.prototype.setWorldAnchorB=function(e){this.bodyB.pointToLocalFrame(e,this.localAnchorB)};i.prototype.getWorldAnchorA=function(e){this.bodyA.pointToWorldFrame(this.localAnchorA,e)};i.prototype.getWorldAnchorB=function(e){this.bodyB.pointToWorldFrame(this.localAnchorB,e)};var a=new n,o=new n,s=new n,l=new n,u=new n,h=new n,c=new n,f=new n,p=new n,d=new n,v=new n;i.prototype.applyForce=function(){var e=this.stiffness,t=this.damping,r=this.restLength,n=this.bodyA,i=this.bodyB,m=a,_=o,g=s,y=l,x=v;var b=u,w=h,T=c,E=f,S=p,M=d;this.getWorldAnchorA(b);this.getWorldAnchorB(w);b.vsub(n.position,T);w.vsub(i.position,E);w.vsub(b,m);var A=m.norm();_.copy(m);_.normalize();i.velocity.vsub(n.velocity,g);i.angularVelocity.cross(E,x);g.vadd(x,g);n.angularVelocity.cross(T,x);g.vsub(x,g);_.mult(-e*(A-r)-t*g.dot(_),y);n.force.vsub(y,n.force);i.force.vadd(y,i.force);T.cross(y,S);E.cross(y,M);n.torque.vsub(S,n.torque);i.torque.vadd(M,i.torque)}},{"../math/Vec3":30}],36:[function(e,t,r){var n=e("../math/Vec3");var i=e("../math/Transform");var a=e("../collision/RaycastResult");var o=e("../utils/Utils");t.exports=s;function s(e){e=o.defaults(e,{chassisConnectionPointLocal:new n,chassisConnectionPointWorld:new n,directionLocal:new n,directionWorld:new n,axleLocal:new n,axleWorld:new n,suspensionRestLength:1,suspensionMaxLength:2,radius:1,suspensionStiffness:100,dampingCompression:10,dampingRelaxation:10,frictionSlip:1e4,steering:0,rotation:0,deltaRotation:0,rollInfluence:.01,maxSuspensionForce:Number.MAX_VALUE,isFrontWheel:true,clippedInvContactDotSuspension:1,suspensionRelativeVelocity:0,suspensionForce:0,skidInfo:0,suspensionLength:0,maxSuspensionTravel:1,useCustomSlidingRotationalSpeed:false,customSlidingRotationalSpeed:-.1});this.maxSuspensionTravel=e.maxSuspensionTravel;this.customSlidingRotationalSpeed=e.customSlidingRotationalSpeed;this.useCustomSlidingRotationalSpeed=e.useCustomSlidingRotationalSpeed;this.sliding=false;this.chassisConnectionPointLocal=e.chassisConnectionPointLocal.clone();this.chassisConnectionPointWorld=e.chassisConnectionPointWorld.clone();this.directionLocal=e.directionLocal.clone();this.directionWorld=e.directionWorld.clone();this.axleLocal=e.axleLocal.clone();this.axleWorld=e.axleWorld.clone();this.suspensionRestLength=e.suspensionRestLength;this.suspensionMaxLength=e.suspensionMaxLength;this.radius=e.radius;this.suspensionStiffness=e.suspensionStiffness;this.dampingCompression=e.dampingCompression;this.dampingRelaxation=e.dampingRelaxation;this.frictionSlip=e.frictionSlip;this.steering=0;this.rotation=0;this.deltaRotation=0;this.rollInfluence=e.rollInfluence;this.maxSuspensionForce=e.maxSuspensionForce;this.engineForce=0;this.brake=0;this.isFrontWheel=e.isFrontWheel;this.clippedInvContactDotSuspension=1;this.suspensionRelativeVelocity=0;this.suspensionForce=0;this.skidInfo=0;this.suspensionLength=0;this.sideImpulse=0;this.forwardImpulse=0;this.raycastResult=new a;this.worldTransform=new i;this.isInContact=false}var l=new n;var u=new n;var l=new n;s.prototype.updateWheel=function(e){var t=this.raycastResult;if(this.isInContact){var r=t.hitNormalWorld.dot(t.directionWorld);t.hitPointWorld.vsub(e.position,u);e.getVelocityAtWorldPoint(u,l);var n=t.hitNormalWorld.dot(l);if(r>=-.1){this.suspensionRelativeVelocity=0;this.clippedInvContactDotSuspension=1/.1}else{var i=-1/r;this.suspensionRelativeVelocity=n*i;this.clippedInvContactDotSuspension=i}}else{t.suspensionLength=this.suspensionRestLength;this.suspensionRelativeVelocity=0;t.directionWorld.scale(-1,t.hitNormalWorld);this.clippedInvContactDotSuspension=1}}},{"../collision/RaycastResult":10,"../math/Transform":29,"../math/Vec3":30,"../utils/Utils":53}],37:[function(e,t,r){t.exports=o;var n=e("./Shape");var i=e("../math/Vec3");var a=e("./ConvexPolyhedron");function o(e){n.call(this);this.type=n.types.BOX;this.halfExtents=e;this.convexPolyhedronRepresentation=null;this.updateConvexPolyhedronRepresentation();this.updateBoundingSphereRadius()}o.prototype=new n;o.prototype.constructor=o;o.prototype.updateConvexPolyhedronRepresentation=function(){var e=this.halfExtents.x;var t=this.halfExtents.y;var r=this.halfExtents.z;var n=i;var o=[new n(-e,-t,-r),new n(e,-t,-r),new n(e,t,-r),new n(-e,t,-r),new n(-e,-t,r),new n(e,-t,r),new n(e,t,r),new n(-e,t,r)];var s=[[3,2,1,0],[4,5,6,7],[5,4,0,1],[2,3,7,6],[0,4,7,3],[1,2,6,5]];var l=[new n(0,0,1),new n(0,1,0),new n(1,0,0)];var u=new a(o,s);this.convexPolyhedronRepresentation=u;u.material=this.material};o.prototype.calculateLocalInertia=function(e,t){t=t||new i;o.calculateInertia(this.halfExtents,e,t);return t};o.calculateInertia=function(e,t,r){var n=e;r.x=1/12*t*(2*n.y*2*n.y+2*n.z*2*n.z);r.y=1/12*t*(2*n.x*2*n.x+2*n.z*2*n.z);r.z=1/12*t*(2*n.y*2*n.y+2*n.x*2*n.x)};o.prototype.getSideNormals=function(e,t){var r=e;var n=this.halfExtents;r[0].set(n.x,0,0);r[1].set(0,n.y,0);r[2].set(0,0,n.z);r[3].set(-n.x,0,0);r[4].set(0,-n.y,0);r[5].set(0,0,-n.z);if(t!==undefined){for(var i=0;i!==r.length;i++){t.vmult(r[i],r[i])}}return r};o.prototype.volume=function(){return 8*this.halfExtents.x*this.halfExtents.y*this.halfExtents.z};o.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.halfExtents.norm()};var s=new i;var l=new i;o.prototype.forEachWorldCorner=function(e,t,r){var n=this.halfExtents;var i=[[n.x,n.y,n.z],[-n.x,n.y,n.z],[-n.x,-n.y,n.z],[-n.x,-n.y,-n.z],[n.x,-n.y,-n.z],[n.x,n.y,-n.z],[-n.x,n.y,-n.z],[n.x,-n.y,n.z]];for(var a=0;a<i.length;a++){s.set(i[a][0],i[a][1],i[a][2]);t.vmult(s,s);e.vadd(s,s);r(s.x,s.y,s.z)}};var u=[new i,new i,new i,new i,new i,new i,new i,new i];o.prototype.calculateWorldAABB=function(e,t,r,n){var i=this.halfExtents;u[0].set(i.x,i.y,i.z);u[1].set(-i.x,i.y,i.z);u[2].set(-i.x,-i.y,i.z);u[3].set(-i.x,-i.y,-i.z);u[4].set(i.x,-i.y,-i.z);u[5].set(i.x,i.y,-i.z);u[6].set(-i.x,i.y,-i.z);u[7].set(i.x,-i.y,i.z);var a=u[0];t.vmult(a,a);e.vadd(a,a);n.copy(a);r.copy(a);for(var o=1;o<8;o++){var a=u[o];t.vmult(a,a);e.vadd(a,a);var s=a.x;var l=a.y;var h=a.z;if(s>n.x){n.x=s}if(l>n.y){n.y=l}if(h>n.z){n.z=h}if(s<r.x){r.x=s}if(l<r.y){r.y=l}if(h<r.z){r.z=h}}}},{"../math/Vec3":30,"./ConvexPolyhedron":38,"./Shape":43}],38:[function(e,t,r){t.exports=s;var n=e("./Shape");var i=e("../math/Vec3");var a=e("../math/Quaternion");var o=e("../math/Transform");function s(e,t,r){n.call(this);this.type=n.types.CONVEXPOLYHEDRON;this.vertices=e||[];this.worldVertices=[];this.worldVerticesNeedsUpdate=true;this.faces=t||[];this.faceNormals=[];this.computeNormals();this.worldFaceNormalsNeedsUpdate=true;this.worldFaceNormals=[];this.uniqueEdges=[];this.uniqueAxes=r?r.slice():null;this.computeEdges();this.updateBoundingSphereRadius()}s.prototype=new n;s.prototype.constructor=s;var l=new i;s.prototype.computeEdges=function(){var e=this.faces;var t=this.vertices;var r=t.length;var n=this.uniqueEdges;n.length=0;var i=l;for(var a=0;a!==e.length;a++){var o=e[a];var s=o.length;for(var u=0;u!==s;u++){var h=(u+1)%s;t[o[u]].vsub(t[o[h]],i);i.normalize();var c=false;for(var f=0;f!==n.length;f++){if(n[f].almostEquals(i)||n[f].almostEquals(i)){c=true;break}}if(!c){n.push(i.clone())}}}};s.prototype.computeNormals=function(){var e=this;this.faceNormals.length=this.faces.length;for(var t=0;t<this.faces.length;t++){for(var r=0;r<this.faces[t].length;r++){if(!e.vertices[e.faces[t][r]]){throw new Error("Vertex "+e.faces[t][r]+" not found!")}}var n=e.faceNormals[t]||new i;e.getFaceNormal(t,n);n.negate(n);e.faceNormals[t]=n;var a=e.vertices[e.faces[t][0]];if(n.dot(a)<0){console.error(".faceNormals["+t+"] = Vec3("+n.toString()+") looks like it points into the shape? The vertices follow. Make sure they are ordered CCW around the normal, using the right hand rule.");for(var r=0;r<this.faces[t].length;r++){console.warn(".vertices["+e.faces[t][r]+"] = Vec3("+e.vertices[e.faces[t][r]].toString()+")")}}}};var u=new i;var h=new i;s.computeNormal=function(e,t,r,n){t.vsub(e,h);r.vsub(t,u);u.cross(h,n);if(!n.isZero()){n.normalize()}};s.prototype.getFaceNormal=function(e,t){var r=this.faces[e];var n=this.vertices[r[0]];var i=this.vertices[r[1]];var a=this.vertices[r[2]];return s.computeNormal(n,i,a,t)};var c=new i;s.prototype.clipAgainstHull=function(e,t,r,n,a,o,s,l,u){var h=c;var f=-1;var p=-Number.MAX_VALUE;for(var d=0;d<r.faces.length;d++){h.copy(r.faceNormals[d]);a.vmult(h,h);var v=h.dot(o);if(v>p){p=v;f=d}}var m=[];var _=r.faces[f];var g=_.length;for(var y=0;y<g;y++){var x=r.vertices[_[y]];var b=new i;b.copy(x);a.vmult(b,b);n.vadd(b,b);m.push(b)}if(f>=0){this.clipFaceAgainstHull(o,e,t,m,s,l,u)}};var f=new i,p=new i,d=new i,v=new i,m=new i,_=new i;s.prototype.findSeparatingAxis=function(e,t,r,n,i,a,o,s){var l=f,u=p,h=d,c=v,g=m,y=_;var x=Number.MAX_VALUE;var b=this;if(!b.uniqueAxes){var w=o?o.length:b.faces.length;for(var T=0;T<w;T++){var E=o?o[T]:T;l.copy(b.faceNormals[E]);r.vmult(l,l);var S=b.testSepAxis(l,e,t,r,n,i);if(S===false){return false}if(S<x){x=S;a.copy(l)}}}else{for(var T=0;T!==b.uniqueAxes.length;T++){r.vmult(b.uniqueAxes[T],l);var S=b.testSepAxis(l,e,t,r,n,i);if(S===false){return false}if(S<x){x=S;a.copy(l)}}}if(!e.uniqueAxes){var M=s?s.length:e.faces.length;for(var T=0;T<M;T++){var E=s?s[T]:T;u.copy(e.faceNormals[E]);i.vmult(u,u);var S=b.testSepAxis(u,e,t,r,n,i);if(S===false){return false}if(S<x){x=S;a.copy(u)}}}else{for(var T=0;T!==e.uniqueAxes.length;T++){i.vmult(e.uniqueAxes[T],u);var S=b.testSepAxis(u,e,t,r,n,i);if(S===false){return false}if(S<x){x=S;a.copy(u)}}}for(var A=0;A!==b.uniqueEdges.length;A++){r.vmult(b.uniqueEdges[A],c);for(var R=0;R!==e.uniqueEdges.length;R++){i.vmult(e.uniqueEdges[R],g);c.cross(g,y);if(!y.almostZero()){y.normalize();var L=b.testSepAxis(y,e,t,r,n,i);if(L===false){return false}if(L<x){x=L;a.copy(y)}}}}n.vsub(t,h);if(h.dot(a)>0){a.negate(a)}return true};var g=[],y=[];s.prototype.testSepAxis=function(e,t,r,n,i,a){var o=this;s.project(o,e,r,n,g);s.project(t,e,i,a,y);var l=g[0];var u=g[1];var h=y[0];var c=y[1];if(l<c||h<u){return false}var f=l-c;var p=h-u;var d=f<p?f:p;return d};var x=new i,b=new i;s.prototype.calculateLocalInertia=function(e,t){this.computeLocalAABB(x,b);var r=b.x-x.x,n=b.y-x.y,i=b.z-x.z;t.x=1/12*e*(2*n*2*n+2*i*2*i);t.y=1/12*e*(2*r*2*r+2*i*2*i);t.z=1/12*e*(2*n*2*n+2*r*2*r)};s.prototype.getPlaneConstantOfFace=function(e){var t=this.faces[e];var r=this.faceNormals[e];var n=this.vertices[t[0]];var i=-r.dot(n);return i};var w=new i,T=new i,E=new i,S=new i,M=new i,A=new i,R=new i,L=new i;s.prototype.clipFaceAgainstHull=function(e,t,r,n,i,a,o){var s=this;var l=w,u=T,h=E,c=S,f=M,p=A,d=R,v=L;var m=this;var _=[];var g=n;var y=_;var x=-1;var b=Number.MAX_VALUE;for(var C=0;C<m.faces.length;C++){l.copy(m.faceNormals[C]);r.vmult(l,l);var I=l.dot(e);if(I<b){b=I;x=C}}if(x<0){return}var U=m.faces[x];U.connectedFaces=[];for(var D=0;D<m.faces.length;D++){for(var O=0;O<m.faces[D].length;O++){if(U.indexOf(m.faces[D][O])!==-1&&D!==x&&U.connectedFaces.indexOf(D)===-1){U.connectedFaces.push(D)}}}var B=g.length;var P=U.length;for(var F=0;F<P;F++){var z=m.vertices[U[F]];var N=m.vertices[U[(F+1)%P]];z.vsub(N,u);h.copy(u);r.vmult(h,h);t.vadd(h,h);c.copy(s.faceNormals[x]);r.vmult(c,c);t.vadd(c,c);h.cross(c,f);f.negate(f);p.copy(z);r.vmult(p,p);t.vadd(p,p);var k=-p.dot(f);var V;{var G=U.connectedFaces[F];d.copy(s.faceNormals[G]);var W=s.getPlaneConstantOfFace(G);v.copy(d);r.vmult(v,v);var V=W-v.dot(t)}s.clipFaceAgainstPlane(g,y,v,V);while(g.length){g.shift()}while(y.length){g.push(y.shift())}}d.copy(this.faceNormals[x]);var W=this.getPlaneConstantOfFace(x);v.copy(d);r.vmult(v,v);var V=W-v.dot(t);for(var D=0;D<g.length;D++){var H=v.dot(g[D])+V;if(H<=i){console.log("clamped: depth="+H+" to minDist="+(i+""));H=i}if(H<=a){var j=g[D];if(H<=0){var q={point:j,normal:v,depth:H};o.push(q)}}}};s.prototype.clipFaceAgainstPlane=function(e,t,r,n){var a,o;var s=e.length;if(s<2){return t}var l=e[e.length-1],u=e[0];a=r.dot(l)+n;for(var h=0;h<s;h++){u=e[h];o=r.dot(u)+n;if(a<0){if(o<0){var c=new i;c.copy(u);t.push(c)}else{var c=new i;l.lerp(u,a/(a-o),c);t.push(c)}}else{if(o<0){var c=new i;l.lerp(u,a/(a-o),c);t.push(c);t.push(u)}}l=u;a=o}return t};s.prototype.computeWorldVertices=function(e,t){var r=this;var n=this.vertices.length;while(this.worldVertices.length<n){r.worldVertices.push(new i)}var a=this.vertices,o=this.worldVertices;for(var s=0;s!==n;s++){t.vmult(a[s],o[s]);e.vadd(o[s],o[s])}this.worldVerticesNeedsUpdate=false};var C=new i;s.prototype.computeLocalAABB=function(e,t){var r=this.vertices.length,n=this.vertices;e.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE);t.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(var i=0;i<r;i++){var a=n[i];if(a.x<e.x){e.x=a.x}else if(a.x>t.x){t.x=a.x}if(a.y<e.y){e.y=a.y}else if(a.y>t.y){t.y=a.y}if(a.z<e.z){e.z=a.z}else if(a.z>t.z){t.z=a.z}}};s.prototype.computeWorldFaceNormals=function(e){var t=this;var r=this.faceNormals.length;while(this.worldFaceNormals.length<r){t.worldFaceNormals.push(new i)}var n=this.faceNormals,a=this.worldFaceNormals;for(var o=0;o!==r;o++){e.vmult(n[o],a[o])}this.worldFaceNormalsNeedsUpdate=false};s.prototype.updateBoundingSphereRadius=function(){var e=0;var t=this.vertices;for(var r=0,n=t.length;r!==n;r++){var i=t[r].norm2();if(i>e){e=i}}this.boundingSphereRadius=Math.sqrt(e)};var I=new i;s.prototype.calculateWorldAABB=function(e,t,r,n){var i=this.vertices.length,a=this.vertices;var o,s,l,u,h,c;for(var f=0;f<i;f++){I.copy(a[f]);t.vmult(I,I);e.vadd(I,I);var p=I;if(p.x<o||o===undefined){o=p.x}else if(p.x>u||u===undefined){u=p.x}if(p.y<s||s===undefined){s=p.y}else if(p.y>h||h===undefined){h=p.y}if(p.z<l||l===undefined){l=p.z}else if(p.z>c||c===undefined){c=p.z}}r.set(o,s,l);n.set(u,h,c)};s.prototype.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3};s.prototype.getAveragePointLocal=function(e){e=e||new i;var t=this.vertices.length,r=this.vertices;for(var n=0;n<t;n++){e.vadd(r[n],e)}e.mult(1/t,e);return e};s.prototype.transformAllPoints=function(e,t){var r=this;var n=this.vertices.length,i=this.vertices;if(t){for(var a=0;a<n;a++){var o=i[a];t.vmult(o,o)}for(var a=0;a<this.faceNormals.length;a++){var o=r.faceNormals[a];t.vmult(o,o)}}if(e){for(var a=0;a<n;a++){var o=i[a];o.vadd(e,o)}}};var U=new i;var D=new i;var O=new i;s.prototype.pointIsInside=function(e){var t=this;var r=this.vertices.length,n=this.vertices,i=this.faces,a=this.faceNormals;var o=null;var s=this.faces.length;var l=U;this.getAveragePointLocal(l);for(var u=0;u<s;u++){var h=t.faces[u].length;var r=a[u];var c=n[i[u][0]];var f=D;e.vsub(c,f);var p=r.dot(f);var d=O;l.vsub(c,d);var v=r.dot(d);if(p<0&&v>0||p>0&&v<0){return false}else{}}return o?1:-1};var B=new i;var P=new i;var F=new i;s.project=function(e,t,r,n,i){var a=e.vertices.length,s=B,l=P,u=0,h=0,c=F,f=e.vertices;c.setZero();o.vectorToLocalFrame(r,n,t,l);o.pointToLocalFrame(r,n,c,c);var p=c.dot(l);h=u=f[0].dot(l);for(var d=1;d<a;d++){var v=f[d].dot(l);if(v>u){u=v}if(v<h){h=v}}h-=p;u-=p;if(h>u){var m=h;h=u;u=m}i[0]=u;i[1]=h}},{"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"./Shape":43}],39:[function(e,t,r){t.exports=s;var n=e("./Shape");var i=e("../math/Vec3");var a=e("../math/Quaternion");var o=e("./ConvexPolyhedron");function s(e,t,r,a){var s=a,l=[],u=[],h=[],c=[],f=[],p=Math.cos,d=Math.sin;l.push(new i(t*p(0),t*d(0),-r*.5));c.push(0);l.push(new i(e*p(0),e*d(0),r*.5));f.push(1);for(var v=0;v<s;v++){var m=2*Math.PI/s*(v+1);var _=2*Math.PI/s*(v+.5);if(v<s-1){l.push(new i(t*p(m),t*d(m),-r*.5));c.push(2*v+2);l.push(new i(e*p(m),e*d(m),r*.5));f.push(2*v+3);h.push([2*v+2,2*v+3,2*v+1,2*v])}else{h.push([0,1,2*v+1,2*v])}if(s%2===1||v<s/2){u.push(new i(p(_),d(_),0))}}h.push(f);u.push(new i(0,0,1));var g=[];for(var v=0;v<c.length;v++){g.push(c[c.length-v-1])}h.push(g);this.type=n.types.CONVEXPOLYHEDRON;o.call(this,l,h,u)}s.prototype=new o},{"../math/Quaternion":28,"../math/Vec3":30,"./ConvexPolyhedron":38,"./Shape":43}],40:[function(e,t,r){var n=e("./Shape");var i=e("./ConvexPolyhedron");var a=e("../math/Vec3");var o=e("../utils/Utils");t.exports=s;function s(e,t){t=o.defaults(t,{maxValue:null,minValue:null,elementSize:1});this.data=e;this.maxValue=t.maxValue;this.minValue=t.minValue;this.elementSize=t.elementSize;if(t.minValue===null){this.updateMinValue()}if(t.maxValue===null){this.updateMaxValue()}this.cacheEnabled=true;n.call(this);this.pillarConvex=new i;this.pillarOffset=new a;this.type=n.types.HEIGHTFIELD;this.updateBoundingSphereRadius();this._cachedPillars={}}s.prototype=new n;s.prototype.update=function(){this._cachedPillars={}};s.prototype.updateMinValue=function(){var e=this.data;var t=e[0][0];for(var r=0;r!==e.length;r++){for(var n=0;n!==e[r].length;n++){var i=e[r][n];if(i<t){t=i}}}this.minValue=t};s.prototype.updateMaxValue=function(){var e=this.data;var t=e[0][0];for(var r=0;r!==e.length;r++){for(var n=0;n!==e[r].length;n++){var i=e[r][n];if(i>t){t=i}}}this.maxValue=t};s.prototype.setHeightValueAtIndex=function(e,t,r){var n=this.data;n[e][t]=r;this.clearCachedConvexTrianglePillar(e,t,false);if(e>0){this.clearCachedConvexTrianglePillar(e-1,t,true);this.clearCachedConvexTrianglePillar(e-1,t,false)}if(t>0){this.clearCachedConvexTrianglePillar(e,t-1,true);this.clearCachedConvexTrianglePillar(e,t-1,false)}if(t>0&&e>0){this.clearCachedConvexTrianglePillar(e-1,t-1,true)}};s.prototype.getRectMinMax=function(e,t,r,n,i){i=i||[];var a=this.data,o=this.minValue;for(var s=e;s<=r;s++){for(var l=t;l<=n;l++){var u=a[s][l];if(u>o){o=u}}}i[0]=this.minValue;i[1]=o};s.prototype.getIndexOfPosition=function(e,t,r,n){var i=this.elementSize;var a=this.data;var o=Math.floor(e/i);var s=Math.floor(t/i);r[0]=o;r[1]=s;if(n){if(o<0){o=0}if(s<0){s=0}if(o>=a.length-1){o=a.length-1}if(s>=a[0].length-1){s=a[0].length-1}}if(o<0||s<0||o>=a.length-1||s>=a[0].length-1){return false}return true};s.prototype.getHeightAt=function(e,t,r){var n=[];this.getIndexOfPosition(e,t,n,r);var i=[];this.getRectMinMax(n[0],n[1]+1,n[0],n[1]+1,i);return(i[0]+i[1])/2};s.prototype.getCacheConvexTrianglePillarKey=function(e,t,r){return e+"_"+t+"_"+(r?1:0)};s.prototype.getCachedConvexTrianglePillar=function(e,t,r){return this._cachedPillars[this.getCacheConvexTrianglePillarKey(e,t,r)]};s.prototype.setCachedConvexTrianglePillar=function(e,t,r,n,i){this._cachedPillars[this.getCacheConvexTrianglePillarKey(e,t,r)]={convex:n,offset:i}};s.prototype.clearCachedConvexTrianglePillar=function(e,t,r){delete this._cachedPillars[this.getCacheConvexTrianglePillarKey(e,t,r)]};s.prototype.getConvexTrianglePillar=function(e,t,r){var n=this.pillarConvex;var o=this.pillarOffset;if(this.cacheEnabled){var s=this.getCachedConvexTrianglePillar(e,t,r);if(s){this.pillarConvex=s.convex;this.pillarOffset=s.offset;return}n=new i;o=new a;this.pillarConvex=n;this.pillarOffset=o}var s=this.data;var l=this.elementSize;var u=n.faces;n.vertices.length=6;for(var h=0;h<6;h++){if(!n.vertices[h]){n.vertices[h]=new a}}u.length=5;for(var h=0;h<5;h++){if(!u[h]){u[h]=[]}}var c=n.vertices;var f=(Math.min(s[e][t],s[e+1][t],s[e][t+1],s[e+1][t+1])-this.minValue)/2+this.minValue;if(!r){o.set((e+.25)*l,(t+.25)*l,f);c[0].set(-.25*l,-.25*l,s[e][t]-f);c[1].set(.75*l,-.25*l,s[e+1][t]-f);c[2].set(-.25*l,.75*l,s[e][t+1]-f);c[3].set(-.25*l,-.25*l,-f-1);c[4].set(.75*l,-.25*l,-f-1);c[5].set(-.25*l,.75*l,-f-1);u[0][0]=0;u[0][1]=1;u[0][2]=2;u[1][0]=5;u[1][1]=4;u[1][2]=3;u[2][0]=0;u[2][1]=2;u[2][2]=5;u[2][3]=3;u[3][0]=1;u[3][1]=0;u[3][2]=3;u[3][3]=4;u[4][0]=4;u[4][1]=5;u[4][2]=2;u[4][3]=1}else{o.set((e+.75)*l,(t+.75)*l,f);c[0].set(.25*l,.25*l,s[e+1][t+1]-f);c[1].set(-.75*l,.25*l,s[e][t+1]-f);c[2].set(.25*l,-.75*l,s[e+1][t]-f);c[3].set(.25*l,.25*l,-f-1);c[4].set(-.75*l,.25*l,-f-1);c[5].set(.25*l,-.75*l,-f-1);u[0][0]=0;u[0][1]=1;u[0][2]=2;u[1][0]=5;u[1][1]=4;u[1][2]=3;u[2][0]=2;u[2][1]=5;u[2][2]=3;u[2][3]=0;u[3][0]=3;u[3][1]=4;u[3][2]=1;u[3][3]=0;u[4][0]=1;u[4][1]=4;u[4][2]=5;u[4][3]=2}n.computeNormals();n.computeEdges();n.updateBoundingSphereRadius();this.setCachedConvexTrianglePillar(e,t,r,n,o)};s.prototype.calculateLocalInertia=function(e,t){t=t||new a;t.set(0,0,0);return t};s.prototype.volume=function(){return Number.MAX_VALUE};s.prototype.calculateWorldAABB=function(e,t,r,n){r.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);n.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)};s.prototype.updateBoundingSphereRadius=function(){var e=this.data,t=this.elementSize;this.boundingSphereRadius=new a(e.length*t,e[0].length*t,Math.max(Math.abs(this.maxValue),Math.abs(this.minValue))).norm()}},{"../math/Vec3":30,"../utils/Utils":53,"./ConvexPolyhedron":38,"./Shape":43}],41:[function(e,t,r){t.exports=a;var n=e("./Shape");var i=e("../math/Vec3");function a(){n.call(this);this.type=n.types.PARTICLE}a.prototype=new n;a.prototype.constructor=a;a.prototype.calculateLocalInertia=function(e,t){t=t||new i;t.set(0,0,0);return t};a.prototype.volume=function(){return 0};a.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=0};a.prototype.calculateWorldAABB=function(e,t,r,n){r.copy(e);n.copy(e)}},{"../math/Vec3":30,"./Shape":43}],42:[function(e,t,r){t.exports=a;var n=e("./Shape");var i=e("../math/Vec3");function a(){n.call(this);this.type=n.types.PLANE;this.worldNormal=new i;this.worldNormalNeedsUpdate=true;this.boundingSphereRadius=Number.MAX_VALUE}a.prototype=new n;a.prototype.constructor=a;a.prototype.computeWorldNormal=function(e){var t=this.worldNormal;t.set(0,0,1);e.vmult(t,t);this.worldNormalNeedsUpdate=false};a.prototype.calculateLocalInertia=function(e,t){t=t||new i;return t};a.prototype.volume=function(){return Number.MAX_VALUE};var o=new i;a.prototype.calculateWorldAABB=function(e,t,r,n){o.set(0,0,1);t.vmult(o,o);var i=Number.MAX_VALUE;r.set(-i,-i,-i);n.set(i,i,i);if(o.x===1){n.x=e.x}if(o.y===1){n.y=e.y}if(o.z===1){n.z=e.z}if(o.x===-1){r.x=e.x}if(o.y===-1){r.y=e.y}if(o.z===-1){r.z=e.z}};a.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=Number.MAX_VALUE}},{"../math/Vec3":30,"./Shape":43}],43:[function(e,t,r){t.exports=n;var n=e("./Shape");var i=e("../math/Vec3");var a=e("../math/Quaternion");var o=e("../material/Material");function n(){this.id=n.idCounter++;this.type=0;this.boundingSphereRadius=0;this.collisionResponse=true;this.material=null}n.prototype.constructor=n;n.prototype.updateBoundingSphereRadius=function(){throw"computeBoundingSphereRadius() not implemented for shape type "+this.type};n.prototype.volume=function(){throw"volume() not implemented for shape type "+this.type};n.prototype.calculateLocalInertia=function(e,t){throw"calculateLocalInertia() not implemented for shape type "+this.type};n.idCounter=0;n.types={SPHERE:1,PLANE:2,BOX:4,COMPOUND:8,CONVEXPOLYHEDRON:16,HEIGHTFIELD:32,PARTICLE:64,CYLINDER:128,TRIMESH:256}},{"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"./Shape":43}],44:[function(e,t,r){t.exports=a;var n=e("./Shape");var i=e("../math/Vec3");function a(e){n.call(this);this.radius=e!==undefined?Number(e):1;this.type=n.types.SPHERE;if(this.radius<0){throw new Error("The sphere radius cannot be negative.")}this.updateBoundingSphereRadius()}a.prototype=new n;a.prototype.constructor=a;a.prototype.calculateLocalInertia=function(e,t){t=t||new i;var r=2*e*this.radius*this.radius/5;t.x=r;t.y=r;t.z=r;return t};a.prototype.volume=function(){return 4*Math.PI*this.radius/3};a.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.radius};a.prototype.calculateWorldAABB=function(e,t,r,n){var i=this.radius;var a=["x","y","z"];for(var o=0;o<a.length;o++){var s=a[o];r[s]=e[s]-i;n[s]=e[s]+i}}},{"../math/Vec3":30,"./Shape":43}],45:[function(e,t,r){t.exports=u;var n=e("./Shape");var i=e("../math/Vec3");var a=e("../math/Quaternion");var o=e("../math/Transform");var s=e("../collision/AABB");var l=e("../utils/Octree");function u(e,t){n.call(this);this.type=n.types.TRIMESH;this.vertices=new Float32Array(e);this.indices=new Int16Array(t);this.normals=new Float32Array(t.length);this.aabb=new s;this.edges=null;this.scale=new i(1,1,1);this.tree=new l;this.updateEdges();this.updateNormals();this.updateAABB();this.updateBoundingSphereRadius();this.updateTree()}u.prototype=new n;u.prototype.constructor=u;var h=new i;u.prototype.updateTree=function(){var e=this;var t=this.tree;t.reset();t.aabb.copy(this.aabb);var r=this.scale;t.aabb.lowerBound.x*=1/r.x;t.aabb.lowerBound.y*=1/r.y;t.aabb.lowerBound.z*=1/r.z;t.aabb.upperBound.x*=1/r.x;t.aabb.upperBound.y*=1/r.y;t.aabb.upperBound.z*=1/r.z;var n=new s;var a=new i;var o=new i;var l=new i;var u=[a,o,l];for(var h=0;h<this.indices.length/3;h++){var c=h*3;e._getUnscaledVertex(e.indices[c],a);e._getUnscaledVertex(e.indices[c+1],o);e._getUnscaledVertex(e.indices[c+2],l);n.setFromPoints(u);t.insert(n,h)}t.removeEmptyNodes()};var c=new s;u.prototype.getTrianglesInAABB=function(e,t){c.copy(e);var r=this.scale;var n=r.x;var i=r.y;var a=r.z;var o=c.lowerBound;var s=c.upperBound;o.x/=n;o.y/=i;o.z/=a;s.x/=n;s.y/=i;s.z/=a;return this.tree.aabbQuery(c,t)};u.prototype.setScale=function(e){var t=this.scale.x===this.scale.y===this.scale.z;var r=e.x===e.y===e.z;if(!(t&&r)){this.updateNormals()}this.scale.copy(e);this.updateAABB();this.updateBoundingSphereRadius()};u.prototype.updateNormals=function(){var e=this;var t=h;var r=this.normals;for(var n=0;n<this.indices.length/3;n++){var i=n*3;var a=e.indices[i],o=e.indices[i+1],s=e.indices[i+2];e.getVertex(a,m);e.getVertex(o,_);e.getVertex(s,g);u.computeNormal(_,m,g,t);r[i]=t.x;r[i+1]=t.y;r[i+2]=t.z}};u.prototype.updateEdges=function(){var e=this;var t={};var r=function(e,r){var n=a<o?a+"_"+o:o+"_"+a;t[n]=true};for(var n=0;n<this.indices.length/3;n++){var i=n*3;var a=e.indices[i],o=e.indices[i+1],s=e.indices[i+2];r(a,o);r(o,s);r(s,a)}var l=Object.keys(t);this.edges=new Int16Array(l.length*2);for(var n=0;n<l.length;n++){var u=l[n].split("_");e.edges[2*n]=parseInt(u[0],10);e.edges[2*n+1]=parseInt(u[1],10)}};u.prototype.getEdgeVertex=function(e,t,r){var n=this.edges[e*2+(t?1:0)];this.getVertex(n,r)};var f=new i;var p=new i;u.prototype.getEdgeVector=function(e,t){var r=f;var n=p;this.getEdgeVertex(e,0,r);this.getEdgeVertex(e,1,n);n.vsub(r,t)};var d=new i;var v=new i;u.computeNormal=function(e,t,r,n){t.vsub(e,v);r.vsub(t,d);d.cross(v,n);if(!n.isZero()){n.normalize()}};var m=new i;var _=new i;var g=new i;u.prototype.getVertex=function(e,t){var r=this.scale;this._getUnscaledVertex(e,t);t.x*=r.x;t.y*=r.y;t.z*=r.z;return t};u.prototype._getUnscaledVertex=function(e,t){var r=e*3;var n=this.vertices;return t.set(n[r],n[r+1],n[r+2])};u.prototype.getWorldVertex=function(e,t,r,n){this.getVertex(e,n);o.pointToWorldFrame(t,r,n,n);return n};u.prototype.getTriangleVertices=function(e,t,r,n){var i=e*3;this.getVertex(this.indices[i],t);this.getVertex(this.indices[i+1],r);this.getVertex(this.indices[i+2],n)};u.prototype.getNormal=function(e,t){var r=e*3;return t.set(this.normals[r],this.normals[r+1],this.normals[r+2])};var y=new s;u.prototype.calculateLocalInertia=function(e,t){this.computeLocalAABB(y);var r=y.upperBound.x-y.lowerBound.x,n=y.upperBound.y-y.lowerBound.y,i=y.upperBound.z-y.lowerBound.z;return t.set(1/12*e*(2*n*2*n+2*i*2*i),1/12*e*(2*r*2*r+2*i*2*i),1/12*e*(2*n*2*n+2*r*2*r))};var x=new i;u.prototype.computeLocalAABB=function(e){var t=this;var r=e.lowerBound,n=e.upperBound,i=this.vertices.length,a=this.vertices,o=x;this.getVertex(0,o);r.copy(o);n.copy(o);for(var s=0;s!==i;s++){t.getVertex(s,o);if(o.x<r.x){r.x=o.x}else if(o.x>n.x){n.x=o.x}if(o.y<r.y){r.y=o.y}else if(o.y>n.y){n.y=o.y}if(o.z<r.z){r.z=o.z}else if(o.z>n.z){n.z=o.z}}};u.prototype.updateAABB=function(){this.computeLocalAABB(this.aabb)};u.prototype.updateBoundingSphereRadius=function(){var e=this;var t=0;var r=this.vertices;var n=new i;for(var a=0,o=r.length/3;a!==o;a++){e.getVertex(a,n);var s=n.norm2();if(s>t){t=s}}this.boundingSphereRadius=Math.sqrt(t)};var b=new i;var w=new o;var T=new s;u.prototype.calculateWorldAABB=function(e,t,r,n){var i=w;var a=T;i.position=e;i.quaternion=t;this.aabb.toWorldFrame(i,a);r.copy(a.lowerBound);n.copy(a.upperBound)};u.prototype.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3};u.createTorus=function(e,t,r,n,i){e=e||1;t=t||.5;r=r||8;n=n||6;i=i||Math.PI*2;var a=[];var o=[];for(var s=0;s<=r;s++){for(var l=0;l<=n;l++){var h=l/n*i;var c=s/r*Math.PI*2;var f=(e+t*Math.cos(c))*Math.cos(h);var p=(e+t*Math.cos(c))*Math.sin(h);var d=t*Math.sin(c);a.push(f,p,d)}}for(var s=1;s<=r;s++){for(var l=1;l<=n;l++){var v=(n+1)*s+l-1;var m=(n+1)*(s-1)+l-1;var _=(n+1)*(s-1)+l;var g=(n+1)*s+l;o.push(v,m,g);o.push(m,_,g)}}return new u(a,o)}},{"../collision/AABB":3,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../utils/Octree":50,"./Shape":43}],46:[function(e,t,r){t.exports=o;var n=e("../math/Vec3");var i=e("../math/Quaternion");var a=e("./Solver");function o(){a.call(this);this.iterations=10;this.tolerance=1e-7}o.prototype=new a;var s=[];var l=[];var u=[];o.prototype.solve=function(e,t){var r=0,n=this.iterations,i=this.tolerance*this.tolerance,a=this.equations,o=a.length,h=t.bodies,c=h.length,f=e,p,d,v,m,_,g,y;if(o!==0){for(var x=0;x!==c;x++){h[x].updateSolveMassProperties()}}var b=l,w=u,T=s;b.length=o;w.length=o;T.length=o;for(var x=0;x!==o;x++){var E=a[x];T[x]=0;w[x]=E.computeB(f);b[x]=1/E.computeC()}if(o!==0){for(var x=0;x!==c;x++){var S=h[x],M=S.vlambda,A=S.wlambda;M.set(0,0,0);if(A){A.set(0,0,0)}}for(r=0;r!==n;r++){_=0;for(var R=0;R!==o;R++){var E=a[R];d=w[R];v=b[R];y=T[R];g=E.computeGWlambda();m=v*(d-g-E.eps*y);if(y+m<E.minForce){m=E.minForce-y}else if(y+m>E.maxForce){m=E.maxForce-y}T[R]+=m;_+=m>0?m:-m;E.addToWlambda(m)}if(_*_<i){break}}for(var x=0;x!==c;x++){var S=h[x],L=S.velocity,C=S.angularVelocity;L.vadd(S.vlambda,L);if(C){C.vadd(S.wlambda,C)}}}return r}},{"../math/Quaternion":28,"../math/Vec3":30,"./Solver":47}],47:[function(e,t,r){t.exports=n;function n(){this.equations=[]}n.prototype.solve=function(e,t){return 0};n.prototype.addEquation=function(e){if(e.enabled){this.equations.push(e)}};n.prototype.removeEquation=function(e){var t=this.equations;var r=t.indexOf(e);if(r!==-1){t.splice(r,1)}};n.prototype.removeAllEquations=function(){this.equations.length=0}},{}],48:[function(e,t,r){t.exports=s;var n=e("../math/Vec3");var i=e("../math/Quaternion");var a=e("./Solver");var o=e("../objects/Body");function s(e){var t=this;a.call(this);this.iterations=10;this.tolerance=1e-7;this.subsolver=e;this.nodes=[];this.nodePool=[];while(this.nodePool.length<128){t.nodePool.push(t.createNode())}}s.prototype=new a;var l=[];var u=[];var h={bodies:[]};var c=o.STATIC;function f(e){var t=e.length;for(var r=0;r!==t;r++){var n=e[r];if(!n.visited&&!(n.body.type&c)){return n}}return false}var p=[];function d(e,t,r,n){p.push(e);e.visited=true;t(e,r,n);while(p.length){var i=p.pop();var a;while(a=f(i.children)){a.visited=true;t(a,r,n);p.push(a)}}}function v(e,t,r){t.push(e.body);var n=e.eqs.length;for(var i=0;i!==n;i++){var a=e.eqs[i];if(r.indexOf(a)===-1){r.push(a)}}}s.prototype.createNode=function(){return{body:null,children:[],eqs:[],visited:false}};s.prototype.solve=function(e,t){var r=this;var n=l,i=this.nodePool,a=t.bodies,o=this.equations,s=o.length,c=a.length,p=this.subsolver;while(i.length<c){i.push(r.createNode())}n.length=c;for(var _=0;_<c;_++){n[_]=i[_]}for(var _=0;_!==c;_++){var g=n[_];g.body=a[_];g.children.length=0;g.eqs.length=0;g.visited=false}for(var y=0;y!==s;y++){var x=o[y],_=a.indexOf(x.bi),b=a.indexOf(x.bj),w=n[_],T=n[b];w.children.push(T);w.eqs.push(x);T.children.push(w);T.eqs.push(x)}var E,S=0,M=u;p.tolerance=this.tolerance;p.iterations=this.iterations;var A=h;while(E=f(n)){M.length=0;A.bodies.length=0;d(E,v,A.bodies,M);var R=M.length;M=M.sort(m);for(var _=0;_!==R;_++){p.addEquation(M[_])}var L=p.solve(e,A);p.removeAllEquations();S++}return S};function m(e,t){return t.id-e.id}},{"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"./Solver":47}],49:[function(e,t,r){var n=function(){};t.exports=n;n.prototype={constructor:n,addEventListener:function(e,t){if(this._listeners===undefined){this._listeners={}}var r=this._listeners;if(r[e]===undefined){r[e]=[]}if(r[e].indexOf(t)===-1){r[e].push(t)}return this},hasEventListener:function(e,t){if(this._listeners===undefined){return false}var r=this._listeners;if(r[e]!==undefined&&r[e].indexOf(t)!==-1){return true}return false},removeEventListener:function(e,t){if(this._listeners===undefined){return this}var r=this._listeners;if(r[e]===undefined){return this}var n=r[e].indexOf(t);if(n!==-1){r[e].splice(n,1)}return this},dispatchEvent:function(e){var t=this;if(this._listeners===undefined){return this}var r=this._listeners;var n=r[e.type];if(n!==undefined){e.target=this;for(var i=0,a=n.length;i<a;i++){n[i].call(t,e)}}return this}}},{}],50:[function(e,t,r){var n=e("../collision/AABB");var i=e("../math/Vec3");t.exports=o;function a(e){e=e||{};this.root=e.root||null;this.aabb=e.aabb?e.aabb.clone():new n;this.data=[];this.children=[]}function o(e,t){t=t||{};t.root=null;t.aabb=e;a.call(this,t);this.maxDepth=typeof t.maxDepth!=="undefined"?t.maxDepth:8}o.prototype=new a;a.prototype.reset=function(e,t){this.children.length=this.data.length=0};a.prototype.insert=function(e,t,r){var n=this.data;r=r||0;if(!this.aabb.contains(e)){return false}var i=this.children;if(r<(this.maxDepth||this.root.maxDepth)){var a=false;if(!i.length){this.subdivide();a=true}for(var o=0;o!==8;o++){if(i[o].insert(e,t,r+1)){return true}}if(a){i.length=0}}n.push(t);return true};var s=new i;a.prototype.subdivide=function(){var e=this.aabb;var t=e.lowerBound;var r=e.upperBound;var o=this.children;o.push(new a({aabb:new n({lowerBound:new i(0,0,0)})}),new a({aabb:new n({lowerBound:new i(1,0,0)})}),new a({aabb:new n({lowerBound:new i(1,1,0)})}),new a({aabb:new n({lowerBound:new i(1,1,1)})}),new a({aabb:new n({lowerBound:new i(0,1,1)})}),new a({aabb:new n({lowerBound:new i(0,0,1)})}),new a({aabb:new n({lowerBound:new i(1,0,1)})}),new a({aabb:new n({lowerBound:new i(0,1,0)})}));r.vsub(t,s);s.scale(.5,s);var l=this.root||this;for(var u=0;u!==8;u++){var h=o[u];h.root=l;var c=h.aabb.lowerBound;c.x*=s.x;c.y*=s.y;c.z*=s.z;c.vadd(t,c);c.vadd(s,h.aabb.upperBound)}};a.prototype.aabbQuery=function(e,t){var r=this.data;var n=this.children;var i=[this];while(i.length){var a=i.pop();if(a.aabb.overlaps(e)){Array.prototype.push.apply(t,a.data)}Array.prototype.push.apply(i,a.children)}return t};var l=new n;a.prototype.rayQuery=function(e,t,r){e.getAABB(l);l.toLocalFrame(t,l);this.aabbQuery(l,r);return r};a.prototype.removeEmptyNodes=function(){var e=[this];while(e.length){var t=e.pop();for(var r=t.children.length-1;r>=0;r--){if(!t.children[r].data.length){t.children.splice(r,1)}}Array.prototype.push.apply(e,t.children)}}},{"../collision/AABB":3,"../math/Vec3":30}],51:[function(e,t,r){t.exports=n;function n(){this.objects=[];this.type=Object}n.prototype.release=function(){var e=arguments;var t=this;var r=arguments.length;for(var n=0;n!==r;n++){t.objects.push(e[n])}};n.prototype.get=function(){if(this.objects.length===0){return this.constructObject()}else{return this.objects.pop()}};n.prototype.constructObject=function(){throw new Error("constructObject() not implemented in this Pool subclass yet!")}},{}],52:[function(e,t,r){t.exports=n;function n(){this.data={keys:[]}}n.prototype.get=function(e,t){if(e>t){var r=t;t=e;e=r}return this.data[e+"-"+t]};n.prototype.set=function(e,t,r){if(e>t){var n=t;t=e;e=n}var i=e+"-"+t;if(!this.get(e,t)){this.data.keys.push(i)}this.data[i]=r};n.prototype.reset=function(){var e=this.data,t=e.keys;while(t.length>0){var r=t.pop();delete e[r]}}},{}],53:[function(e,t,r){function n(){}t.exports=n;n.defaults=function(e,t){e=e||{};for(var r in t){if(!(r in e)){e[r]=t[r]}}return e}},{}],54:[function(e,t,r){t.exports=a;var n=e("../math/Vec3");var i=e("./Pool");function a(){i.call(this);this.type=n}a.prototype=new i;a.prototype.constructObject=function(){return new n}},{"../math/Vec3":30,"./Pool":51}],55:[function(e,t,r){t.exports=d;var n=e("../collision/AABB");var i=e("../shapes/Shape");var a=e("../collision/Ray");var o=e("../math/Vec3");var s=e("../math/Transform");var l=e("../shapes/ConvexPolyhedron");var u=e("../math/Quaternion");var h=e("../solver/Solver");var c=e("../utils/Vec3Pool");var f=e("../equations/ContactEquation");var p=e("../equations/FrictionEquation");function d(e){this.contactPointPool=[];this.frictionEquationPool=[];this.result=[];this.frictionResult=[];this.v3pool=new c;this.world=e;this.currentContactMaterial=null;this.enableFrictionReduction=false}d.prototype.createContactEquation=function(e,t,r,n,i,a){var o;if(this.contactPointPool.length){o=this.contactPointPool.pop();o.bi=e;o.bj=t}else{o=new f(e,t)}o.enabled=e.collisionResponse&&t.collisionResponse&&r.collisionResponse&&n.collisionResponse;var s=this.currentContactMaterial;o.restitution=s.restitution;o.setSpookParams(s.contactEquationStiffness,s.contactEquationRelaxation,this.world.dt);var l=r.material||e.material;var u=n.material||t.material;if(l&&u&&l.restitution>=0&&u.restitution>=0){o.restitution=l.restitution*u.restitution}o.si=i||r;o.sj=a||n;return o};d.prototype.createFrictionEquationsFromContact=function(e,t){var r=e.bi;var n=e.bj;var i=e.si;var a=e.sj;var o=this.world;var s=this.currentContactMaterial;var l=s.friction;var u=i.material||r.material;var h=a.material||n.material;if(u&&h&&u.friction>=0&&h.friction>=0){l=u.friction*h.friction}if(l>0){var c=l*o.gravity.length();var f=r.invMass+n.invMass;if(f>0){f=1/f}var d=this.frictionEquationPool;var v=d.length?d.pop():new p(r,n,c*f);var m=d.length?d.pop():new p(r,n,c*f);v.bi=m.bi=r;v.bj=m.bj=n;v.minForce=m.minForce=-c*f;v.maxForce=m.maxForce=c*f;v.ri.copy(e.ri);v.rj.copy(e.rj);m.ri.copy(e.ri);m.rj.copy(e.rj);e.ni.tangents(v.t,m.t);v.setSpookParams(s.frictionEquationStiffness,s.frictionEquationRelaxation,o.dt);m.setSpookParams(s.frictionEquationStiffness,s.frictionEquationRelaxation,o.dt);v.enabled=m.enabled=e.enabled;t.push(v,m);return true}return false};var v=new o;var m=new o;var _=new o;d.prototype.createFrictionFromAverage=function(e){var t=this;var r=this.result[this.result.length-1];if(!this.createFrictionEquationsFromContact(r,this.frictionResult)||e===1){return}var n=this.frictionResult[this.frictionResult.length-2];var i=this.frictionResult[this.frictionResult.length-1];v.setZero();m.setZero();_.setZero();var a=r.bi;var o=r.bj;for(var s=0;s!==e;s++){r=t.result[t.result.length-1-s];if(r.bodyA!==a){v.vadd(r.ni,v);m.vadd(r.ri,m);_.vadd(r.rj,_)}else{v.vsub(r.ni,v);m.vadd(r.rj,m);_.vadd(r.ri,_)}}var l=1/e;m.scale(l,n.ri);_.scale(l,n.rj);i.ri.copy(n.ri);i.rj.copy(n.rj);v.normalize();v.tangents(n.t,i.t)};var g=new o;var y=new o;var x=new u;var b=new u;d.prototype.getContacts=function(e,t,r,n,i,a,o){var s=this;this.contactPointPool=i;this.frictionEquationPool=o;this.result=n;this.frictionResult=a;var l=x;var u=b;var h=g;var c=y;for(var f=0,p=e.length;f!==p;f++){var d=e[f],v=t[f];var m=null;if(d.material&&v.material){m=r.getContactMaterial(d.material,v.material)||null}for(var _=0;_<d.shapes.length;_++){d.quaternion.mult(d.shapeOrientations[_],l);d.quaternion.vmult(d.shapeOffsets[_],h);h.vadd(d.position,h);var w=d.shapes[_];for(var T=0;T<v.shapes.length;T++){v.quaternion.mult(v.shapeOrientations[T],u);v.quaternion.vmult(v.shapeOffsets[T],c);c.vadd(v.position,c);var E=v.shapes[T];if(h.distanceTo(c)>w.boundingSphereRadius+E.boundingSphereRadius){continue}var S=null;if(w.material&&E.material){S=r.getContactMaterial(w.material,E.material)||null}s.currentContactMaterial=S||m||r.defaultContactMaterial;var M=s[w.type|E.type];if(M){if(w.type<E.type){M.call(s,w,E,h,c,l,u,d,v,w,E)}else{M.call(s,E,w,c,h,u,l,v,d,w,E)}}}}}};d.prototype[i.types.BOX|i.types.BOX]=d.prototype.boxBox=function(e,t,r,n,i,a,o,s){e.convexPolyhedronRepresentation.material=e.material;t.convexPolyhedronRepresentation.material=t.material;e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse;t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse;this.convexConvex(e.convexPolyhedronRepresentation,t.convexPolyhedronRepresentation,r,n,i,a,o,s,e,t)};d.prototype[i.types.BOX|i.types.CONVEXPOLYHEDRON]=d.prototype.boxConvex=function(e,t,r,n,i,a,o,s){e.convexPolyhedronRepresentation.material=e.material;e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse;this.convexConvex(e.convexPolyhedronRepresentation,t,r,n,i,a,o,s,e,t)};d.prototype[i.types.BOX|i.types.PARTICLE]=d.prototype.boxParticle=function(e,t,r,n,i,a,o,s){e.convexPolyhedronRepresentation.material=e.material;e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse;this.convexParticle(e.convexPolyhedronRepresentation,t,r,n,i,a,o,s,e,t)};d.prototype[i.types.SPHERE]=d.prototype.sphereSphere=function(e,t,r,n,i,a,o,s){var l=this.createContactEquation(o,s,e,t);n.vsub(r,l.ni);l.ni.normalize();l.ri.copy(l.ni);l.rj.copy(l.ni);l.ri.mult(e.radius,l.ri);l.rj.mult(-t.radius,l.rj);l.ri.vadd(r,l.ri);l.ri.vsub(o.position,l.ri);l.rj.vadd(n,l.rj);l.rj.vsub(s.position,l.rj);this.result.push(l);this.createFrictionEquationsFromContact(l,this.frictionResult)};var w=new o;var T=new o;var E=new o;d.prototype[i.types.PLANE|i.types.TRIMESH]=d.prototype.planeTrimesh=function(e,t,r,n,i,a,l,u){var h=this;var c=new o;var f=w;f.set(0,0,1);i.vmult(f,f);for(var p=0;p<t.vertices.length/3;p++){t.getVertex(p,c);var d=new o;d.copy(c);s.pointToWorldFrame(n,a,d,c);var v=T;c.vsub(r,v);var m=f.dot(v);if(m<=0){var _=h.createContactEquation(l,u,e,t);_.ni.copy(f);var g=E;f.scale(v.dot(f),g);c.vsub(g,g);_.ri.copy(g);_.ri.vsub(l.position,_.ri);_.rj.copy(c);_.rj.vsub(u.position,_.rj);h.result.push(_);h.createFrictionEquationsFromContact(_,h.frictionResult)}}};var S=new o;var M=new o;var A=new o;var R=new o;var L=new o;var C=new o;var I=new o;var U=new o;var D=new o;var O=new o;var B=new o;var P=new o;var F=new o;var z=new o;var N=new n;var k=[];d.prototype[i.types.SPHERE|i.types.TRIMESH]=d.prototype.sphereTrimesh=function(e,t,r,n,i,o,l,u){var h=this;var c=C;var f=I;var p=U;var d=D;var v=O;var m=B;var _=N;var g=L;var y=M;var x=k;s.pointToLocalFrame(n,o,r,v);var b=e.radius;_.lowerBound.set(v.x-b,v.y-b,v.z-b);_.upperBound.set(v.x+b,v.y+b,v.z+b);t.getTrianglesInAABB(_,x);var w=R;var T=e.radius*e.radius;for(var E=0;E<x.length;E++){for(var A=0;A<3;A++){t.getVertex(t.indices[x[E]*3+A],w);w.vsub(v,y);if(y.norm2()<=T){g.copy(w);s.pointToWorldFrame(n,o,g,w);w.vsub(r,y);var V=h.createContactEquation(l,u,e,t);V.ni.copy(y);V.ni.normalize();V.ri.copy(V.ni);V.ri.scale(e.radius,V.ri);V.ri.vadd(r,V.ri);V.ri.vsub(l.position,V.ri);V.rj.copy(w);V.rj.vsub(u.position,V.rj);h.result.push(V);h.createFrictionEquationsFromContact(V,h.frictionResult)}}}for(var E=0;E<x.length;E++){for(var A=0;A<3;A++){t.getVertex(t.indices[x[E]*3+A],c);t.getVertex(t.indices[x[E]*3+(A+1)%3],f);f.vsub(c,p);v.vsub(f,m);var G=m.dot(p);v.vsub(c,m);var W=m.dot(p);if(W>0&&G<0){v.vsub(c,m);d.copy(p);d.normalize();W=m.dot(d);d.scale(W,m);m.vadd(c,m);var H=m.distanceTo(v);if(H<e.radius){var V=h.createContactEquation(l,u,e,t);m.vsub(v,V.ni);V.ni.normalize();V.ni.scale(e.radius,V.ri);s.pointToWorldFrame(n,o,m,m);m.vsub(u.position,V.rj);s.vectorToWorldFrame(o,V.ni,V.ni);s.vectorToWorldFrame(o,V.ri,V.ri);h.result.push(V);h.createFrictionEquationsFromContact(V,h.frictionResult)}}}}var j=P;var q=F;var X=z;var Y=S;for(var E=0,K=x.length;E!==K;E++){t.getTriangleVertices(x[E],j,q,X);t.getNormal(x[E],Y);v.vsub(j,m);var H=m.dot(Y);Y.scale(H,m);v.vsub(m,m);H=m.distanceTo(v);if(a.pointInTriangle(m,j,q,X)&&H<e.radius){var V=h.createContactEquation(l,u,e,t);m.vsub(v,V.ni);V.ni.normalize();V.ni.scale(e.radius,V.ri);s.pointToWorldFrame(n,o,m,m);m.vsub(u.position,V.rj);s.vectorToWorldFrame(o,V.ni,V.ni);s.vectorToWorldFrame(o,V.ri,V.ri);h.result.push(V);h.createFrictionEquationsFromContact(V,h.frictionResult)}}x.length=0};var V=new o;var G=new o;d.prototype[i.types.SPHERE|i.types.PLANE]=d.prototype.spherePlane=function(e,t,r,n,i,a,o,s){var l=this.createContactEquation(o,s,e,t);l.ni.set(0,0,1);a.vmult(l.ni,l.ni);l.ni.negate(l.ni);l.ni.normalize();l.ni.mult(e.radius,l.ri);r.vsub(n,V);l.ni.mult(l.ni.dot(V),G);V.vsub(G,l.rj);if(-V.dot(l.ni)<=e.radius){var u=l.ri;var h=l.rj;u.vadd(r,u);u.vsub(o.position,u);h.vadd(n,h);h.vsub(s.position,h);this.result.push(l);this.createFrictionEquationsFromContact(l,this.frictionResult)}};var W=new o;var H=new o;var j=new o;function q(e,t,r){var n=null;var i=e.length;for(var a=0;a!==i;a++){var o=e[a];var s=W;e[(a+1)%i].vsub(o,s);var l=H;s.cross(t,l);var u=j;r.vsub(o,u);var h=l.dot(u);if(n===null||h>0&&n===true||h<=0&&n===false){if(n===null){n=h>0}continue}else{return false}}return true}var X=new o;var Y=new o;var K=new o;var Z=new o;var Q=[new o,new o,new o,new o,new o,new o];var J=new o;var $=new o;var ee=new o;var te=new o;d.prototype[i.types.SPHERE|i.types.BOX]=d.prototype.sphereBox=function(e,t,r,n,i,a,o,s){var l=this;var u=this.v3pool;var h=Q;r.vsub(n,X);t.getSideNormals(h,a);var c=e.radius;var f=false;var p=$;var d=ee;var v=te;var m=null;var _=0;var g=0;var y=0;var x=null;for(var b=0,w=h.length;b!==w&&f===false;b++){var T=Y;T.copy(h[b]);var E=T.norm();T.normalize();var S=X.dot(T);if(S<E+c&&S>0){var M=K;var A=Z;M.copy(h[(b+1)%3]);A.copy(h[(b+2)%3]);var R=M.norm();var L=A.norm();M.normalize();A.normalize();var C=X.dot(M);var I=X.dot(A);if(C<R&&C>-R&&I<L&&I>-L){var U=Math.abs(S-E-c);if(x===null||U<x){x=U;g=C;y=I;m=E;p.copy(T);d.copy(M);v.copy(A);_++}}}}if(_){f=true;var D=this.createContactEquation(o,s,e,t);p.mult(-c,D.ri);D.ni.copy(p);D.ni.negate(D.ni);p.mult(m,p);d.mult(g,d);p.vadd(d,p);v.mult(y,v);p.vadd(v,D.rj);D.ri.vadd(r,D.ri);D.ri.vsub(o.position,D.ri);D.rj.vadd(n,D.rj);D.rj.vsub(s.position,D.rj);this.result.push(D);this.createFrictionEquationsFromContact(D,this.frictionResult)}var O=u.get();var B=J;for(var P=0;P!==2&&!f;P++){for(var F=0;F!==2&&!f;F++){for(var z=0;z!==2&&!f;z++){O.set(0,0,0);if(P){O.vadd(h[0],O)}else{O.vsub(h[0],O)}if(F){O.vadd(h[1],O)}else{O.vsub(h[1],O)}if(z){O.vadd(h[2],O)}else{O.vsub(h[2],O)}n.vadd(O,B);B.vsub(r,B);if(B.norm2()<c*c){f=true;var D=l.createContactEquation(o,s,e,t);D.ri.copy(B);D.ri.normalize();D.ni.copy(D.ri);D.ri.mult(c,D.ri);D.rj.copy(O);D.ri.vadd(r,D.ri);D.ri.vsub(o.position,D.ri);D.rj.vadd(n,D.rj);D.rj.vsub(s.position,D.rj);l.result.push(D);l.createFrictionEquationsFromContact(D,l.frictionResult)}}}}u.release(O);O=null;var N=u.get();var k=u.get();var D=u.get();var V=u.get();var U=u.get();var G=h.length;for(var P=0;P!==G&&!f;P++){for(var F=0;F!==G&&!f;F++){if(P%3!==F%3){h[F].cross(h[P],N);N.normalize();h[P].vadd(h[F],k);D.copy(r);D.vsub(k,D);D.vsub(n,D);var W=D.dot(N);N.mult(W,V);var z=0;while(z===P%3||z===F%3){z++}U.copy(r);U.vsub(V,U);U.vsub(k,U);U.vsub(n,U);var H=Math.abs(W);var j=U.norm();if(H<h[z].norm()&&j<c){f=true;var q=l.createContactEquation(o,s,e,t);k.vadd(V,q.rj);q.rj.copy(q.rj);U.negate(q.ni);q.ni.normalize();q.ri.copy(q.rj);q.ri.vadd(n,q.ri);q.ri.vsub(r,q.ri);q.ri.normalize();q.ri.mult(c,q.ri);q.ri.vadd(r,q.ri);q.ri.vsub(o.position,q.ri);q.rj.vadd(n,q.rj);q.rj.vsub(s.position,q.rj);l.result.push(q);l.createFrictionEquationsFromContact(q,l.frictionResult)}}}}u.release(N,k,D,V,U)};var re=new o;var ne=new o;var ie=new o;var ae=new o;var oe=new o;var se=new o;var le=new o;var ue=new o;var he=new o;var ce=new o;d.prototype[i.types.SPHERE|i.types.CONVEXPOLYHEDRON]=d.prototype.sphereConvex=function(e,t,r,n,i,a,o,s){var l=this;var u=this.v3pool;r.vsub(n,re);var h=t.faceNormals;var c=t.faces;var f=t.vertices;var p=e.radius;for(var d=0;d!==f.length;d++){var v=f[d];var m=oe;a.vmult(v,m);n.vadd(m,m);var _=ae;m.vsub(r,_);if(_.norm2()<p*p){y=true;var g=l.createContactEquation(o,s,e,t);g.ri.copy(_);g.ri.normalize();g.ni.copy(g.ri);g.ri.mult(p,g.ri);m.vsub(n,g.rj);g.ri.vadd(r,g.ri);g.ri.vsub(o.position,g.ri);g.rj.vadd(n,g.rj);g.rj.vsub(s.position,g.rj);l.result.push(g);l.createFrictionEquationsFromContact(g,l.frictionResult);return}}var y=false;for(var d=0,x=c.length;d!==x&&y===false;d++){var b=h[d];var w=c[d];var T=se;a.vmult(b,T);var E=le;a.vmult(f[w[0]],E);E.vadd(n,E);var S=ue;T.mult(-p,S);r.vadd(S,S);var M=he;S.vsub(E,M);var A=M.dot(T);var R=ce;r.vsub(E,R);if(A<0&&R.dot(T)>0){var L=[];for(var C=0,I=w.length;C!==I;C++){var U=u.get();a.vmult(f[w[C]],U);n.vadd(U,U);L.push(U)}if(q(L,T,r)){y=true;var g=l.createContactEquation(o,s,e,t);T.mult(-p,g.ri);T.negate(g.ni);var D=u.get();T.mult(-A,D);var O=u.get();T.mult(-p,O);r.vsub(n,g.rj);g.rj.vadd(O,g.rj);g.rj.vadd(D,g.rj);g.rj.vadd(n,g.rj);g.rj.vsub(s.position,g.rj);g.ri.vadd(r,g.ri);g.ri.vsub(o.position,g.ri);u.release(D);u.release(O);l.result.push(g);l.createFrictionEquationsFromContact(g,l.frictionResult);for(var C=0,B=L.length;C!==B;C++){u.release(L[C])}return}else{for(var C=0;C!==w.length;C++){var P=u.get();var F=u.get();a.vmult(f[w[(C+1)%w.length]],P);a.vmult(f[w[(C+2)%w.length]],F);n.vadd(P,P);n.vadd(F,F);var z=ne;F.vsub(P,z);var N=ie;z.unit(N);var k=u.get();var V=u.get();r.vsub(P,V);var G=V.dot(N);N.mult(G,k);k.vadd(P,k);var W=u.get();k.vsub(r,W);if(G>0&&G*G<z.norm2()&&W.norm2()<p*p){var g=l.createContactEquation(o,s,e,t);k.vsub(n,g.rj);k.vsub(r,g.ni);g.ni.normalize();g.ni.mult(p,g.ri);g.rj.vadd(n,g.rj);g.rj.vsub(s.position,g.rj);g.ri.vadd(r,g.ri);g.ri.vsub(o.position,g.ri);l.result.push(g);l.createFrictionEquationsFromContact(g,l.frictionResult);for(var C=0,B=L.length;C!==B;C++){u.release(L[C])}u.release(P);u.release(F);u.release(k);u.release(W);u.release(V);return}u.release(P);u.release(F);u.release(k);u.release(W);u.release(V)}}for(var C=0,B=L.length;C!==B;C++){u.release(L[C])}}}};var fe=new o;var pe=new o;d.prototype[i.types.PLANE|i.types.BOX]=d.prototype.planeBox=function(e,t,r,n,i,a,o,s){t.convexPolyhedronRepresentation.material=t.material;t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse;this.planeConvex(e,t.convexPolyhedronRepresentation,r,n,i,a,o,s)};var de=new o;var ve=new o;var me=new o;var _e=new o;d.prototype[i.types.PLANE|i.types.CONVEXPOLYHEDRON]=d.prototype.planeConvex=function(e,t,r,n,i,a,o,s){var l=this;var u=de,h=ve;h.set(0,0,1);i.vmult(h,h);var c=0;var f=me;for(var p=0;p!==t.vertices.length;p++){u.copy(t.vertices[p]);a.vmult(u,u);n.vadd(u,u);u.vsub(r,f);var d=h.dot(f);if(d<=0){var v=l.createContactEquation(o,s,e,t);var m=_e;h.mult(h.dot(f),m);u.vsub(m,m);m.vsub(r,v.ri);v.ni.copy(h);u.vsub(n,v.rj);v.ri.vadd(r,v.ri);v.ri.vsub(o.position,v.ri);v.rj.vadd(n,v.rj);v.rj.vsub(s.position,v.rj);l.result.push(v);c++;if(!l.enableFrictionReduction){l.createFrictionEquationsFromContact(v,l.frictionResult)}}}if(this.enableFrictionReduction&&c){this.createFrictionFromAverage(c)}};var ge=new o;var ye=new o;d.prototype[i.types.CONVEXPOLYHEDRON]=d.prototype.convexConvex=function(e,t,r,n,i,a,o,s,l,u,h,c){var f=this;var p=ge;if(r.distanceTo(n)>e.boundingSphereRadius+t.boundingSphereRadius){return}if(e.findSeparatingAxis(t,r,i,n,a,p,h,c)){var d=[];var v=ye;e.clipAgainstHull(r,i,t,n,a,p,-100,100,d);var m=0;for(var _=0;_!==d.length;_++){var g=f.createContactEquation(o,s,e,t,l,u),y=g.ri,x=g.rj;p.negate(g.ni);d[_].normal.negate(v);v.mult(d[_].depth,v);d[_].point.vadd(v,y);x.copy(d[_].point);y.vsub(r,y);x.vsub(n,x);y.vadd(r,y);y.vsub(o.position,y);x.vadd(n,x);x.vsub(s.position,x);f.result.push(g);m++;if(!f.enableFrictionReduction){f.createFrictionEquationsFromContact(g,f.frictionResult)}}if(this.enableFrictionReduction&&m){this.createFrictionFromAverage(m)}}};var xe=new o;var be=new o;var we=new o;d.prototype[i.types.PLANE|i.types.PARTICLE]=d.prototype.planeParticle=function(e,t,r,n,i,a,o,s){var l=xe;l.set(0,0,1);o.quaternion.vmult(l,l);var u=be;n.vsub(o.position,u);var h=l.dot(u);if(h<=0){var c=this.createContactEquation(s,o,t,e);c.ni.copy(l);c.ni.negate(c.ni);c.ri.set(0,0,0);var f=we;l.mult(l.dot(n),f);n.vsub(f,f);c.rj.copy(f);this.result.push(c);this.createFrictionEquationsFromContact(c,this.frictionResult)}};var Te=new o;d.prototype[i.types.PARTICLE|i.types.SPHERE]=d.prototype.sphereParticle=function(e,t,r,n,i,a,o,s){var l=Te;l.set(0,0,1);n.vsub(r,l);var u=l.norm2();if(u<=e.radius*e.radius){var h=this.createContactEquation(s,o,t,e);l.normalize();h.rj.copy(l);h.rj.mult(e.radius,h.rj);h.ni.copy(l);h.ni.negate(h.ni);h.ri.set(0,0,0);this.result.push(h);this.createFrictionEquationsFromContact(h,this.frictionResult)}};var Ee=new u;var Se=new o;var Me=new o;var Ae=new o;var Re=new o;var Le=new o;d.prototype[i.types.PARTICLE|i.types.CONVEXPOLYHEDRON]=d.prototype.convexParticle=function(e,t,r,n,i,a,o,s){var l=-1;var u=Ae;var h=Le;var c=null;var f=Se;f.copy(n);f.vsub(r,f);i.conjugate(Ee);Ee.vmult(f,f);if(e.pointIsInside(f)){if(e.worldVerticesNeedsUpdate){e.computeWorldVertices(r,i)}if(e.worldFaceNormalsNeedsUpdate){e.computeWorldFaceNormals(i)}for(var p=0,d=e.faces.length;p!==d;p++){var v=[e.worldVertices[e.faces[p][0]]];var m=e.worldFaceNormals[p];n.vsub(v[0],Re);var _=-m.dot(Re);if(c===null||Math.abs(_)<Math.abs(c)){c=_;l=p;u.copy(m)}}if(l!==-1){var g=this.createContactEquation(s,o,t,e);u.mult(c,h);h.vadd(n,h);h.vsub(r,h);g.rj.copy(h);u.negate(g.ni);g.ri.set(0,0,0);var y=g.ri,x=g.rj;y.vadd(n,y);y.vsub(s.position,y);x.vadd(r,x);x.vsub(o.position,x);this.result.push(g);this.createFrictionEquationsFromContact(g,this.frictionResult)}else{console.warn("Point found inside convex, but did not find penetrating face!")}}};d.prototype[i.types.BOX|i.types.HEIGHTFIELD]=d.prototype.boxHeightfield=function(e,t,r,n,i,a,o,s){e.convexPolyhedronRepresentation.material=e.material;e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse;this.convexHeightfield(e.convexPolyhedronRepresentation,t,r,n,i,a,o,s)};var Ce=new o;var Ie=new o;var Ue=[0];d.prototype[i.types.CONVEXPOLYHEDRON|i.types.HEIGHTFIELD]=d.prototype.convexHeightfield=function(e,t,r,n,i,a,o,l){var u=this;var h=t.data,c=t.elementSize,f=e.boundingSphereRadius,p=Ie,d=Ue;var v=Ce;s.pointToLocalFrame(n,a,r,v);var m=Math.floor((v.x-f)/c)-1,_=Math.ceil((v.x+f)/c)+1,g=Math.floor((v.y-f)/c)-1,y=Math.ceil((v.y+f)/c)+1;if(_<0||y<0||m>h.length||g>h[0].length){return}if(m<0){m=0}if(_<0){_=0}if(g<0){g=0}if(y<0){y=0}if(m>=h.length){m=h.length-1}if(_>=h.length){_=h.length-1}if(y>=h[0].length){y=h[0].length-1}if(g>=h[0].length){g=h[0].length-1}var x=[];t.getRectMinMax(m,g,_,y,x);var b=x[0];var w=x[1];if(v.z-f>w||v.z+f<b){return}for(var T=m;T<_;T++){for(var E=g;E<y;E++){t.getConvexTrianglePillar(T,E,false);s.pointToWorldFrame(n,a,t.pillarOffset,p);if(r.distanceTo(p)<t.pillarConvex.boundingSphereRadius+e.boundingSphereRadius){u.convexConvex(e,t.pillarConvex,r,p,i,a,o,l,null,null,d,null)}t.getConvexTrianglePillar(T,E,true);s.pointToWorldFrame(n,a,t.pillarOffset,p);if(r.distanceTo(p)<t.pillarConvex.boundingSphereRadius+e.boundingSphereRadius){u.convexConvex(e,t.pillarConvex,r,p,i,a,o,l,null,null,d,null)}}}};var De=new o;var Oe=new o;d.prototype[i.types.SPHERE|i.types.HEIGHTFIELD]=d.prototype.sphereHeightfield=function(e,t,r,n,i,a,o,l){var u=this;var h=t.data,c=e.radius,f=t.elementSize,p=Oe;var d=De;s.pointToLocalFrame(n,a,r,d);var v=Math.floor((d.x-c)/f)-1,m=Math.ceil((d.x+c)/f)+1,_=Math.floor((d.y-c)/f)-1,g=Math.ceil((d.y+c)/f)+1;if(m<0||g<0||v>h.length||g>h[0].length){return}if(v<0){v=0}if(m<0){m=0}if(_<0){_=0}if(g<0){g=0}if(v>=h.length){v=h.length-1}if(m>=h.length){m=h.length-1}if(g>=h[0].length){g=h[0].length-1}if(_>=h[0].length){_=h[0].length-1}var y=[];t.getRectMinMax(v,_,m,g,y);var x=y[0];var b=y[1];if(d.z-c>b||d.z+c<x){return}var w=this.result;for(var T=v;T<m;T++){for(var E=_;E<g;E++){var S=w.length;t.getConvexTrianglePillar(T,E,false);s.pointToWorldFrame(n,a,t.pillarOffset,p);if(r.distanceTo(p)<t.pillarConvex.boundingSphereRadius+e.boundingSphereRadius){u.sphereConvex(e,t.pillarConvex,r,p,i,a,o,l)}t.getConvexTrianglePillar(T,E,true);s.pointToWorldFrame(n,a,t.pillarOffset,p);if(r.distanceTo(p)<t.pillarConvex.boundingSphereRadius+e.boundingSphereRadius){u.sphereConvex(e,t.pillarConvex,r,p,i,a,o,l)}var M=w.length-S;if(M>2){return}}}}},{"../collision/AABB":3,"../collision/Ray":9,"../equations/ContactEquation":19,"../equations/FrictionEquation":21,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../shapes/ConvexPolyhedron":38,"../shapes/Shape":43,"../solver/Solver":47,"../utils/Vec3Pool":54}],56:[function(e,t,r){t.exports=b;var n=e("../shapes/Shape");var i=e("../math/Vec3");var a=e("../math/Quaternion");var o=e("../solver/GSSolver");var s=e("../utils/Vec3Pool");var l=e("../equations/ContactEquation");var u=e("../equations/FrictionEquation");var h=e("./Narrowphase");var c=e("../utils/EventTarget");var f=e("../collision/ArrayCollisionMatrix");var p=e("../material/Material");var d=e("../material/ContactMaterial");var v=e("../objects/Body");var m=e("../utils/TupleDictionary");var _=e("../collision/RaycastResult");var g=e("../collision/AABB");var y=e("../collision/Ray");var x=e("../collision/NaiveBroadphase");function b(){c.apply(this);this.dt=-1;this.allowSleep=false;this.contacts=[];this.frictionEquations=[];this.quatNormalizeSkip=0;this.quatNormalizeFast=false;this.time=0;this.stepnumber=0;this.default_dt=1/60;this.nextId=0;this.gravity=new i;this.broadphase=new x;this.bodies=[];this.solver=new o;this.constraints=[];this.narrowphase=new h(this);this.collisionMatrix=new f;this.collisionMatrixPrevious=new f;this.materials=[];this.contactmaterials=[];this.contactMaterialTable=new m;this.defaultMaterial=new p("default");this.defaultContactMaterial=new d(this.defaultMaterial,this.defaultMaterial,{friction:.3,restitution:0});this.doProfiling=false;this.profile={solve:0,makeContactConstraints:0,broadphase:0,integrate:0,narrowphase:0};this.subsystems=[];this.addBodyEvent={type:"addBody",body:null};this.removeBodyEvent={type:"removeBody",body:null}}b.prototype=new c;var w=new g;var T=new y;b.prototype.getContactMaterial=function(e,t){return this.contactMaterialTable.get(e.id,t.id)};b.prototype.numObjects=function(){return this.bodies.length};b.prototype.collisionMatrixTick=function(){var e=this.collisionMatrixPrevious;this.collisionMatrixPrevious=this.collisionMatrix;this.collisionMatrix=e;this.collisionMatrix.reset()};b.prototype.add=b.prototype.addBody=function(e){if(this.bodies.indexOf(e)!==-1){return}e.index=this.bodies.length;this.bodies.push(e);e.world=this;e.initPosition.copy(e.position);e.initVelocity.copy(e.velocity);e.timeLastSleepy=this.time;if(e instanceof v){e.initAngularVelocity.copy(e.angularVelocity);e.initQuaternion.copy(e.quaternion)}this.collisionMatrix.setNumObjects(this.bodies.length);this.addBodyEvent.body=e;this.dispatchEvent(this.addBodyEvent)};b.prototype.addConstraint=function(e){this.constraints.push(e)};b.prototype.removeConstraint=function(e){var t=this.constraints.indexOf(e);if(t!==-1){this.constraints.splice(t,1)}};b.prototype.rayTest=function(e,t,r){if(r instanceof _){this.raycastClosest(e,t,{skipBackfaces:true},r)}else{this.raycastAll(e,t,{skipBackfaces:true},r)}};b.prototype.raycastAll=function(e,t,r,n){r.mode=y.ALL;r.from=e;r.to=t;r.callback=n;return T.intersectWorld(this,r)};b.prototype.raycastAny=function(e,t,r,n){r.mode=y.ANY;r.from=e;r.to=t;r.result=n;return T.intersectWorld(this,r)};b.prototype.raycastClosest=function(e,t,r,n){r.mode=y.CLOSEST;r.from=e;r.to=t;r.result=n;return T.intersectWorld(this,r)};b.prototype.remove=function(e){e.world=null;var t=this.bodies.length-1,r=this.bodies,n=r.indexOf(e);if(n!==-1){r.splice(n,1);for(var i=0;i!==r.length;i++){r[i].index=i}this.collisionMatrix.setNumObjects(t);this.removeBodyEvent.body=e;this.dispatchEvent(this.removeBodyEvent)}};b.prototype.removeBody=b.prototype.remove;b.prototype.addMaterial=function(e){this.materials.push(e)};b.prototype.addContactMaterial=function(e){this.contactmaterials.push(e);this.contactMaterialTable.set(e.materials[0].id,e.materials[1].id,e)};if(typeof performance==="undefined"){performance={}}if(!performance.now){var E=Date.now();if(performance.timing&&performance.timing.navigationStart){E=performance.timing.navigationStart}performance.now=function(){return Date.now()-E}}var S=new i;b.prototype.step=function(e,t,r){var n=this;r=r||10;t=t||0;if(t===0){this.internalStep(e);this.time+=e}else{var i=Math.floor((this.time+t)/e)-Math.floor(this.time/e);i=Math.min(i,r);var a=performance.now();for(var o=0;o!==i;o++){n.internalStep(e);if(performance.now()-a>e*1e3){break}}this.time+=t;var s=this.time%e;var l=s/e;var u=S;var h=this.bodies;for(var c=0;c!==h.length;c++){var f=h[c];if(f.type!==v.STATIC&&f.sleepState!==v.SLEEPING){f.position.vsub(f.previousPosition,u);u.scale(l,u);f.position.vadd(u,f.interpolatedPosition)}else{f.interpolatedPosition.copy(f.position);f.interpolatedQuaternion.copy(f.quaternion)}}}};var M={type:"postStep"},A={type:"preStep"},R={type:"collide",body:null,contact:null},L=[],C=[],I=[],U=[],D=new i,O=new i,B=new i,P=new i,F=new i,z=new i,N=new i,k=new i,V=new i,G=new a,W=new a,H=new a,j=new i;b.prototype.internalStep=function(e){var t=this;this.dt=e;var r=this,i=this,a=this.contacts,o=I,s=U,l=this.numObjects(),u=this.bodies,h=this.solver,c=this.gravity,f=this.doProfiling,p=this.profile,d=v.DYNAMIC,m,_=this.constraints,g=C,y=c.norm(),x=c.x,b=c.y,w=c.z,T=0;if(f){m=performance.now()}for(T=0;T!==l;T++){var E=u[T];if(E.type&d){var S=E.force,D=E.mass;S.x+=D*x;S.y+=D*b;S.z+=D*w}}for(var T=0,O=this.subsystems.length;T!==O;T++){t.subsystems[T].update()}if(f){m=performance.now()}o.length=0;s.length=0;this.broadphase.collisionPairs(this,o,s);if(f){p.broadphase=performance.now()-m}var B=_.length;for(T=0;T!==B;T++){var P=_[T];if(!P.collideConnected){for(var F=o.length-1;F>=0;F-=1){if(P.bodyA===o[F]&&P.bodyB===s[F]||P.bodyB===o[F]&&P.bodyA===s[F]){o.splice(F,1);s.splice(F,1)}}}}this.collisionMatrixTick();if(f){m=performance.now()}var z=L;var N=a.length;for(T=0;T!==N;T++){z.push(a[T])}a.length=0;var k=this.frictionEquations.length;for(T=0;T!==k;T++){g.push(t.frictionEquations[T])}this.frictionEquations.length=0;this.narrowphase.getContacts(o,s,this,a,z,this.frictionEquations,g);if(f){p.narrowphase=performance.now()-m}if(f){m=performance.now()}for(var T=0;T<this.frictionEquations.length;T++){h.addEquation(t.frictionEquations[T])}var V=a.length;for(var G=0;G!==V;G++){var P=a[G];var E=P.bi,q=P.bj,X=P.si,Y=P.sj;var K;if(E.material&&q.material){K=t.getContactMaterial(E.material,q.material)||t.defaultContactMaterial}else{K=t.defaultContactMaterial}var Z=K.friction;if(E.material&&q.material){if(E.material.friction>=0&&q.material.friction>=0){Z=E.material.friction*q.material.friction}if(E.material.restitution>=0&&q.material.restitution>=0){P.restitution=E.material.restitution*q.material.restitution}}h.addEquation(P);if(E.allowSleep&&E.type===v.DYNAMIC&&E.sleepState===v.SLEEPING&&q.sleepState===v.AWAKE&&q.type!==v.STATIC){var Q=q.velocity.norm2()+q.angularVelocity.norm2();var J=Math.pow(q.sleepSpeedLimit,2);if(Q>=J*2){E._wakeUpAfterNarrowphase=true}}if(q.allowSleep&&q.type===v.DYNAMIC&&q.sleepState===v.SLEEPING&&E.sleepState===v.AWAKE&&E.type!==v.STATIC){var $=E.velocity.norm2()+E.angularVelocity.norm2();var ee=Math.pow(E.sleepSpeedLimit,2);if($>=ee*2){q._wakeUpAfterNarrowphase=true}}t.collisionMatrix.set(E,q,true);if(!t.collisionMatrixPrevious.get(E,q)){R.body=q;R.contact=P;E.dispatchEvent(R);R.body=E;q.dispatchEvent(R)}}if(f){p.makeContactConstraints=performance.now()-m;m=performance.now()}for(T=0;T!==l;T++){var E=u[T];if(E._wakeUpAfterNarrowphase){E.wakeUp();E._wakeUpAfterNarrowphase=false}}var B=_.length;for(T=0;T!==B;T++){var P=_[T];P.update();for(var F=0,te=P.equations.length;F!==te;F++){var re=P.equations[F];h.addEquation(re)}}h.solve(e,this);if(f){p.solve=performance.now()-m}h.removeAllEquations();var ne=Math.pow;for(T=0;T!==l;T++){var E=u[T];if(E.type&d){var ie=ne(1-E.linearDamping,e);var ae=E.velocity;ae.mult(ie,ae);var oe=E.angularVelocity;if(oe){var se=ne(1-E.angularDamping,e);oe.mult(se,oe)}}}this.dispatchEvent(A);for(T=0;T!==l;T++){var E=u[T];if(E.preStep){E.preStep.call(E)}}if(f){m=performance.now()}var le=W;var ue=H;var he=this.stepnumber;var ce=v.DYNAMIC|v.KINEMATIC;var fe=he%(this.quatNormalizeSkip+1)===0;var pe=this.quatNormalizeFast;var de=e*.5;var ve=n.types.PLANE,me=n.types.CONVEXPOLYHEDRON;for(T=0;T!==l;T++){var _e=u[T],ge=_e.force,ye=_e.torque;if(_e.type&ce&&_e.sleepState!==v.SLEEPING){var xe=_e.velocity,be=_e.angularVelocity,we=_e.position,Te=_e.quaternion,Ee=_e.invMass,Se=_e.invInertiaWorld;xe.x+=ge.x*Ee*e;xe.y+=ge.y*Ee*e;xe.z+=ge.z*Ee*e;if(_e.angularVelocity){Se.vmult(ye,j);j.mult(e,j);j.vadd(be,be)}we.x+=xe.x*e;we.y+=xe.y*e;we.z+=xe.z*e;if(_e.angularVelocity){le.set(be.x,be.y,be.z,0);le.mult(Te,ue);Te.x+=de*ue.x;Te.y+=de*ue.y;Te.z+=de*ue.z;Te.w+=de*ue.w;if(fe){if(pe){Te.normalizeFast()}else{Te.normalize()}}}if(_e.aabb){_e.aabbNeedsUpdate=true}if(_e.updateInertiaWorld){_e.updateInertiaWorld()}}}this.clearForces();this.broadphase.dirty=true;if(f){p.integrate=performance.now()-m}this.time+=e;this.stepnumber+=1;this.dispatchEvent(M);for(T=0;T!==l;T++){var E=u[T];var Me=E.postStep;if(Me){Me.call(E)}}if(this.allowSleep){for(T=0;T!==l;T++){u[T].sleepTick(t.time)}}};b.prototype.clearForces=function(){var e=this.bodies;var t=e.length;for(var r=0;r!==t;r++){var n=e[r],i=n.force,a=n.torque;n.force.set(0,0,0);n.torque.set(0,0,0)}}},{"../collision/AABB":3,"../collision/ArrayCollisionMatrix":4,"../collision/NaiveBroadphase":7,"../collision/Ray":9,"../collision/RaycastResult":10,"../equations/ContactEquation":19,"../equations/FrictionEquation":21,"../material/ContactMaterial":24,"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Shape":43,"../solver/GSSolver":46,"../utils/EventTarget":49,"../utils/TupleDictionary":52,"../utils/Vec3Pool":54,"./Narrowphase":55}]},{},[2])(2)})});var lv=1/60;var uv=3;var hv=function(e){function t(){e.call(this);this.gravity.set(0,-9.82,0)}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.setGravity=function e(t,r,n){this.gravity.set(t,r,n)};t.prototype.add=function e(t){this.addBody(t.collider)};t.prototype.remove=function e(t){this.removeBody(t.collider)};t.prototype.step=function t(r){e.prototype.step.call(this,lv,r,uv)};return t}(sv.World);var cv={ENGINE_BUILTIN:0,ENGINE_CANNON:1};var fv=1/60;var pv=3;var dv=function(e){function t(){e.call(this);this._engine=cv.ENGINE_CANNON;this._fullSimulation=false}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.init=function e(){switch(this._engine){case cv.ENGINE_BUILTIN:this.world=new iv;break;case cv.ENGINE_CANNON:this.world=new hv;break}};t.prototype.add=function e(t){this.world.add(t)};t.prototype.remove=function e(t){this.world.remove(t)};t.prototype.postTick=function e(){if(!this._fullSimulation){return}this.world.step(fv,this._app.deltaTime,pv)};return t}($i);Object.assign(dv,cv);var vv=function e(){};vv.prototype.onDestroy=function e(){};var mv=Lt.zero();var _v=Ut.create();function gv(e){return Math.max(Math.max(e.x,e.y),e.z)}var yv=function(e){function t(t){var r=this;e.call(this,t);this._entity=t._entity;this._world=t._system.world;this._size=Lt.new(1,1,1);this.shapeType=t.type;this.shape=this.createShape(t);this.addShape(this.shape,(new sv.Vec3).copy(t.center));this.addEventListener("collide",function(e){r._entity.emit("collide",e)});this.updateIn=this.updateIn.bind(this);this.updateOut=this.updateOut.bind(this);this.updateIn()}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.setUpdateMode=function e(t){if(t.in){this._world.addEventListener("preStep",this.updateIn)}else{this._world.removeEventListener("preStep",this.updateIn)}if(t.out){this._world.addEventListener("postStep",this.updateOut)}else{this._world.removeEventListener("postStep",this.updateOut)}};t.prototype.createShape=function e(t){this._entity.getWorldScale(mv);switch(t.type){case"box":Lt.scale(mv,Lt.mul(mv,mv,t.size),.5);return new sv.Box(new sv.Vec3(mv.x,mv.y,mv.z));case"sphere":return new sv.Sphere(t.radius*gv(mv));default:return new sv.Shape}};t.prototype.setFixedRotation=function e(t){this.fixedRotation=t;this.updateMassProperties()};t.prototype.setIsKinematic=function e(t){this._isKinematic=t;if(t){this.type=sv.Body.KINEMATIC}else{this.type=this.mass<=0?sv.Body.STATIC:sv.Body.DYNAMIC}if(this.type!==sv.Body.STATIC){this.setUpdateMode({out:true})}};t.prototype.setMass=function e(t){this.mass=t;this.setIsKinematic(this._isKinematic);this.updateMassProperties()};t.prototype.setCenter=function e(t){this.shapeOffsets[0].set(t.x,t.y,t.z);this.updateBoundingRadius()};t.prototype.setSize=function e(t){if(this.shapeType!="box"){return}if(!t){t=this._size}this._entity.getWorldScale(mv);Lt.scale(mv,Lt.mul(mv,mv,t),.5);this.shape.halfExtents.set(mv.x,mv.y,mv.z);this.shape.updateConvexPolyhedronRepresentation();this.shape.updateBoundingSphereRadius();this.updateBoundingRadius();this._size=t};t.prototype.setRadius=function e(t){if(this.shapeType!="sphere"){return}this._entity.getWorldScale(mv);this.shape.radius=t*gv(mv);this.shape.updateBoundingSphereRadius();this.updateBoundingRadius()};t.prototype.manualUpdate=function e(){this.updateIn();this.setSize()};t.prototype.updateIn=function e(){this._entity._getWorldPosAndRot(mv,_v);this.position.set(mv.x,mv.y,mv.z);if(!this.fixedRotation){this.quaternion.set(_v.x,_v.y,_v.z,_v.w)}};t.prototype.updateOut=function e(){this._entity.setWorldPos(this.position);if(!this.fixedRotation){this._entity.setWorldRot(this.quaternion)}};return t}(sv.Body);var xv=function(e){function t(){e.call(this)}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.onInit=function e(){switch(this._system._engine){case dv.ENGINE_BUILTIN:this.collider=new vv(this);break;case dv.ENGINE_CANNON:this.collider=new yv(this);break}this.type=this._type;this.mass=this._mass;this.isKinematic=this._isKinematic;this.center=this._center;this.size=this._size;this.radius=this._radius;this._system.add(this)};t.prototype.onDestroy=function e(){this._system.remove(this)};return t}(Yi);xv.schema={type:{type:"string",default:"box"},isKinematic:{type:"boolean",default:false,set:function e(t){this._isKinematic=t;this.collider.setIsKinematic(t);if(t){this._system._fullSimulation=true}}},mass:{type:"number",default:0,set:function e(t){this._mass=t;this.collider.setMass(t);if(t>0){this._system._fullSimulation=true}}},center:{type:"vec3",default:[0,0,0],set:function e(t){this._center=t;this.collider.setCenter(t)}},size:{type:"vec3",default:[1,1,1],set:function e(t){this._size=t;this.collider.setSize(t)}},radius:{type:"number",default:1,set:function e(t){this._radius=t;this.collider.setRadius(t)}}};var bv=function(e){function t(){e.call(this);this._model=new Ui.Model;this._attachedCamera=null;this.material=this._material;this.cubeMap=this._cubeMap}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.onInit=function e(){this._model.setNode(this._entity);var t=Ui.createIA(this._app.device,Ao(2,2,2,{widthSegments:1,heightSegments:1,lengthSegments:1}));this._model.setInputAssembler(t);if(this._material===null){this._material=new us;this._material.effect=this._app.assets.get("builtin-effect-skybox")}this._updateMaterialParams();this._model.setEffect(this._material.effectInst)};t.prototype.onEnable=function e(){if(this._entity!=null){var t=this._entity.getComp("Camera");if(t!=null&&t._clearFlags&Ui.CLEAR_SKYBOX){this._attachedCamera=t._camera;this._attachedCamera._clearModel=this._model}}};t.prototype.onDisable=function e(){if(this._attachedCamera!=null){this._attachedCamera._clearModel=null;this._attachedCamera=null}};t.prototype._updateMaterialParams=function e(){if(this._material===null||this._material===undefined){return}if(this._cubeMap!==null&&this._cubeMap!==undefined){this._material.setProperty("cubeMap",this._cubeMap)}};return t}(Yi);bv.schema={material:{type:"asset",default:null,set:function e(t){this._material=t;if(!this._material){return}this._updateMaterialParams();this._model.setEffect(t.effectInst)}},cubeMap:{type:"asset",default:null,set:function e(t){this._cubeMap=t;this._updateMaterialParams()}}};var wv=function e(t){this.particleSystem=t;this.position=Lt.new(0,0,0);this.velocity=Lt.new(0,0,0);this.animatedVelocity=Lt.new(0,0,0);this.ultimateVelocity=Lt.new(0,0,0);this.angularVelocity=Lt.new(0,0,0);this.axisOfRotation=Lt.new(0,0,0);this.rotation=Lt.new(0,0,0);this.startSize=Lt.new(0,0,0);this.size=Lt.zero();this.startColor=Ft.new(1,1,1,1);this.color=Ft.create();this.randomSeed=0;this.remainingLifetime=0;this.startLifetime=0;this.emitAccumulator0=0;this.emitAccumulator1=0;this.frameIndex=0};var Tv=function e(){};Tv.schema={color:{type:"color3",default:[1,1,1]},time:{type:"number",default:0}};var Ev=function e(){};Ev.schema={alpha:{type:"number",default:1},time:{type:"number",default:0}};var Sv=function e(){this._rgb=Pt.new(1,1,1);this._rgba=Ft.new(1,1,1,1)};Sv.prototype.setKeys=function e(t,r){this._colorKeys=t;this._alphaKeys=r};Sv.prototype.sortKeys=function e(){if(this._colorKeys.length>1){this._colorKeys.sort(function(e,t){return e.time-t.time})}if(this._alphaKeys.length>1){this._alphaKeys.sort(function(e,t){return e.time-t.time})}};Sv.prototype.getRGB=function e(t){var r=this;if(this._colorKeys.length>1){t=rt(t,1);for(var n=1;n<this._colorKeys.length;++n){var i=r._colorKeys[n-1].time;var a=r._colorKeys[n].time;if(t>=i&&t<a){if(r._mode==="fixed"){return r._colorKeys[n].color}var o=(t-i)/(a-i);Pt.lerp(r._rgb,r._colorKeys[n-1].color,r._colorKeys[n].color,o);return r._rgb}}console.warn("something went wrong. can not get gradient color.")}else if(this._colorKeys.length===1){return this._colorKeys[0].color}else{return Pt.set(this._rgb,1,1,1)}};Sv.prototype.getAlpha=function e(t){var r=this;if(this._alphaKeys.length>1){t=rt(t,1);for(var n=1;n<this._alphaKeys.length;++n){var i=r._alphaKeys[n-1].time;var a=r._alphaKeys[n].time;if(t>=i&&t<a){if(r._mode==="fixed"){return r._alphaKeys[n].alpha}var o=(t-i)/(a-i);return r._alphaKeys[n-1].alpha*(1-o)+r._alphaKeys[n].alpha*o}}console.warn("something went wrong. can not get gradient alpha.")}else if(this._alphaKeys.length===1){return this._alphaKeys[0].alpha}else{return 1}};Sv.prototype.evaluate=function e(t){var r=this.getRGB(t);Ft.set(this._rgba,r.r,r.g,r.b,this.getAlpha(t));return this._rgba};Sv.prototype.randomColor=function e(){var t=this._colorKeys[Math.trunc(Math.random()*this._colorKeys.length)];var r=this._alphaKeys[Math.trunc(Math.random()*this._alphaKeys.length)];Ft.set(this._rgba,t.r,t.g,t.b,r);return this._rgba};Sv.schema={colorKeys:{type:"ColorKey",default:[],array:true},alphaKeys:{type:"AlphaKey",default:[],array:true},mode:{type:"enums",default:"blend",options:["blend","fixed"]}};var Mv=function e(){};Mv.prototype.evaluate=function e(t,r){switch(this._mode){case"constant":return this._constant;case"curve":return this._curve.evaluate(t)*this._multiplier;case"twoCurves":return qe(this._curveMin.evaluate(t),this._curveMax.evaluate(t),r)*this._multiplier;case"twoConstants":return qe(this._constantMin,this._constantMax,r)}};Mv.schema={mode:{type:"enums",default:"constant",options:["constant","curve","twoCurves","twoConstants"]},curve:{type:"AnimationCurve",default:null},curveMin:{type:"AnimationCurve",default:null},curveMax:{type:"AnimationCurve",default:null},constant:{type:"number",default:0},constantMin:{type:"number",default:0},constantMax:{type:"number",default:0},multiplier:{type:"number",default:1}};var Av=function e(){};Av.prototype.evaluate=function e(t,r){switch(this._mode){case"color":return this._color;case"twoColors":return Ft.set(this._color,qe(this._colorMin.r,this._colorMax.r,r),qe(this._colorMin.g,this._colorMax.g,r),qe(this._colorMin.b,this._colorMax.b,r),qe(this._colorMin.a,this._colorMax.a,r));case"randomColor":return this._gradient.randomColor();case"gradient":return this._gradient.evaluate(t);case"twoGradients":this._colorMin=this._gradientMin.evaluate(t);this._colorMax=this._gradientMax.evaluate(t);return Ft.set(this._color,qe(this._colorMin.r,this._colorMax.r,r),qe(this._colorMin.g,this._colorMax.g,r),qe(this._colorMin.b,this._colorMax.b,r),qe(this._colorMin.a,this._colorMax.a,r))}};Av.schema={mode:{type:"enums",default:"color",options:["color","gradient","twoColors","twoGradients","randomColor"]},color:{type:"color4",default:[1,1,1,1]},colorMin:{type:"color4",default:[1,1,1,1]},colorMax:{type:"color4",default:[1,1,1,1]},gradient:{type:"Gradient",default:null},gradientMin:{type:"Gradient",default:null},gradientMax:{type:"Gradient",default:null}};var Rv={position:Lt.zero(),uv:Ct.zero(),uv0:Rt.zero(),color:Ct.zero(),color0:Ct.zero(),normal:Lt.zero(),tangent:Lt.zero()};var Lv={position:{name:Me.ATTR_POSITION,type:Me.ATTR_TYPE_FLOAT32,num:3},uv:{name:Me.ATTR_UV,type:Me.ATTR_TYPE_FLOAT32,num:3},uv0:{name:Me.ATTR_UV0,type:Me.ATTR_TYPE_FLOAT32,num:2},color:{name:Me.ATTR_COLOR,type:Me.ATTR_TYPE_FLOAT32,num:4},normal:{name:Me.ATTR_NORMAL,type:Me.ATTR_TYPE_FLOAT32,num:3},tangent:{name:Me.ATTR_TANGENT,type:Me.ATTR_TYPE_FLOAT32,num:3},custom1:{name:Me.ATTR_UV1,type:Me.ATTR_TYPE_FLOAT32,num:2},custom2:{name:Me.ATTR_UV2,type:Me.ATTR_TYPE_FLOAT32,num:2}};var Cv=[0,0,1,0,0,1,1,1];var Iv=function e(){this._model=null;this._vertAttrs=[];this._vertAttrFlags={position:true,uv:true,uv0:true,color:true,normal:false,tangent:false,custom1:false,custom2:false,color0:false};this.frameTile=Rt.new(1,1)};Iv.prototype.setVertexAtrributes=function e(t){var r=this;for(var n in r._vertAttrFlags){r._vertAttrFlags[n]=false}for(var i=0;i<t.length;++i){var a=Lv[t[i]];if(a!==undefined){r._vertAttrs.push(a);r._vertAttrFlags[t[i]]=true}else{console.error("vertex attribute name wrong.")}}this._model.setVertexAttributes(this._vertAttrs)};Iv.prototype.onInit=function e(t){this.particleSystem=t;if(this._material===null||this._material===undefined){this._material=new us;this._material.effect=t._app.assets.get("builtin-effect-particle-premultiply-blend")}this._updateMaterialParams();this._updateModel()};Iv.prototype._updateMaterialParams=function e(){if(!this.particleSystem){return}if(this.particleSystem._simulationSpace==="world"){this._material.define("USE_WORLD_SPACE",true)}else{this._material.define("USE_WORLD_SPACE",false)}if(this._renderMode==="billboard"){this._material.define("USE_BILLBOARD",true);this._material.define("USE_STRETCHED_BILLBOARD",false);this._material.define("USE_HORIZONTAL_BILLBOARD",false);this._material.define("USE_VERTICAL_BILLBOARD",false)}else if(this._renderMode==="stretchedBillboard"){this._material.define("USE_BILLBOARD",false);this._material.define("USE_STRETCHED_BILLBOARD",true);this._material.define("USE_HORIZONTAL_BILLBOARD",false);this._material.define("USE_VERTICAL_BILLBOARD",false);this._material.setProperty("velocityScale",this._velocityScale);this._material.setProperty("lengthScale",this._lengthScale)}else if(this._renderMode==="horizontalBillboard"){this._material.define("USE_BILLBOARD",false);this._material.define("USE_STRETCHED_BILLBOARD",false);this._material.define("USE_HORIZONTAL_BILLBOARD",true);this._material.define("USE_VERTICAL_BILLBOARD",false)}else if(this._renderMode==="verticalBillboard"){this._material.define("USE_BILLBOARD",false);this._material.define("USE_STRETCHED_BILLBOARD",false);this._material.define("USE_HORIZONTAL_BILLBOARD",false);this._material.define("USE_VERTICAL_BILLBOARD",true)}else{console.warn("particle system renderMode "+this._renderMode+" not support.")}if(this.particleSystem.textureAnimationModule.enable){this._material.setProperty("frameTile",Rt.set(this.frameTile,this.particleSystem.textureAnimationModule.numTilesX,this.particleSystem.textureAnimationModule.numTilesY))}else{this._material.setProperty("frameTile",this.frameTile)}};Iv.prototype._updateModel=function e(){if(!this.particleSystem){return}if(this._model===null){this._model=new Ui.ParticleBatchModel(this.particleSystem._app.device,this.particleSystem._capacity);this._model.setNode(this.particleSystem._entity)}this._model.setEffect(this._material?this._material.effectInst:null);if(this._renderMode==="stretchedBillboard"){this._model.enableStretchedBillboard();this._vertAttrFlags.color0=true}else{this._model.disableStretchedBillboard();this._vertAttrFlags.color0=false}};Iv.prototype._updateRenderData=function e(){var t=this;var r=0;for(var n=0;n<this.particleSystem._particles.length;++n){var i=t.particleSystem._particles.data[n];if(t.particleSystem.textureAnimationModule.enable){Rv.uv.z=i.frameIndex}else{Rv.uv.z=0}for(var a=0;a<4;++a){var o=[];if(t._vertAttrFlags.position){o.push(Lt.set(Rv.position,i.position.x,i.position.y,i.position.z))}if(t._vertAttrFlags.uv){Rv.uv.x=Cv[2*a];Rv.uv.y=Cv[2*a+1];o.push(Rv.uv)}if(t._vertAttrFlags.uv0){o.push(Rt.set(Rv.uv0,i.size.x,i.rotation.x))}if(t._vertAttrFlags.color){o.push(Ct.set(Rv.color,i.color.r,i.color.g,i.color.b,i.color.a))}if(t._vertAttrFlags.custom1){o.push(t._customData1)}if(t._vertAttrFlags.custom2){o.push(t._customData2)}if(t._vertAttrFlags.color0){o.push(Lt.set(Rv.color0,i.ultimateVelocity.x,i.ultimateVelocity.y,i.ultimateVelocity.z))}t._model.addParticleVertexData(r++,o)}}this._model.updateIA(this.particleSystem._particles.length*6)};Iv.schema={material:{type:"asset",default:null,set:function e(t){if(this._material===t){return}this._material=t;this._updateMaterialParams();this._updateModel()},parse:function e(t,r){if(typeof r==="string"){var n=new us;n.copy(t.assets.get(r));return n}return r}},renderMode:{type:"enums",default:"billboard",options:["billboard","stretchedBillboard","horizontalBillboard","verticalBillboard","mesh"],set:function e(t){if(this._renderMode===t){return}this._renderMode=t;this._updateMaterialParams();this._updateModel()}},velocityScale:{type:"number",default:1,set:function e(t){this._velocityScale=t;this._updateMaterialParams();this._updateModel()}},lengthScale:{type:"number",default:.4,set:function e(t){this._lengthScale=t;this._updateMaterialParams();this._updateModel()}}};var Uv=function e(){};Uv.prototype.animate=function e(t){if(!this._separateAxes){Lt.scale(t.size,t.startSize,this._size.evaluate(1-t.remainingLifetime/t.startLifetime,t.randomSeed))}};Uv.schema={enable:{type:"boolean",default:false},separateAxes:{type:"boolean",default:false},size:{type:"CurveRange",default:null},x:{type:"CurveRange",default:null},y:{type:"CurveRange",default:null},z:{type:"CurveRange",default:null}};var Dv=function e(){};Dv.prototype.animate=function e(t){if(this._enable){Ft.multiply(t.color,t.startColor,this._color.evaluate(1-t.remainingLifetime/t.startLifetime,t.randomSeed))}};Dv.schema={enable:{type:"boolean",default:false},color:{type:"GradientRange",default:null}};var Ov=Lt.new(0,0,-1);function Bv(e,t,r,n){if(t!==e){if(e==="world"){Bt.getRotation(n,r)}else{Bt.invert(r,r);Bt.getRotation(n,r)}return true}else{Ut.identity(n);return false}}function Pv(e,t){Rt.set(e,Math.cos(t),Math.sin(t))}function Fv(e){var t=Ze(-1,1);var r=Ze(0,2*Math.PI);var n=Math.sqrt(1-t*t);var i=n*Math.cos(r);var a=n*Math.sin(r);Lt.set(e,i,a,t)}function zv(e,t,r){Fv(e);Lt.scale(e,e,t+(r-t)*Ke())}function Nv(e,t,r,n){Pv(e,n);Lt.scale(e,e,t+(r-t)*Ke())}function kv(e,t){Lt.set(e,Ze(-t.x,t.x),Ze(-t.y,t.y),Ze(-t.z,t.z))}function Vv(e){for(var t=0;t<e.length;t++){var r=t+Qe(0,e.length-t);var n=e[r];e[r]=e[t];e[t]=n}}function Gv(){var e=Ze(-1,1);e===0?e++:e;return lt(e)}var Wv=function e(){this.rotation=Ut.create()};Wv.prototype.update=function e(t,r){this.needTransform=Bv(t,this._space,r,this.rotation)};Wv.prototype.animate=function e(t){var r=1-t.remainingLifetime/t.startLifetime;var n=Lt.new(this._x.evaluate(r,t.randomSeed),this._y.evaluate(r,t.randomSeed),this._z.evaluate(r,t.randomSeed));if(this.needTransform){Lt.transformQuat(n,n,this.rotation)}Lt.add(t.animatedVelocity,t.animatedVelocity,n);Lt.add(t.ultimateVelocity,t.velocity,t.animatedVelocity);Lt.scale(t.ultimateVelocity,t.ultimateVelocity,this._speedModifier.evaluate(1-t.remainingLifetime/t.startLifetime,t.randomSeed))};Wv.schema={enable:{type:"boolean",default:false},x:{type:"CurveRange",default:null},y:{type:"CurveRange",default:null},z:{type:"CurveRange",default:null},speedModifier:{type:"CurveRange",default:null},space:{type:"enums",options:["local","world"],default:"local"}};var Hv=function e(){this.rotation=Ut.create()};Hv.prototype.update=function e(t,r){this.needTransform=Bv(t,this._space,r,this.rotation)};Hv.prototype.animate=function e(t,r){var n=1-t.remainingLifetime/t.startLifetime;var i=Lt.new(this._x.evaluate(n,t.randomSeed),this._y.evaluate(n,t.randomSeed),this._z.evaluate(n,t.randomSeed));if(this.needTransform){Lt.transformQuat(i,i,this.rotation)}Lt.scaleAndAdd(t.velocity,t.velocity,i,r)};Hv.schema={enable:{type:"boolean",default:false},x:{type:"CurveRange",default:null},y:{type:"CurveRange",default:null},z:{type:"CurveRange",default:null},space:{type:"enums",default:"local",options:["local","world"]},randomized:{type:"boolean",default:false}};var jv=function e(){};jv.prototype.animate=function e(t){var r=1-t.remainingLifetime/t.startLifetime;var n=Lt.zero();if(this._separateAxes){Lt.set(n,qv(t.ultimateVelocity.x,this._limitX.evaluate(r,t.randomSeed),this._dampen),qv(t.ultimateVelocity.y,this._limitY.evaluate(r,t.randomSeed),this._dampen),qv(t.ultimateVelocity.z,this._limitZ.evaluate(r,t.randomSeed),this._dampen))}else{Lt.normalize(n,t.ultimateVelocity);Lt.scale(n,n,qv(Lt.magnitude(t.ultimateVelocity),this._limit.evaluate(r,t.randomSeed),this._dampen))}Lt.copy(t.ultimateVelocity,n)};function qv(e,t,r){var n=Math.sign(e);var i=Math.abs(e);if(i>t){i=qe(i,t,r)}return i*n}jv.schema={enable:{type:"boolean",default:false},limitX:{type:"CurveRange",default:null},limitY:{type:"CurveRange",default:null},limitZ:{type:"CurveRange",default:null},limit:{type:"CurveRange",default:null},dampen:{type:"number",default:0},separateAxes:{type:"boolean",default:false},space:{type:"enums",default:"local",options:["local","world"]},drag:{type:"CurveRange",default:null},multiplyDragByParticleSize:{type:"boolean",default:false},multiplyDragByParticleVelocity:{type:"boolean",default:false}};var Xv=function e(){};Xv.prototype.animate=function e(t,r){var n=1-t.remainingLifetime/t.startLifetime;if(!this._separateAxes){t.rotation.x+=this._z.evaluate(n,t.randomSeed)*r}else{}};Xv.schema={enable:{type:"boolean",default:false},separateAxes:{type:"boolean",default:false,set:function e(t){if(!t){this._separateAxes=t}else{console.error("rotation overtime separateAxes is not supported!")}}},x:{type:"CurveRange",default:null},y:{type:"CurveRange",default:null},z:{type:"CurveRange",default:null}};var Yv=function e(){};Yv.prototype.animate=function e(t){var r=1-t.remainingLifetime/t.startLifetime;var n=this._startFrame.evaluate(r,t.randomSeed)/(this._numTilesX*this._numTilesY);if(this._animation=="wholeSheet"){t.frameIndex=rt(this._cycleCount*(this._frameOverTime.evaluate(r,t.randomSeed)+n),1)}else if(this._animation=="singleRow"){var i=1/this._numTilesY;if(this._randomRow){var a=rt(this._cycleCount*(this._frameOverTime.evaluate(r,t.randomSeed)+n),1);var o=Math.floor(Math.random()*this._numTilesY);var s=o*i;var l=s+i;t.frameIndex=qe(s,l,a)}else{var u=this._rowIndex*i;var h=u+i;t.frameIndex=qe(u,h,rt(this._cycleCount*(this._frameOverTime.evaluate(r,t.randomSeed)+n),1))}}};Yv.schema={enable:{type:"boolean",default:false},mode:{type:"enums",options:["grid","sprites"],default:"grid",set:function e(t){if(t==="sprites"){console.error("particle texture animation's sprites is not supported!");return}}},numTilesX:{type:"number",default:0},numTilesY:{type:"number",default:0},animation:{type:"enums",options:["wholeSheet","singleRow"],default:"wholeSheet"},frameOverTime:{type:"CurveRange",default:null},startFrame:{type:"CurveRange",default:null},cycleCount:{type:"number",default:0},flipU:{type:"number",default:0,set:function e(t){console.error("particle texture animation's flipU is not supported!")}},flipV:{type:"number",default:0,set:function e(t){console.error("particle texture animation's flipV is not supported!")}},uvChannelMask:{type:"number",default:-1,set:function e(t){console.error("particle texture animation's uvChannelMask is not supported!")}},randomRow:{type:"boolean",default:false},rowIndex:{type:"number",default:0}};var Kv=Lt.zero();var Zv=new Array;var Qv=Lt.new(.5,.5,.5);var Jv=function e(){this.mat=Bt.create();this.quat=Ut.create()};Jv.prototype.onInit=function e(t){this.constructMat();this.particleSystem=t;this.lastTime=t._time;this.totalAngle=0};Jv.prototype.constructMat=function e(){Ut.fromEuler(this.quat,this._rotation.x,this._rotation.y,this._rotation.z);Bt.fromRTS(this.mat,this.quat,this._position,this._scale)};Jv.prototype.emit=function e(t){switch(this._shapeType){case"box":rm(this._emitFrom,this._boxThickness,t.position,t.velocity);break;case"circle":nm(this._radius,this._radiusThickness,this.generateArcAngle(),t.position,t.velocity);break;case"cone":tm(this._emitFrom,this._radius,this._radiusThickness,this.generateArcAngle(),this._angle,this._length,t.position,t.velocity);break;case"sphere":$v(this._emitFrom,this._radius,this._radiusThickness,t.position,t.velocity);break;case"hemisphere":em(this._emitFrom,this._radius,this._radiusThickness,t.position,t.velocity);break;default:console.warn(this._shapeType+" shapeType is not supported by ShapeModule.")}if(this._randomPositionAmount>0){t.position.x+=Ze(-this._randomPositionAmount,this._randomPositionAmount);t.position.y+=Ze(-this._randomPositionAmount,this._randomPositionAmount);t.position.z+=Ze(-this._randomPositionAmount,this._randomPositionAmount)}Lt.transformQuat(t.velocity,t.velocity,this.quat);Lt.transformMat4(t.position,t.position,this.mat);if(this._sphericalDirectionAmount>0){var r=Lt.normalize(Kv,t.position);Lt.lerp(t.velocity,t.velocity,r,this._sphericalDirectionAmount)}this.lastTime=this.particleSystem._time};Jv.prototype.generateArcAngle=function e(){if(this._arcMode==="random"){return Ze(0,this._arc)}var t=this.totalAngle+2*Math.PI*this._arcSpeed.evaluate(this.particleSystem._time)*(this.particleSystem._time-this.lastTime);this.totalAngle=t;if(this._arcSpread!==0){t=Math.floor(t/(this._arc*this._arcSpread))*this._arc*this._arcSpread}switch(this._arcMode){case"loop":return rt(t,this._arc);case"pingPong":return nt(t,this._arc)}};function $v(e,t,r,n,i){switch(e){case"volume":zv(n,t*(1-r),t);Lt.copy(i,n);Lt.normalize(i,i);break;case"shell":Fv(n);Lt.scale(n,t);Lt.copy(i,n);break;default:console.warn(e+" is not supported for sphere emitter.")}}function em(e,t,r,n,i){switch(e){case"volume":zv(n,t*(1-r),t);if(n.z>0){n.z*=-1}Lt.copy(i,n);Lt.normalize(i,i);break;case"shell":Fv(n);Lt.scale(n,t);if(n.z<0){n.z*=-1}Lt.copy(i,n);break;default:console.warn(e+" is not supported for hemisphere emitter.")}}function tm(e,t,r,n,i,a,o,s){switch(e){case"base":Nv(o,t*(1-r),t,n);Rt.scale(s,o,Math.sin(i));s.z=-Math.cos(i)*t;o.z=0;break;case"shell":Pv(o,n);Rt.scale(s,o,Math.sin(i));s.z=-Math.cos(i);Rt.scale(o,o,t);o.z=0;break;case"volume":Nv(o,t*(1-r),t,n);Rt.scale(s,o,Math.sin(i));s.z=-Math.cos(i)*t;Lt.normalize(s,s);o.z=0;Lt.add(o,o,Lt.scale(Kv,s,a*Ke()/-s.z));break;default:console.warn(e+" is not supported for cone emitter.")}}function rm(e,t,r,n){switch(e){case"volume":kv(r,Qv);break;case"shell":Zv.splice(0,Zv.length);Zv.push(Ze(-.5,.5));Zv.push(Ze(-.5,.5));Zv.push(Gv()*.5);Vv(Zv);im(Zv,t);Lt.set(r,Zv[0],Zv[1],Zv[2]);break;case"edge":Zv.splice(0,Zv.length);Zv.push(Ze(-.5,.5));Zv.push(Gv()*.5);Zv.push(Gv()*.5);Vv(Zv);im(Zv,t);Lt.set(r,Zv[0],Zv[1],Zv[2]);break;default:console.warn(e+" is not supported for box emitter.")}Lt.copy(n,Ov)}function nm(e,t,r,n,i){Nv(n,e*(1-t),e,r);Lt.normalize(i,n)}function im(e,t){if(t.x>0){e[0]+=.5*Ze(-t.x,t.x);e[0]=He(e[0],-.5,.5)}if(t.y>0){e[1]+=.5*Ze(-t.y,t.y);e[1]=He(e[0],-.5,.5)}if(t.z>0){e[2]+=.5*Ze(-t.z,t.z);e[2]=He(e[0],-.5,.5)}}Jv.schema={enable:{type:"boolean",default:false},shapeType:{type:"enums",options:["box","circle","cone","sphere","hemisphere"],default:"box"},emitFrom:{type:"enums",options:["base","edge","shell","volume"],default:"base"},position:{type:"vec3",default:[0,0,0],set:function e(t){this._position=t;this.constructMat()}},rotation:{type:"vec3",default:[0,0,0],set:function e(t){this._rotation=t;this.constructMat()}},scale:{type:"vec3",default:[1,1,1],set:function e(t){this._scale=t;this.constructMat()}},alignToDirection:{type:"boolean",default:false},randomDirectionAmount:{type:"number",default:0},sphericalDirectionAmount:{type:"number",default:0},randomPositionAmount:{type:"number",default:0},radius:{type:"number",default:0},radiusThickness:{type:"number",default:1},arc:{type:"number",default:0},arcMode:{type:"enums",options:["random","loop","pingPong"],default:"random"},arcSpread:{type:"number",default:0},arcSpeed:{type:"CurveRange",default:null},angle:{type:"number",default:0},length:{type:"number",default:0},boxThickness:{type:"vec3",default:[0,0,0]}};var am=function e(){this._remainingCount=1;this._curTime=0};am.prototype.update=function e(t,r){if(t._loop&&this._remainingCount===0){this._remainingCount=this._repeatCount;this._curTime=this._time}if(this._remainingCount>0){var n=rt(t._time-t._startDelay.evaluate(),t._duration)-r;n=n>0?n:0;var i=rt(t.time-t._startDelay.evaluate(),t._duration);if(this._curTime>=n&&this._curTime<i){t.emit(this._count.evaluate(this._curTime/t._duration));this._curTime+=this._repeatInterval;--this._remainingCount}}};am.schema={time:{type:"number",default:0,set:function e(t){this._time=t;this._curTime=t}},minCount:{type:"int",default:30},maxCount:{type:"int",default:30},repeatCount:{type:"number",default:1,set:function e(t){this._repeatCount=t;this._remainingCount=t}},repeatInterval:{type:"number",default:1},count:{type:"CurveRange",default:null}};da.registerClass("Burst",am);da.registerClass("ColorKey",Tv);da.registerClass("AlphaKey",Ev);da.registerClass("Gradient",Sv);da.registerClass("GradientRange",Av);da.registerClass("CurveRange",Mv);da.registerClass("SizeOvertimeModule",Uv);da.registerClass("ColorOverLifetimeModule",Dv);da.registerClass("ParticleSystemRenderer",Iv);da.registerClass("VelocityOvertimeModule",Wv);da.registerClass("ForceOvertimeModule",Hv);da.registerClass("LimitVelocityOvertimeModule",jv);da.registerClass("RotationOvertimeModule",Xv);da.registerClass("TextureAnimationModule",Yv);da.registerClass("ShapeModule",Jv);var om=Bt.create();var sm=function(e){function t(){e.call(this);this._isPlaying=false;this._isPaused=false;this._isStopped=true;this._isEmitting=false;this._time=0;this._emitRateTimeCounter=0;this._emitRateDistanceCounter=0;this._oldWPos=Lt.zero();this._curWPos=Lt.zero();this._customData1=Rt.zero();this._customData2=Rt.zero();this._subEmitters=[];this._vertAttrs=[];this._vertAttrFlags={position:true,uv:true,uv0:true,color:true,normal:false,tangent:false,custom1:false,custom2:false,color0:false}}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;var r={isPlaying:{configurable:true},isPaused:{configurable:true},isStopped:{configurable:true},isEmitting:{configurable:true},time:{configurable:true}};t.prototype.onInit=function e(){var t=this;this._particles=new on(function(){return new wv(t)},this._capacity);this._renderer.onInit(this);this._shapeModule.onInit(this);this._entity.getWorldPos(this._oldWPos);Lt.copy(this._curWPos,this._oldWPos);this._system.add(this)};t.prototype.onDestroy=function e(){this._renderer._model.destroy();this._system.remove(this)};t.prototype.onEnable=function e(){this._app.scene.addModel(this._renderer._model);if(this._playOnAwake){this.play()}};t.prototype.onDisable=function e(){this._app.scene.removeModel(this._renderer._model)};t.prototype.play=function e(){if(this._isPaused){this._isPaused=false}if(this._isStopped){this._isStopped=false}this._time=0;this._emitRateTimeCounter=0;this._emitRateDistanceCounter=0;this._isPlaying=true;if(this._prewarm){this._prewarmSystem()}};t.prototype.pause=function e(){if(this._isStopped){console.warn("pause(): particle system is already stopped.");return}if(this._isPlaying){this._isPlaying=false}this._isPaused=true};t.prototype.stop=function e(){if(this._isPlaying){this._isPlaying=false}if(this._isPaused){this._isPaused=false}this.clear();this._time=0;this._emitRateTimeCounter=0;this._emitRateDistanceCounter=0;this._isStopped=true};t.prototype.clear=function e(){this._particles.reset();this._renderer._model.clear()};t.prototype.emit=function e(t,r){var n=this;if(r===void 0)r=null;for(var i=0;i<t;++i){if(n._particles.length>=n._capacity){return}var a=n._particles.add();var o=Je(Qe(0,ot));if(n._shapeModule.enable){n._shapeModule.emit(a)}else{Lt.set(a.position,0,0,0);Lt.copy(a.velocity,Ov)}Lt.scale(a.velocity,a.velocity,n._startSpeed.evaluate(n._time/n._duration,o));switch(n._simulationSpace){case"local":break;case"world":{n._entity.getWorldMatrix(om);Lt.transformMat4(a.position,a.position,om);var s=Ut.create();n._entity.getWorldRot(s);Lt.transformQuat(a.velocity,a.velocity,s)}break;case"custom":break}Lt.set(a.rotation,n._startRotation.evaluate(n._time/n._duration,o),0,0);Lt.set(a.startSize,n._startSize.evaluate(n._time/n._duration,o),0,0);Lt.copy(a.size,a.startSize);Ft.copy(a.startColor,n._startColor.evaluate(n._time/n._duration,o));Ft.copy(a.color,a.startColor);a.startLifetime=n._startLifetime.evaluate(n._time/n._duration,o);a.remainingLifetime=a.startLifetime;a.randomSeed=Je(Qe(0,ot))}};t.prototype._updateParticles=function e(t){var r=this;this._entity.getWorldMatrix(om);if(this._velocityOvertimeModule.enable){this._velocityOvertimeModule.update(this._simulationSpace,om)}if(this._forceOvertimeModule.enable){this._forceOvertimeModule.update(this._simulationSpace,om)}for(var n=0;n<this._particles.length;++n){var i=r._particles.data[n];i.remainingLifetime-=t;Lt.set(i.animatedVelocity,0,0,0);if(i.remainingLifetime<0){r._particles.remove(n);--n;continue}i.velocity.y-=r._gravityModifier.evaluate(1-i.remainingLifetime/i.startLifetime,i.randomSeed)*9.8*t;if(r._sizeOvertimeModule.enable){r._sizeOvertimeModule.animate(i)}if(r._colorOverLifetimeModule.enable){r._colorOverLifetimeModule.animate(i)}if(r._forceOvertimeModule.enable){r._forceOvertimeModule.animate(i,t)}if(r._velocityOvertimeModule.enable){r._velocityOvertimeModule.animate(i)}else{Lt.copy(i.ultimateVelocity,i.velocity)}if(r._limitVelocityOvertimeModule.enable){r._limitVelocityOvertimeModule.animate(i)}if(r._rotationOvertimeModule.enable){r._rotationOvertimeModule.animate(i,t)}if(r._textureAnimationModule.enable){r._textureAnimationModule.animate(i)}Lt.scaleAndAdd(i.position,i.position,i.ultimateVelocity,t)}};t.prototype._prewarmSystem=function e(){var t=this;this._startDelay.mode="constant";this._startDelay.constant=0;var r=1;var n=this._duration/r;for(var i=0;i<n;++i){t._time+=r;t._emit(r);t._updateParticles(r)}};t.prototype._emit=function e(t){var r=this;var n=this._startDelay.evaluate();if(this._time>n){if(!this._isStopped){this._isEmitting=true}if(this._time>this._duration+n){if(!this._loop){this._isEmitting=false;this._isStopped=true}}this._emitRateTimeCounter+=this._rateOverTime.evaluate(this._time/this._duration,1)*t;if(this._emitRateTimeCounter>1&&this._isEmitting){var i=Math.floor(this._emitRateTimeCounter);this._emitRateTimeCounter-=i;this.emit(i)}this._entity.getWorldPos(this._curWPos);var a=Lt.distance(this._curWPos,this._oldWPos);Lt.copy(this._oldWPos,this._curWPos);this._emitRateDistanceCounter+=a*this._rateOverDistance.evaluate(this._time/this._duration,1);if(this._emitRateDistanceCounter>1&&this._isEmitting){var o=Math.floor(this._emitRateDistanceCounter);this._emitRateDistanceCounter-=o;this.emit(o)}for(var s=0;s<this._bursts.length;++s){r._bursts[s].update(r,t)}}};t.prototype.tick=function e(t){var r=t*this._simulationSpeed;if(this._isPlaying){this._time+=r;this._emit(r);this._updateParticles(r);this.renderer._updateRenderData()}};t.prototype.addSubEmitter=function e(t){this._subEmitters.push(t)};t.prototype.removeSubEmitter=function e(t){this._subEmitters.remove(t)};t.prototype.addBurst=function e(t){this._bursts.push(t)};t.prototype.removeBurst=function e(t){this._bursts.remove(t)};t.prototype.getParticleCount=function e(){return this._particles.length};t.prototype.setCustomData1=function e(t,r){Rt.set(this._customData1,t,r)};t.prototype.setCustomData2=function e(t,r){Rt.set(this._customData2,t,r)};r.isPlaying.get=function(){return this._isPlaying};r.isPaused.get=function(){return this._isPaused};r.isStopped.get=function(){return this._isStopped};r.isEmitting.get=function(){return this._isEmitting};r.time.get=function(){return this._time};Object.defineProperties(t.prototype,r);return t}(Yi);sm.schema={capacity:{type:"int",default:2e3},startColor:{type:"GradientRange",default:{mode:"color",color:[1,1,1,1]}},startSize:{type:"CurveRange",default:{mode:"constant",constant:1}},startSpeed:{type:"CurveRange",default:{mode:"constant",constant:5}},startRotation:{type:"CurveRange",default:{mode:"constant",constant:0}},startDelay:{type:"CurveRange",default:{mode:"constant",constant:0}},startLifetime:{type:"CurveRange",default:{mode:"constant",constant:5}},duration:{type:"number",default:5},loop:{type:"boolean",default:true},prewarm:{type:"boolean",default:false,set:function e(t){if(t===true&&this._loop===false){}this._prewarm=t}},simulationSpace:{type:"enums",default:"local",options:["local","world","custom"],set:function e(t){if(t==="world"){this._renderer._material.define("USE_WORLD_SPACE",true)}else{this._renderer._material.define("USE_WORLD_SPACE",false)}this._simulationSpace=t}},simulationSpeed:{type:"number",default:1},playOnAwake:{type:"boolean",default:false},gravityModifier:{type:"CurveRange",default:{mode:"constant",constant:0}},rateOverTime:{type:"CurveRange",default:{mode:"constant",constant:10}},rateOverDistance:{type:"CurveRange",default:{mode:"constant",constant:10}},bursts:{type:"Burst",default:[],array:true},colorOverLifetimeModule:{type:"ColorOverLifetimeModule",default:null},shapeModule:{type:"ShapeModule",default:null},renderer:{type:"ParticleSystemRenderer",default:null},sizeOvertimeModule:{type:"SizeOvertimeModule",default:null},velocityOvertimeModule:{type:"VelocityOvertimeModule",default:null},forceOvertimeModule:{type:"ForceOvertimeModule",default:null},limitVelocityOvertimeModule:{type:"LimitVelocityOvertimeModule",default:null},rotationOvertimeModule:{type:"RotationOvertimeModule",default:null},textureAnimationModule:{type:"TextureAnimationModule",default:null}};var lm=Bt.create();var um=function(e){function t(){e.call(this);this._rect={x:0,y:0,w:0,h:0}}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype._onRectChanged=function e(){};t.prototype.setAnchors=function e(t,r,n,i){this._anchorLeft=t;this._anchorRight=n;this._anchorBottom=r;this._anchorTop=i};t.prototype.setOffset=function e(t,r){this._offsetX=t;this._offsetY=r};t.prototype.setSize=function e(t,r){this._sizeX=t;this._sizeY=r};t.prototype.setPivot=function e(t,r){this._pivotX=t;this._pivotY=r};t.prototype.getLeft=function e(){return this._offsetX-this._sizeX*this._pivotX};t.prototype.getRight=function e(){return-(this._offsetX+this._sizeX*(1-this._pivotX))};t.prototype.getBottom=function e(){return this._offsetY-this._sizeY*this._pivotY};t.prototype.getTop=function e(){return-(this._offsetY+this._sizeY*(1-this._pivotY))};t.prototype.setLeft=function e(t){var r=t-(this._offsetX-this._sizeX*this._pivotX);this._sizeX-=r;this._offsetX+=r*(1-this._pivotX)};t.prototype.setRight=function e(t){var r=-t-(this._offsetX+this._sizeX*(1-this._pivotX));this._sizeX+=r;this._offsetX+=r*this._pivotX};t.prototype.setBottom=function e(t){var r=t-(this._offsetY-this._sizeY*this._pivotY);this._sizeY-=r;this._offsetY+=r*(1-this._pivotY)};t.prototype.setTop=function e(t){var r=-t-(this._offsetY+this._sizeY*(1-this._pivotY));this._sizeY+=r;this._offsetY+=r*this._pivotY};t.prototype.calculate=function e(t,r,n,i){var a=t+n*this._anchorLeft;var o=r+i*this._anchorBottom;var s=t+n*this._anchorRight;var l=r+i*this._anchorTop;var u=0;var h=0;var c=0;var f=0;c=s-a+this._sizeX;f=l-o+this._sizeY;u=a+this._offsetX-this._sizeX*this._pivotX;h=o+this._offsetY-this._sizeY*this._pivotY;var p=u+c*this._pivotX;var d=h+f*this._pivotY;Lt.set(this._entity.lpos,p,d,this._entity.lpos.z);u=u-p;h=h-d;if(u!==this._rect.x||h!==this._rect.y||c!==this._rect.w||f!==this._rect.h){this._onRectChanged()}this._rect.x=u;this._rect.y=h;this._rect.w=c;this._rect.h=f};t.prototype.getWorldCorners=function e(t,r,n,i){this._entity.getWorldMatrix(lm);var a=this._rect.x;var o=this._rect.y;var s=this._rect.w;var l=this._rect.h;Lt.set(t,a,o+l,0);Lt.transformMat4(t,t,lm);Lt.set(r,a,o,0);Lt.transformMat4(r,r,lm);Lt.set(n,a+s,o,0);Lt.transformMat4(n,n,lm);Lt.set(i,a+s,o+l,0);Lt.transformMat4(i,i,lm)};return t}(Yi);um.schema={focusable:{type:"boolean",default:false},pivotX:{type:"number",default:.5},pivotY:{type:"number",default:.5},anchorLeft:{type:"number",default:.5},anchorBottom:{type:"number",default:.5},anchorRight:{type:"number",default:.5},anchorTop:{type:"number",default:.5},offsetX:{type:"number",default:0},offsetY:{type:"number",default:0},sizeX:{type:"number",default:100},sizeY:{type:"number",default:100}};var hm=function(e){function t(){e.call(this);this._view=new Ui.View}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.onInit=function e(){this._view._clearFlags=Ui.CLEAR_DEPTH|Ui.CLEAR_STENCIL;this._view._cullingByID=true;this._view._stages=["ui"];this._view._stencil=0;this._view._priority=this._priority;this._system.addScreen(this)};t.prototype.onDestroy=function e(){this._system.removeScreen(this)};return t}(um);hm.schema={priority:{type:"number",default:0,set:function e(t){this._priority=t;this._view._priority=t}},width:{type:"number",default:960,set:function e(t){this._width=t}},height:{type:"number",default:640,set:function e(t){this._height=t}},scaleFactor:{type:"number",default:1,set:function e(t){this._scaleFactor=t;Lt.set(this._entity.lscale,this._scaleFactor,this._scaleFactor,this._scaleFactor)}}};var cm=function(e){function t(){e.apply(this,arguments)}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.onInit=function e(){this._system.add(this)};t.prototype.onDestroy=function e(){this._system.remove(this)};return t}(Yi);var fm=function(e){function t(){e.apply(this,arguments)}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.tick=function e(){var t=this._entity&&this._entity.getComp("Screen");if(!t){return}var r=this._app._canvas;var n=[r.width/t.width,r.height/t.height];if(this._adaptionMode==="match-width-or-height"){var i=Math.log2(n[0]);var a=Math.log2(n[1]);var o=qe(i,a,this._match);this._scaleFactor=Math.pow(2,o)}else if(this._adaptionMode==="expand"){this._scaleFactor=Math.min(n[0],n[1])}else if(this._adaptionMode==="shrink"){this._scaleFactor=Math.max(n[0],n[1])}t.scaleFactor=this._scaleFactor};return t}(cm);fm.schema={adaptionMode:{type:"enums",default:"none",options:["none","match-width-or-height","expand","shrink"],set:function e(t){if(this._adaptionMode===t){return}this._adaptionMode=t;this._adaption()}},match:{type:"number",default:0},scaleFactor:{type:"number",default:1,set:function e(t){if(this._scaleFactor===t){return}if(this._adaptionMode!=="none"){return}this._scaleFactor=t}}};var pm=[0,0,0,0];var dm=[0,0,0,0];var vm=Bt.create();var mm=[0,1,2,3,2,1];var _m=[0,1,4,5,4,1,1,2,5,6,5,2,2,3,6,7,6,3,4,5,8,9,8,5,5,6,9,10,9,6,6,7,10,11,10,7,8,9,12,13,12,9,9,10,13,14,13,10,10,11,14,15,14,11];var gm=[0,1,2,0,3,4,0,5,6,0,7,8,0,9,10];function ym(e,t){var r=4;var n=null;if(e==="simple"){r=4;n=mm}else if(e==="sliced"){r=16;n=_m}else if(e==="filled"){if(t==="radial"){r=11}else{r=4;n=mm}}var i=new Array(r);var a=new Array(r);var o=new Array(r);var s=Ft.create();for(var l=0;l<r;++l){a[l]=Lt.zero();i[l]=Lt.zero();o[l]=Lt.zero()}return{wposList:a,lposList:i,uvs:o,color:s,indices:n}}function xm(e,t,r,n,i,a){Lt.set(e.lposList[0],r,n,0);Lt.set(e.lposList[1],r+i,n,0);Lt.set(e.lposList[2],r,n+a,0);Lt.set(e.lposList[3],r+i,n+a,0);Lt.copy(e.uvs[0],t.uvs[0]);Lt.copy(e.uvs[1],t.uvs[3]);Lt.copy(e.uvs[2],t.uvs[12]);Lt.copy(e.uvs[3],t.uvs[15]);return e}function bm(e,t,r,n,i,a){var o=1;var s=1;if(t._left+t._right>i){o=i/(t._left+t._right)}if(t._bottom+t._top>a){s=a/(t._bottom+t._top)}pm[0]=r;pm[1]=r+t._left*o;pm[2]=r+i-t._right*o;pm[3]=r+i;dm[0]=n;dm[1]=n+t._bottom*s;dm[2]=n+a-t._top*s;dm[3]=n+a;for(var l=0;l<4;++l){for(var u=0;u<4;++u){Lt.set(e.lposList[l*4+u],pm[u],dm[l],0)}}for(var h=0;h<16;++h){Lt.copy(e.uvs[h],t.uvs[h])}return e}function wm(e,t,r,n,i,a,o,s){o=o<0?0:o;o=o>1?1:o;s=s<0?0:s;var l=s+o>1?1:s+o;Lt.set(e.lposList[0],i*o+r,n,0);Lt.set(e.lposList[1],i*l+r,n,0);Lt.set(e.lposList[2],i*o+r,n+a,0);Lt.set(e.lposList[3],i*l+r,n+a,0);Lt.lerp(e.uvs[0],t.uvs[0],t.uvs[3],o);Lt.lerp(e.uvs[1],t.uvs[0],t.uvs[3],l);Lt.lerp(e.uvs[2],t.uvs[12],t.uvs[15],o);Lt.lerp(e.uvs[3],t.uvs[12],t.uvs[15],l);return e}function Tm(e,t,r,n,i,a,o,s){o=o<0?0:o;o=o>1?1:o;s=s<0?0:s;var l=s+o>1?1:s+o;Lt.set(e.lposList[0],r,n+a*o,0);Lt.set(e.lposList[1],i+r,n+a*o,0);Lt.set(e.lposList[2],r,n+a*l,0);Lt.set(e.lposList[3],i+r,n+a*l,0);Lt.lerp(e.uvs[0],t.uvs[0],t.uvs[12],o);Lt.lerp(e.uvs[1],t.uvs[3],t.uvs[15],o);Lt.lerp(e.uvs[2],t.uvs[0],t.uvs[12],l);Lt.lerp(e.uvs[3],t.uvs[3],t.uvs[15],l);return e}function Em(e,t){var r,n;r=t.x-e.x;n=t.y-e.y;if(r===0&&n===0){return NaN}else if(r===0){if(n>0){return Math.PI*.5}else{return Math.PI*1.5}}else{var i=Math.atan(n/r);if(r<0){i+=Math.PI}return i}}function Sm(e,t,r,n,i){var a=e.left;var o=e.right;var s=e.top;var l=e.bottom;var u=Math.sin(r);var h=Math.cos(r);var c,f;if(Math.cos(r)!==0){c=u/h;if((a-t.x)*h>0){var p=t.y+c*(a-t.x);n[3].x=a;n[3].y=p;Lt.lerp(i[3],e.uvbl,e.uvtl,(p-e.bottom)/(e.top-e.bottom))}if((o-t.x)*h>0){var d=t.y+c*(o-t.x);n[1].x=o;n[1].y=d;Lt.lerp(i[1],e.uvbr,e.uvtr,(d-e.bottom)/(e.top-e.bottom))}}if(Math.sin(r)!==0){f=h/u;if((s-t.y)*u>0){var v=t.x+f*(s-t.y);n[2].x=v;n[2].y=s;Lt.lerp(i[2],e.uvtl,e.uvtr,(v-e.left)/(e.right-e.left))}if((l-t.y)*u>0){var m=t.x+f*(l-t.y);n[0].x=m;n[0].y=l;Lt.lerp(i[0],e.uvbl,e.uvbr,(m-e.left)/(e.right-e.left))}}}var Mm=function(){var e=[Lt.zero(),Lt.zero(),Lt.zero(),Lt.zero()];var t=[Lt.zero(),Lt.zero(),Lt.zero(),Lt.zero()];var r=[Lt.zero(),Lt.zero(),Lt.zero(),Lt.zero()];var n=[Lt.zero(),Lt.zero(),Lt.zero(),Lt.zero()];var i=Lt.zero();var a=Lt.zero();var o=[Lt.zero(),Lt.zero(),Lt.zero(),Lt.zero()];var s=[0,0,0,0];var l=Lt.zero();var u=Lt.zero();var h={left:0,right:100,bottom:0,top:100,uvbl:Lt.new(0,0,0),uvbr:Lt.new(1,0,0),uvtl:Lt.new(0,1,0),uvtr:Lt.new(1,1,0)};var c=new Array(4);return function(f,p,d,v,m,_,g,y,x,b){Lt.sub(l,p.uvs[3],p.uvs[0]);Lt.sub(u,p.uvs[12],p.uvs[0]);c[0]=p.uvs[0];c[1]=p.uvs[3];c[2]=p.uvs[15];c[3]=p.uvs[12];if(y>=1){xm(f,p,d,v,m,_);f.indices=mm;return f}f.indices=gm;y=y<0?0:y;while(g>=1){g=g-1}while(g<0){g=g+1}g=g*Math.PI*2;y=y*Math.PI*2;var w=g+y;i.x=x<0?0:x;i.y=b<0?0:b;i.x=x>1?1:x;i.y=b>1?1:b;Lt.copy(a,p.uvs[0]);a.x+=l.x*x;a.y+=l.y*x;a.x+=u.x*b;a.y+=u.y*b;i.x=i.x*m;i.y=i.y*_;o[0].x=0;o[0].y=0;o[1].x=m;o[1].y=0;o[2].x=m;o[2].y=_;o[3].x=0;o[3].y=_;for(var T=0;T<4;++T){s[T]=Em(i,o[T])}h.left=0;h.bottom=0;h.right=m;h.top=_;h.uvbl=p.uvs[0];h.uvbr=p.uvs[3];h.uvtl=p.uvs[12];h.uvtr=p.uvs[15];Sm(h,i,g,e,r);Sm(h,i,w,t,n);var E=1;Lt.copy(f.lposList[0],i);Lt.copy(f.uvs[0],a);for(var S=0;S<4;++S){var M=s[S];var A=s[(S+1)%4];if(A<M){A+=Math.PI*2}M-=Math.PI*2;A-=Math.PI*2;for(var R=0;R<3;++R){if(M>=w){}else if(M>=g){if(A>=w){Lt.copy(f.lposList[E],o[S]);Lt.copy(f.lposList[E+1],t[S]);Lt.copy(f.uvs[E],c[S]);Lt.copy(f.uvs[E+1],n[S]);E+=2}else{Lt.copy(f.lposList[E],o[S]);Lt.copy(f.lposList[E+1],o[(S+1)%4]);Lt.copy(f.uvs[E],c[S]);Lt.copy(f.uvs[E+1],c[(S+1)%4]);E+=2}}else{if(A<=g){}else if(A<=w){Lt.copy(f.lposList[E],e[S]);Lt.copy(f.lposList[E+1],o[(S+1)%4]);Lt.copy(f.uvs[E],r[S]);Lt.copy(f.uvs[E+1],c[(S+1)%4]);E+=2}else{Lt.copy(f.lposList[E],e[S]);Lt.copy(f.lposList[E+1],t[S]);Lt.copy(f.uvs[E],r[S]);Lt.copy(f.uvs[E+1],n[S]);E+=2}}M+=Math.PI*2;A+=Math.PI*2}}for(var L=0;L<E;++L){f.lposList[L].x+=d;f.lposList[L].y+=v}for(var C=E;C<f.lposList.length;++C){Lt.copy(f.lposList[C],f.lposList[0])}return f}}();var Am=function(e){function t(){e.apply(this,arguments)}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.onInit=function e(){this._cachedVertexData=ym(this._type,this._fillType);this._vertexDataDirty=true;if(this._material===null){this._material=this._app.assets.get("builtin-material-sprite")}};t.prototype._onRectChanged=function e(){this._vertexDataDirty=true};t.prototype.calcVertexData=function e(t,r,n,i){var a=this;if(this._vertexDataDirty){this._vertexDataDirty=false;var o=this._sprite;if(o===null){o=this._app.assets.get("default-sprite")}Ft.copy(this._cachedVertexData.color,this._color);if(this._type==="simple"){xm(this._cachedVertexData,o,t,r,n,i)}else if(this._type=="sliced"){bm(this._cachedVertexData,o,t,r,n,i)}else if(this._type==="filled"){if(this._fillType==="radial"){Mm(this._cachedVertexData,o,t,r,n,i,this._fillStart,this._fillRange,this._fillCenter.x,this._fillCenter.y)}else if(this._fillType==="vertical"){Tm(this._cachedVertexData,o,t,r,n,i,this._fillStart,this._fillRange)}else{wm(this._cachedVertexData,o,t,r,n,i,this._fillStart,this._fillRange)}}}this._entity.getWorldMatrix(vm);for(var s=0;s<this._cachedVertexData.lposList.length;++s){var l=a._cachedVertexData.lposList[s];var u=a._cachedVertexData.wposList[s];Lt.transformMat4(u,l,vm)}return this._cachedVertexData};return t}(um);Am.schema={material:{type:"asset",default:null,set:function e(t){if(t===this._material){return}this._material=t}},type:{type:"enums",default:"simple",options:["simple","sliced","filled"],set:function e(t){if(t===this._type){return}this._type=t;this._cachedVertexData=ym(this._type,this._fillType);this._vertexDataDirty=true}},fillType:{type:"enums",default:"horizontal",options:["horizontal","vertical","radial"],set:function e(t){if(t===this._fillType){return}this._fillType=t;if(this._type==="filled"){this._cachedVertexData=ym(this._type,this._fillType);this._vertexDataDirty=true}}},fillStart:{type:"number",default:.2,set:function e(t){if(t===this._fillStart){return}this._fillStart=t;if(this._type==="filled"){this._vertexDataDirty=true}}},fillRange:{type:"number",default:.8,set:function e(t){if(t===this._fillRange){return}this._fillRange=t;if(this._type==="filled"){this._vertexDataDirty=true}}},fillCenter:{type:"vec2",default:[.5,.5],set:function e(t){if(Rt.equals(this._fillCenter,t)){return}this._fillCenter=t;if(this._type==="filled"&&this._fillType==="radial"){this._vertexDataDirty=true}}},sprite:{type:"asset",default:null,set:function e(t){if(t===this._sprite){return}this._sprite=t;this._vertexDataDirty=true}},color:{type:"color4",default:[1,1,1,1],set:function e(t){if(Ft.equals(this._color,t)){return}Ft.copy(this._color,t);this._vertexDataDirty=true}}};var Rm=Bt.create();var Lm=document.createElement("canvas");Lm.width=Lm.height=1;function Cm(e){var t=4*e;var r=6*e;var n=new Array(r);var i=new Array(t);var a=new Array(t);var o=new Array(t);var s=Ft.new();for(var l=0;l<t;++l){a[l]=Lt.zero();i[l]=Lt.zero();o[l]=Rt.zero()}for(var u=0;u<e;++u){n[6*u+0]=4*u+0;n[6*u+1]=4*u+1;n[6*u+2]=4*u+2;n[6*u+3]=4*u+3;n[6*u+4]=4*u+2;n[6*u+5]=4*u+1}return{wposList:a,lposList:i,uvs:o,color:s,indices:n}}function Im(e,t,r){var n=0;if(e._font===null){n=t.measureText(r).width}else{var i=e._fontSize/e._font._size;for(var a=0;a<r.length;++a){var o=r.charCodeAt(a);var s=e._font._glyphs[o]||e._font._defaultGlyph;n+=s.xadvance*i}}return n}function Um(e,t,r){var n=[];var i=t.split(e._regWordSep);var a=0;var o=0;var s=0;var l=Lm.getContext("2d");if(e._font===null){var u=e._italic?"italic":"";var h=e._bold?"bold":"";var c=u+" "+h+" "+e._fontSize+"px "+e._fontFamily;l.font=c}for(var f=0;f+1<i.length;){var p=Im(e,l,i[f]);var d=Im(e,l,i[f+1]);if(s+p+d<r){if(f!==0&&s===0){s+=d;a=a+i[f].length;o+=i[f].length+i[f+1].length;f+=2}else{s+=p+d;o+=i[f].length+i[f+1].length;f+=2}}else if(s===0){n.push({start:a+i[f].length,end:a+i[f].length+i[f+1].length,width:d});a=a+i[f].length+i[f+1].length;o=a;s=0;f+=2}else{n.push({start:a,end:o,width:s});a=o;s=0}}if(s>0){n.push({start:a,end:o,width:s})}return n}function Dm(e,t,r,n,i){function a(t){var r=t.text.slice(t.start,t.end);var i=d.measureText(r).width;var a=(n-i)*e._alignH;s.fillText(r,a,t.y)}var o=e._cachedVertexData;Lt.set(o.lposList[0],t,r,0);Lt.set(o.lposList[1],t+n,r,0);Lt.set(o.lposList[2],t,r+i,0);Lt.set(o.lposList[3],t+n,r+i,0);Rt.set(o.uvs[0],0,0);Rt.set(o.uvs[1],1,0);Rt.set(o.uvs[2],0,1);Rt.set(o.uvs[3],1,1);e._fontCanvas.width=n;e._fontCanvas.height=i;var s=e._fontCanvas.getContext("2d");s.clearRect(0,0,n,i);s.fillStyle="#FFFFFF";var l=e._italic?"italic":"";var u=e._bold?"bold":"";var h=l+" "+u+" "+e._fontSize+"px "+e._fontFamily;s.font=h;var c=e._lineHeight*e._fontSize*-.15;var f=c;var p=e._text.split("\n");var d=Lm.getContext("2d");d.font=h;var v=[];if(e._wrap){for(var m=0;m<p.length;++m){var _=Um(e,p[m],n);if(_.length===0){f+=e._lineHeight*e._fontSize;v.push({text:"",start:0,end:0,y:f})}else{for(var g=0;g<_.length;++g){f+=e._lineHeight*e._fontSize;v.push({text:p[m],start:_[g].start,end:_[g].end,y:f})}}}}else{for(var y=0;y<p.length;++y){f+=e._lineHeight*e._fontSize;v.push({text:p[y],start:0,end:p[y].length,y:f})}}var x=v[v.length-1].y-c;for(var b=0;b<v.length;++b){v[b].y+=(i-x)*e._alignV;a(v[b])}e._fontTexture.setImages([e._fontCanvas]);e._fontTexture.commit()}function Om(e,t,r,n,i){var a=0;var o=e._text.split("\n");var s=e._font;var l=e._fontSize/s._size;var u=e._cachedVertexData;var h=0;var c=0;function f(t,r,i){var o=0;for(var f=0;f<i-r;++f){var p=t.charCodeAt(f+r);var d=s._glyphs[p]||s._defaultGlyph;var v=o+d.xoffset*l;var m=o+(d.width+d.xoffset)*l;var _=a-(d.height+d.yoffset)*l;var g=a-d.yoffset*l;var y=c+f;Lt.set(u.lposList[4*y+0],v,_,0);Lt.set(u.lposList[4*y+1],m,_,0);Lt.set(u.lposList[4*y+2],v,g,0);Lt.set(u.lposList[4*y+3],m,g,0);Rt.copy(u.uvs[4*y+0],d.uvs[0]);Rt.copy(u.uvs[4*y+1],d.uvs[1]);Rt.copy(u.uvs[4*y+2],d.uvs[2]);Rt.copy(u.uvs[4*y+3],d.uvs[3]);o+=d.xadvance*l}if(o<n){for(var x=0;x<i-r;++x){var b=(n-o)*e._alignH;var w=c+x;u.lposList[4*w+0].x+=b;u.lposList[4*w+1].x+=b;u.lposList[4*w+2].x+=b;u.lposList[4*w+3].x+=b}}c+=i-r;++h;a-=e._lineHeight*s._lineHeight*l}if(e._wrap){for(var p=0;p<o.length;++p){var d=Um(e,o[p],n);if(d.length===0&&e._text.length!==0){f(" ",0,1)}else{for(var v=0;v<d.length;++v){f(o[p],d[v].start,d[v].end)}}}}else{for(var m=0;m<o.length;++m){f(o[m],0,o[m].length)}}var _=h*e._lineHeight*s._lineHeight*l;var g=_<i?(i-_)*-e._alignV:0;var y=r+i+g;for(var x=0;x<c;++x){u.lposList[4*x+0].x+=t;u.lposList[4*x+1].x+=t;u.lposList[4*x+2].x+=t;u.lposList[4*x+3].x+=t;u.lposList[4*x+0].y+=y;u.lposList[4*x+1].y+=y;u.lposList[4*x+2].y+=y;u.lposList[4*x+3].y+=y}return c}var Bm=function(e){function t(){e.apply(this,arguments)}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.onInit=function e(){this._alignH=0;this._alignV=0;this._regWordSep=new RegExp(this._wordSep);this._fontCanvas=document.createElement("canvas");if(this._material===null){this._material=this._app.assets.get("builtin-material-font")}if(this._font===null&&this._fontTexture===null){this._fontTexture=new Pa(this._app.device);this._fontTexture.mipmap=false;this._fontTexture.wrapS="clamp";this._fontTexture.wrapT="clamp";this._fontTexture.premultiplyAlpha=true}this._updateFont();this._updateAlignHV()};t.prototype._onRectChanged=function e(){this._vertexDataDirty=true};t.prototype._updateFont=function e(){if(this._font===null){this._cachedVertexData=Cm(1);this._vertexDataDirty=true;return}if(this._font.type==="opentype"){this._font.addText(this._text)}else if(this._font.type==="bitmap"){this._material=this._app.assets.get("builtin-material-sprite")}this._cachedVertexData=Cm(this._text.length);this._vertexDataDirty=true};t.prototype._updateAlignHV=function e(){if(this._align==="top-left"){this._alignH=0;this._alignV=0}else if(this._align==="top-center"){this._alignH=.5;this._alignV=0}else if(this._align==="top-right"){this._alignH=1;this._alignV=0}else if(this._align==="middle-left"){this._alignH=0;this._alignV=.5}else if(this._align==="middle-center"){this._alignH=.5;this._alignV=.5}else if(this._align==="middle-right"){this._alignH=1;this._alignV=.5}else if(this._align==="bottom-left"){this._alignH=0;this._alignV=1}else if(this._align==="bottom-center"){this._alignH=.5;this._alignV=1}else if(this._align==="bottom-right"){this._alignH=1;this._alignV=1}};t.prototype.calcVertexData=function e(t,r,n,i){var a=this;if(this._vertexDataDirty){this._vertexDataDirty=false;Ft.copy(this._cachedVertexData.color,this._color);if(this._font===null){Dm(this,t,r,n,i)}else{Om(this,t,r,n,i)}}this._entity.getWorldMatrix(Rm);for(var o=0;o<this._cachedVertexData.lposList.length;++o){var s=a._cachedVertexData.lposList[o];var l=a._cachedVertexData.wposList[o];Lt.transformMat4(l,s,Rm)}return this._cachedVertexData};return t}(um);Bm.schema={material:{type:"asset",default:null,set:function e(t){if(t===this._material){return}this._material=t}},font:{type:"asset",default:null,set:function e(t){if(t===this._font){return}this._font=t;this._updateFont()}},text:{type:"string",default:"",set:function e(t){if(this._text===t){return}this._text=t;this._updateFont()}},align:{type:"enums",default:"top-left",options:["top-left","top-center","top-right","middle-left","middle-center","middle-right","bottom-left","bottom-center","bottom-right"],set:function e(t){if(this._align===t){return}this._align=t;this._vertexDataDirty=true;this._updateAlignHV()}},wrap:{type:"boolean",default:true,set:function e(t){if(this._wrap===t){return}this._wrap=t;this._vertexDataDirty=true}},fontSize:{type:"int",default:32,set:function e(t){if(this._fontSize===t){return}this._fontSize=t;this._vertexDataDirty=true}},lineHeight:{type:"number",default:1,set:function e(t){if(this._lineHeight===t){return}this._lineHeight=t;this._vertexDataDirty=true}},color:{type:"color4",default:[1,1,1,1],set:function e(t){if(Ft.equals(this._color,t)){return}this._color=t;this._vertexDataDirty=true}},wordSep:{type:"string",default:/([a-zA-Z0-9ÄÖÜäöüßéèçàùêâîôûа-яА-ЯЁё]+|\S)/,set:function e(t){if(this._wordSep===t){return}this._wordSep=t;this._regWordSep=new RegExp(t)}},fontFamily:{type:"string",default:"Arial",set:function e(t){if(this._fontFamily===t){return}this._fontFamily=t;this._vertexDataDirty=true}},italic:{type:"boolean",default:false,set:function e(t){if(this._italic===t){return}this._italic=t;this._vertexDataDirty=true}},bold:{type:"boolean",default:false,set:function e(t){if(this._bold===t){return}this._bold=t;this._vertexDataDirty=true}},fontTexture:{type:"asset",default:null}};var Pm=Bt.create();function Fm(){var e=4;var t=[0,1,2,3,2,1];var r=new Array(e);var n=new Array(e);var i=new Array(e);var a=Ft.new(1,1,1,1);i[0]=Rt.new(0,0);i[1]=Rt.new(1,0);i[2]=Rt.new(0,1);i[3]=Rt.new(1,1);for(var o=0;o<e;++o){n[o]=Lt.zero();r[o]=Lt.zero()}return{wposList:n,lposList:r,uvs:i,color:a,indices:t}}var zm=function(e){function t(){e.apply(this,arguments)}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.onInit=function e(){this._cachedVertexData=Fm();this._vertexDataDirty=true;if(this._material===null){this._material=this._app.assets.get("builtin-material-sprite")}};t.prototype._onRectChanged=function e(){this._vertexDataDirty=true};t.prototype.calcVertexData=function e(t,r,n,i){var a=this;if(this._vertexDataDirty){this._vertexDataDirty=false;Lt.set(this._cachedVertexData.lposList[0],t,r,0);Lt.set(this._cachedVertexData.lposList[1],t+n,r,0);Lt.set(this._cachedVertexData.lposList[2],t,r+i,0);Lt.set(this._cachedVertexData.lposList[3],t+n,r+i,0)}this._entity.getWorldMatrix(Pm);for(var o=0;o<this._cachedVertexData.lposList.length;++o){var s=a._cachedVertexData.lposList[o];var l=a._cachedVertexData.wposList[o];Lt.transformMat4(l,s,Pm)}return this._cachedVertexData};return t}(um);zm.schema={material:{type:"asset",default:null,set:function e(t){if(t===this._material){return}this._material=t}},sprite:{type:"asset",default:null,set:function e(t){if(t!==this._sprite){return}this._sprite=t}}};var Nm=function(e){function t(){e.call(this);this._uiElements=new en(200)}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.add=function e(t){this._uiElements.push(t)};t.prototype.remove=function e(t){var r=this;for(var n=0;n<this._uiElements.length;++n){var i=r._uiElements.data[n];if(i===t){r._uiElements.fastRemove(n);break}}};t.prototype.tick=function e(){var t=this;for(var r=0;r<this._uiElements.length;++r){var n=t._uiElements.data[r];if(n&&n.tick){n.tick()}}};t.prototype.postTick=function e(){var t=this;for(var r=0;r<this._uiElements.length;++r){var n=t._uiElements.data[r];if(n&&n.postTick){n.postTick()}}};return t}($i);var km=function(e){function t(){e.call(this);this._highlighting=false;this._pressing=false;this._widget=null;this._bgImage=null;this._state="none";this._fingerId=-1}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.onInit=function e(){this._widget=this._entity.getComp("Widget");this._widget.focusable=true;this._bgImage=this._background&&this._background.getComp("Image");if(!this._bgImage){this._bgImage=this._entity.getComp("Image")}};t.prototype.onDestroy=function e(){this._widget.focusable=false};t.prototype._updateState=function e(){var t="normal";if(this._pressing){t="pressed"}else if(this._highlighting){t="highlight"}if(this._state===t){return}var r=this._state;this._state=t;this.dispatch("transition",{detail:{oldState:r,newState:this._state}});if(this._bgImage===null){return}if(this._transition==="none"){return}if(this._transition==="color"){this._bgImage.color=this._transitionColors[t]}else if(this._transition==="sprite"){this._bgImage.sprite=this._transitionSprites[t]}else{console.warn("Button transition animation is not implemented")}};t.prototype._onMouseEnter=function e(t){if(this.enabled===false){return}var r=this._widget.system;this._highlighting=true;if(r.focusedEntity===this._entity&&t.buttons&1!==0){this._pressing=true}this._updateState()};t.prototype._onMouseLeave=function e(){if(this.enabled===false){return}var t=this._widget.system;this._pressing=false;if(t.focusedEntity&&t.focusedEntity===this._entity){this._highlighting=true}else{this._highlighting=false}this._updateState()};t.prototype._onMouseDown=function e(t){if(this.enabled===false){return}var r=this._widget.system;if(t.button==="left"){t.stop();if(r.focusedEntity!==this._entity){return}this._pressing=true;this._updateState()}};t.prototype._onMouseUp=function e(t){if(this.enabled===false){return}if(t.button==="left"){t.stop();this._pressing=false;this._updateState();this.dispatch("clicked")}};t.prototype._onFocus=function e(){if(this.enabled===false){return}this._highlighting=true;this._updateState()};t.prototype._onBlur=function e(){if(this.enabled===false){return}this._fingerId=-1;this._highlighting=false;this._updateState()};t.prototype._onTouchEnter=function e(t){if(this.enabled===false){return}if(this._fingerId===t.id){t.stop();this._pressing=true;this._updateState()}};t.prototype._onTouchLeave=function e(t){if(this.enabled===false){return}t.stop();this._pressing=false;this._updateState()};t.prototype._onTouchStart=function e(t){if(this.enabled===false){return}t.stop();this._fingerId=t.id;this._pressing=true;this._updateState()};t.prototype._onTouchEnd=function e(t){if(this.enabled===false){return}t.stop();this._fingerId=-1;this._pressing=false;this._updateState();this.dispatch("clicked")};return t}(cm);km.events={mouseenter:"_onMouseEnter",mouseleave:"_onMouseLeave",mousedown:"_onMouseDown",mouseup:"_onMouseUp",focus:"_onFocus",blur:"_onBlur",touchenter:"_onTouchEnter",touchleave:"_onTouchLeave",touchstart:"_onTouchStart",touchend:"_onTouchEnd"};km.schema={transitionColors:{type:"object",default:{normal:Ft.create(),highlight:Ft.create(),pressed:Ft.create(),disabled:Ft.create()}},transitionSprites:{type:"object",parse:function e(t,r,n,i){if(r){var a={normal:null,highlight:null,pressed:null,disabled:null};if(r.normal&&typeof r.normal==="string"){a.normal=t.assets.get(r.normal)}if(r.highlight&&typeof r.highlight==="string"){a.highlight=t.assets.get(r.highlight)}if(r.pressed&&typeof r.pressed==="string"){a.pressed=t.assets.get(r.pressed)}if(r.disabled&&typeof r.disabled==="string"){a.disabled=t.assets.get(r.disabled)}return a}},default:{normal:null,highlight:null,pressed:null,disabled:null}},background:{type:"entity",default:null,set:function e(t){if(!(t instanceof Zi)){return}this._background=t;if(this._background){this._bgImage=this._background.getComp("Image")}}},transition:{type:"enums",default:"none",options:["none","color","sprite"]}};var Vm=function(e){function t(){e.call(this);this._state="none";this._highlighting=false;this._pressing=false;this._widget=null;this._bgImage=null;this._toggleGroupComp=null;this._checkerImage=null;this._fingerId=-1}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.onInit=function e(){this._widget=this._entity.getComp("Widget");this._widget.focusable=true;this._bgImage=this._background&&this._background.getComp("Image");if(!this._bgImage){this._bgImage=this._entity.getComp("Image")}this._toggleGroupComp=this._toggleGroup&&this._toggleGroup.getComp("ToggleGroup");if(this._toggleGroupComp){this._toggleGroupComp._addItem(this)}this._checkerImage=this._checker&&this._checker.getComp("Image");if(this._checkerImage){this._checkerImage.enabled=this._checked}};t.prototype.onDestroy=function e(){this._widget.focusable=false};t.prototype._updateState=function e(){var t="normal";if(this._pressing){t="pressed"}else if(this._highlighting){t="highlight"}if(this._state===t){return}var r=this._state;this._state=t;this.dispatch("transition",{detail:{oldState:r,newState:this._state}});if(this._bgImage===null){return}if(this._transition==="none"){return}if(this._transition==="color"){this._bgImage.color=this._transitionColors[t]}else if(this._transition==="sprite"){this._bgImage.sprite=this._transitionSprites[t]}else{console.warn("Button transition animation is not implemented")}};t.prototype._onMouseEnter=function e(t){if(this.enabled===false){return}var r=this._widget.system;this._highlighting=true;if(r.focusedEntity===this._entity&&t.buttons&1!==0){this._pressing=true}this._updateState()};t.prototype._onMouseLeave=function e(){if(this.enabled===false){return}var t=this._widget.system;this._pressing=false;if(t.focusedEntity&&t.focusedEntity===this._entity){this._highlighting=true}else{this._highlighting=false}this._updateState()};t.prototype._onMouseDown=function e(t){if(this.enabled===false){return}var r=this._widget.system;if(t.button==="left"){t.stop();if(r.focusedEntity!==this._entity){return}this._pressing=true;this._updateState()}};t.prototype._onMouseUp=function e(t){if(this.enabled===false){return}var r=this._widget.system;if(t.button==="left"){t.stop();if(r.focusedEntity!==this._entity){return}this.checked=!this.checked;this.dispatch("change");if(this._toggleGroupComp){this._toggleGroupComp._updateCheck(this)}this._pressing=false;this._updateState()}};t.prototype._onFocus=function e(){if(this.enabled===false){return}this._highlighting=true;this._updateState()};t.prototype._onBlur=function e(){if(this.enabled===false){return}this._fingerId=-1;this._highlighting=false;this._updateState()};t.prototype._onTouchEnter=function e(t){if(this.enabled===false){return}if(this._fingerId===t.id){t.stop();this._pressing=true;this._updateState()}};t.prototype._onTouchLeave=function e(t){if(this.enabled===false){return}t.stop();this._pressing=false;this._updateState()};t.prototype._onTouchStart=function e(t){if(this.enabled===false){return}t.stop();this._fingerId=t.id;this._pressing=true;this._updateState()};t.prototype._onTouchEnd=function e(t){if(this.enabled===false){return}t.stop();this._fingerId=-1;this._pressing=false;this._updateState();this.checked=!this.checked;this.dispatch("change");if(this._toggleGroupComp){this._toggleGroupComp._updateCheck(this)}};return t}(cm);Vm.events={mouseenter:"_onMouseEnter",mouseleave:"_onMouseLeave",mousedown:"_onMouseDown",mouseup:"_onMouseUp",focus:"_onFocus",blur:"_onBlur",touchenter:"_onTouchEnter",touchleave:"_onTouchLeave",touchstart:"_onTouchStart",touchend:"_onTouchEnd"};Vm.schema={checker:{type:"entity",default:null,set:function e(t){if(!(t instanceof Zi)){return}if(this._checker===t){return}this._checker=t;if(this._checker){this._checkerImage=this._checker.getComp("Image");this._checkerImage.enabled=this._checked}}},checked:{type:"boolean",default:true,set:function e(t){if(this._checked===t){return}this._checked=t;if(this._checkerImage){this._checkerImage.enabled=this._checked}}},toggleGroup:{type:"entity",default:null,set:function e(t){if(!(t instanceof Zi)){return}if(this._toggleGroup===t){return}this._toggleGroup=t;if(this._toggleGroupComp){this._toggleGroupComp._removeItem(this);this._toggleGroupComp=null}if(this._toggleGroup){this._toggleGroupComp=this._toggleGroup.getComp("ToggleGroup");if(this._toggleGroupComp){this._toggleGroupComp._addItem(this)}}}},transitionColors:{type:"object",default:{normal:Ft.create(),highlight:Ft.create(),pressed:Ft.create(),disabled:Ft.create()}},transitionSprites:{type:"object",parse:function e(t,r,n,i){if(r){var a={normal:null,highlight:null,pressed:null,disabled:null};if(r.normal&&typeof r.normal==="string"){a.normal=t.assets.get(r.normal)}if(r.highlight&&typeof r.highlight==="string"){a.highlight=t.assets.get(r.highlight)}if(r.pressed&&typeof r.pressed==="string"){a.pressed=t.assets.get(r.pressed)}if(r.disabled&&typeof r.disabled==="string"){a.disabled=t.assets.get(r.disabled)}return a}},default:{normal:null,highlight:null,pressed:null,disabled:null}},background:{type:"entity",default:null,set:function e(t){if(!(t instanceof Zi)){return}if(this._background===t){return}this._background=t;if(this._background){this._bgImage=this._background.getComp("Image")}}},transition:{type:"enums",default:"none",options:["none","color","sprite"]}};var Gm=function(e){function t(){e.call(this);this._toggleItems=[];this._activeItem=null}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype._addItem=function e(t){if(this._toggleItems.indexOf(t)===-1){this._toggleItems.push(t);if(this._activeItem===null){if(t.checked){this._activeItem=t}}else{t.checked=false}}else{console.warn("toggle item already added into toggle groups")}};t.prototype._removeItem=function e(t){var r=this._toggleItems.indexOf(t);if(r===-1){console.warn("toggle item not exists in toggle groups")}else{if(this._activeItem===t){this._activeItem=null}this._toggleItems.splice(r,1)}};t.prototype._updateCheck=function e(t){var r=this._toggleItems.indexOf(t);if(r===-1){console.warn("toggle item not exists in toggle groups");return true}else{if(this._activeItem!==t){if(this._activeItem){this._activeItem.checked=false}this._activeItem=t}else{if(!this._allowSwitchOff){if(this._activeItem&&!this._activeItem.checked){this._activeItem.checked=true}}}}};return t}(cm);Gm.schema={allowSwitchOff:{type:"boolean",default:false}};var Wm=function(e){function t(){var t=this;e.call(this);this._state="none";this._calMinValue=0;this._calMaxValue=1;this._highlighting=false;this._pressing=false;this._widget=null;this._dragging=false;this._bgImage=null;this._handleWidget=null;this._fillWidget=null;this._lastAxis="horizontal";this._normalizedValue=0;this._reverse=false;this._fingerId=-1;this._onMouseEnter=function(e){if(t.enabled===false){return}var r=t._widget.system;t._highlighting=true;if(r.focusedEntity===t._entity&&e.buttons&1!==0){t._pressing=true}t._updateState()};this._onMouseLeave=function(){if(t.enabled===false){return}var e=t._widget.system;t._pressing=false;if(e.focusedEntity&&e.focusedEntity===t._entity){t._highlighting=true}else{t._highlighting=false}t._updateState()};this._onMouseDown=function(e){if(t.enabled===false){return}var r=t._widget.system;if(e.button==="left"){e.stop();if(r.focusedEntity!==t._entity){return}t._pressing=true;t._updateState();if(!t._handle||e.target!==t._handle){t._updateDrag(Lt.new(e.mouseX,e.mouseY,0))}t._dragging=true}};this._onMouseMove=function(e){if(t.enabled===false){return}if(e.button===0){e.stop();if(t._dragging){t._updateDrag(Lt.new(e.mouseX,e.mouseY,0))}}};this._onMouseUp=function(e){if(t.enabled===false){return}if(e.button==="left"){e.stop();t._dragging=false;t._pressing=false;t._updateState()}};this._onTouchMove=function(e){if(t.enabled===false){return}e.stop();if(e.id===t._fingerId){if(t._dragging){t._updateDrag(Lt.new(e.x,e.y,0))}}};this._onTouchStart=function(e){if(t.enabled===false){return}e.stop();if(t._fingerId!==-1){return}t._fingerId=e.id;t._pressing=true;t._updateState();if(!t._handle||e.target!==t._handle){t._updateDrag(Lt.new(e.x,e.y,0))}t._dragging=true};this._onTouchEnd=function(e){if(t.enabled===false){return}e.stop();if(e.id!==t._fingerId){return}t._dragging=false;t._fingerId=-1;t._pressing=false;t._updateState()}}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.onInit=function t(){e.prototype.onInit.call(this);this._widget=this._entity.getComp("Widget");this._widget.focusable=true;this._bgImage=this._background&&this._background.getComp("Image");if(!this._bgImage){this._bgImage=this._entity.getComp("Image")}this._fillWidget=this._fill&&this._fill.getComp("Widget");this._handleWidget=this._handle&&this._handle.getComp("Widget");var r=0;if(this._value>0){r=(this._value-this._calMinValue)/(this._calMaxValue-this._calMinValue);r=Math.round(r*100)/100}this._normalizedValue=this._reverse?1-r:r;this._updateVisuals()};t.prototype.onDestroy=function t(){this._widget.focusable=false;e.prototype.onDestroy.call(this)};t.prototype._updateState=function e(){var t="normal";if(this._pressing){t="pressed"}else if(this._highlighting){t="highlight"}if(this._state===t){return}var r=this._state;this._state=t;this.dispatch("transition",{detail:{oldState:r,newState:this._state}});if(this._bgImage===null){return}if(this._transition==="none"){return}if(this._transition==="color"){this._bgImage.color=this._transitionColors[t]}else if(this._transition==="sprite"){this._bgImage.sprite=this._transitionSprites[t]}else{console.warn("Button transition animation is not implemented")}};t.prototype._set=function e(t){var r=He(t,this._calMinValue,this._calMaxValue);if(this._value!=r){this._value=r;this._updateVisuals();this._emitValueChangedEvents()}};t.prototype._getReverseValue=function e(){return this._maxValue<this._minValue};t.prototype._updateDrag=function e(t){var r=this._handle?this._handleWidget:this._fillWidget;var n=r._entity.parent.getComp("Widget");if(n){var i=[Lt.zero(),Lt.zero(),Lt.zero(),Lt.zero()];n.getWorldCorners(i[0],i[1],i[2],i[3]);var a=i[1];var o=Lt.zero(),s=Lt.zero();var l=0,u=0;if(this._direction==="horizontal"){Lt.subtract(o,i[2],a);Lt.subtract(s,t,a);l=Lt.distance(i[2],a);this._normalizedValue=je(u/l)}else{Lt.subtract(o,i[0],a);Lt.subtract(s,t,a);l=Lt.distance(i[0],a)}u=Lt.dot(o,s)/l;this._normalizedValue=je(u/l);this._clampValue()}};t.prototype._updateVisuals=function e(){var t=[0,0];var r=[1,1];var n=this._direction==="horizontal"?0:1;if(this._fillWidget){var i=this._fill.getComp("Image");if(i){if(i.type==="filled"){i.filledStart=this._normalizedValue}else if(this._reverse){t[n]=this._normalizedValue}else{r[n]=this._normalizedValue}}this._fillWidget.setAnchors(t[0],t[1],r[0],r[1])}if(this._handleWidget){t=[0,0];r=[1,1];t[n]=this._normalizedValue;r[n]=this._normalizedValue;this._handleWidget.setAnchors(t[0],t[1],r[0],r[1])}};t.prototype._clampValue=function e(){this.value=(this._reverse?1-this._normalizedValue:this._normalizedValue)*(this._calMaxValue-this._calMinValue)};t.prototype._getCalculateWidget=function e(){return this._handle.parent.getComp("Widget")};t.prototype._onFocus=function e(){if(this.enabled===false){return}this._highlighting=true;this._updateState()};t.prototype._onBlur=function e(){if(this.enabled===false){return}this._fingerId=-1;this._highlighting=false;this._updateState()};t.prototype._onTouchEnter=function e(t){if(this.enabled===false){return}if(this._fingerId!==-1&&this._fingerId===t.id){t.stop();this._pressing=true;this._updateState()}};t.prototype._onTouchLeave=function e(t){if(this.enabled===false){return}if(this._fingerId!==-1&&this._fingerId===t.id){t.stop();this._pressing=false;this._updateState()}};t.prototype._emitValueChangedEvents=function e(){this.dispatch("Slider.onValueChanged")};return t}(cm);Wm.events={mouseenter:"_onMouseEnter",mouseleave:"_onMouseLeave",mousemove:"_onMouseMove",mousedown:"_onMouseDown",mouseup:"_onMouseUp",focus:"_onFocus",blur:"_onBlur",touchenter:"_onTouchEnter",touchleave:"_onTouchLeave",touchstart:"_onTouchStart",touchmove:"_onTouchMove",touchend:"_onTouchEnd"};Wm.schema={handle:{type:"entity",default:null,set:function e(t){if(!(t instanceof Zi)){return}if(this._handle===t){return}this._handle=t;if(this._handle){this._handleWidget=this._handle.getComp("Widget")}this._updateVisuals()}},fill:{type:"entity",default:null,set:function e(t){if(!(t instanceof Zi)){return}if(this._fill===t){return}this._fill=t;if(this._fill){this._fillWidget=this._fill.getComp("Widget")}this._updateVisuals()}},direction:{type:"enums",default:"horizontal",options:["horizontal","vertical"],set:function e(t){if(this._direction===t){return}this._direction=t;this._lastAxis=this._direction}},minValue:{type:"number",default:0,set:function e(t){if(this._minValue===t){return}this._minValue=t;this._calMinValue=t;if(this._minValue>this._maxValue){this._calMinValue=this._maxValue;this._calMaxValue=this._minValue}}},maxValue:{type:"number",default:1,set:function e(t){if(this._maxValue===t){return}this._maxValue=t;this._calMaxValue=t;if(this._minValue>this._maxValue){this._calMinValue=this._maxValue;this._calMaxValue=this._minValue}}},value:{type:"number",default:0,set:function e(t){if(this._value===t){return}this._set(t,false)}},transitionColors:{type:"object",default:{normal:Ft.create(),highlight:Ft.create(),pressed:Ft.create(),disabled:Ft.create()}},transitionSprites:{type:"object",parse:function e(t,r,n,i){if(r){var a={normal:null,highlight:null,pressed:null,disabled:null};if(r.normal&&typeof r.normal==="string"){a.normal=t.assets.get(r.normal)}if(r.highlight&&typeof r.highlight==="string"){a.highlight=t.assets.get(r.highlight)}if(r.pressed&&typeof r.pressed==="string"){a.pressed=t.assets.get(r.pressed)}if(r.disabled&&typeof r.disabled==="string"){a.disabled=t.assets.get(r.disabled)}return a}},default:{normal:null,highlight:null,pressed:null,disabled:null}},background:{type:"entity",default:null,set:function e(t){if(!(t instanceof Zi)){return}if(this._background===t){return}this._background=t;if(this._background){this._bgImage=this._background.getComp("Image")}}},transition:{type:"enums",default:"none",options:["none","color","sprite"]}};var Hm=function(e){function t(){var t=this;e.call(this);this._state="none";this._highlighting=false;this._pressing=false;this._widget=null;this._bgImage=null;this._textComp=null;this._activeDom=null;this._inputText="";this._editMode=false;this._onMouseMove=function(){if(t._pressing){t._flushDom()}};this._onMouseEnter=function(e){if(t.enabled===false){return}var r=t._widget.system;t._highlighting=true;if(r.focusedEntity===t._entity&&e.buttons&1!==0){t._pressing=true}t._updateState()};this._onMouseLeave=function(){if(t.enabled===false){return}var e=t._widget.system;t._pressing=false;if(e.focusedEntity&&e.focusedEntity===t._entity){t._highlighting=true}else{t._highlighting=false}t._updateState()};this._onMouseDown=function(e){if(t.enabled===false){return}var r=t._widget.system;if(e.button==="left"){e.stop();if(r.focusedEntity!==t._entity){return}t._pressing=true;t._updateState()}};this._onMouseUp=function(e){if(t.enabled===false){return}if(e.button==="left"){e.stop();t._pressing=false;t._updateState();t._onClk()}};this._onInput=function(){t._text=t._activeDom.value;t._emitValueChangedEvents()};this._onReturnKey=function(e){if(t._textComp===null){return}if(e.keyCode===13){if(t._returnKeyType==="new-line"){if(t._lineType==="multi-line"){t._text+="\n"}}else{t._endInput();if(t._returnKeyType==="submit"){t._emitSubmitEvents()}}}};this._onTouchEnd=function(e){if(t.enabled===false){return}e.stop();t._pressing=false;t._updateState();t._onClk()}}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.onInit=function t(){e.prototype.onInit.call(this);this._widget=this._entity.getComp("Widget");this._widget.focusable=true;this._bgImage=this._background&&this._background.getComp("Image");if(!this._bgImage){this._bgImage=this._entity.getComp("Image")}this._textComp=this._textEnt&&this._textEnt.getComp("Text");if(this._textComp){var r=this._textComp.align;var n=r.split("-");if(n.indexOf("middle")===-1){this._textComp.align="middle-"+n[1]}}this._dealText(this._text);if(this._lineType==="multi-line"){this._createDom("textarea")}else{this._createDom("input")}};t.prototype.onDisable=function e(){this._endInput()};t.prototype.onDestroy=function t(){this._widget.focusable=false;this._endInput();e.prototype.onDestroy.call(this)};t.prototype._updateState=function e(){var t="normal";if(this._pressing){t="pressed"}else if(this._highlighting){t="highlight"}if(this._state===t){return}var r=this._state;this._state=t;this.dispatch("transition",{detail:{oldState:r,newState:this._state}});if(this._bgImage===null){return}if(this._transition==="none"){return}if(this._transition==="color"){this._bgImage.color=this._transitionColors[t]}else if(this._transition==="sprite"){this._bgImage.sprite=this._transitionSprites[t]}else{console.warn("Button transition animation is not implemented")}};t.prototype._registerEvent=function e(){this._activeDom.addEventListener("input",this._onInput);this._activeDom.addEventListener("keypress",this._onReturnKey)};t.prototype._unregisterEvent=function e(){this._activeDom.removeEventListener("input",this._onInput);this._activeDom.removeEventListener("keypress",this._onReturnKey)};t.prototype._onClk=function e(){if(this._textComp===null){return}if(!this._editMode){this._editMode=true;this._activeDom.style.display="block";this._activeDom.value=this._text;this._textComp.enabled=false;this._startFocus()}};t.prototype._startFocus=function e(){this._activeDom.focus();this._flushDom()};t.prototype._dealText=function e(t){var r=this;if(this._textComp===null){return}this._text="";if(this._lineType==="single-line"){t=t.replace("\n","")}var n=Math.min(t.length,this._maxLength);for(var i=0;i<n;++i){var a=r._checkChar(t[i],r._text.length,r._text);if(a.length>0){r._text+=a}}this._switchTextState();var o=this._text;if(this._contentType==="password"){o=this._text.replace(new RegExp(".+?","g"),"V")}this._textComp.text=o.length>0?o:this.defaultText};t.prototype._switchTextState=function e(){var t=this._textComp.color;if(this._text.length<=0){this._textComp.color=Ft.new(t.r,t.g,t.b,.5)}else{this._textComp.color=Ft.new(t.r,t.g,t.b,1)}};t.prototype._checkChar=function e(t,r,n){var i=false;if(this._contentType==="standard"){return t}if(this._contentType==="int-number"||this._contentType==="decimal-number"){i=new RegExp("[0-9]").test(t);if(i){return t}if(t==="-"){if(r===0){return t}}if(t==="."&&this._contentType==="decimal-number"&&this._text.indexOf(".")<0){return t}}else if(this._contentType==="alpha-number"){i=new RegExp("[0-9a-zA-Z]").test(t);if(i){return t}}else if(this._contentType==="caps-all"){return t.toUpperCase()}else if(this._contentType==="name"){i=new RegExp("[a-zA-Z]").test(t);if(i){i=new RegExp("[a-z]").test(t);if(i){if(r===0||n[r-1]===" "){return t.toUpperCase()}}else{if(r>0&&n[r-1]!==" "){return t.toLowerCase()}}return t}else{if(t===" "&&r>0){if(n[r-1]!==" "){return t}}}}else if(this._contentType==="email"){i=new RegExp("[0-9a-zA-Z]").test(t);if(i){return t}if(t==="@"&&this._text.indexOf("@")===-1){return t}var a="!#$%&'*+-/=?^_`{}|~";if(a.indexOf(t)!==-1){return t}if(t==="."){if(r>0&&n[r-1]!=="."){return t}}}else{return t}return""};t.prototype._endInput=function e(){if(this._textComp===null){return}if(this._editMode){this._editMode=false;this._activeDom.style.display="none";this._dealText(this._text);this._textComp.enabled=true;if(this._text.length<=0){this._textComp.text=this.defaultText}this._switchTextState();this._activeDom.blur()}};t.prototype._createDom=function e(t){if(this._activeDom){this._unregisterEvent();document.body.removeChild(this._activeDom)}this._activeDom=document.createElement(t);document.body.appendChild(this._activeDom);if(this._activeDom.type!=="textarea"){this._activeDom.type=this._contentType==="password"?"password":"text"}this._activeDom.style.background="transparent";this._activeDom.style.position="absolute";this._activeDom.style.padding="2px";this._activeDom.style.fontSize=this._textComp!==null?this._textComp.fontSize+"px":"10px";this._activeDom.style.display="none";if(this._activeDom.type==="textarea"){this._activeDom.style.active=0;this._activeDom.style.overflowY="scroll";this._activeDom.style.resize="none"}this._activeDom.maxLength=this._maxLength;this._registerEvent()};t.prototype._flushDom=function e(){if(this._textComp===null||this._activeDom.style.display==="none"){return}var t=this._app._canvas;var r=this._textComp.entity.getComp("Widget");var n=[Lt.zero(),Lt.zero(),Lt.zero(),Lt.zero()];r.getWorldCorners(n[0],n[1],n[2],n[3]);var i=4;var a=n[0].x+i;var o=t.height-n[0].y+i;var s=this._textComp.align;this._activeDom.type==="textarea"?"textarea":"input";s=s.indexOf("left")!==-1?"left":s.indexOf("center")!==-1?"center":"right";this._activeDom.style.textAlign=s;this._activeDom.maxLength=this._maxLength;this._activeDom.style.width=r._rect.w-i-2+"px";this._activeDom.style.height=r._rect.h-i-2+"px";this._activeDom.style.top=o+"px";this._activeDom.style.left=a+"px"};t.prototype._onFocus=function e(){if(this.enabled===false){return}this._highlighting=true;this._updateState()};t.prototype._onBlur=function e(){if(this._entity.enabledInHierarchy===false){return}this._fingerId=-1;this._highlighting=false;this._updateState();this._endInput()};t.prototype._onTouchEnter=function e(t){if(this.enabled===false){return}if(this._fingerId===t.id){t.stop();this._pressing=true;this._updateState()}};t.prototype._onTouchLeave=function e(t){if(this.enabled===false){return}t.stop();this._pressing=false;this._updateState()};t.prototype._onTouchStart=function e(t){if(this.enabled===false){return}t.stop();this._fingerId=t.id;this._pressing=true;this._updateState()};t.prototype._emitValueChangedEvents=function e(){this.dispatch("EditBox.onValueChanged")};t.prototype._emitSubmitEvents=function e(){this.dispatch("EditBox.onSubmit")};return t}(cm);Hm.events={mouseenter:"_onMouseEnter",mouseleave:"_onMouseLeave",mousedown:"_onMouseDown",mousemove:"_onMouseMove",mouseup:"_onMouseUp",focus:"_onFocus",blur:"_onBlur",touchenter:"_onTouchEnter",touchleave:"_onTouchLeave",touchstart:"_onTouchStart",touchend:"_onTouchEnd"};Hm.schema={defaultText:{type:"string",default:""},textEnt:{type:"entity",default:null,set:function e(t){if(!(t instanceof Zi)){return}if(this._textEnt===t){return}this._textEnt=t;if(!this._textEnt){console.warn("Text component cannot be null")}if(this._textEnt){this._textComp=this._textEnt.getComp("Text");if(this._textComp){this._activeDom.style.fontSize=this._textComp.fontSize+"px";this._textComp.text=this._defaultText;var r=this._textComp.align;var n=r.split("-");if(n.indexOf("middle")===-1){this._textComp.align="middle-"+n[1]}}this._switchTextState()}}},text:{type:"string",default:"",set:function e(t){t=!t?"":t;if(this._text===t){return}this._dealText(t)}},contentType:{type:"enums",default:"standard",options:["standard","int-number","decimal-number","alpha-number","caps-all","name","email","password"],set:function e(t){if(this._contentType===t){return}this._contentType=t;if(this._contentType==="password"){this._activeDom.type="password";this.lineType="single-line"}else if(this._contentType==="email"){this._activeDom.type="email";this.lineType="single-line"}else{this._activeDom.type="text";this.lineType=this._lineType}this._dealText(this._text)}},lineType:{type:"enums",default:"single-line",options:["single-line","multi-line"],set:function e(t){if(this._lineType===t){return}if(this._contentType==="standard"){this._lineType=t}else{this._lineType="single-line"}if(this._lineType==="multi-line"){this._createDom("textarea")}else{this._createDom("input")}}},returnKeyType:{type:"enums",default:"none",options:["none","submit","new-line"]},maxLength:{type:"int",default:2147483647,set:function e(t){if(this._maxLength===t){return}this._maxLength=t;if(this._maxLength<=0){this._maxLength=2147483647}this._activeDom.maxLength=this._maxLength;this._dealText(this._text)}},transitionColors:{type:"object",default:{normal:Ft.create(),highlight:Ft.create(),pressed:Ft.create(),disabled:Ft.create()}},transitionSprites:{type:"object",parse:function e(t,r,n,i){if(r){var a={normal:null,highlight:null,pressed:null,disabled:null};if(r.normal&&typeof r.normal==="string"){a.normal=t.assets.get(r.normal)}if(r.highlight&&typeof r.highlight==="string"){a.highlight=t.assets.get(r.highlight)}if(r.pressed&&typeof r.pressed==="string"){a.pressed=t.assets.get(r.pressed)}if(r.disabled&&typeof r.disabled==="string"){a.disabled=t.assets.get(r.disabled)}return a}},default:{normal:null,highlight:null,pressed:null,disabled:null}},background:{type:"entity",default:null,set:function e(t){if(!(t instanceof Zi)){return}if(this._background===t){return}this._background=t;if(this._background){this._bgImage=this._background.getComp("Image")}}},transition:{type:"enums",default:"none",options:["none","color","sprite"],set:function e(t){if(this._transition!==t){this._transition=t}}}};var jm=function(e){function t(){var t=this;e.call(this);this._state="none";this._highlighting=false;this._pressing=false;this._widget=null;this._dragging=false;this._handleWidget=null;this._startDistance=0;this._fingerId=-1;this._onMouseEnter=function(e){if(t.enabled===false){return}var r=t._widget.system;t._highlighting=true;if(r.focusedEntity===t._entity&&e.buttons&1!==0){t._pressing=true}t._updateState()};this._onMouseLeave=function(){if(t.enabled===false){return}var e=t._widget.system;t._pressing=false;if(e.focusedEntity&&e.focusedEntity===t._entity){t._highlighting=true}else{t._highlighting=false}t._updateState()};this._onMouseDown=function(e){if(t.enabled===false){return}var r=t._widget.system;if(e.button==="left"){e.stop();if(r.focusedEntity!==t._entity){return}t._pressing=true;t._updateState();if(e.target!==t._handle){if(!t._dragging){t._dragging=true;t._updateValue(Rt.new(e.mouseX,e.mouseY),true)}}else{t._dragging=true;t._startOffset(Rt.new(e.mouseX,e.mouseY))}}};this._onMouseMove=function(e){if(t.enabled===false){return}if(e.button===0){e.stop();if(t._dragging){t._updateValue(Lt.new(e.mouseX,e.mouseY,0))}}};this._onMouseUp=function(e){if(t.enabled===false){return}if(e.button==="left"){e.stop();t._dragging=false;t._pressing=false;t._updateState()}};this._onTouchStart=function(e){if(t.enabled===false){return}e.stop();if(t._fingerId!==-1){return}t._fingerId=e.id;t._pressing=true;t._updateState();t._startPos=Lt.new(e.x,e.y,0);t._offsetValue=0;if(e.target!==t._handle){if(!t._dragging){t._dragging=true;t._clkBar(Lt.new(e.x,e.y,0),true)}}else{t._dragging=true;t._startOffset(Rt.new(e.x,e.y))}};this._onTouchMove=function(e){if(t.enabled===false){return}e.stop();if(e.id===t._fingerId){if(t._dragging){t._updateValue(Lt.new(e.x,e.y,0))}}};this._onTouchEnd=function(e){if(t.enabled===false){return}e.stop();if(e.id!==t._fingerId){return}t._dragging=false;t._fingerId=-1;t._pressing=false;t._updateState()}}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.onInit=function t(){this._widget=this._entity.getComp("Widget");this._widget.focusable=true;this._bgImage=this._background&&this._background.getComp("Image");if(!this._bgImage){this._bgImage=this._entity.getComp("Image")}this._handleWidget=this._handle&&this._handle.getComp("Widget");e.prototype.onInit.call(this)};t.prototype.onEnable=function e(){this._updateHandle()};t.prototype.onDestroy=function t(){this._widget.focusable=false;e.prototype.onDestroy.call(this)};t.prototype._updateState=function e(){var t="normal";if(this._pressing){t="pressed"}else if(this._highlighting){t="highlight"}if(this._state===t){return}var r=this._state;this._state=t;this.dispatch("transition",{detail:{oldState:r,newState:this._state}});if(this._background===null){return}if(this._transition==="none"){return}if(this._transition==="color"){this._background.color=this._transitionColors[t]}else if(this._transition==="sprite"){this._background.sprite=this._transitionSprites[t]}else{console.warn("Button transition animation is not implemented")}};t.prototype._set=function e(t){var r=this._value;if(t===r){return}this._value=je(t);this._emitValueChangedEvents()};t.prototype._updateValue=function e(t,r){if(r===void 0)r=false;if(!this._handle||!this._handle){return}var n=this._getCalculateWidget();var i=[Lt.zero(),Lt.zero(),Lt.zero(),Lt.zero()];n.getWorldCorners(i[0],i[1],i[2],i[3]);var a=Rt.new(i[1].x,i[1].y);var o=Rt.zero(),s=Rt.zero();var l=this._direction==="horizontal"?Rt.new(i[2].x,i[2].y):Rt.new(i[0].x,i[0].y);Rt.subtract(o,l,a);Rt.subtract(s,t,a);var u=[n._rect.w*this._size/2,n._rect.h*this._size/2];var h=Rt.dot(o,s)/(this._direction==="horizontal"?n._rect.w:n._rect.h);if(this._direction==="horizontal"){h-=u[0]+(r?0:this._startDistance);h=je(h/(n._rect.w*(1-this._size)))}else{h-=u[1]+(r?0:this._startDistance);h=je(h/(n._rect.h*(1-this._size)))}this.value=this._reverse?1-h:h};t.prototype._startOffset=function e(t){var r=[Lt.zero(),Lt.zero(),Lt.zero(),Lt.zero()];var n=this._getCalculateWidget();n.getWorldCorners(r[0],r[1],r[2],r[3]);var i=Lt.zero();if(this._direction==="horizontal"){Lt.subtract(i,r[2],r[1])}else{Lt.subtract(i,r[3],r[2])}var a=[Lt.zero(),Lt.zero(),Lt.zero(),Lt.zero()];this._handleWidget.getWorldCorners(a[0],a[1],a[2],a[3]);var o=Lt.zero(),s=Rt.zero();Lt.add(o,a[3],a[1]);Lt.divide(o,o,Lt.new(2,2,2));Rt.subtract(s,t,Rt.new(o.x,o.y));var l=Rt.dot(s,Rt.new(i.x,i.y))/(this._direction==="horizontal"?n._rect.w:n._rect.h);return l};t.prototype._updateHandle=function e(){if(!this._handle||!this._handle){return}var t={0:0,1:0};var r={0:1,1:1};var n=this._value*(1-this._size);n=Math.round(parseFloat(n)*100)/100;var i=this._direction==="horizontal"?0:1;if(this._reverse){t[i]=1-n-this._size;r[i]=1-n}else{t[i]=n;r[i]=n+this._size}this._handleWidget.setAnchors(t[0],t[1],r[0],r[1])};t.prototype._getCalculateWidget=function e(){if(!this._handle||!this._handle){return null}var t=this._handle.parent.getComp("Widget");return t};t.prototype._onFocus=function e(){if(this.enabled===false){return}this._highlighting=true;this._updateState()};t.prototype._onBlur=function e(){if(this.enabled===false){return}this._fingerId=-1;this._highlighting=false;this._updateState()};t.prototype._onTouchEnter=function e(t){if(this.enabled===false){return}if(this._fingerId!==-1&&this._fingerId===t.id){t.stop();this._pressing=true;this._updateState()}};t.prototype._onTouchLeave=function e(t){if(this.enabled===false){return}if(this._fingerId!==-1&&this._fingerId===t.id){t.stop();this._pressing=false;this._updateState()}};t.prototype._emitValueChangedEvents=function e(){this.dispatch("ScrollBar.onValueChanged")};return t}(cm);jm.events={mouseenter:"_onMouseEnter",mouseleave:"_onMouseLeave",mousedown:"_onMouseDown",mousemove:"_onMouseMove",mouseup:"_onMouseUp",focus:"_onFocus",blur:"_onBlur",touchenter:"_onTouchEnter",touchleave:"_onTouchLeave",touchstart:"_onTouchStart",touchmove:"_onTouchMove",touchend:"_onTouchEnd"};jm.schema={direction:{type:"enums",default:"horizontal",options:["horizontal","vertical"],set:function e(t){if(t===this._direction){return}this._direction=t}},size:{type:"number",default:0,set:function e(t){if(this._size===t){return}this._size=je(t);this._updateHandle()},get:function e(){this._size=Math.round(parseFloat(this._size)*100)/100;return this._size}},value:{type:"number",default:0,set:function e(t){if(this._value===t){return}this._set(t);this._updateHandle()},get:function e(){this._value=Math.round(parseFloat(this._value)*100)/100;return this._value}},reverse:{type:"boolean",default:false},handle:{type:"entity",default:null,set:function e(t){if(!(t instanceof Zi)){return}if(this._handle===t){return}this._handle=t;if(this._handle){this._handleWidget=this._handle.getComp("Widget")}}},transitionColors:{type:"object",default:{normal:Ft.create(),highlight:Ft.create(),pressed:Ft.create(),disabled:Ft.create()}},transitionSprites:{type:"object",parse:function e(t,r,n,i){if(r){var a={normal:null,highlight:null,pressed:null,disabled:null};if(r.normal&&typeof r.normal==="string"){a.normal=t.assets.get(r.normal)}if(r.highlight&&typeof r.highlight==="string"){a.highlight=t.assets.get(r.highlight)}if(r.pressed&&typeof r.pressed==="string"){a.pressed=t.assets.get(r.pressed)}if(r.disabled&&typeof r.disabled==="string"){a.disabled=t.assets.get(r.disabled)}return a}},default:{normal:null,highlight:null,pressed:null,disabled:null}},background:{type:"entity",default:null,set:function e(t){if(!(t instanceof Zi)){return}if(this._background===t){return}this._background=t;if(this._background){this._bgImage=this._background.getComp("Image")}}},transition:{type:"enums",default:"none",options:["none","color","sprite"]}};var qm=function e(t,r){this._center=Lt.zero();Lt.copy(this._center,t);this._extents=Lt.zero();Lt.mul(this._extents,r,Lt.new(.5,.5,.5));this._size=Lt.zero();this._min=Lt.zero();this._max=Lt.zero()};var Xm={center:{configurable:true},size:{configurable:true},min:{configurable:true},max:{configurable:true}};Xm.center.set=function(e){this._center=e};Xm.center.get=function(){return this._center};Xm.size.set=function(e){Lt.mul(this._extents,e,Lt.new(.5,.5,.5))};Xm.size.get=function(){var e=Lt.zero();Lt.mul(e,this._extents,Lt.new(2,2,2));return e};Xm.min.set=function(e){this.setMinMax(e,this._max)};Xm.min.get=function(){var e=Lt.zero();Lt.subtract(e,this._center,this._extents);return e};Xm.max.set=function(e){this.setMinMax(this._min,e)};Xm.max.get=function(){var e=Lt.zero();Lt.add(e,this._center,this._extents);return e};qm.prototype.setMinMax=function e(t,r){var n=Lt.zero();Lt.subtract(n,r,t);Lt.mul(n,n,Lt.new(.5,.5,.5));Lt.set(this._extents,n.x,n.y,n.z);Lt.add(this._center,t,this._extents)};qm.prototype.encapsulate=function e(t){var r=Lt.zero(),n=Lt.zero();Lt.min(r,this.min,t);Lt.max(n,this.max,t);this.setMinMax(r,n)};Object.defineProperties(qm.prototype,Xm);var Ym=function(e){function t(){var t=this;e.call(this);this._widget=null;this._viewBound=null;this._contentBound=null;this._contentWidget=null;this._viewPortWidget=null;this._hScrollBarComp=null;this._vScrollBarComp=null;this._dragging=false;this._velocity=Rt.zero();this._startPos=Rt.zero();this._startPoint=Rt.zero();this._fingerId=-1;this._correctInited=false;this._prevContentBound=null;this._prevViewBound=null;this._prevPosition=Rt.zero();this._onMouseDown=function(e){if(t.enabled===false){return}e.stop();t._dragging=true;t._startPos=Rt.new(t._contentWidget.offsetX,t._contentWidget.offsetY);t._startPoint=Rt.new(e.mouseX,e.mouseY)};this._onMouseUp=function(e){if(t.enabled===false){return}e.stop();t._dragging=false};this._onMouseMove=function(e){if(t.enabled===false){return}e.stop();if(t._dragging){t._onDrag(Rt.new(e.mouseX,e.mouseY))}};this._onTouchStart=function(e){if(t.enabled===false){return}e.stop();if(t._fingerId!==-1){return}t._fingerId=e.id;t._dragging=true;t._startPos=Rt.new(t._contentWidget.offsetX,t._contentWidget.offsetY);t._startPoint=Rt.new(e.x,e.y)};this._onTouchMove=function(e){if(t.enabled===false){return}e.stop();if(e.id===t._fingerId){if(t._dragging){t._onDrag(Rt.new(e.x,e.y))}}};this._onTouchEnd=function(e){if(t.enabled===false){return}e.stop();if(e.id!==t._fingerId){return}t._fingerId=-1;t._dragging=false};this._updateScrollView=function(e){if(e.component._dragging===false){return}t._updateBound();var r=e.component.reverse?1-e.component.value:e.component.value;if(e.component.direction==="horizontal"){var n=t._contentBound.size.x-t._viewBound.size.x;var i=n*r;var a=t._viewBound.min.x-t._contentBound.min.x;t._contentWidget.offsetX+=a-i}else{var o=t._contentBound.size.y-t._viewBound.size.y;var s=o*r;var l=t._viewBound.min.y-t._contentBound.min.y;t._contentWidget.offsetY+=l-s}t._updateBound()}}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.onInit=function t(){e.prototype.onInit.call(this);this._widget=this._entity.getComp("Widget");this._viewPortWidget=this._viewPort&&this._viewPort.getComp("Widget");this._contentWidget=this._content&&this._content.getComp("Widget");if(this._vScrollBarComp){this._vScrollBar.off("ScrollBar.onValueChanged",this._updateScrollView)}this._vScrollBarComp=this._vScrollBar&&this._vScrollBar.getComp("ScrollBar");if(this._vScrollBarComp){this._vScrollBar._reverse=true;this._vScrollBar.on("ScrollBar.onValueChanged",this._updateScrollView)}if(this._hScrollBarComp){this._hScrollBar.off("ScrollBar.onValueChanged",this._updateScrollView)}this._hScrollBarComp=this._hScrollBar&&this._hScrollBar.getComp("ScrollBar");if(this._hScrollBarComp){this._hScrollBar.on("ScrollBar.onValueChanged",this._updateScrollView)}};t.prototype.onDestroy=function t(){this._vScrollBar._entity.off("ScrollBar.onValueChanged",this._updateScrollView);this._hScrollBar._entity.off("ScrollBar.onValueChanged",this._updateScrollView);e.prototype.onDestroy.call(this)};t.prototype.tick=function e(){if(this._viewPortWidget){if(this._viewPortWidget.anchorLeft!==0||this._viewPortWidget.anchorRight!==1||this._viewPortWidget.anchorBottom!==0||this._viewPortWidget.anchorTop!==1){this._viewPortWidget.setAnchors(0,0,1,1)}}if(this._correctInited===false){this._correctVisual()}};t.prototype._correctVisual=function e(){this._getBound();if(this._viewBound&&!Lt.equals(this._viewBound.size,Lt.zero())&&this._contentBound&&!Lt.equals(this._contentBound.size,Lt.zero())){this._correctInited=true;if(this._viewBound.size.x>=this._contentBound.size.x){if(this._hScrollBar&&this._hScrollBar.active){this._hScrollBar.active=false}if(this._viewPortWidget){this._viewPortWidget.offsetY=0;this._viewPortWidget.sizeY=0}}else{if(this._hScrollBar){if(this._hScrollBar.active===false){this._hScrollBar.active=true}var t=this._hScrollBar.getComp("Widget");if(this._viewPortWidget){this._viewPortWidget.offsetY=t._rect.h*(1-this._viewPortWidget.pivotY);this._viewPortWidget.sizeY=-t._rect.h}t.setAnchors(0,0,1,0);if(this._vScrollBar){if(this._vScrollBar.active){var r=this._vScrollBar.getComp("Widget");t.sizeX=-r._rect.w;t.offsetX=-r._rect.w*t.pivotX}else{t.sizeX=0;t.offsetX=0}}}}if(this._viewBound.size.y>=this._contentBound.size.y){if(this._vScrollBar&&this._vScrollBar.active){this._vScrollBar.active=false}if(this._viewPortWidget){this._viewPortWidget.offsetX=0;this._viewPortWidget.sizeX=0}}else{if(this._vScrollBar){if(this._vScrollBar.active===false){this._vScrollBar.active=true}var n=this._vScrollBar.getComp("Widget");if(this._viewPortWidget){this._viewPortWidget.offsetX=-n._rect.w*this._viewPortWidget.pivotX;this._viewPortWidget.sizeX=-n._rect.w}n.setAnchors(1,0,1,1);if(this._hScrollBar){if(this._hScrollBar.active){var i=this._hScrollBar.getComp("Widget");n.sizeY=-i._rect.h;n.offsetY=i._rect.h*(1-n.pivotY)}else{n.sizeY=0;n.offsetY=0}}}}}};t.prototype.postTick=function e(){this._lateUpdate()};t.prototype._onDrag=function e(t){if(!this._contentWidget){return}this._updateBound();var r=Rt.zero(),n=Rt.zero();Rt.subtract(r,t,this._startPoint);Rt.add(n,r,this._startPos);Rt.subtract(r,n,Rt.new(this._contentWidget.offsetX,this._contentWidget.offsetY));var i=this._calculateOffset(r);Rt.add(n,n,i);var a=[n.x,n.y];if(this._movementType=="elastic"){var o=this._viewBound.size;if(i.x!==0){a[0]-=(1-1/(Math.abs(i.x)*.5/o.x+1))*o.x*this._sign(i.x)}if(i.y!==0){a[1]-=(1-1/(Math.abs(i.y)*.5/o.y+1))*o.y*this._sign(i.y)}}this._setContentOffset(Rt.new(a[0],a[1]))};t.prototype._sign=function e(t){if(t>=0){return 1}return-1};t.prototype._getBound=function e(){if(!this._contentWidget){return new qm(Lt.zero(),Lt.zero())}var t=[Lt.zero(),Lt.zero(),Lt.zero(),Lt.zero()];this._viewPortWidget.getWorldCorners(t[0],t[1],t[2],t[3]);var r=Lt.zero();Lt.add(r,t[0],t[2]);Lt.divide(r,r,Lt.new(2,2,2));var n=this._viewPortWidget._rect;this._viewBound=new qm(r,Lt.new(n.w,n.h,0));var i=[Lt.zero(),Lt.zero(),Lt.zero(),Lt.zero()];this._contentWidget.getWorldCorners(i[0],i[1],i[2],i[3]);var a=Lt.new(3.4e38,3.4e38,3.4e38);var o=Lt.new(-3.4e38,-3.4e38,-3.4e38);for(var s=0;s<4;s++){Lt.min(a,a,i[s]);Lt.max(o,o,i[s])}this._contentBound=new qm(a,Lt.zero());this._contentBound.encapsulate(o)};t.prototype._adjustBound=function e(t,r){var n=[t.x,t.y];var i=[r.x,r.y];var a=Lt.zero();Lt.subtract(a,this._viewBound.size,this._contentBound.size);if(a.x>0){i[0]-=a.x*(this._contentWidget.pivotX-.5);n[0]=this._viewBound.size.x}if(a.y>0){i[1]-=a.y*(this._contentWidget.pivotY-.5);n[1]=this._viewBound.size.y}return{size:Lt.new(n[0],n[1],0),center:Lt.new(i[0],i[1],0)}};t.prototype._updateBound=function e(){this._getBound();if(!this._contentWidget){return}var t=this._contentBound.size;var r=this._contentBound.center;var n=this._adjustBound(t,r);this._contentBound.size=n.size;this._contentBound.center=n.center;if(this._movementType==="clamp"){var i=[0,0];if(this._viewBound.max.x>this._contentBound.max.y){i[0]=Math.min(this._viewBound.max.x-this._contentBound.max.x,this._viewBound.min.x-this._contentBound.min.x)}else if(this._viewBound.min.x<this._contentBound.min.x){i[0]=Math.max(this._viewBound.max.x-this._contentBound.max.x,this._viewBound.min.x-this._contentBound.min.x)}if(this._viewBound.max.y>this._contentBound.max.y){i[1]=Math.min(this._viewBound.max.y-this._contentBound.max.y,this._viewBound.min.y-this._contentBound.min.y)}else if(this._viewBound.min.y<this._contentBound.min.y){i[1]=Math.max(this._viewBound.max.y-this._contentBound.max.y,this._viewBound.min.y-this._contentBound.min.y)}if(!Rt.equals(Rt.new(i.x,i.y),Rt.zero())){r=[];r[0]=this._contentWidget.offsetX+i[0];r[1]=this._contentWidget.offsetY+i[1];if(!this._horizontal){r[0]=this._contentWidget.offsetX}if(!this._vertical){r[1]=this._contentWidget.offsetX}this._setContentOffset(Rt.new(r[0],r[1]))}}};t.prototype._calculateOffset=function e(t){var r=[0,0];if(this._movementType==="unrestricted"){return Rt.zero()}else{var n=[this._contentBound.min.x,this._contentBound.min.y];var i=[this._contentBound.max.x,this._contentBound.max.y];if(this._horizontal){n[0]+=t.x;i[0]+=t.x;if(n[0]>this._viewBound.min.x){r[0]=this._viewBound.min.x-n[0]}else if(i[0]<this._viewBound.max.x){r[0]=this._viewBound.max.x-i[0]}}if(this._vertical){n[1]+=t.y;i[1]+=t.y;if(n[1]>this._viewBound.min.y){r[1]=this._viewBound.min.y-n[1]}else if(i[1]<this._viewBound.max.y){r[1]=this._viewBound.max.y-i[1]}}}return Rt.new(r[0],r[1])};t.prototype._lateUpdate=function e(){var t=this;if(!this._contentWidget){return}this._getBound();var r=this._calculateOffset(Rt.zero());var n=!Rt.equals(r,Rt.zero());var i=!Rt.equals(this._velocity,Rt.zero());if(!this._dragging&&(n||i)){var a=[this._contentWidget.offsetX,this._contentWidget.offsetY];var o=[r.x,r.y];var s=[this._velocity.x,this._velocity.y];for(var l=0;l<2;l++){if(t._movementType==="elastic"&&o[l]!==0){var u=t._smoothBack(a[l],a[l]+o[l],s[l]);a[l]=u.value;s[l]=u.velocity;if(Math.abs(s[l])<1){s[l]=0}}else if(t._inertia){s[l]=s[l]*Math.pow(t._brake,t._app.deltaTime);if(Math.abs(s[l])<1){s[l]=0}a[l]+=s[l]*t._app.deltaTime}else{s[l]=0}}this._velocity=Rt.new(s[0],s[1]);if(!Rt.equals(this._velocity,Rt.zero())){if(this._movementType==="clamped"){var h=Rt.zero();Rt.subtract(h,Rt.new(a.x,a.y),Rt.new(this._contentWidget.offsetX,this._contentWidget.offsetY));r=this._calculateOffset(h);a[0]+=r.x;a[1]+=r.y}this._setContentOffset(Rt.new(a[0],a[1]))}else if(!Rt.equals(r,Rt.zero())){this._setContentOffset(Rt.new(a[0]+r.x,a[1]+r.y))}}var c=Rt.new(this._contentWidget.offsetX,this._contentWidget.offsetY);if(this._dragging&&this._inertia){var f=Rt.zero();Rt.subtract(f,c,this._prevPosition);Rt.divide(f,f,Rt.new(this._app.deltaTime,this._app.deltaTime));Rt.lerp(this._velocity,this._velocity,f,this._app.deltaTime*10)}if(this._prevPosition.x-c.x>.01||this._prevPosition.y>c.y>.01||this._viewBound!==this._prevViewBound||this._contentBound!==this._prevContentBound){this._updateScrollBar();this._emitValueChangedEvents();this._updatePrevData()}};t.prototype._smoothBack=function e(t,r,n){var i=this._app.deltaTime;this._elasticityDuration=Math.max(1e-4,this._elasticityDuration);var a=2/this._elasticityDuration;var o=a*i;var s=1/(1+o+.48*Math.pow(o,2)+.235*Math.pow(o,3));var l=t-r;var u=r;var h=ot*this._elasticityDuration;l=He(l,-h,h);r=t-l;var c=(n+a*l)*i;n=(n-a*c)*s;var f=r+(l+c)*s;if(u-t>0===f>u){f=u;n=(f-u)/i}return{value:f,velocity:n}};t.prototype._setContentOffset=function e(t){var r=[t.x,t.y];if(!this._contentWidget){return}if(!this._horizontal){r[0]=this._contentWidget.offsetX}if(!this._vertical){r[1]=this._contentWidget.offsetY}if(!Rt.equals(t,Rt.new(this._contentWidget.offsetX,this._contentWidget.offsetY))){this._contentWidget.setOffset(r[0],r[1]);this._updateBound()}};t.prototype._updatePrevData=function e(){this._prevPosition=Rt.new(this._contentWidget.offsetX,this._contentWidget.offsetY);this._prevContentBound=this._contentBound;this._prevViewBound=this._viewBound};t.prototype._updateScrollBar=function e(){var t=this._calculateOffset(Rt.zero());if(this._hScrollBarComp&&this._hScrollBar.active&&this._hScrollBarComp.handle){this._hScrollBarComp.size=je(this._viewBound.size.x/(this._contentBound.size.x+Math.abs(t.x)));if(this._contentBound.size.x<=this._viewBound.size.x){this._hScrollBarComp.value=this._viewBound.min.x<=this._contentBound.min.x?0:1}else{var r=(this._viewBound.min.x-this._contentBound.min.x)/(this._contentBound.size.x-this._viewBound.size.x);this._hScrollBarComp.value=this._hScrollBarComp.reverse?1-je(r,0,1):je(r,0,1)}}if(this._vScrollBarComp&&this._vScrollBar.active&&this._vScrollBarComp.handle){this._vScrollBarComp.size=je(this._viewBound.size.y/(this._contentBound.size.y+Math.abs(t.y)));if(this._contentBound.size.y<=this._viewBound.size.y){this._vScrollBarComp.value=this._viewBound.min.x<=this._contentBound.min.x?0:1}else{var n=(this._viewBound.min.y-this._contentBound.min.y)/(this._contentBound.size.y-this._viewBound.size.y);this._vScrollBarComp.value=this._vScrollBarComp.reverse?1-je(n,0,1):je(n,0,1)}}};t.prototype._emitValueChangedEvents=function e(){this.dispatch("ScrollView.onValueChanged")};return t}(cm);Ym.events={mousedown:"_onMouseDown",mousemove:"_onMouseMove",mouseup:"_onMouseUp",touchstart:"_onTouchStart",touchmove:"_onTouchMove",touchend:"_onTouchEnd"};Ym.schema={horizontal:{type:"boolean",default:true},vertical:{type:"boolean",default:true},viewPort:{type:"entity",default:null,set:function e(t){if(!(t instanceof Zi)){return}if(this._viewPort===t){return}this._viewPort=t;if(!this._viewPort){console.warn("ViewPort cannot be null")}if(this._viewPort){this._viewPortWidget=this._viewPort.getComp("Widget")}}},content:{type:"entity",default:null,set:function e(t){if(!(t instanceof Zi)){return}if(this._content===t){return}this._content=t;if(!this._content){console.warn("Content cannot be null");return}if(this._content){this._contentWidget=this._content.getComp("Widget")}}},movementType:{type:"enums",default:"clamped",options:["unrestricted","elastic","clamped"]},elasticityDuration:{type:"number",default:.1},inertia:{type:"boolean",default:true},brake:{type:"number",default:.135},vScrollBar:{type:"entity",default:null,set:function e(t){if(!(t instanceof Zi)){return}if(this._vScrollBar===t){return}if(this._vScrollBarComp){this._vScrollBar.off("ScrollBar.onValueChanged",this._updateScrollView)}this._vScrollBar=t;if(this._vScrollBar){this._vScrollBar.on("ScrollBar.onValueChanged",this._updateScrollView);this._vScrollBarComp=this._vScrollBar.getComp("ScrollBar");this._vScrollBarComp.reverse=true;this._correctVisual()}}},hScrollBar:{type:"entity",default:null,set:function e(t){if(!(t instanceof Zi)){return}if(this._hScrollBar===t){return}if(this._hScrollBarComp){this._hScrollBar.off("ScrollBar.onValueChanged",this._updateScrollView)}this._hScrollBar=t;if(this._hScrollBar){this._hScrollBar.on("ScrollBar.onValueChanged",this._updateScrollView);this._hScrollBarComp=this._hScrollBar.getComp("ScrollBar");this._correctVisual()}}}};var Km=function(e){function t(){e.call(this);this._childManager=[];this._childAlignEnum=0;this._cornerEnum=0;this._lastSize=Rt.zero();this._dirty=false}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.onInit=function t(){e.prototype.onInit.call(this);this._widget=this._entity.getComp("Widget");var r=["upper-left","upper-center","upper-right","middle-left","middle-center","middle-right","lower-left","lower-center","lower-right"];this._childAlignEnum=r.indexOf(this._childAlign);if(this._childAlignEnum===-1){this._childAlignEnum=0}r=["upper-left","upper-right","lower-left","lower-right"];this._cornerEnum=r.indexOf(this._corner);if(this._cornerEnum===-1){this._cornerEnum=0}this._lastSize=Rt.new(this._widget._rect.w,this._widget._rect.h)};t.prototype.tick=function e(){var t=this;if(!Rt.equals(this._lastSize,Rt.new(this._widget._rect.w,this._widget._rect.h))){this._lastSize=Rt.new(this._widget._rect.w,this._widget._rect.h);this._dirty=true}if(!this._dirty){if(this._childManager.length!==this._entity.children.length){this._dirty=true}else{for(var r=0;r<this._entity.children.length;++r){var n=t._entity.children[r];if(n.enabled!==t._childManager[r].enabled){t._dirty=true;break}}}}if(this._dirty){this._calculate();this._dirty=false}};t.prototype.reset=function e(){this._setSpacing(0,0);this._setPadding(0,0,0,0);this._setCellSize(100,100);this._axisDirection="horizontal";var t=["upper-left","upper-right","lower-left","lower-right"];this._corner="upper-left";this._cornerEnum=t.indexOf(this._corner);t=["upper-left","upper-center","upper-right","middle-left","middle-center","middle-right","lower-left","lower-center","lower-right"];this._childAlign="upper-left";this._childAlignEnum=t.indexOf(this._childAlign);this._constraint="flexible";this._constraintCount=2;this._dirty=true};t.prototype._calculate=function e(){var t=this;if(!this._widget){return}this._childManager=[];var r=this._widget._rect.w,n=this._widget._rect.h;var i=this._entity.children.length;var a,o;if(this._constraint==="fixed-row"){a=He(this._constraintCount,1,i);o=Math.max(1,Math.ceil(i/(1*a)))}else if(this._constraint==="fixed-col"){o=He(this._constraintCount,1,i);a=Math.max(1,Math.ceil(i/(1*o)))}else{if(this._cellWidth+this._spacingX<=0){o=65535}else{o=Math.floor((r-this._getPaddingHorizontal()+this._spacingX)/(this._cellWidth+this._spacingX));o=Math.max(1,o)}if(this._cellHeight+this._spacingY<=0){a=65535}else{a=Math.floor((n-this._getPaddingVertical()+this._spacingY)/(this._cellHeight+this._spacingY));a=Math.max(1,a)}}var s,l,u;if(this._axisDirection==="horizontal"){u=o;s=He(o,1,i);l=He(a,1,Math.ceil(i/(1*u)))}else{u=a;l=He(a,1,i);s=He(o,1,Math.ceil(i/(1*u)))}var h=Rt.new(this._cellWidth*s+this._spacingX*(s-1),this._cellHeight*l+this._spacingY*(l-1));var c=Rt.new(this._getStartOffset("horizontal",h.x),this._getStartOffset("vertical",h.y));var f=this._cornerEnum%2,p=parseInt(this._cornerEnum/2);var d=0;for(var v=0;v<i;++v){var m=t._entity.children[v];if(m.enabled===false){continue}var _=m.getComp("Widget");_.setSize(t._cellWidth,t._cellHeight);_.setAnchors(0,1,0,1);var g=void 0,y=void 0;if(t._axisDirection==="horizontal"){g=d%u;y=parseInt(d/u)}else{g=parseInt(d/u);y=d%u}var x=void 0,b=void 0;if(f===1){g=s-g-1}if(p===1){y=l-y-1}x=c.x+(t._cellWidth+t._spacingX)*g+_.pivotX*t._cellWidth;b=c.y+(t._cellHeight+t._spacingY)*y+(1-_.pivotY)*t._cellHeight;_.setOffset(x,-b);t._childManager.push(m);d++}};t.prototype._getStartOffset=function e(t,r){var n=r+(t==="horizontal"?this._getPaddingHorizontal():this._getPaddingVertical());var i=(t==="horizontal"?this._widget._rect.w:this._widget._rect.h)-n;var a=t==="horizontal"?this._childAlignEnum%3*.5:parseInt(this._childAlignEnum/3)*.5;return(t==="horizontal"?this._paddingLeft:this._paddingTop)+i*a};t.prototype._getPaddingHorizontal=function e(){return this._paddingLeft+this._paddingRight};t.prototype._getPaddingVertical=function e(){return this._paddingTop+this._paddingBottom};t.prototype._setPadding=function e(t,r,n,i){this._paddingLeft=t;this._paddingRight=n;this._paddingBottom=r;this._paddingTop=i};t.prototype._setSpacing=function e(t,r){this._spacingX=t;this._spacingY=r};t.prototype._setCellSize=function e(t,r){this._cellWidth=t;this._cellHeight=r};t.prototype.getItems=function e(){return this._childManager};return t}(cm);Km.schema={axisDirection:{type:"enums",default:"horizontal",options:["horizontal","vertical"],set:function e(t){if(this._axisDirection===t){return}this._axisDirection=t;this._dirty=true}},paddingLeft:{type:"number",default:0,set:function e(t){if(this._paddingLeft===t){return}this._paddingLeft=t;this._dirty=true}},paddingRight:{type:"number",default:0,set:function e(t){if(this._paddingRight===t){return}this._paddingRight=t;this._dirty=true}},paddingBottom:{type:"number",default:0,set:function e(t){if(this._paddingBottom===t){return}this._paddingBottom=t;this._dirty=true}},paddingTop:{type:"number",default:0,set:function e(t){if(this._paddingTop===t){return}this._paddingTop=t;this._dirty=true}},cellWidth:{type:"number",default:100,set:function e(t){if(this._cellWidth===t){return}this._cellWidth=t;this._dirty=true}},cellHeight:{type:"number",default:100,set:function e(t){if(this._cellHeight===t){return}this._cellHeight=t;this._dirty=true}},spacingX:{type:"number",default:0,set:function e(t){if(this._spacingX===t){return}this._spacingX=t;this._dirty=true}},spacingY:{type:"number",default:0,set:function e(t){if(this._spacingY===t){return}this._spacingY=t;this._dirty=true}},corner:{type:"enums",default:"upper-left",options:["upper-left","upper-right","lower-left","lower-right"],set:function e(t){if(this._corner===t){return}var r=["upper-left","upper-right","lower-left","lower-right"];this._cornerEnum=r.indexOf(t);if(this._cornerEnum!==-1){this._corner=t;this._dirty=true}else{this._cornerEnum=0}}},childAlign:{type:"enums",default:"upper-left",options:["upper-left","upper-center","upper-right","middle-left","middle-center","middle-right","lower-left","lower-center","lower-right"],set:function e(t){if(this._childAlign===t){return}var r=["upper-left","upper-center","upper-right","middle-left","middle-center","middle-right","lower-left","lower-center","lower-right"];this._childAlignEnum=r.indexOf(t);if(this._childAlignEnum!==-1){this._childAlign=t;this._dirty=true}else{this._childAlignEnum=0}}},constraint:{type:"enums",default:"flexible",options:["flexible","fixed-row","fixed-col"],set:function e(t){if(this._constraint===t){return}this._constraint=t;this._dirty=true}},constraintCount:{type:"int",default:2,set:function e(t){if(this._constraintCount===t){return}this._constraintCount=t;this._dirty=true}}};var Zm=function(e){function t(){e.call(this);this._scripts=new en(200)}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.add=function e(t){this._scripts.push(t);t.awake()};t.prototype.remove=function e(t){var r=this;for(var n=0;n<this._scripts.length;++n){var i=r._scripts.data[n];if(i===t){r._scripts.fastRemove(n);t.end();break}}};t.prototype.tick=function e(){var t=this;for(var r=0;r<this._scripts.length;++r){var n=t._scripts.data[r];if(n.destroyed||!n.enabled){continue}if(n._startedFlag===0){n._startedFlag=1;n.start();continue}n.tick()}};t.prototype.postTick=function e(){var t=this;for(var r=0;r<this._scripts.length;++r){var n=t._scripts.data[r];if(n._startedFlag===1){n._startedFlag=2;continue}if(n.destroyed||!n.enabled){continue}n.postTick()}};return t}($i);var Qm=function(e){function t(){e.call(this);this._comps=new en(200)}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.add=function e(t){this._comps.push(t)};t.prototype.remove=function e(t){var r=this;for(var n=0;n<this._comps.length;++n){var i=r._comps.data[n];if(i===t){r._comps.fastRemove(n);break}}};t.prototype.tick=function e(){var t=this;for(var r=0;r<this._comps.length;++r){var n=t._comps.data[r];if(n.enabled===false){continue}n._updateMatrices()}};return t}($i);var Jm=function(e){function t(){e.call(this);this._anims=new en(200)}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.add=function e(t){this._anims.push(t)};t.prototype.remove=function e(t){var r=this;for(var n=0;n<this._anims.length;++n){var i=r._anims.data[n];if(i===t){r._anims.fastRemove(n);break}}};t.prototype.tick=function e(){var t=this;for(var r=0;r<this._anims.length;++r){var n=t._anims.data[r];n._animCtrl.tick(t._app.deltaTime)}};return t}($i);var $m=function(e){function t(){e.call(this);this.instanceID=0;this.id2audio={};this.url2id={};var t={};var r=false;var n=t.browserVersion;var i=!!(window.AudioContext||window.webkitAudioContext||window.mozAudioContext);var a={ONLY_ONE:false,WEB_AUDIO:i,DELAY_CREATE_CTX:false};if(t.os===t.OS_IOS){a.USE_LOADER_EVENT="loadedmetadata"}if(t.browserType===t.BROWSER_TYPE_FIREFOX){a.DELAY_CREATE_CTX=true;a.USE_LOADER_EVENT="canplay"}if(t.os===t.OS_ANDROID){if(t.browserType===t.BROWSER_TYPE_UC){a.ONE_SOURCE=true}}if(r){setTimeout(function(){console.log("browse type: "+t.browserType);console.log("browse version: "+n);console.log("MULTI_CHANNEL: "+a.MULTI_CHANNEL);console.log("WEB_AUDIO: "+a.WEB_AUDIO);console.log("AUTOPLAY: "+a.AUTOPLAY)},0)}try{if(a.WEB_AUDIO){a.context=new(window.AudioContext||window.webkitAudioContext||window.mozAudioContext);if(a.DELAY_CREATE_CTX){setTimeout(function(){a.context=new(window.AudioContext||window.webkitAudioContext||window.mozAudioContext)},0)}}}catch(e){a.WEB_AUDIO=false;console.log(e)}function o(){var e=[];var t=document.createElement("audio");if(t.canPlayType){var r=t.canPlayType('audio/ogg; codecs="vorbis"');if(r){e.push(".ogg")}var n=t.canPlayType("audio/mpeg");if(n){e.push(".mp3")}var i=t.canPlayType('audio/wav; codecs="1"');if(i){e.push(".wav")}var a=t.canPlayType("audio/mp4");if(a){e.push(".mp4")}var o=t.canPlayType("audio/x-m4a");if(o){e.push(".m4a")}}return e}a.format=o();this.__audioSupport=a;this._audios=new en(200)}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.add=function e(t){this._audios.push(t)};t.prototype.remove=function e(t){var r=this;for(var n=0;n<this._audios.length;++n){var i=r._audios.data[n];if(i===t){r._audios.fastRemove(n);break}}};t.prototype.addClip=function e(t,r){this.instanceID++;this.url2id[t]=this.instanceID;this.id2audio[this.instanceID]=r;return this.instanceID};t.prototype.getIDByURL=function e(t){return this.url2id[t]};t.prototype.removeClip=function e(t){var r=null;if(!t){return}else if(typeof t==="string"){r=t}else{r=t.url}var n=this.url2id[r];delete this.url2id[r];var i=this.id2audio[n];if(i){i.stop();i.destroy();delete this.id2audio[n]}};t.prototype.setVolumeForAll=function e(t){var r=this;for(var n=0;n<this._audios.length;n++){r._audios.data[n].setVolume(t)}};t.prototype.pauseAll=function e(){var t=this;for(var r=0;r<this._audios.length;r++){t._audios.data[r].pause()}};t.prototype.stopAll=function e(){var t=this;for(var r=0;r<this._audios.length;r++){t._audios.data[r].stop()}};t.prototype.resumeAll=function e(){var t=this;for(var r=0;r<this._audios.length;r++){t._audios.data[r].resume()}};t.prototype._getClipByURL=function e(t){return this.id2audio[this.url2id[t]]};t.prototype._getClipByID=function e(t){return this.id2audio[t]};return t}($i);var e_=function(e){function t(t,r){e.call(this,t,r);this.reset()}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.reset=function e(){this._stopped=false;this.target=null;this.bubbles=false;this.dx=0;this.dy=0;this.mouseX=0;this.mouseY=0;this.button=0;this.buttons=0};return t}(Ni);var t_=function(e){function t(t,r){e.call(this,t,r);this.reset()}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.reset=function e(){this._stopped=false;this.target=null;this.bubbles=false;this.key=""};return t}(Ni);var r_=function(e){function t(t,r){e.call(this,t,r);this.reset()}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.reset=function e(){this._stopped=false;this.target=null;this.bubbles=false;this.dx=0;this.dy=0;this.x=0;this.y=0};return t}(Ni);var n_=function(e){function t(t,r){e.call(this,t,r);this.reset()}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.reset=function e(){this._stopped=false;this.target=null;this.bubbles=false;this.relatedTarget=null};return t}(Ni);var i_=8;function a_(e,t,r,n,i,a,o,s,l){var u=e.effectInst.getTechnique("ui");for(var h=0;h<u.passes.length;++h){var c=u.passes[h];c.setStencilFront(t,r,n,i,a,o,s,l);c.setStencilBack(t,r,n,i,a,o,s,l)}}var o_=function e(t){this._app=t;this._screen=null;this._curMaterail=null;this._curTexture=null;this._curSpriteBatch=null;this._curStencilLevel=0;this._curUserKey=0;this._dummyNode=new Tn;this._materialPool=new on(function(){return new us},100);this._spriteBatchModelPool=new on(function(){return new Ui.SpriteBatchModel},100)};o_.prototype.reset=function e(){var t=this;for(var r=0;r<this._spriteBatchModelPool.length;++r){var n=t._spriteBatchModelPool.data[r];n.clear();t._app.scene.removeModel(n)}this._materialPool.reset();this._spriteBatchModelPool.reset()};o_.prototype.resetScreen=function e(t){this._screen=t;this._curMaterail=null;this._curTexture=null;this._curSpriteBatch=null;this._curStencilLevel=0;this._curUserKey=0};o_.prototype._stencilWriteMask=function e(){return 1<<this._curStencilLevel-1};o_.prototype._stencilRef=function e(){var t=0;for(var r=0;r<this._curStencilLevel;++r){t+=1<<r}return t};o_.prototype._cloneMaterial=function e(t){var r=this._materialPool.add();r.copy(t);return r};o_.prototype._getSpriteBatchModel=function e(t,r){if(this._curSpriteBatch!==null&&this._curMaterail===t&&this._curTexture===r){return this._curSpriteBatch}var n=this._cloneMaterial(t);n.setProperty("mainTexture",r);if(this._curStencilLevel!==0){var i=this._stencilRef();a_(n,true,Me.DS_FUNC_EQUAL,i,i,Me.STENCIL_OP_KEEP,Me.STENCIL_OP_KEEP,Me.STENCIL_OP_KEEP,0)}else{a_(n,false,Me.DS_FUNC_ALWAYS,0,0,Me.STENCIL_OP_KEEP,Me.STENCIL_OP_KEEP,Me.STENCIL_OP_KEEP,0)}var a=this._spriteBatchModelPool.add();a.setNode(this._dummyNode);a.setEffect(n.effectInst);a._viewID=this._screen._view._id;a.setUserKey(this._curUserKey++);this._app.scene.addModel(a);this._curMaterail=t;this._curTexture=r;this._curSpriteBatch=a;return a};o_.prototype.addImage=function e(t){var r=t.calcVertexData(t._rect.x,t._rect.y,t._rect.w,t._rect.h);var n=t.sprite;if(t.sprite===null){n=this._app.assets.get("default-sprite")}var i=this._getSpriteBatchModel(t.material,n.texture);i.addSprite(r.wposList,r.uvs,r.color,r.indices)};o_.prototype.addText=function e(t){var r=t.calcVertexData(t._rect.x,t._rect.y,t._rect.w,t._rect.h);var n=t.font===null?t.fontTexture:t.font.texture;var i=this._getSpriteBatchModel(t.material,n);i.addSprite(r.wposList,r.uvs,r.color,r.indices)};o_.prototype.pushMask=function e(t){if(this._curStencilLevel+1>i_){console.error("Stencil level exceeed, we only support "+i_+" level in this device.");return}this._curStencilLevel++;var r=t.calcVertexData(t._rect.x,t._rect.y,t._rect.w,t._rect.h);this._curSpriteBatch=null;var n=t.sprite;if(t.sprite===null){n=this._app.assets.get("default-sprite")}var i=this._cloneMaterial(t.material);i.setProperty("mainTexture",n.texture);var a=this._stencilRef();var o=this._stencilWriteMask();a_(i,true,Me.DS_FUNC_NEVER,a,o,Me.STENCIL_OP_REPLACE,Me.STENCIL_OP_KEEP,Me.STENCIL_OP_KEEP,o);var s=this._spriteBatchModelPool.add();s.setNode(this._dummyNode);s.setEffect(i.effectInst);s._viewID=this._screen._view._id;s.setUserKey(this._curUserKey++);s.addSprite(r.wposList,r.uvs,r.color,r.indices);this._app.scene.addModel(s)};o_.prototype.popMask=function e(t){if(this._curStencilLevel-1<0){console.error("popMask being called more than once");return}this._curSpriteBatch=null;var r=t.calcVertexData(t._rect.x,t._rect.y,t._rect.w,t._rect.h);var n=t.sprite;if(t.sprite===null){n=this._app.assets.get("default-sprite")}var i=this._cloneMaterial(t.material);i.setProperty("mainTexture",n.texture);var a=this._stencilWriteMask();a_(i,true,Me.DS_FUNC_NEVER,0,a,Me.STENCIL_OP_REPLACE,Me.STENCIL_OP_KEEP,Me.STENCIL_OP_KEEP,a);var o=this._spriteBatchModelPool.add();o.setNode(this._dummyNode);o.setEffect(i.effectInst);o._viewID=this._screen._view._id;o.setUserKey(this._curUserKey++);o.addSprite(r.wposList,r.uvs,r.color,r.indices);this._app.scene.addModel(o);this._curStencilLevel--};var s_=new en(100);var l_=["left","middle","right"];var u_=function(){var e=Lt.zero();var t=Lt.zero();var r=Lt.zero();var n=Lt.zero();var i=Lt.zero();var a=Lt.zero();return function(o,s,l,u){Lt.set(e,l,u,1);Lt.set(t,l,u,-1);for(var h=s.length-1;h>=0;--h){var c=s.data[h];var f=c.getComp("Widget");f.getWorldCorners(r,n,i,a);if(or.line_quad(e,t,r,n,i,a)){var p=c.parent;var d=p.getComp("Widget");var v=false;while(d){if(p.getComp("Mask")){d.getWorldCorners(r,n,i,a);if(or.line_quad(e,t,r,n,i,a)===false){v=true}}p=p.parent;d=p.getComp("Widget")}if(v){continue}return c}}return null}}();var h_=function(e){function t(){e.call(this);this._screens=[];this._screenRenderHelper=null;this._hoveringEntity=null;this._focusedEntity=null;this._capturingEntities=[];this._mouseEventPool=new on(function(){return new e_("unknown")},8);this._keyboardEventPool=new on(function(){return new t_("unknown")},8);this._touchEventPool=new on(function(){return new r_("unknown")},8);this._focusEventPool=new on(function(){return new n_("unknown")},8)}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;var r={hoveringEntity:{configurable:true},focusedEntity:{configurable:true}};r.hoveringEntity.get=function(){return this._hoveringEntity};r.focusedEntity.get=function(){return this._focusedEntity};t.prototype.init=function e(){this._screenRenderHelper=new o_(this._app)};t.prototype.addScreen=function e(t){this._screens.push(t);this._app.scene.addView(t._view)};t.prototype.removeScreen=function e(t){var r=this._screens.indexOf(t);if(r!==-1){this._screens.splice(r,1);this._app.scene.removeView(t._view)}};t.prototype.tick=function e(){var t=this;this._mouseEventPool.reset();this._keyboardEventPool.reset();this._touchEventPool.reset();this._focusEventPool.reset();this._screenRenderHelper.reset();s_.reset();for(var r=0;r<this._screens.length;++r){var n=t._screens[r];if(!n.enabled){continue}var i=false;var a=n._entity.parent;while(a){if(a.getComp("Screen")){i=true;break}a=a.parent}if(i){continue}s_.push(n._entity);Dn.walkSibling(n._entity,function(e){if(e.active===true){s_.push(e);return true}else{return false}})}this._processInputs(s_);this._processLayout(s_);this._renderScreens()};t.prototype._processInputs=function e(t){var r=this;var n=this._app.input;var i=null;var a=null;if(n.hasTouch){for(var o=0;o<n.touchCount;++o){var s=n.getTouchInfo(o);a=u_(screen,t,s.x,s.y);i=r._capturingEntities[o]?r._capturingEntities[o]:a;if(i===null){continue}var l=r._touchEventPool.add();l.reset();l.id=s.id;l.dx=s.dx;l.dy=s.dy;l.x=s.x;l.y=s.y;l.target=i;if(s.phase==="start"){if(o===0){r._focus(i)}l.name="touchstart";l.bubbles=true;i.dispatch(l);r._capturingEntities[o]=i;if(o===0){r._hover(a,true)}}else if(s.phase==="pressing"){if(s.dx!==0||s.dy!==0){if(o===0){r._hover(a,true)}l.name="touchmove";l.bubbles=true;i.dispatch(l)}}else if(s.phase==="end"){if(o===0){r._hover(null,true)}l.name="touchend";l.bubbles=true;i.dispatch(l);r._capturingEntities[o]=null}else if(s.phase==="cancel"){if(o===0){r._hover(null,true)}l.name="touchcancel";l.bubbles=true;i.dispatch(l);r._capturingEntities[o]=null}}return}var u=n.hasMouseDown;var h=n.hasMouseUp;var c=n.mouseDeltaX!==0||n.mouseDeltaY!==0;if(c||u||h){a=u_(screen,t,n.mouseX,n.mouseY);i=this._capturingEntities[0]?this._capturingEntities[0]:a}if(u){this._focus(i);this._capturingEntities[0]=i}if(i){if(u){for(var f=0;f<l_.length;++f){var p=l_[f];if(n.mousedown(p)){var d=r._mouseEventPool.add();d.reset();d.name="mousedown";d.bubbles=true;d.dx=n.mouseDeltaX;d.dy=n.mouseDeltaY;d.mouseX=n.mouseX;d.mouseY=n.mouseY;d.target=i;d.button=p;d.buttons=n.mouseButtons;i.dispatch(d)}}}if(h){for(var v=0;v<l_.length;++v){var m=l_[v];if(n.mouseup(m)){var _=r._mouseEventPool.add();_.reset();_.name="mouseup";_.bubbles=true;_.dx=n.mouseDeltaX;_.dy=n.mouseDeltaY;_.mouseX=n.mouseX;_.mouseY=n.mouseY;_.target=i;_.button=m;_.buttons=n.mouseButtons;i.dispatch(_)}}this._capturingEntities[0]=null}}if(c){this._hover(a,false);if(i){var g=this._mouseEventPool.add();g.reset();g.name="mousemove";g.bubbles=true;g.dx=n.mouseDeltaX;g.dy=n.mouseDeltaY;g.mouseX=n.mouseX;g.mouseY=n.mouseY;g.target=i;g.button=0;g.buttons=n.mouseButtons;i.dispatch(g)}}if(this._focusedEntity){n._keys.forEach(function(e){if(e.state==="down"){var t=r._keyboardEventPool.add();t.reset();t.name="keydown";t.bubbles=true;t.key=e.key;t.target=r._focusedEntity;r._focusedEntity.dispatch(t)}if(e.state==="up"){var n=r._keyboardEventPool.add();n.reset();n.name="keyup";n.bubbles=true;n.key=e.key;n.target=r._focusedEntity;r._focusedEntity.dispatch(n)}})}};t.prototype._focus=function e(t){var r=t;if(r&&r._destroyed){r=null}var n=r?r.getComp("Widget"):null;while(n){if(n.focusable){break}r=r.parent;n=r.getComp("Widget")}if(this._focusedEntity===r){return}var i=this._focusedEntity;this._focusedEntity=r;if(i){var a=this._focusEventPool.add();a.reset();a.name="blur";a.bubbles=false;a.target=i;a.relatedTarget=r;i.dispatch(a)}if(r){var o=this._focusEventPool.add();o.reset();o.name="focus";o.bubbles=false;o.target=r;o.relatedTarget=i;r.dispatch(o)}};t.prototype._hover=function e(t,r){var n=this;if(this._hoveringEntity===t){return}var i=this._app.input;var a=this._hoveringEntity;this._hoveringEntity=t;var o=[];var s=[];var l=a;if(l&&l._destroyed){l=null}var u=l?l.getComp("Widget"):null;while(u){o.push(l);l=l.parent;u=l.getComp("Widget")}l=t;u=l?l.getComp("Widget"):null;while(u){s.push(l);l=l.parent;u=l.getComp("Widget")}var h=o.length;var c=s.length;var f=false;for(var p=0;p<o.length;++p){var d=o[p];for(var v=0;v<s.length;++v){var m=s[p];if(m===d){h=p;c=v;f=true}}if(f){break}}if(!r){for(var _=0;_<h;++_){var g=o[_];var y=n._mouseEventPool.add();y.reset();y.name="mouseleave";y.bubbles=false;y.dx=i.mouseDeltaX;y.dy=i.mouseDeltaY;y.mouseX=i.mouseX;y.mouseY=i.mouseY;y.target=g;y.button=0;y.buttons=i.mouseButtons;g.emit("mouseleave",y)}for(var x=c-1;x>=0;--x){var b=s[x];var w=n._mouseEventPool.add();w.reset();w.name="mouseenter";w.bubbles=false;w.dx=i.mouseDeltaX;w.dy=i.mouseDeltaY;w.mouseX=i.mouseX;w.mouseY=i.mouseY;w.target=b;w.button=0;w.buttons=i.mouseButtons;b.emit("mouseenter",w)}}else{var T=i.getTouchInfo(0);for(var E=0;E<h;++E){var S=o[E];var M=n._touchEventPool.add();M.reset();M.name="touchleave";M.bubbles=false;M.id=T.id;M.dx=T.dx;M.dy=T.dy;M.x=T.x;M.y=T.y;M.target=S;S.emit("touchleave",M)}for(var A=c-1;A>=0;--A){var R=s[A];var L=n._touchEventPool.add();L.reset();L.name="touchenter";L.bubbles=false;L.id=T.id;L.dx=T.dx;L.dy=T.dy;L.x=T.x;L.y=T.y;L.target=R;R.emit("touchenter",L)}}};t.prototype._processLayout=function e(t){var r=this;for(var n=0;n<t.length;++n){var i=t.data[n];var a=i.getComp("Widget");var o=i.parent;var s=o.getComp("Widget");var l=0,u=0;var h=0,c=0;if(s===null){l=0;u=0;h=r._app._canvas.width/a.scaleFactor;c=r._app._canvas.height/a.scaleFactor;a.setOffset(0,0);a.setAnchors(0,0,0,0);a.setSize(h,c);a.setPivot(0,0)}else{l=s._rect.x;u=s._rect.y;h=s._rect.w;c=s._rect.h}a.calculate(l,u,h,c)}};t.prototype._renderScreens=function e(){var t=this;for(var r=0;r<this._screens.length;++r){var n=t._screens[r];if(!n.enabled){continue}var i=n._view;var a=t._app._canvas.width;var o=t._app._canvas.height;Bt.ortho(i._matProj,0,a,0,o,-100,100);Bt.copy(i._matViewProj,i._matProj);Bt.invert(i._matInvViewProj,i._matProj);i._rect.x=i._rect.y=0;i._rect.w=a;i._rect.h=o;t._screenRenderHelper.resetScreen(n);Dn.walk2(n._entity,function(e){var r=e.getComp("Mask");if(r&&r.enabled){t._screenRenderHelper.pushMask(r)}var n=e.getComp("Image");if(n&&n.enabled){t._screenRenderHelper.addImage(n)}var i=e.getComp("Text");if(i&&i.enabled){t._screenRenderHelper.addText(i)}},function(e){var r=e.getComp("Mask");if(r&&r.enabled){t._screenRenderHelper.popMask(r)}})}};Object.defineProperties(t.prototype,r);return t}($i);var c_=function(e){function t(){e.call(this);this._particleSystems=new en(10)}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.add=function e(t){this._particleSystems.push(t)};t.prototype.remove=function e(t){var r=this;for(var n=0;n<this._particleSystems.length;++n){var i=r._particleSystems.data[n];if(i===t){r._particleSystems.fastRemove(n);break}}};t.prototype.tick=function e(){var t=this;for(var r=0;r<this._particleSystems.length;++r){var n=t._particleSystems.data[r];n.tick(t._app.deltaTime)}};return t}($i);function f_(e){return e.replace(/\\/g,"/").replace(/[\/]+/g,"/").replace(/\/\?/g,"?").replace(/\/\#/g,"#").replace(/\:\//g,"://")}var p_={normalize:function e(t){return f_(t)},join:function e(){var t=[].slice.call(arguments,0).join("/");return f_(t)}};da.registerLoader("mesh",Ps);da.registerLoader("material",Fs);da.registerLoader("texture",Gs);da.registerLoader("prefab",Hs);da.registerLoader("gltf",qs);da.registerLoader("animation",Xs);da.registerLoader("audio",Qs);da.registerLoader("bmfont",nl);da.registerLoader("otfont",Dd);da.registerLoader("effect",Fd);da.registerLoader("program",Vd);for(var d_ in bs){da.registerType(d_,bs[d_])}da.registerClass("Script",Gd);da.registerClass("Camera",Wd);da.registerClass("Light",Hd);da.registerClass("Model",jd);da.registerClass("SkinningModel",Xd);da.registerClass("Animation",Zd);da.registerClass("AudioSource",rv);da.registerClass("Collider",xv);da.registerClass("Skybox",bv);da.registerClass("Screen",hm);da.registerClass("ScreenScaler",fm);da.registerClass("Widget",um);da.registerClass("Mask",zm);da.registerClass("Image",Am);da.registerClass("Text",Bm);da.registerClass("UIElement",cm);da.registerClass("Button",km);da.registerClass("Toggle",Vm);da.registerClass("ToggleGroup",Gm);da.registerClass("Slider",Wm);da.registerClass("EditBox",Hm);da.registerClass("ScrollBar",jm);da.registerClass("ScrollView",Ym);da.registerClass("GridLayout",Km);da.registerClass("ParticleSystem",sm);da.registerSystem("script",Zm,"Script",0);da.registerSystem("skinning-model",Qm,"SkinningModel",100);da.registerSystem("animation",Jm,"Animation",200);da.registerSystem("audio",$m,"AudioSource",200);da.registerSystem("physics",dv,"Collider",200);da.registerSystem("widget",h_,"Widget",100);da.registerSystem("ui-element",Nm,"UIElement",101);da.registerSystem("particle-system",c_,"ParticleSystem",100);da.registerClass("Keyframe",pr);da.registerClass("AnimationCurve",dr);function v_(e){var t=e;return function(e){t._tickID=requestAnimationFrame(t._tick);if(e===undefined){e=0}t.deltaTime=(e-t._lasttime)/1e3;t.totalTime=e/1e3;t._lasttime=e;t._debugger.tick();t.emit("tick");t.tick();t._debugger.postTick();t._forward.render(t.scene);t._input.reset();t._scene.reset()}}var m_=function(e){function t(t,r){var n=this;if(r===void 0)r={};e.call(this,{poolSize:r.poolSize||100});this.__initEventEmitter();this._canvas=t;this._input=new Fi(t,{lock:false,invertY:true});this._device=new Me.Device(t,r);var i=xs(this._device);Ui.addStage("opaque");Ui.addStage("transparent");Ui.addStage("ui");Ui.addStage("shadowcast");this._forward=new Ui.ForwardRenderer(this._device,{defaultTexture:i["default-texture"]._texture,defaultTextureCube:i["default-texture-cube"]._texture});this._scene=new Ui.Scene;this._assetMng=new $a(this);this._debugger=new ss(this);for(var a in i){var o=i[a];n._assetMng.add(o._uuid,o)}da._init(this);this._sortSystems();this._tick=v_(this);this.deltaTime=0;this.totalTime=0;this._tickID=null;this._lasttime=0;this._activeCamera=null;window.addEventListener("resize",function(){n.resize()})}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;var r={device:{configurable:true},scene:{configurable:true},input:{configurable:true},assets:{configurable:true},debugger:{configurable:true}};r.device.get=function(){return this._device};r.scene.get=function(){return this._scene};r.input.get=function(){return this._input};r.assets.get=function(){return this._assetMng};r.debugger.get=function(){return this._debugger};t.prototype.run=function e(){if(!this._activeLevel){console.warn("There is no level to run, please load it first");return}this._tickID=requestAnimationFrame(this._tick)};t.prototype.resize=function e(){if(!this._canvas){return}var t=this._canvas.parentElement.getBoundingClientRect();this._canvas.width=t.width;this._canvas.height=t.height;this._input.resize()};t.prototype.destroy=function e(){this._canvas=null;this._input.destroy();this._activeLevel.destroy();this._activeLevel=null;if(this._tickID){cancelAnimationFrame(this._tickID)}};t.prototype.find=function e(t,r){if(!t){return null}r=r||this._activeLevel;return Dn.find(r,t)};t.prototype.loadGameConfig=function e(t,r){var n=this;var i=r.assets;var a=r.scenes;var o=r.entry;for(var s in i){var l=i[s];for(var u in l.urls){l.urls[u]=p_.join(t,l.urls[u])}n.assets.registerAsset(s,l)}for(var h in a){n.assets.registerLevel(h,p_.join(t,a[h]))}};Object.defineProperties(t.prototype,r);return t}(la);qi.mixin(m_);var __=Object.freeze({CANNON:sv});var g_={registerLoader:da.registerLoader,registerClass:da.registerClass,registerSystem:da.registerSystem,Node:Tn,Asset:Ma,Mesh:Ra,Joints:Ss,Material:us,Prefab:Ws,AnimationClip:Ts,AudioClip:Ks,Gltf:js,Texture:La,Texture2D:Pa,TextureCube:fs,Sprite:gs,App:m_,Level:Ji,System:$i,Component:Yi,ScriptComponent:Gd,CameraComponent:Wd,LightComponent:Hd,ModelComponent:jd,SkinningModelComponent:Xd,AnimationComponent:Zd,AudioSourceComponent:rv,SkyboxComponent:bv,ParticleSystemComponent:sm,ScreenComponent:hm,ScreenScalerComponent:fm,WidgetComponent:um,ImageComponent:Am,TextComponent:Bm,MaskComponent:zm,UIElementComponent:cm,ButtonComponent:km,ToggleComponent:Vm,ToggleGroupComponent:Gm,SliderComponent:Wm,EditBoxComponent:Hm,ScrollBarComponent:jm,BoundComponent:qm,ScrollViewComponent:Ym,GridLayoutComponent:Km,math:Nt,geometry:vr,memop:vn,primitives:Jo,renderer:Ui,gfx:Me,utils:Ka,resl:Ea,path:p_,input:Fi,physics:__,async:za};return g_}();
//# sourceMappingURL=engine.min.js.map