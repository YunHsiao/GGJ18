var cc=function(){"use strict";var e=9728;var t=9729;var n=9984;var r=9985;var i=9986;var a=9987;var o=5121;var s=5123;var l=5125;var u=5126;var h=33635;var c=32819;var f=32820;var p=36193;var d=6402;var v=6406;var m=6407;var _=6408;var g=6409;var y=6410;var x=33776;var b=33777;var w=33778;var E=33779;var T=35840;var S=35841;var A=35842;var M=35843;var R=36196;var L=[[e,n,i],[t,r,a]];var C=[{format:m,internalFormat:x,pixelType:null},{format:_,internalFormat:b,pixelType:null},{format:_,internalFormat:w,pixelType:null},{format:_,internalFormat:E,pixelType:null},{format:m,internalFormat:R,pixelType:null},{format:m,internalFormat:S,pixelType:null},{format:_,internalFormat:M,pixelType:null},{format:m,internalFormat:T,pixelType:null},{format:_,internalFormat:A,pixelType:null},{format:v,internalFormat:v,pixelType:o},{format:g,internalFormat:g,pixelType:o},{format:y,internalFormat:y,pixelType:o},{format:m,internalFormat:m,pixelType:h},{format:_,internalFormat:_,pixelType:f},{format:_,internalFormat:_,pixelType:c},{format:m,internalFormat:m,pixelType:o},{format:_,internalFormat:_,pixelType:o},{format:m,internalFormat:m,pixelType:p},{format:_,internalFormat:_,pixelType:p},{format:m,internalFormat:m,pixelType:u},{format:_,internalFormat:_,pixelType:u},{format:null,internalFormat:null,pixelType:null},{format:null,internalFormat:null,pixelType:null},{format:null,internalFormat:null,pixelType:null},{format:null,internalFormat:null,pixelType:null},{format:d,internalFormat:d,pixelType:s},{format:d,internalFormat:d,pixelType:l},{format:null,internalFormat:null,pixelType:null}];var O={USAGE_STATIC:35044,USAGE_DYNAMIC:35048,USAGE_STREAM:35040,INDEX_FMT_UINT8:5121,INDEX_FMT_UINT16:5123,INDEX_FMT_UINT32:5125,ATTR_POSITION:"a_position",ATTR_NORMAL:"a_normal",ATTR_TANGENT:"a_tangent",ATTR_BITANGENT:"a_bitangent",ATTR_WEIGHTS:"a_weights",ATTR_JOINTS:"a_joints",ATTR_COLOR:"a_color",ATTR_COLOR0:"a_color0",ATTR_COLOR1:"a_color1",ATTR_UV:"a_uv",ATTR_UV0:"a_uv0",ATTR_UV1:"a_uv1",ATTR_UV2:"a_uv2",ATTR_UV3:"a_uv3",ATTR_UV4:"a_uv4",ATTR_UV5:"a_uv5",ATTR_UV6:"a_uv6",ATTR_UV7:"a_uv7",ATTR_TYPE_INT8:5120,ATTR_TYPE_UINT8:5121,ATTR_TYPE_INT16:5122,ATTR_TYPE_UINT16:5123,ATTR_TYPE_INT32:5124,ATTR_TYPE_UINT32:5125,ATTR_TYPE_FLOAT32:5126,FILTER_NEAREST:0,FILTER_LINEAR:1,WRAP_REPEAT:10497,WRAP_CLAMP:33071,WRAP_MIRROR:33648,TEXTURE_FMT_RGB_DXT1:0,TEXTURE_FMT_RGBA_DXT1:1,TEXTURE_FMT_RGBA_DXT3:2,TEXTURE_FMT_RGBA_DXT5:3,TEXTURE_FMT_RGB_ETC1:4,TEXTURE_FMT_RGB_PVRTC_2BPPV1:5,TEXTURE_FMT_RGBA_PVRTC_2BPPV1:6,TEXTURE_FMT_RGB_PVRTC_4BPPV1:7,TEXTURE_FMT_RGBA_PVRTC_4BPPV1:8,TEXTURE_FMT_A8:9,TEXTURE_FMT_L8:10,TEXTURE_FMT_L8_A8:11,TEXTURE_FMT_R5_G6_B5:12,TEXTURE_FMT_R5_G5_B5_A1:13,TEXTURE_FMT_R4_G4_B4_A4:14,TEXTURE_FMT_RGB8:15,TEXTURE_FMT_RGBA8:16,TEXTURE_FMT_RGB16F:17,TEXTURE_FMT_RGBA16F:18,TEXTURE_FMT_RGB32F:19,TEXTURE_FMT_RGBA32F:20,TEXTURE_FMT_R32F:21,TEXTURE_FMT_111110F:22,TEXTURE_FMT_SRGB:23,TEXTURE_FMT_SRGBA:24,TEXTURE_FMT_D16:25,TEXTURE_FMT_D32:26,TEXTURE_FMT_D24S8:27,DS_FUNC_NEVER:512,DS_FUNC_LESS:513,DS_FUNC_EQUAL:514,DS_FUNC_LEQUAL:515,DS_FUNC_GREATER:516,DS_FUNC_NOTEQUAL:517,DS_FUNC_GEQUAL:518,DS_FUNC_ALWAYS:519,RB_FMT_RGBA4:32854,RB_FMT_RGB5_A1:32855,RB_FMT_RGB565:36194,RB_FMT_D16:33189,RB_FMT_S8:36168,RB_FMT_D24S8:34041,BLEND_FUNC_ADD:32774,BLEND_FUNC_SUBTRACT:32778,BLEND_FUNC_REVERSE_SUBTRACT:32779,BLEND_ZERO:0,BLEND_ONE:1,BLEND_SRC_COLOR:768,BLEND_ONE_MINUS_SRC_COLOR:769,BLEND_DST_COLOR:774,BLEND_ONE_MINUS_DST_COLOR:775,BLEND_SRC_ALPHA:770,BLEND_ONE_MINUS_SRC_ALPHA:771,BLEND_DST_ALPHA:772,BLEND_ONE_MINUS_DST_ALPHA:773,BLEND_CONSTANT_COLOR:32769,BLEND_ONE_MINUS_CONSTANT_COLOR:32770,BLEND_CONSTANT_ALPHA:32771,BLEND_ONE_MINUS_CONSTANT_ALPHA:32772,BLEND_SRC_ALPHA_SATURATE:776,STENCIL_OP_KEEP:7680,STENCIL_OP_ZERO:0,STENCIL_OP_REPLACE:7681,STENCIL_OP_INCR:7682,STENCIL_OP_INCR_WRAP:34055,STENCIL_OP_DECR:7683,STENCIL_OP_DECR_WRAP:34056,STENCIL_OP_INVERT:5386,CULL_NONE:0,CULL_FRONT:1028,CULL_BACK:1029,CULL_FRONT_AND_BACK:1032,PT_POINTS:0,PT_LINES:1,PT_LINE_LOOP:2,PT_LINE_STRIP:3,PT_TRIANGLES:4,PT_TRIANGLE_STRIP:5,PT_TRIANGLE_FAN:6};function I(e){if(e===O.ATTR_TYPE_INT8){return 1}else if(e===O.ATTR_TYPE_UINT8){return 1}else if(e===O.ATTR_TYPE_INT16){return 2}else if(e===O.ATTR_TYPE_UINT16){return 2}else if(e===O.ATTR_TYPE_INT32){return 4}else if(e===O.ATTR_TYPE_UINT32){return 4}else if(e===O.ATTR_TYPE_FLOAT32){return 4}console.warn("Unknown ATTR_TYPE: "+e);return 0}function U(e,t,n){if(n===void 0)n=-1;var r=L[t][n+1];if(r===undefined){console.warn("Unknown FILTER: "+t);return n===-1?e.LINEAR:e.LINEAR_MIPMAP_LINEAR}return r}function P(e){var t=C[e];if(t===undefined){console.warn("Unknown TEXTURE_FMT: "+e);return C[O.TEXTURE_FMT_RGBA8]}return t}var B=function e(t){var n=this;this._attr2el={};this._elements=[];this._bytes=0;var r=0;for(var i=0,a=t.length;i<a;++i){var o=t[i];var s={name:o.name,offset:r,stride:0,stream:-1,type:o.type,num:o.num,normalize:o.normalize===undefined?false:o.normalize,bytes:o.num*I(o.type)};n._attr2el[s.name]=s;n._elements.push(s);n._bytes+=s.bytes;r+=s.bytes}for(var l=0,u=this._elements.length;l<u;++l){var h=n._elements[l];h.stride=n._bytes}};B.prototype.element=function e(t){return this._attr2el[t]};var D=function e(t,n,r,i,a){this._device=t;this._format=n;this._usage=r;this._numIndices=a;this._bytesPerIndex=0;if(n===O.INDEX_FMT_UINT8){this._bytesPerIndex=1}else if(n===O.INDEX_FMT_UINT16){this._bytesPerIndex=2}else if(n===O.INDEX_FMT_UINT32){this._bytesPerIndex=4}this._bytes=this._bytesPerIndex*a;this._glID=t._gl.createBuffer();this.update(0,i);t._stats.ib+=this._bytes};var F={count:{configurable:true}};D.prototype.destroy=function e(){if(this._glID===-1){console.error("The buffer already destroyed");return}var t=this._device._gl;t.deleteBuffer(this._glID);this._device._stats.ib-=this.bytes;this._glID=-1};D.prototype.update=function e(t,n){if(this._glID===-1){console.error("The buffer is destroyed");return}if(n&&n.byteLength+t>this._bytes){console.error("Failed to update data, bytes exceed.");return}var r=this._device._gl;var i=this._usage;r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,this._glID);if(!n){if(this._bytes){r.bufferData(r.ELEMENT_ARRAY_BUFFER,this._bytes,i)}else{console.warn("bufferData should not submit 0 bytes data")}}else{if(t){r.bufferSubData(r.ELEMENT_ARRAY_BUFFER,t,n)}else{r.bufferData(r.ELEMENT_ARRAY_BUFFER,n,i)}}this._device._restoreIndexBuffer()};F.count.get=function(){return this._numIndices};Object.defineProperties(D.prototype,F);var z=function e(t,n,r,i,a){this._device=t;this._format=n;this._usage=r;this._numVertices=a;this._bytes=this._format._bytes*a;this._glID=t._gl.createBuffer();this.update(0,i);t._stats.vb+=this._bytes};var N={count:{configurable:true}};z.prototype.destroy=function e(){if(this._glID===-1){console.error("The buffer already destroyed");return}var t=this._device._gl;t.deleteBuffer(this._glID);this._device._stats.vb-=this.bytes;this._glID=-1};z.prototype.update=function e(t,n){if(this._glID===-1){console.error("The buffer is destroyed");return}if(n&&n.byteLength+t>this._bytes){console.error("Failed to update data, bytes exceed.");return}var r=this._device._gl;var i=this._usage;r.bindBuffer(r.ARRAY_BUFFER,this._glID);if(!n){if(this._bytes){r.bufferData(r.ARRAY_BUFFER,this._bytes,i)}else{console.warn("bufferData should not submit 0 bytes data")}}else{if(t){r.bufferSubData(r.ARRAY_BUFFER,t,n)}else{r.bufferData(r.ARRAY_BUFFER,n,i)}}r.bindBuffer(r.ARRAY_BUFFER,null)};N.count.get=function(){return this._numVertices};Object.defineProperties(z.prototype,N);var k=0;function V(n,r,e){e.split("\n").forEach(function(e){if(e.length<5){return}var t=/^ERROR\:\s+(\d+)\:(\d+)\:\s*(.*)$/.exec(e);if(t){n.push({type:r,fileID:t[1]|0,line:t[2]|0,message:t[3].trim()})}else if(e.length>0){n.push({type:r,fileID:-1,line:0,message:e})}})}var W=function e(t,n){this._device=t;this._attributes=[];this._uniforms=[];this._samplers=[];this._errors=[];this._linked=false;this._vertSource=n.vert;this._fragSource=n.frag;this._glID=null;this._id=k++};var G={id:{configurable:true}};G.id.get=function(){return this._id};W.prototype.link=function e(){var t=this;if(this._linked){return}var n=this._device._gl;var r=H(n,n.VERTEX_SHADER,this._vertSource);var i=H(n,n.FRAGMENT_SHADER,this._fragSource);var a=n.createProgram();n.attachShader(a,r);n.attachShader(a,i);n.linkProgram(a);var o=false;var s=this._errors;if(!n.getShaderParameter(r,n.COMPILE_STATUS)){V(s,"vs",n.getShaderInfoLog(r));o=true}if(!n.getShaderParameter(i,n.COMPILE_STATUS)){V(s,"fs",n.getShaderInfoLog(i));o=true}n.deleteShader(r);n.deleteShader(i);if(o){s.forEach(function(e){console.error("Failed to compile "+e.type+" "+e.fileID+" (ln "+e.line+"): "+e.message)});return}if(!n.getProgramParameter(a,n.LINK_STATUS)){console.error("Failed to link shader program: "+n.getProgramInfoLog(a));o=true}if(o){return}this._glID=a;var l=n.getProgramParameter(a,n.ACTIVE_ATTRIBUTES);for(var u=0;u<l;++u){var h=n.getActiveAttrib(a,u);var c=n.getAttribLocation(a,h.name);t._attributes.push({name:h.name,location:c,type:h.type})}var f=n.getProgramParameter(a,n.ACTIVE_UNIFORMS);for(var p=0;p<f;++p){var d=n.getActiveUniform(a,p);var v=d.name;var m=n.getUniformLocation(a,v);var _=v.substr(v.length-3)==="[0]";if(_){v=v.substr(0,v.length-3)}var g={name:v,location:m,type:d.type,size:_?d.size:undefined};t._uniforms.push(g)}this._linked=true};W.prototype.destroy=function e(){var t=this._device._gl;t.deleteProgram(this._glID);this._linked=false;this._glID=null;this._attributes=[];this._uniforms=[];this._samplers=[]};Object.defineProperties(W.prototype,G);function H(e,t,n){var r=e.createShader(t);e.shaderSource(r,n);e.compileShader(r);return r}var j=function e(t){this._device=t;this._width=4;this._height=4;this._hasMipmap=false;this._compressed=false;this._anisotropy=1;this._minFilter=O.FILTER_LINEAR;this._magFilter=O.FILTER_LINEAR;this._mipFilter=O.FILTER_LINEAR;this._wrapS=O.WRAP_REPEAT;this._wrapT=O.WRAP_REPEAT;this._format=O.TEXTURE_FMT_RGBA8;this._target=-1};j.prototype.destroy=function e(){if(this._glID===-1){console.error("The texture already destroyed");return}var t=this._device._gl;t.deleteTexture(this._glID);this._device._stats.tex-=this.bytes;this._glID=-1};function q(e){return!(e&e-1)&&!!e}var X=function(r){function e(e,t){r.call(this,e);var n=this._device._gl;this._target=n.TEXTURE_2D;this._glID=n.createTexture();t.images=t.images||[null];this.update(t)}if(r)e.__proto__=r;e.prototype=Object.create(r&&r.prototype);e.prototype.constructor=e;e.prototype.update=function e(t){var n=this._device._gl;var r=this._hasMipmap;if(t){if(t.width!==undefined){this._width=t.width}if(t.height!==undefined){this._height=t.height}if(t.anisotropy!==undefined){this._anisotropy=t.anisotropy}if(t.minFilter!==undefined){this._minFilter=t.minFilter}if(t.magFilter!==undefined){this._magFilter=t.magFilter}if(t.mipFilter!==undefined){this._mipFilter=t.mipFilter}if(t.wrapS!==undefined){this._wrapS=t.wrapS}if(t.wrapT!==undefined){this._wrapT=t.wrapT}if(t.format!==undefined){this._format=t.format;this._compressed=this._format>=O.TEXTURE_FMT_RGB_DXT1&&this._format<=O.TEXTURE_FMT_RGBA_PVRTC_4BPPV1}if(t.mipmap!==undefined){this._hasMipmap=t.mipmap;r=t.mipmap}if(t.images!==undefined){if(t.images.length>1){r=false;var i=t.width>t.height?t.width:t.height;if(i>>t.images.length-1!==1){console.error("texture-2d mipmap is invalid, should have a 1x1 mipmap.")}}}}var a=q(this._width)&&q(this._height);if(!a){r=false}n.activeTexture(n.TEXTURE0);n.bindTexture(n.TEXTURE_2D,this._glID);if(t.images!==undefined&&t.images.length>0){this._setMipmap(t.images,t.flipY,t.premultiplyAlpha);if(t.images.length>1){this._hasMipmap=true}}if(r){n.hint(n.GENERATE_MIPMAP_HINT,n.NICEST);n.generateMipmap(n.TEXTURE_2D);this._hasMipmap=true}this._setTexInfo();this._device._restoreTexture(0)};e.prototype.updateSubImage=function e(t){var n=this._device._gl;var r=P(this._format);n.activeTexture(n.TEXTURE0);n.bindTexture(n.TEXTURE_2D,this._glID);this._setSubImage(r,t);this._device._restoreTexture(0)};e.prototype.updateImage=function e(t){var n=this._device._gl;var r=P(this._format);n.activeTexture(n.TEXTURE0);n.bindTexture(n.TEXTURE_2D,this._glID);this._setImage(r,t);this._device._restoreTexture(0)};e.prototype._setSubImage=function e(t,n){var r=this._device._gl;var i=n.flipY;var a=n.premultiplyAlpha;var o=n.image;if(o instanceof HTMLCanvasElement||o instanceof HTMLImageElement||o instanceof HTMLVideoElement){if(i===undefined){r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,true)}else{r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,i)}if(a===undefined){r.pixelStorei(r.UNPACK_PREMULTIPLY_ALPHA_WEBGL,false)}else{r.pixelStorei(r.UNPACK_PREMULTIPLY_ALPHA_WEBGL,a)}r.texSubImage2D(r.TEXTURE_2D,n.level,n.x,n.y,t.format,t.pixelType,o)}else{if(i===undefined){r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,false)}else{r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,i)}if(a===undefined){r.pixelStorei(r.UNPACK_PREMULTIPLY_ALPHA_WEBGL,false)}else{r.pixelStorei(r.UNPACK_PREMULTIPLY_ALPHA_WEBGL,a)}if(this._compressed){r.compressedTexSubImage2D(r.TEXTURE_2D,n.level,n.x,n.y,n.width,n.height,t.format,o)}else{r.texSubImage2D(r.TEXTURE_2D,n.level,n.x,n.y,n.width,n.height,t.format,t.pixelType,o)}}};e.prototype._setImage=function e(t,n){var r=this._device._gl;var i=n.flipY;var a=n.premultiplyAlpha;var o=n.image;if(o instanceof HTMLCanvasElement||o instanceof HTMLImageElement||o instanceof HTMLVideoElement){if(i===undefined){r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,true)}else{r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,i)}if(a===undefined){r.pixelStorei(r.UNPACK_PREMULTIPLY_ALPHA_WEBGL,false)}else{r.pixelStorei(r.UNPACK_PREMULTIPLY_ALPHA_WEBGL,a)}r.texImage2D(r.TEXTURE_2D,n.level,t.internalFormat,t.format,t.pixelType,o)}else{if(i===undefined){r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,false)}else{r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,i)}if(a===undefined){r.pixelStorei(r.UNPACK_PREMULTIPLY_ALPHA_WEBGL,false)}else{r.pixelStorei(r.UNPACK_PREMULTIPLY_ALPHA_WEBGL,a)}if(this._compressed){r.compressedTexImage2D(r.TEXTURE_2D,n.level,t.internalFormat,n.width,n.height,0,o)}else{r.texImage2D(r.TEXTURE_2D,n.level,t.internalFormat,n.width,n.height,0,t.format,t.pixelType,o)}}};e.prototype._setMipmap=function e(t,n,r){var i=this;var a=P(this._format);var o={width:this._width,height:this._height,flipY:n,premultiplyAlpha:r,level:0,image:null};for(var s=0;s<t.length;++s){o.level=s;o.width=i._width>>s;o.height=i._height>>s;o.image=t[s];i._setImage(a,o)}};e.prototype._setTexInfo=function e(){var t=this._device._gl;var n=q(this._width)&&q(this._height);if(!n&&(this._wrapS!==O.WRAP_CLAMP||this._wrapT!==O.WRAP_CLAMP)){console.warn("WebGL1 doesn't support all wrap modes with NPOT textures");this._wrapS=O.WRAP_CLAMP;this._wrapT=O.WRAP_CLAMP}var r=this._hasMipmap?this._mipFilter:-1;if(!n&&r!==-1){console.warn("NPOT textures do not support mipmap filter");r=-1}t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,U(t,this._minFilter,r));t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,U(t,this._magFilter,-1));t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,this._wrapS);t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,this._wrapT);var i=this._device.ext("EXT_texture_filter_anisotropic");if(i){t.texParameteri(t.TEXTURE_2D,i.TEXTURE_MAX_ANISOTROPY_EXT,this._anisotropy)}};return e}(j);var Y=function(r){function e(e,t){r.call(this,e);var n=this._device._gl;this._target=n.TEXTURE_CUBE_MAP;this._glID=n.createTexture();this.update(t)}if(r)e.__proto__=r;e.prototype=Object.create(r&&r.prototype);e.prototype.constructor=e;e.prototype.update=function e(t){var n=this._device._gl;var r=this._hasMipmap;if(t){if(t.width!==undefined){this._width=t.width}if(t.height!==undefined){this._height=t.height}if(t.anisotropy!==undefined){this._anisotropy=t.anisotropy}if(t.minFilter!==undefined){this._minFilter=t.minFilter}if(t.magFilter!==undefined){this._magFilter=t.magFilter}if(t.mipFilter!==undefined){this._mipFilter=t.mipFilter}if(t.wrapS!==undefined){this._wrapS=t.wrapS}if(t.wrapT!==undefined){this._wrapT=t.wrapT}if(t.format!==undefined){this._format=t.format;this._compressed=this._format>=O.TEXTURE_FMT_RGB_DXT1&&this._format<=O.TEXTURE_FMT_RGBA_PVRTC_4BPPV1}if(t.mipmap!==undefined){this._hasMipmap=t.mipmap;r=t.mipmap}if(t.images!==undefined){if(t.images.length>1){r=false;if(t.width!==t.height){console.warn("texture-cube width and height should be identical.")}if(t.width>>t.images.length-1!==1){console.error("texture-cube mipmap is invalid. please set mipmap as 1x1, 2x2, 4x4 ... nxn")}}}}var i=q(this._width)&&q(this._height);if(!i){r=false}n.activeTexture(n.TEXTURE0);n.bindTexture(n.TEXTURE_CUBE_MAP,this._glID);if(t.images!==undefined&&t.images.length>0){this._setMipmap(t.images,t.flipY,t.premultiplyAlpha);if(t.images.length>1){this._hasMipmap=true}}if(r){n.hint(n.GENERATE_MIPMAP_HINT,n.NICEST);n.generateMipmap(n.TEXTURE_CUBE_MAP);this._hasMipmap=true}this._setTexInfo();this._device._restoreTexture(0)};e.prototype.updateSubImage=function e(t){var n=this._device._gl;var r=P(this._format);n.activeTexture(n.TEXTURE0);n.bindTexture(n.TEXTURE_CUBE_MAP,this._glID);this._setSubImage(r,t);this._device._restoreTexture(0)};e.prototype.updateImage=function e(t){var n=this._device._gl;var r=P(this._format);n.activeTexture(n.TEXTURE0);n.bindTexture(n.TEXTURE_CUBE_MAP,this._glID);this._setImage(r,t);this._device._restoreTexture(0)};e.prototype._setSubImage=function e(t,n){var r=this._device._gl;var i=n.flipY;var a=n.premultiplyAlpha;var o=n.faceIndex;var s=n.image;if(i===undefined){r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,false)}else{r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,i)}if(a===undefined){r.pixelStorei(r.UNPACK_PREMULTIPLY_ALPHA_WEBGL,false)}else{r.pixelStorei(r.UNPACK_PREMULTIPLY_ALPHA_WEBGL,a)}if(s instanceof HTMLCanvasElement||s instanceof HTMLImageElement||s instanceof HTMLVideoElement){r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+o,n.level,n.x,n.y,t.format,t.pixelType,s)}else{if(this._compressed){r.compressedTexSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+o,n.level,n.x,n.y,n.width,n.height,t.format,s)}else{r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+o,n.level,n.x,n.y,n.width,n.height,t.format,t.pixelType,s)}}};e.prototype._setImage=function e(t,n){var r=this._device._gl;var i=n.flipY;var a=n.premultiplyAlpha;var o=n.faceIndex;var s=n.image;if(i===undefined){r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,false)}else{r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,i)}if(a===undefined){r.pixelStorei(r.UNPACK_PREMULTIPLY_ALPHA_WEBGL,false)}else{r.pixelStorei(r.UNPACK_PREMULTIPLY_ALPHA_WEBGL,a)}if(s instanceof HTMLCanvasElement||s instanceof HTMLImageElement||s instanceof HTMLVideoElement){r.texImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+o,n.level,t.internalFormat,t.format,t.pixelType,s)}else{if(this._compressed){r.compressedTexImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+o,n.level,t.internalFormat,n.width,n.height,0,s)}else{r.texImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+o,n.level,t.internalFormat,n.width,n.height,0,t.format,t.pixelType,s)}}};e.prototype._setMipmap=function e(t,n,r){var i=this;var a=P(this._format);var o={width:this._width,height:this._height,faceIndex:0,flipY:n,premultiplyAlpha:r,level:0,image:null};for(var s=0;s<t.length;++s){var l=t[s];o.level=s;o.width=i._width>>s;o.height=i._height>>s;for(var u=0;u<6;++u){o.faceIndex=u;o.image=l[u];i._setImage(a,o)}}};e.prototype._setTexInfo=function e(){var t=this._device._gl;var n=q(this._width)&&q(this._height);if(!n&&(this._wrapS!==O.WRAP_CLAMP||this._wrapT!==O.WRAP_CLAMP)){console.warn("WebGL1 doesn't support all wrap modes with NPOT textures");this._wrapS=O.WRAP_CLAMP;this._wrapT=O.WRAP_CLAMP}var r=this._hasMipmap?this._mipFilter:-1;if(!n&&r!==-1){console.warn("NPOT textures do not support mipmap filter");r=-1}t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_MIN_FILTER,U(t,this._minFilter,r));t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_MAG_FILTER,U(t,this._magFilter,-1));t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_WRAP_S,this._wrapS);t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_WRAP_T,this._wrapT);var i=this._device.ext("EXT_texture_filter_anisotropic");if(i){t.texParameteri(t.TEXTURE_CUBE_MAP,i.TEXTURE_MAX_ANISOTROPY_EXT,this._anisotropy)}};return e}(j);var K=function e(t,n,r,i){this._device=t;this._format=n;this._width=r;this._height=i;var a=t._gl;this._glID=a.createRenderbuffer();a.bindRenderbuffer(a.RENDERBUFFER,this._glID);a.renderbufferStorage(a.RENDERBUFFER,n,r,i);a.bindRenderbuffer(a.RENDERBUFFER,null)};K.prototype.destroy=function e(){if(this._glID===null){console.error("The render-buffer already destroyed");return}var t=this._device._gl;t.bindRenderbuffer(t.RENDERBUFFER,null);t.deleteRenderbuffer(this._glID);this._glID=null};var Z=function e(t,n,r,i){this._device=t;this._width=n;this._height=r;this._colors=i.colors||[];this._depth=i.depth||null;this._stencil=i.stencil||null;this._depthStencil=i.depthStencil||null;this._glID=t._gl.createFramebuffer()};Z.prototype.destroy=function e(){if(this._glID===null){console.error("The frame-buffer already destroyed");return}var t=this._device._gl;t.deleteFramebuffer(this._glID);this._glID=null};var Q={blend:false,blendSep:false,blendColor:4294967295,blendEq:O.BLEND_FUNC_ADD,blendAlphaEq:O.BLEND_FUNC_ADD,blendSrc:O.BLEND_ONE,blendDst:O.BLEND_ZERO,blendSrcAlpha:O.BLEND_ONE,blendDstAlpha:O.BLEND_ZERO,depthTest:false,depthWrite:false,depthFunc:O.DS_FUNC_LESS,stencilTest:false,stencilSep:false,stencilFuncFront:O.DS_FUNC_ALWAYS,stencilRefFront:0,stencilMaskFront:255,stencilFailOpFront:O.STENCIL_OP_KEEP,stencilZFailOpFront:O.STENCIL_OP_KEEP,stencilZPassOpFront:O.STENCIL_OP_KEEP,stencilWriteMaskFront:255,stencilFuncBack:O.DS_FUNC_ALWAYS,stencilRefBack:0,stencilMaskBack:255,stencilFailOpBack:O.STENCIL_OP_KEEP,stencilZFailOpBack:O.STENCIL_OP_KEEP,stencilZPassOpBack:O.STENCIL_OP_KEEP,stencilWriteMaskBack:255,cullMode:O.CULL_BACK,primitiveType:O.PT_TRIANGLES,maxStream:-1,vertexBuffers:[],vertexBufferOffsets:[],indexBuffer:null,maxTextureSlot:-1,textureUnits:[],program:null};var J=function e(t){this.vertexBuffers=new Array(t._caps.maxVertexStreams);this.vertexBufferOffsets=new Array(t._caps.maxVertexStreams);this.textureUnits=new Array(t._caps.maxTextureUnits);this.set(Q)};J.initDefault=function e(t){Q.vertexBuffers=new Array(t._caps.maxVertexStreams);Q.vertexBufferOffsets=new Array(t._caps.maxVertexStreams);Q.textureUnits=new Array(t._caps.maxTextureUnits)};J.prototype.reset=function e(){this.set(Q)};J.prototype.set=function e(t){var n=this;this.blend=t.blend;this.blendSep=t.blendSep;this.blendColor=t.blendColor;this.blendEq=t.blendEq;this.blendAlphaEq=t.blendAlphaEq;this.blendSrc=t.blendSrc;this.blendDst=t.blendDst;this.blendSrcAlpha=t.blendSrcAlpha;this.blendDstAlpha=t.blendDstAlpha;this.depthTest=t.depthTest;this.depthWrite=t.depthWrite;this.depthFunc=t.depthFunc;this.stencilTest=t.stencilTest;this.stencilSep=t.stencilSep;this.stencilFuncFront=t.stencilFuncFront;this.stencilRefFront=t.stencilRefFront;this.stencilMaskFront=t.stencilMaskFront;this.stencilFailOpFront=t.stencilFailOpFront;this.stencilZFailOpFront=t.stencilZFailOpFront;this.stencilZPassOpFront=t.stencilZPassOpFront;this.stencilWriteMaskFront=t.stencilWriteMaskFront;this.stencilFuncBack=t.stencilFuncBack;this.stencilRefBack=t.stencilRefBack;this.stencilMaskBack=t.stencilMaskBack;this.stencilFailOpBack=t.stencilFailOpBack;this.stencilZFailOpBack=t.stencilZFailOpBack;this.stencilZPassOpBack=t.stencilZPassOpBack;this.stencilWriteMaskBack=t.stencilWriteMaskBack;this.cullMode=t.cullMode;this.primitiveType=t.primitiveType;this.maxStream=t.maxStream;for(var r=0;r<t.vertexBuffers.length;++r){n.vertexBuffers[r]=t.vertexBuffers[r]}for(var i=0;i<t.vertexBufferOffsets.length;++i){n.vertexBufferOffsets[i]=t.vertexBufferOffsets[i]}this.indexBuffer=t.indexBuffer;this.maxTextureSlot=t.maxTextureSlot;for(var a=0;a<t.textureUnits.length;++a){n.textureUnits[a]=t.textureUnits[a]}this.program=t.program};var $=5124;var ee=5126;var te=35664;var ne=35665;var re=35666;var ie=35667;var ae=35668;var oe=35669;var se=35670;var le=35671;var ue=35672;var he=35673;var ce=35674;var fe=35675;var pe=35676;var de=35678;var ve=35680;var me={};me[$]=function(e,t,n){e.uniform1i(t,n)};me[ee]=function(e,t,n){e.uniform1f(t,n)};me[te]=function(e,t,n){e.uniform2fv(t,n)};me[ne]=function(e,t,n){e.uniform3fv(t,n)};me[re]=function(e,t,n){e.uniform4fv(t,n)};me[ie]=function(e,t,n){e.uniform2iv(t,n)};me[ae]=function(e,t,n){e.uniform3iv(t,n)};me[oe]=function(e,t,n){e.uniform4iv(t,n)};me[se]=function(e,t,n){e.uniform1i(t,n)};me[le]=function(e,t,n){e.uniform2iv(t,n)};me[ue]=function(e,t,n){e.uniform3iv(t,n)};me[he]=function(e,t,n){e.uniform4iv(t,n)};me[ce]=function(e,t,n){e.uniformMatrix2fv(t,false,n)};me[fe]=function(e,t,n){e.uniformMatrix3fv(t,false,n)};me[pe]=function(e,t,n){e.uniformMatrix4fv(t,false,n)};me[de]=function(e,t,n){e.uniform1i(t,n)};me[ve]=function(e,t,n){e.uniform1i(t,n)};var _e={};_e[$]=function(e,t,n){e.uniform1iv(t,n)};_e[ee]=function(e,t,n){e.uniform1fv(t,n)};_e[te]=function(e,t,n){e.uniform2fv(t,n)};_e[ne]=function(e,t,n){e.uniform3fv(t,n)};_e[re]=function(e,t,n){e.uniform4fv(t,n)};_e[ie]=function(e,t,n){e.uniform2iv(t,n)};_e[ae]=function(e,t,n){e.uniform3iv(t,n)};_e[oe]=function(e,t,n){e.uniform4iv(t,n)};_e[se]=function(e,t,n){e.uniform1iv(t,n)};_e[le]=function(e,t,n){e.uniform2iv(t,n)};_e[ue]=function(e,t,n){e.uniform3iv(t,n)};_e[he]=function(e,t,n){e.uniform4iv(t,n)};_e[ce]=function(e,t,n){e.uniformMatrix2fv(t,false,n)};_e[fe]=function(e,t,n){e.uniformMatrix3fv(t,false,n)};_e[pe]=function(e,t,n){e.uniformMatrix4fv(t,false,n)};_e[de]=function(e,t,n){e.uniform1iv(t,n)};_e[ve]=function(e,t,n){e.uniform1iv(t,n)};function ge(e,t,n){if(t.blend!==n.blend){if(!n.blend){e.disable(e.BLEND);return}e.enable(e.BLEND);if(n.blendSrc===O.BLEND_CONSTANT_COLOR||n.blendSrc===O.BLEND_ONE_MINUS_CONSTANT_COLOR||n.blendDst===O.BLEND_CONSTANT_COLOR||n.blendDst===O.BLEND_ONE_MINUS_CONSTANT_COLOR){e.blendColor((n.blendColor>>24)/255,(n.blendColor>>16&255)/255,(n.blendColor>>8&255)/255,(n.blendColor&255)/255)}if(n.blendSep){e.blendFuncSeparate(n.blendSrc,n.blendDst,n.blendSrcAlpha,n.blendDstAlpha);e.blendEquationSeparate(n.blendEq,n.blendAlphaEq)}else{e.blendFunc(n.blendSrc,n.blendDst);e.blendEquation(n.blendEq)}return}if(n.blend===false){return}if(t.blendColor!==n.blendColor){e.blendColor((n.blendColor>>24)/255,(n.blendColor>>16&255)/255,(n.blendColor>>8&255)/255,(n.blendColor&255)/255)}if(t.blendSep!==n.blendSep){if(n.blendSep){e.blendFuncSeparate(n.blendSrc,n.blendDst,n.blendSrcAlpha,n.blendDstAlpha);e.blendEquationSeparate(n.blendEq,n.blendAlphaEq)}else{e.blendFunc(n.blendSrc,n.blendDst);e.blendEquation(n.blendEq)}return}if(n.blendSep){if(t.blendSrc!==n.blendSrc||t.blendDst!==n.blendDst||t.blendSrcAlpha!==n.blendSrcAlpha||t.blendDstAlpha!==n.blendDstAlpha){e.blendFuncSeparate(n.blendSrc,n.blendDst,n.blendSrcAlpha,n.blendDstAlpha)}if(t.blendEq!==n.blendEq||t.blendAlphaEq!==n.blendAlphaEq){e.blendEquationSeparate(n.blendEq,n.blendAlphaEq)}}else{if(t.blendSrc!==n.blendSrc||t.blendDst!==n.blendDst){e.blendFunc(n.blendSrc,n.blendDst)}if(t.blendEq!==n.blendEq){e.blendEquation(n.blendEq)}}}function ye(e,t,n){if(t.depthTest!==n.depthTest){if(!n.depthTest){e.disable(e.DEPTH_TEST);return}e.enable(e.DEPTH_TEST);e.depthFunc(n.depthFunc);e.depthMask(n.depthWrite);return}if(t.depthWrite!==n.depthWrite){e.depthMask(n.depthWrite)}if(n.depthTest===false){if(n.depthWrite){n.depthTest=true;n.depthFunc=O.DS_FUNC_ALWAYS;e.enable(e.DEPTH_TEST);e.depthFunc(n.depthFunc)}return}if(t.depthFunc!==n.depthFunc){e.depthFunc(n.depthFunc)}}function xe(e,t,n){if(n.stencilTest!==t.stencilTest){if(!n.stencilTest){e.disable(e.STENCIL_TEST);return}e.enable(e.STENCIL_TEST);if(n.stencilSep){e.stencilFuncSeparate(e.FRONT,n.stencilFuncFront,n.stencilRefFront,n.stencilMaskFront);e.stencilMaskSeparate(e.FRONT,n.stencilWriteMaskFront);e.stencilOpSeparate(e.FRONT,n.stencilFailOpFront,n.stencilZFailOpFront,n.stencilZPassOpFront);e.stencilFuncSeparate(e.BACK,n.stencilFuncBack,n.stencilRefBack,n.stencilMaskBack);e.stencilMaskSeparate(e.BACK,n.stencilWriteMaskBack);e.stencilOpSeparate(e.BACK,n.stencilFailOpBack,n.stencilZFailOpBack,n.stencilZPassOpBack)}else{e.stencilFunc(n.stencilFuncFront,n.stencilRefFront,n.stencilMaskFront);e.stencilMask(n.stencilWriteMaskFront);e.stencilOp(n.stencilFailOpFront,n.stencilZFailOpFront,n.stencilZPassOpFront)}return}if(!n.stencilTest){return}if(t.stencilSep!==n.stencilSep){if(n.stencilSep){e.stencilFuncSeparate(e.FRONT,n.stencilFuncFront,n.stencilRefFront,n.stencilMaskFront);e.stencilMaskSeparate(e.FRONT,n.stencilWriteMaskFront);e.stencilOpSeparate(e.FRONT,n.stencilFailOpFront,n.stencilZFailOpFront,n.stencilZPassOpFront);e.stencilFuncSeparate(e.BACK,n.stencilFuncBack,n.stencilRefBack,n.stencilMaskBack);e.stencilMaskSeparate(e.BACK,n.stencilWriteMaskBack);e.stencilOpSeparate(e.BACK,n.stencilFailOpBack,n.stencilZFailOpBack,n.stencilZPassOpBack)}else{e.stencilFunc(n.stencilFuncFront,n.stencilRefFront,n.stencilMaskFront);e.stencilMask(n.stencilWriteMaskFront);e.stencilOp(n.stencilFailOpFront,n.stencilZFailOpFront,n.stencilZPassOpFront)}return}if(n.stencilSep){if(t.stencilFuncFront!==n.stencilFuncFront||t.stencilRefFront!==n.stencilRefFront||t.stencilMaskFront!==n.stencilMaskFront){e.stencilFuncSeparate(e.FRONT,n.stencilFuncFront,n.stencilRefFront,n.stencilMaskFront)}if(t.stencilWriteMaskFront!==n.stencilWriteMaskFront){e.stencilMaskSeparate(e.FRONT,n.stencilWriteMaskFront)}if(t.stencilFailOpFront!==n.stencilFailOpFront||t.stencilZFailOpFront!==n.stencilZFailOpFront||t.stencilZPassOpFront!==n.stencilZPassOpFront){e.stencilOpSeparate(e.FRONT,n.stencilFailOpFront,n.stencilZFailOpFront,n.stencilZPassOpFront)}if(t.stencilFuncBack!==n.stencilFuncBack||t.stencilRefBack!==n.stencilRefBack||t.stencilMaskBack!==n.stencilMaskBack){e.stencilFuncSeparate(e.BACK,n.stencilFuncBack,n.stencilRefBack,n.stencilMaskBack)}if(t.stencilWriteMaskBack!==n.stencilWriteMaskBack){e.stencilMaskSeparate(e.BACK,n.stencilWriteMaskBack)}if(t.stencilFailOpBack!==n.stencilFailOpBack||t.stencilZFailOpBack!==n.stencilZFailOpBack||t.stencilZPassOpBack!==n.stencilZPassOpBack){e.stencilOpSeparate(e.BACK,n.stencilFailOpBack,n.stencilZFailOpBack,n.stencilZPassOpBack)}}else{if(t.stencilFuncFront!==n.stencilFuncFront||t.stencilRefFront!==n.stencilRefFront||t.stencilMaskFront!==n.stencilMaskFront){e.stencilFunc(n.stencilFuncFront,n.stencilRefFront,n.stencilMaskFront)}if(t.stencilWriteMaskFront!==n.stencilWriteMaskFront){e.stencilMask(n.stencilWriteMaskFront)}if(t.stencilFailOpFront!==n.stencilFailOpFront||t.stencilZFailOpFront!==n.stencilZFailOpFront||t.stencilZPassOpFront!==n.stencilZPassOpFront){e.stencilOp(n.stencilFailOpFront,n.stencilZFailOpFront,n.stencilZPassOpFront)}}}function be(e,t,n){if(t.cullMode===n.cullMode){return}if(n.cullMode===O.CULL_NONE){e.disable(e.CULL_FACE);return}e.enable(e.CULL_FACE);e.cullFace(n.cullMode)}function we(e,t,n,r){var i=false;if(r.maxStream===-1){console.warn("VertexBuffer not assigned, please call setVertexBuffer before every draw.");return}if(n.maxStream!==r.maxStream){i=true}else if(n.program!==r.program){i=true}else{for(var a=0;a<r.maxStream+1;++a){if(n.vertexBuffers[a]!==r.vertexBuffers[a]||n.vertexBufferOffsets[a]!==r.vertexBufferOffsets[a]){i=true;break}}}if(i){for(var o=0;o<e._caps.maxVertexAttribs;++o){e._newAttributes[o]=0}for(var s=0;s<r.maxStream+1;++s){var l=r.vertexBuffers[s];var u=r.vertexBufferOffsets[s];if(!l){continue}t.bindBuffer(t.ARRAY_BUFFER,l._glID);for(var h=0;h<r.program._attributes.length;++h){var c=r.program._attributes[h];var f=l._format.element(c.name);if(!f){console.warn("Can not find vertex attribute: "+c.name);continue}if(e._enabledAttributes[c.location]===0){t.enableVertexAttribArray(c.location);e._enabledAttributes[c.location]=1}e._newAttributes[c.location]=1;t.vertexAttribPointer(c.location,f.num,f.type,f.normalize,f.stride,f.offset+u*f.stride)}}for(var p=0;p<e._caps.maxVertexAttribs;++p){if(e._enabledAttributes[p]!==e._newAttributes[p]){t.disableVertexAttribArray(p);e._enabledAttributes[p]=0}}}}function Ee(e,t,n){for(var r=0;r<n.maxTextureSlot+1;++r){if(t.textureUnits[r]!==n.textureUnits[r]){var i=n.textureUnits[r];if(i!==undefined&&i._glID!==-1){e.activeTexture(e.TEXTURE0+r);e.bindTexture(i._target,i._glID)}}}}function Te(e,t,n,r){if(r===void 0)r=0;if(n instanceof X){e.framebufferTexture2D(e.FRAMEBUFFER,t,e.TEXTURE_2D,n._glID,0)}else if(n instanceof Y){e.framebufferTexture2D(e.FRAMEBUFFER,t,e.TEXTURE_CUBE_MAP_POSITIVE_X+r,n._glID,0)}else{e.framebufferRenderbuffer(e.FRAMEBUFFER,t,e.RENDERBUFFER,n._glID)}}var Se=function e(t,n){var r=this;var i;n=n||{};if(n.alpha===undefined){n.alpha=false}if(n.stencil===undefined){n.stencil=true}if(n.depth===undefined){n.depth=true}if(n.antialias===undefined){n.antialias=false}if(n.preserveDrawingBuffer===undefined){n.preserveDrawingBuffer=false}try{i=t.getContext("webgl",n)}catch(e){console.error(e);return}this._gl=i;this._extensions={};this._caps={};this._stats={texture:0,vb:0,ib:0,drawcalls:0};this._initExtensions(["EXT_texture_filter_anisotropic","EXT_shader_texture_lod","OES_standard_derivatives","OES_texture_float","OES_texture_float_linear","OES_texture_half_float","OES_texture_half_float_linear","OES_vertex_array_object","WEBGL_compressed_texture_atc","WEBGL_compressed_texture_etc1","WEBGL_compressed_texture_pvrtc","WEBGL_compressed_texture_s3tc","WEBGL_depth_texture","WEBGL_draw_buffers"]);this._initCaps();this._initStates();J.initDefault(this);this._current=new J(this);this._next=new J(this);this._uniforms={};this._vx=this._vy=this._vw=this._vh=0;this._sx=this._sy=this._sw=this._sh=0;this._framebuffer=null;this._enabledAttributes=new Array(this._caps.maxVertexAttribs);this._newAttributes=new Array(this._caps.maxVertexAttribs);for(var a=0;a<this._caps.maxVertexAttribs;++a){r._enabledAttributes[a]=0;r._newAttributes[a]=0}};Se.prototype._initExtensions=function e(t){var n=this;var r=this._gl;for(var i=0;i<t.length;++i){var a=t[i];try{var o=r.getExtension(a);if(o){n._extensions[a]=o}}catch(e){console.error(e)}}};Se.prototype._initCaps=function e(){var t=this._gl;var n=this.ext("WEBGL_draw_buffers");this._caps.maxVertexStreams=4;this._caps.maxVertexTextures=t.getParameter(t.MAX_VERTEX_TEXTURE_IMAGE_UNITS);this._caps.maxFragUniforms=t.getParameter(t.MAX_FRAGMENT_UNIFORM_VECTORS);this._caps.maxTextureUnits=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS);this._caps.maxVertexAttribs=t.getParameter(t.MAX_VERTEX_ATTRIBS);this._caps.maxDrawBuffers=n?t.getParameter(n.MAX_DRAW_BUFFERS_WEBGL):1;this._caps.maxColorAttachments=n?t.getParameter(n.MAX_COLOR_ATTACHMENTS_WEBGL):1};Se.prototype._initStates=function e(){var t=this._gl;t.disable(t.BLEND);t.blendFunc(t.ONE,t.ZERO);t.blendEquation(t.FUNC_ADD);t.blendColor(1,1,1,1);t.colorMask(true,true,true,true);t.enable(t.CULL_FACE);t.cullFace(t.BACK);t.disable(t.DEPTH_TEST);t.depthFunc(t.LESS);t.depthMask(false);t.disable(t.POLYGON_OFFSET_FILL);t.depthRange(0,1);t.disable(t.STENCIL_TEST);t.stencilFunc(t.ALWAYS,0,255);t.stencilMask(255);t.stencilOp(t.KEEP,t.KEEP,t.KEEP);t.clearDepth(1);t.clearColor(0,0,0,0);t.clearStencil(0);t.disable(t.SCISSOR_TEST)};Se.prototype._restoreTexture=function e(t){var n=this._gl;var r=this._current.textureUnits[t];if(r&&r._glID!==-1){n.bindTexture(r._target,r._glID)}else{n.bindTexture(n.TEXTURE_2D,null)}};Se.prototype._restoreIndexBuffer=function e(){var t=this._gl;var n=this._current.indexBuffer;t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,n?n._glID:null)};Se.prototype.ext=function e(t){return this._extensions[t]};Se.prototype.allowFloatTexture=function e(){return this.ext("OES_texture_float")!=null};Se.prototype.setFrameBuffer=function e(t){var n=this;if(this._framebuffer===t){return}this._framebuffer=t;var r=this._gl;if(t===null){r.bindFramebuffer(r.FRAMEBUFFER,null);return}r.bindFramebuffer(r.FRAMEBUFFER,t._glID);var i=this._framebuffer._colors.length;for(var a=0;a<i;++a){var o=n._framebuffer._colors[a];Te(r,r.COLOR_ATTACHMENT0+a,o)}for(var s=i;s<this._caps.maxColorAttachments;++s){r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0+s,r.TEXTURE_2D,null,0)}if(this._framebuffer._depth){Te(r,r.DEPTH_ATTACHMENT,this._framebuffer._depth)}if(this._framebuffer._stencil){Te(r,r.STENCIL_ATTACHMENT,t._stencil)}if(this._framebuffer._depthStencil){Te(r,r.DEPTH_STENCIL_ATTACHMENT,t._depthStencil)}};Se.prototype.setViewport=function e(t,n,r,i){if(this._vx!==t||this._vy!==n||this._vw!==r||this._vh!==i){this._gl.viewport(t,n,r,i);this._vx=t;this._vy=n;this._vw=r;this._vh=i}};Se.prototype.setScissor=function e(t,n,r,i){if(this._sx!==t||this._sy!==n||this._sw!==r||this._sh!==i){this._gl.scissor(t,n,r,i);this._sx=t;this._sy=n;this._sw=r;this._sh=i}};Se.prototype.clear=function e(t){var n=this._gl;var r=0;if(t.color!==undefined){r|=n.COLOR_BUFFER_BIT;n.clearColor(t.color[0],t.color[1],t.color[2],t.color[3])}if(t.depth!==undefined){r|=n.DEPTH_BUFFER_BIT;n.clearDepth(t.depth);n.enable(n.DEPTH_TEST);n.depthMask(true);n.depthFunc(n.ALWAYS)}if(t.stencil!==undefined){r|=n.STENCIL_BUFFER_BIT;n.clearStencil(t.stencil)}n.clear(r);if(t.depth!==undefined){if(this._current.depthTest===false){n.disable(n.DEPTH_TEST)}else{if(this._current.depthWrite===false){n.depthMask(false)}if(this._current.depthFunc!==O.DS_FUNC_ALWAYS){n.depthFunc(this._current.depthFunc)}}}};Se.prototype.enableBlend=function e(){this._next.blend=true};Se.prototype.enableDepthTest=function e(){this._next.depthTest=true};Se.prototype.enableDepthWrite=function e(){this._next.depthWrite=true};Se.prototype.enableStencilTest=function e(){this._next.stencilTest=true};Se.prototype.setStencilFunc=function e(t,n,r){this._next.stencilSep=false;this._next.stencilFuncFront=this._next.stencilFuncBack=t;this._next.stencilRefFront=this._next.stencilRefBack=n;this._next.stencilMaskFront=this._next.stencilMaskBack=r};Se.prototype.setStencilFuncFront=function e(t,n,r){this._next.stencilSep=true;this._next.stencilFuncFront=t;this._next.stencilRefFront=n;this._next.stencilMaskFront=r};Se.prototype.setStencilFuncBack=function e(t,n,r){this._next.stencilSep=true;this._next.stencilFuncBack=t;this._next.stencilRefBack=n;this._next.stencilMaskBack=r};Se.prototype.setStencilOp=function e(t,n,r,i){this._next.stencilFailOpFront=this._next.stencilFailOpBack=t;this._next.stencilZFailOpFront=this._next.stencilZFailOpBack=n;this._next.stencilZPassOpFront=this._next.stencilZPassOpBack=r;this._next.stencilWriteMaskFront=this._next.stencilWriteMaskBack=i};Se.prototype.setStencilOpFront=function e(t,n,r,i){this._next.stencilSep=true;this._next.stencilFailOpFront=t;this._next.stencilZFailOpFront=n;this._next.stencilZPassOpFront=r;this._next.stencilWriteMaskFront=i};Se.prototype.setStencilOpBack=function e(t,n,r,i){this._next.stencilSep=true;this._next.stencilFailOpBack=t;this._next.stencilZFailOpBack=n;this._next.stencilZPassOpBack=r;this._next.stencilWriteMaskBack=i};Se.prototype.setDepthFunc=function e(t){this._next.depthFunc=t};Se.prototype.setBlendColor32=function e(t){this._next.blendColor=t};Se.prototype.setBlendColor=function e(t,n,r,i){this._next.blendColor=(t*255<<24|n*255<<16|r*255<<8|i*255)>>>0};Se.prototype.setBlendFunc=function e(t,n){this._next.blendSep=false;this._next.blendSrc=t;this._next.blendDst=n};Se.prototype.setBlendFuncSep=function e(t,n,r,i){this._next.blendSep=true;this._next.blendSrc=t;this._next.blendDst=n;this._next.blendSrcAlpha=r;this._next.blendDstAlpha=i};Se.prototype.setBlendEq=function e(t){this._next.blendSep=false;this._next.blendEq=t};Se.prototype.setBlendEqSep=function e(t,n){this._next.blendSep=true;this._next.blendEq=t;this._next.blendAlphaEq=n};Se.prototype.setCullMode=function e(t){this._next.cullMode=t};Se.prototype.setVertexBuffer=function e(t,n,r){if(r===void 0)r=0;this._next.vertexBuffers[t]=n;this._next.vertexBufferOffsets[t]=r;if(this._next.maxStream<t){this._next.maxStream=t}};Se.prototype.setIndexBuffer=function e(t){this._next.indexBuffer=t};Se.prototype.setProgram=function e(t){this._next.program=t};Se.prototype.setTexture=function e(t,n,r){if(r>=this._caps.maxTextureUnits){console.warn("Can not set texture "+t+" at stage "+r+", max texture exceed: "+this._caps.maxTextureUnits);return}this._next.textureUnits[r]=n;this.setUniform(t,r);if(this._next.maxTextureSlot<r){this._next.maxTextureSlot=r}};Se.prototype.setTextureArray=function e(t,n,r){var i=this;var a=n.length;if(a>=this._caps.maxTextureUnits){console.warn("Can not set "+a+" textures for "+t+", max texture exceed: "+this._caps.maxTextureUnits);return}for(var o=0;o<a;++o){var s=r[o];i._next.textureUnits[s]=n[o]}this.setUniform(t,r)};Se.prototype.setUniform=function e(t,n){var r=this._uniforms[t];if(!r){r={dirty:true,value:n}}else{r.dirty=true;r.value=n}this._uniforms[t]=r};Se.prototype.setPrimitiveType=function e(t){this._next.primitiveType=t};Se.prototype.draw=function e(t,n){var r=this;var i=this._gl;var a=this._current;var o=this._next;ge(i,a,o);ye(i,a,o);xe(i,a,o);be(i,a,o);we(this,i,a,o);if(a.indexBuffer!==o.indexBuffer){i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,o.indexBuffer?o.indexBuffer._glID:null)}var s=false;if(a.program!==o.program){if(o.program._linked){i.useProgram(o.program._glID)}else{console.warn("Failed to use program: has not linked yet.")}s=true}Ee(i,a,o);for(var l=0;l<o.program._uniforms.length;++l){var u=o.program._uniforms[l];var h=r._uniforms[u.name];if(!h){continue}if(!s&&!h.dirty){continue}h.dirty=false;var c=u.size===undefined?me[u.type]:_e[u.type];if(!c){console.warn("Can not find commit function for uniform "+u.name);continue}c(i,u.location,h.value)}if(o.indexBuffer){i.drawElements(this._next.primitiveType,n,o.indexBuffer._format,t*o.indexBuffer._bytesPerIndex)}else{i.drawArrays(this._next.primitiveType,t,n)}this._stats.drawcalls+=1;a.set(o);o.reset()};var Ae={VertexFormat:B,IndexBuffer:D,VertexBuffer:z,Program:W,Texture:j,Texture2D:X,TextureCube:Y,RenderBuffer:K,FrameBuffer:Z,Device:Se,attrTypeBytes:I,glFilter:U,glTextureFmt:P};Object.assign(Ae,O);var Me={PROJ_PERSPECTIVE:0,PROJ_ORTHO:1,LIGHT_DIRECTIONAL:0,LIGHT_POINT:1,LIGHT_SPOT:2,SHADOW_NONE:0,SHADOW_HARD:1,SHADOW_SOFT:2,PARAM_INT:0,PARAM_INT2:1,PARAM_INT3:2,PARAM_INT4:3,PARAM_FLOAT:4,PARAM_FLOAT2:5,PARAM_FLOAT3:6,PARAM_FLOAT4:7,PARAM_COLOR3:8,PARAM_COLOR4:9,PARAM_MAT2:10,PARAM_MAT3:11,PARAM_MAT4:12,PARAM_TEXTURE_2D:13,PARAM_TEXTURE_CUBE:14,CLEAR_COLOR:1,CLEAR_DEPTH:2,CLEAR_STENCIL:4,CLEAR_SKYBOX:8,BUFFER_VIEW_INT8:0,BUFFER_VIEW_UINT8:1,BUFFER_VIEW_INT16:2,BUFFER_VIEW_UINT16:3,BUFFER_VIEW_INT32:4,BUFFER_VIEW_UINT32:5,BUFFER_VIEW_FLOAT32:6};var Re=function e(t,n,r){if(r===void 0)r=Ae.PT_TRIANGLES;this._vertexBuffer=t;this._indexBuffer=n;this._primitiveType=r;this._start=0;this._count=-1};var Le={count:{configurable:true}};Le.count.get=function(){if(this._count!==-1){return this._count}if(this._indexBuffer){return this._indexBuffer.count}return this._vertexBuffer.count};Object.defineProperties(Re.prototype,Le);var Ce=function e(t){this._programName=t;this._cullMode=Ae.CULL_BACK;this._blend=false;this._blendEq=Ae.BLEND_FUNC_ADD;this._blendAlphaEq=Ae.BLEND_FUNC_ADD;this._blendSrc=Ae.BLEND_ONE;this._blendDst=Ae.BLEND_ZERO;this._blendSrcAlpha=Ae.BLEND_ONE;this._blendDstAlpha=Ae.BLEND_ZERO;this._blendColor=4294967295;this._depthTest=false;this._depthWrite=false;this._depthFunc=Ae.DS_FUNC_LESS,this._stencilTest=false;this._stencilFuncFront=Ae.DS_FUNC_ALWAYS;this._stencilRefFront=0;this._stencilMaskFront=255;this._stencilFailOpFront=Ae.STENCIL_OP_KEEP;this._stencilZFailOpFront=Ae.STENCIL_OP_KEEP;this._stencilZPassOpFront=Ae.STENCIL_OP_KEEP;this._stencilWriteMaskFront=255;this._stencilFuncBack=Ae.DS_FUNC_ALWAYS;this._stencilRefBack=0;this._stencilMaskBack=255;this._stencilFailOpBack=Ae.STENCIL_OP_KEEP;this._stencilZFailOpBack=Ae.STENCIL_OP_KEEP;this._stencilZPassOpBack=Ae.STENCIL_OP_KEEP;this._stencilWriteMaskBack=255};Ce.prototype.setCullMode=function e(t){this._cullMode=t};Ce.prototype.setBlend=function e(t,n,r,i,a,o,s){if(t===void 0)t=Ae.BLEND_FUNC_ADD;if(n===void 0)n=Ae.BLEND_ONE;if(r===void 0)r=Ae.BLEND_ZERO;if(i===void 0)i=Ae.BLEND_FUNC_ADD;if(a===void 0)a=Ae.BLEND_ONE;if(o===void 0)o=Ae.BLEND_ZERO;if(s===void 0)s=4294967295;this._blend=true;this._blendEq=t;this._blendSrc=n;this._blendDst=r;this._blendAlphaEq=i;this._blendSrcAlpha=a;this._blendDstAlpha=o;this._blendColor=s};Ce.prototype.setDepth=function e(t,n,r){if(t===void 0)t=false;if(n===void 0)n=false;if(r===void 0)r=Ae.DS_FUNC_LESS;this._depthTest=t;this._depthWrite=n;this._depthFunc=r};Ce.prototype.setStencilFront=function e(t,n,r,i,a,o,s,l){if(t===void 0)t=false;if(n===void 0)n=Ae.DS_FUNC_ALWAYS;if(r===void 0)r=0;if(i===void 0)i=255;if(a===void 0)a=Ae.STENCIL_OP_KEEP;if(o===void 0)o=Ae.STENCIL_OP_KEEP;if(s===void 0)s=Ae.STENCIL_OP_KEEP;if(l===void 0)l=255;this._stencilTest=t;this._stencilFuncFront=n;this._stencilRefFront=r;this._stencilMaskFront=i;this._stencilFailOpFront=a;this._stencilZFailOpFront=o;this._stencilZPassOpFront=s;this._stencilWriteMaskFront=l};Ce.prototype.setStencilBack=function e(t,n,r,i,a,o,s,l){if(t===void 0)t=false;if(n===void 0)n=Ae.DS_FUNC_ALWAYS;if(r===void 0)r=0;if(i===void 0)i=255;if(a===void 0)a=Ae.STENCIL_OP_KEEP;if(o===void 0)o=Ae.STENCIL_OP_KEEP;if(s===void 0)s=Ae.STENCIL_OP_KEEP;if(l===void 0)l=255;this._stencilTest=t;this._stencilFuncBack=n;this._stencilRefBack=r;this._stencilMaskBack=i;this._stencilFailOpBack=a;this._stencilZFailOpBack=o;this._stencilZPassOpBack=s;this._stencilWriteMaskBack=l};var Oe=0;var Ie={};var Ue={addStage:function(e){if(Ie[e]!==undefined){return}var t=1<<Oe;Ie[e]=t;Oe+=1},stageID:function(e){var t=Ie[e];if(t===undefined){return-1}return t},stageIDs:function(e){var t=0;for(var n=0;n<e.length;++n){var r=Ie[e[n]];if(r!==undefined){t|=r}}return t}};var Pe=0;var Be=function e(t,n,r,i){if(i===void 0)i=0;this._id=Pe++;this._stageIDs=Ue.stageIDs(t);this._parameters=n;this._passes=r;this._layer=i};var De={passes:{configurable:true},stageIDs:{configurable:true}};Be.prototype.setStages=function e(t){this._stageIDs=Ue.stageIDs(t)};De.passes.get=function(){return this._passes};De.stageIDs.get=function(){return this._stageIDs};Object.defineProperties(Be.prototype,De);var Fe=function e(t,n,r,i){if(n===void 0)n={};if(r===void 0)r=[];if(i===void 0)i=[];this._techniques=t;this._properties=n;this._defines=r;this._dependencies=i};Fe.prototype.clear=function e(){this._techniques.length=0;this._properties=null;this._defines.length=0};Fe.prototype.getTechnique=function e(t){var n=this;var r=Ue.stageID(t);if(r===-1){return null}for(var i=0;i<this._techniques.length;++i){var a=n._techniques[i];if(a.stageIDs&r){return a}}return null};Fe.prototype.getProperty=function e(t){return this._properties[t]};Fe.prototype.setProperty=function e(t,n){this._properties[t]=n};Fe.prototype.getDefine=function e(t){var n=this;for(var r=0;r<this._defines.length;++r){var i=n._defines[r];if(i.name===t){return i.value}}console.warn("Failed to get define "+t+", define not found.");return null};Fe.prototype.define=function e(t,n){var r=this;for(var i=0;i<this._defines.length;++i){var a=r._defines[i];if(a.name===t){a.value=n;return}}console.warn("Failed to set define "+t+", define not found.")};Fe.prototype.extractDefines=function e(t){var n=this;if(t===void 0)t={};for(var r=0;r<this._defines.length;++r){var i=n._defines[r];t[i.name]=i.value}return t};Fe.prototype.extractDependencies=function e(t){var n=this;if(t===void 0)t={};for(var r=0;r<this._dependencies.length;++r){var i=n._dependencies[r];t[i.define]=i.extension}return t};function ze(e,t){if(!t.positions){console.error("The data must have positions field");return null}var n=[];var r=t.positions.length/3;for(var i=0;i<r;++i){n.push(t.positions[3*i],t.positions[3*i+1],t.positions[3*i+2]);if(t.normals){n.push(t.normals[3*i],t.normals[3*i+1],t.normals[3*i+2])}if(t.uvs){n.push(t.uvs[2*i],t.uvs[2*i+1])}}var a=[];a.push({name:Ae.ATTR_POSITION,type:Ae.ATTR_TYPE_FLOAT32,num:3});if(t.normals){a.push({name:Ae.ATTR_NORMAL,type:Ae.ATTR_TYPE_FLOAT32,num:3})}if(t.uvs){a.push({name:Ae.ATTR_UV0,type:Ae.ATTR_TYPE_FLOAT32,num:2})}var o=new Ae.VertexBuffer(e,new Ae.VertexFormat(a),Ae.USAGE_STATIC,new Float32Array(n),r);var s=null;if(t.indices){s=new Ae.IndexBuffer(e,Ae.INDEX_FMT_UINT16,Ae.USAGE_STATIC,new Uint16Array(t.indices),t.indices.length)}return new Re(o,s)}var Ne=Math.PI/180;var ke=180/Math.PI;var Ve=1e-6;function We(e,t){return Math.abs(e-t)<=Ve*Math.max(1,Math.abs(e),Math.abs(t))}function Ge(e,t,n){n=n||Ve;return Math.abs(e-t)<=n}function He(e,t,n){return e<t?t:e>n?n:e}function je(e){return e<0?0:e>1?1:e}function qe(e,t,n){return e+(t-e)*n}function Xe(e){return e*Ne}function Ye(e){return e*ke}var Ke=Math.random;function Ze(e,t){return Math.random()*(t-e)+e}function Qe(e,t){return Math.floor(Ze(e,t))}function Je(e){e=(e*9301+49297)%233280;return e/233280}function $e(e,t,n){return Je(e)*(n-t)+t}function et(e,t,n){return Math.floor($e(e,t,n))}function tt(e){--e;e=e>>1|e;e=e>>2|e;e=e>>4|e;e=e>>8|e;e=e>>16|e;++e;return e}function nt(e,t){return e-Math.floor(e/t)*t}function rt(e,t){e=nt(e,t*2);e=t-Math.abs(e-t);return e}function it(e,t,n){return(n-e)/(t-e)}var at=32;var ot=2147483647;var st=-1<<at-1;function lt(e){return(e>0)-(e<0)}function ut(e){var t=e>>at-1;return(e^t)-t}function ht(e,t){return t^(e^t)&-(e<t)}function ct(e,t){return e^(e^t)&-(e<t)}function ft(e){return!(e&e-1)&&!!e}function pt(e){var t,n;t=(e>65535)<<4;e>>>=t;n=(e>255)<<3;e>>>=n;t|=n;n=(e>15)<<2;e>>>=n;t|=n;n=(e>3)<<1;e>>>=n;t|=n;return t|e>>1}function dt(e){return e>=1e9?9:e>=1e8?8:e>=1e7?7:e>=1e6?6:e>=1e5?5:e>=1e4?4:e>=1e3?3:e>=100?2:e>=10?1:0}function vt(e){e=e-(e>>>1&1431655765);e=(e&858993459)+(e>>>2&858993459);return(e+(e>>>4)&252645135)*16843009>>>24}function mt(e){var t=32;e&=-e;if(e){t--}if(e&65535){t-=16}if(e&16711935){t-=8}if(e&252645135){t-=4}if(e&858993459){t-=2}if(e&1431655765){t-=1}return t}function _t(e){e+=e===0;--e;e|=e>>>1;e|=e>>>2;e|=e>>>4;e|=e>>>8;e|=e>>>16;return e+1}function gt(e){e|=e>>>1;e|=e>>>2;e|=e>>>4;e|=e>>>8;e|=e>>>16;return e-(e>>>1)}function yt(e){e^=e>>>16;e^=e>>>8;e^=e>>>4;e&=15;return 27030>>>e&1}var xt=new Array(256);(function(e){for(var t=0;t<256;++t){var n=t,r=t,i=7;for(n>>>=1;n;n>>>=1){r<<=1;r|=n&1;--i}e[t]=r<<i&255}})(xt);function bt(e){return xt[e&255]<<24|xt[e>>>8&255]<<16|xt[e>>>16&255]<<8|xt[e>>>24&255]}function wt(e,t){e&=65535;e=(e|e<<8)&16711935;e=(e|e<<4)&252645135;e=(e|e<<2)&858993459;e=(e|e<<1)&1431655765;t&=65535;t=(t|t<<8)&16711935;t=(t|t<<4)&252645135;t=(t|t<<2)&858993459;t=(t|t<<1)&1431655765;return e|t<<1}function Et(e,t){e=e>>>t&1431655765;e=(e|e>>>1)&858993459;e=(e|e>>>2)&252645135;e=(e|e>>>4)&16711935;e=(e|e>>>16)&65535;return e<<16>>16}function Tt(e,t,n){e&=1023;e=(e|e<<16)&4278190335;e=(e|e<<8)&251719695;e=(e|e<<4)&3272356035;e=(e|e<<2)&1227133513;t&=1023;t=(t|t<<16)&4278190335;t=(t|t<<8)&251719695;t=(t|t<<4)&3272356035;t=(t|t<<2)&1227133513;e|=t<<1;n&=1023;n=(n|n<<16)&4278190335;n=(n|n<<8)&251719695;n=(n|n<<4)&3272356035;n=(n|n<<2)&1227133513;return e|n<<2}function St(e,t){e=e>>>t&1227133513;e=(e|e>>>2)&3272356035;e=(e|e>>>4)&251719695;e=(e|e>>>8)&4278190335;e=(e|e>>>16)&1023;return e<<22>>22}function At(e){var t=e|e-1;return t+1|(~t&-~t)-1>>>mt(e)+1}var Mt=Object.freeze({INT_BITS:at,INT_MAX:ot,INT_MIN:st,sign:lt,abs:ut,min:ht,max:ct,isPow2:ft,log2:pt,log10:dt,popCount:vt,countTrailingZeros:mt,nextPow2:_t,prevPow2:gt,parity:yt,reverse:bt,interleave2:wt,deinterleave2:Et,interleave3:Tt,deinterleave3:St,nextCombination:At});var Rt=function e(t,n){this.x=t;this.y=n};Rt.new=function e(t,n){return new Rt(t,n)};Rt.zero=function e(){return new Rt(0,0)};Rt.clone=function e(t){return new Rt(t.x,t.y)};Rt.copy=function e(t,n){t.x=n.x;t.y=n.y;return t};Rt.set=function e(t,n,r){t.x=n;t.y=r;return t};Rt.add=function e(t,n,r){t.x=n.x+r.x;t.y=n.y+r.y;return t};Rt.subtract=function e(t,n,r){t.x=n.x-r.x;t.y=n.y-r.y;return t};Rt.sub=function e(t,n,r){return Rt.subtract(t,n,r)};Rt.multiply=function e(t,n,r){t.x=n.x*r.x;t.y=n.y*r.y;return t};Rt.mul=function e(t,n,r){return Rt.multiply(t,n,r)};Rt.divide=function e(t,n,r){t.x=n.x/r.x;t.y=n.y/r.y;return t};Rt.div=function e(t,n,r){return Rt.divide(t,n,r)};Rt.ceil=function e(t,n){t.x=Math.ceil(n.x);t.y=Math.ceil(n.y);return t};Rt.floor=function e(t,n){t.x=Math.floor(n.x);t.y=Math.floor(n.y);return t};Rt.min=function e(t,n,r){t.x=Math.min(n.x,r.x);t.y=Math.min(n.y,r.y);return t};Rt.max=function e(t,n,r){t.x=Math.max(n.x,r.x);t.y=Math.max(n.y,r.y);return t};Rt.round=function e(t,n){t.x=Math.round(n.x);t.y=Math.round(n.y);return t};Rt.scale=function e(t,n,r){t.x=n.x*r;t.y=n.y*r;return t};Rt.scaleAndAdd=function e(t,n,r,i){t.x=n.x+r.x*i;t.y=n.y+r.y*i;return t};Rt.distance=function e(t,n){var r=n.x-t.x,i=n.y-t.y;return Math.sqrt(r*r+i*i)};Rt.dist=function e(t,n){return Rt.distance(t,n)};Rt.squaredDistance=function e(t,n){var r=n.x-t.x,i=n.y-t.y;return r*r+i*i};Rt.sqrDist=function e(t,n){return Rt.squaredDistance(t,n)};Rt.magnitude=function e(t){var n=t.x,r=t.y;return Math.sqrt(n*n+r*r)};Rt.mag=function e(t){return Rt.magnitude(t)};Rt.squaredMagnitude=function e(t){var n=t.x,r=t.y;return n*n+r*r};Rt.sqrMag=function e(t){return Rt.squaredMagnitude(t)};Rt.negate=function e(t,n){t.x=-n.x;t.y=-n.y;return t};Rt.inverse=function e(t,n){t.x=1/n.x;t.y=1/n.y;return t};Rt.inverseSafe=function e(t,n){var r=n.x,i=n.y;if(Math.abs(r)<Ve){t.x=0}else{t.x=1/r}if(Math.abs(i)<Ve){t.y=0}else{t.y=1/n.y}return t};Rt.normalize=function e(t,n){var r=n.x,i=n.y;var a=r*r+i*i;if(a>0){a=1/Math.sqrt(a);t.x=n.x*a;t.y=n.y*a}return t};Rt.dot=function e(t,n){return t.x*n.x+t.y*n.y};Rt.cross=function e(t,n,r){var i=n.x*r.y-n.y*r.x;t.x=t.y=0;t.z=i;return t};Rt.lerp=function e(t,n,r,i){var a=n.x,o=n.y;t.x=a+i*(r.x-a);t.y=o+i*(r.y-o);return t};Rt.random=function e(t,n){n=n||1;var r=Ke()*2*Math.PI;t.x=Math.cos(r)*n;t.y=Math.sin(r)*n;return t};Rt.transformMat2=function e(t,n,r){var i=n.x,a=n.y;t.x=r.m00*i+r.m02*a;t.y=r.m01*i+r.m03*a;return t};Rt.transformMat23=function e(t,n,r){var i=n.x,a=n.y;t.x=r.m00*i+r.m02*a+r.m04;t.y=r.m01*i+r.m03*a+r.m05;return t};Rt.transformMat3=function e(t,n,r){var i=n.x,a=n.y;t.x=r.m00*i+r.m03*a+r.m06;t.y=r.m01*i+r.m04*a+r.m07;return t};Rt.transformMat4=function e(t,n,r){var i=n.x,a=n.y;t.x=r.m00*i+r.m04*a+r.m12;t.y=r.m01*i+r.m05*a+r.m13;return t};Rt.forEach=function e(t,n,r,i,a,o){return Rt._forEach(t,n,r,i,a,o)};Rt.str=function e(t){return"vec2("+t.x+", "+t.y+")"};Rt.array=function e(t,n){t[0]=n.x;t[1]=n.y;return t};Rt.exactEquals=function e(t,n){return t.x===n.x&&t.y===n.y};Rt.equals=function e(t,n){var r=t.x,i=t.y;var a=n.x,o=n.y;return Math.abs(r-a)<=Ve*Math.max(1,Math.abs(r),Math.abs(a))&&Math.abs(i-o)<=Ve*Math.max(1,Math.abs(i),Math.abs(o))};Rt._forEach=function(){var l=Rt.zero();return function(e,t,n,r,i,a){var o,s;if(!t){t=2}if(!n){n=0}if(r){s=Math.min(r*t+n,e.length)}else{s=e.length}for(o=n;o<s;o+=t){l.x=e[o];l.y=e[o+1];i(l,l,a);e[o]=l.x;e[o+1]=l.y}return e}}();var Lt=function e(t,n,r){this.x=t;this.y=n;this.z=r};Lt.new=function e(t,n,r){return new Lt(t,n,r)};Lt.zero=function e(){return Lt.new(0,0,0)};Lt.clone=function e(t){return new Lt(t.x,t.y,t.z)};Lt.copy=function e(t,n){t.x=n.x;t.y=n.y;t.z=n.z;return t};Lt.set=function e(t,n,r,i){t.x=n;t.y=r;t.z=i;return t};Lt.add=function e(t,n,r){t.x=n.x+r.x;t.y=n.y+r.y;t.z=n.z+r.z;return t};Lt.subtract=function e(t,n,r){t.x=n.x-r.x;t.y=n.y-r.y;t.z=n.z-r.z;return t};Lt.sub=function e(t,n,r){return Lt.subtract(t,n,r)};Lt.multiply=function e(t,n,r){t.x=n.x*r.x;t.y=n.y*r.y;t.z=n.z*r.z;return t};Lt.mul=function e(t,n,r){return Lt.multiply(t,n,r)};Lt.divide=function e(t,n,r){t.x=n.x/r.x;t.y=n.y/r.y;t.z=n.z/r.z;return t};Lt.div=function e(t,n,r){return Lt.divide(t,n,r)};Lt.ceil=function e(t,n){t.x=Math.ceil(n.x);t.y=Math.ceil(n.y);t.z=Math.ceil(n.z);return t};Lt.floor=function e(t,n){t.x=Math.floor(n.x);t.y=Math.floor(n.y);t.z=Math.floor(n.z);return t};Lt.min=function e(t,n,r){t.x=Math.min(n.x,r.x);t.y=Math.min(n.y,r.y);t.z=Math.min(n.z,r.z);return t};Lt.max=function e(t,n,r){t.x=Math.max(n.x,r.x);t.y=Math.max(n.y,r.y);t.z=Math.max(n.z,r.z);return t};Lt.round=function e(t,n){t.x=Math.round(n.x);t.y=Math.round(n.y);t.z=Math.round(n.z);return t};Lt.scale=function e(t,n,r){t.x=n.x*r;t.y=n.y*r;t.z=n.z*r;return t};Lt.scaleAndAdd=function e(t,n,r,i){t.x=n.x+r.x*i;t.y=n.y+r.y*i;t.z=n.z+r.z*i;return t};Lt.distance=function e(t,n){var r=n.x-t.x,i=n.y-t.y,a=n.z-t.z;return Math.sqrt(r*r+i*i+a*a)};Lt.dist=function e(t,n){return Lt.distance(t,n)};Lt.squaredDistance=function e(t,n){var r=n.x-t.x,i=n.y-t.y,a=n.z-t.z;return r*r+i*i+a*a};Lt.sqrDist=function e(t,n){return Lt.squaredDistance(t,n)};Lt.magnitude=function e(t){var n=t.x,r=t.y,i=t.z;return Math.sqrt(n*n+r*r+i*i)};Lt.mag=function e(t){return Lt.magnitude(t)};Lt.squaredMagnitude=function e(t){var n=t.x,r=t.y,i=t.z;return n*n+r*r+i*i};Lt.sqrMag=function e(t){return Lt.squaredMagnitude(t)};Lt.negate=function e(t,n){t.x=-n.x;t.y=-n.y;t.z=-n.z;return t};Lt.inverse=function e(t,n){t.x=1/n.x;t.y=1/n.y;t.z=1/n.z;return t};Lt.inverseSafe=function e(t,n){var r=n.x,i=n.y,a=n.z;if(Math.abs(r)<Ve){t.x=0}else{t.x=1/r}if(Math.abs(i)<Ve){t.y=0}else{t.y=1/i}if(Math.abs(a)<Ve){t.z=0}else{t.z=1/a}return t};Lt.normalize=function e(t,n){var r=n.x,i=n.y,a=n.z;var o=r*r+i*i+a*a;if(o>0){o=1/Math.sqrt(o);t.x=r*o;t.y=i*o;t.z=a*o}return t};Lt.dot=function e(t,n){return t.x*n.x+t.y*n.y+t.z*n.z};Lt.cross=function e(t,n,r){var i=n.x,a=n.y,o=n.z,s=r.x,l=r.y,u=r.z;t.x=a*u-o*l;t.y=o*s-i*u;t.z=i*l-a*s;return t};Lt.lerp=function e(t,n,r,i){var a=n.x,o=n.y,s=n.z;t.x=a+i*(r.x-a);t.y=o+i*(r.y-o);t.z=s+i*(r.z-s);return t};Lt.hermite=function e(t,n,r,i,a,o){var s=o*o,l=s*(2*o-3)+1,u=s*(o-2)+o,h=s*(o-1),c=s*(3-2*o);t.x=n.x*l+r.x*u+i.x*h+a.x*c;t.y=n.y*l+r.y*u+i.y*h+a.y*c;t.z=n.z*l+r.z*u+i.z*h+a.z*c;return t};Lt.bezier=function e(t,n,r,i,a,o){var s=1-o,l=s*s,u=o*o,h=l*s,c=3*o*l,f=3*u*s,p=u*o;t.x=n.x*h+r.x*c+i.x*f+a.x*p;t.y=n.y*h+r.y*c+i.y*f+a.y*p;t.z=n.z*h+r.z*c+i.z*f+a.z*p;return t};Lt.random=function e(t,n){n=n||1;var r=Ke()*2*Math.PI;var i=Ke()*2-1;var a=Math.sqrt(1-i*i)*n;t.x=Math.cos(r)*a;t.y=Math.sin(r)*a;t.z=i*n;return t};Lt.transformMat4=function e(t,n,r){var i=n.x,a=n.y,o=n.z,s=r.m03*i+r.m07*a+r.m11*o+r.m15;s=s||1;t.x=(r.m00*i+r.m04*a+r.m08*o+r.m12)/s;t.y=(r.m01*i+r.m05*a+r.m09*o+r.m13)/s;t.z=(r.m02*i+r.m06*a+r.m10*o+r.m14)/s;return t};Lt.transformMat3=function e(t,n,r){var i=n.x,a=n.y,o=n.z;t.x=i*r.m00+a*r.m03+o*r.m06;t.y=i*r.m01+a*r.m04+o*r.m07;t.z=i*r.m02+a*r.m05+o*r.m08;return t};Lt.transformQuat=function e(t,n,r){var i=n.x,a=n.y,o=n.z;var s=r.x,l=r.y,u=r.z,h=r.w;var c=h*i+l*o-u*a;var f=h*a+u*i-s*o;var p=h*o+s*a-l*i;var d=-s*i-l*a-u*o;t.x=c*h+d*-s+f*-u-p*-l;t.y=f*h+d*-l+p*-s-c*-u;t.z=p*h+d*-u+c*-l-f*-s;return t};Lt.rotateX=function e(t,n,r,i){var a=[],o=[];a.x=n.x-r.x;a.y=n.y-r.y;a.z=n.z-r.z;o.x=a.x;o.y=a.y*Math.cos(i)-a.z*Math.sin(i);o.z=a.y*Math.sin(i)+a.z*Math.cos(i);t.x=o.x+r.x;t.y=o.y+r.y;t.z=o.z+r.z;return t};Lt.rotateY=function e(t,n,r,i){var a=[],o=[];a.x=n.x-r.x;a.y=n.y-r.y;a.z=n.z-r.z;o.x=a.z*Math.sin(i)+a.x*Math.cos(i);o.y=a.y;o.z=a.z*Math.cos(i)-a.x*Math.sin(i);t.x=o.x+r.x;t.y=o.y+r.y;t.z=o.z+r.z;return t};Lt.rotateZ=function e(t,n,r,i){var a=[],o=[];a.x=n.x-r.x;a.y=n.y-r.y;a.z=n.z-r.z;o.x=a.x*Math.cos(i)-a.y*Math.sin(i);o.y=a.x*Math.sin(i)+a.y*Math.cos(i);o.z=a.z;t.x=o.x+r.x;t.y=o.y+r.y;t.z=o.z+r.z;return t};Lt.str=function e(t){return"vec3("+t.x+", "+t.y+", "+t.z+")"};Lt.array=function e(t,n){t[0]=n.x;t[1]=n.y;t[2]=n.z;return t};Lt.exactEquals=function e(t,n){return t.x===n.x&&t.y===n.y&&t.z===n.z};Lt.equals=function e(t,n){var r=t.x,i=t.y,a=t.z;var o=n.x,s=n.y,l=n.z;return Math.abs(r-o)<=Ve*Math.max(1,Math.abs(r),Math.abs(o))&&Math.abs(i-s)<=Ve*Math.max(1,Math.abs(i),Math.abs(s))&&Math.abs(a-l)<=Ve*Math.max(1,Math.abs(a),Math.abs(l))};Lt.forEach=function e(t,n,r,i,a,o){return Lt._forEach(t,n,r,i,a,o)};Lt.angle=function e(t,n){return Lt._angle(t,n)};Lt._forEach=function(){var l=Lt.zero();return function(e,t,n,r,i,a){var o,s;if(!t){t=3}if(!n){n=0}if(r){s=Math.min(r*t+n,e.length)}else{s=e.length}for(o=n;o<s;o+=t){l.x=e[o];l.y=e[o+1];l.z=e[o+2];i(l,l,a);e[o]=l.x;e[o+1]=l.y;e[o+2]=l.z}return e}}();Lt._angle=function(){var r=Lt.zero();var i=Lt.zero();return function(e,t){Lt.copy(r,e);Lt.copy(i,t);Lt.normalize(r,r);Lt.normalize(i,i);var n=Lt.dot(r,i);if(n>1){return 0}if(n<-1){return Math.PI}return Math.acos(n)}}();var Ct=function e(t,n,r,i){this.x=t;this.y=n;this.z=r;this.w=i};Ct.new=function e(t,n,r,i){return new Ct(t,n,r,i)};Ct.zero=function e(){return Ct.new(0,0,0,0)};Ct.clone=function e(t){return new Ct(t.x,t.y,t.z,t.w)};Ct.copy=function e(t,n){t.x=n.x;t.y=n.y;t.z=n.z;t.w=n.w;return t};Ct.set=function e(t,n,r,i,a){t.x=n;t.y=r;t.z=i;t.w=a;return t};Ct.add=function e(t,n,r){t.x=n.x+r.x;t.y=n.y+r.y;t.z=n.z+r.z;t.w=n.w+r.w;return t};Ct.subtract=function e(t,n,r){t.x=n.x-r.x;t.y=n.y-r.y;t.z=n.z-r.z;t.w=n.w-r.w;return t};Ct.sub=function e(t,n,r){return Ct.subtract(t,n,r)};Ct.multiply=function e(t,n,r){t.x=n.x*r.x;t.y=n.y*r.y;t.z=n.z*r.z;t.w=n.w*r.w;return t};Ct.mul=function e(t,n,r){return Ct.multiply(t,n,r)};Ct.divide=function e(t,n,r){t.x=n.x/r.x;t.y=n.y/r.y;t.z=n.z/r.z;t.w=n.w/r.w;return t};Ct.div=function e(t,n,r){return Ct.divide(t,n,r)};Ct.ceil=function e(t,n){t.x=Math.ceil(n.x);t.y=Math.ceil(n.y);t.z=Math.ceil(n.z);t.w=Math.ceil(n.w);return t};Ct.floor=function e(t,n){t.x=Math.floor(n.x);t.y=Math.floor(n.y);t.z=Math.floor(n.z);t.w=Math.floor(n.w);return t};Ct.min=function e(t,n,r){t.x=Math.min(n.x,r.x);t.y=Math.min(n.y,r.y);t.z=Math.min(n.z,r.z);t.w=Math.min(n.w,r.w);return t};Ct.max=function e(t,n,r){t.x=Math.max(n.x,r.x);t.y=Math.max(n.y,r.y);t.z=Math.max(n.z,r.z);t.w=Math.max(n.w,r.w);return t};Ct.round=function e(t,n){t.x=Math.round(n.x);t.y=Math.round(n.y);t.z=Math.round(n.z);t.w=Math.round(n.w);return t};Ct.scale=function e(t,n,r){t.x=n.x*r;t.y=n.y*r;t.z=n.z*r;t.w=n.w*r;return t};Ct.scaleAndAdd=function e(t,n,r,i){t.x=n.x+r.x*i;t.y=n.y+r.y*i;t.z=n.z+r.z*i;t.w=n.w+r.w*i;return t};Ct.distance=function e(t,n){var r=n.x-t.x,i=n.y-t.y,a=n.z-t.z,o=n.w-t.w;return Math.sqrt(r*r+i*i+a*a+o*o)};Ct.dist=function e(t,n){return Ct.distance(t,n)};Ct.squaredDistance=function e(t,n){var r=n.x-t.x,i=n.y-t.y,a=n.z-t.z,o=n.w-t.w;return r*r+i*i+a*a+o*o};Ct.sqrDist=function e(t,n){return Ct.squaredDistance(t,n)};Ct.magnitude=function e(t){var n=t.x,r=t.y,i=t.z,a=t.w;return Math.sqrt(n*n+r*r+i*i+a*a)};Ct.mag=function e(t){return Ct.magnitude(t)};Ct.squaredMagnitude=function e(t){var n=t.x,r=t.y,i=t.z,a=t.w;return n*n+r*r+i*i+a*a};Ct.sqrMag=function e(t){return Ct.squaredMagnitude(t)};Ct.negate=function e(t,n){t.x=-n.x;t.y=-n.y;t.z=-n.z;t.w=-n.w;return t};Ct.inverse=function e(t,n){t.x=1/n.x;t.y=1/n.y;t.z=1/n.z;t.w=1/n.w;return t};Ct.inverseSafe=function e(t,n){var r=n.x,i=n.y,a=n.z,o=n.w;if(Math.abs(r)<Ve){t.x=0}else{t.x=1/r}if(Math.abs(i)<Ve){t.y=0}else{t.y=1/i}if(Math.abs(a)<Ve){t.z=0}else{t.z=1/a}if(Math.abs(o)<Ve){t.w=0}else{t.w=1/o}return t};Ct.normalize=function e(t,n){var r=n.x,i=n.y,a=n.z,o=n.w;var s=r*r+i*i+a*a+o*o;if(s>0){s=1/Math.sqrt(s);t.x=r*s;t.y=i*s;t.z=a*s;t.w=o*s}return t};Ct.dot=function e(t,n){return t.x*n.x+t.y*n.y+t.z*n.z+t.w*n.w};Ct.lerp=function e(t,n,r,i){var a=n.x,o=n.y,s=n.z,l=n.w;t.x=a+i*(r.x-a);t.y=o+i*(r.y-o);t.z=s+i*(r.z-s);t.w=l+i*(r.w-l);return t};Ct.random=function e(t,n){n=n||1;t.x=Ke();t.y=Ke();t.z=Ke();t.w=Ke();Ct.normalize(t,t);Ct.scale(t,t,n);return t};Ct.transformMat4=function e(t,n,r){var i=n.x,a=n.y,o=n.z,s=n.w;t.x=r.m00*i+r.m04*a+r.m08*o+r.m12*s;t.y=r.m01*i+r.m05*a+r.m09*o+r.m13*s;t.z=r.m02*i+r.m06*a+r.m10*o+r.m14*s;t.w=r.m03*i+r.m07*a+r.m11*o+r.m15*s;return t};Ct.transformQuat=function e(t,n,r){var i=n.x,a=n.y,o=n.z;var s=r.x,l=r.y,u=r.z,h=r.w;var c=h*i+l*o-u*a;var f=h*a+u*i-s*o;var p=h*o+s*a-l*i;var d=-s*i-l*a-u*o;t.x=c*h+d*-s+f*-u-p*-l;t.y=f*h+d*-l+p*-s-c*-u;t.z=p*h+d*-u+c*-l-f*-s;t.w=n.w;return t};Ct.str=function e(t){return"vec4("+t.x+", "+t.y+", "+t.z+", "+t.w+")"};Ct.array=function e(t,n){t[0]=n.x;t[1]=n.y;t[2]=n.z;t[3]=n.w;return t};Ct.exactEquals=function e(t,n){return t.x===n.x&&t.y===n.y&&t.z===n.z&&t.w===n.w};Ct.equals=function e(t,n){var r=t.x,i=t.y,a=t.z,o=t.w;var s=n.x,l=n.y,u=n.z,h=n.w;return Math.abs(r-s)<=Ve*Math.max(1,Math.abs(r),Math.abs(s))&&Math.abs(i-l)<=Ve*Math.max(1,Math.abs(i),Math.abs(l))&&Math.abs(a-u)<=Ve*Math.max(1,Math.abs(a),Math.abs(u))&&Math.abs(o-h)<=Ve*Math.max(1,Math.abs(o),Math.abs(h))};Ct.forEach=function e(t,n,r,i,a,o){return Ct._forEach(t,n,r,i,a,o)};Ct._forEach=function(){var l=Ct.zero();return function(e,t,n,r,i,a){var o,s;if(!t){t=4}if(!n){n=0}if(r){s=Math.min(r*t+n,e.length)}else{s=e.length}for(o=n;o<s;o+=t){l.x=e[o];l.y=e[o+1];l.z=e[o+2];l.w=e[o+3];i(l,l,a);e[o]=l.x;e[o+1]=l.y;e[o+2]=l.z;e[o+3]=l.w}return e}}();var Ot=function e(t,n,r,i,a,o,s,l,u){this.m00=t;this.m01=n;this.m02=r;this.m03=i;this.m04=a;this.m05=o;this.m06=s;this.m07=l;this.m08=u};Ot.create=function e(){return new Ot(1,0,0,0,1,0,0,0,1)};Ot.new=function e(t,n,r,i,a,o,s,l,u){return new Ot(t,n,r,i,a,o,s,l,u)};Ot.clone=function e(t){return new Ot(t.m00,t.m01,t.m02,t.m03,t.m04,t.m05,t.m06,t.m07,t.m08)};Ot.copy=function e(t,n){t.m00=n.m00;t.m01=n.m01;t.m02=n.m02;t.m03=n.m03;t.m04=n.m04;t.m05=n.m05;t.m06=n.m06;t.m07=n.m07;t.m08=n.m08;return t};Ot.set=function e(t,n,r,i,a,o,s,l,u,h){t.m00=n;t.m01=r;t.m02=i;t.m03=a;t.m04=o;t.m05=s;t.m06=l;t.m07=u;t.m08=h;return t};Ot.identity=function e(t){t.m00=1;t.m01=0;t.m02=0;t.m03=0;t.m04=1;t.m05=0;t.m06=0;t.m07=0;t.m08=1;return t};Ot.transpose=function e(t,n){if(t===n){var r=n.m01,i=n.m02,a=n.m05;t.m01=n.m03;t.m02=n.m06;t.m03=r;t.m05=n.m07;t.m06=i;t.m07=a}else{t.m00=n.m00;t.m01=n.m03;t.m02=n.m06;t.m03=n.m01;t.m04=n.m04;t.m05=n.m07;t.m06=n.m02;t.m07=n.m05;t.m08=n.m08}return t};Ot.invert=function e(t,n){var r=n.m00,i=n.m01,a=n.m02,o=n.m03,s=n.m04,l=n.m05,u=n.m06,h=n.m07,c=n.m08;var f=c*s-l*h;var p=-c*o+l*u;var d=h*o-s*u;var v=r*f+i*p+a*d;if(!v){return null}v=1/v;t.m00=f*v;t.m01=(-c*i+a*h)*v;t.m02=(l*i-a*s)*v;t.m03=p*v;t.m04=(c*r-a*u)*v;t.m05=(-l*r+a*o)*v;t.m06=d*v;t.m07=(-h*r+i*u)*v;t.m08=(s*r-i*o)*v;return t};Ot.adjoint=function e(t,n){var r=n.m00,i=n.m01,a=n.m02,o=n.m03,s=n.m04,l=n.m05,u=n.m06,h=n.m07,c=n.m08;t.m00=s*c-l*h;t.m01=a*h-i*c;t.m02=i*l-a*s;t.m03=l*u-o*c;t.m04=r*c-a*u;t.m05=a*o-r*l;t.m06=o*h-s*u;t.m07=i*u-r*h;t.m08=r*s-i*o;return t};Ot.determinant=function e(t){var n=t.m00,r=t.m01,i=t.m02,a=t.m03,o=t.m04,s=t.m05,l=t.m06,u=t.m07,h=t.m08;return n*(h*o-s*u)+r*(-h*a+s*l)+i*(u*a-o*l)};Ot.multiply=function e(t,n,r){var i=n.m00,a=n.m01,o=n.m02,s=n.m03,l=n.m04,u=n.m05,h=n.m06,c=n.m07,f=n.m08;var p=r.m00,d=r.m01,v=r.m02;var m=r.m03,_=r.m04,g=r.m05;var y=r.m06,x=r.m07,b=r.m08;t.m00=p*i+d*s+v*h;t.m01=p*a+d*l+v*c;t.m02=p*o+d*u+v*f;t.m03=m*i+_*s+g*h;t.m04=m*a+_*l+g*c;t.m05=m*o+_*u+g*f;t.m06=y*i+x*s+b*h;t.m07=y*a+x*l+b*c;t.m08=y*o+x*u+b*f;return t};Ot.mul=function e(t,n,r){return Ot.multiply(t,n,r)};Ot.translate=function e(t,n,r){var i=n.m00,a=n.m01,o=n.m02,s=n.m03,l=n.m04,u=n.m05,h=n.m06,c=n.m07,f=n.m08;var p=r.x,d=r.y;t.m00=i;t.m01=a;t.m02=o;t.m03=s;t.m04=l;t.m05=u;t.m06=p*i+d*s+h;t.m07=p*a+d*l+c;t.m08=p*o+d*u+f;return t};Ot.rotate=function e(t,n,r){var i=n.m00,a=n.m01,o=n.m02,s=n.m03,l=n.m04,u=n.m05,h=n.m06,c=n.m07,f=n.m08;var p=Math.sin(r);var d=Math.cos(r);t.m00=d*i+p*s;t.m01=d*a+p*l;t.m02=d*o+p*u;t.m03=d*s-p*i;t.m04=d*l-p*a;t.m05=d*u-p*o;t.m06=h;t.m07=c;t.m08=f;return t};Ot.scale=function e(t,n,r){var i=r.x,a=r.y;t.m00=i*n.m00;t.m01=i*n.m01;t.m02=i*n.m02;t.m03=a*n.m03;t.m04=a*n.m04;t.m05=a*n.m05;t.m06=n.m06;t.m07=n.m07;t.m08=n.m08;return t};Ot.fromMat4=function e(t,n){t.m00=n.m00;t.m01=n.m01;t.m02=n.m02;t.m03=n.m04;t.m04=n.m05;t.m05=n.m06;t.m06=n.m08;t.m07=n.m09;t.m08=n.m10;return t};Ot.fromTranslation=function e(t,n){t.m00=1;t.m01=0;t.m02=0;t.m03=0;t.m04=1;t.m05=0;t.m06=n.x;t.m07=n.y;t.m08=1;return t};Ot.fromRotation=function e(t,n){var r=Math.sin(n),i=Math.cos(n);t.m00=i;t.m01=r;t.m02=0;t.m03=-r;t.m04=i;t.m05=0;t.m06=0;t.m07=0;t.m08=1;return t};Ot.fromScaling=function e(t,n){t.m00=n.x;t.m01=0;t.m02=0;t.m03=0;t.m04=n.y;t.m05=0;t.m06=0;t.m07=0;t.m08=1;return t};Ot.fromMat2d=function e(t,n){t.m00=n.m00;t.m01=n.m01;t.m02=0;t.m03=n.m02;t.m04=n.m03;t.m05=0;t.m06=n.m04;t.m07=n.m05;t.m08=1;return t};Ot.fromQuat=function e(t,n){var r=n.x,i=n.y,a=n.z,o=n.w;var s=r+r;var l=i+i;var u=a+a;var h=r*s;var c=i*s;var f=i*l;var p=a*s;var d=a*l;var v=a*u;var m=o*s;var _=o*l;var g=o*u;t.m00=1-f-v;t.m03=c-g;t.m06=p+_;t.m01=c+g;t.m04=1-h-v;t.m07=d-m;t.m02=p-_;t.m05=d+m;t.m08=1-h-f;return t};Ot.fromViewUp=function e(t,n,r){return Ot._fromViewUp(t,n,r)};Ot.normalFromMat4=function e(t,n){var r=n.m00,i=n.m01,a=n.m02,o=n.m03,s=n.m04,l=n.m05,u=n.m06,h=n.m07,c=n.m08,f=n.m09,p=n.m10,d=n.m11,v=n.m12,m=n.m13,_=n.m14,g=n.m15;var y=r*l-i*s;var x=r*u-a*s;var b=r*h-o*s;var w=i*u-a*l;var E=i*h-o*l;var T=a*h-o*u;var S=c*m-f*v;var A=c*_-p*v;var M=c*g-d*v;var R=f*_-p*m;var L=f*g-d*m;var C=p*g-d*_;var O=y*C-x*L+b*R+w*M-E*A+T*S;if(!O){return null}O=1/O;t.m00=(l*C-u*L+h*R)*O;t.m01=(u*M-s*C-h*A)*O;t.m02=(s*L-l*M+h*S)*O;t.m03=(a*L-i*C-o*R)*O;t.m04=(r*C-a*M+o*A)*O;t.m05=(i*M-r*L-o*S)*O;t.m06=(m*T-_*E+g*w)*O;t.m07=(_*b-v*T-g*x)*O;t.m08=(v*E-m*b+g*y)*O;return t};Ot.str=function e(t){return"mat3("+t.m00+", "+t.m01+", "+t.m02+", "+t.m03+", "+t.m04+", "+t.m05+", "+t.m06+", "+t.m07+", "+t.m08+")"};Ot.array=function e(t,n){t[0]=n.m00;t[1]=n.m01;t[2]=n.m02;t[3]=n.m03;t[4]=n.m04;t[5]=n.m05;t[6]=n.m06;t[7]=n.m07;t[8]=n.m08;return t};Ot.frob=function e(t){return Math.sqrt(Math.pow(t.m00,2)+Math.pow(t.m01,2)+Math.pow(t.m02,2)+Math.pow(t.m03,2)+Math.pow(t.m04,2)+Math.pow(t.m05,2)+Math.pow(t.m06,2)+Math.pow(t.m07,2)+Math.pow(t.m08,2))};Ot.add=function e(t,n,r){t.m00=n.m00+r.m00;t.m01=n.m01+r.m01;t.m02=n.m02+r.m02;t.m03=n.m03+r.m03;t.m04=n.m04+r.m04;t.m05=n.m05+r.m05;t.m06=n.m06+r.m06;t.m07=n.m07+r.m07;t.m08=n.m08+r.m08;return t};Ot.subtract=function e(t,n,r){t.m00=n.m00-r.m00;t.m01=n.m01-r.m01;t.m02=n.m02-r.m02;t.m03=n.m03-r.m03;t.m04=n.m04-r.m04;t.m05=n.m05-r.m05;t.m06=n.m06-r.m06;t.m07=n.m07-r.m07;t.m08=n.m08-r.m08;return t};Ot.sub=function e(t,n,r){return Ot.subtract(t,n,r)};Ot.multiplyScalar=function e(t,n,r){t.m00=n.m00*r;t.m01=n.m01*r;t.m02=n.m02*r;t.m03=n.m03*r;t.m04=n.m04*r;t.m05=n.m05*r;t.m06=n.m06*r;t.m07=n.m07*r;t.m08=n.m08*r;return t};Ot.multiplyScalarAndAdd=function e(t,n,r,i){t.m00=n.m00+r.m00*i;t.m01=n.m01+r.m01*i;t.m02=n.m02+r.m02*i;t.m03=n.m03+r.m03*i;t.m04=n.m04+r.m04*i;t.m05=n.m05+r.m05*i;t.m06=n.m06+r.m06*i;t.m07=n.m07+r.m07*i;t.m08=n.m08+r.m08*i;return t};Ot.exactEquals=function e(t,n){return t.m00===n.m00&&t.m01===n.m01&&t.m02===n.m02&&t.m03===n.m03&&t.m04===n.m04&&t.m05===n.m05&&t.m06===n.m06&&t.m07===n.m07&&t.m08===n.m08};Ot.equals=function e(t,n){var r=t.m00,i=t.m01,a=t.m02,o=t.m03,s=t.m04,l=t.m05,u=t.m06,h=t.m07,c=t.m08;var f=n.m00,p=n.m01,d=n.m02,v=n.m03,m=n.m04,_=n.m05,g=n.m06,y=n.m07,x=n.m08;return Math.abs(r-f)<=Ve*Math.max(1,Math.abs(r),Math.abs(f))&&Math.abs(i-p)<=Ve*Math.max(1,Math.abs(i),Math.abs(p))&&Math.abs(a-d)<=Ve*Math.max(1,Math.abs(a),Math.abs(d))&&Math.abs(o-v)<=Ve*Math.max(1,Math.abs(o),Math.abs(v))&&Math.abs(s-m)<=Ve*Math.max(1,Math.abs(s),Math.abs(m))&&Math.abs(l-_)<=Ve*Math.max(1,Math.abs(l),Math.abs(_))&&Math.abs(u-g)<=Ve*Math.max(1,Math.abs(u),Math.abs(g))&&Math.abs(h-y)<=Ve*Math.max(1,Math.abs(h),Math.abs(y))&&Math.abs(c-x)<=Ve*Math.max(1,Math.abs(c),Math.abs(x))};Ot._fromViewUp=function(){var r=Lt.new(0,1,0);var i=Lt.zero();var a=Lt.zero();return function(e,t,n){if(Lt.sqrMag(t)<Ve*Ve){Ot.identity(e);return e}n=n||r;Lt.normalize(i,Lt.cross(i,n,t));if(Lt.sqrMag(i)<Ve*Ve){Ot.identity(e);return e}Lt.cross(a,t,i);Ot.set(e,i.x,i.y,i.z,a.x,a.y,a.z,t.x,t.y,t.z);return e}}();var It=function e(t,n,r,i){this.x=t;this.y=n;this.z=r;this.w=i};It.new=function e(t,n,r,i){return new It(t,n,r,i)};It.create=function e(){return new It(0,0,0,1)};It.clone=function e(t){return new It(t.x,t.y,t.z,t.w)};It.copy=function e(t,n){return Ct.copy(t,n)};It.set=function e(t,n,r,i,a){t.x=n;t.y=r;t.z=i;t.w=a;return t};It.identity=function e(t){t.x=0;t.y=0;t.z=0;t.w=1;return t};It.rotationTo=function e(t,n,r){return It._rotationTo(t,n,r)};It.getAxisAngle=function e(t,n){var r=Math.acos(n.w)*2;var i=Math.sin(r/2);if(i!=0){t.x=n.x/i;t.y=n.y/i;t.z=n.z/i}else{t.x=1;t.y=0;t.z=0}return r};It.multiply=function e(t,n,r){var i=n.x,a=n.y,o=n.z,s=n.w,l=r.x,u=r.y,h=r.z,c=r.w;t.x=i*c+s*l+a*h-o*u;t.y=a*c+s*u+o*l-i*h;t.z=o*c+s*h+i*u-a*l;t.w=s*c-i*l-a*u-o*h;return t};It.mul=function e(t,n,r){return It.multiply(t,n,r)};It.scale=function e(t,n,r){t.x=n.x*r;t.y=n.y*r;t.z=n.z*r;t.w=n.w*r;return t};It.rotateX=function e(t,n,r){r*=.5;var i=n.x,a=n.y,o=n.z,s=n.w,l=Math.sin(r),u=Math.cos(r);t.x=i*u+s*l;t.y=a*u+o*l;t.z=o*u-a*l;t.w=s*u-i*l;return t};It.rotateY=function e(t,n,r){r*=.5;var i=n.x,a=n.y,o=n.z,s=n.w,l=Math.sin(r),u=Math.cos(r);t.x=i*u-o*l;t.y=a*u+s*l;t.z=o*u+i*l;t.w=s*u-a*l;return t};It.rotateZ=function e(t,n,r){r*=.5;var i=n.x,a=n.y,o=n.z,s=n.w,l=Math.sin(r),u=Math.cos(r);t.x=i*u+a*l;t.y=a*u-i*l;t.z=o*u+s*l;t.w=s*u-o*l;return t};It.rotateAround=function e(t,n,r,i){return It._rotateAround(t,n,r,i)};It.rotateAroundLocal=function e(t,n,r,i){return It._rotateAroundLocal(t,n,r,i)};It.calculateW=function e(t,n){var r=n.x,i=n.y,a=n.z;t.x=r;t.y=i;t.z=a;t.w=Math.sqrt(Math.abs(1-r*r-i*i-a*a));return t};It.dot=function e(t,n){return t.x*n.x+t.y*n.y+t.z*n.z+t.w*n.w};It.lerp=function e(t,n,r,i){var a=n.x,o=n.y,s=n.z,l=n.w;t.x=a+i*(r.x-a);t.y=o+i*(r.y-o);t.z=s+i*(r.z-s);t.w=l+i*(r.w-l);return t};It.slerp=function e(t,n,r,i){var a=n.x,o=n.y,s=n.z,l=n.w,u=r.x,h=r.y,c=r.z,f=r.w;var p,d,v,m,_;d=a*u+o*h+s*c+l*f;if(d<0){d=-d;u=-u;h=-h;c=-c;f=-f}if(1-d>1e-6){p=Math.acos(d);v=Math.sin(p);m=Math.sin((1-i)*p)/v;_=Math.sin(i*p)/v}else{m=1-i;_=i}t.x=m*a+_*u;t.y=m*o+_*h;t.z=m*s+_*c;t.w=m*l+_*f;return t};It.sqlerp=function e(t,n,r,i,a,o){return It._sqlerp(t,n,r,i,a,o)};It.invert=function e(t,n){var r=n.x,i=n.y,a=n.z,o=n.w;var s=r*r+i*i+a*a+o*o;var l=s?1/s:0;t.x=-r*l;t.y=-i*l;t.z=-a*l;t.w=o*l;return t};It.conjugate=function e(t,n){t.x=-n.x;t.y=-n.y;t.z=-n.z;t.w=n.w;return t};It.magnitude=function e(t){var n=t.x,r=t.y,i=t.z,a=t.w;return Math.sqrt(n*n+r*r+i*i+a*a)};It.mag=function e(t){return It.magnitude(t)};It.squaredMagnitude=function e(t){var n=t.x,r=t.y,i=t.z,a=t.w;return n*n+r*r+i*i+a*a};It.sqrMag=function e(t){return It.squaredMagnitude(t)};It.normalize=function e(t,n){var r=n.x,i=n.y,a=n.z,o=n.w;var s=r*r+i*i+a*a+o*o;if(s>0){s=1/Math.sqrt(s);t.x=r*s;t.y=i*s;t.z=a*s;t.w=o*s}return t};It.fromAxes=function e(t,n,r,i){return It._fromAxes(t,n,r,i)};It.fromViewUp=function e(t,n,r){return It._fromViewUp(t,n,r)};It.fromAxisAngle=function e(t,n,r){r=r*.5;var i=Math.sin(r);t.x=i*n.x;t.y=i*n.y;t.z=i*n.z;t.w=Math.cos(r);return t};It.fromMat3=function e(t,n){var r=n.m00,i=n.m03,a=n.m06,o=n.m01,s=n.m04,l=n.m07,u=n.m02,h=n.m05,c=n.m08;var f=r+s+c;if(f>0){var p=.5/Math.sqrt(f+1);t.w=.25/p;t.x=(h-l)*p;t.y=(a-u)*p;t.z=(o-i)*p}else if(r>s&&r>c){var d=2*Math.sqrt(1+r-s-c);t.w=(h-l)/d;t.x=.25*d;t.y=(i+o)/d;t.z=(a+u)/d}else if(s>c){var v=2*Math.sqrt(1+s-r-c);t.w=(a-u)/v;t.x=(i+o)/v;t.y=.25*v;t.z=(l+h)/v}else{var m=2*Math.sqrt(1+c-r-s);t.w=(o-i)/m;t.x=(a+u)/m;t.y=(l+h)/m;t.z=.25*m}return t};It.fromEuler=function e(t,n,r,i){var a=.5*Math.PI/180;n*=a;r*=a;i*=a;var o=Math.sin(n);var s=Math.cos(n);var l=Math.sin(r);var u=Math.cos(r);var h=Math.sin(i);var c=Math.cos(i);t.x=o*u*c-s*l*h;t.y=s*l*c+o*u*h;t.z=s*u*h-o*l*c;t.w=s*u*c+o*l*h;return t};It.str=function e(t){return"quat("+t.x+", "+t.y+", "+t.z+", "+t.w+")"};It.array=function e(t,n){t[0]=n.x;t[1]=n.y;t[2]=n.z;t[3]=n.w;return t};It.exactEquals=function e(t,n){return Ct.exactEquals(t,n)};It.equals=function e(t,n){return Ct.equals(t,n)};It._rotationTo=function(){var i=Lt.zero();var a=Lt.new(1,0,0);var o=Lt.new(0,1,0);return function(e,t,n){var r=Lt.dot(t,n);if(r<-.999999){Lt.cross(i,a,t);if(Lt.magnitude(i)<1e-6){Lt.cross(i,o,t)}Lt.normalize(i,i);It.fromAxisAngle(e,i,Math.PI);return e}else if(r>.999999){e.x=0;e.y=0;e.z=0;e.w=1;return e}else{Lt.cross(i,t,n);e.x=i.x;e.y=i.y;e.z=i.z;e.w=1+r;return It.normalize(e,e)}}}();It._rotateAround=function(){var i=Lt.zero();var a=It.create();return function(e,t,n,r){It.invert(a,t);Lt.transformQuat(i,n,a);It.fromAxisAngle(a,i,r);It.mul(e,t,a);return e}}();It._rotateAroundLocal=function(){var i=It.create();return function(e,t,n,r){It.fromAxisAngle(i,n,r);It.mul(e,t,i);return e}}();It._sqlerp=function(){var o=It.create();var s=It.create();return function(e,t,n,r,i,a){It.slerp(o,t,i,a);It.slerp(s,n,r,a);It.slerp(e,o,s,2*a*(1-a));return e}}();It._fromAxes=function(){var i=Ot.create();return function(e,t,n,r){Ot.set(i,t.x,t.y,t.z,n.x,n.y,n.z,r.x,r.y,r.z);return It.normalize(e,It.fromMat3(e,i))}}();It._fromViewUp=function(){var r=Ot.create();return function(e,t,n){Ot.fromViewUp(r,t,n);if(!r){return null}return It.normalize(e,It.fromMat3(e,r))}}();var Ut=function e(t,n,r,i){this.m00=t;this.m01=n;this.m02=r;this.m03=i};Ut.create=function e(){return new Ut(1,0,0,1)};Ut.new=function e(t,n,r,i){return new Ut(t,n,r,i)};Ut.clone=function e(t){return new Ut(t.m00,t.m01,t.m02,t.m03)};Ut.copy=function e(t,n){t.m00=n.m00;t.m01=n.m01;t.m02=n.m02;t.m03=n.m03;return t};Ut.identity=function e(t){t.m00=1;t.m01=0;t.m02=0;t.m03=1;return t};Ut.set=function e(t,n,r,i,a){t.m00=n;t.m01=r;t.m02=i;t.m03=a;return t};Ut.transpose=function e(t,n){if(t===n){var r=n.m01;t.m01=n.m02;t.m02=r}else{t.m00=n.m00;t.m01=n.m02;t.m02=n.m01;t.m03=n.m03}return t};Ut.invert=function e(t,n){var r=n.m00,i=n.m01,a=n.m02,o=n.m03;var s=r*o-a*i;if(!s){return null}s=1/s;t.m00=o*s;t.m01=-i*s;t.m02=-a*s;t.m03=r*s;return t};Ut.adjoint=function e(t,n){var r=n.m00;t.m00=n.m03;t.m01=-n.m01;t.m02=-n.m02;t.m03=r;return t};Ut.determinant=function e(t){return t.m00*t.m03-t.m02*t.m01};Ut.multiply=function e(t,n,r){var i=n.m00,a=n.m01,o=n.m02,s=n.m03;var l=r.m00,u=r.m01,h=r.m02,c=r.m03;t.m00=i*l+o*u;t.m01=a*l+s*u;t.m02=i*h+o*c;t.m03=a*h+s*c;return t};Ut.mul=function e(t,n,r){return Ut.multiply(t,n,r)};Ut.rotate=function e(t,n,r){var i=n.m00,a=n.m01,o=n.m02,s=n.m03,l=Math.sin(r),u=Math.cos(r);t.m00=i*u+o*l;t.m01=a*u+s*l;t.m02=i*-l+o*u;t.m03=a*-l+s*u;return t};Ut.scale=function e(t,n,r){var i=n.m00,a=n.m01,o=n.m02,s=n.m03,l=r.x,u=r.y;t.m00=i*l;t.m01=a*l;t.m02=o*u;t.m03=s*u;return t};Ut.fromRotation=function e(t,n){var r=Math.sin(n),i=Math.cos(n);t.m00=i;t.m01=r;t.m02=-r;t.m03=i;return t};Ut.fromScaling=function e(t,n){t.m00=n.x;t.m01=0;t.m02=0;t.m03=n.y;return t};Ut.str=function e(t){return"mat2("+t.m00+", "+t.m01+", "+t.m02+", "+t.m03+")"};Ut.array=function e(t,n){t[0]=n.m00;t[1]=n.m01;t[2]=n.m02;t[3]=n.m03;return t};Ut.frob=function e(t){return Math.sqrt(Math.pow(t.m00,2)+Math.pow(t.m01,2)+Math.pow(t.m02,2)+Math.pow(t.m03,2))};Ut.LDU=function e(t,n,r,i){t.m02=i.m02/i.m00;r.m00=i.m00;r.m01=i.m01;r.m03=i.m03-t.m02*r.m01};Ut.add=function e(t,n,r){t.m00=n.m00+r.m00;t.m01=n.m01+r.m01;t.m02=n.m02+r.m02;t.m03=n.m03+r.m03;return t};Ut.subtract=function e(t,n,r){t.m00=n.m00-r.m00;t.m01=n.m01-r.m01;t.m02=n.m02-r.m02;t.m03=n.m03-r.m03;return t};Ut.sub=function e(t,n,r){return Ut.subtract(t,n,r)};Ut.exactEquals=function e(t,n){return t.m00===n.m00&&t.m01===n.m01&&t.m02===n.m02&&t.m03===n.m03};Ut.equals=function e(t,n){var r=t.m00,i=t.m01,a=t.m02,o=t.m03;var s=n.m00,l=n.m01,u=n.m02,h=n.m03;return Math.abs(r-s)<=Ve*Math.max(1,Math.abs(r),Math.abs(s))&&Math.abs(i-l)<=Ve*Math.max(1,Math.abs(i),Math.abs(l))&&Math.abs(a-u)<=Ve*Math.max(1,Math.abs(a),Math.abs(u))&&Math.abs(o-h)<=Ve*Math.max(1,Math.abs(o),Math.abs(h))};Ut.multiplyScalar=function e(t,n,r){t.m00=n.m00*r;t.m01=n.m01*r;t.m02=n.m02*r;t.m03=n.m03*r;return t};Ut.multiplyScalarAndAdd=function e(t,n,r,i){t.m00=n.m00+r.m00*i;t.m01=n.m01+r.m01*i;t.m02=n.m02+r.m02*i;t.m03=n.m03+r.m03*i;return t};var Pt=function e(t,n,r,i,a,o){this.m00=t;this.m01=n;this.m02=r;this.m03=i;this.m04=a;this.m05=o};Pt.create=function e(){return new Pt(1,0,0,1,0,0)};Pt.new=function e(t,n,r,i,a,o){return new Pt(t,n,r,i,a,o)};Pt.clone=function e(t){return new Pt(t.m00,t.m01,t.m02,t.m03,t.m04,t.m05)};Pt.copy=function e(t,n){t.m00=n.m00;t.m01=n.m01;t.m02=n.m02;t.m03=n.m03;t.m04=n.m04;t.m05=n.m05;return t};Pt.identity=function e(t){t.m00=1;t.m01=0;t.m02=0;t.m03=1;t.m04=0;t.m05=0;return t};Pt.set=function e(t,n,r,i,a,o,s){t.m00=n;t.m01=r;t.m02=i;t.m03=a;t.m04=o;t.m05=s;return t};Pt.invert=function e(t,n){var r=n.m00,i=n.m01,a=n.m02,o=n.m03,s=n.m04,l=n.m05;var u=r*o-i*a;if(!u){return null}u=1/u;t.m00=o*u;t.m01=-i*u;t.m02=-a*u;t.m03=r*u;t.m04=(a*l-o*s)*u;t.m05=(i*s-r*l)*u;return t};Pt.determinant=function e(t){return t.m00*t.m03-t.m01*t.m02};Pt.multiply=function e(t,n,r){var i=n.m00,a=n.m01,o=n.m02,s=n.m03,l=n.m04,u=n.m05,h=r.m00,c=r.m01,f=r.m02,p=r.m03,d=r.m04,v=r.m05;t.m00=i*h+o*c;t.m01=a*h+s*c;t.m02=i*f+o*p;t.m03=a*f+s*p;t.m04=i*d+o*v+l;t.m05=a*d+s*v+u;return t};Pt.mul=function e(t,n,r){return Pt.multiply(t,n,r)};Pt.rotate=function e(t,n,r){var i=n.m00,a=n.m01,o=n.m02,s=n.m03,l=n.m04,u=n.m05,h=Math.sin(r),c=Math.cos(r);t.m00=i*c+o*h;t.m01=a*c+s*h;t.m02=i*-h+o*c;t.m03=a*-h+s*c;t.m04=l;t.m05=u;return t};Pt.scale=function e(t,n,r){var i=n.m00,a=n.m01,o=n.m02,s=n.m03,l=n.m04,u=n.m05,h=r.x,c=r.y;t.m00=i*h;t.m01=a*h;t.m02=o*c;t.m03=s*c;t.m04=l;t.m05=u;return t};Pt.translate=function e(t,n,r){var i=n.m00,a=n.m01,o=n.m02,s=n.m03,l=n.m04,u=n.m05,h=r.x,c=r.y;t.m00=i;t.m01=a;t.m02=o;t.m03=s;t.m04=i*h+o*c+l;t.m05=a*h+s*c+u;return t};Pt.fromRotation=function e(t,n){var r=Math.sin(n),i=Math.cos(n);t.m00=i;t.m01=r;t.m02=-r;t.m03=i;t.m04=0;t.m05=0;return t};Pt.fromScaling=function e(t,n){t.m00=n.m00;t.m01=0;t.m02=0;t.m03=n.m01;t.m04=0;t.m05=0;return t};Pt.fromTranslation=function e(t,n){t.m00=1;t.m01=0;t.m02=0;t.m03=1;t.m04=n.x;t.m05=n.y;return t};Pt.fromRTS=function e(t,n,r,i){var a=Math.sin(n),o=Math.cos(n);t.m00=o*i.x;t.m01=a*i.x;t.m02=-a*i.y;t.m03=o*i.y;t.m04=r.x;t.m05=r.y;return t};Pt.str=function e(t){return"mat23("+t.m00+", "+t.m01+", "+t.m02+", "+t.m03+", "+t.m04+", "+t.m05+")"};Pt.array=function e(t,n){t[0]=n.m00;t[1]=n.m01;t[2]=n.m02;t[3]=n.m03;t[4]=n.m04;t[5]=n.m05;return t};Pt.array4x4=function e(t,n){t[0]=n.m00;t[1]=n.m01;t[2]=0;t[3]=0;t[4]=n.m02;t[5]=n.m03;t[6]=0;t[7]=0;t[8]=0;t[9]=0;t[10]=1;t[11]=0;t[12]=n.m04;t[13]=n.m05;t[14]=0;t[15]=1;return t};Pt.frob=function e(t){return Math.sqrt(Math.pow(t.m00,2)+Math.pow(t.m01,2)+Math.pow(t.m02,2)+Math.pow(t.m03,2)+Math.pow(t.m04,2)+Math.pow(t.m05,2)+1)};Pt.add=function e(t,n,r){t.m00=n.m00+r.m00;t.m01=n.m01+r.m01;t.m02=n.m02+r.m02;t.m03=n.m03+r.m03;t.m04=n.m04+r.m04;t.m05=n.m05+r.m05;return t};Pt.subtract=function e(t,n,r){t.m00=n.m00-r.m00;t.m01=n.m01-r.m01;t.m02=n.m02-r.m02;t.m03=n.m03-r.m03;t.m04=n.m04-r.m04;t.m05=n.m05-r.m05;return t};Pt.sub=function e(t,n,r){return Pt.subtract(t,n,r)};Pt.multiplyScalar=function e(t,n,r){t.m00=n.m00*r;t.m01=n.m01*r;t.m02=n.m02*r;t.m03=n.m03*r;t.m04=n.m04*r;t.m05=n.m05*r;return t};Pt.multiplyScalarAndAdd=function e(t,n,r,i){t.m00=n.m00+r.m00*i;t.m01=n.m01+r.m01*i;t.m02=n.m02+r.m02*i;t.m03=n.m03+r.m03*i;t.m04=n.m04+r.m04*i;t.m05=n.m05+r.m05*i;return t};Pt.exactEquals=function e(t,n){return t.m00===n.m00&&t.m01===n.m01&&t.m02===n.m02&&t.m03===n.m03&&t.m04===n.m04&&t.m05===n.m05};Pt.equals=function e(t,n){var r=t.m00,i=t.m01,a=t.m02,o=t.m03,s=t.m04,l=t.m05;var u=n.m00,h=n.m01,c=n.m02,f=n.m03,p=n.m04,d=n.m05;return Math.abs(r-u)<=Ve*Math.max(1,Math.abs(r),Math.abs(u))&&Math.abs(i-h)<=Ve*Math.max(1,Math.abs(i),Math.abs(h))&&Math.abs(a-c)<=Ve*Math.max(1,Math.abs(a),Math.abs(c))&&Math.abs(o-f)<=Ve*Math.max(1,Math.abs(o),Math.abs(f))&&Math.abs(s-p)<=Ve*Math.max(1,Math.abs(s),Math.abs(p))&&Math.abs(l-d)<=Ve*Math.max(1,Math.abs(l),Math.abs(d))};var Bt=function e(t,n,r,i,a,o,s,l,u,h,c,f,p,d,v,m){this.m00=t;this.m01=n;this.m02=r;this.m03=i;this.m04=a;this.m05=o;this.m06=s;this.m07=l;this.m08=u;this.m09=h;this.m10=c;this.m11=f;this.m12=p;this.m13=d;this.m14=v;this.m15=m};Bt.new=function e(t,n,r,i,a,o,s,l,u,h,c,f,p,d,v,m){return new Bt(t,n,r,i,a,o,s,l,u,h,c,f,p,d,v,m)};Bt.create=function e(){return new Bt(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1)};Bt.clone=function e(t){return new Bt(t.m00,t.m01,t.m02,t.m03,t.m04,t.m05,t.m06,t.m07,t.m08,t.m09,t.m10,t.m11,t.m12,t.m13,t.m14,t.m15)};Bt.copy=function e(t,n){t.m00=n.m00;t.m01=n.m01;t.m02=n.m02;t.m03=n.m03;t.m04=n.m04;t.m05=n.m05;t.m06=n.m06;t.m07=n.m07;t.m08=n.m08;t.m09=n.m09;t.m10=n.m10;t.m11=n.m11;t.m12=n.m12;t.m13=n.m13;t.m14=n.m14;t.m15=n.m15;return t};Bt.set=function e(t,n,r,i,a,o,s,l,u,h,c,f,p,d,v,m,_){t.m00=n;t.m01=r;t.m02=i;t.m03=a;t.m04=o;t.m05=s;t.m06=l;t.m07=u;t.m08=h;t.m09=c;t.m10=f;t.m11=p;t.m12=d;t.m13=v;t.m14=m;t.m15=_;return t};Bt.identity=function e(t){t.m00=1;t.m01=0;t.m02=0;t.m03=0;t.m04=0;t.m05=1;t.m06=0;t.m07=0;t.m08=0;t.m09=0;t.m10=1;t.m11=0;t.m12=0;t.m13=0;t.m14=0;t.m15=1;return t};Bt.transpose=function e(t,n){if(t===n){var r=n.m01,i=n.m02,a=n.m03,o=n.m06,s=n.m07,l=n.m11;t.m01=n.m04;t.m02=n.m08;t.m03=n.m12;t.m04=r;t.m06=n.m09;t.m07=n.m13;t.m08=i;t.m09=o;t.m11=n.m14;t.m12=a;t.m13=s;t.m14=l}else{t.m00=n.m00;t.m01=n.m04;t.m02=n.m08;t.m03=n.m12;t.m04=n.m01;t.m05=n.m05;t.m06=n.m09;t.m07=n.m13;t.m08=n.m02;t.m09=n.m06;t.m10=n.m10;t.m11=n.m14;t.m12=n.m03;t.m13=n.m07;t.m14=n.m11;t.m15=n.m15}return t};Bt.invert=function e(t,n){var r=n.m00,i=n.m01,a=n.m02,o=n.m03,s=n.m04,l=n.m05,u=n.m06,h=n.m07,c=n.m08,f=n.m09,p=n.m10,d=n.m11,v=n.m12,m=n.m13,_=n.m14,g=n.m15;var y=r*l-i*s;var x=r*u-a*s;var b=r*h-o*s;var w=i*u-a*l;var E=i*h-o*l;var T=a*h-o*u;var S=c*m-f*v;var A=c*_-p*v;var M=c*g-d*v;var R=f*_-p*m;var L=f*g-d*m;var C=p*g-d*_;var O=y*C-x*L+b*R+w*M-E*A+T*S;if(!O){return null}O=1/O;t.m00=(l*C-u*L+h*R)*O;t.m01=(a*L-i*C-o*R)*O;t.m02=(m*T-_*E+g*w)*O;t.m03=(p*E-f*T-d*w)*O;t.m04=(u*M-s*C-h*A)*O;t.m05=(r*C-a*M+o*A)*O;t.m06=(_*b-v*T-g*x)*O;t.m07=(c*T-p*b+d*x)*O;t.m08=(s*L-l*M+h*S)*O;t.m09=(i*M-r*L-o*S)*O;t.m10=(v*E-m*b+g*y)*O;t.m11=(f*b-c*E-d*y)*O;t.m12=(l*A-s*R-u*S)*O;t.m13=(r*R-i*A+a*S)*O;t.m14=(m*x-v*w-_*y)*O;t.m15=(c*w-f*x+p*y)*O;return t};Bt.adjoint=function e(t,n){var r=n.m00,i=n.m01,a=n.m02,o=n.m03,s=n.m04,l=n.m05,u=n.m06,h=n.m07,c=n.m08,f=n.m09,p=n.m10,d=n.m11,v=n.m12,m=n.m13,_=n.m14,g=n.m15;t.m00=l*(p*g-d*_)-f*(u*g-h*_)+m*(u*d-h*p);t.m01=-(i*(p*g-d*_)-f*(a*g-o*_)+m*(a*d-o*p));t.m02=i*(u*g-h*_)-l*(a*g-o*_)+m*(a*h-o*u);t.m03=-(i*(u*d-h*p)-l*(a*d-o*p)+f*(a*h-o*u));t.m04=-(s*(p*g-d*_)-c*(u*g-h*_)+v*(u*d-h*p));t.m05=r*(p*g-d*_)-c*(a*g-o*_)+v*(a*d-o*p);t.m06=-(r*(u*g-h*_)-s*(a*g-o*_)+v*(a*h-o*u));t.m07=r*(u*d-h*p)-s*(a*d-o*p)+c*(a*h-o*u);t.m08=s*(f*g-d*m)-c*(l*g-h*m)+v*(l*d-h*f);t.m09=-(r*(f*g-d*m)-c*(i*g-o*m)+v*(i*d-o*f));t.m10=r*(l*g-h*m)-s*(i*g-o*m)+v*(i*h-o*l);t.m11=-(r*(l*d-h*f)-s*(i*d-o*f)+c*(i*h-o*l));t.m12=-(s*(f*_-p*m)-c*(l*_-u*m)+v*(l*p-u*f));t.m13=r*(f*_-p*m)-c*(i*_-a*m)+v*(i*p-a*f);t.m14=-(r*(l*_-u*m)-s*(i*_-a*m)+v*(i*u-a*l));t.m15=r*(l*p-u*f)-s*(i*p-a*f)+c*(i*u-a*l);return t};Bt.determinant=function e(t){var n=t.m00,r=t.m01,i=t.m02,a=t.m03,o=t.m04,s=t.m05,l=t.m06,u=t.m07,h=t.m08,c=t.m09,f=t.m10,p=t.m11,d=t.m12,v=t.m13,m=t.m14,_=t.m15;var g=n*s-r*o;var y=n*l-i*o;var x=n*u-a*o;var b=r*l-i*s;var w=r*u-a*s;var E=i*u-a*l;var T=h*v-c*d;var S=h*m-f*d;var A=h*_-p*d;var M=c*m-f*v;var R=c*_-p*v;var L=f*_-p*m;return g*L-y*R+x*M+b*A-w*S+E*T};Bt.multiply=function e(t,n,r){var i=n.m00,a=n.m01,o=n.m02,s=n.m03,l=n.m04,u=n.m05,h=n.m06,c=n.m07,f=n.m08,p=n.m09,d=n.m10,v=n.m11,m=n.m12,_=n.m13,g=n.m14,y=n.m15;var x=r.m00,b=r.m01,w=r.m02,E=r.m03;t.m00=x*i+b*l+w*f+E*m;t.m01=x*a+b*u+w*p+E*_;t.m02=x*o+b*h+w*d+E*g;t.m03=x*s+b*c+w*v+E*y;x=r.m04;b=r.m05;w=r.m06;E=r.m07;t.m04=x*i+b*l+w*f+E*m;t.m05=x*a+b*u+w*p+E*_;t.m06=x*o+b*h+w*d+E*g;t.m07=x*s+b*c+w*v+E*y;x=r.m08;b=r.m09;w=r.m10;E=r.m11;t.m08=x*i+b*l+w*f+E*m;t.m09=x*a+b*u+w*p+E*_;t.m10=x*o+b*h+w*d+E*g;t.m11=x*s+b*c+w*v+E*y;x=r.m12;b=r.m13;w=r.m14;E=r.m15;t.m12=x*i+b*l+w*f+E*m;t.m13=x*a+b*u+w*p+E*_;t.m14=x*o+b*h+w*d+E*g;t.m15=x*s+b*c+w*v+E*y;return t};Bt.mul=function e(t,n,r){return Bt.multiply(t,n,r)};Bt.translate=function e(t,n,r){var i=r.x,a=r.y,o=r.z,s,l,u,h,c,f,p,d,v,m,_,g;if(n===t){t.m12=n.m00*i+n.m04*a+n.m08*o+n.m12;t.m13=n.m01*i+n.m05*a+n.m09*o+n.m13;t.m14=n.m02*i+n.m06*a+n.m10*o+n.m14;t.m15=n.m03*i+n.m07*a+n.m11*o+n.m15}else{s=n.m00;l=n.m01;u=n.m02;h=n.m03;c=n.m04;f=n.m05;p=n.m06;d=n.m07;v=n.m08;m=n.m09;_=n.m10;g=n.m11;t.m00=s;t.m01=l;t.m02=u;t.m03=h;t.m04=c;t.m05=f;t.m06=p;t.m07=d;t.m08=v;t.m09=m;t.m10=_;t.m11=g;t.m12=s*i+c*a+v*o+n.m12;t.m13=l*i+f*a+m*o+n.m13;t.m14=u*i+p*a+_*o+n.m14;t.m15=h*i+d*a+g*o+n.m15}return t};Bt.scale=function e(t,n,r){var i=r.x,a=r.y,o=r.z;t.m00=n.m00*i;t.m01=n.m01*i;t.m02=n.m02*i;t.m03=n.m03*i;t.m04=n.m04*a;t.m05=n.m05*a;t.m06=n.m06*a;t.m07=n.m07*a;t.m08=n.m08*o;t.m09=n.m09*o;t.m10=n.m10*o;t.m11=n.m11*o;t.m12=n.m12;t.m13=n.m13;t.m14=n.m14;t.m15=n.m15;return t};Bt.rotate=function e(t,n,r,i){var a=i.x,o=i.y,s=i.z;var l,u,h,c,f,p,d,v,m,_,g,y,x,b,w,E,T,S,A,M,R,L,C,O;var I=Math.sqrt(a*a+o*o+s*s);if(Math.abs(I)<Ve){return null}I=1/I;a*=I;o*=I;s*=I;l=Math.sin(r);u=Math.cos(r);h=1-u;c=n.m00;f=n.m01;p=n.m02;d=n.m03;v=n.m04;m=n.m05;_=n.m06;g=n.m07;y=n.m08;x=n.m09;b=n.m10;w=n.m11;E=a*a*h+u;T=o*a*h+s*l;S=s*a*h-o*l;A=a*o*h-s*l;M=o*o*h+u;R=s*o*h+a*l;L=a*s*h+o*l;C=o*s*h-a*l;O=s*s*h+u;t.m00=c*E+v*T+y*S;t.m01=f*E+m*T+x*S;t.m02=p*E+_*T+b*S;t.m03=d*E+g*T+w*S;t.m04=c*A+v*M+y*R;t.m05=f*A+m*M+x*R;t.m06=p*A+_*M+b*R;t.m07=d*A+g*M+w*R;t.m08=c*L+v*C+y*O;t.m09=f*L+m*C+x*O;t.m10=p*L+_*C+b*O;t.m11=d*L+g*C+w*O;if(n!==t){t.m12=n.m12;t.m13=n.m13;t.m14=n.m14;t.m15=n.m15}return t};Bt.rotateX=function e(t,n,r){var i=Math.sin(r),a=Math.cos(r),o=n.m04,s=n.m05,l=n.m06,u=n.m07,h=n.m08,c=n.m09,f=n.m10,p=n.m11;if(n!==t){t.m00=n.m00;t.m01=n.m01;t.m02=n.m02;t.m03=n.m03;t.m12=n.m12;t.m13=n.m13;t.m14=n.m14;t.m15=n.m15}t.m04=o*a+h*i;t.m05=s*a+c*i;t.m06=l*a+f*i;t.m07=u*a+p*i;t.m08=h*a-o*i;t.m09=c*a-s*i;t.m10=f*a-l*i;t.m11=p*a-u*i;return t};Bt.rotateY=function e(t,n,r){var i=Math.sin(r),a=Math.cos(r),o=n.m00,s=n.m01,l=n.m02,u=n.m03,h=n.m08,c=n.m09,f=n.m10,p=n.m11;if(n!==t){t.m04=n.m04;t.m05=n.m05;t.m06=n.m06;t.m07=n.m07;t.m12=n.m12;t.m13=n.m13;t.m14=n.m14;t.m15=n.m15}t.m00=o*a-h*i;t.m01=s*a-c*i;t.m02=l*a-f*i;t.m03=u*a-p*i;t.m08=o*i+h*a;t.m09=s*i+c*a;t.m10=l*i+f*a;t.m11=u*i+p*a;return t};Bt.rotateZ=function e(t,n,r){var i=Math.sin(r),a=Math.cos(r),o=n.m00,s=n.m01,l=n.m02,u=n.m03,h=n.m04,c=n.m05,f=n.m06,p=n.m07;if(n!==t){t.m08=n.m08;t.m09=n.m09;t.m10=n.m10;t.m11=n.m11;t.m12=n.m12;t.m13=n.m13;t.m14=n.m14;t.m15=n.m15}t.m00=o*a+h*i;t.m01=s*a+c*i;t.m02=l*a+f*i;t.m03=u*a+p*i;t.m04=h*a-o*i;t.m05=c*a-s*i;t.m06=f*a-l*i;t.m07=p*a-u*i;return t};Bt.fromTranslation=function e(t,n){t.m00=1;t.m01=0;t.m02=0;t.m03=0;t.m04=0;t.m05=1;t.m06=0;t.m07=0;t.m08=0;t.m09=0;t.m10=1;t.m11=0;t.m12=n.x;t.m13=n.y;t.m14=n.z;t.m15=1;return t};Bt.fromScaling=function e(t,n){t.m00=n.x;t.m01=0;t.m02=0;t.m03=0;t.m04=0;t.m05=n.y;t.m06=0;t.m07=0;t.m08=0;t.m09=0;t.m10=n.z;t.m11=0;t.m12=0;t.m13=0;t.m14=0;t.m15=1;return t};Bt.fromRotation=function e(t,n,r){var i=r.x,a=r.y,o=r.z;var s=Math.sqrt(i*i+a*a+o*o);var l,u,h;if(Math.abs(s)<Ve){return null}s=1/s;i*=s;a*=s;o*=s;l=Math.sin(n);u=Math.cos(n);h=1-u;t.m00=i*i*h+u;t.m01=a*i*h+o*l;t.m02=o*i*h-a*l;t.m03=0;t.m04=i*a*h-o*l;t.m05=a*a*h+u;t.m06=o*a*h+i*l;t.m07=0;t.m08=i*o*h+a*l;t.m09=a*o*h-i*l;t.m10=o*o*h+u;t.m11=0;t.m12=0;t.m13=0;t.m14=0;t.m15=1;return t};Bt.fromXRotation=function e(t,n){var r=Math.sin(n),i=Math.cos(n);t.m00=1;t.m01=0;t.m02=0;t.m03=0;t.m04=0;t.m05=i;t.m06=r;t.m07=0;t.m08=0;t.m09=-r;t.m10=i;t.m11=0;t.m12=0;t.m13=0;t.m14=0;t.m15=1;return t};Bt.fromYRotation=function e(t,n){var r=Math.sin(n),i=Math.cos(n);t.m00=i;t.m01=0;t.m02=-r;t.m03=0;t.m04=0;t.m05=1;t.m06=0;t.m07=0;t.m08=r;t.m09=0;t.m10=i;t.m11=0;t.m12=0;t.m13=0;t.m14=0;t.m15=1;return t};Bt.fromZRotation=function e(t,n){var r=Math.sin(n),i=Math.cos(n);t.m00=i;t.m01=r;t.m02=0;t.m03=0;t.m04=-r;t.m05=i;t.m06=0;t.m07=0;t.m08=0;t.m09=0;t.m10=1;t.m11=0;t.m12=0;t.m13=0;t.m14=0;t.m15=1;return t};Bt.fromRT=function e(t,n,r){var i=n.x,a=n.y,o=n.z,s=n.w;var l=i+i;var u=a+a;var h=o+o;var c=i*l;var f=i*u;var p=i*h;var d=a*u;var v=a*h;var m=o*h;var _=s*l;var g=s*u;var y=s*h;t.m00=1-(d+m);t.m01=f+y;t.m02=p-g;t.m03=0;t.m04=f-y;t.m05=1-(c+m);t.m06=v+_;t.m07=0;t.m08=p+g;t.m09=v-_;t.m10=1-(c+d);t.m11=0;t.m12=r.x;t.m13=r.y;t.m14=r.z;t.m15=1;return t};Bt.getTranslation=function e(t,n){t.x=n.m12;t.y=n.m13;t.z=n.m14;return t};Bt.getScaling=function e(t,n){var r=n.m00,i=n.m01,a=n.m02,o=n.m04,s=n.m05,l=n.m06,u=n.m08,h=n.m09,c=n.m10;t.x=Math.sqrt(r*r+i*i+a*a);t.y=Math.sqrt(o*o+s*s+l*l);t.z=Math.sqrt(u*u+h*h+c*c);return t};Bt.getRotation=function e(t,n){var r=n.m00+n.m05+n.m10;var i=0;if(r>0){i=Math.sqrt(r+1)*2;t.w=.25*i;t.x=(n.m06-n.m09)/i;t.y=(n.m08-n.m02)/i;t.z=(n.m01-n.m04)/i}else if(n.m00>n.m05&n.m00>n.m10){i=Math.sqrt(1+n.m00-n.m05-n.m10)*2;t.w=(n.m06-n.m09)/i;t.x=.25*i;t.y=(n.m01+n.m04)/i;t.z=(n.m08+n.m02)/i}else if(n.m05>n.m10){i=Math.sqrt(1+n.m05-n.m00-n.m10)*2;t.w=(n.m08-n.m02)/i;t.x=(n.m01+n.m04)/i;t.y=.25*i;t.z=(n.m06+n.m09)/i}else{i=Math.sqrt(1+n.m10-n.m00-n.m05)*2;t.w=(n.m01-n.m04)/i;t.x=(n.m08+n.m02)/i;t.y=(n.m06+n.m09)/i;t.z=.25*i}return t};Bt.fromRTS=function e(t,n,r,i){var a=n.x,o=n.y,s=n.z,l=n.w;var u=a+a;var h=o+o;var c=s+s;var f=a*u;var p=a*h;var d=a*c;var v=o*h;var m=o*c;var _=s*c;var g=l*u;var y=l*h;var x=l*c;var b=i.x;var w=i.y;var E=i.z;t.m00=(1-(v+_))*b;t.m01=(p+x)*b;t.m02=(d-y)*b;t.m03=0;t.m04=(p-x)*w;t.m05=(1-(f+_))*w;t.m06=(m+g)*w;t.m07=0;t.m08=(d+y)*E;t.m09=(m-g)*E;t.m10=(1-(f+v))*E;t.m11=0;t.m12=r.x;t.m13=r.y;t.m14=r.z;t.m15=1;return t};Bt.fromRTSOrigin=function e(t,n,r,i,a){var o=n.x,s=n.y,l=n.z,u=n.w;var h=o+o;var c=s+s;var f=l+l;var p=o*h;var d=o*c;var v=o*f;var m=s*c;var _=s*f;var g=l*f;var y=u*h;var x=u*c;var b=u*f;var w=i.x;var E=i.y;var T=i.z;var S=a.x;var A=a.y;var M=a.z;t.m00=(1-(m+g))*w;t.m01=(d+b)*w;t.m02=(v-x)*w;t.m03=0;t.m04=(d-b)*E;t.m05=(1-(p+g))*E;t.m06=(_+y)*E;t.m07=0;t.m08=(v+x)*T;t.m09=(_-y)*T;t.m10=(1-(p+m))*T;t.m11=0;t.m12=r.x+S-(t.m00*S+t.m04*A+t.m08*M);t.m13=r.y+A-(t.m01*S+t.m05*A+t.m09*M);t.m14=r.z+M-(t.m02*S+t.m06*A+t.m10*M);t.m15=1;return t};Bt.fromQuat=function e(t,n){var r=n.x,i=n.y,a=n.z,o=n.w;var s=r+r;var l=i+i;var u=a+a;var h=r*s;var c=i*s;var f=i*l;var p=a*s;var d=a*l;var v=a*u;var m=o*s;var _=o*l;var g=o*u;t.m00=1-f-v;t.m01=c+g;t.m02=p-_;t.m03=0;t.m04=c-g;t.m05=1-h-v;t.m06=d+m;t.m07=0;t.m08=p+_;t.m09=d-m;t.m10=1-h-f;t.m11=0;t.m12=0;t.m13=0;t.m14=0;t.m15=1;return t};Bt.frustum=function e(t,n,r,i,a,o,s){var l=1/(r-n);var u=1/(a-i);var h=1/(o-s);t.m00=o*2*l;t.m01=0;t.m02=0;t.m03=0;t.m04=0;t.m05=o*2*u;t.m06=0;t.m07=0;t.m08=(r+n)*l;t.m09=(a+i)*u;t.m10=(s+o)*h;t.m11=-1;t.m12=0;t.m13=0;t.m14=s*o*2*h;t.m15=0;return t};Bt.perspective=function e(t,n,r,i,a){var o=1/Math.tan(n/2);var s=1/(i-a);t.m00=o/r;t.m01=0;t.m02=0;t.m03=0;t.m04=0;t.m05=o;t.m06=0;t.m07=0;t.m08=0;t.m09=0;t.m10=(a+i)*s;t.m11=-1;t.m12=0;t.m13=0;t.m14=2*a*i*s;t.m15=0;return t};Bt.perspectiveFromFieldOfView=function e(t,n,r,i){var a=Math.tan(n.upDegrees*Math.PI/180);var o=Math.tan(n.downDegrees*Math.PI/180);var s=Math.tan(n.leftDegrees*Math.PI/180);var l=Math.tan(n.rightDegrees*Math.PI/180);var u=2/(s+l);var h=2/(a+o);t.m00=u;t.m01=0;t.m02=0;t.m03=0;t.m04=0;t.m05=h;t.m06=0;t.m07=0;t.m08=-((s-l)*u*.5);t.m09=(a-o)*h*.5;t.m10=i/(r-i);t.m11=-1;t.m12=0;t.m13=0;t.m14=i*r/(r-i);t.m15=0;return t};Bt.ortho=function e(t,n,r,i,a,o,s){var l=1/(n-r);var u=1/(i-a);var h=1/(o-s);t.m00=-2*l;t.m01=0;t.m02=0;t.m03=0;t.m04=0;t.m05=-2*u;t.m06=0;t.m07=0;t.m08=0;t.m09=0;t.m10=2*h;t.m11=0;t.m12=(n+r)*l;t.m13=(a+i)*u;t.m14=(s+o)*h;t.m15=1;return t};Bt.lookAt=function e(t,n,r,i){var a,o,s,l,u,h,c,f,p,d;var v=n.x;var m=n.y;var _=n.z;var g=i.x;var y=i.y;var x=i.z;var b=r.x;var w=r.y;var E=r.z;c=v-b;f=m-w;p=_-E;d=1/Math.sqrt(c*c+f*f+p*p);c*=d;f*=d;p*=d;a=y*p-x*f;o=x*c-g*p;s=g*f-y*c;d=1/Math.sqrt(a*a+o*o+s*s);a*=d;o*=d;s*=d;l=f*s-p*o;u=p*a-c*s;h=c*o-f*a;t.m00=a;t.m01=l;t.m02=c;t.m03=0;t.m04=o;t.m05=u;t.m06=f;t.m07=0;t.m08=s;t.m09=h;t.m10=p;t.m11=0;t.m12=-(a*v+o*m+s*_);t.m13=-(l*v+u*m+h*_);t.m14=-(c*v+f*m+p*_);t.m15=1;return t};Bt.str=function e(t){return"mat4("+t.m00+", "+t.m01+", "+t.m02+", "+t.m03+", "+t.m04+", "+t.m05+", "+t.m06+", "+t.m07+", "+t.m08+", "+t.m09+", "+t.m10+", "+t.m11+", "+t.m12+", "+t.m13+", "+t.m14+", "+t.m15+")"};Bt.array=function e(t,n){t[0]=n.m00;t[1]=n.m01;t[2]=n.m02;t[3]=n.m03;t[4]=n.m04;t[5]=n.m05;t[6]=n.m06;t[7]=n.m07;t[8]=n.m08;t[9]=n.m09;t[10]=n.m10;t[11]=n.m11;t[12]=n.m12;t[13]=n.m13;t[14]=n.m14;t[15]=n.m15;return t};Bt.frob=function e(t){return Math.sqrt(Math.pow(t.m00,2)+Math.pow(t.m01,2)+Math.pow(t.m02,2)+Math.pow(t.m03,2)+Math.pow(t.m04,2)+Math.pow(t.m05,2)+Math.pow(t.m06,2)+Math.pow(t.m07,2)+Math.pow(t.m08,2)+Math.pow(t.m09,2)+Math.pow(t.m10,2)+Math.pow(t.m11,2)+Math.pow(t.m12,2)+Math.pow(t.m13,2)+Math.pow(t.m14,2)+Math.pow(t.m15,2))};Bt.add=function e(t,n,r){t.m00=n.m00+r.m00;t.m01=n.m01+r.m01;t.m02=n.m02+r.m02;t.m03=n.m03+r.m03;t.m04=n.m04+r.m04;t.m05=n.m05+r.m05;t.m06=n.m06+r.m06;t.m07=n.m07+r.m07;t.m08=n.m08+r.m08;t.m09=n.m09+r.m09;t.m10=n.m10+r.m10;t.m11=n.m11+r.m11;t.m12=n.m12+r.m12;t.m13=n.m13+r.m13;t.m14=n.m14+r.m14;t.m15=n.m15+r.m15;return t};Bt.subtract=function e(t,n,r){t.m00=n.m00-r.m00;t.m01=n.m01-r.m01;t.m02=n.m02-r.m02;t.m03=n.m03-r.m03;t.m04=n.m04-r.m04;t.m05=n.m05-r.m05;t.m06=n.m06-r.m06;t.m07=n.m07-r.m07;t.m08=n.m08-r.m08;t.m09=n.m09-r.m09;t.m10=n.m10-r.m10;t.m11=n.m11-r.m11;t.m12=n.m12-r.m12;t.m13=n.m13-r.m13;t.m14=n.m14-r.m14;t.m15=n.m15-r.m15;return t};Bt.sub=function e(t,n,r){return Bt.subtract(t,n,r)};Bt.multiplyScalar=function e(t,n,r){t.m00=n.m00*r;t.m01=n.m01*r;t.m02=n.m02*r;t.m03=n.m03*r;t.m04=n.m04*r;t.m05=n.m05*r;t.m06=n.m06*r;t.m07=n.m07*r;t.m08=n.m08*r;t.m09=n.m09*r;t.m10=n.m10*r;t.m11=n.m11*r;t.m12=n.m12*r;t.m13=n.m13*r;t.m14=n.m14*r;t.m15=n.m15*r;return t};Bt.multiplyScalarAndAdd=function e(t,n,r,i){t.m00=n.m00+r.m00*i;t.m01=n.m01+r.m01*i;t.m02=n.m02+r.m02*i;t.m03=n.m03+r.m03*i;t.m04=n.m04+r.m04*i;t.m05=n.m05+r.m05*i;t.m06=n.m06+r.m06*i;t.m07=n.m07+r.m07*i;t.m08=n.m08+r.m08*i;t.m09=n.m09+r.m09*i;t.m10=n.m10+r.m10*i;t.m11=n.m11+r.m11*i;t.m12=n.m12+r.m12*i;t.m13=n.m13+r.m13*i;t.m14=n.m14+r.m14*i;t.m15=n.m15+r.m15*i;return t};Bt.exactEquals=function e(t,n){return t.m00===n.m00&&t.m01===n.m01&&t.m02===n.m02&&t.m03===n.m03&&t.m04===n.m04&&t.m05===n.m05&&t.m06===n.m06&&t.m07===n.m07&&t.m08===n.m08&&t.m09===n.m09&&t.m10===n.m10&&t.m11===n.m11&&t.m12===n.m12&&t.m13===n.m13&&t.m14===n.m14&&t.m15===n.m15};Bt.equals=function e(t,n){var r=t.m00,i=t.m01,a=t.m02,o=t.m03,s=t.m04,l=t.m05,u=t.m06,h=t.m07,c=t.m08,f=t.m09,p=t.m10,d=t.m11,v=t.m12,m=t.m13,_=t.m14,g=t.m15;var y=n.m00,x=n.m01,b=n.m02,w=n.m03,E=n.m04,T=n.m05,S=n.m06,A=n.m07,M=n.m08,R=n.m09,L=n.m10,C=n.m11,O=n.m12,I=n.m13,U=n.m14,P=n.m15;return Math.abs(r-y)<=Ve*Math.max(1,Math.abs(r),Math.abs(y))&&Math.abs(i-x)<=Ve*Math.max(1,Math.abs(i),Math.abs(x))&&Math.abs(a-b)<=Ve*Math.max(1,Math.abs(a),Math.abs(b))&&Math.abs(o-w)<=Ve*Math.max(1,Math.abs(o),Math.abs(w))&&Math.abs(s-E)<=Ve*Math.max(1,Math.abs(s),Math.abs(E))&&Math.abs(l-T)<=Ve*Math.max(1,Math.abs(l),Math.abs(T))&&Math.abs(u-S)<=Ve*Math.max(1,Math.abs(u),Math.abs(S))&&Math.abs(h-A)<=Ve*Math.max(1,Math.abs(h),Math.abs(A))&&Math.abs(c-M)<=Ve*Math.max(1,Math.abs(c),Math.abs(M))&&Math.abs(f-R)<=Ve*Math.max(1,Math.abs(f),Math.abs(R))&&Math.abs(p-L)<=Ve*Math.max(1,Math.abs(p),Math.abs(L))&&Math.abs(d-C)<=Ve*Math.max(1,Math.abs(d),Math.abs(C))&&Math.abs(v-O)<=Ve*Math.max(1,Math.abs(v),Math.abs(O))&&Math.abs(m-I)<=Ve*Math.max(1,Math.abs(m),Math.abs(I))&&Math.abs(_-U)<=Ve*Math.max(1,Math.abs(_),Math.abs(U))&&Math.abs(g-P)<=Ve*Math.max(1,Math.abs(g),Math.abs(P))};var Dt=function e(t,n,r){this.r=t;this.g=n;this.b=r};Dt.new=function e(t,n,r){return new Dt(t,n,r)};Dt.create=function e(){return new Dt(1,1,1)};Dt.clone=function e(t){return new Dt(t.r,t.g,t.b)};Dt.copy=function e(t,n){t.r=n.r;t.g=n.g;t.b=n.b;return t};Dt.set=function e(t,n,r,i){t.r=n;t.g=r;t.b=i;return t};Dt.fromHex=function e(t,n){var r=(n>>16)/255;var i=(n>>8&255)/255;var a=(n&255)/255;t.r=r;t.g=i;t.b=a;return t};Dt.add=function e(t,n,r){t.r=n.r+r.r;t.g=n.g+r.g;t.b=n.b+r.b;return t};Dt.subtract=function e(t,n,r){t.r=n.r-r.r;t.g=n.g-r.g;t.b=n.b-r.b;return t};Dt.sub=function e(t,n,r){return Dt.subtract(t,n,r)};Dt.multiply=function e(t,n,r){t.r=n.r*r.r;t.g=n.g*r.g;t.b=n.b*r.b;return t};Dt.mul=function e(t,n,r){return Dt.multiply(t,n,r)};Dt.divide=function e(t,n,r){t.r=n.r/r.r;t.g=n.g/r.g;t.b=n.b/r.b;return t};Dt.div=function e(t,n,r){return Dt.divide(t,n,r)};Dt.scale=function e(t,n,r){t.r=n.r*r;t.g=n.g*r;t.b=n.b*r;return t};Dt.lerp=function e(t,n,r,i){var a=n.r,o=n.g,s=n.b;t.r=a+i*(r.r-a);t.g=o+i*(r.g-o);t.b=s+i*(r.b-s);return t};Dt.str=function e(t){return"color3("+t.r+", "+t.g+", "+t.b+")"};Dt.array=function e(t,n){t[0]=n.r;t[1]=n.g;t[2]=n.b;return t};Dt.exactEquals=function e(t,n){return t.r===n.r&&t.g===n.g&&t.b===n.b};Dt.equals=function e(t,n){var r=t.r,i=t.g,a=t.b;var o=n.r,s=n.g,l=n.b;return Math.abs(r-o)<=Ve*Math.max(1,Math.abs(r),Math.abs(o))&&Math.abs(i-s)<=Ve*Math.max(1,Math.abs(i),Math.abs(s))&&Math.abs(a-l)<=Ve*Math.max(1,Math.abs(a),Math.abs(l))};Dt.hex=function e(t){return t.r*255<<16|t.g*255<<8|t.b*255};var Ft=function e(t,n,r,i){this.r=t;this.g=n;this.b=r;this.a=i};Ft.new=function e(t,n,r,i){return new Ft(t,n,r,i)};Ft.create=function e(){return new Ft(1,1,1,1)};Ft.clone=function e(t){return new Ft(t.r,t.g,t.b,t.a)};Ft.copy=function e(t,n){t.r=n.r;t.g=n.g;t.b=n.b;t.a=n.a;return t};Ft.set=function e(t,n,r,i,a){t.r=n;t.g=r;t.b=i;t.a=a;return t};Ft.fromHex=function e(t,n){var r=(n>>24)/255;var i=(n>>16&255)/255;var a=(n>>8&255)/255;var o=(n&255)/255;t.r=r;t.g=i;t.b=a;t.a=o;return t};Ft.add=function e(t,n,r){t.r=n.r+r.r;t.g=n.g+r.g;t.b=n.b+r.b;t.a=n.a+r.a;return t};Ft.subtract=function e(t,n,r){t.r=n.r-r.r;t.g=n.g-r.g;t.b=n.b-r.b;t.a=n.a-r.a;return t};Ft.sub=function e(t,n,r){return Ft.subtract(t,n,r)};Ft.multiply=function e(t,n,r){t.r=n.r*r.r;t.g=n.g*r.g;t.b=n.b*r.b;t.a=n.a*r.a;return t};Ft.mul=function e(t,n,r){return Ft.multiply(t,n,r)};Ft.divide=function e(t,n,r){t.r=n.r/r.r;t.g=n.g/r.g;t.b=n.b/r.b;t.a=n.a/r.a;return t};Ft.div=function e(t,n,r){return Ft.divide(t,n,r)};Ft.scale=function e(t,n,r){t.r=n.r*r;t.g=n.g*r;t.b=n.b*r;t.a=n.a*r;return t};Ft.lerp=function e(t,n,r,i){var a=n.r,o=n.g,s=n.b,l=n.a;t.r=a+i*(r.r-a);t.g=o+i*(r.g-o);t.b=s+i*(r.b-s);t.a=l+i*(r.a-l);return t};Ft.str=function e(t){return"color4("+t.r+", "+t.g+", "+t.b+", "+t.a+")"};Ft.array=function e(t,n){t[0]=n.r;t[1]=n.g;t[2]=n.b;t[3]=n.a;return t};Ft.exactEquals=function e(t,n){return t.r===n.r&&t.g===n.g&&t.b===n.b&&t.a===n.a};Ft.equals=function e(t,n){var r=t.r,i=t.g,a=t.b,o=t.a;var s=n.r,l=n.g,u=n.b,h=n.a;return Math.abs(r-s)<=Ve*Math.max(1,Math.abs(r),Math.abs(s))&&Math.abs(i-l)<=Ve*Math.max(1,Math.abs(i),Math.abs(l))&&Math.abs(a-u)<=Ve*Math.max(1,Math.abs(a),Math.abs(u))&&Math.abs(o-h)<=Ve*Math.max(1,Math.abs(o),Math.abs(h))};Ft.hex=function e(t){return(t.r*255<<24|t.g*255<<16|t.b*255<<8|t.a*255)>>>0};var zt=Mt;var Nt=Object.freeze({bits:zt,vec2:Rt,vec3:Lt,vec4:Ct,quat:It,mat2:Ut,mat23:Pt,mat3:Ot,mat4:Bt,color3:Dt,color4:Ft,EPSILON:Ve,equals:We,approx:Ge,clamp:He,clamp01:je,lerp:qe,toRadian:Xe,toDegree:Ye,random:Ke,randomRange:Ze,randomRangeInt:Qe,pseudoRandom:Je,pseudoRandomRange:$e,pseudoRandomRangeInt:et,nextPow2:tt,repeat:nt,pingPong:rt,inverseLerp:it});var kt={SHAPE_RAY:1,SHAPE_LINE:2,SHAPE_SPHERE:4,SHAPE_BOX:8,SHAPE_PLANE:16,SHAPE_TRIANGLE:32,SHAPE_FRUSTUM:64,SHAPE_FRUSTUM_ACCURATE:128};function Vt(e,t){return Lt.dot(t.n,e)-t.d}function Wt(e,t,n){var r=Vt(t,n);return Lt.sub(e,t,Lt.scale(e,n.n,r))}var Gt={point_plane:Vt,pt_point_plane:Wt};var Ht=function(){var a=Lt.zero();return function(e,t,n){Gt.pt_point_plane(a,e.o,t);var r=Lt.dot(a,t.n)/Lt.dot(e.d,t.n);var i=r>=0;if(n&&i){Lt.scale(n,e.d,r);Lt.add(n,n,e.o)}return i}}();var jt=function(){var a=Lt.zero();return function(e,t,n){Lt.sub(a,e.e,e.s);var r=(t.d-Lt.dot(e.s,t.n))/Lt.dot(a,t.n);var i=r>=0&&r<=1;if(n&&i){Lt.scale(n,a,r);Lt.add(n,n,e.s)}return i}}();var qt=function(){var s=Lt.zero();var l=Lt.zero();var u=Lt.zero();var h=Lt.zero();var c=Lt.zero();return function(e,t,n){Lt.sub(s,t.b,t.a);Lt.sub(l,t.c,t.a);Lt.cross(u,e.d,l);var r=Lt.dot(s,u);if(r<=0){return false}Lt.sub(h,e.o,t.a);var i=Lt.dot(h,u);if(i<0||i>r){return false}Lt.cross(c,h,s);var a=Lt.dot(e.d,c);if(a<0||i+a>r){return false}if(n){var o=Lt.dot(l,c)/r;Lt.scaleAndAdd(n,e.o,e.d,o)}return true}}();var Xt=function(){var u=Lt.zero();var h=Lt.zero();var c=Lt.zero();var f=Lt.zero();var p=Lt.zero();var d=Lt.zero();return function(e,t,n){Lt.sub(u,t.b,t.a);Lt.sub(h,t.c,t.a);Lt.sub(c,e.s,e.e);Lt.cross(p,u,h);var r=Lt.dot(c,p);if(r<=0){return false}Lt.sub(f,e.s,t.a);var i=Lt.dot(f,p);if(i<0||i>r){return false}Lt.cross(d,c,f);var a=Lt.dot(h,d);if(a<0||a>r){return false}var o=-Lt.dot(u,d);if(o<0||a+o>r){return false}if(n){var s=1/r;a*=s;o*=s;var l=1-a-o;Lt.set(n,t.a.x*l+t.b.x*a+t.c.x*o,t.a.y*l+t.b.y*a+t.c.y*o,t.a.z*l+t.b.z*a+t.c.z*o)}return true}}();var Yt=function(){var d=Lt.zero();var v=Lt.zero();var m=Lt.zero();var _=Lt.zero();var g=Lt.zero();var y=Lt.zero();var x=Lt.zero();return function(e,t,n,r,i,a,o){Lt.sub(d,t,e);Lt.sub(v,n,e);Lt.sub(m,r,e);Lt.sub(_,i,e);Lt.cross(y,_,d);var s=Lt.dot(v,y);if(s>=0){var l=-Lt.dot(m,y);if(l<0){return false}var u=Lt.dot(Lt.cross(x,d,m),v);if(u<0){return false}if(o){var h=1/(l+s+u);l*=h;s*=h;u*=h;Lt.set(o,n.x*l+r.x*s+i.x*u,n.y*l+r.y*s+i.y*u,n.z*l+r.z*s+i.z*u)}}else{Lt.sub(g,a,e);var c=Lt.dot(g,y);if(c<0){return false}var f=Lt.dot(Lt.cross(x,d,v),g);if(f<0){return false}if(o){s=-s;var p=1/(c+s+f);c*=p;s*=p;f*=p;Lt.set(o,n.x*c+a.x*s+i.x*f,n.y*c+a.y*s+i.y*f,n.z*c+a.z*s+i.z*f)}}return true}}();var Kt=function(){var l=Lt.zero();var u=Lt.zero();var h=Lt.zero();var c=Lt.zero();return function(e,t,n){var r=t.r;u=t.c;h=e.o;c=e.d;Lt.sub(l,u,h);var i=Lt.magnitude(l);var a=Lt.dot(l,c)/Lt.magnitude(c);var o=Math.sqrt(t.r*t.r-(i*i-a*a));var s=a-o;if(o<0||s<0||i<t.r){return false}if(n){Lt.scale(n,l,(i-r)/i)}return true}}();var Zt=function(){var o=Lt.zero();var s=Lt.zero();var l=Lt.zero();var u=Lt.zero();var h=Lt.zero();var c=Lt.zero();var f=Lt.zero();var p=Lt.zero();var d=new Array(3);var v=new Array(3);var m=new Array(3);var _=new Array(6);return function(e,t,n){d[0]=t.halfExtents.x;d[1]=t.halfExtents.y;d[2]=t.halfExtents.z;o=t.center;s=e.o;l=e.d;Lt.set(u,t.orientation.m00,t.orientation.m01,t.orientation.m02);Lt.set(h,t.orientation.m03,t.orientation.m04,t.orientation.m05);Lt.set(c,t.orientation.m06,t.orientation.m07,t.orientation.m08);Lt.sub(f,o,s);v[0]=Lt.dot(u,l);v[1]=Lt.dot(h,l);v[2]=Lt.dot(c,l);m[0]=Lt.dot(u,f);m[1]=Lt.dot(h,f);m[2]=Lt.dot(c,f);for(var r=0;r<3;++r){if(v[r]===0){if(-m[r]-d[r]>0||-m[r]+d[r]<0){return false}v[r]=1e-7}_[r*2+0]=(m[r]+d[r])/v[r];_[r*2+1]=(m[r]-d[r])/v[r]}var i=Math.max(Math.max(Math.min(_[0],_[1]),Math.min(_[2],_[3])),Math.min(_[4],_[5]));var a=Math.min(Math.min(Math.max(_[0],_[1]),Math.max(_[2],_[3])),Math.max(_[4],_[5]));if(a<0||i>a||i<0){return false}Lt.set(p,i*v[0]+s.x,i*v[1]+s.y,i*v[2]+s.z);if(n){Lt.transformMat3(n,p,t.orientation)}return true}}();var Qt=function(){var n=Lt.zero(),r=Ot.create();var i=function(e,t){return Math.abs(e.x)<t.x&&Math.abs(e.y)<t.y&&Math.abs(e.z)<t.z};return function(e,t){Lt.sub(n,t,e.center);Lt.transformMat3(n,n,Ot.transpose(r,e.orientation));return i(n,e.halfExtents)}}();var Jt=function(){var i=function(e,t,n,r){return Math.abs(e.x*t+e.y*n+e.z*r)};return function(e,t){var n=e.halfExtents.x*i(t.n,e.orientation.m00,e.orientation.m01,e.orientation.m02)+e.halfExtents.y*i(t.n,e.orientation.m03,e.orientation.m04,e.orientation.m05)+e.halfExtents.z*i(t.n,e.orientation.m06,e.orientation.m07,e.orientation.m08);var r=Lt.dot(t.n,e.center);if(r+n<t.d){return 1}else if(r-n>t.d){return 0}return-1}}();var $t=function(e,t){for(var n=0;n<t.planes.length;n++){if(Jt(e,t.planes[n])==1){return false}}return true};var en=function(){var u=new Array(8),h=0,c=0,f=0;for(var e=0;e<u.length;e++){u[e]=Lt.zero()}var p=function(e,t,n,r){return e.x*t+e.y*n+e.z*r};return function(e,t){var n=0,r=false;for(var i=0;i<t.planes.length;i++){n=Jt(e,t.planes[i]);if(n==1){return false}else if(n==-1){r=true}}if(!r){return true}for(var a=0;a<t.vertices.length;a++){Lt.sub(u[a],t.vertices[a],e.center)}c=0,f=0;for(var o=0;o<t.vertices.length;o++){h=p(u[o],e.orientation.m00,e.orientation.m01,e.orientation.m02);if(h>e.halfExtents.x){c++}else if(h<-e.halfExtents.x){f++}}if(c==t.vertices.length||f==t.vertices.length){return false}c=0;f=0;for(var s=0;s<t.vertices.length;s++){h=p(u[s],e.orientation.m03,e.orientation.m04,e.orientation.m05);if(h>e.halfExtents.y){c++}else if(h<-e.halfExtents.y){f++}}if(c==t.vertices.length||f==t.vertices.length){return false}c=0;f=0;for(var l=0;l<t.vertices.length;l++){h=p(u[l],e.orientation.m06,e.orientation.m07,e.orientation.m08);if(h>e.halfExtents.z){c++}else if(h<-e.halfExtents.z){f++}}if(c==t.vertices.length||f==t.vertices.length){return false}return true}}();var tn=function(){var a=new Array(15);for(var e=0;e<15;e++){a[e]=Lt.zero()}var l=new Array(8);for(var t=0;t<8;t++){l[t]=Lt.zero()}var u=Lt.zero();var h=Lt.zero();var c=Lt.zero();var f=Lt.zero();return function(e,t){Lt.set(a[0],e.orientation.m00,e.orientation.m01,e.orientation.m02);Lt.set(a[1],e.orientation.m03,e.orientation.m04,e.orientation.m05);Lt.set(a[2],e.orientation.m06,e.orientation.m07,e.orientation.m08);Lt.set(a[3],t.orientation.m00,t.orientation.m01,t.orientation.m02);Lt.set(a[4],t.orientation.m03,t.orientation.m04,t.orientation.m05);Lt.set(a[5],t.orientation.m06,t.orientation.m07,t.orientation.m08);for(var n=0;n<3;++n){Lt.cross(a[6+n*3+0],a[n],a[0]);Lt.cross(a[6+n*3+1],a[n],a[1]);Lt.cross(a[6+n*3+1],a[n],a[2])}for(var r=0;r<15;++r){if(!i(e,t,a[r])){return false}}return true;function i(e,t,n){var r=0;var i=1;var a=s(e,n);var o=s(t,n);return o[r]<=a[i]&&a[r]<=o[i]}function s(e,t){Lt.add(c,e.center,e.halfExtents);Lt.sub(f,e.center,e.halfExtents);Lt.set(u,Math.min(c.x,f.x),Math.min(c.y,f.y),Math.min(c.z,f.z));Lt.set(h,Math.max(c.x,f.x),Math.max(c.y,f.y),Math.max(c.z,f.z));Lt.set(l[0],u.x,h.y,h.z);Lt.set(l[1],u.x,h.y,u.z);Lt.set(l[2],u.x,u.y,h.z);Lt.set(l[3],u.x,u.y,u.z);Lt.set(l[4],h.x,h.y,h.z);Lt.set(l[5],h.x,h.y,u.z);Lt.set(l[6],h.x,u.y,h.z);Lt.set(l[7],h.x,u.y,u.z);var n=0;var r=0;n=r=Lt.dot(t,l[0]);for(var i=1;i<8;++i){var a=Lt.dot(t,l[i]);n=a<n?a:n;r=a>r?a:r}var o=[n,r];return o}}}();var nn=function(e,t){var n=Lt.dot(t.n,e.c);var r=e.r*Lt.magnitude(t.n);if(n+r<t.d){return 1}else if(n-r>t.d){return 0}return-1};var rn=function(e,t){for(var n=0;n<t.planes.length;n++){if(nn(e,t.planes[n])==1){return false}}return true};var an=function(){var u=Lt.zero(),h=[1,-1,1,-1,1,-1];var c=[],f=[];return function(e,t){var n=false;c.length=0;f.length=0;for(var r=0;r<t.planes.length;r++){var i=Lt.dot(t.planes[r].n,e.c);var a=Lt.magnitude(t.planes[r].n);var o=e.r*a;f.push(1/a);if(i+o<t.planes[r].d){return false}else if(i-o<t.planes[r].d){n=true;c.push(r)}}if(!n){return true}for(var s=0;s<c.length;s++){Lt.scale(u,t.planes[c[s]].n,e.r*f[c[s]]);Lt.add(u,e.c,u);for(var l=0;l<t.planes.length;l++){if(l==c[s]||l==c[s]+h[l]){continue}if(Lt.dot(t.planes[l].n,u)<t.planes[l].d){return false}}}return true}}();var on=function(){var a=Lt.zero();var o=Lt.zero();return function(e,t){var n=e.r;var r=t.r;a=e.c;o=t.c;var i=Lt.distance(a,o);if(i>n+r){return false}else{return true}}}();var sn=function(){var a=Lt.zero();var o=Lt.zero();var s=Lt.zero();var l=Lt.zero();var u=Lt.zero();var h=new Array(3);var c=new Array(3);return function(e,t){Lt.set(a,t.orientation.m00,t.orientation.m01,t.orientation.m02);Lt.set(o,t.orientation.m03,t.orientation.m04,t.orientation.m05);Lt.set(s,t.orientation.m06,t.orientation.m07,t.orientation.m08);h[0]=a;h[1]=o;h[2]=s;c[0]=t.halfExtents.x;c[1]=t.halfExtents.y;c[2]=t.halfExtents.z;Lt.sub(l,e.c,t.center);Lt.set(u,t.center.x,t.center.y,t.center.z);for(var n=0;n<3;n++){var r=Lt.dot(l,h[n]);if(r>c[n]){r=c[n]}if(r<-c[n]){r=-c[n]}u.x+=r*h[n].x;u.y+=r*h[n].y;u.z+=r*h[n].z}var i=Lt.distance(u,e.c);return i<e.r}}();var ln={ray_sphere:Kt,ray_box:Zt,ray_plane:Ht,ray_triangle:qt,line_plane:jt,line_triangle:Xt,line_quad:Yt,sphere_sphere:on,sphere_box:sn,sphere_plane:nn,sphere_frustum:rn,sphere_frustum_accurate:an,box_box:tn,box_plane:Jt,box_frustum:$t,box_frustum_accurate:en,box_point:Qt};ln[kt.SHAPE_RAY|kt.SHAPE_SPHERE]=Kt;ln[kt.SHAPE_RAY|kt.SHAPE_BOX]=Zt;ln[kt.SHAPE_RAY|kt.SHAPE_PLANE]=Ht;ln[kt.SHAPE_RAY|kt.SHAPE_TRIANGLE]=qt;ln[kt.SHAPE_LINE|kt.SHAPE_PLANE]=jt;ln[kt.SHAPE_LINE|kt.SHAPE_TRIANGLE]=Xt;ln[kt.SHAPE_SPHERE]=on;ln[kt.SHAPE_SPHERE|kt.SHAPE_BOX]=sn;ln[kt.SHAPE_SPHERE|kt.SHAPE_PLANE]=nn;ln[kt.SHAPE_SPHERE|kt.SHAPE_FRUSTUM]=rn;ln[kt.SHAPE_SPHERE|kt.SHAPE_FRUSTUM_ACCURATE]=an;ln[kt.SHAPE_BOX]=tn;ln[kt.SHAPE_BOX|kt.SHAPE_PLANE]=Jt;ln[kt.SHAPE_BOX|kt.SHAPE_FRUSTUM]=$t;ln[kt.SHAPE_BOX|kt.SHAPE_FRUSTUM_ACCURATE]=en;ln.resolve=function(e,t,n,r,i){if(i===void 0)i=null;var a=this[e|t];if(e<t){return a(n,r,i)}else{return a(r,n,i)}};var un=function e(t,n,r,i,a,o){this.s=Lt.new(t,n,r);this.e=Lt.new(i,a,o)};un.create=function e(){return new un(0,0,0,0,0,-1)};un.new=function e(t,n,r,i,a,o){return new un(t,n,r,i,a,o)};un.clone=function e(t){return new un(t.s.x,t.s.y,t.s.z,t.e.x,t.e.y,t.e.z)};un.copy=function e(t,n){t.s.x=n.s.x;t.s.y=n.s.y;t.s.z=n.s.z;t.e.x=n.e.x;t.e.y=n.e.y;t.e.z=n.e.z;return t};un.set=function e(t,n,r,i,a,o,s){t.s.x=n;t.s.y=r;t.s.z=i;t.e.x=a;t.e.y=o;t.e.z=s;return t};un.magnitude=function e(t){return Lt.distance(t.s,t.e)};un.mag=function e(t){return t.magnitude(t)};var hn=function e(t,n,r,i){this.n=Lt.new(t,n,r);this.d=i};hn.create=function e(){return new hn(0,1,0,0)};hn.new=function e(t,n,r,i){return new hn(t,n,r,i)};hn.clone=function e(t){return new hn(t.n.x,t.n.y,t.n.z,t.d)};hn.copy=function e(t,n){t.n.x=n.n.x;t.n.y=n.n.y;t.n.z=n.n.z;t.d=n.d;return t};hn.set=function e(t,n,r,i,a){t.n.x=n;t.n.y=r;t.n.z=i;t.d=a;return t};hn.fromNormalAndPoint=function e(t,n,r){Lt.copy(t.n,n);t.d=Lt.dot(n,r);return t};hn.normalize=function e(t,n){var r=Lt.magnitude(n.n);Lt.normalize(t.n,n.n);if(r>0){t.d=n.d/r}return t};hn.fromPoints=function(){var i=Lt.zero();var a=Lt.zero();return function(e,t,n,r){Lt.sub(i,n,t);Lt.sub(a,r,t);Lt.normalize(e.n,Lt.cross(e.n,i,a));e.d=Lt.dot(e.n,t);return e}}();var cn=function e(t,n,r,i,a,o){this.o=Lt.new(t,n,r);this.d=Lt.new(i,a,o)};cn.create=function e(){return new cn(0,0,0,0,0,-1)};cn.new=function e(t,n,r,i,a,o){return new cn(t,n,r,i,a,o)};cn.clone=function e(t){return new cn(t.o.x,t.o.y,t.o.z,t.d.x,t.d.y,t.d.z)};cn.copy=function e(t,n){t.o.x=n.o.x;t.o.y=n.o.y;t.o.z=n.o.z;t.d.x=n.d.x;t.d.y=n.d.y;t.d.z=n.d.z;return t};cn.set=function e(t,n,r,i,a,o,s){t.o.x=n;t.o.y=r;t.o.z=i;t.d.x=a;t.d.y=o;t.d.z=s;return t};cn.fromPoints=function e(t,n,r){Lt.copy(t.o,n);Lt.normalize(t.d,Lt.sub(t.d,r,n));return t};var fn=function e(t,n,r,i,a,o,s,l,u){this.a=Lt.new(t,n,r);this.b=Lt.new(i,a,o);this.c=Lt.new(s,l,u)};fn.create=function e(){return new fn(0,0,0,1,0,0,0,1,0)};fn.new=function e(t,n,r,i,a,o,s,l,u){return new fn(t,n,r,i,a,o,s,l,u)};fn.clone=function e(t){return new fn(t.a.x,t.a.y,t.a.z,t.b.x,t.b.y,t.b.z,t.c.x,t.c.y,t.c.z)};fn.copy=function e(t,n){t.a.x=n.a.x;t.a.y=n.a.y;t.a.z=n.a.z;t.b.x=n.b.x;t.b.y=n.b.y;t.b.z=n.b.z;t.c.x=n.c.x;t.c.y=n.c.y;t.c.z=n.c.z;return t};fn.set=function e(t,n,r,i,a,o,s,l,u,h){t.a.x=n;t.a.y=r;t.a.z=i;t.b.x=a;t.b.y=o;t.b.z=s;t.c.x=l;t.c.y=u;t.c.z=h;return t};function pn(e){return Math.max(Math.max(e.x,e.y),e.z)}var dn=function e(t,n,r,i){this.c=Lt.new(t,n,r);this.r=i};dn.create=function e(){return new dn(0,0,0,1)};dn.new=function e(t,n,r,i){return new dn(t,n,r,i)};dn.clone=function e(t){return new dn(t.c.x,t.c.y,t.c.z,t.r)};dn.copy=function e(t,n){t.c.x=n.c.x;t.c.y=n.c.y;t.c.z=n.c.z;t.r=n.r;return t};dn.set=function e(t,n,r,i,a){t.c.x=n;t.c.y=r;t.c.z=i;t.r=a;return t};dn.prototype.setTransform=function e(t,n,r,i){if(i===void 0)i=null;Lt.copy(this.c,t);this.r=pn(r);if(i){Lt.add(this.c,this.c,i.c);this.r*=i.r}return this};var vn=Lt.zero();var mn=Lt.zero();var _n=function e(t,n,r,i,a,o,s,l,u,h,c,f,p,d,v){this.center=Lt.new(t,n,r);this.halfExtents=Lt.new(i,a,o);this.orientation=Ot.new(s,l,u,h,c,f,p,d,v)};_n.create=function e(){return new _n(0,0,0,1,1,1,1,0,0,0,1,0,0,0,1)};_n.new=function e(t,n,r,i,a,o,s,l,u,h,c,f,p,d,v){return new _n(t,n,r,i,a,o,s,l,u,h,c,f,p,d,v)};_n.fromPoints=function e(t,n){Lt.scale(vn,Lt.add(vn,t,n),.5);Lt.scale(mn,Lt.sub(mn,n,t),.5);return new _n(vn.x,vn.y,vn.z,mn.x,mn.y,mn.z,1,0,0,0,1,0,0,0,1)};_n.clone=function e(t){return new _n(t.center.x,t.center.y,t.center.z,t.halfExtents.x,t.halfExtents.y,t.halfExtents.z,t.orientation.m00,t.orientation.m01,t.orientation.m02,t.orientation.m03,t.orientation.m04,t.orientation.m05,t.orientation.m06,t.orientation.m07,t.orientation.m08)};_n.copy=function e(t,n){t.center=n.center;t.halfExtents=n.halfExtents;t.orientation=n.orientation;return t};_n.set=function e(t,n,r,i,a,o,s,l,u,h,c,f,p,d,v,m){Lt.set(t.center,n,r,i);Lt.set(t.halfExtents,a,o,s);Ot.set(t.orientation,l,u,h,c,f,p,d,v,m);return t};_n.prototype.setTransform=function e(t,n,r,i){if(i===void 0)i=null;Lt.copy(this.center,t);Ot.fromQuat(this.orientation,n);Lt.copy(this.halfExtents,r);if(i){Lt.add(this.center,this.center,i.center);Ot.mul(this.orientation,this.orientation,i.orientation);Lt.mul(this.halfExtents,this.halfExtents,i.halfExtents)}return this};var gn=3;var yn=function e(){};yn.schema={time:{type:"number",default:0},value:{type:"number",default:0},inTangent:{type:"number",default:0},outTangent:{type:"number",default:0}};var xn=function e(){this.index=-1;this.time=0;this.endTime=0;this.coefficient=new Float32Array(4)};xn.prototype.evaluate=function e(t){var n=t-this.time;return bn(n,this.coefficient)};function bn(e,t){return e*(e*(e*t[0]+t[1])+t[2])+t[3]}var wn=function e(t){this._keyFrames=t;this.cachedKey=new xn};wn.prototype.addKey=function e(t){if(this._keyFrames===null){this._keyFrames=[]}this._keyFrames.push(t)};wn.prototype.evaluate_slow=function e(t){var n=this;var r=t;var i=t<0?this._preWrapMode:this._postWrapMode;var a=this._keyFrames[0].time;var o=this._keyFrames[this._keyFrames.length-1].time;switch(i){case"loop":r=nt(t-a,o-a)+a;break;case"pingPong":r=rt(t-a,o-a)+a;break;case"clampForever":r=He(t,a,o);break}var s=0;if(r>this._keyFrames[0].time){if(r>=this._keyFrames[this._keyFrames.length-1].time){s=this._keyFrames.length-2}else{for(var l=0;l<this._keyFrames.length-1;l++){if(r>=n._keyFrames[0].time&&r<=n._keyFrames[l+1].time){s=l;break}}}}var u=this._keyFrames[s];var h=this._keyFrames[s+1];var c=it(u.time,h.time,r);var f=h.time-u.time;var p=u.outTangent*f;var d=h.inTangent*f;var v=c*c;var m=v*c;var _=2*m-3*v+1;var g=m-2*v+c;var y=m-v;var x=-2*m+3*v;return _*u.value+g*p+y*d+x*h.value};wn.prototype.evaluate=function e(t){var n=t;var r=t<0?this._preWrapMode:this._postWrapMode;var i=this._keyFrames[0].time;var a=this._keyFrames[this._keyFrames.length-1].time;switch(r){case"loop":n=nt(t-i,a-i)+i;break;case"pingPong":n=rt(t-i,a-i)+i;break;case"clampForever":n=He(t,i,a);break}if(n>=this.cachedKey.time&&n<this.cachedKey.endTime){return this.cachedKey.evaluate(n)}else{var o=this.findIndex(this.cachedKey,n);var s=o+1;if(s==this._keyFrames.length){s-=1}this.calcOptimizedKey(this.cachedKey,o,s);return this.cachedKey.evaluate(n)}};wn.prototype.calcOptimizedKey=function e(t,n,r){var i=this._keyFrames[n];var a=this._keyFrames[r];t.index=n;t.time=i.time;t.endTime=a.time;var o=a.time-i.time;var s=a.value-i.value;var l=1/(o*o);var u=i.outTangent*o;var h=a.inTangent*o;t.coefficient[0]=(u+h-s-s)*l/o;t.coefficient[1]=(s+s+s-u-u-h)*l;t.coefficient[2]=i.outTangent;t.coefficient[3]=i.value};wn.prototype.findIndex=function e(t,n){var r=this;var i=t.index;if(i!==-1){var a=this._keyFrames[i].time;if(n>a){for(var o=0;o<gn;o++){var s=i+o;if(s+1<r._keyFrames.length&&r._keyFrames[s+1].time>n){return s}}}else{for(var l=0;l<gn;l++){var u=i-l;if(u>=0&&r._keyFrames[u-1].time<=n){return u-1}}}}var h=0;var c=this._keyFrames.length;var f=parseInt((h+c)/2);while(c-h>1){if(r._keyFrames[f].time>=n){c=f}else{h=f+1}f=parseInt((h+c)/2)}return h};wn.schema={keyFrames:{type:"Keyframe",default:null,array:true},preWrapMode:{type:"enums",default:"default",options:["default","once","loop","pingPong","clampForever"]},postWrapMode:{type:"enums",default:"default",options:["default","once","loop","pingPong","clampForever"]}};var En=Object.freeze({enums:kt,distance:Gt,intersect:ln,line:un,plane:hn,ray:cn,triangle:fn,sphere:dn,box:_n,Keyframe:yn,AnimationCurve:wn});var Tn=Bt.create();var Sn=Lt.zero();var An=0;var Mn=function e(){var t=this;this._id=An++;this._priority=0;this._rect={x:0,y:0,w:1,h:1};this._color=Ft.new(.3,.3,.3,1);this._depth=1;this._stencil=0;this._clearFlags=Me.CLEAR_COLOR|Me.CLEAR_DEPTH;this._clearModel=null;this._matView=Bt.create();this._matProj=Bt.create();this._matViewProj=Bt.create();this._matInvViewProj=Bt.create();this._stages=[];this._cullingByID=false;this._framebuffer=null;this._shadowLight=null;this._frustum={};this._frustum.fullUpdate=false;this._frustum.planes=new Array(6);for(var n=0;n<6;++n){t._frustum.planes[n]=hn.create()}this._frustum.vertices=new Array(8);for(var r=0;r<8;++r){t._frustum.vertices[r]=Lt.zero()}};var Rn={fullUpdate:{configurable:true}};Rn.fullUpdate.set=function(e){this._frustum.fullUpdate=e};Mn.prototype.getForward=function e(t){return Lt.set(t,-this._matView.m02,-this._matView.m06,-this._matView.m10)};Mn.prototype.getPosition=function e(t){Bt.invert(Tn,this._matView);return Bt.getTranslation(t,Tn)};Mn.prototype.updateFrustum=function e(){var t=this._matViewProj;Lt.set(this._frustum.planes[0].n,t.m03+t.m00,t.m07+t.m04,t.m11+t.m08);this._frustum.planes[0].d=-(t.m15+t.m12);Lt.set(this._frustum.planes[1].n,t.m03-t.m00,t.m07-t.m04,t.m11-t.m08);this._frustum.planes[1].d=-(t.m15-t.m12);Lt.set(this._frustum.planes[2].n,t.m03+t.m01,t.m07+t.m05,t.m11+t.m09);this._frustum.planes[2].d=-(t.m15+t.m13);Lt.set(this._frustum.planes[3].n,t.m03-t.m01,t.m07-t.m05,t.m11-t.m09);this._frustum.planes[3].d=-(t.m15-t.m13);Lt.set(this._frustum.planes[4].n,t.m03+t.m02,t.m07+t.m06,t.m11+t.m10);this._frustum.planes[4].d=-(t.m15+t.m14);Lt.set(this._frustum.planes[5].n,t.m03-t.m02,t.m07-t.m06,t.m11-t.m10);this._frustum.planes[5].d=-(t.m15-t.m14);if(!this._frustum.fullUpdate){return}Lt.set(Sn,1,1,1);Lt.transformMat4(this._frustum.vertices[0],Sn,this._matInvViewProj);Lt.set(Sn,-1,1,1);Lt.transformMat4(this._frustum.vertices[1],Sn,this._matInvViewProj);Lt.set(Sn,-1,-1,1);Lt.transformMat4(this._frustum.vertices[2],Sn,this._matInvViewProj);Lt.set(Sn,1,-1,1);Lt.transformMat4(this._frustum.vertices[3],Sn,this._matInvViewProj);Lt.set(Sn,1,1,-1);Lt.transformMat4(this._frustum.vertices[4],Sn,this._matInvViewProj);Lt.set(Sn,-1,1,-1);Lt.transformMat4(this._frustum.vertices[5],Sn,this._matInvViewProj);Lt.set(Sn,-1,-1,-1);Lt.transformMat4(this._frustum.vertices[6],Sn,this._matInvViewProj);Lt.set(Sn,1,-1,-1);Lt.transformMat4(this._frustum.vertices[7],Sn,this._matInvViewProj)};Object.defineProperties(Mn.prototype,Rn);var Ln=Lt.new(0,0,-1);var Cn=Bt.create();var On=Ot.create();var In=Lt.zero();function Un(e,t,n){e._node.getWorldRT(t);Bt.invert(t,t);Bt.perspective(n,e._spotAngle*e._spotAngleScale,1,e._shadowMinDepth,e._shadowMaxDepth)}function Pn(e,t,n){e._node.getWorldRT(t);Bt.invert(t,t);var r=e._shadowFrustumSize/2;Bt.ortho(n,-r,r,-r,r,e._shadowMinDepth,e._shadowMaxDepth)}function Bn(e,t,n){e._node.getWorldRT(t);Bt.invert(t,t);Bt.perspective(n,Xe(179),1,e._shadowMinDepth,e._shadowMaxDepth)}var Dn=function e(){this._poolID=-1;this._node=null;this._type=Me.LIGHT_DIRECTIONAL;this._color=Dt.new(1,1,1);this._intensity=1;this._range=1;this._spotAngle=Xe(60);this._spotExp=1;this._directionUniform=new Float32Array(3);this._positionUniform=new Float32Array(3);this._colorUniform=new Float32Array([this._color.r*this._intensity,this._color.g*this._intensity,this._color.b*this._intensity]);this._spotUniform=new Float32Array([Math.cos(this._spotAngle*.5),this._spotExp]);this._shadowType=Me.SHADOW_NONE;this._shadowFrameBuffer=null;this._shadowMap=null;this._shadowMapDirty=false;this._shadowDepthBuffer=null;this._shadowResolution=1024;this._shadowBias=5e-4;this._shadowDarkness=1;this._shadowMinDepth=1;this._shadowMaxDepth=1e3;this._shadowDepthScale=50;this._frustumEdgeFalloff=0;this._viewProjMatrix=Bt.create();this._spotAngleScale=1;this._shadowFrustumSize=50};var Fn={color:{configurable:true},intensity:{configurable:true},type:{configurable:true},spotAngle:{configurable:true},spotExp:{configurable:true},range:{configurable:true},shadowType:{configurable:true},shadowMap:{configurable:true},viewProjMatrix:{configurable:true},shadowResolution:{configurable:true},shadowBias:{configurable:true},shadowDarkness:{configurable:true},shadowMinDepth:{configurable:true},shadowMaxDepth:{configurable:true},shadowDepthScale:{configurable:true},frustumEdgeFalloff:{configurable:true},shadowFrustumSize:{configurable:true}};Dn.prototype.setNode=function e(t){this._node=t};Dn.prototype.setColor=function e(t,n,r){Dt.set(this._color,t,n,r);this._colorUniform[0]=t*this._intensity;this._colorUniform[1]=n*this._intensity;this._colorUniform[2]=r*this._intensity};Fn.color.get=function(){return this._color};Dn.prototype.setIntensity=function e(t){this._intensity=t;this._colorUniform[0]=t*this._color.r;this._colorUniform[1]=t*this._color.g;this._colorUniform[2]=t*this._color.b};Fn.intensity.get=function(){return this._intensity};Dn.prototype.setType=function e(t){this._type=t};Fn.type.get=function(){return this._type};Dn.prototype.setSpotAngle=function e(t){this._spotAngle=t;this._spotUniform[0]=Math.cos(this._spotAngle*.5)};Fn.spotAngle.get=function(){return this._spotAngle};Dn.prototype.setSpotExp=function e(t){this._spotExp=t;this._spotUniform[1]=t};Fn.spotExp.get=function(){return this._spotExp};Dn.prototype.setRange=function e(t){this._range=t};Fn.range.get=function(){return this._range};Dn.prototype.setShadowType=function e(t){if(this._shadowType===Me.SHADOW_NONE&&t!==Me.SHADOW_NONE){this._shadowMapDirty=true}this._shadowType=t};Fn.shadowType.get=function(){return this._shadowType};Fn.shadowMap.get=function(){return this._shadowMap};Fn.viewProjMatrix.get=function(){return this._viewProjMatrix};Dn.prototype.setShadowResolution=function e(t){if(this._shadowResolution!==t){this._shadowMapDirty=true}this._shadowResolution=t};Fn.shadowResolution.get=function(){return this._shadowResolution};Dn.prototype.setShadowBias=function e(t){this._shadowBias=t};Fn.shadowBias.get=function(){return this._shadowBias};Dn.prototype.setShadowDarkness=function e(t){this._shadowDarkness=t};Fn.shadowDarkness.get=function(){return this._shadowDarkness};Dn.prototype.setShadowMinDepth=function e(t){this._shadowMinDepth=t};Fn.shadowMinDepth.get=function(){if(this._type===Me.LIGHT_DIRECTIONAL){return 1}return this._shadowMinDepth};Dn.prototype.setShadowMaxDepth=function e(t){this._shadowMaxDepth=t};Fn.shadowMaxDepth.get=function(){if(this._type===Me.LIGHT_DIRECTIONAL){return 1}return this._shadowMaxDepth};Dn.prototype.setShadowDepthScale=function e(t){this._shadowDepthScale=t};Fn.shadowDepthScale.get=function(){return this._shadowDepthScale};Dn.prototype.setFrustumEdgeFalloff=function e(t){this._frustumEdgeFalloff=t};Fn.frustumEdgeFalloff.get=function(){return this._frustumEdgeFalloff};Dn.prototype.setShadowFrustumSize=function e(t){this._shadowFrustumSize=t};Fn.shadowFrustumSize.get=function(){return this._shadowFrustumSize};Dn.prototype.extractView=function e(t,n){t._shadowLight=this;t._priority=-1;t._rect.x=0;t._rect.y=0;t._rect.w=this._shadowResolution;t._rect.h=this._shadowResolution;Ft.set(t._color,1,1,1,1);t._depth=1;t._stencil=1;t._clearFlags=Me.CLEAR_COLOR|Me.CLEAR_DEPTH;t._stages=n;t._framebuffer=this._shadowFrameBuffer;switch(this._type){case Me.LIGHT_SPOT:Un(this,t._matView,t._matProj);break;case Me.LIGHT_DIRECTIONAL:Pn(this,t._matView,t._matProj);break;case Me.LIGHT_POINT:Bn(this,t._matView,t._matProj);break;default:console.warn("shadow of this light type is not supported")}Bt.mul(t._matViewProj,t._matProj,t._matView);this._viewProjMatrix=t._matViewProj;Bt.invert(t._matInvViewProj,t._matViewProj);t.updateFrustum()};Dn.prototype._updateLightPositionAndDirection=function e(){this._node.getWorldMatrix(Cn);Ot.fromMat4(On,Cn);Lt.transformMat3(In,Ln,On);Lt.array(this._directionUniform,In);var t=this._positionUniform;t[0]=Cn.m12;t[1]=Cn.m13;t[2]=Cn.m14};Dn.prototype._generateShadowMap=function e(t){this._shadowMap=new Ae.Texture2D(t,{width:this._shadowResolution,height:this._shadowResolution,format:Ae.TEXTURE_FMT_RGBA8,wrapS:Ae.WRAP_CLAMP,wrapT:Ae.WRAP_CLAMP});this._shadowDepthBuffer=new Ae.RenderBuffer(t,Ae.RB_FMT_D16,this._shadowResolution,this._shadowResolution);this._shadowFrameBuffer=new Ae.FrameBuffer(t,this._shadowResolution,this._shadowResolution,{colors:[this._shadowMap],depth:this._shadowDepthBuffer})};Dn.prototype._destroyShadowMap=function e(){if(this._shadowMap){this._shadowMap.destroy();this._shadowDepthBuffer.destroy();this._shadowFrameBuffer.destroy();this._shadowMap=null;this._shadowDepthBuffer=null;this._shadowFrameBuffer=null}};Dn.prototype.update=function e(t){this._updateLightPositionAndDirection();if(this._shadowType===Me.SHADOW_NONE){this._destroyShadowMap()}else if(this._shadowMapDirty){this._destroyShadowMap();this._generateShadowMap(t);this._shadowMapDirty=false}};Object.defineProperties(Dn.prototype,Fn);var zn=Bt.create();var Nn=Bt.create();var kn=Bt.create();var Vn=Bt.create();var Wn=Lt.zero();var Gn=Lt.zero();var Hn=Lt.zero();var jn=function e(){this._poolID=-1;this._node=null;this._projection=Me.PROJ_PERSPECTIVE;this._priority=0;this._color=Ft.new(.2,.3,.47,1);this._depth=1;this._stencil=0;this._clearFlags=Me.CLEAR_COLOR|Me.CLEAR_DEPTH;this._clearModel=null;this._stages=[];this._framebuffer=null;this._near=.01;this._far=1e3;this._fov=Math.PI/4;this._rect={x:0,y:0,w:1,h:1};this._orthoHeight=10};jn.prototype.getNode=function e(){return this._node};jn.prototype.setNode=function e(t){this._node=t};jn.prototype.getType=function e(){return this._projection};jn.prototype.setType=function e(t){this._projection=t};jn.prototype.getPriority=function e(){return this._priority};jn.prototype.setPriority=function e(t){this._priority=t};jn.prototype.getOrthoHeight=function e(){return this._orthoHeight};jn.prototype.setOrthoHeight=function e(t){this._orthoHeight=t};jn.prototype.getFov=function e(){return this._fov};jn.prototype.setFov=function e(t){this._fov=t};jn.prototype.getNear=function e(){return this._near};jn.prototype.setNear=function e(t){this._near=t};jn.prototype.getFar=function e(){return this._far};jn.prototype.setFar=function e(t){this._far=t};jn.prototype.getColor=function e(t){return Ft.copy(t,this._color)};jn.prototype.setColor=function e(t,n,r,i){Ft.set(this._color,t,n,r,i)};jn.prototype.getDepth=function e(){return this._depth};jn.prototype.setDepth=function e(t){this._depth=t};jn.prototype.getStencil=function e(){return this._stencil};jn.prototype.setStencil=function e(t){this._stencil=t};jn.prototype.getClearFlags=function e(){return this._clearFlags};jn.prototype.setClearFlags=function e(t){this._clearFlags=t};jn.prototype.getRect=function e(t){t.x=this._rect.x;t.y=this._rect.y;t.w=this._rect.w;t.h=this._rect.h;return t};jn.prototype.setRect=function e(t,n,r,i){this._rect.x=t;this._rect.y=n;this._rect.w=r;this._rect.h=i};jn.prototype.getStages=function e(){return this._stages};jn.prototype.setStages=function e(t){this._stages=t};jn.prototype.getFramebuffer=function e(){return this._framebuffer};jn.prototype.setFramebuffer=function e(t){this._framebuffer=t};jn.prototype.extractView=function e(t,n,r){t._priority=this._priority;t._rect.x=this._rect.x*n;t._rect.y=this._rect.y*r;t._rect.w=this._rect.w*n;t._rect.h=this._rect.h*r;t._color=this._color;t._depth=this._depth;t._stencil=this._stencil;t._clearFlags=this._clearFlags;t._clearModel=this._clearModel;t._stages=this._stages;t._framebuffer=this._framebuffer;this._node.getWorldRT(t._matView);Bt.invert(t._matView,t._matView);var i=n/r;if(this._projection===Me.PROJ_PERSPECTIVE){Bt.perspective(t._matProj,this._fov,i,this._near,this._far)}else{var a=this._orthoHeight*i;var o=this._orthoHeight;Bt.ortho(t._matProj,-a,a,-o,o,this._near,this._far)}Bt.mul(t._matViewProj,t._matProj,t._matView);Bt.invert(t._matInvViewProj,t._matViewProj);t.updateFrustum()};jn.prototype.screenToWorld=function e(t,n,r,i){var a=r/i;var o=this._rect.x*r;var s=this._rect.y*i;var l=this._rect.w*r;var u=this._rect.h*i;this._node.getWorldRT(zn);Bt.invert(zn,zn);if(this._projection===Me.PROJ_PERSPECTIVE){Bt.perspective(Nn,this._fov,a,this._near,this._far)}else{var h=this._orthoHeight*a;var c=this._orthoHeight;Bt.ortho(Nn,-h,h,-c,c,this._near,this._far)}Bt.mul(kn,Nn,zn);Bt.invert(Vn,kn);if(this._projection===Me.PROJ_PERSPECTIVE){Lt.set(t,(n.x-o)*2/l-1,(n.y-s)*2/u-1,1);Lt.transformMat4(t,t,Vn);this._node.getWorldPos(Wn);Lt.lerp(t,Wn,t,n.z/this._far)}else{var f=this._farClip-this._nearClip;Lt.set(t,(n.x-o)*2/l-1,(n.y-s)*2/u-1,(this._far-n.z)/f*2-1);Lt.transformMat4(t,t,Vn)}return t};jn.prototype.screenPointToRay=function e(t,n,r){this._node.getWorldPos(Hn);this.screenToWorld(Gn,t,n,r);Lt.sub(Gn,Gn,Hn);return cn.new(Hn.x,Hn.y,Hn.z,Gn.x,Gn.y,Gn.z)};jn.prototype.worldToScreen=function e(t,n,r,i){var a=r/i;var o=this._rect.x*r;var s=this._rect.y*i;var l=this._rect.w*r;var u=this._rect.h*i;this._node.getWorldRT(zn);Bt.invert(zn,zn);if(this._projection===Me.PROJ_PERSPECTIVE){Bt.perspective(Nn,this._fov,a,this._near,this._far)}else{var h=this._orthoHeight*a;var c=this._orthoHeight;Bt.ortho(Nn,-h,h,-c,c,this._near,this._far)}Bt.mul(kn,Nn,zn);var f=n.x*kn.m03+n.y*kn.m07+n.z*kn.m11+kn.m15;Lt.transformMat4(t,n,kn);t.x=o+(t.x/f+1)*.5*l;t.y=s+(t.y/f+1)*.5*u;return t};var qn=function e(){this._type="default";this._poolID=-1;this._node=null;this._inputAssembler=null;this._effect=null;this._defines={};this._dependencies={};this._viewID=-1;this._cameraID=-1;this._userKey=-1;this._castShadow=false;this._boundingBox=null};qn.prototype.setNode=function e(t){this._node=t};qn.prototype.setInputAssembler=function e(t){this._inputAssembler=t};qn.prototype.setEffect=function e(t){if(t){this._effect=t;this._defines=t.extractDefines(Object.create(null));this._dependencies=t.extractDependencies(Object.create(null))}else{this._effect=null;this._defines=Object.create(null);this._dependencies=Object.create(null)}};qn.prototype.setUserKey=function e(t){this._userKey=t};qn.prototype.extractDrawItem=function e(t){t.model=this;t.node=this._node;t.ia=this._inputAssembler;t.effect=this._effect;t.defines=this._effect.extractDefines(this._defines);t.dependencies=this._effect.extractDependencies(this._dependencies)};qn.prototype.createBoundingBox=function e(t,n){if(t===null||t===undefined||n===null||n===undefined){return}this._bbModelSpace=_n.fromPoints(t,n);this._boundingBox=_n.clone(this._bbModelSpace)};var Xn=function e(t,n){var r=this;this._cursor=0;this._data=new Array(n);for(var i=0;i<n;++i){r._data[i]=t()}};Xn.prototype.request=function e(){var t=this._data[this._cursor];this._cursor=(this._cursor+1)%this._data.length;return t};var Yn=32;var Kn=7;var Zn=256;var Qn=[1,10,100,1e3,1e4,1e5,1e6,1e7,1e8,1e9];function Jn(e){if(e<1e5){if(e<100){return e<10?0:1}if(e<1e4){return e<1e3?2:3}return 4}if(e<1e7){return e<1e6?5:6}if(e<1e9){return e<1e8?7:8}return 9}function $n(e,t){if(e===t){return 0}if(~~e===e&&~~t===t){if(e===0||t===0){return e<t?-1:1}if(e<0||t<0){if(t>=0){return-1}if(e>=0){return 1}e=-e;t=-t}var n=Jn(e);var r=Jn(t);var i=0;if(n<r){e*=Qn[r-n-1];t/=10;i=-1}else if(n>r){t*=Qn[n-r-1];e/=10;i=1}if(e===t){return i}return e<t?-1:1}var a=String(e);var o=String(t);if(a===o){return 0}return a<o?-1:1}function er(e){var t=0;while(e>=Yn){t|=e&1;e>>=1}return e+t}function tr(e,t,n,r){var i=t+1;if(i===n){return 1}if(r(e[i++],e[t])<0){while(i<n&&r(e[i],e[i-1])<0){i++}nr(e,t,i)}else{while(i<n&&r(e[i],e[i-1])>=0){i++}}return i-t}function nr(e,t,n){n--;while(t<n){var r=e[t];e[t++]=e[n];e[n--]=r}}function rr(e,t,n,r,i){if(r===t){r++}for(;r<n;r++){var a=e[r];var o=t;var s=r;while(o<s){var l=o+s>>>1;if(i(a,e[l])<0){s=l}else{o=l+1}}var u=r-o;switch(u){case 3:e[o+3]=e[o+2];case 2:e[o+2]=e[o+1];case 1:e[o+1]=e[o];break;default:while(u>0){e[o+u]=e[o+u-1];u--}}e[o]=a}}function ir(e,t,n,r,i,a){var o=0;var s=0;var l=1;if(a(e,t[n+i])>0){s=r-i;while(l<s&&a(e,t[n+i+l])>0){o=l;l=(l<<1)+1;if(l<=0){l=s}}if(l>s){l=s}o+=i;l+=i}else{s=i+1;while(l<s&&a(e,t[n+i-l])<=0){o=l;l=(l<<1)+1;if(l<=0){l=s}}if(l>s){l=s}var u=o;o=i-l;l=i-u}o++;while(o<l){var h=o+(l-o>>>1);if(a(e,t[n+h])>0){o=h+1}else{l=h}}return l}function ar(e,t,n,r,i,a){var o=0;var s=0;var l=1;if(a(e,t[n+i])<0){s=i+1;while(l<s&&a(e,t[n+i-l])<0){o=l;l=(l<<1)+1;if(l<=0){l=s}}if(l>s){l=s}var u=o;o=i-l;l=i-u}else{s=r-i;while(l<s&&a(e,t[n+i+l])>=0){o=l;l=(l<<1)+1;if(l<=0){l=s}}if(l>s){l=s}o+=i;l+=i}o++;while(o<l){var h=o+(l-o>>>1);if(a(e,t[n+h])<0){l=h}else{o=h+1}}return l}var or=function e(t,n){this.array=t;this.compare=n;this.minGallop=Kn;this.length=t.length;this.tmpStorageLength=Zn;if(this.length<2*Zn){this.tmpStorageLength=this.length>>>1}this.tmp=new Array(this.tmpStorageLength);this.stackLength=this.length<120?5:this.length<1542?10:this.length<119151?19:40;this.runStart=new Array(this.stackLength);this.runLength=new Array(this.stackLength);this.stackSize=0};or.prototype.pushRun=function e(t,n){this.runStart[this.stackSize]=t;this.runLength[this.stackSize]=n;this.stackSize+=1};or.prototype.mergeRuns=function e(){var t=this;while(this.stackSize>1){var n=t.stackSize-2;if(n>=1&&t.runLength[n-1]<=t.runLength[n]+t.runLength[n+1]||n>=2&&t.runLength[n-2]<=t.runLength[n]+t.runLength[n-1]){if(t.runLength[n-1]<t.runLength[n+1]){n--}}else if(t.runLength[n]>t.runLength[n+1]){break}t.mergeAt(n)}};or.prototype.forceMergeRuns=function e(){var t=this;while(this.stackSize>1){var n=t.stackSize-2;if(n>0&&t.runLength[n-1]<t.runLength[n+1]){n--}t.mergeAt(n)}};or.prototype.mergeAt=function e(t){var n=this.compare;var r=this.array;var i=this.runStart[t];var a=this.runLength[t];var o=this.runStart[t+1];var s=this.runLength[t+1];this.runLength[t]=a+s;if(t===this.stackSize-3){this.runStart[t+1]=this.runStart[t+2];this.runLength[t+1]=this.runLength[t+2]}this.stackSize--;var l=ar(r[o],r,i,a,0,n);i+=l;a-=l;if(a===0){return}s=ir(r[i+a-1],r,o,s,s-1,n);if(s===0){return}if(a<=s){this.mergeLow(i,a,o,s)}else{this.mergeHigh(i,a,o,s)}};or.prototype.mergeLow=function e(t,n,r,i){var a=this.compare;var o=this.array;var s=this.tmp;var l=0;for(l=0;l<n;l++){s[l]=o[t+l]}var u=0;var h=r;var c=t;o[c++]=o[h++];if(--i===0){for(l=0;l<n;l++){o[c+l]=s[u+l]}return}if(n===1){for(l=0;l<i;l++){o[c+l]=o[h+l]}o[c+i]=s[u];return}var f=this.minGallop;while(true){var p=0;var d=0;var v=false;do{if(a(o[h],s[u])<0){o[c++]=o[h++];d++;p=0;if(--i===0){v=true;break}}else{o[c++]=s[u++];p++;d=0;if(--n===1){v=true;break}}}while((p|d)<f);if(v){break}do{p=ar(o[h],s,u,n,0,a);if(p!==0){for(l=0;l<p;l++){o[c+l]=s[u+l]}c+=p;u+=p;n-=p;if(n<=1){v=true;break}}o[c++]=o[h++];if(--i===0){v=true;break}d=ir(s[u],o,h,i,0,a);if(d!==0){for(l=0;l<d;l++){o[c+l]=o[h+l]}c+=d;h+=d;i-=d;if(i===0){v=true;break}}o[c++]=s[u++];if(--n===1){v=true;break}f--}while(p>=Kn||d>=Kn);if(v){break}if(f<0){f=0}f+=2}this.minGallop=f;if(f<1){this.minGallop=1}if(n===1){for(l=0;l<i;l++){o[c+l]=o[h+l]}o[c+i]=s[u]}else if(n===0){throw new Error("mergeLow preconditions were not respected")}else{for(l=0;l<n;l++){o[c+l]=s[u+l]}}};or.prototype.mergeHigh=function e(t,n,r,i){var a=this.compare;var o=this.array;var s=this.tmp;var l=0;for(l=0;l<i;l++){s[l]=o[r+l]}var u=t+n-1;var h=i-1;var c=r+i-1;var f=0;var p=0;o[c--]=o[u--];if(--n===0){f=c-(i-1);for(l=0;l<i;l++){o[f+l]=s[l]}return}if(i===1){c-=n;u-=n;p=c+1;f=u+1;for(l=n-1;l>=0;l--){o[p+l]=o[f+l]}o[c]=s[h];return}var d=this.minGallop;while(true){var v=0;var m=0;var _=false;do{if(a(s[h],o[u])<0){o[c--]=o[u--];v++;m=0;if(--n===0){_=true;break}}else{o[c--]=s[h--];m++;v=0;if(--i===1){_=true;break}}}while((v|m)<d);if(_){break}do{v=n-ar(s[h],o,t,n,n-1,a);if(v!==0){c-=v;u-=v;n-=v;p=c+1;f=u+1;for(l=v-1;l>=0;l--){o[p+l]=o[f+l]}if(n===0){_=true;break}}o[c--]=s[h--];if(--i===1){_=true;break}m=i-ir(o[u],s,0,i,i-1,a);if(m!==0){c-=m;h-=m;i-=m;p=c+1;f=h+1;for(l=0;l<m;l++){o[p+l]=s[f+l]}if(i<=1){_=true;break}}o[c--]=o[u--];if(--n===0){_=true;break}d--}while(v>=Kn||m>=Kn);if(_){break}if(d<0){d=0}d+=2}this.minGallop=d;if(d<1){this.minGallop=1}if(i===1){c-=n;u-=n;p=c+1;f=u+1;for(l=n-1;l>=0;l--){o[p+l]=o[f+l]}o[c]=s[h]}else if(i===0){throw new Error("mergeHigh preconditions were not respected")}else{f=c-(i-1);for(l=0;l<i;l++){o[f+l]=s[l]}}};function sr(e,t,n,r){if(!Array.isArray(e)){throw new TypeError("Can only sort arrays")}if(t===undefined){t=0}if(n===undefined){n=e.length}if(r===undefined){r=$n}var i=n-t;if(i<2){return}var a=0;if(i<Yn){a=tr(e,t,n,r);rr(e,t,n,t+a,r);return}var o=new or(e,r);var s=er(i);do{a=tr(e,t,n,r);if(a<s){var l=i;if(l>s){l=s}rr(e,t,t+l,t+a,r);a=l}o.pushRun(t,a);o.mergeRuns();i-=a;t+=a}while(i!==0);o.forceMergeRuns()}var lr=function e(t){this._count=0;this._data=new Array(t)};var ur={length:{configurable:true},data:{configurable:true}};lr.prototype._resize=function e(t){var n=this;if(t>this._data.length){for(var r=this._data.length;r<t;++r){n._data[r]=undefined}}};ur.length.get=function(){return this._count};ur.data.get=function(){return this._data};lr.prototype.reset=function e(){var t=this;for(var n=0;n<this._count;++n){t._data[n]=undefined}this._count=0};lr.prototype.push=function e(t){if(this._count>=this._data.length){this._resize(this._data.length*2)}this._data[this._count]=t;++this._count};lr.prototype.pop=function e(){--this._count;if(this._count<0){this._count=0}var t=this._data[this._count];this._data[this._count]=undefined;return t};lr.prototype.fastRemove=function e(t){if(t>=this._count||t<0){return}var n=this._count-1;this._data[t]=this._data[n];this._data[n]=undefined;this._count-=1};lr.prototype.indexOf=function e(t){return this._data.indexOf(t)};lr.prototype.sort=function e(t){return sr(this._data,0,this._count,t)};Object.defineProperties(lr.prototype,ur);var hr=function e(t,n){var r=this;this._fn=t;this._idx=n-1;this._frees=new Array(n);for(var i=0;i<n;++i){r._frees[i]=t()}};hr.prototype._expand=function e(t){var n=this;var r=this._frees;this._frees=new Array(t);var i=t-r.length;for(var a=0;a<i;++a){n._frees[a]=n._fn()}for(var o=i,s=0;o<t;++o,++s){n._frees[o]=r[s]}this._idx+=i};hr.prototype.alloc=function e(){if(this._idx<0){this._expand(Math.round(this._frees.length*1.2)+1)}var t=this._frees[this._idx];this._frees[this._idx]=null;--this._idx;return t};hr.prototype.free=function e(t){++this._idx;this._frees[this._idx]=t};var cr=function e(t,n){this._fn=t;this._count=0;this._head=null;this._tail=null;this._pool=new hr(t,n)};var fr={head:{configurable:true},tail:{configurable:true},length:{configurable:true}};fr.head.get=function(){return this._head};fr.tail.get=function(){return this._tail};fr.length.get=function(){return this._count};cr.prototype.add=function e(){var t=this._pool.alloc();if(!this._tail){this._head=t}else{this._tail._next=t;t._prev=this._tail}this._tail=t;this._count+=1;return t};cr.prototype.remove=function e(t){if(t._prev){t._prev._next=t._next}else{this._head=t._next}if(t._next){t._next._prev=t._prev}else{this._tail=t._prev}t._next=null;t._prev=null;this._pool.free(t);this._count-=1};cr.prototype.forEach=function e(t,n){var r=this;var i=this._head;if(!i){return}if(n){t=t.bind(n)}var a=0;var o=i;while(i){o=i._next;t(i,a,r);i=o;++a}};Object.defineProperties(cr.prototype,fr);var pr=function e(t,n){var r=this;this._fn=t;this._count=0;this._data=new Array(n);for(var i=0;i<n;++i){r._data[i]=t()}};var dr={length:{configurable:true},data:{configurable:true}};dr.length.get=function(){return this._count};dr.data.get=function(){return this._data};pr.prototype.reset=function e(){this._count=0};pr.prototype.resize=function e(t){var n=this;if(t>this._data.length){for(var r=this._data.length;r<t;++r){n._data[r]=n._fn()}}};pr.prototype.add=function e(){if(this._count>=this._data.length){this.resize(this._data.length*2)}return this._data[this._count++]};pr.prototype.remove=function e(t){if(t>=this._count){return}var n=this._count-1;var r=this._data[t];this._data[t]=this._data[n];this._data[n]=r;this._count-=1};pr.prototype.sort=function e(t){return sr(this._data,0,this._count,t)};Object.defineProperties(pr.prototype,dr);var vr=Array(8);for(var mr=0;mr<8;++mr){vr[mr]=[]}function _r(e){for(var t=16;t<=1<<28;t*=16){if(e<=t){return t}}return 0}function gr(e){var t,n;t=(e>65535)<<4;e>>>=t;n=(e>255)<<3;e>>>=n;t|=n;n=(e>15)<<2;e>>>=n;t|=n;n=(e>3)<<1;e>>>=n;t|=n;return t|e>>1}function yr(e){var t=_r(e);var n=vr[gr(t)>>2];if(n.length>0){return n.pop()}return new ArrayBuffer(t)}function xr(e){vr[gr(e.byteLength)>>2].push(e)}var br={alloc_int8:function e(t){var n=new Int8Array(yr(t),0,t);if(n.length!==t){return n.subarray(0,t)}return n},alloc_uint8:function e(t){var n=new Uint8Array(yr(t),0,t);if(n.length!==t){return n.subarray(0,t)}return n},alloc_int16:function e(t){var n=new Int16Array(yr(2*t),0,t);if(n.length!==t){return n.subarray(0,t)}return n},alloc_uint16:function e(t){var n=new Uint16Array(yr(2*t),0,t);if(n.length!==t){return n.subarray(0,t)}return n},alloc_int32:function e(t){var n=new Int32Array(yr(4*t),0,t);if(n.length!==t){return n.subarray(0,t)}return n},alloc_uint32:function e(t){var n=new Uint32Array(yr(4*t),0,t);if(n.length!==t){return n.subarray(0,t)}return n},alloc_float32:function e(t){var n=new Float32Array(yr(4*t),0,t);if(n.length!==t){return n.subarray(0,t)}return n},alloc_float64:function e(t){var n=new Float64Array(yr(8*t),0,t);if(n.length!==t){return n.subarray(0,t)}return n},alloc_dataview:function e(t){var n=new DataView(yr(t),0,t);if(n.length!==t){return n.subarray(0,t)}return n},free:function e(t){xr(t.buffer)},reset:function e(){var t=Array(8);for(var n=0;n<8;++n){t[n]=[]}}};var wr=Object.freeze({CircularPool:Xn,FixedArray:lr,LinkedArray:cr,Pool:hr,RecyclePool:pr,TypedArrayPool:br});function Er(e){return e?(e^Math.random()*16>>e/4).toString(16):([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,Er)}var Tr=function e(){};Tr.addLayer=function e(t){if(Tr._nextAvailable>31){return new Error("maximum layers reached.")}Tr[t]=1<<Tr._nextAvailable++;return Tr[t]};Tr.makeInclusiveMask=function e(t){var n=0;for(var r=0;r<t.length;r++){n|=t[r]}return n};Tr.makeExclusiveMask=function e(t){return~Tr.makeInclusiveMask(t)};Tr.check=function e(t,n){return(t&n)==t};Tr._nextAvailable=8;Tr.Default=1<<0;Tr.IgnoreRaycast=1<<1;Tr.RaycastMask=Tr.makeExclusiveMask([Tr.IgnoreRaycast]);var Sr=Lt.zero();var Ar=It.create();var Mr=Ot.create();var Rr=Ot.create();var Lr=Bt.create();var Cr=function e(t){this._id=Er();this._parent=null;this._children=[];this.name=t||"";this.lpos=Lt.new(0,0,0);this.lscale=Lt.new(1,1,1);this.lrot=It.new(0,0,0,1);this.layer=Tr.Default};var Or={id:{configurable:true},parent:{configurable:true},children:{configurable:true}};Cr.mixin=function e(t){Object.getOwnPropertyNames(Cr.prototype).forEach(function(e){if(t.prototype.hasOwnProperty(e)===false){Object.defineProperty(t.prototype,e,Object.getOwnPropertyDescriptor(Cr.prototype,e))}});t.prototype.__initNode=function(){this._id=Er();this._parent=null;this._children=[];this.name="";this.lpos=Lt.new(0,0,0);this.lscale=Lt.new(1,1,1);this.lrot=It.new(0,0,0,1);this.layer=Tr.Default}};Or.id.get=function(){return this._id};Or.parent.get=function(){return this._parent};Or.children.get=function(){return this._children};Cr.prototype.setParent=function e(t){var n=this;var r=this._parent;if(r===t){return false}var i=t;while(i){if(i===n){return false}i=i._parent}if(r){var a=r._children.length;for(var o=0;o<a;++o){if(r._children[o]===n){r._children.splice(o,1);break}}}this._parent=t;if(t){t._children.push(this)}if(this._onParentChanged){this._onParentChanged(r,t)}return true};Cr.prototype.insertAt=function e(t,n){var r=this;if(!n){return false}var i=this;while(i){if(i===n){return false}i=i._parent}var a=n._parent;var o=this._children.length;t=t<0?0:t>o?o:t;if(a){o=a._children.length;for(var s=0;s<o;++s){if(a._children[s]===n){if(a===r){if(s===t||s===t-1){return false}if(s<t-1){t=t-1}}a._children.splice(s,1);break}}}n._parent=this;this._children.splice(t,0,n);if(n._onParentChanged&&n._parent!==this){n._onParentChanged(a,this)}return true};Cr.prototype.append=function e(t){var n=this;if(!t){return false}var r=this;while(r){if(r===t){return false}r=r._parent}var i=t._parent;if(i){var a=i._children.length;for(var o=0;o<a;++o){if(i._children[o]===t){if(i===n&&o===a-1){return false}i._children.splice(o,1);break}}}t._parent=this;this._children.push(t);if(t._onParentChanged&&t._parent!==this){t._onParentChanged(i,this)}return true};Cr.prototype.remove=function e(){if(this._parent){this._parent.removeChild(this)}};Cr.prototype.removeChild=function e(t){var n=this;var r=this._children.length;for(var i=0;i<r;++i){if(n._children[i]===t){n._children.splice(i,1);t._parent=null;if(t._onParentChanged){t._onParentChanged(n,null)}return true}}return false};Cr.prototype.lookAt=function e(t,n){this.getWorldPos(Sr);Lt.sub(Sr,Sr,t);Lt.normalize(Sr,Sr);It.fromViewUp(Ar,Sr,n);this.setWorldRot(Ar)};Cr.prototype.getWorldPos=function e(t){Lt.copy(t,this.lpos);var n=this._parent;while(n){Lt.mul(t,t,n.lscale);Lt.transformQuat(t,t,n.lrot);Lt.add(t,t,n.lpos);n=n._parent}return t};Cr.prototype.setWorldPos=function e(t){if(this._parent){this._parent.invTransformPoint(this.lpos,t);return}Lt.copy(this.lpos,t)};Cr.prototype.getWorldRot=function e(t){It.copy(t,this.lrot);var n=this._parent;while(n){It.mul(t,n.lrot,t);n=n._parent}return t};Cr.prototype.setWorldRot=function e(t){if(this._parent){this._parent.getWorldRot(this.lrot);It.conjugate(this.lrot,this.lrot);It.mul(this.lrot,this.lrot,t);return}It.copy(this.lrot,t)};Cr.prototype.getWorldScale=function e(t){Lt.copy(t,this.lscale);var n=this._parent;while(n){Lt.mul(t,n.lscale,t);n=n._parent}return t};Cr.prototype.invTransformPoint=function e(t,n){if(this._parent){this._parent.invTransformPoint(t,n)}else{Lt.copy(t,n)}Lt.sub(t,t,this.lpos);It.conjugate(Ar,this.lrot);Lt.transformQuat(t,t,Ar);Lt.inverseSafe(Sr,this.lscale);Lt.mul(t,t,Sr);return t};Cr.prototype.getLocalMatrix=function e(t){Bt.fromRTS(t,this.lrot,this.lpos,this.lscale);return t};Cr.prototype.getWorldMatrix=function e(t){this.getLocalMatrix(t);var n=this._parent;while(n){n.getLocalMatrix(Lr);Bt.mul(t,Lr,t);n=n._parent}return t};Cr.prototype.getWorldRT=function e(t){this._getWorldPosAndRot(Sr,Ar);Bt.fromRT(t,Ar,Sr);return t};Cr.prototype.getWorldRS=function e(t){Ot.set(Mr,this.lscale.x,0,0,0,this.lscale.y,0,0,0,this.lscale.z);Ot.fromQuat(Rr,this.lrot);if(this._parent){this._parent.getWorldRS(t);Ot.mul(t,t,Rr);Ot.mul(t,t,Mr)}else{Ot.mul(t,Rr,Mr)}return t};Cr.prototype._getWorldPosAndRot=function e(t,n){Lt.copy(t,this.lpos);It.copy(n,this.lrot);var r=this._parent;while(r){Lt.mul(t,t,r.lscale);Lt.transformQuat(t,t,r.lrot);Lt.add(t,t,r.lpos);It.mul(n,r.lrot,n);r=r._parent}};Cr.prototype._getWorldPRS=function e(t,n,r){Lt.copy(t,this.lpos);It.copy(n,this.lrot);Lt.copy(r,this.lscale);var i=this._parent;while(i){Lt.mul(t,t,i.lscale);Lt.transformQuat(t,t,i.lrot);Lt.add(t,t,i.lpos);It.mul(n,i.lrot,n);Lt.mul(r,i.lscale,r);i=i._parent}};Object.defineProperties(Cr.prototype,Or);function Ir(e,t,n){if(n===void 0)n=0;n+=1;var r=e.children.length;for(var i=0;i<r;++i){var a=e.children[i];var o=t(a,e,n);if(o===false){break}Ir(a,t,n)}}function Ur(e,t,n,r){if(r===void 0)r=0;r+=1;var i=e.children.length;for(var a=0;a<i;++a){var o=e.children[a];var s=t(o,e,r);if(s===false){n(o,e,r);break}Ur(o,t,n,r);n(o,e,r)}}function Pr(e,t,n){if(n===void 0)n=0;n+=1;var r=e.children.length;for(var i=0;i<r;++i){var a=e.children[i];var o=t(a,e,n);if(o!==false){Pr(a,t,n)}}}function Br(e){var t=[];t.push(e);Ir(e,function(e){t.push(e)});return t}function Dr(e,t){t.remove();var n=e._parent;if(!n){return}e._parent=null;t._parent=n;var r=n._children.length;for(var i=0;i<r;++i){if(n._children[i]===e){n._children[i]=t;return}}}function Fr(e,t,n){if(t===void 0)t=Cr;if(n===void 0)n=null;var r=new t;r.name=e.name;Lt.copy(r.lpos,e.lpos);Lt.copy(r.lscale,e.lscale);It.copy(r.lrot,e.lrot);if(n){n(r,e)}return r}function zr(e,t,n){if(t===void 0)t=Cr;if(n===void 0)n=null;var r=Fr(e,t,n);r._children=new Array(e._children.length);for(var i=0;i<e._children.length;++i){var a=e._children[i];var o=zr(a,t,n);r._children[i]=o;o._parent=r}return r}function Nr(e,t){var o=t.split("/");function s(e,t){var n=e.children.length;var r=o[t];for(var i=0;i<n;++i){var a=e.children[i];if(a.name!==r){continue}if(t===o.length-1){return a}else{return s(a,t+1)}}return null}return s(e,0)}var kr={walk:Ir,walk2:Ur,walkSibling:Pr,flat:Br,replace:Dr,clone:Fr,deepClone:zr,find:Nr};var Vr=function e(){this._lights=new lr(16);this._models=new lr(16);this._cameras=new lr(16);this._debugCamera=null;this._views=[]};Vr.prototype._add=function e(t,n){if(n._poolID!==-1){return}t.push(n);n._poolID=t.length-1};Vr.prototype._remove=function e(t,n){if(n._poolID===-1){return}t.data[t.length-1]._poolID=n._poolID;t.fastRemove(n._poolID);n._poolID=-1};Vr.prototype.reset=function e(){var t=this;for(var n=0;n<this._models.length;++n){var r=t._models.data[n];r._viewID=-1}};Vr.prototype.setDebugCamera=function e(t){this._debugCamera=t};Vr.prototype.getCameraCount=function e(){return this._cameras.length};Vr.prototype.getCamera=function e(t){return this._cameras.data[t]};Vr.prototype.addCamera=function e(t){this._add(this._cameras,t)};Vr.prototype.removeCamera=function e(t){this._remove(this._cameras,t)};Vr.prototype.getModelCount=function e(){return this._models.length};Vr.prototype.getModel=function e(t){return this._models.data[t]};Vr.prototype.addModel=function e(t){this._add(this._models,t)};Vr.prototype.removeModel=function e(t){this._remove(this._models,t)};Vr.prototype.raycast=function e(t,n,r){var i=this;if(r===void 0)r=Infinity;var a=Infinity,o=a;var s=Lt.zero();for(var l=0;l<this.getModelCount();l++){var u=i.getModel(l);if(!Tr.check(u._node.layer,Tr.RaycastMask)){continue}if(!ln.ray_box(n,u._boundingBox,s)){continue}o=Lt.sqrDist(s,n.o);if(o>r*r||o>a){continue}a=o;t.entity=u._node}return a<Infinity};Vr.prototype.getLightCount=function e(){return this._lights.length};Vr.prototype.getLight=function e(t){return this._lights.data[t]};Vr.prototype.addLight=function e(t){this._add(this._lights,t)};Vr.prototype.removeLight=function e(t){this._remove(this._lights,t)};Vr.prototype.addView=function e(t){if(this._views.indexOf(t)===-1){this._views.push(t)}};Vr.prototype.removeView=function e(t){var n=this._views.indexOf(t);if(n!==-1){this._views.splice(n,1)}};var Wr=function(e){function t(){e.call(this);this._type="line-batch";this._lines=new pr(function(){return{start:Lt.zero(),end:Lt.zero(),color:Dt.create(),normal:Lt.zero()}},2e3)}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;var n={vertCount:{configurable:true},lineCount:{configurable:true}};n.vertCount.get=function(){return this._lines.length*2};n.lineCount.get=function(){return this._lines.length};t.prototype.getLine=function e(t){return this._lines.data[t]};t.prototype.addLine=function e(t,n,r,i){var a=this._lines.add();Lt.copy(a.start,t);Lt.copy(a.end,n);if(r){Dt.copy(a.color,r)}if(i){Lt.copy(a.normal,i)}return a};t.prototype.clear=function e(){this._lines.reset()};Object.defineProperties(t.prototype,n);return t}(qn);var Gr=function(e){function t(){e.call(this);this._type="sprite-batch";this._sprites=new pr(function(){return{refPositions:null,refUVs:null,refColor:null,refIndices:null}},2e3);this._vertCount=0;this._indexCount=0}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;var n={vertCount:{configurable:true},indexCount:{configurable:true},spriteCount:{configurable:true}};n.vertCount.get=function(){return this._vertCount};n.indexCount.get=function(){return this._indexCount};n.spriteCount.get=function(){return this._sprites.length};t.prototype.getSprite=function e(t){return this._sprites.data[t]};t.prototype.addSprite=function e(t,n,r,i){var a=this._sprites.add();a.refPositions=t;a.refUVs=n;a.refColor=r;a.refIndices=i;this._vertCount+=t.length;this._indexCount+=i.length;return a};t.prototype.clear=function e(){this._sprites.reset();this._vertCount=0;this._indexCount=0};Object.defineProperties(t.prototype,n);return t}(qn);function Hr(e){var t=new Ae.VertexBuffer(e._device,new Ae.VertexFormat(e._vertAttrs),Ae.USAGE_DYNAMIC,null,e._capacity*4);var n=new Array(e._capacity);var r=0;for(var i=0;i<e._capacity;++i){var a=4*i;n[r++]=a;n[r++]=a+1;n[r++]=a+2;n[r++]=a+3;n[r++]=a+2;n[r++]=a+1}var o=new Ae.IndexBuffer(e._device,Ae.INDEX_FMT_UINT16,Ae.USAGE_STATIC,new Uint16Array(n),n.length);e._ia=new Re(t,o)}var jr=function(r){function e(e,t,n){r.call(this);this._type="particle-batch";this._device=e;this._capacity=t;this.setVertexAttributes(n)}if(r)e.__proto__=r;e.prototype=Object.create(r&&r.prototype);e.prototype.constructor=e;e.prototype.setVertexAttributes=function e(t){this._vertAttrs=t;Hr(this);this._vertAttrsSize=this._ia._vertexBuffer._format._bytes/4;this._vdataF32=new Float32Array(this._capacity*4*this._vertAttrsSize)};e.prototype.enableStretchedBillboard=function e(){if(this._vertAttrs.find(function(e){return e.name===Ae.ATTR_COLOR0})===undefined){this._vertAttrs.push({name:Ae.ATTR_COLOR0,type:Ae.ATTR_TYPE_FLOAT32,num:3});this.setVertexAttributes(this._vertAttrs)}};e.prototype.disableStretchedBillboard=function e(){if(this._vertAttrs.find(function(e){return e.name===Ae.ATTR_COLOR0})!==undefined){this._vertAttrs.pop();this.setVertexAttributes(this._vertAttrs)}};e.prototype.addParticleVertexData=function e(t,n){var r=this;var i=t*this._vertAttrsSize;for(var a=0;a<this._vertAttrs.length;++a){var o=r._vertAttrs[a];if(o.num===1){r._vdataF32[i]=n[a];i++}else if(o.num===2){r._vdataF32[i]=n[a].x;r._vdataF32[i+1]=n[a].y;i+=2}else if(o.num===3){r._vdataF32[i]=n[a].x;r._vdataF32[i+1]=n[a].y;r._vdataF32[i+2]=n[a].z;i+=3}else if(o.num===4){r._vdataF32[i]=n[a].x;r._vdataF32[i+1]=n[a].y;r._vdataF32[i+2]=n[a].z;r._vdataF32[i+3]=n[a].w;i+=4}else{console.error("particle vertex attribute format not support")}}};e.prototype.updateIA=function e(t){this._ia._count=t;this._ia._vertexBuffer.update(0,this._vdataF32)};e.prototype.clear=function e(){this._ia._count=0};e.prototype.destroy=function e(){this._vdataF32=null;this._ia._vertexBuffer.destroy();this._ia._indexBuffer.destroy()};return e}(qn);var qr=function(e){function t(){e.call(this);this._type="skinning";this._jointsTexture=null;this._jointsMatrixArray=null}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.setJointsTexture=function e(t){this._jointsTexture=t};t.prototype.setJointsMatrixArray=function e(t){this._jointsMatrixArray=t};return t}(qn);var Xr={"common.frag":"\n#define PI 3.14159265359\n#define PI2 6.28318530718\n#define EPSILON 1e-6\n#define LOG2 1.442695\n#define saturate(a) clamp( a, 0.0, 1.0 )","gamma-correction.frag":"\nvec3 gammaToLinearSpaceRGB(vec3 sRGB) { \n  return sRGB * (sRGB * (sRGB * 0.305306011 + 0.682171111) + 0.012522878);\n}\nvec3 linearToGammaSpaceRGB(vec3 RGB) { \n  vec3 S1 = sqrt(RGB);\n  vec3 S2 = sqrt(S1);\n  vec3 S3 = sqrt(S2);\n  return 0.585122381 * S1 + 0.783140355 * S2 - 0.368262736 * S3;\n}\nvec4 gammaToLinearSpaceRGBA(vec4 sRGBA) {\n  return vec4(gammaToLinearSpaceRGB(sRGBA.rgb), sRGBA.a);\n}\nvec4 linearToGammaSpaceRGBA(vec4 RGBA) {\n  return vec4(linearToGammaSpaceRGB(RGBA.rgb), RGBA.a);\n}\nfloat gammaToLinearSpaceExact(float val) {\n  if (val <= 0.04045) {\n    return val / 12.92;\n  } else if (val < 1.0) {\n    return pow((val + 0.055) / 1.055, 2.4);\n  } else {\n    return pow(val, 2.2);\n  }\n}\nfloat linearToGammaSpaceExact(float val) {\n  if (val <= 0.0) {\n    return 0.0;\n  } else if (val <= 0.0031308) {\n    return 12.92 * val;\n  } else if (val < 1.0) {\n    return 1.055 * pow(val, 0.4166667) - 0.055;\n  } else {\n    return pow(val, 0.45454545);\n  }\n}","packing.frag":"\nvec4 packDepthToRGBA(float depth) {\n  vec4 ret = vec4(1.0, 255.0, 65025.0, 160581375.0) * depth;\n  ret = fract(ret);\n  ret -= ret.yzww * vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0, 0.0);\n  return ret;\n}\nfloat unpackRGBAToDepth(vec4 color) {\n  return dot(color, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n}","pbr-lighting.frag":"\nstruct LightInfo {\n  vec3 lightDir;\n  vec3 radiance;\n};\n#if NUM_DIR_LIGHTS > 0\n  #pragma for id in range(0, NUM_DIR_LIGHTS)\n    uniform vec3 dir_light{id}_direction;\n    uniform vec3 dir_light{id}_color;\n  #pragma endFor\n#endif\n#if NUM_POINT_LIGHTS > 0\n  #pragma for id in range(0, NUM_POINT_LIGHTS)\n    uniform vec3 point_light{id}_position;\n    uniform vec3 point_light{id}_color;\n    uniform float point_light{id}_range;\n  #pragma endFor\n#endif\n#if NUM_SPOT_LIGHTS > 0\n  #pragma for id in range(0, NUM_SPOT_LIGHTS)\n    uniform vec3 spot_light{id}_position;\n    uniform vec3 spot_light{id}_direction;\n    uniform vec3 spot_light{id}_color;\n    uniform vec2 spot_light{id}_spot;\n    uniform float spot_light{id}_range;\n  #pragma endFor\n#endif\nLightInfo computeDirectionalLighting(\n  vec3 lightDirection,\n  vec3 lightColor\n) {\n  LightInfo ret;\n  ret.lightDir = -normalize(lightDirection);\n  ret.radiance = lightColor;\n  return ret;\n}\nLightInfo computePointLighting(\n  vec3 lightPosition,\n  vec3 positionW,\n  vec3 lightColor,\n  float lightRange\n) {\n  LightInfo ret;\n  vec3 lightDir = lightPosition - positionW;\n  float attenuation = max(0.0, 1.0 - length(lightDir) / lightRange);\n  ret.lightDir = normalize(lightDir);\n  ret.radiance = lightColor * attenuation;\n  return ret;\n}\nLightInfo computeSpotLighting(\n  vec3 lightPosition,\n  vec3 positionW,\n  vec3 lightDirection,\n  vec3 lightColor,\n  vec2 lightSpot,\n  float lightRange\n) {\n  LightInfo ret;\n  vec3 lightDir = lightPosition - positionW;\n  float attenuation = max(0., 1.0 - length(lightDir) / lightRange);\n  float cosConeAngle = max(0., dot(lightDirection, -lightDir));\n  cosConeAngle = cosConeAngle < lightSpot.x ? 0.0 : cosConeAngle;\n  cosConeAngle = pow(cosConeAngle,lightSpot.y);\n  ret.lightDir = normalize(lightDir);\n  ret.radiance = lightColor * attenuation * cosConeAngle;\n  return ret;\n}","phong-lighting.frag":"\nstruct LightInfo {\n  vec3 diffuse;\n  vec3 specular;\n};\nLightInfo computeDirectionalLighting(\n  vec3 lightDirection,\n  vec3 lightColor,\n  vec3 normal,\n  vec3 viewDirection,\n  float glossiness\n) {\n  LightInfo lightingResult;\n  float ndl = 0.0;\n  float ndh = 0.0;\n  vec3 lightDir = -normalize(lightDirection);\n  ndl = max(0.0, dot(normal, lightDir));\n  lightingResult.diffuse = lightColor * ndl;\n  vec3 dirH = normalize(viewDirection + lightDir);\n  ndh = max(0.0, dot(normal, dirH));\n  ndh = (ndl == 0.0) ? 0.0: ndh;\n  ndh = pow(ndh, max(1.0, glossiness * 128.0));\n  lightingResult.specular = lightColor * ndh;\n  return lightingResult;\n}\nLightInfo computePointLighting(\n  vec3 lightPosition,\n  vec3 lightColor,\n  float lightRange,\n  vec3 normal,\n  vec3 positionW,\n  vec3 viewDirection,\n  float glossiness\n) {\n  LightInfo lightingResult;\n  float ndl = 0.0;\n  float ndh = 0.0;\n  vec3 lightDir = vec3(0, 0, 0);\n  float attenuation = 1.0;\n  lightDir = lightPosition - positionW;\n  attenuation = max(0., 1.0 - length(lightDir) / lightRange);\n  lightDir = normalize(lightDir);\n  ndl = max(0.0, dot(normal, lightDir));\n  lightingResult.diffuse = lightColor * ndl * attenuation;\n  vec3 dirH = normalize(viewDirection + lightDir);\n  ndh = max(0.0, dot(normal, dirH));\n  ndh = (ndl == 0.0) ? 0.0: ndh;\n  ndh = pow(ndh, max(1.0, glossiness * 128.0));\n  lightingResult.specular = lightColor * ndh * attenuation;\n  return lightingResult;\n}\nLightInfo computeSpotLighting(\n  vec3 lightPosition,\n  vec3 lightDirection,\n  vec3 lightColor,\n  float lightRange,\n  vec2 lightSpot,\n  vec3 normal,\n  vec3 positionW,\n  vec3 viewDirection,\n  float glossiness\n) {\n  LightInfo lightingResult;\n  float ndl = 0.0;\n  float ndh = 0.0;\n  vec3 lightDir = vec3(0, 0, 0);\n  float attenuation = 1.0;\n  float cosConeAngle = 1.0;\n  lightDir = lightPosition - positionW;\n  attenuation = max(0., 1.0 - length(lightDir) / lightRange);\n  lightDir = normalize(lightDir);\n  cosConeAngle = max(0., dot(lightDirection, -lightDir));\n  cosConeAngle = cosConeAngle < lightSpot.x ? 0.0 : cosConeAngle;\n  cosConeAngle = pow(cosConeAngle,lightSpot.y);\n  ndl = max(0.0, dot(normal, lightDir));\n  lightingResult.diffuse = lightColor * ndl * attenuation * cosConeAngle;\n  vec3 dirH = normalize(viewDirection + lightDir);\n  ndh = max(0.0, dot(normal, dirH));\n  ndh = (ndl == 0.0) ? 0.0: ndh;\n  ndh = pow(ndh, max(1.0, glossiness * 128.0));\n  lightingResult.specular = lightColor * ndh * attenuation * cosConeAngle;\n  return lightingResult;\n}\n#if NUM_DIR_LIGHTS > 0\n  #pragma for id in range(0, NUM_DIR_LIGHTS)\n    uniform vec3 dir_light{id}_direction;\n    uniform vec3 dir_light{id}_color;\n  #pragma endFor\n#endif\n#if NUM_POINT_LIGHTS > 0\n  #pragma for id in range(0, NUM_POINT_LIGHTS)\n    uniform vec3 point_light{id}_position;\n    uniform vec3 point_light{id}_color;\n    uniform float point_light{id}_range;\n  #pragma endFor\n#endif\n#if NUM_SPOT_LIGHTS > 0\n  #pragma for id in range(0, NUM_SPOT_LIGHTS)\n    uniform vec3 spot_light{id}_position;\n    uniform vec3 spot_light{id}_direction;\n    uniform vec3 spot_light{id}_color;\n    uniform float spot_light{id}_range;\n    uniform vec2 spot_light{id}_spot;\n  #pragma endFor\n#endif\nLightInfo getPhongLighting(\n  vec3 normal,\n  vec3 positionW,\n  vec3 viewDirection,\n  float glossiness\n) {\n  LightInfo result;\n  result.diffuse = vec3(0, 0, 0);\n  result.specular = vec3(0, 0, 0);\n  LightInfo dirLighting;\n  #if NUM_DIR_LIGHTS > 0\n    #pragma for id in range(0, NUM_DIR_LIGHTS)\n      dirLighting = computeDirectionalLighting(dir_light{id}_direction,dir_light{id}_color,normal, viewDirection, glossiness);\n      result.diffuse += dirLighting.diffuse;\n      result.specular += dirLighting.specular;\n    #pragma endFor\n  #endif\n  LightInfo pointLighting;\n  #if NUM_POINT_LIGHTS > 0\n    #pragma for id in range(0, NUM_POINT_LIGHTS)\n      pointLighting = computePointLighting(point_light{id}_position, point_light{id}_color, point_light{id}_range,\n                                          normal, positionW, viewDirection, glossiness);\n      result.diffuse += pointLighting.diffuse;\n      result.specular += pointLighting.specular;\n    #pragma endFor\n  #endif\n  LightInfo spotLighting;\n  #if NUM_SPOT_LIGHTS > 0\n    #pragma for id in range(0, NUM_SPOT_LIGHTS)\n      spotLighting = computeSpotLighting(spot_light{id}_position, spot_light{id}_direction, spot_light{id}_color,\n                      spot_light{id}_range, spot_light{id}_spot,normal, positionW, viewDirection, glossiness);\n      result.diffuse += spotLighting.diffuse;\n      result.specular += spotLighting.specular;\n    #pragma endFor\n  #endif\n  return result;\n}\n","shadow-mapping.frag":"\n#if NUM_SHADOW_LIGHTS > 0\n  #pragma for id in range(0, NUM_SHADOW_LIGHTS)\n    uniform sampler2D shadowMap_{id};\n    uniform float darkness_{id};\n    uniform float depthScale_{id};\n    uniform float frustumEdgeFalloff_{id};\n    uniform float bias_{id};\n    uniform vec2 texelSize_{id};\n    varying vec4 pos_lightspace_{id};\n    varying float vDepth_{id};\n  #pragma endFor\n#endif\nfloat computeShadow(sampler2D shadowMap, vec4 pos_lightspace, float bias) {\n  vec3 projCoords = pos_lightspace.xyz / pos_lightspace.w;\n  projCoords = projCoords * 0.5 + 0.5;\n  float closestDepth = unpackRGBAToDepth(texture2D(shadowMap, projCoords.xy));\n  float currentDepth = projCoords.z;\n  float shadow = (currentDepth - bias > closestDepth) ? 0.0 : 1.0;\n  return shadow;\n}\nfloat computeFallOff(float esm, vec2 coords, float frustumEdgeFalloff) {\n  float mask = smoothstep(1.0 - frustumEdgeFalloff, 1.0, clamp(dot(coords, coords), 0.0, 1.0));\n  return mix(esm, 1.0, mask);\n}\nfloat computeShadowESM(sampler2D shadowMap, vec4 pos_lightspace, float vDepth, float depthScale, float darkness, float frustumEdgeFalloff) {\n  vec2 projCoords = pos_lightspace.xy / pos_lightspace.w;\n  vec2 shadowUV = projCoords * 0.5 + vec2(0.5);\n  if (shadowUV.x < 0.0 || shadowUV.x > 1.0 || shadowUV.y < 0.0 || shadowUV.y > 1.0) {\n    return 1.0;\n  }\n  float currentDepth = clamp(vDepth, 0.0, 1.0);\n  float closestDepth = unpackRGBAToDepth(texture2D(shadowMap, shadowUV));\n  \n  float esm = clamp(exp(-depthScale * (currentDepth - closestDepth)), 1.0 - darkness, 1.0);\n  return computeFallOff(esm, projCoords, frustumEdgeFalloff);\n}\nfloat computeShadowPCF(sampler2D shadowMap, vec4 pos_lightspace, float vDepth, float darkness, vec2 texelSize, float frustumEdgeFalloff) {\n  vec2 projCoords = pos_lightspace.xy / pos_lightspace.w;\n  vec2 shadowUV = projCoords * 0.5 + vec2(0.5);\n  if (shadowUV.x < 0.0 || shadowUV.x > 1.0 || shadowUV.y < 0.0 || shadowUV.y > 1.0) {\n    return 1.0;\n  }\n  float currentDepth = clamp(vDepth, 0.0, 1.0);\n  float visibility = 1.0;\n  vec2 poissonDisk[4];\n  poissonDisk[0] = vec2(-0.94201624, -0.39906216);\n  poissonDisk[1] = vec2(0.94558609, -0.76890725);\n  poissonDisk[2] = vec2(-0.094184101, -0.92938870);\n  poissonDisk[3] = vec2(0.34495938, 0.29387760);\n  if (unpackRGBAToDepth(texture2D(shadowMap, shadowUV + poissonDisk[0] * texelSize)) < currentDepth) visibility -= 0.25;\n  if (unpackRGBAToDepth(texture2D(shadowMap, shadowUV + poissonDisk[1] * texelSize)) < currentDepth) visibility -= 0.25;\n  if (unpackRGBAToDepth(texture2D(shadowMap, shadowUV + poissonDisk[2] * texelSize)) < currentDepth) visibility -= 0.25;\n  if (unpackRGBAToDepth(texture2D(shadowMap, shadowUV + poissonDisk[3] * texelSize)) < currentDepth) visibility -= 0.25;\n  return computeFallOff(min(1.0, visibility + 1.0 - darkness), projCoords, frustumEdgeFalloff);\n}","skinning.vert":"\nattribute vec4 a_weights;\nattribute vec4 a_joints;\n#if USE_JOINTS_TEXTURE\nuniform sampler2D u_jointsTexture;\nuniform float u_jointsTextureSize;\nmat4 getBoneMatrix(const in float i) {\n  float size = u_jointsTextureSize;\n  float j = i * 4.0;\n  float x = mod(j, size);\n  float y = floor(j / size);\n  float dx = 1.0 / size;\n  float dy = 1.0 / size;\n  y = dy * (y + 0.5);\n  vec4 v1 = texture2D(u_jointsTexture, vec2(dx * (x + 0.5), y));\n  vec4 v2 = texture2D(u_jointsTexture, vec2(dx * (x + 1.5), y));\n  vec4 v3 = texture2D(u_jointsTexture, vec2(dx * (x + 2.5), y));\n  vec4 v4 = texture2D(u_jointsTexture, vec2(dx * (x + 3.5), y));\n  return mat4(v1, v2, v3, v4);\n}\n#else\nuniform mat4 u_jointMatrices[128];\nmat4 getBoneMatrix(const in float i) {\n  return u_jointMatrices[int(i)];\n}\n#endif\nmat4 skinMatrix() {\n  return\n    getBoneMatrix(a_joints.x) * a_weights.x +\n    getBoneMatrix(a_joints.y) * a_weights.y +\n    getBoneMatrix(a_joints.z) * a_weights.z +\n    getBoneMatrix(a_joints.w) * a_weights.w\n    ;\n}","unpack.frag":"\nvec3 unpackNormal(vec4 nmap) {\n  return nmap.xyz * 2.0 - 1.0;\n}\nvec3 unpackRGBE(vec4 rgbe) {\n    return rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}"};var Yr=[{name:"gaussian-blur",vert:"\nattribute vec2 a_position;\nattribute vec2 a_uv0;\nvarying vec2 uv;\nvoid main() {\n  uv = a_uv0;\n  gl_Position = vec4(a_position.x, a_position.y, 0.0, 1.0);\n}",frag:"\nvarying vec2 uv;\nuniform sampler2D texture;\nuniform vec2 pixelSize;\n\nvec4 packDepthToRGBA(float depth) {\n  vec4 ret = vec4(1.0, 255.0, 65025.0, 160581375.0) * depth;\n  ret = fract(ret);\n  ret -= ret.yzww * vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0, 0.0);\n  return ret;\n}\nfloat unpackRGBAToDepth(vec4 color) {\n  return dot(color, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n}\nfloat kGaussianBlur[10];\nfloat log_conv(float x0, float X, float y0, float Y) {\n  return ( X + log( x0 + (y0 * exp(Y - X) ) ) );\n}\nvoid main() {\n  kGaussianBlur[0] = 0.0882357;\n  kGaussianBlur[1] = 0.0957407;\n  kGaussianBlur[2] = 0.101786;\n  kGaussianBlur[3] = 0.106026;\n  kGaussianBlur[4] = 0.108212;\n  kGaussianBlur[5] = 0.108212;\n  kGaussianBlur[6] = 0.106026;\n  kGaussianBlur[7] = 0.101786;\n  kGaussianBlur[8] = 0.0957407;\n  kGaussianBlur[9] = 0.0882357;\n  float sample[10];\n  for (int i = 0; i < 10; ++i) {\n    float offset = float(i) - 4.5;\n    vec2 texCoord = vec2( uv.x + offset * pixelSize.x, uv.y + offset * pixelSize.y);\n    sample[i] = unpackRGBAToDepth(texture2D(texture, texCoord));\n  }\n  float sum = log_conv(kGaussianBlur[0], sample[0], kGaussianBlur[1], sample[1]);\n  for (int i = 2; i < 10; ++i) {\n    sum = log_conv(1.0, sum, kGaussianBlur[i], sample[i]);\n  }\n  gl_FragColor = packDepthToRGBA(sum);\n}\n",defines:[]},{name:"grid",vert:"\nattribute vec2 a_uv0;\nattribute vec3 a_position;\nattribute vec3 a_normal;\nuniform mat4 model;\nuniform mat4 viewProj;\nvarying vec2 uv0;\nvarying vec4 pos_w;\n#if USE_WORLD_POS\n  uniform mat3 normalMatrix;\n  varying vec3 normal_w;\n#endif\nvoid main () {\n  uv0 = a_uv0;\n  pos_w = model * vec4(a_position, 1);\n  #if USE_WORLD_POS\n    normal_w = normalMatrix * a_normal;\n  #endif\n  gl_Position = viewProj * pos_w;\n}",frag:"\nvarying vec2 uv0;\nvarying vec4 pos_w;\n#if USE_WORLD_POS\n  varying vec3 normal_w;\n#endif\nuniform vec2 tiling;\nuniform vec3 baseColorWhite;\nuniform vec3 baseColorBlack;\nuniform sampler2D basePattern;\nuniform vec2 basePatternTiling;\nuniform vec2 basePatternOffset;\nuniform vec4 subPatternColor;\nuniform sampler2D subPattern;\nuniform vec2 subPatternTiling;\nuniform vec2 subPatternOffset;\nuniform vec4 subPatternColor2;\nuniform sampler2D subPattern2;\nuniform vec2 subPattern2Tiling;\nuniform vec2 subPattern2Offset;\nvoid main () {\n  vec2 uv = uv0 * tiling;\n  vec2 uvBase = uv * basePatternTiling + basePatternOffset;\n  vec2 uvSub = uv * subPatternTiling + subPatternOffset;\n  vec2 uvSub2 = uv * subPattern2Tiling + subPattern2Offset;\n  #if USE_WORLD_POS\n    vec3 dnormal_w = normalize(normal_w);\n    if (abs(dnormal_w.x)>0.5) { \n      uvBase = (pos_w.zy * tiling * basePatternTiling) + basePatternOffset;\n      uvSub = (pos_w.zy * tiling * subPatternTiling) + subPatternOffset;\n      uvSub2 = (pos_w.zy * tiling * subPattern2Tiling) + subPattern2Offset;\n    } else if (abs(dnormal_w.z)>0.5) { \n      uvBase = (pos_w.xy * tiling * basePatternTiling) + basePatternOffset;\n      uvSub = (pos_w.xy * tiling * subPatternTiling) + subPatternOffset;\n      uvSub2 = (pos_w.xy * tiling * subPattern2Tiling) + subPattern2Offset;\n    } else { \n      uvBase = (pos_w.xz * tiling * basePatternTiling) + basePatternOffset;\n      uvSub = (pos_w.xz * tiling * subPatternTiling) + subPatternOffset;\n      uvSub2 = (pos_w.xz * tiling * subPattern2Tiling) + subPattern2Offset;\n    }\n  #endif\n  vec4 texColBase = texture2D(basePattern, uvBase);\n  vec4 texColSub = texture2D(subPattern, uvSub);\n  vec4 texColSub2 = texture2D(subPattern2, uvSub2);\n  \n  \n  \n  vec4 color = vec4(baseColorWhite,1) * texColBase + vec4(baseColorBlack,1) * (1.0-texColBase);\n  color =\n    color * (1.0 - texColSub) +\n    (subPatternColor * subPatternColor.a + color * (1.0-subPatternColor.a)) * texColSub\n    ;\n  color =\n    color * (1.0 - texColSub2) +\n    (subPatternColor2 * subPatternColor2.a + color * (1.0-subPatternColor2.a)) * texColSub2\n    ;\n  \n  \n  gl_FragColor = color;\n}",defines:[{name:"USE_WORLD_POS"}]},{name:"line",vert:"\nattribute vec3 a_position;\nattribute vec3 a_color;\nuniform mat4 model;\nuniform mat4 viewProj;\nvarying vec3 color;\nvoid main () {\n  vec4 pos = viewProj * model * vec4(a_position, 1);\n  \n  \n  \n  \n  \n  \n  \n  \n  \n  \n  \n  \n  \n  \n  \n  \n  color = a_color;\n  gl_Position = pos;\n}",frag:"\nvarying vec3 color;\nvoid main () {\n  gl_FragColor = vec4(color, 1.0);\n}",defines:[]},{name:"matcap",vert:"\nattribute vec3 a_position;\nattribute vec3 a_normal;\nuniform   mat4 model;\nuniform   mat4 viewProj;\nuniform   mat3 normalMatrix;\nvarying   vec2 matcapUV;\n#if USE_MAIN_TEX\n  attribute vec2 a_uv0;\n  varying   vec2 uv0;\n#endif\n#if USE_SKINNING\n  \nattribute vec4 a_weights;\nattribute vec4 a_joints;\n#if USE_JOINTS_TEXTURE\nuniform sampler2D u_jointsTexture;\nuniform float u_jointsTextureSize;\nmat4 getBoneMatrix(const in float i) {\n  float size = u_jointsTextureSize;\n  float j = i * 4.0;\n  float x = mod(j, size);\n  float y = floor(j / size);\n  float dx = 1.0 / size;\n  float dy = 1.0 / size;\n  y = dy * (y + 0.5);\n  vec4 v1 = texture2D(u_jointsTexture, vec2(dx * (x + 0.5), y));\n  vec4 v2 = texture2D(u_jointsTexture, vec2(dx * (x + 1.5), y));\n  vec4 v3 = texture2D(u_jointsTexture, vec2(dx * (x + 2.5), y));\n  vec4 v4 = texture2D(u_jointsTexture, vec2(dx * (x + 3.5), y));\n  return mat4(v1, v2, v3, v4);\n}\n#else\nuniform mat4 u_jointMatrices[128];\nmat4 getBoneMatrix(const in float i) {\n  return u_jointMatrices[int(i)];\n}\n#endif\nmat4 skinMatrix() {\n  return\n    getBoneMatrix(a_joints.x) * a_weights.x +\n    getBoneMatrix(a_joints.y) * a_weights.y +\n    getBoneMatrix(a_joints.z) * a_weights.z +\n    getBoneMatrix(a_joints.w) * a_weights.w\n    ;\n}\n#endif\nvoid main(void){\n  #if USE_MAIN_TEX\n    uv0 = a_uv0;\n  #endif\n  vec4 pos = vec4(a_position, 1);\n  #if USE_SKINNING\n    mat4 skinMat = skinMatrix();\n    pos = skinMat * pos;\n  #endif\n  pos = viewProj * model * pos;\n  gl_Position = pos;\n  vec4 normal = vec4(a_normal, 0);\n  #if USE_SKINNING\n    normal = skinMat * normal;\n  #endif\n  normal = vec4(normalize(normalMatrix * normal.xyz), 0);\n  matcapUV = normal.xy;\n  matcapUV = matcapUV * 0.5 + 0.5;\n}",frag:"\nprecision mediump float;\nuniform sampler2D matcapTex;\nuniform float colorFactor;\nuniform vec4 color;\nvarying vec2 matcapUV;\n#if USE_MAIN_TEX\n  varying vec2 uv0;\n  uniform sampler2D mainTex;\n#endif\nvoid main(void){\n  vec4 col = vec4(1, 1, 1, 1);\n  col *= color;\n  #if USE_MAIN_TEX\n    col *= texture2D(mainTex, uv0);\n  #endif\n  vec4 matcapColor = texture2D(matcapTex, matcapUV);\n  gl_FragColor = col * colorFactor + matcapColor * (1.0 - colorFactor);\n}",defines:[{name:"USE_MAIN_TEX"},{name:"USE_SKINNING"}]},{name:"particle-add-multiply",vert:"\nattribute vec3 a_position; \nattribute vec3 a_uv;  \nattribute vec2 a_uv0; \nattribute vec4 a_color;\n#if USE_STRETCHED_BILLBOARD\nattribute vec3 a_color0; \n#endif\nuniform vec2 frameTile; \nuniform vec2 mainTiling;\nuniform vec2 mainOffset;\nuniform mat4 model;\nuniform mat4 viewProj;\n#if USE_BILLBOARD || USE_VERTICAL_BILLBOARD\n  uniform mat4 view;\n#endif\n#if USE_STRETCHED_BILLBOARD\n  uniform vec3 eye;\n  uniform float velocityScale;\n  uniform float lengthScale;\n#endif\nvarying vec2 uv;\nvarying vec4 color;\nvoid main () {\n  vec4 pos = vec4(a_position, 1);\n#if USE_STRETCHED_BILLBOARD\n  vec4 velocity = vec4(a_color0.xyz,0);\n#endif\n#if USE_WORLD_SPACE\n  \n#else\n  pos = model * pos;\n  #if USE_STRETCHED_BILLBOARD\n  velocity = model * velocity;\n  #endif\n#endif\n  vec2 cornerOffset = vec2((a_uv.x - 0.5) * a_uv0.x, (a_uv.y - 0.5) * a_uv0.x); \n#if USE_STRETCHED_BILLBOARD\n  \n#else\n  \n  vec2 rotatedOffset;\n  rotatedOffset.x = cos(a_uv0.y) * cornerOffset.x - sin(a_uv0.y) * cornerOffset.y;\n  rotatedOffset.y = sin(a_uv0.y) * cornerOffset.x + cos(a_uv0.y) * cornerOffset.y;\n#endif\n#if USE_BILLBOARD\n  vec3 camRight = normalize(vec3(view[0][0], view[1][0], view[2][0]));\n  vec3 camUp = normalize(vec3(view[0][1], view[1][1], view[2][1]));\n  pos.xyz += (camRight * rotatedOffset.x) + (camUp * rotatedOffset.y);\n#elif USE_STRETCHED_BILLBOARD\n  vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz));\n  vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * a_uv0.x;\n  pos.xyz += (camRight * abs(cornerOffset.x) * sign(cornerOffset.y)) - camUp * a_uv.x;\n#elif USE_HORIZONTAL_BILLBOARD\n  vec3 camRight = vec3(1, 0, 0);\n  vec3 camUp = vec3(0, 0, -1);\n  pos.xyz += (camRight * rotatedOffset.x) + (camUp * rotatedOffset.y);\n#elif USE_VERTICAL_BILLBOARD\n  vec3 camRight = normalize(vec3(view[0][0], view[1][0], view[2][0]));\n  vec3 camUp = vec3(0, 1, 0);\n  pos.xyz += (camRight * rotatedOffset.x) + (camUp * rotatedOffset.y);\n#else\n  pos.x += rotatedOffset.x;\n  pos.y += rotatedOffset.y;\n#endif\n  pos = viewProj * pos;\n  vec2 aniUV = vec2(0, floor(a_uv.z * frameTile.y));\n  aniUV.x = floor(a_uv.z * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n  aniUV.y = frameTile.y - aniUV.y - 1.0;\n  aniUV = (aniUV.xy + a_uv.xy) / vec2(frameTile.x, frameTile.y);\n  uv = aniUV * mainTiling + mainOffset;\n  color = a_color;\n  gl_Position = pos;\n}",frag:"\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvarying vec2 uv;\nvarying vec4 color;\nvoid main () {\n  \n  vec4 col;\n  vec4 texColor = texture2D(mainTexture, uv);\n  col.rgb = tintColor.rgb * texColor.rgb * color.rgb * vec3(2.0);\n  col.a = (1.0 - texColor.a) * (tintColor.a * color.a * 2.0);\n  gl_FragColor = col;\n}",defines:[{name:"USE_SOFT_PARTICLE"},{name:"USE_BILLBOARD"},{name:"USE_STRETCHED_BILLBOARD"},{name:"USE_HORIZONTAL_BILLBOARD"},{name:"USE_VERTICAL_BILLBOARD"},{name:"USE_WORLD_SPACE"}]},{name:"particle-add-smooth",vert:"\nattribute vec3 a_position; \nattribute vec3 a_uv;  \nattribute vec2 a_uv0; \nattribute vec4 a_color;\n#if USE_STRETCHED_BILLBOARD\nattribute vec3 a_color0; \n#endif\nuniform vec2 frameTile;\nuniform vec2 mainTiling;\nuniform vec2 mainOffset;\nuniform mat4 model;\nuniform mat4 viewProj;\n#if USE_BILLBOARD || USE_VERTICAL_BILLBOARD\n  uniform mat4 view;\n#endif\n#if USE_STRETCHED_BILLBOARD\n  uniform vec3 eye;\n  uniform float velocityScale;\n  uniform float lengthScale;\n#endif\nvarying vec2 uv;\nvarying vec4 color;\nvoid main () {\n  vec4 pos = vec4(a_position, 1);\n#if USE_STRETCHED_BILLBOARD\n  vec4 velocity = vec4(a_color0.xyz,0);\n#endif\n#if USE_WORLD_SPACE\n  \n#else\n  pos = model * pos;\n  #if USE_STRETCHED_BILLBOARD\n  velocity = model * velocity;\n  #endif\n#endif\n  vec2 cornerOffset = vec2((a_uv.x - 0.5) * a_uv0.x, (a_uv.y - 0.5) * a_uv0.x);\n#if USE_STRETCHED_BILLBOARD\n  \n#else\n  \n  vec2 rotatedOffset;\n  rotatedOffset.x = cos(a_uv0.y) * cornerOffset.x - sin(a_uv0.y) * cornerOffset.y;\n  rotatedOffset.y = sin(a_uv0.y) * cornerOffset.x + cos(a_uv0.y) * cornerOffset.y;\n#endif\n#if USE_BILLBOARD\n  vec3 camRight = normalize(vec3(view[0][0], view[1][0], view[2][0]));\n  vec3 camUp = normalize(vec3(view[0][1], view[1][1], view[2][1]));\n  pos.xyz += (camRight * rotatedOffset.x) + (camUp * rotatedOffset.y);\n#elif USE_STRETCHED_BILLBOARD\n  vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz));\n  vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * a_uv0.x;\n  pos.xyz += (camRight * abs(cornerOffset.x) * sign(cornerOffset.y)) - camUp * a_uv.x;\n#elif USE_HORIZONTAL_BILLBOARD\n  vec3 camRight = vec3(1, 0, 0);\n  vec3 camUp = vec3(0, 0, -1);\n  pos.xyz += (camRight * rotatedOffset.x) + (camUp * rotatedOffset.y);\n#elif USE_VERTICAL_BILLBOARD\n  vec3 camRight = normalize(vec3(view[0][0], view[1][0], view[2][0]));\n  vec3 camUp = vec3(0, 1, 0);\n  pos.xyz += (camRight * rotatedOffset.x) + (camUp * rotatedOffset.y);\n#else\n  pos.x += rotatedOffset.x;\n  pos.y += rotatedOffset.y;\n#endif\n  pos = viewProj * pos;\n  vec2 aniUV = vec2(0, floor(a_uv.z * frameTile.y));\n  aniUV.x = floor(a_uv.z * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n  aniUV.y = frameTile.y - aniUV.y - 1.0;\n  aniUV = (aniUV.xy + a_uv.xy) / vec2(frameTile.x, frameTile.y);\n  uv = aniUV * mainTiling + mainOffset;\n  color = a_color;\n  gl_Position = pos;\n}",frag:"\nuniform sampler2D mainTexture;\nvarying vec2 uv;\nvarying vec4 color;\nvoid main () {\n  \n  vec4 col = color * texture2D(mainTexture, uv);\n  col.rgb *= col.a;\n  gl_FragColor = col;\n}",defines:[{name:"USE_SOFT_PARTICLE"},{name:"USE_BILLBOARD"},{name:"USE_STRETCHED_BILLBOARD"},{name:"USE_HORIZONTAL_BILLBOARD"},{name:"USE_VERTICAL_BILLBOARD"},{name:"USE_WORLD_SPACE"}]},{name:"particle-add",vert:"\nattribute vec3 a_position; \nattribute vec3 a_uv;  \nattribute vec2 a_uv0; \nattribute vec4 a_color;\n#if USE_STRETCHED_BILLBOARD\nattribute vec3 a_color0; \n#endif\nuniform vec2 frameTile;\nuniform vec2 mainTiling;\nuniform vec2 mainOffset;\nuniform mat4 model;\nuniform mat4 viewProj;\n#if USE_BILLBOARD || USE_VERTICAL_BILLBOARD\n  uniform mat4 view;\n#endif\n#if USE_STRETCHED_BILLBOARD\n  uniform vec3 eye;\n  uniform float velocityScale;\n  uniform float lengthScale;\n#endif\nvarying vec2 uv;\nvarying vec4 color;\nvoid main () {\n  vec4 pos = vec4(a_position, 1);\n#if USE_STRETCHED_BILLBOARD\n  vec4 velocity = vec4(a_color0.xyz,0);\n#endif\n#if USE_WORLD_SPACE\n  \n#else\n  pos = model * pos;\n  #if USE_STRETCHED_BILLBOARD\n  velocity = model * velocity;\n  #endif\n#endif\n  vec2 cornerOffset = vec2((a_uv.x - 0.5) * a_uv0.x, (a_uv.y - 0.5) * a_uv0.x);\n#if USE_STRETCHED_BILLBOARD\n  \n#else\n  \n  vec2 rotatedOffset;\n  rotatedOffset.x = cos(a_uv0.y) * cornerOffset.x - sin(a_uv0.y) * cornerOffset.y;\n  rotatedOffset.y = sin(a_uv0.y) * cornerOffset.x + cos(a_uv0.y) * cornerOffset.y;\n#endif\n#if USE_BILLBOARD\n  vec3 camRight = normalize(vec3(view[0][0], view[1][0], view[2][0]));\n  vec3 camUp = normalize(vec3(view[0][1], view[1][1], view[2][1]));\n  pos.xyz += (camRight * rotatedOffset.x) + (camUp * rotatedOffset.y);\n#elif USE_STRETCHED_BILLBOARD\n  vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz));\n  vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * a_uv0.x;\n  pos.xyz += (camRight * abs(cornerOffset.x) * sign(cornerOffset.y)) - camUp * a_uv.x;\n#elif USE_HORIZONTAL_BILLBOARD\n  vec3 camRight = vec3(1, 0, 0);\n  vec3 camUp = vec3(0, 0, -1);\n  pos.xyz += (camRight * rotatedOffset.x) + (camUp * rotatedOffset.y);\n#elif USE_VERTICAL_BILLBOARD\n  vec3 camRight = normalize(vec3(view[0][0], view[1][0], view[2][0]));\n  vec3 camUp = vec3(0, 1, 0);\n  pos.xyz += (camRight * rotatedOffset.x) + (camUp * rotatedOffset.y);\n#else\n  pos.x += rotatedOffset.x;\n  pos.y += rotatedOffset.y;\n#endif\n  pos = viewProj * pos;\n  vec2 aniUV = vec2(0, floor(a_uv.z * frameTile.y));\n  aniUV.x = floor(a_uv.z * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n  aniUV.y = frameTile.y - aniUV.y - 1.0;\n  aniUV = (aniUV.xy + a_uv.xy) / vec2(frameTile.x, frameTile.y);\n  uv = aniUV * mainTiling + mainOffset;\n  color = a_color;\n  gl_Position = pos;\n}",frag:"\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvarying vec2 uv;\nvarying vec4 color;\nvoid main () {\n  \n  gl_FragColor = 2.0 * color * tintColor * texture2D(mainTexture, uv);\n}",defines:[{name:"USE_SOFT_PARTICLE"},{name:"USE_BILLBOARD"},{name:"USE_STRETCHED_BILLBOARD"},{name:"USE_HORIZONTAL_BILLBOARD"},{name:"USE_VERTICAL_BILLBOARD"},{name:"USE_WORLD_SPACE"}]},{name:"particle-alpha-blend",vert:"\nattribute vec3 a_position; \nattribute vec3 a_uv;  \nattribute vec2 a_uv0; \nattribute vec4 a_color;\n#if USE_STRETCHED_BILLBOARD\nattribute vec3 a_color0; \n#endif\nuniform vec2 frameTile;\nuniform vec2 mainTiling;\nuniform vec2 mainOffset;\nuniform mat4 model;\nuniform mat4 viewProj;\n#if USE_BILLBOARD || USE_VERTICAL_BILLBOARD\n  uniform mat4 view;\n#endif\n#if USE_STRETCHED_BILLBOARD\n  uniform vec3 eye;\n  uniform float velocityScale;\n  uniform float lengthScale;\n#endif\nvarying vec2 uv;\nvarying vec4 color;\nvoid main () {\n  vec4 pos = vec4(a_position, 1);\n#if USE_STRETCHED_BILLBOARD\n  vec4 velocity = vec4(a_color0.xyz,0);\n#endif\n#if USE_WORLD_SPACE\n  \n#else\n  pos = model * pos;\n  #if USE_STRETCHED_BILLBOARD\n  velocity = model * velocity;\n  #endif\n#endif\n  vec2 cornerOffset = vec2((a_uv.x - 0.5) * a_uv0.x, (a_uv.y - 0.5) * a_uv0.x); \n#if USE_STRETCHED_BILLBOARD\n  \n#else\n  \n  vec2 rotatedOffset;\n  rotatedOffset.x = cos(a_uv0.y) * cornerOffset.x - sin(a_uv0.y) * cornerOffset.y;\n  rotatedOffset.y = sin(a_uv0.y) * cornerOffset.x + cos(a_uv0.y) * cornerOffset.y;\n#endif\n#if USE_BILLBOARD\n  vec3 camRight = normalize(vec3(view[0][0], view[1][0], view[2][0]));\n  vec3 camUp = normalize(vec3(view[0][1], view[1][1], view[2][1]));\n  pos.xyz += (camRight * rotatedOffset.x) + (camUp * rotatedOffset.y);\n#elif USE_STRETCHED_BILLBOARD\n  vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz));\n  vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * a_uv0.x;\n  pos.xyz += (camRight * abs(cornerOffset.x) * sign(cornerOffset.y)) - camUp * a_uv.x;\n#elif USE_HORIZONTAL_BILLBOARD\n  vec3 camRight = vec3(1, 0, 0);\n  vec3 camUp = vec3(0, 0, -1);\n  pos.xyz += (camRight * rotatedOffset.x) + (camUp * rotatedOffset.y);\n#elif USE_VERTICAL_BILLBOARD\n  vec3 camRight = normalize(vec3(view[0][0], view[1][0], view[2][0]));\n  vec3 camUp = vec3(0, 1, 0);\n  pos.xyz += (camRight * rotatedOffset.x) + (camUp * rotatedOffset.y);\n#else\n  pos.x += rotatedOffset.x;\n  pos.y += rotatedOffset.y;\n#endif\n  pos = viewProj * pos;\n  vec2 aniUV = vec2(0, floor(a_uv.z * frameTile.y));\n  aniUV.x = floor(a_uv.z * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n  aniUV.y = frameTile.y - aniUV.y - 1.0;\n  aniUV = (aniUV.xy + a_uv.xy) / vec2(frameTile.x, frameTile.y);\n  uv = aniUV * mainTiling + mainOffset;\n  color = a_color;\n  gl_Position = pos;\n}",frag:"\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvarying vec2 uv;\nvarying vec4 color;\nvoid main () {\n  \n  gl_FragColor = 2.0 * color * tintColor * texture2D(mainTexture, uv);\n}",defines:[{name:"USE_SOFT_PARTICLE"},{name:"USE_BILLBOARD"},{name:"USE_STRETCHED_BILLBOARD"},{name:"USE_HORIZONTAL_BILLBOARD"},{name:"USE_VERTICAL_BILLBOARD"},{name:"USE_WORLD_SPACE"}]},{name:"particle-premultiply-blend",vert:"\nattribute vec3 a_position; \nattribute vec3 a_uv;  \nattribute vec2 a_uv0; \nattribute vec4 a_color;\n#if USE_STRETCHED_BILLBOARD\nattribute vec3 a_color0; \n#endif\nuniform vec2 frameTile;\nuniform vec2 mainTiling;\nuniform vec2 mainOffset;\nuniform mat4 model;\nuniform mat4 viewProj;\n#if USE_BILLBOARD || USE_VERTICAL_BILLBOARD\n  uniform mat4 view;\n#endif\n#if USE_STRETCHED_BILLBOARD\n  uniform vec3 eye;\n  uniform float velocityScale;\n  uniform float lengthScale;\n#endif\nvarying vec2 uv;\nvarying vec4 color;\nvoid main () {\n  vec4 pos = vec4(a_position, 1);\n#if USE_STRETCHED_BILLBOARD\n  vec4 velocity = vec4(a_color0.xyz,0);\n#endif\n#if USE_WORLD_SPACE\n  \n#else\n  pos = model * pos;\n  #if USE_STRETCHED_BILLBOARD\n  velocity = model * velocity;\n  #endif\n#endif\n  vec2 cornerOffset = vec2((a_uv.x - 0.5) * a_uv0.x, (a_uv.y - 0.5) * a_uv0.x);\n#if USE_STRETCHED_BILLBOARD\n  \n#else\n  \n  vec2 rotatedOffset;\n  rotatedOffset.x = cos(a_uv0.y) * cornerOffset.x - sin(a_uv0.y) * cornerOffset.y;\n  rotatedOffset.y = sin(a_uv0.y) * cornerOffset.x + cos(a_uv0.y) * cornerOffset.y;\n#endif\n#if USE_BILLBOARD\n  vec3 camRight = normalize(vec3(view[0][0], view[1][0], view[2][0]));\n  vec3 camUp = normalize(vec3(view[0][1], view[1][1], view[2][1]));\n  pos.xyz += (camRight * rotatedOffset.x) + (camUp * rotatedOffset.y);\n#elif USE_STRETCHED_BILLBOARD\n  vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz));\n  vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * a_uv0.x;\n  pos.xyz += (camRight * abs(cornerOffset.x) * sign(cornerOffset.y)) - camUp * a_uv.x;\n#elif USE_HORIZONTAL_BILLBOARD\n  vec3 camRight = vec3(1, 0, 0);\n  vec3 camUp = vec3(0, 0, -1);\n  pos.xyz += (camRight * rotatedOffset.x) + (camUp * rotatedOffset.y);\n#elif USE_VERTICAL_BILLBOARD\n  vec3 camRight = normalize(vec3(view[0][0], view[1][0], view[2][0]));\n  vec3 camUp = vec3(0, 1, 0);\n  pos.xyz += (camRight * rotatedOffset.x) + (camUp * rotatedOffset.y);\n#else\n  pos.x += rotatedOffset.x;\n  pos.y += rotatedOffset.y;\n#endif\n  pos = viewProj * pos;\n  vec2 aniUV = vec2(0, floor(a_uv.z * frameTile.y));\n  aniUV.x = floor(a_uv.z * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n  aniUV.y = frameTile.y - aniUV.y - 1.0;\n  aniUV = (aniUV.xy + a_uv.xy) / vec2(frameTile.x, frameTile.y);\n  uv = aniUV * mainTiling + mainOffset;\n  color = a_color;\n  gl_Position = pos;\n}",frag:"\nuniform sampler2D mainTexture;\nvarying vec2 uv;\nvarying vec4 color;\nvoid main () {\n  \n  gl_FragColor = color * texture2D(mainTexture, uv) * color.a;\n}",defines:[{name:"USE_SOFT_PARTICLE"},{name:"USE_BILLBOARD"},{name:"USE_STRETCHED_BILLBOARD"},{name:"USE_HORIZONTAL_BILLBOARD"},{name:"USE_VERTICAL_BILLBOARD"},{name:"USE_WORLD_SPACE"}]},{name:"pbr",vert:"\nattribute vec3 a_position;\nattribute vec3 a_normal;\nvarying vec3 pos_w;\nvarying vec3 normal_w;\nuniform mat4 model;\nuniform mat4 viewProj;\nuniform mat3 normalMatrix;\n#if USE_NORMAL_TEXTURE || USE_ALBEDO_TEXTURE || USE_MRA_TEXTURE || USE_METALLIC_TEXTURE || USE_ROUGHNESS_TEXTURE || USE_AO_TEXTURE || USE_EMISSIVE_TEXTURE\n  attribute vec2 a_uv0;\n  uniform vec2 mainTiling;\n  uniform vec2 mainOffset;\n  varying vec2 uv0;\n#endif\n#if USE_SKINNING\n  \nattribute vec4 a_weights;\nattribute vec4 a_joints;\n#if USE_JOINTS_TEXTURE\nuniform sampler2D u_jointsTexture;\nuniform float u_jointsTextureSize;\nmat4 getBoneMatrix(const in float i) {\n  float size = u_jointsTextureSize;\n  float j = i * 4.0;\n  float x = mod(j, size);\n  float y = floor(j / size);\n  float dx = 1.0 / size;\n  float dy = 1.0 / size;\n  y = dy * (y + 0.5);\n  vec4 v1 = texture2D(u_jointsTexture, vec2(dx * (x + 0.5), y));\n  vec4 v2 = texture2D(u_jointsTexture, vec2(dx * (x + 1.5), y));\n  vec4 v3 = texture2D(u_jointsTexture, vec2(dx * (x + 2.5), y));\n  vec4 v4 = texture2D(u_jointsTexture, vec2(dx * (x + 3.5), y));\n  return mat4(v1, v2, v3, v4);\n}\n#else\nuniform mat4 u_jointMatrices[128];\nmat4 getBoneMatrix(const in float i) {\n  return u_jointMatrices[int(i)];\n}\n#endif\nmat4 skinMatrix() {\n  return\n    getBoneMatrix(a_joints.x) * a_weights.x +\n    getBoneMatrix(a_joints.y) * a_weights.y +\n    getBoneMatrix(a_joints.z) * a_weights.z +\n    getBoneMatrix(a_joints.w) * a_weights.w\n    ;\n}\n#endif\n#if USE_SHADOW_MAP\n  #if NUM_SHADOW_LIGHTS > 0\n    #pragma for id in range(0, NUM_SHADOW_LIGHTS)\n      uniform mat4 lightViewProjMatrix_{id};\n      uniform float minDepth_{id};\n      uniform float maxDepth_{id};\n      varying vec4 pos_lightspace_{id};\n      varying float vDepth_{id};\n    #pragma endFor\n  #endif\n#endif\nvoid main () {\n  vec4 pos = vec4(a_position, 1);\n  #if USE_SKINNING\n    mat4 skinMat = skinMatrix();\n    pos = skinMat * pos;\n  #endif\n  pos_w = (model * pos).xyz;\n  pos = viewProj * model * pos;\n  #if USE_NORMAL_TEXTURE || USE_ALBEDO_TEXTURE || USE_MRA_TEXTURE || USE_METALLIC_TEXTURE || USE_ROUGHNESS_TEXTURE || USE_AO_TEXTURE || USE_EMISSIVE_TEXTURE\n    uv0 = a_uv0 * mainTiling + mainOffset;\n  #endif\n  vec4 normal = vec4(a_normal, 0);\n  #if USE_SKINNING\n    normal = skinMat * normal;\n  #endif\n  normal_w = normalMatrix * normal.xyz;\n  #if USE_SHADOW_MAP\n    #if NUM_SHADOW_LIGHTS > 0\n      #pragma for id in range(0, NUM_SHADOW_LIGHTS)\n        pos_lightspace_{id} = lightViewProjMatrix_{id} * vec4(pos_w, 1.0);\n        vDepth_{id} = (pos_lightspace_{id}.z + minDepth_{id}) / (minDepth_{id} + maxDepth_{id});\n      #pragma endFor\n    #endif\n  #endif\n  gl_Position = pos;\n}",frag:"\n#if USE_NORMAL_TEXTURE\n#extension GL_OES_standard_derivatives : enable\n#endif\n#if USE_TEX_LOD\n#extension GL_EXT_shader_texture_lod: enable\n#endif\n\n#define PI 3.14159265359\n#define PI2 6.28318530718\n#define EPSILON 1e-6\n#define LOG2 1.442695\n#define saturate(a) clamp( a, 0.0, 1.0 )\n\nvec3 gammaToLinearSpaceRGB(vec3 sRGB) { \n  return sRGB * (sRGB * (sRGB * 0.305306011 + 0.682171111) + 0.012522878);\n}\nvec3 linearToGammaSpaceRGB(vec3 RGB) { \n  vec3 S1 = sqrt(RGB);\n  vec3 S2 = sqrt(S1);\n  vec3 S3 = sqrt(S2);\n  return 0.585122381 * S1 + 0.783140355 * S2 - 0.368262736 * S3;\n}\nvec4 gammaToLinearSpaceRGBA(vec4 sRGBA) {\n  return vec4(gammaToLinearSpaceRGB(sRGBA.rgb), sRGBA.a);\n}\nvec4 linearToGammaSpaceRGBA(vec4 RGBA) {\n  return vec4(linearToGammaSpaceRGB(RGBA.rgb), RGBA.a);\n}\nfloat gammaToLinearSpaceExact(float val) {\n  if (val <= 0.04045) {\n    return val / 12.92;\n  } else if (val < 1.0) {\n    return pow((val + 0.055) / 1.055, 2.4);\n  } else {\n    return pow(val, 2.2);\n  }\n}\nfloat linearToGammaSpaceExact(float val) {\n  if (val <= 0.0) {\n    return 0.0;\n  } else if (val <= 0.0031308) {\n    return 12.92 * val;\n  } else if (val < 1.0) {\n    return 1.055 * pow(val, 0.4166667) - 0.055;\n  } else {\n    return pow(val, 0.45454545);\n  }\n}\n\nstruct LightInfo {\n  vec3 lightDir;\n  vec3 radiance;\n};\n#if NUM_DIR_LIGHTS > 0\n  #pragma for id in range(0, NUM_DIR_LIGHTS)\n    uniform vec3 dir_light{id}_direction;\n    uniform vec3 dir_light{id}_color;\n  #pragma endFor\n#endif\n#if NUM_POINT_LIGHTS > 0\n  #pragma for id in range(0, NUM_POINT_LIGHTS)\n    uniform vec3 point_light{id}_position;\n    uniform vec3 point_light{id}_color;\n    uniform float point_light{id}_range;\n  #pragma endFor\n#endif\n#if NUM_SPOT_LIGHTS > 0\n  #pragma for id in range(0, NUM_SPOT_LIGHTS)\n    uniform vec3 spot_light{id}_position;\n    uniform vec3 spot_light{id}_direction;\n    uniform vec3 spot_light{id}_color;\n    uniform vec2 spot_light{id}_spot;\n    uniform float spot_light{id}_range;\n  #pragma endFor\n#endif\nLightInfo computeDirectionalLighting(\n  vec3 lightDirection,\n  vec3 lightColor\n) {\n  LightInfo ret;\n  ret.lightDir = -normalize(lightDirection);\n  ret.radiance = lightColor;\n  return ret;\n}\nLightInfo computePointLighting(\n  vec3 lightPosition,\n  vec3 positionW,\n  vec3 lightColor,\n  float lightRange\n) {\n  LightInfo ret;\n  vec3 lightDir = lightPosition - positionW;\n  float attenuation = max(0.0, 1.0 - length(lightDir) / lightRange);\n  ret.lightDir = normalize(lightDir);\n  ret.radiance = lightColor * attenuation;\n  return ret;\n}\nLightInfo computeSpotLighting(\n  vec3 lightPosition,\n  vec3 positionW,\n  vec3 lightDirection,\n  vec3 lightColor,\n  vec2 lightSpot,\n  float lightRange\n) {\n  LightInfo ret;\n  vec3 lightDir = lightPosition - positionW;\n  float attenuation = max(0., 1.0 - length(lightDir) / lightRange);\n  float cosConeAngle = max(0., dot(lightDirection, -lightDir));\n  cosConeAngle = cosConeAngle < lightSpot.x ? 0.0 : cosConeAngle;\n  cosConeAngle = pow(cosConeAngle,lightSpot.y);\n  ret.lightDir = normalize(lightDir);\n  ret.radiance = lightColor * attenuation * cosConeAngle;\n  return ret;\n}\n\nvec3 unpackNormal(vec4 nmap) {\n  return nmap.xyz * 2.0 - 1.0;\n}\nvec3 unpackRGBE(vec4 rgbe) {\n    return rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\n#if USE_SHADOW_MAP\n  \nvec4 packDepthToRGBA(float depth) {\n  vec4 ret = vec4(1.0, 255.0, 65025.0, 160581375.0) * depth;\n  ret = fract(ret);\n  ret -= ret.yzww * vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0, 0.0);\n  return ret;\n}\nfloat unpackRGBAToDepth(vec4 color) {\n  return dot(color, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n}\n  \n#if NUM_SHADOW_LIGHTS > 0\n  #pragma for id in range(0, NUM_SHADOW_LIGHTS)\n    uniform sampler2D shadowMap_{id};\n    uniform float darkness_{id};\n    uniform float depthScale_{id};\n    uniform float frustumEdgeFalloff_{id};\n    uniform float bias_{id};\n    uniform vec2 texelSize_{id};\n    varying vec4 pos_lightspace_{id};\n    varying float vDepth_{id};\n  #pragma endFor\n#endif\nfloat computeShadow(sampler2D shadowMap, vec4 pos_lightspace, float bias) {\n  vec3 projCoords = pos_lightspace.xyz / pos_lightspace.w;\n  projCoords = projCoords * 0.5 + 0.5;\n  float closestDepth = unpackRGBAToDepth(texture2D(shadowMap, projCoords.xy));\n  float currentDepth = projCoords.z;\n  float shadow = (currentDepth - bias > closestDepth) ? 0.0 : 1.0;\n  return shadow;\n}\nfloat computeFallOff(float esm, vec2 coords, float frustumEdgeFalloff) {\n  float mask = smoothstep(1.0 - frustumEdgeFalloff, 1.0, clamp(dot(coords, coords), 0.0, 1.0));\n  return mix(esm, 1.0, mask);\n}\nfloat computeShadowESM(sampler2D shadowMap, vec4 pos_lightspace, float vDepth, float depthScale, float darkness, float frustumEdgeFalloff) {\n  vec2 projCoords = pos_lightspace.xy / pos_lightspace.w;\n  vec2 shadowUV = projCoords * 0.5 + vec2(0.5);\n  if (shadowUV.x < 0.0 || shadowUV.x > 1.0 || shadowUV.y < 0.0 || shadowUV.y > 1.0) {\n    return 1.0;\n  }\n  float currentDepth = clamp(vDepth, 0.0, 1.0);\n  float closestDepth = unpackRGBAToDepth(texture2D(shadowMap, shadowUV));\n  \n  float esm = clamp(exp(-depthScale * (currentDepth - closestDepth)), 1.0 - darkness, 1.0);\n  return computeFallOff(esm, projCoords, frustumEdgeFalloff);\n}\nfloat computeShadowPCF(sampler2D shadowMap, vec4 pos_lightspace, float vDepth, float darkness, vec2 texelSize, float frustumEdgeFalloff) {\n  vec2 projCoords = pos_lightspace.xy / pos_lightspace.w;\n  vec2 shadowUV = projCoords * 0.5 + vec2(0.5);\n  if (shadowUV.x < 0.0 || shadowUV.x > 1.0 || shadowUV.y < 0.0 || shadowUV.y > 1.0) {\n    return 1.0;\n  }\n  float currentDepth = clamp(vDepth, 0.0, 1.0);\n  float visibility = 1.0;\n  vec2 poissonDisk[4];\n  poissonDisk[0] = vec2(-0.94201624, -0.39906216);\n  poissonDisk[1] = vec2(0.94558609, -0.76890725);\n  poissonDisk[2] = vec2(-0.094184101, -0.92938870);\n  poissonDisk[3] = vec2(0.34495938, 0.29387760);\n  if (unpackRGBAToDepth(texture2D(shadowMap, shadowUV + poissonDisk[0] * texelSize)) < currentDepth) visibility -= 0.25;\n  if (unpackRGBAToDepth(texture2D(shadowMap, shadowUV + poissonDisk[1] * texelSize)) < currentDepth) visibility -= 0.25;\n  if (unpackRGBAToDepth(texture2D(shadowMap, shadowUV + poissonDisk[2] * texelSize)) < currentDepth) visibility -= 0.25;\n  if (unpackRGBAToDepth(texture2D(shadowMap, shadowUV + poissonDisk[3] * texelSize)) < currentDepth) visibility -= 0.25;\n  return computeFallOff(min(1.0, visibility + 1.0 - darkness), projCoords, frustumEdgeFalloff);\n}\n#endif\nuniform vec3 eye;\nvarying vec3 pos_w;\nvarying vec3 normal_w;\n#if USE_NORMAL_TEXTURE || USE_ALBEDO_TEXTURE || USE_MRA_TEXTURE || USE_METALLIC_TEXTURE || USE_ROUGHNESS_TEXTURE || USE_AO_TEXTURE || USE_EMISSIVE_TEXTURE\n  varying vec2 uv0;\n#endif\n#if USE_IBL\n  uniform samplerCube diffuseEnvTexture;\n  uniform samplerCube specularEnvTexture;\n  uniform sampler2D brdfLUT;\n  #if USE_TEX_LOD\n    uniform float maxReflectionLod;\n  #endif\n#endif\nuniform vec4 albedo;\n#if USE_ALBEDO_TEXTURE\n  uniform sampler2D albedo_texture;\n#endif\n#if USE_MRA_TEXTURE\n  uniform vec2 sampler2D mra_texture;\n#endif\nuniform float metallic;\n#if USE_METALLIC_TEXTURE\n  uniform sampler2D metallic_texture;\n#endif\nuniform float roughness;\n#if USE_ROUGHNESS_TEXTURE\n  uniform sampler2D roughness_texture;\n#endif\nuniform float ao;\n#if USE_AO_TEXTURE\n  uniform sampler2D ao_texture;\n#endif\n#if USE_EMISSIVE\n  uniform vec3 emissive;\n  #if USE_EMISSIVE_TEXTURE\n    uniform sampler2D emissive_texture;\n  #endif\n#endif\n#if USE_ALPHA_TEST\n  uniform float alphaTestThreshold;\n#endif\n#if USE_NORMAL_TEXTURE\n  uniform sampler2D normal_texture;\n  \n  vec3 getNormalFromTexture() {\n    vec3 tangentNormal = texture2D(normal_texture, uv0).rgb * 2.0 - 1.0;\n    vec3 q1  = dFdx(pos_w);\n    vec3 q2  = dFdy(pos_w);\n    vec2 st1 = dFdx(uv0);\n    vec2 st2 = dFdy(uv0);\n    vec3 N   = normalize(normal_w);\n    vec3 T   = normalize(q1*st2.t - q2*st1.t);\n    vec3 B   = -normalize(cross(N, T));\n    mat3 TBN = mat3(T, B, N);\n    return normalize(TBN * tangentNormal);\n  }\n#endif\nfloat distributionGGX(vec3 N, vec3 H, float roughness) {\n  float a = roughness * roughness;\n  float a2 = a * a;\n  float NdotH = max(dot(N, H), 0.0);\n  float NdotH2 = NdotH * NdotH;\n  float nom   = a2;\n  float denom = (NdotH2 * (a2 - 1.0) + 1.0);\n  denom = PI * denom * denom;\n  return nom / denom;\n}\nfloat geometrySchlickGGX(float NdotV, float roughness) {\n  float r = (roughness + 1.0);\n  float k = (r * r) / 8.0;\n  float nom   = NdotV;\n  float denom = NdotV * (1.0 - k) + k;\n  return nom / denom;\n}\nfloat geometrySmith(vec3 N, vec3 V, vec3 L, float roughness) {\n  float NdotV = max(dot(N, V), 0.0);\n  float NdotL = max(dot(N, L), 0.0);\n  float ggx2 = geometrySchlickGGX(NdotV, roughness);\n  float ggx1 = geometrySchlickGGX(NdotL, roughness);\n  return ggx1 * ggx2;\n}\nvec3 fresnelSchlick(float cosTheta, vec3 F0) {\n  float fresnel = exp2((-5.55473 * cosTheta - 6.98316) * cosTheta);\n  return F0 + (1.0 - F0) * fresnel;\n}\nvec3 fresnelSchlickRoughness(float cosTheta, vec3 F0, float roughness) {\n  float fresnel = exp2((-5.55473 * cosTheta - 6.98316) * cosTheta);\n  return F0 + (max(vec3(1.0 - roughness), F0) - F0) * fresnel;\n}\nvec3 brdf(LightInfo lightInfo, vec3 N, vec3 V, vec3 F0, vec3 albedo, float metallic, float roughness) {\n  vec3 H = normalize(V + lightInfo.lightDir);\n  float NDF = distributionGGX(N, H, roughness);\n  float G   = geometrySmith(N, V, lightInfo.lightDir, roughness);\n  vec3 F    = fresnelSchlick(max(dot(H, V), 0.0), F0);\n  vec3 nominator    = NDF * G * F;\n  float denominator = 4.0 * max(dot(N, V), 0.0) * max(dot(N, lightInfo.lightDir), 0.0) + 0.001; \n  vec3 specular = nominator / denominator;\n  \n  vec3 kS = F;\n  \n  \n  \n  vec3 kD = vec3(1.0) - kS;\n  \n  \n  \n  kD *= 1.0 - metallic;\n  float NdotL = max(dot(N, lightInfo.lightDir), 0.0);\n  return (kD * albedo / PI + specular) * lightInfo.radiance * NdotL;\n}\nvoid main() {\n  float opacity = 1.0;\n  #if USE_ALBEDO_TEXTURE\n    vec4 baseColor = albedo * gammaToLinearSpaceRGBA(texture2D(albedo_texture, uv0));\n    vec3 albedo = baseColor.rgb;\n    opacity = baseColor.a;\n  #else\n    opacity = albedo.a;\n    vec3 albedo = albedo.rgb;\n  #endif\n  #if USE_ALPHA_TEST\n    if(opacity < alphaTestThreshold) discard;\n  #endif\n  #if USE_MRA_TEXTURE\n    vec3 metalRoughness = texture2D(mra_texture, uv0).rgb;\n    float metallic = metalRoughness.r;\n    float roughness = metalRoughness.g;\n    float ao = metalRoughness.b;\n  #else\n    #if USE_METALLIC_TEXTURE\n      float metallic  = texture2D(metallic_texture, uv0).r;\n    #endif\n    #if USE_ROUGHNESS_TEXTURE\n      float roughness  = texture2D(roughness_texture, uv0).r;\n    #endif\n    #if USE_AO_TEXTURE\n      float ao  = texture2D(ao_texture, uv0).r;\n    #endif\n  #endif\n  vec3 N = normalize(normal_w);\n  #if USE_NORMAL_TEXTURE\n    N = getNormalFromTexture();\n  #endif\n  vec3 V = normalize(eye - pos_w);\n  \n  \n  vec3 F0 = vec3(0.04);\n  F0 = mix(F0, albedo, metallic);\n  \n  vec3 Lo = vec3(0.0);\n  \n  #if NUM_POINT_LIGHTS > 0\n    #pragma for id in range(0, NUM_POINT_LIGHTS)\n      LightInfo pointLight{id};\n      pointLight{id} = computePointLighting(point_light{id}_position, pos_w, point_light{id}_color, point_light{id}_range);\n      Lo += brdf(pointLight{id}, N, V, F0, albedo, metallic, roughness);\n    #pragma endFor\n  #endif\n  #if NUM_DIR_LIGHTS > 0\n    #pragma for id in range(0, NUM_DIR_LIGHTS)\n      LightInfo directionalLight{id};\n      directionalLight{id} = computeDirectionalLighting(dir_light{id}_direction, dir_light{id}_color);\n      Lo += brdf(directionalLight{id}, N, V, F0, albedo, metallic, roughness);\n    #pragma endFor\n  #endif\n  #if NUM_SPOT_LIGHTS > 0\n    #pragma for id in range(0, NUM_SPOT_LIGHTS)\n      LightInfo spotLight{id};\n      spotLight{id} = computeSpotLighting(spot_light{id}_position, pos_w, spot_light{id}_direction, spot_light{id}_color, spot_light{id}_spot, spot_light{id}_range);\n      Lo += brdf(spotLight{id}, N, V, F0, albedo, metallic, roughness);\n    #pragma endFor\n  #endif\n  #if USE_EMISSIVE\n    vec3 emissiveColor = gammaToLinearSpaceRGB(emissive);\n    #if USE_EMISSIVE_TEXTURE\n      emissiveColor *= gammaToLinearSpaceRGB(texture2D(emissive_texture, uv0).rgb);\n    #endif\n    Lo += emissiveColor;\n  #endif\n  \n  vec3 ambient = vec3(0.03) * albedo * ao;\n  #if USE_IBL\n    \n    vec3 F = fresnelSchlickRoughness(max(dot(N, V), 0.0), F0, roughness);\n    vec3 kS = F;\n    vec3 kD = vec3(1.0) - kS;\n    kD *= 1.0 - metallic;\n    #if USE_RGBE_HDR_IBL_DIFFUSE\n      vec3 diffuseEnv = unpackRGBE(textureCube(diffuseEnvTexture, N));\n    #else\n      vec3 diffuseEnv = textureCube(diffuseEnvTexture, N).rgb;\n    #endif\n    vec3 diffuse = diffuseEnv * albedo;\n    \n    vec3 R = reflect(-V, N);\n    #if USE_TEX_LOD\n      #if USE_RGBE_HDR_IBL_SPECULAR\n        vec3 specularEnv = unpackRGBE(textureCubeLodEXT(specularEnvTexture, R, roughness * maxReflectionLod));\n      #else\n        vec3 specularEnv = textureCubeLodEXT(specularEnvTexture, R, roughness * maxReflectionLod).rgb;\n      #endif\n    #else\n      #if USE_RGBE_HDR_IBL_SPECULAR\n        vec3 specularEnv = unpackRGBE(textureCube(specularEnvTexture, R));\n      #else\n        vec3 specularEnv = textureCube(specularEnvTexture, R).rgb;\n      #endif\n    #endif\n    vec2 brdf  = texture2D(brdfLUT, vec2(max(dot(N, V), 0.0), roughness)).rg;\n    vec3 specular = specularEnv * (F * brdf.x + brdf.y);\n    ambient = (kD * diffuse + specular) * ao;\n  #endif\n  #if USE_SHADOW_MAP\n    float shadow = 1.0;\n    #if NUM_SHADOW_LIGHTS > 0\n      #pragma for id in range(0, NUM_SHADOW_LIGHTS)\n        shadow *= computeShadowESM(shadowMap_{id}, pos_lightspace_{id}, vDepth_{id}, depthScale_{id}, darkness_{id}, frustumEdgeFalloff_{id});\n      #pragma endFor\n    #endif\n    vec3 color = (ambient + Lo) * shadow;\n  #else\n    vec3 color = ambient + Lo;\n  #endif\n  \n  color = color / (color + vec3(1.0));\n  \n  vec4 finalColor = vec4(color, opacity);\n  gl_FragColor = linearToGammaSpaceRGBA(finalColor);\n}",defines:[{name:"USE_NORMAL_TEXTURE"},{name:"USE_ALBEDO_TEXTURE"},{name:"USE_METALLIC_ROUGHNESS_TEXTURE"},{name:"USE_METALLIC_TEXTURE"},{name:"USE_ROUGHNESS_TEXTURE"},{name:"USE_AO_TEXTURE"},{name:"USE_EMISSIVE"},{name:"USE_EMISSIVE_TEXTURE"},{name:"USE_IBL"},{name:"USE_TEX_LOD"},{name:"USE_ALPHA_TEST"},{name:"USE_SHADOW_MAP"},{name:"USE_SKINNING"},{name:"NUM_DIR_LIGHTS",min:0,max:4},{name:"NUM_POINT_LIGHTS",min:0,max:4},{name:"NUM_SPOT_LIGHTS",min:0,max:4},{name:"NUM_SHADOW_LIGHTS",min:0,max:4}]},{name:"phong",vert:"\nattribute vec3 a_position;\nattribute vec3 a_normal;\nuniform mat4 model;\nuniform mat4 viewProj;\nuniform mat3 normalMatrix;\nvarying vec3 normal_w;\nvarying vec3 pos_w;\n#if USE_NORMAL_TEXTURE || USE_DIFFUSE_TEXTURE || USE_EMISSIVE_TEXTURE\n  attribute vec2 a_uv0;\n  uniform vec2 mainTiling;\n  uniform vec2 mainOffset;\n  varying vec2 uv0;\n#endif\n#if USE_SKINNING\n  \nattribute vec4 a_weights;\nattribute vec4 a_joints;\n#if USE_JOINTS_TEXTURE\nuniform sampler2D u_jointsTexture;\nuniform float u_jointsTextureSize;\nmat4 getBoneMatrix(const in float i) {\n  float size = u_jointsTextureSize;\n  float j = i * 4.0;\n  float x = mod(j, size);\n  float y = floor(j / size);\n  float dx = 1.0 / size;\n  float dy = 1.0 / size;\n  y = dy * (y + 0.5);\n  vec4 v1 = texture2D(u_jointsTexture, vec2(dx * (x + 0.5), y));\n  vec4 v2 = texture2D(u_jointsTexture, vec2(dx * (x + 1.5), y));\n  vec4 v3 = texture2D(u_jointsTexture, vec2(dx * (x + 2.5), y));\n  vec4 v4 = texture2D(u_jointsTexture, vec2(dx * (x + 3.5), y));\n  return mat4(v1, v2, v3, v4);\n}\n#else\nuniform mat4 u_jointMatrices[128];\nmat4 getBoneMatrix(const in float i) {\n  return u_jointMatrices[int(i)];\n}\n#endif\nmat4 skinMatrix() {\n  return\n    getBoneMatrix(a_joints.x) * a_weights.x +\n    getBoneMatrix(a_joints.y) * a_weights.y +\n    getBoneMatrix(a_joints.z) * a_weights.z +\n    getBoneMatrix(a_joints.w) * a_weights.w\n    ;\n}\n#endif\n#if USE_SHADOW_MAP\n  #if NUM_SHADOW_LIGHTS > 0\n    #pragma for id in range(0, NUM_SHADOW_LIGHTS)\n      uniform mat4 lightViewProjMatrix_{id};\n      uniform float minDepth_{id};\n      uniform float maxDepth_{id};\n      varying vec4 pos_lightspace_{id};\n      varying float vDepth_{id};\n    #pragma endFor\n  #endif\n#endif\nvoid main () {\n  vec4 pos = vec4(a_position, 1);\n  #if USE_SKINNING\n    mat4 skinMat = skinMatrix();\n    pos = skinMat * pos;\n  #endif\n  pos_w = (model * pos).xyz;\n  pos = viewProj * model * pos;\n  #if USE_NORMAL_TEXTURE || USE_DIFFUSE_TEXTURE || USE_EMISSIVE_TEXTURE\n    uv0 = a_uv0 * mainTiling + mainOffset;\n  #endif\n  vec4 normal = vec4(a_normal, 0);\n  #if USE_SKINNING\n    normal = skinMat * normal;\n  #endif\n  normal_w = normalMatrix * normal.xyz;\n  #if USE_SHADOW_MAP\n    #if NUM_SHADOW_LIGHTS > 0\n      #pragma for id in range(0, NUM_SHADOW_LIGHTS)\n        pos_lightspace_{id} = lightViewProjMatrix_{id} * vec4(pos_w, 1.0);\n        vDepth_{id} = (pos_lightspace_{id}.z + minDepth_{id}) / (minDepth_{id} + maxDepth_{id});\n      #pragma endFor\n    #endif\n  #endif\n  gl_Position = pos;\n}",frag:"\n#if USE_NORMAL_TEXTURE\n#extension GL_OES_standard_derivatives : enable\n#endif\n\n#define PI 3.14159265359\n#define PI2 6.28318530718\n#define EPSILON 1e-6\n#define LOG2 1.442695\n#define saturate(a) clamp( a, 0.0, 1.0 )\n\nvec3 gammaToLinearSpaceRGB(vec3 sRGB) { \n  return sRGB * (sRGB * (sRGB * 0.305306011 + 0.682171111) + 0.012522878);\n}\nvec3 linearToGammaSpaceRGB(vec3 RGB) { \n  vec3 S1 = sqrt(RGB);\n  vec3 S2 = sqrt(S1);\n  vec3 S3 = sqrt(S2);\n  return 0.585122381 * S1 + 0.783140355 * S2 - 0.368262736 * S3;\n}\nvec4 gammaToLinearSpaceRGBA(vec4 sRGBA) {\n  return vec4(gammaToLinearSpaceRGB(sRGBA.rgb), sRGBA.a);\n}\nvec4 linearToGammaSpaceRGBA(vec4 RGBA) {\n  return vec4(linearToGammaSpaceRGB(RGBA.rgb), RGBA.a);\n}\nfloat gammaToLinearSpaceExact(float val) {\n  if (val <= 0.04045) {\n    return val / 12.92;\n  } else if (val < 1.0) {\n    return pow((val + 0.055) / 1.055, 2.4);\n  } else {\n    return pow(val, 2.2);\n  }\n}\nfloat linearToGammaSpaceExact(float val) {\n  if (val <= 0.0) {\n    return 0.0;\n  } else if (val <= 0.0031308) {\n    return 12.92 * val;\n  } else if (val < 1.0) {\n    return 1.055 * pow(val, 0.4166667) - 0.055;\n  } else {\n    return pow(val, 0.45454545);\n  }\n}\n\nstruct LightInfo {\n  vec3 diffuse;\n  vec3 specular;\n};\nLightInfo computeDirectionalLighting(\n  vec3 lightDirection,\n  vec3 lightColor,\n  vec3 normal,\n  vec3 viewDirection,\n  float glossiness\n) {\n  LightInfo lightingResult;\n  float ndl = 0.0;\n  float ndh = 0.0;\n  vec3 lightDir = -normalize(lightDirection);\n  ndl = max(0.0, dot(normal, lightDir));\n  lightingResult.diffuse = lightColor * ndl;\n  vec3 dirH = normalize(viewDirection + lightDir);\n  ndh = max(0.0, dot(normal, dirH));\n  ndh = (ndl == 0.0) ? 0.0: ndh;\n  ndh = pow(ndh, max(1.0, glossiness * 128.0));\n  lightingResult.specular = lightColor * ndh;\n  return lightingResult;\n}\nLightInfo computePointLighting(\n  vec3 lightPosition,\n  vec3 lightColor,\n  float lightRange,\n  vec3 normal,\n  vec3 positionW,\n  vec3 viewDirection,\n  float glossiness\n) {\n  LightInfo lightingResult;\n  float ndl = 0.0;\n  float ndh = 0.0;\n  vec3 lightDir = vec3(0, 0, 0);\n  float attenuation = 1.0;\n  lightDir = lightPosition - positionW;\n  attenuation = max(0., 1.0 - length(lightDir) / lightRange);\n  lightDir = normalize(lightDir);\n  ndl = max(0.0, dot(normal, lightDir));\n  lightingResult.diffuse = lightColor * ndl * attenuation;\n  vec3 dirH = normalize(viewDirection + lightDir);\n  ndh = max(0.0, dot(normal, dirH));\n  ndh = (ndl == 0.0) ? 0.0: ndh;\n  ndh = pow(ndh, max(1.0, glossiness * 128.0));\n  lightingResult.specular = lightColor * ndh * attenuation;\n  return lightingResult;\n}\nLightInfo computeSpotLighting(\n  vec3 lightPosition,\n  vec3 lightDirection,\n  vec3 lightColor,\n  float lightRange,\n  vec2 lightSpot,\n  vec3 normal,\n  vec3 positionW,\n  vec3 viewDirection,\n  float glossiness\n) {\n  LightInfo lightingResult;\n  float ndl = 0.0;\n  float ndh = 0.0;\n  vec3 lightDir = vec3(0, 0, 0);\n  float attenuation = 1.0;\n  float cosConeAngle = 1.0;\n  lightDir = lightPosition - positionW;\n  attenuation = max(0., 1.0 - length(lightDir) / lightRange);\n  lightDir = normalize(lightDir);\n  cosConeAngle = max(0., dot(lightDirection, -lightDir));\n  cosConeAngle = cosConeAngle < lightSpot.x ? 0.0 : cosConeAngle;\n  cosConeAngle = pow(cosConeAngle,lightSpot.y);\n  ndl = max(0.0, dot(normal, lightDir));\n  lightingResult.diffuse = lightColor * ndl * attenuation * cosConeAngle;\n  vec3 dirH = normalize(viewDirection + lightDir);\n  ndh = max(0.0, dot(normal, dirH));\n  ndh = (ndl == 0.0) ? 0.0: ndh;\n  ndh = pow(ndh, max(1.0, glossiness * 128.0));\n  lightingResult.specular = lightColor * ndh * attenuation * cosConeAngle;\n  return lightingResult;\n}\n#if NUM_DIR_LIGHTS > 0\n  #pragma for id in range(0, NUM_DIR_LIGHTS)\n    uniform vec3 dir_light{id}_direction;\n    uniform vec3 dir_light{id}_color;\n  #pragma endFor\n#endif\n#if NUM_POINT_LIGHTS > 0\n  #pragma for id in range(0, NUM_POINT_LIGHTS)\n    uniform vec3 point_light{id}_position;\n    uniform vec3 point_light{id}_color;\n    uniform float point_light{id}_range;\n  #pragma endFor\n#endif\n#if NUM_SPOT_LIGHTS > 0\n  #pragma for id in range(0, NUM_SPOT_LIGHTS)\n    uniform vec3 spot_light{id}_position;\n    uniform vec3 spot_light{id}_direction;\n    uniform vec3 spot_light{id}_color;\n    uniform float spot_light{id}_range;\n    uniform vec2 spot_light{id}_spot;\n  #pragma endFor\n#endif\nLightInfo getPhongLighting(\n  vec3 normal,\n  vec3 positionW,\n  vec3 viewDirection,\n  float glossiness\n) {\n  LightInfo result;\n  result.diffuse = vec3(0, 0, 0);\n  result.specular = vec3(0, 0, 0);\n  LightInfo dirLighting;\n  #if NUM_DIR_LIGHTS > 0\n    #pragma for id in range(0, NUM_DIR_LIGHTS)\n      dirLighting = computeDirectionalLighting(dir_light{id}_direction,dir_light{id}_color,normal, viewDirection, glossiness);\n      result.diffuse += dirLighting.diffuse;\n      result.specular += dirLighting.specular;\n    #pragma endFor\n  #endif\n  LightInfo pointLighting;\n  #if NUM_POINT_LIGHTS > 0\n    #pragma for id in range(0, NUM_POINT_LIGHTS)\n      pointLighting = computePointLighting(point_light{id}_position, point_light{id}_color, point_light{id}_range,\n                                          normal, positionW, viewDirection, glossiness);\n      result.diffuse += pointLighting.diffuse;\n      result.specular += pointLighting.specular;\n    #pragma endFor\n  #endif\n  LightInfo spotLighting;\n  #if NUM_SPOT_LIGHTS > 0\n    #pragma for id in range(0, NUM_SPOT_LIGHTS)\n      spotLighting = computeSpotLighting(spot_light{id}_position, spot_light{id}_direction, spot_light{id}_color,\n                      spot_light{id}_range, spot_light{id}_spot,normal, positionW, viewDirection, glossiness);\n      result.diffuse += spotLighting.diffuse;\n      result.specular += spotLighting.specular;\n    #pragma endFor\n  #endif\n  return result;\n}\n\n#if USE_SHADOW_MAP\n  \nvec4 packDepthToRGBA(float depth) {\n  vec4 ret = vec4(1.0, 255.0, 65025.0, 160581375.0) * depth;\n  ret = fract(ret);\n  ret -= ret.yzww * vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0, 0.0);\n  return ret;\n}\nfloat unpackRGBAToDepth(vec4 color) {\n  return dot(color, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n}\n  \n#if NUM_SHADOW_LIGHTS > 0\n  #pragma for id in range(0, NUM_SHADOW_LIGHTS)\n    uniform sampler2D shadowMap_{id};\n    uniform float darkness_{id};\n    uniform float depthScale_{id};\n    uniform float frustumEdgeFalloff_{id};\n    uniform float bias_{id};\n    uniform vec2 texelSize_{id};\n    varying vec4 pos_lightspace_{id};\n    varying float vDepth_{id};\n  #pragma endFor\n#endif\nfloat computeShadow(sampler2D shadowMap, vec4 pos_lightspace, float bias) {\n  vec3 projCoords = pos_lightspace.xyz / pos_lightspace.w;\n  projCoords = projCoords * 0.5 + 0.5;\n  float closestDepth = unpackRGBAToDepth(texture2D(shadowMap, projCoords.xy));\n  float currentDepth = projCoords.z;\n  float shadow = (currentDepth - bias > closestDepth) ? 0.0 : 1.0;\n  return shadow;\n}\nfloat computeFallOff(float esm, vec2 coords, float frustumEdgeFalloff) {\n  float mask = smoothstep(1.0 - frustumEdgeFalloff, 1.0, clamp(dot(coords, coords), 0.0, 1.0));\n  return mix(esm, 1.0, mask);\n}\nfloat computeShadowESM(sampler2D shadowMap, vec4 pos_lightspace, float vDepth, float depthScale, float darkness, float frustumEdgeFalloff) {\n  vec2 projCoords = pos_lightspace.xy / pos_lightspace.w;\n  vec2 shadowUV = projCoords * 0.5 + vec2(0.5);\n  if (shadowUV.x < 0.0 || shadowUV.x > 1.0 || shadowUV.y < 0.0 || shadowUV.y > 1.0) {\n    return 1.0;\n  }\n  float currentDepth = clamp(vDepth, 0.0, 1.0);\n  float closestDepth = unpackRGBAToDepth(texture2D(shadowMap, shadowUV));\n  \n  float esm = clamp(exp(-depthScale * (currentDepth - closestDepth)), 1.0 - darkness, 1.0);\n  return computeFallOff(esm, projCoords, frustumEdgeFalloff);\n}\nfloat computeShadowPCF(sampler2D shadowMap, vec4 pos_lightspace, float vDepth, float darkness, vec2 texelSize, float frustumEdgeFalloff) {\n  vec2 projCoords = pos_lightspace.xy / pos_lightspace.w;\n  vec2 shadowUV = projCoords * 0.5 + vec2(0.5);\n  if (shadowUV.x < 0.0 || shadowUV.x > 1.0 || shadowUV.y < 0.0 || shadowUV.y > 1.0) {\n    return 1.0;\n  }\n  float currentDepth = clamp(vDepth, 0.0, 1.0);\n  float visibility = 1.0;\n  vec2 poissonDisk[4];\n  poissonDisk[0] = vec2(-0.94201624, -0.39906216);\n  poissonDisk[1] = vec2(0.94558609, -0.76890725);\n  poissonDisk[2] = vec2(-0.094184101, -0.92938870);\n  poissonDisk[3] = vec2(0.34495938, 0.29387760);\n  if (unpackRGBAToDepth(texture2D(shadowMap, shadowUV + poissonDisk[0] * texelSize)) < currentDepth) visibility -= 0.25;\n  if (unpackRGBAToDepth(texture2D(shadowMap, shadowUV + poissonDisk[1] * texelSize)) < currentDepth) visibility -= 0.25;\n  if (unpackRGBAToDepth(texture2D(shadowMap, shadowUV + poissonDisk[2] * texelSize)) < currentDepth) visibility -= 0.25;\n  if (unpackRGBAToDepth(texture2D(shadowMap, shadowUV + poissonDisk[3] * texelSize)) < currentDepth) visibility -= 0.25;\n  return computeFallOff(min(1.0, visibility + 1.0 - darkness), projCoords, frustumEdgeFalloff);\n}\n#endif\nuniform vec3 eye;\nuniform vec3 sceneAmbient;\nvarying vec3 normal_w;\nvarying vec3 pos_w;\n#if USE_NORMAL_TEXTURE || USE_DIFFUSE_TEXTURE || USE_EMISSIVE_TEXTURE\n  varying vec2 uv0;\n#endif\nstruct phongMaterial\n{\n  vec3 diffuse;\n  vec3 emissive;\n  vec3 specular;\n  float glossiness;\n  float opacity;\n};\nuniform vec4 diffuseColor;\n#if USE_DIFFUSE_TEXTURE\n  uniform sampler2D diffuse_texture;\n#endif\n#if USE_EMISSIVE\n  uniform vec3 emissiveColor;\n  #if USE_EMISSIVE_TEXTURE\n    uniform sampler2D emissive_texture;\n  #endif\n#endif\n#if USE_SPECULAR\n  uniform vec3 specularColor;\n  uniform float glossiness;\n  #if USE_SPECULAR_TEXTURE\n    uniform sampler2D specular_texture;\n  #endif\n#endif\n#if USE_NORMAL_TEXTURE\n  uniform sampler2D normal_texture;\n  uniform float normalScale;  \n  vec3 getNormal(vec3 pos, vec3 normal) {\n    vec3 q0 = vec3( dFdx( pos.x ), dFdx( pos.y ), dFdx( pos.z ) );\n    vec3 q1 = vec3( dFdy( pos.x ), dFdy( pos.y ), dFdy( pos.z ) );\n    vec2 st0 = dFdx( uv0.st );\n    vec2 st1 = dFdy( uv0.st );\n    vec3 S = normalize( q0 * st1.t - q1 * st0.t );\n    vec3 T = normalize( -q0 * st1.s + q1 * st0.s );\n    vec3 N = normal;\n    vec3 mapN = texture2D(normal_texture, uv0).rgb * 2.0 - 1.0;\n    mapN.xy = 1.0 * mapN.xy;\n    mat3 tsn = mat3( S, T, N );\n    return normalize( tsn * mapN );\n  }\n#endif\n#if USE_ALPHA_TEST\n  uniform float alphaTestThreshold;\n#endif\nphongMaterial getPhongMaterial() {\n  phongMaterial result;\n  #if USE_DIFFUSE_TEXTURE\n    vec4 baseColor = diffuseColor * gammaToLinearSpaceRGBA(texture2D(diffuse_texture, uv0));\n    result.diffuse = baseColor.rgb;\n    result.opacity = baseColor.a;\n  #else\n    result.diffuse = diffuseColor.rgb;\n    result.opacity = diffuseColor.a;\n  #endif\n  #if USE_EMISSIVE\n    result.emissive = gammaToLinearSpaceRGB(emissiveColor);\n    #if USE_EMISSIVE_TEXTURE\n      result.emissive *= gammaToLinearSpaceRGB(texture2D(emissive_texture, uv0).rgb);\n    #endif\n  #endif\n  #if USE_SPECULAR\n    result.specular = gammaToLinearSpaceRGB(specularColor);\n    #if USE_SPECULAR_TEXTURE\n      result.specular = gammaToLinearSpaceRGB(texture2D(specular_texture, uv0).rgb);\n    #endif\n    result.glossiness = glossiness;\n  #endif\n  return result;\n}\nvec4 composePhongShading(LightInfo lighting, phongMaterial mtl, float shadow)\n{\n  vec4 o = vec4(0.0, 0.0, 0.0, 1.0);\n  \n  o.xyz = lighting.diffuse * mtl.diffuse;\n  #if USE_EMISSIVE\n    o.xyz += mtl.emissive;\n  #endif\n  #if USE_SPECULAR\n    o.xyz += lighting.specular * mtl.specular;\n  #endif\n  o.xyz *= shadow;\n  o.w = mtl.opacity;\n  return o;\n}\nvoid main () {\n  LightInfo phongLighting;\n  vec3 viewDirection = normalize(eye - pos_w);\n  phongMaterial mtl = getPhongMaterial();\n  #if USE_ALPHA_TEST\n    if(mtl.opacity < alphaTestThreshold) discard;\n  #endif\n  vec3 normal = normalize(normal_w);\n  #if USE_NORMAL_TEXTURE\n    normal = getNormal(pos_w, normal);\n  #endif\n  phongLighting = getPhongLighting(normal, pos_w, viewDirection, mtl.glossiness);\n  phongLighting.diffuse += sceneAmbient;\n  #if USE_SHADOW_MAP\n    float shadow = 1.0;\n    #if NUM_SHADOW_LIGHTS > 0\n      #pragma for id in range(0, NUM_SHADOW_LIGHTS)\n        shadow *= computeShadowESM(shadowMap_{id}, pos_lightspace_{id}, vDepth_{id}, depthScale_{id}, darkness_{id}, frustumEdgeFalloff_{id});\n      #pragma endFor\n    #endif\n    vec4 finalColor = composePhongShading(phongLighting, mtl, shadow);\n  #else\n    vec4 finalColor = composePhongShading(phongLighting, mtl, 1.0);\n  #endif\n  gl_FragColor = linearToGammaSpaceRGBA(finalColor);\n}",defines:[{name:"USE_NORMAL_TEXTURE"},{name:"USE_DIFFUSE_TEXTURE"},{name:"USE_SPECULAR"},{name:"USE_SPECULAR_TEXTURE"},{name:"USE_EMISSIVE"},{name:"USE_EMISSIVE_TEXTURE"},{name:"USE_ALPHA_TEST"},{name:"USE_SKINNING"},{name:"USE_SHADOW_MAP"},{name:"NUM_DIR_LIGHTS",min:0,max:4},{name:"NUM_POINT_LIGHTS",min:0,max:4},{name:"NUM_SPOT_LIGHTS",min:0,max:4},{name:"NUM_SHADOW_LIGHTS",min:0,max:4}]},{name:"shadow-depth",vert:"\nattribute vec3 a_position;\nuniform mat4 model;\nuniform mat4 lightViewProjMatrix;\nuniform float minDepth;\nuniform float maxDepth;\nuniform float bias;\nvarying float vDepth;\n#if USE_SKINNING\n  \nattribute vec4 a_weights;\nattribute vec4 a_joints;\n#if USE_JOINTS_TEXTURE\nuniform sampler2D u_jointsTexture;\nuniform float u_jointsTextureSize;\nmat4 getBoneMatrix(const in float i) {\n  float size = u_jointsTextureSize;\n  float j = i * 4.0;\n  float x = mod(j, size);\n  float y = floor(j / size);\n  float dx = 1.0 / size;\n  float dy = 1.0 / size;\n  y = dy * (y + 0.5);\n  vec4 v1 = texture2D(u_jointsTexture, vec2(dx * (x + 0.5), y));\n  vec4 v2 = texture2D(u_jointsTexture, vec2(dx * (x + 1.5), y));\n  vec4 v3 = texture2D(u_jointsTexture, vec2(dx * (x + 2.5), y));\n  vec4 v4 = texture2D(u_jointsTexture, vec2(dx * (x + 3.5), y));\n  return mat4(v1, v2, v3, v4);\n}\n#else\nuniform mat4 u_jointMatrices[128];\nmat4 getBoneMatrix(const in float i) {\n  return u_jointMatrices[int(i)];\n}\n#endif\nmat4 skinMatrix() {\n  return\n    getBoneMatrix(a_joints.x) * a_weights.x +\n    getBoneMatrix(a_joints.y) * a_weights.y +\n    getBoneMatrix(a_joints.z) * a_weights.z +\n    getBoneMatrix(a_joints.w) * a_weights.w\n    ;\n}\n#endif\nvoid main() {\n  vec4 pos = vec4(a_position, 1);\n  #if USE_SKINNING\n    mat4 skinMat = skinMatrix();\n    pos = skinMat * pos;\n  #endif\n  gl_Position = lightViewProjMatrix * model * pos;\n  \n  vDepth = ((gl_Position.z + minDepth) / (minDepth + maxDepth)) + bias;\n}",frag:"\nuniform float depthScale;\nvarying float vDepth;\n\nvec4 packDepthToRGBA(float depth) {\n  vec4 ret = vec4(1.0, 255.0, 65025.0, 160581375.0) * depth;\n  ret = fract(ret);\n  ret -= ret.yzww * vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0, 0.0);\n  return ret;\n}\nfloat unpackRGBAToDepth(vec4 color) {\n  return dot(color, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n}\nvoid main() {\n  \n  \n  gl_FragColor = packDepthToRGBA(vDepth);\n  \n  \n}",defines:[{name:"USE_SKINNING"}]},{name:"simple",vert:"\nattribute vec3 a_position;\nuniform mat4 model;\nuniform mat4 viewProj;\n#if USE_TEXTURE\n  attribute vec2 a_uv0;\n  varying vec2 uv0;\n#endif\nvoid main () {\n  vec4 pos = viewProj * model * vec4(a_position, 1);\n  #if USE_TEXTURE\n    uv0 = a_uv0;\n  #endif\n  gl_Position = pos;\n}",frag:"\n#if USE_TEXTURE\n  uniform sampler2D texture;\n  varying vec2 uv0;\n#endif\n#if USE_COLOR\n  uniform vec4 color;\n#endif\nvoid main () {\n  vec4 o = vec4(1, 1, 1, 1);\n  #if USE_TEXTURE\n    o *= texture2D(texture, uv0);\n  #endif\n  #if USE_COLOR\n    o *= color;\n  #endif\n  if (!gl_FrontFacing) {\n    o.rgb *= 0.5;\n  }\n  gl_FragColor = o;\n}",defines:[{name:"USE_TEXTURE"},{name:"USE_COLOR"}]},{name:"skybox",vert:"\nattribute vec3 a_position;\nuniform mat4 view;\nuniform mat4 proj;\nvarying vec3 viewDir;\nvoid main() {\n  mat4 rotView = mat4(mat3(view));\n  vec4 clipPos = proj * rotView * vec4(a_position, 1.0);\n  gl_Position = clipPos.xyww;\n  viewDir = a_position;\n}\n",frag:"\nvarying vec3 viewDir;\nuniform samplerCube cubeMap;\n\nvec3 gammaToLinearSpaceRGB(vec3 sRGB) { \n  return sRGB * (sRGB * (sRGB * 0.305306011 + 0.682171111) + 0.012522878);\n}\nvec3 linearToGammaSpaceRGB(vec3 RGB) { \n  vec3 S1 = sqrt(RGB);\n  vec3 S2 = sqrt(S1);\n  vec3 S3 = sqrt(S2);\n  return 0.585122381 * S1 + 0.783140355 * S2 - 0.368262736 * S3;\n}\nvec4 gammaToLinearSpaceRGBA(vec4 sRGBA) {\n  return vec4(gammaToLinearSpaceRGB(sRGBA.rgb), sRGBA.a);\n}\nvec4 linearToGammaSpaceRGBA(vec4 RGBA) {\n  return vec4(linearToGammaSpaceRGB(RGBA.rgb), RGBA.a);\n}\nfloat gammaToLinearSpaceExact(float val) {\n  if (val <= 0.04045) {\n    return val / 12.92;\n  } else if (val < 1.0) {\n    return pow((val + 0.055) / 1.055, 2.4);\n  } else {\n    return pow(val, 2.2);\n  }\n}\nfloat linearToGammaSpaceExact(float val) {\n  if (val <= 0.0) {\n    return 0.0;\n  } else if (val <= 0.0031308) {\n    return 12.92 * val;\n  } else if (val < 1.0) {\n    return 1.055 * pow(val, 0.4166667) - 0.055;\n  } else {\n    return pow(val, 0.45454545);\n  }\n}\n\nvec3 unpackNormal(vec4 nmap) {\n  return nmap.xyz * 2.0 - 1.0;\n}\nvec3 unpackRGBE(vec4 rgbe) {\n    return rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvoid main() {\n#if USE_RGBE_HDR\n    vec3 c = unpackRGBE(textureCube(cubeMap, viewDir));\n    c = linearToGammaSpaceRGB(c / (1.0 + c));\n    gl_FragColor = vec4(c, 1.0);\n#else\n    gl_FragColor = textureCube(cubeMap, viewDir);\n#endif\n}",defines:[]},{name:"sprite",vert:"\nattribute vec3 a_position;\nuniform mat4 model;\nuniform mat4 viewProj;\nattribute vec2 a_uv0;\nattribute vec4 a_color;\nvarying vec2 uv0;\nvarying vec4 color;\nvoid main () {\n  vec4 pos = vec4(a_position, 1);\n  pos = viewProj * model * pos;\n  uv0 = a_uv0;\n  color = a_color;\n  gl_Position = pos;\n}",frag:"\nuniform sampler2D mainTexture;\nvarying vec2 uv0;\nvarying vec4 color;\nvoid main () {\n  vec4 o = vec4(1, 1, 1, 1);\n  o *= texture2D(mainTexture, uv0);\n  o *= color;\n  gl_FragColor = o;\n}",defines:[]},{name:"unlit",vert:"\nattribute vec3 a_position;\nuniform mat4 model;\nuniform mat4 viewProj;\n#if USE_TEXTURE\n  attribute vec2 a_uv0;\n  uniform vec2 mainTiling;\n  uniform vec2 mainOffset;\n  varying vec2 uv0;\n#endif\n#if USE_SKINNING\n  \nattribute vec4 a_weights;\nattribute vec4 a_joints;\n#if USE_JOINTS_TEXTURE\nuniform sampler2D u_jointsTexture;\nuniform float u_jointsTextureSize;\nmat4 getBoneMatrix(const in float i) {\n  float size = u_jointsTextureSize;\n  float j = i * 4.0;\n  float x = mod(j, size);\n  float y = floor(j / size);\n  float dx = 1.0 / size;\n  float dy = 1.0 / size;\n  y = dy * (y + 0.5);\n  vec4 v1 = texture2D(u_jointsTexture, vec2(dx * (x + 0.5), y));\n  vec4 v2 = texture2D(u_jointsTexture, vec2(dx * (x + 1.5), y));\n  vec4 v3 = texture2D(u_jointsTexture, vec2(dx * (x + 2.5), y));\n  vec4 v4 = texture2D(u_jointsTexture, vec2(dx * (x + 3.5), y));\n  return mat4(v1, v2, v3, v4);\n}\n#else\nuniform mat4 u_jointMatrices[128];\nmat4 getBoneMatrix(const in float i) {\n  return u_jointMatrices[int(i)];\n}\n#endif\nmat4 skinMatrix() {\n  return\n    getBoneMatrix(a_joints.x) * a_weights.x +\n    getBoneMatrix(a_joints.y) * a_weights.y +\n    getBoneMatrix(a_joints.z) * a_weights.z +\n    getBoneMatrix(a_joints.w) * a_weights.w\n    ;\n}\n#endif\nvoid main () {\n  vec4 pos = vec4(a_position, 1);\n  #if USE_SKINNING\n    pos = skinMatrix() * pos;\n  #endif\n  pos = viewProj * model * pos;\n  #if USE_TEXTURE\n    uv0 = a_uv0 * mainTiling + mainOffset;\n  #endif\n  gl_Position = pos;\n}",frag:"\n#if USE_TEXTURE\n  uniform sampler2D mainTexture;\n  varying vec2 uv0;\n#endif\n#if USE_COLOR\n  uniform vec4 color;\n#endif\nvoid main () {\n  vec4 o = vec4(1, 1, 1, 1);\n  #if USE_TEXTURE\n    o *= texture2D(mainTexture, uv0);\n  #endif\n  #if USE_COLOR\n    o *= color;\n  #endif\n  gl_FragColor = o;\n}",defines:[{name:"USE_TEXTURE"},{name:"USE_COLOR"},{name:"USE_SKINNING"}]},{name:"wireframe",vert:"\nattribute vec3 a_position;\nattribute vec3 a_normal;\nuniform mat4 model, viewProj;\nuniform mat3 normalMatrix;\nvarying vec3 position_w;\nvarying vec3 normal_w;\nvoid main () {\n  vec4 pos = vec4(a_position, 1);\n  position_w = (model * pos).xyz;\n  pos = viewProj * model * pos;\n  normal_w = normalMatrix * a_normal.xyz;\n  gl_Position = pos;\n}",frag:"\nuniform vec3 eye;\nuniform vec3 color;\nvarying vec3 position_w;\nvarying vec3 normal_w;\nvoid main () {\n  gl_FragColor = vec4(color, 1.0);\n  vec3 e2p = normalize(eye - position_w);\n  if (dot (normal_w, e2p) <= 0.0) {\n    gl_FragColor.rgb *= 0.6;\n  }\n}",defines:[]}];var Kr=0;function Zr(e,t,n){var r=[];for(var i in t){if(n[i]===undefined){if(t[i]===true){r.push("#define "+i+" 1")}else if(t[i]===false){r.push("#define "+i+" 0")}}else{if(e.ext(n[i])&&t[i]===true){r.push("#define "+i+" 1")}else{r.push("#define "+i+" 0")}}}return r.join("\n")}function Qr(e,t){var n={};var r=e;for(var i in t){if(Number.isInteger(t[i])){n[i]=t[i]}}for(var a in n){var o=new RegExp(a,"g");r=r.replace(o,n[a])}return r}function Jr(e){var t=/#pragma for (\w+) in range\(\s*(\d+)\s*,\s*(\d+)\s*\)([\s\S]+?)#pragma endFor/g;function n(e,t,n,r,i){var a="";var o=parseInt(n);var s=parseInt(r);if(o.isNaN||s.isNaN){console.error("Unroll For Loops Error: begin and end of range must be an int num.")}for(var l=o;l<s;++l){a+=i.replace(new RegExp("{"+t+"}","g"),l)}return a}return e.replace(t,n)}var $r=function e(t,n,r){var i=this;if(n===void 0)n=[];if(r===void 0)r={};this._device=t;this._precision="precision highp float;\n";this._templates={};for(var a=0;a<n.length;++a){var o=n[a];i.define(o.name,o.vert,o.frag,o.defines)}this._chunks={};Object.assign(this._chunks,r);this._cache={}};$r.prototype.define=function e(t,n,r,i){if(this._templates[t]){console.warn("Failed to define shader "+t+": already exists.");return}var a=++Kr;var o=0;for(var s=0;s<i.length;++s){var l=i[s];var u=1;if(l.min!==undefined&&l.max!==undefined){u=Math.ceil((l.max-l.min)*.5);l._map=function(e){return e-this.min<<this._offset}.bind(l)}else{l._map=function(e){if(e){return 1<<this._offset}return 0}.bind(l)}o+=u;l._offset=o}n=this._precision+n;r=this._precision+r;this._templates[t]={id:a,name:t,vert:n,frag:r,defines:i}};$r.prototype.hasProgram=function e(t){return this._templates[t]!==undefined};$r.prototype.getKey=function e(t,n){var r=this._templates[t];var i=0;for(var a=0;a<r.defines.length;++a){var o=r.defines[a];var s=n[o.name];if(s===undefined){continue}i|=o._map(s)}return i<<8|r.id};$r.prototype.getProgram=function e(t,n,r){var i=this.getKey(t,n);var a=this._cache[i];if(a){return a}var o=this._templates[t];var s=Zr(this._device,n,r)+"\n";var l=Qr(o.vert,n);l=s+Jr(l);var u=Qr(o.frag,n);u=s+Jr(u);a=new Ae.Program(this._device,{vert:l,frag:u});a.link();this._cache[i]=a;return a};var ei=Ot.create();var ti=Bt.create();var ni=Lt.zero();var ri=Lt.zero();var ii=It.create();var ai=new pr(function(){return{stage:null,items:null}},8);var oi=new pr(function(){return new Float32Array(2)},8);var si=new pr(function(){return new Float32Array(3)},8);var li=new pr(function(){return new Float32Array(4)},8);var ui=new pr(function(){return new Float32Array(9)},8);var hi=new pr(function(){return new Float32Array(16)},8);var ci=new pr(function(){return new Float32Array(64)},8);var fi=new pr(function(){return new Int32Array(2)},8);var pi=new pr(function(){return new Int32Array(3)},8);var di=new pr(function(){return new Int32Array(4)},8);var vi=new pr(function(){return new Int32Array(64)},8);var mi={};mi[Me.PARAM_INT]=function(e){return e};mi[Me.PARAM_INT2]=function(e){return Rt.array(fi.add(),e)};mi[Me.PARAM_INT3]=function(e){return Lt.array(pi.add(),e)};mi[Me.PARAM_INT4]=function(e){return Ct.array(di.add(),e)};mi[Me.PARAM_FLOAT]=function(e){return e};mi[Me.PARAM_FLOAT2]=function(e){return Rt.array(oi.add(),e)};mi[Me.PARAM_FLOAT3]=function(e){return Lt.array(si.add(),e)};mi[Me.PARAM_FLOAT4]=function(e){return Ct.array(li.add(),e)};mi[Me.PARAM_COLOR3]=function(e){return Dt.array(si.add(),e)};mi[Me.PARAM_COLOR4]=function(e){return Ft.array(li.add(),e)};mi[Me.PARAM_MAT2]=function(e){return Ut.array(li.add(),e)};mi[Me.PARAM_MAT3]=function(e){return Ot.array(ui.add(),e)};mi[Me.PARAM_MAT4]=function(e){return Bt.array(hi.add(),e)};var _i={};_i[Me.PARAM_INT]={func:function e(t){var n=vi.add();for(var r=0;r<t.length;++r){n[r]=t[r]}return n},size:1};_i[Me.PARAM_INT2]={func:function e(t){var n=vi.add();for(var r=0;r<t.length;++r){n[2*r]=t[r].x;n[2*r+1]=t[r].y}return n},size:2};_i[Me.PARAM_INT3]={func:undefined,size:3};_i[Me.PARAM_INT4]={func:function e(t){var n=vi.add();for(var r=0;r<t.length;++r){var i=t[r];n[4*r]=i.x;n[4*r+1]=i.y;n[4*r+2]=i.z;n[4*r+3]=i.w}return n},size:4};_i[Me.PARAM_FLOAT]={func:function e(t){var n=ci.add();for(var r=0;r<t.length;++r){n[r]=t[r]}return n},size:1};_i[Me.PARAM_FLOAT2]={func:function e(t){var n=ci.add();for(var r=0;r<t.length;++r){n[2*r]=t[r].x;n[2*r+1]=t[r].y}return n},size:2};_i[Me.PARAM_FLOAT3]={func:undefined,size:3};_i[Me.PARAM_FLOAT4]={func:function e(t){var n=ci.add();for(var r=0;r<t.length;++r){var i=t[r];n[4*r]=i.x;n[4*r+1]=i.y;n[4*r+2]=i.z;n[4*r+3]=i.w}return n},size:4};_i[Me.PARAM_COLOR3]={func:undefined,size:3};_i[Me.PARAM_COLOR4]={func:function e(t){var n=ci.add();for(var r=0;r<t.length;++r){var i=t[r];n[4*r]=i.r;n[4*r+1]=i.g;n[4*r+2]=i.b;n[4*r+3]=i.a}return n},size:4};_i[Me.PARAM_MAT2]={func:function e(t){var n=ci.add();for(var r=0;r<t.length;++r){var i=t[r];n[4*r]=i.m00;n[4*r+1]=i.m01;n[4*r+2]=i.m02;n[4*r+3]=i.m03}return n},size:4};_i[Me.PARAM_MAT3]={func:undefined,size:9};_i[Me.PARAM_MAT4]={func:function e(t){var n=ci.add();for(var r=0;r<t.length;++r){var i=t[r];n[16*r]=i.m00;n[16*r+1]=i.m01;n[16*r+2]=i.m02;n[16*r+3]=i.m03;n[16*r+4]=i.m04;n[16*r+5]=i.m05;n[16*r+6]=i.m06;n[16*r+7]=i.m07;n[16*r+8]=i.m08;n[16*r+9]=i.m09;n[16*r+10]=i.m10;n[16*r+11]=i.m11;n[16*r+12]=i.m12;n[16*r+13]=i.m13;n[16*r+14]=i.m14;n[16*r+15]=i.m15}return n},size:16};var gi=function e(t,n){var r;this._device=t;this._programLib=new $r(t,Yr,Xr);this._opts=n;this._type2defaultValue=(r={},r[Me.PARAM_INT]=0,r[Me.PARAM_INT2]=Rt.new(0,0),r[Me.PARAM_INT3]=Lt.new(0,0,0),r[Me.PARAM_INT4]=Ct.new(0,0,0,0),r[Me.PARAM_FLOAT]=0,r[Me.PARAM_FLOAT2]=Rt.new(0,0),r[Me.PARAM_FLOAT3]=Lt.new(0,0,0),r[Me.PARAM_FLOAT4]=Ct.new(0,0,0,0),r[Me.PARAM_COLOR3]=Dt.new(0,0,0),r[Me.PARAM_COLOR4]=Ft.new(0,0,0,1),r[Me.PARAM_MAT2]=Ut.create(),r[Me.PARAM_MAT3]=Ot.create(),r[Me.PARAM_MAT4]=Bt.create(),r[Me.PARAM_TEXTURE_2D]=n.defaultTexture,r[Me.PARAM_TEXTURE_CUBE]=n.defaultTextureCube,r);this._stage2fn={};this._modelType2fn={};this._usedTextureUnits=0;this.frustum_test_func=ln.box_frustum;this._accurateFrustumCulling=false;this._viewPools=new pr(function(){return new Mn},8);this._drawItemsPools=new pr(function(){return{model:null,node:null,ia:null,effect:null,defines:null,dependencies:null}},100);this._stageItemsPools=new pr(function(){return new pr(function(){return{model:null,node:null,ia:null,effect:null,defines:null,dependencies:null,technique:null,sortKey:-1}},100)},16)};var yi={accurateFrustumCulling:{configurable:true}};gi.prototype._resetTextureUnit=function e(){this._usedTextureUnits=0};gi.prototype._allocTextureUnit=function e(){var t=this._device;var n=this._usedTextureUnits;if(n>=t._caps.maxTextureUnits){console.warn("Trying to use "+n+" texture units while this GPU supports only "+t._caps.maxTextureUnits)}this._usedTextureUnits+=1;return n};gi.prototype._registerStage=function e(t,n){this._stage2fn[t]=n};gi.prototype._registerModel=function e(t,n){this._modelType2fn[t]=n};gi.prototype._reset=function e(){this._viewPools.reset();this._stageItemsPools.reset()};gi.prototype._requestView=function e(){var t=this._viewPools.add();t.fullUpdate=this._accurateFrustumCulling;return t};yi.accurateFrustumCulling.set=function(e){this._accurateFrustumCulling=e;if(!e){this.frustum_test_func=ln.box_frustum}else{this.frustum_test_func=ln.box_frustum_accurate}};gi.prototype._render=function e(t,n){var r=this;var i=this._device;i.setFrameBuffer(t._framebuffer);i.setViewport(t._rect.x,t._rect.y,t._rect.w,t._rect.h);var a={};if(t._clearFlags&Me.CLEAR_COLOR){a.color=[t._color.r,t._color.g,t._color.b,t._color.a]}if(t._clearFlags&Me.CLEAR_DEPTH){a.depth=t._depth}if(t._clearFlags&Me.CLEAR_STENCIL){a.stencil=t._stencil}i.clear(a);this._drawItemsPools.reset();if(t._clearFlags&Me.CLEAR_SKYBOX&&t._clearModel!=null){var o=this._drawItemsPools.add();t._clearModel.extractDrawItem(o)}for(var s=0;s<n._models.length;++s){var l=n._models.data[s];if(t._cullingByID){if(l._viewID!==t._id){continue}}else{if(l._viewID!==-1){continue}}if(l._boundingBox!==null){l._node._getWorldPRS(ni,ii,ri);l._boundingBox.setTransform(ni,ii,ri,l._bbModelSpace);if(!r.frustum_test_func(l._boundingBox,t._frustum)){continue}}var u=r._drawItemsPools.add();l.extractDrawItem(u)}ai.reset();for(var h=0;h<t._stages.length;++h){var c=t._stages[h];var f=r._stageItemsPools.add();f.reset();for(var p=0;p<this._drawItemsPools.length;++p){var d=r._drawItemsPools.data[p];var v=d.effect.getTechnique(c);if(v){var m=f.add();m.model=d.model;m.node=d.node;m.ia=d.ia;m.effect=d.effect;m.defines=d.defines;m.dependencies=d.dependencies;m.technique=v;m.sortKey=-1}}var _=ai.add();_.stage=c;_.items=f}for(var g=0;g<ai.length;++g){var y=ai.data[g];var x=r._stage2fn[y.stage];x(t,y.items)}};gi.prototype._drawModel=function e(t){var n=t.model;var r=this._modelType2fn[n._type];if(!r){return}r(t)};gi.prototype._draw=function e(t){var n=this;var r=this._device;var i=this._programLib;var a=t.node;var o=t.ia;var s=t.effect;var l=t.technique;var u=t.defines;var h=t.dependencies;oi.reset();si.reset();li.reset();ui.reset();hi.reset();ci.reset();fi.reset();pi.reset();di.reset();vi.reset();a.getWorldMatrix(ti);r.setUniform("model",Bt.array(hi.add(),ti));Ot.normalFromMat4(ei,ti);r.setUniform("normalMatrix",Ot.array(ui.add(),ei));for(var c=0;c<l._parameters.length;++c){var f=l._parameters[c];var p=s.getProperty(f.name);if(p===undefined||p===null){p=f.val}if(p===undefined||p===null){p=n._type2defaultValue[f.type]}if(p===undefined||p===null){console.warn("Failed to set technique property "+f.name+", value not found.");continue}if(f.type===Me.PARAM_TEXTURE_2D||f.type===Me.PARAM_TEXTURE_CUBE){if(u["USE_"+f.name.toUpperCase()]==false){continue}if(f.size!==undefined){if(f.size!==p.length){console.error("The length of texture array ("+p.length+") is not corrent(expect "+f.size+").");continue}var d=vi.add();for(var v=0;v<p.length;++v){d[v]=n._allocTextureUnit()}r.setTextureArray(f.name,p,d)}else{r.setTexture(f.name,p,n._allocTextureUnit())}}else{var m=void 0;if(f.size!==undefined){var _=_i[f.type];if(_.func===undefined){console.error("Uniform array of color3/int3/float3/mat3 can not be supportted!");continue}if(f.size*_.size>64){console.error("Uniform array is too long!");continue}m=_.func(p)}else{var g=mi[f.type];m=g(p)}r.setUniform(f.name,m)}}for(var y=0;y<l._passes.length;++y){var x=l._passes[y];var b=o.count;r.setVertexBuffer(0,o._vertexBuffer);if(o._indexBuffer){r.setIndexBuffer(o._indexBuffer)}r.setPrimitiveType(o._primitiveType);var w=i.getProgram(x._programName,u,h);r.setProgram(w);r.setCullMode(x._cullMode);if(x._blend){r.enableBlend();r.setBlendFuncSep(x._blendSrc,x._blendDst,x._blendSrcAlpha,x._blendDstAlpha);r.setBlendEqSep(x._blendEq,x._blendAlphaEq);r.setBlendColor32(x._blendColor)}if(x._depthTest){r.enableDepthTest();r.setDepthFunc(x._depthFunc)}if(x._depthWrite){r.enableDepthWrite()}if(x._stencilTest){r.enableStencilTest();r.setStencilFuncFront(x._stencilFuncFront,x._stencilRefFront,x._stencilMaskFront);r.setStencilOpFront(x._stencilFailOpFront,x._stencilZFailOpFront,x._stencilZPassOpFront,x._stencilWriteMaskFront);r.setStencilFuncBack(x._stencilFuncBack,x._stencilRefBack,x._stencilMaskBack);r.setStencilOpBack(x._stencilFailOpBack,x._stencilZFailOpBack,x._stencilZPassOpBack,x._stencilWriteMaskBack)}r.draw(o._start,b);n._resetTextureUnit()}};Object.defineProperties(gi.prototype,yi);function xi(e,t,n,r){e[n]=new r(e._data);Object.defineProperty(e,t,{get:function e(){return this[n]}})}var bi=function e(t,n){var r=this;this._data=new ArrayBuffer(t);for(var i=0;i<n.length;++i){var a=n[i];if(a===Me.BUFFER_VIEW_INT8){xi(r,"int8View","_int8View",Int8Array)}else if(a===Me.BUFFER_VIEW_UINT8){xi(r,"uint8View","_uint8View",Uint8Array)}else if(a===Me.BUFFER_VIEW_INT16){xi(r,"int16View","_int16View",Int16Array)}else if(a===Me.BUFFER_VIEW_UINT16){xi(r,"uint16View","_uint16View",Uint16Array)}else if(a===Me.BUFFER_VIEW_INT32){xi(r,"int32View","_int32View",Int32Array)}else if(a===Me.BUFFER_VIEW_UINT32){xi(r,"uint32View","_uint32View",Uint32Array)}else if(a===Me.BUFFER_VIEW_FLOAT32){xi(r,"float32View","_float32View",Float32Array)}}};var wi=512e3;var Ei=64;var Ti=zt.log2(Ei);var Si=function e(t,n){var r=this;if(t===void 0)t=wi;if(n===void 0)n=[Me.BUFFER_VIEW_FLOAT32];this._buffers=[];this._maxBytes=zt.nextPow2(t);this._maxLog=zt.log2(this._maxBytes);for(var i=Ti;i<=this._maxLog;++i){r._buffers.push(new bi(1<<i,n))}};var Ai={maxBytes:{configurable:true}};Ai.maxBytes.get=function(){return this._maxBytes};Si.prototype.request=function e(t){var n=zt.nextPow2(t);var r=zt.log2(n);if(r>this._maxLog){return this._buffers[this._maxLog-Ti]}else if(r<Ti){return this._buffers[0]}else{return this._buffers[r-Ti]}};Object.defineProperties(Si.prototype,Ai);var Mi={};Mi[Ae.ATTR_TYPE_INT8]=Me.BUFFER_VIEW_INT8;Mi[Ae.ATTR_TYPE_UINT8]=Me.BUFFER_VIEW_UINT8;Mi[Ae.ATTR_TYPE_INT16]=Me.BUFFER_VIEW_INT16;Mi[Ae.ATTR_TYPE_UINT16]=Me.BUFFER_VIEW_UINT16;Mi[Ae.ATTR_TYPE_INT32]=Me.BUFFER_VIEW_INT32;Mi[Ae.ATTR_TYPE_UINT32]=Me.BUFFER_VIEW_UINT32;Mi[Ae.ATTR_TYPE_FLOAT32]=Me.BUFFER_VIEW_FLOAT32;var Ri=function e(t,n,r,i,a,o,s){var l=this;if(o===void 0)o=Ae.INDEX_FMT_UINT16;if(s===void 0)s=-1;var u=[];for(var h=0;h<i._elements.length;++h){var c=i._elements[h].type;var f=Mi[c];if(u.indexOf(f)===-1){u.push(f)}}this._bytesPerVeretx=i._bytes;this._vdataPool=new Si(this._bytesPerVeretx*a,u);if(s!==-1){var p=-1;if(o===Ae.INDEX_FMT_UINT8){p=Me.BUFFER_VIEW_UINT8;this._bytesPerIndex=1}else if(o===Ae.INDEX_FMT_UINT16){p=Me.BUFFER_VIEW_UINT16;this._bytesPerIndex=2}else if(o===Ae.INDEX_FMT_UINT32){p=Me.BUFFER_VIEW_UINT32;this._bytesPerIndex=4}this._idataPool=new Si(this._bytesPerIndex*s,[p])}this._maxVerts=a;this._maxIndices=s;this._IAs=new Xn(function(){return new Re(new Ae.VertexBuffer(t,i,Ae.USAGE_DYNAMIC,null,Math.ceil(l._vdataPool.maxBytes/l._bytesPerVeretx)),s===-1?null:new Ae.IndexBuffer(t,o,Ae.USAGE_DYNAMIC,null,Math.ceil(l._idataPool.maxBytes/l._bytesPerIndex)),r)},n)};var Li={maxVerts:{configurable:true},maxIndices:{configurable:true}};Li.maxVerts.get=function(){return this._maxVerts};Li.maxIndices.get=function(){return this._maxIndices};Ri.prototype.requestIA=function e(){return this._IAs.request()};Ri.prototype.requestVData=function e(t){return this._vdataPool.request(t*this._bytesPerVeretx)};Ri.prototype.requestIData=function e(t){return this._idataPool.request(t*this._bytesPerIndex)};Object.defineProperties(Ri.prototype,Li);var Ci=Lt.zero();var Oi=Lt.zero();var Ii=Lt.zero();var Ui=new Float32Array(16);var Pi=new Float32Array(16);var Bi=new Float32Array(16);var Di=new Float32Array(16);var Fi=new Float32Array(3);var zi=function(n){function e(e,t){n.call(this,e,t);this._directionalLights=[];this._pointLights=[];this._spotLights=[];this._shadowLights=[];this._sceneAmbient=new Float32Array([.5,.5,.5]);this._registerStage("shadowcast",this._shadowStage.bind(this));this._registerStage("opaque",this._opaqueStage.bind(this));this._registerStage("transparent",this._transparentStage.bind(this));this._registerStage("ui",this._uiStage.bind(this));this._registerModel("default",this._draw.bind(this));this._registerModel("line-batch",this._drawLineBatch.bind(this));this._registerModel("sprite-batch",this._drawSpriteBatch.bind(this));this._registerModel("particle-batch",this._drawParticleBatch.bind(this));this._registerModel("skinning",this._drawSkinning.bind(this));this._lineIAs=new Ri(e,2,Ae.PT_LINES,new Ae.VertexFormat([{name:Ae.ATTR_POSITION,type:Ae.ATTR_TYPE_FLOAT32,num:3},{name:Ae.ATTR_COLOR,type:Ae.ATTR_TYPE_FLOAT32,num:3}]),2e3);this._spriteIAs=new Ri(e,2,Ae.PT_TRIANGLES,new Ae.VertexFormat([{name:Ae.ATTR_POSITION,type:Ae.ATTR_TYPE_FLOAT32,num:3},{name:Ae.ATTR_UV0,type:Ae.ATTR_TYPE_FLOAT32,num:2},{name:Ae.ATTR_COLOR,type:Ae.ATTR_TYPE_FLOAT32,num:4}]),2e3,Ae.INDEX_FMT_UINT16,2e3)}if(n)e.__proto__=n;e.prototype=Object.create(n&&n.prototype);e.prototype.constructor=e;e.prototype.updateLights=function e(t){var n=this;this._directionalLights.length=0;this._pointLights.length=0;this._spotLights.length=0;this._shadowLights.length=0;var r=t._lights;for(var i=0;i<r.length;++i){var a=r.data[i];a.update(n._device);if(a.shadowType!==Me.SHADOW_NONE){n._shadowLights.push(a);var o=n._requestView();a.extractView(o,["shadowcast"])}if(a._type===Me.LIGHT_DIRECTIONAL){n._directionalLights.push(a)}else if(a._type===Me.LIGHT_POINT){n._pointLights.push(a)}else{n._spotLights.push(a)}}};e.prototype.render=function e(t){var n=this;this._reset();var r=this._device._gl.canvas;this.updateLights(t);if(t._debugCamera){var i=this._requestView();t._debugCamera.extractView(i,r.width,r.height)}else{for(var a=0;a<t._cameras.length;++a){var o=n._requestView();t._cameras.data[a].extractView(o,r.width,r.height)}}this._viewPools.sort(function(e,t){return e._priority-t._priority});t._views.sort(function(e,t){return e._priority-t._priority});for(var s=0;s<this._viewPools.length;++s){var l=n._viewPools.data[s];n._render(l,t)}for(var u=0;u<t._views.length;++u){var h=t._views[u];n._render(h,t)}};e.prototype._submitLightUniforms=function e(){var t=this;this._device.setUniform("sceneAmbient",this._sceneAmbient);if(this._directionalLights.length>0){for(var n=0;n<this._directionalLights.length;++n){var r=t._directionalLights[n];t._device.setUniform("dir_light"+n+"_direction",r._directionUniform);t._device.setUniform("dir_light"+n+"_color",r._colorUniform)}}if(this._pointLights.length>0){for(var i=0;i<this._pointLights.length;++i){var a=t._pointLights[i];t._device.setUniform("point_light"+i+"_position",a._positionUniform);t._device.setUniform("point_light"+i+"_color",a._colorUniform);t._device.setUniform("point_light"+i+"_range",a._range)}}if(this._spotLights.length>0){for(var o=0;o<this._spotLights.length;++o){var s=t._spotLights[o];t._device.setUniform("spot_light"+o+"_position",s._positionUniform);t._device.setUniform("spot_light"+o+"_direction",s._directionUniform);t._device.setUniform("spot_light"+o+"_color",s._colorUniform);t._device.setUniform("spot_light"+o+"_range",s._range);t._device.setUniform("spot_light"+o+"_spot",s._spotUniform)}}};e.prototype._submitShadowStageUniforms=function e(t){var n=t._shadowLight;this._device.setUniform("minDepth",n.shadowMinDepth);this._device.setUniform("maxDepth",n.shadowMaxDepth);this._device.setUniform("bias",n.shadowBias);this._device.setUniform("depthScale",n.shadowDepthScale)};e.prototype._submitOtherStagesUniforms=function e(){var t=this;for(var n=0;n<this._shadowLights.length;++n){var r=t._shadowLights[n];t._device.setUniform("lightViewProjMatrix_"+n,Bt.array(Di,r.viewProjMatrix));t._device.setUniform("minDepth_"+n,r.shadowMinDepth);t._device.setUniform("maxDepth_"+n,r.shadowMaxDepth);t._device.setUniform("bias_"+n,r.shadowBias);t._device.setUniform("depthScale_"+n,r.shadowDepthScale);t._device.setUniform("darkness_"+n,r.shadowDarkness);t._device.setUniform("frustumEdgeFalloff_"+n,r.frustumEdgeFalloff);t._device.setUniform("texelSize_"+n,new Float32Array([1/r.shadowResolution,1/r.shadowResolution]))}};e.prototype._updateShaderDefines=function e(t){var n=this;for(var r=0;r<t.length;++r){var i=t.data[r];var a=i.defines;a.NUM_DIR_LIGHTS=Math.min(4,n._directionalLights.length);a.NUM_POINT_LIGHTS=Math.min(4,n._pointLights.length);a.NUM_SPOT_LIGHTS=Math.min(4,n._spotLights.length);a.NUM_SHADOW_LIGHTS=Math.min(4,n._shadowLights.length)}};e.prototype._uiStage=function e(t,n){var r=this;this._device.setUniform("view",Bt.array(Ui,t._matView));this._device.setUniform("proj",Bt.array(Pi,t._matProj));this._device.setUniform("viewProj",Bt.array(Bi,t._matViewProj));n.sort(function(e,t){return e.model._userKey-t.model._userKey});for(var i=0;i<n.length;++i){var a=n.data[i];r._drawModel(a)}};e.prototype._shadowStage=function e(t,n){var r=this;var i=this._programLib;this._device.setUniform("lightViewProjMatrix",Bt.array(Bi,t._matViewProj));this._submitLightUniforms();this._submitShadowStageUniforms(t);this._updateShaderDefines(n);for(var a=0;a<n.length;++a){var o=n.data[a];o.sortKey=i.getKey(o.technique._passes[0]._programName,o.defines)}n.sort(function(e,t){var n=e.technique;var r=t.technique;if(n._layer!==r._layer){return n._layer-r._layer}if(n._passes.length!==r._passes.length){return n._passes.length-r._passes.length}return e.sortKey-t.sortKey});for(var s=0;s<n.length;++s){var l=n.data[s];if(l.model._castShadow){r._drawModel(l)}}};e.prototype._opaqueStage=function e(t,n){var r=this;var i=this._programLib;t.getPosition(Ci);this._device.setUniform("view",Bt.array(Ui,t._matView));this._device.setUniform("proj",Bt.array(Pi,t._matProj));this._device.setUniform("viewProj",Bt.array(Bi,t._matViewProj));this._device.setUniform("eye",Lt.array(Fi,Ci));this._submitLightUniforms();this._submitOtherStagesUniforms();this._updateShaderDefines(n);for(var a=0;a<n.length;++a){var o=n.data[a];o.sortKey=i.getKey(o.technique._passes[0]._programName,o.defines)}n.sort(function(e,t){var n=e.technique;var r=t.technique;if(n._layer!==r._layer){return n._layer-r._layer}if(n._passes.length!==r._passes.length){return n._passes.length-r._passes.length}return e.sortKey-t.sortKey});for(var s=0;s<n.length;++s){var l=n.data[s];for(var u=0;u<this._shadowLights.length;++u){var h=r._shadowLights[u];r._device.setTexture("shadowMap_"+u,h.shadowMap,r._allocTextureUnit())}r._drawModel(l)}};e.prototype._transparentStage=function e(t,n){var r=this;t.getPosition(Ci);t.getForward(Oi);this._device.setUniform("view",Bt.array(Ui,t._matView));this._device.setUniform("proj",Bt.array(Pi,t._matProj));this._device.setUniform("viewProj",Bt.array(Bi,t._matViewProj));this._device.setUniform("eye",Lt.array(Fi,Ci));for(var i=0;i<n.length;++i){var a=n.data[i];a.node.getWorldPos(Ii);Lt.sub(Ii,Ii,Ci);a.sortKey=Lt.dot(Ii,Oi)}this._submitLightUniforms();this._submitOtherStagesUniforms();this._updateShaderDefines(n);n.sort(function(e,t){if(e.technique._layer!==t.technique._layer){return e.technique._layer-t.technique._layer}return t.sortKey-e.sortKey});for(var o=0;o<n.length;++o){var s=n.data[o];for(var l=0;l<this._shadowLights.length;++l){var u=r._shadowLights[l];r._device.setTexture("shadowMap_"+l,u.shadowMap,r._allocTextureUnit())}r._drawModel(s)}};e.prototype._drawSkinning=function e(t){var n=t.model;var r=t.defines;r.USE_SKINNING=true;if(n._jointsTexture!=null){r.USE_JOINTS_TEXTURE=true;this._device.setTexture("u_jointsTexture",n._jointsTexture,this._allocTextureUnit());this._device.setUniform("u_jointsTextureSize",n._jointsTexture._width)}else{r.USE_JOINTS_TEXTURE=false;this._device.setUniform("u_jointMatrices",n._jointsMatrixArray)}this._draw(t)};e.prototype._drawLineBatch=function e(t){var n=this;var r=t.model;var i=0;var a=this._lineIAs.requestVData(r.vertCount);var o=a.float32View;for(var s=r.lineCount-1;s>=0;--s){var l=r.getLine(s);if(i+2>=n._lineIAs.maxVerts){var u=n._lineIAs.requestIA();u._vertexBuffer.update(0,o);u._start=0;u._count=i;t.ia=u;n._draw(t);i=0}var h=i*6;o[h]=l.start.x;o[h+1]=l.start.y;o[h+2]=l.start.z;o[h+3]=l.color.r;o[h+4]=l.color.g;o[h+5]=l.color.b;o[h+6]=l.end.x;o[h+7]=l.end.y;o[h+8]=l.end.z;o[h+9]=l.color.r;o[h+10]=l.color.g;o[h+11]=l.color.b;i+=2}if(i>0){var c=this._lineIAs.requestIA();c._vertexBuffer.update(0,o);c._start=0;c._count=i;t.ia=c;this._draw(t)}};e.prototype._drawSpriteBatch=function e(t){var n=this;var r=t.model;var i=0;var a=0;var o=0;var s=this._spriteIAs.requestVData(r.vertCount);var l=this._spriteIAs.requestIData(r.indexCount);var u=s.float32View;var h=l.uint16View;for(var c=0;c<r.spriteCount;++c){var f=r.getSprite(c);var p=f.refPositions.length;var d=f.refIndices.length;if(a+p>=n._spriteIAs.maxVerts||o+d>=n._spriteIAs.maxIndices){var v=n._spriteIAs.requestIA();v._vertexBuffer.update(0,u);v._indexBuffer.update(0,h);v._start=0;v._count=o;t.ia=v;n._draw(t);i=0;a=0;o=0}for(var m=0;m<p;++m){var _=a*9;u[_]=f.refPositions[m].x;u[_+1]=f.refPositions[m].y;u[_+2]=f.refPositions[m].z;u[_+3]=f.refUVs[m].x;u[_+4]=f.refUVs[m].y;u[_+5]=f.refColor.r;u[_+6]=f.refColor.g;u[_+7]=f.refColor.b;u[_+8]=f.refColor.a;a+=1}for(var g=0;g<d;++g){var y=o;h[y]=i+f.refIndices[g];o+=1}i+=p}if(o>0){var x=this._spriteIAs.requestIA();x._vertexBuffer.update(0,u);x._indexBuffer.update(0,h);x._start=0;x._count=o;t.ia=x;this._draw(t)}};e.prototype._drawParticleBatch=function e(t){t.ia=t.model._ia;this._draw(t)};return e}(gi);var Ni={addStage:Ue.addStage,createIA:ze,Pass:Ce,Technique:Be,Effect:Fe,InputAssembler:Re,View:Mn,Light:Dn,Camera:jn,Model:qn,Scene:Vr,LineBatchModel:Wr,SpriteBatchModel:Gr,ParticleBatchModel:jr,SkinningModel:qr,ForwardRenderer:zi};Object.assign(Ni,Me);var ki={KEY_NONE:0,KEY_DOWN:1,KEY_PRESSING:2,KEY_UP:3,TOUCH_START:0,TOUCH_PRESSING:1,TOUCH_END:2,TOUCH_CANCEL:3,LOCK_NEVER:0,LOCK_WHEN_PRESSED:1,LOCK_ALWAYS:2};var Vi=null;var Wi=["start","pressing","end","cancel"];var Gi=["none","down","pressing","up"];var Hi=function e(t,n){var a=this;n=n||{};if(!Vi&&n.useMask){Vi=document.createElement("div");Vi.classList.add("drag-mask");Vi.style.position="fixed";Vi.style.zIndex="9999";Vi.style.top="0";Vi.style.right="0";Vi.style.bottom="0";Vi.style.left="0";Vi.oncontextmenu=function(){return false}}this._view=t;this._element=t.canvas;this._element.requestPointerLock=this._element.requestPointerLock||this._element.mozRequestPointerLock;this._element.exitPointerLock=this._element.exitPointerLock||this._element.mozExitPointerLock;this._enabled=true;if(n.enabled!==undefined){this._enabled=n.enabled}this._lock=ki.LOCK_NEVER;if(n.lock!==undefined){this._lock=n.lock}this._useMask=false;if(n.useMask!==undefined){this._useMask=n.useMask}this._maskCursor="default";if(n.maskCursor!==undefined){this._maskCursor=n.maskCursor}this._invertY=false;if(n.invertY!==undefined){this._invertY=n.invertY}var r=navigator.userAgent.toLowerCase();if(/mobile|android|iphone|ipad|phone/i.test(r)){this._hasTouch=true}this._globalEventInstalled=false;this._pointerLocked=false;this._mouseGrabbed=false;this._mouse={x:0,y:0,dx:0,dy:0,prevX:0,prevY:0,scrollX:0,scrollY:0,left:ki.KEY_NONE,right:ki.KEY_NONE,middle:ki.KEY_NONE};this._keys=new cr(function(){return{_next:null,_prev:null,_state:0,key:"",get state(){return Gi[this._state]}}},100);this._touches=new pr(function(){return{id:-1,x:0,y:0,dx:0,dy:0,prevX:0,prevY:0,get phase(){return Wi[this._phase]},_phase:-1}},16);this._mousemoveHandle=function(e){e.preventDefault();e.stopPropagation();a._mouse.dx=e.movementX;a._mouse.dy=e.movementY;if(a._pointerLocked){a._mouse.x+=e.movementX;if(a._invertY){a._mouse.y-=e.movementY}else{a._mouse.y+=e.movementY}}else{a._mouse.x=a._view._calcOffsetX(e.clientX,e.clientY);a._mouse.y=a._view._calcOffsetY(e.clientX,e.clientY)}};this._mousewheelHandle=function(e){e.preventDefault();e.stopPropagation();a._mouse.scrollX=e.deltaX;a._mouse.scrollY=e.deltaY};this._domMouseWheelHandle=function(e){e.preventDefault();e.stopPropagation();a._mouse.scrollX=0;a._mouse.scrollY=e.detail/3};this._mousedownHandle=function(e){e.preventDefault();e.stopPropagation();if(a._lock){a._lockPointer(true)}a._installGlobalEvents();a._element.focus();switch(e.button){case 0:if(a._mouse.left!==ki.KEY_PRESSING){a._mouse.left=ki.KEY_DOWN}break;case 1:if(a._mouse.middle!==ki.KEY_PRESSING){a._mouse.middle=ki.KEY_DOWN}break;case 2:if(a._mouse.right!==ki.KEY_PRESSING){a._mouse.right=ki.KEY_DOWN}break}};this._mouseupHandle=function(e){e.preventDefault();e.stopPropagation();a._mouse.dx=e.movementX;a._mouse.dy=e.movementY;a._mouse.prevX=a._mouse.x=a._view._calcOffsetX(e.clientX,e.clientY);a._mouse.prevY=a._mouse.y=a._view._calcOffsetY(e.clientX,e.clientY);switch(e.button){case 0:a._mouse.left=ki.KEY_UP;break;case 1:a._mouse.middle=ki.KEY_UP;break;case 2:a._mouse.right=ki.KEY_UP;break}};this._mouseenterHandle=function(e){e.preventDefault();e.stopPropagation();a._mouse.dx=0;a._mouse.dy=0;a._mouse.prevX=a._mouse.x=a._view._calcOffsetX(e.clientX,e.clientY);a._mouse.prevY=a._mouse.y=a._view._calcOffsetY(e.clientX,e.clientY)};this._mouseleaveHandle=function(e){e.preventDefault();e.stopPropagation();if(a._mouseGrabbed){return}a._uninstallGlobalEvents();a._mouse.dx=e.movementX;a._mouse.dy=e.movementY;a._mouse.prevX=a._mouse.x=a._view._calcOffsetX(e.clientX,e.clientY);a._mouse.prevY=a._mouse.y=a._view._calcOffsetY(e.clientX,e.clientY)};this._keydownHandle=function(e){e.stopPropagation();var t=a._keys.head;while(t){if(t.key===e.key){break}t=t._next}if(t&&t._state===ki.KEY_PRESSING){return}if(!t){t=a._keys.add()}t.key=e.key;t._state=ki.KEY_DOWN};this._keyupHandle=function(e){e.stopPropagation();var t=a._keys.head;while(t){if(t.key===e.key){break}t=t._next}if(t){a._keys.remove(t)}t=a._keys.add();t.key=e.key;t._state=ki.KEY_UP};this._touchstartHandle=function(e){e.preventDefault();for(var t=0;t<e.changedTouches.length;t++){var n=e.changedTouches[t];var r=a._touches.add();r.id=n.identifier;r._phase=ki.TOUCH_START;r.x=a._view._calcOffsetX(n.clientX,n.clientY);r.y=a._view._calcOffsetY(n.clientX,n.clientY);r.dx=0;r.dy=0;r.prevX=0;r.prevY=0}};this._touchmoveHandle=function(e){e.preventDefault();for(var t=0;t<a._touches.length;t++){for(var n=0;n<e.changedTouches.length;n++){var r=a._touches.data[t];var i=e.changedTouches[n];if(r.id===i.identifier){r._phase=ki.TOUCH_PRESSING;r.x=a._view._calcOffsetX(i.clientX,i.clientY);r.y=a._view._calcOffsetY(i.clientX,i.clientY);r.dx=r.x-r.prevX;r.dy=r.y-r.prevY}}}};this._touchendHandle=function(e){e.preventDefault();for(var t=0;t<a._touches.length;t++){for(var n=0;n<e.changedTouches.length;n++){var r=a._touches.data[t];var i=e.changedTouches[n];if(r.id===i.identifier){r._phase=ki.TOUCH_END;r.prevX=r.x=a._view._calcOffsetX(i.clientX,i.clientY);r.prevY=r.y=a._view._calcOffsetY(i.clientX,i.clientY);r.dx=0;r.dy=0}}}};this._touchcancelHandle=function(e){e.preventDefault();for(var t=0;t<a._touches.length;t++){for(var n=0;n<e.changedTouches.length;n++){var r=a._touches.data[t];var i=e.changedTouches[n];if(r.id===i.identifier){r._phase=ki.TOUCH_CANCEL;r.prevX=r.x=a._view._calcOffsetX(i.clientX,i.clientY);r.prevY=r.y=a._view._calcOffsetY(i.clientX,i.clientY);r.dx=0;r.dy=0}}}};this._contextmenuHandle=function(e){e.preventDefault();e.stopPropagation()};this._lockChangeHandle=function(){if(document.pointerLockElement===a._element||document.mozPointerLockElement===a._element){a._pointerLocked=true}else{a._pointerLocked=false}};if(this._enabled){this._registerEvents()}};var ji={enabled:{configurable:true},hasTouch:{configurable:true},mouseX:{configurable:true},mouseY:{configurable:true},mouseDeltaX:{configurable:true},mouseDeltaY:{configurable:true},mousePrevX:{configurable:true},mousePrevY:{configurable:true},mouseScrollX:{configurable:true},mouseScrollY:{configurable:true},mouseButtons:{configurable:true},touchCount:{configurable:true},hasKeyDown:{configurable:true},hasKeyUp:{configurable:true},hasMouseDown:{configurable:true},hasMouseUp:{configurable:true}};Hi.prototype._registerMousewheelEvent=function e(){this._element.addEventListener("mousewheel",this._mousewheelHandle,{passive:false});this._element.addEventListener("DOMMouseScroll",this._domMouseWheelHandle,{passive:false})};Hi.prototype._unregisterMousewheelEvent=function e(){this._element.removeEventListener("mousewheel",this._mousewheelHandle,{passive:true});this._element.removeEventListener("DOMMouseScroll",this._domMouseWheelHandle,{passive:true})};Hi.prototype.destroy=function e(){this._element.removeEventListener("mousedown",this._mousedownHandle);this._element.removeEventListener("mouseenter",this._mouseenterHandle);this._element.removeEventListener("mouseleave",this._mouseleaveHandle);this._element.removeEventListener("mousemove",this._mousemoveHandle);this._unregisterMousewheelEvent();this._element.removeEventListener("keydown",this._keydownHandle);this._element.removeEventListener("keyup",this._keyupHandle);this._element.removeEventListener("touchstart",this._touchstartHandle);this._element.removeEventListener("touchend",this._touchendHandle);this._element.removeEventListener("touchcancel",this._touchcancelHandle);this._element.removeEventListener("touchmove",this._touchmoveHandle);this._element.removeEventListener("contextmenu",this._contextmenuHandle);document.removeEventListener("pointerlockchange",this._lockChangeHandle);this._uninstallGlobalEvents()};Hi.prototype._registerEvents=function e(){this._element.addEventListener("mousedown",this._mousedownHandle);this._element.addEventListener("mouseenter",this._mouseenterHandle);this._element.addEventListener("mouseleave",this._mouseleaveHandle);this._element.addEventListener("mousemove",this._mousemoveHandle);this._registerMousewheelEvent();this._element.addEventListener("keydown",this._keydownHandle);this._element.addEventListener("keyup",this._keyupHandle);this._element.addEventListener("touchstart",this._touchstartHandle,false);this._element.addEventListener("touchend",this._touchendHandle,false);this._element.addEventListener("touchcancel",this._touchcancelHandle,false);this._element.addEventListener("touchmove",this._touchmoveHandle,false);this._element.addEventListener("contextmenu",this._contextmenuHandle);document.addEventListener("pointerlockchange",this._lockChangeHandle,false)};Hi.prototype._installGlobalEvents=function e(){if(this._globalEventInstalled){return}document.addEventListener("mouseup",this._mouseupHandle);document.addEventListener("mousemove",this._mousemoveHandle);document.addEventListener("mousewheel",this._mousewheelHandle,{passive:true});if(this._useMask){Vi.style.cursor=this._maskCursor||"default";document.body.appendChild(Vi)}this._globalEventInstalled=true};Hi.prototype._uninstallGlobalEvents=function e(){if(!this._globalEventInstalled){return}if(this._mouse.left!==ki.KEY_NONE&&this._mouse.left!==ki.KEY_UP||this._mouse.right!==ki.KEY_NONE&&this._mouse.right!==ki.KEY_UP||this._mouse.middle!==ki.KEY_NONE&&this._mouse.middle!==ki.KEY_UP){return}if(this._lock===ki.LOCK_WHEN_PRESSED){this._lockPointer(false)}if(this._mouseGrabbed){return}document.removeEventListener("mouseup",this._mouseupHandle);document.removeEventListener("mousemove",this._mousemoveHandle);document.removeEventListener("mousewheel",this._mousewheelHandle,{passive:true});if(this._useMask){Vi.remove()}this._globalEventInstalled=false};Hi.prototype._lockPointer=function e(t){if(t){if(this._pointerLocked){return}if(this._element.requestPointerLock){this._element.requestPointerLock();this._pointerLocked=true}return}else{if(!this._pointerLocked){return}if(document.exitPointerLock){document.exitPointerLock();this._pointerLocked=false}}};ji.enabled.get=function(){return this._enabled};ji.enabled.set=function(e){if(this._enabled!==e){this._enabled=e;if(this._enabled){this._registerEvents();if(this._mouseGrabbed){this._installGlobalEvents()}}else{this.destroy()}}};ji.hasTouch.get=function(){return this._hasTouch};ji.mouseX.get=function(){return this._mouse.x};ji.mouseY.get=function(){return this._mouse.y};ji.mouseDeltaX.get=function(){return this._mouse.dx};ji.mouseDeltaY.get=function(){return this._mouse.dy};ji.mousePrevX.get=function(){return this._mouse.prevX};ji.mousePrevY.get=function(){return this._mouse.prevY};ji.mouseScrollX.get=function(){return this._mouse.scrollX};ji.mouseScrollY.get=function(){return this._mouse.scrollY};ji.mouseButtons.get=function(){var e=0;var t=this._mouse.left;if(t===ki.KEY_DOWN||t===ki.KEY_PRESSING){e|=1}t=this._mouse.right;if(t===ki.KEY_DOWN||t===ki.KEY_PRESSING){e|=2}t=this._mouse.middle;if(t===ki.KEY_DOWN||t===ki.KEY_PRESSING){e|=4}return e};ji.touchCount.get=function(){return this._touches.length};ji.hasKeyDown.get=function(){var e=this._keys.head;while(e){if(e._state===ki.KEY_DOWN){return true}e=e._next}return false};ji.hasKeyUp.get=function(){var e=this._keys.head;while(e){if(e._state===ki.KEY_UP){return true}e=e._next}return false};ji.hasMouseDown.get=function(){if(this._mouse.left===ki.KEY_DOWN||this._mouse.middle===ki.KEY_DOWN||this._mouse.right===ki.KEY_DOWN){return true}return false};ji.hasMouseUp.get=function(){if(this._mouse.left===ki.KEY_UP||this._mouse.middle===ki.KEY_UP||this._mouse.right===ki.KEY_UP){return true}return false};Hi.prototype.getTouchInfo=function e(t){if(t>=this.touchCount){return null}else{return this._touches.data[t]}};Hi.prototype.reset=function e(){var t=this;if(this._enabled===false){return}this._mouse.prevX=this._mouse.x;this._mouse.prevY=this._mouse.y;this._mouse.dx=0;this._mouse.dy=0;this._mouse.scrollX=0;this._mouse.scrollY=0;if(this._mouse.left===ki.KEY_DOWN){this._mouse.left=ki.KEY_PRESSING}else if(this._mouse.left===ki.KEY_UP){this._mouse.left=ki.KEY_NONE}if(this._mouse.middle===ki.KEY_DOWN){this._mouse.middle=ki.KEY_PRESSING}else if(this._mouse.middle===ki.KEY_UP){this._mouse.middle=ki.KEY_NONE}if(this._mouse.right===ki.KEY_DOWN){this._mouse.right=ki.KEY_PRESSING}else if(this._mouse.right===ki.KEY_UP){this._mouse.right=ki.KEY_NONE}var n=this._keys.head;var r=n;while(r){n=r;r=n._next;if(n._state===ki.KEY_DOWN){n._state=ki.KEY_PRESSING}else if(n._state===ki.KEY_UP){t._keys.remove(n)}}for(var i=0;i<this._touches.length;i++){t._touches.data[i].prevX=t._touches.data[i].x;t._touches.data[i].prevY=t._touches.data[i].y;t._touches.data[i].dx=0;t._touches.data[i].dy=0;if(t._touches.data[i]._phase===ki.TOUCH_START){t._touches.data[i]._phase=ki.TOUCH_PRESSING}if(t._touches.data[i]._phase===ki.TOUCH_END||t._touches.data[i]._phase===ki.TOUCH_CANCEL){t._touches.remove(i)}}this._uninstallGlobalEvents()};Hi.prototype.grabMouse=function e(t){this._mouseGrabbed=t;if(this._enabled===false){return}if(t){this._installGlobalEvents()}else{this._uninstallGlobalEvents()}};Hi.prototype.mousedown=function e(t){var n=this._mouse[t];if(n!==undefined){return n===ki.KEY_DOWN}return false};Hi.prototype.mousepress=function e(t){var n=this._mouse[t];if(n!==undefined){return n===ki.KEY_DOWN||n===ki.KEY_PRESSING}return false};Hi.prototype.mouseup=function e(t){var n=this._mouse[t];if(n!==undefined){return n===ki.KEY_UP}return false};Hi.prototype.keydown=function e(t){var n=this._keys.head;while(n){if(n.key===t&&n._state===ki.KEY_DOWN){return true}n=n._next}return false};Hi.prototype.keyup=function e(t){var n=this._keys.head;while(n){if(n.key===t&&n._state===ki.KEY_UP){return true}n=n._next}return false};Hi.prototype.keypress=function e(t){var n=this._keys.head;while(n){if(n.key===t&&(n._state===ki.KEY_DOWN||n._state===ki.KEY_PRESSING)){return true}n=n._next}return false};Object.defineProperties(Hi.prototype,ji);Object.assign(Hi,ki);var qi=function e(t,n){if(n===void 0)n={};this.name=t;this.detail=n.detail;this.bubbles=!!n.bubbles;this.target=null;this._stopped=false};qi.prototype.stop=function e(){this._stopped=true};var Xi=Object.prototype.hasOwnProperty;function Yi(){var e=Object.create(null);e.__tmp__=undefined;delete e.__tmp__;return e}function Ki(e,t,n){this.fn=e;this.context=t;this.once=n||false}function Zi(e,t,n,r,i){var a=new Ki(n,r||e,i);if(!e._events[t]){e._events[t]=a;e._eventsCount++}else if(!e._events[t].fn){e._events[t].push(a)}else{e._events[t]=[e._events[t],a]}return e}function Qi(e,t){if(--e._eventsCount===0){e._events=Yi()}else{delete e._events[t]}}function Ji(e){var t=e.target;while(t){t.emit(e.name,e);if(!e.bubbles||e._stopped){break}t=t.parent}}var $i=function e(){this._events=Yi();this._eventsCount=0};$i.mixin=function e(t){Object.getOwnPropertyNames($i.prototype).forEach(function(e){if(t.prototype.hasOwnProperty(e)===false){Object.defineProperty(t.prototype,e,Object.getOwnPropertyDescriptor($i.prototype,e))}});t.prototype.__initEventEmitter=function(){this._events=Yi();this._eventsCount=0}};$i.prototype.eventNames=function e(){var t=this;var n=[],r,i;if(this._eventsCount===0){return n}for(i in r=t._events){if(Xi.call(r,i)){n.push(i)}}if(Object.getOwnPropertySymbols){return n.concat(Object.getOwnPropertySymbols(r))}return n};$i.prototype.listeners=function e(t,n){var r=this._events[t];if(n){return!!r}if(!r){return[]}if(r.fn){return[r.fn]}var i=r.length;var a=new Array(i);for(var o=0;o<i;++o){a[o]=r[o].fn}return a};$i.prototype.emit=function e(t,n,r,i,a,o){var s=arguments;var l=this;if(!this._events[t]){return false}var u=this._events[t],h=arguments.length,c,f;if(u.fn){if(u.once){this.off(t,u.fn,undefined,true)}switch(h){case 1:return u.fn.call(u.context),true;case 2:return u.fn.call(u.context,n),true;case 3:return u.fn.call(u.context,n,r),true;case 4:return u.fn.call(u.context,n,r,i),true;case 5:return u.fn.call(u.context,n,r,i,a),true;case 6:return u.fn.call(u.context,n,r,i,a,o),true}for(f=1,c=new Array(h-1);f<h;f++){c[f-1]=s[f]}u.fn.apply(u.context,c)}else{var p=u.length,d;for(f=0;f<p;f++){if(u[f].once){l.off(t,u[f].fn,undefined,true)}switch(h){case 1:u[f].fn.call(u[f].context);break;case 2:u[f].fn.call(u[f].context,n);break;case 3:u[f].fn.call(u[f].context,n,r);break;case 4:u[f].fn.call(u[f].context,n,r,i);break;default:if(!c){for(d=1,c=new Array(h-1);d<h;d++){c[d-1]=s[d]}}u[f].fn.apply(u[f].context,c)}}}return true};$i.prototype.on=function e(t,n,r){return Zi(this,t,n,r,false)};$i.prototype.once=function e(t,n,r){return Zi(this,t,n,r,true)};$i.prototype.off=function e(t,n,r,i){if(!this._events[t]){return this}if(!n){Qi(this,t);return this}var a=this._events[t];if(a.fn){if(a.fn===n&&(!i||a.once)&&(!r||a.context===r)){Qi(this,t)}}else{var o=[];for(var s=0,l=a.length;s<l;s++){if(a[s].fn!==n||i&&!a[s].once||r&&a[s].context!==r){o.push(a[s])}}if(o.length){this._events[t]=o.length===1?o[0]:o}else{Qi(this,t)}}return this};$i.prototype.removeAllListeners=function e(t){if(t){if(this._events[t]){Qi(this,t)}}else{this._events=Yi();this._eventsCount=0}return this};$i.prototype.dispatch=function e(t,n){var r=t;if(typeof t==="string"){r=new qi(t,n)}r.target=this;Ji(r)};var ea=function(n){function e(e,t){n.call(this,e,t);this.component=null}if(n)e.__proto__=n;e.prototype=Object.create(n&&n.prototype);e.prototype.constructor=e;return e}(qi);var ta=function e(){this._enabled=true;this._destroyed=false;this._inited=false;this._app=null;this._system=null;this._entity=null};var na={enabled:{configurable:true},destroyed:{configurable:true},system:{configurable:true},entity:{configurable:true}};na.enabled.get=function(){return this._entity.activeInHierarchy&&this._enabled};na.enabled.set=function(e){if(this._enabled!==e){this._enabled=e;if(this._entity.activeInHierarchy){if(this._enabled){this.onEnable&&this.onEnable()}else{this.onDisable&&this.onDisable()}}}};ta.prototype._onEntityActiveChanged=function e(t){if(!this._inited){this._inited=true;if(this.onInit){this.onInit()}}if(this._enabled){if(t){this.onEnable&&this.onEnable()}else{this.onDisable&&this.onDisable()}}};ta.prototype._onComponentNeedDestroy=function e(){if(this._inited){this.onDestroy&&this.onDestroy();this._inited=false}};na.destroyed.get=function(){return this._entity.destroyed||this._destroyed};na.system.get=function(){return this._system};na.entity.get=function(){return this._entity};ta.prototype.dispatch=function e(t,n){var r=t;if(typeof t==="string"){r=new ea(t,n)}r.target=this._entity;r.component=this;this._entity.dispatch(r)};ta.prototype.destroy=function e(){if(this._destroyed){return}this._destroyed=true;var t=this._entity;if(this.enabled){this.onDisable&&this.onDisable()}this._app._destroyComp(this)};Object.defineProperties(ta.prototype,na);var ra=function e(t){this.__initNode();this.__initEventEmitter();this.name=t||"";this._active=false;this._ancestorActive=false;this._destroyed=false;this._comps=[];this._app=null;this._poolID=-1};var ia={active:{configurable:true},activeInHierarchy:{configurable:true},destroyed:{configurable:true}};ia.active.get=function(){return this._active};ia.active.set=function(e){e=!!e;if(this._active!==e){if(e){this.activate()}else{this.deactivate()}}};ia.activeInHierarchy.get=function(){return this._active&&this._ancestorActive};ia.destroyed.get=function(){return this._destroyed};ra.prototype.activate=function e(){if(this._active===true){return}this._active=true;if(this._ancestorActive){this._notifyComponents(true);this._notifyChildren(true)}};ra.prototype.deactivate=function e(){if(this._active===false){return}this._active=false;if(this._ancestorActive){this._notifyComponents(false);this._notifyChildren(false)}};ra.prototype._notifyComponents=function e(t){var n=this;this.emit(t?"active":"inactive");for(var r=0;r<this._comps.length;++r){var i=n._comps[r];i._onEntityActiveChanged(t)}};ra.prototype._notifyChildren=function e(t){var n=this;for(var r=0;r<this._children.length;++r){var i=n._children[r];i._ancestorActive=t;if(i.active){i._notifyComponents(t);i._notifyChildren(t)}}};ra.prototype.destroy=function e(){var t=this;if(this._destroyed){return}this._destroyed=true;for(var n=0;n<this._children.length;++n){var r=t._children[n];r.destroy()}for(var i=0;i<this._comps.length;++i){var a=t._comps[i];a.destroy()}if(this.activeInHierarchy){this.emit("inactive")}this._app._destroyEntity(this)};ra.prototype._onParentChanged=function e(t,n){var r=!!(t&&t.activeInHierarchy);this._ancestorActive=!!(n&&n.activeInHierarchy);if(this._active&&this._ancestorActive!==r){this._notifyComponents(this._ancestorActive);this._notifyChildren(this._ancestorActive)}this.emit("parent-changed",t,n)};ra.prototype.clone=function e(){return this._app.cloneEntity(this)};ra.prototype.deepClone=function e(){return this._app.deepCloneEntity(this)};ra.prototype.getComp=function e(t){var n=this;var r=this._app.getClass(t);for(var i=0;i<this._comps.length;++i){var a=n._comps[i];if(a instanceof r){return a}}return null};ra.prototype.getComps=function e(t){var n=this;var r=this._app.getClass(t);var i=[];for(var a=0;a<this._comps.length;++a){var o=n._comps[a];if(o instanceof r){i.push(o)}}return i};ra.prototype.getCompsInChildren=function e(t){var r=this._app.getClass(t);var i=[];kr.walk(this,function(e){for(var t=0;t<e._comps.length;++t){var n=e._comps[t];if(n instanceof r){i.push(n)}}});return i};ra.prototype.addComp=function e(t,n){var r=this._app.getClass(t);if(!r.multiple){if(this.getComp(t)){return null}}var i=this._app._createComp(r,this,n);this._comps.push(i);if(this.activeInHierarchy){i._onEntityActiveChanged(true)}return i};ra.prototype._removeComp=function e(t){var n=this;for(var r=0;r<this._comps.length;++r){var i=n._comps[r];if(i===t){n._comps.splice(r,1);return true}}return false};Object.defineProperties(ra.prototype,ia);Cr.mixin(ra);$i.mixin(ra);var aa=function(t){function e(e){t.call(this,e)}if(t)e.__proto__=t;e.prototype=Object.create(t&&t.prototype);e.prototype.constructor=e;e.prototype.addComp=function e(){console.warn("Can not add component in level")};e.prototype.setParent=function e(){console.error("Can not set parent to level")};e.prototype.activate=function e(){if(this._active===true&&this._ancestorActive===true){return}this._ancestorActive=true;t.prototype.activate.call(this)};e.prototype.deactivate=function e(){if(this._active===false&&this._ancestorActive===false){return}this._ancestorActive=false;t.prototype.deactivate.call(this)};return e}(ra);var oa=function e(){this._enabled=true;this._id="";this._app=null;this._priority=0;this._componentCls=null};oa.prototype.init=function e(){};oa.prototype.add=function e(){};oa.prototype.remove=function e(){};oa.prototype.tick=function e(){};oa.prototype.postTick=function e(){};function sa(o){return function(e,t,n,r){var i=e.getClass(o);if(i===undefined){console.warn("Can not find class "+o+".");return null}t=t||{};if(t instanceof i){return t}if(t.constructor&&t.constructor.__classname__){console.warn("Invalid class instance, it is not instanceof "+o+".");return null}var a=new i;pa(e,a,t,r);return a}}function la(o){if(o){return function(e,t,n,r){if(t===null){return[]}var i=new Array(t.length);for(var a=0;a<t.length;++a){i[a]=o(e,t[a],n,r)}return i}}return function(e,t){return t}}function ua(e,t){if(t.parse){return t.parse}var n=null;var r=e.getType(t.type);if(r){n=r.parse||null}else{n=sa(t.type)}if(t.array){return la(n)}return n}function ha(t,n,r,i){if(i){if(r.set){return function(e){r.set.call(this,i(t,e,r))}}return function(e){this[n]=i(t,e,r)}}if(r.set){return r.set}return function(e){this[n]=e}}function ca(e,t,n){if(n.get){return n.get}return function(){return this[t]}}function fa(e,t){var n={};for(var r in t){var i=t[r];if(i.type===undefined&&i.default===undefined){console.warn("Invalid property "+r+": you must provide 'default' or 'type'.");continue}if(i.array===undefined){i.array=false}if(i.array&&i.type===undefined){console.warn("Invalid property "+r+": array value must have a 'type'.");continue}var a=i.type;if(a===undefined){i.type=typeof i.default}if(i.default===undefined){var o=e.getType(i.type);if(o){i.default=o.default}else{i.default=null}}var s=ua(e,i);var l="_"+r;var u=ca(e,l,i);var h=ha(e,l,i,s);n[r]={configurable:true,enumerable:true,get:u,set:h}}return n}function pa(e,t,n,r){var i=t.constructor;while(i.__classname__!==undefined){if(i.hasOwnProperty("schema")===false){i=Object.getPrototypeOf(i);continue}for(var a in i.schema){var o="_"+a;if(t[o]!==undefined){continue}var s=i.schema[a];var l=ua(e,s);var u=n&&n[a];if(u===undefined){u=s.default}if(l){var h=l(e,u,s,r);t[o]=h}else{t[o]=u}}i=Object.getPrototypeOf(i)}}var da={createPrototypeAccessors:fa,parse:pa};var va=function e(t){var n=this;if(t===void 0)t={};var r=t.poolSize||100;this._types={};this._classes={};this._systems=[];this._activeLevel=new aa;this._activeLevel._app=this;this._activeLevel.activate();this._entities=new lr(r);this._deadComponents=new lr(r);this._deadEntities=new lr(r);if(t.systems){for(var i=0;i<t.systems.length;++i){var a=t.systems[i];n.registerSystem(a.id,a.system,a.component,a.priority)}}this._sortSystems()};var ma={activeLevel:{configurable:true}};ma.activeLevel.get=function(){return this._activeLevel};va.prototype.registerType=function e(t,n){this._types[t]=n};va.prototype.registerClass=function e(t,n){n.__classname__=t;var r=null;if(n.hasOwnProperty("schema")){r=n.schema}if(r){var i=da.createPrototypeAccessors(this,r);Object.defineProperties(n.prototype,i)}this._classes[t]=n};va.prototype.registerSystem=function e(t,n,r,i){if(i===void 0)i=0;var a=new n;a._id=t;a._app=this;a._priority=i;a._componentCls=this.getClass(r);if(!a._componentCls){console.warn("Failed to get class "+r+", please register it first.")}a.init();this._systems.push(a);return a};va.prototype.getType=function e(t){return this._types[t]};va.prototype.getClass=function e(t){return this._classes[t]};va.prototype.getClassName=function e(t){if(typeof t==="function"){return t.__classname__}return t.constructor.__classname__};va.prototype.createObject=function e(t,n){var r=this.getClass(t);var i=new r;da.parse(this,i,n||{});return i};va.prototype.createEntity=function e(t,n){if(n===void 0)n=null;var r=new ra(t);r._app=this;r._active=true;this._entities.push(r);var i=n||this._activeLevel;if(i){r.setParent(i)}return r};va.prototype.cloneEntity=function e(t){var a=this;return kr.clone(t,ra,function(e,t){e._app=a;e._active=t._active;for(var n=0;n<t._comps.length;++n){var r=t._comps[n];if(r._destroyed){continue}var i=a._createComp(r.constructor,e,r);i._enabled=r._enabled;if(i.onClone){i.onClone(r)}e._comps.push(i)}a._entities.push(e)})};va.prototype.deepCloneEntity=function e(t){var a=this;return kr.deepClone(t,ra,function(e,t){e._app=a;e._active=t._active;for(var n=0;n<t._comps.length;++n){var r=t._comps[n];if(r._destroyed){continue}var i=a._createComp(r.constructor,e,r);i._enabled=r._enabled;if(i.onClone){i.onClone(r)}e._comps.push(i)}a._entities.push(e)})};va.prototype.loadLevel=function e(t){if(this._activeLevel){kr.walk(this._activeLevel,function(e){e.destroy()})}this._activeLevel=t;this._activeLevel._app=this;this._activeLevel.activate()};va.prototype.tick=function e(){var t=this;for(var n=0;n<this._systems.length;++n){var r=t._systems[n];r.tick()}for(var i=0;i<this._systems.length;++i){var a=t._systems[i];a.postTick()}for(var o=0;o<this._deadComponents.length;++o){var s=t._deadComponents.data[o];s._onComponentNeedDestroy();s._entity._removeComp(s);for(var l=0;l<s.__events__.length;++l){var u=s.__events__[l];s._entity.off(u.name,u.fn)}s._app=null;s._system=null;s._entity=null}for(var h=0;h<this._deadEntities.length;++h){var c=t._deadEntities.data[h];c.emit("destroy");if(c._parent&&c._parent._destroyed===false){c.setParent(null)}var f=t._entities.data[t._entities.length-1];t._entities.fastRemove(c._poolID);f._poolID=c._poolID;c._poolID=-1;c._app=null;c._parent=null;c._children.length=0;c._comps.length=0}this._deadComponents.reset();this._deadEntities.reset()};va.prototype.system=function e(t){var n=this;for(var r=0;r<this._systems.length;++r){var i=n._systems[r];if(i._id===t){return i}}return null};va.prototype._getSystem=function e(t){var n=this;for(var r=0;r<this._systems.length;++r){var i=n._systems[r];if(t instanceof i._componentCls){return i}}return null};va.prototype._destroyEntity=function e(t){this._deadEntities.push(t)};va.prototype._finalizeComp=function e(t,n,r){var i=t._entity;var a=t.constructor;while(a.__classname__!==undefined){if(a.hasOwnProperty("events")){for(var o in a.events){var s=a.events[o];var l=t[s];if(l){l=l.bind(t);i.on(o,l);t.__events__.push({name:o,fn:l})}}}a=Object.getPrototypeOf(a)}da.parse(this,t,n,r)};va.prototype._createComp=function e(t,n,r){if(r===void 0)r={};var i=new t;i._app=this;i._system=this._getSystem(i);i._entity=n;i.__events__=[];this._finalizeComp(i,r,null);return i};va.prototype._destroyComp=function e(t){this._deadComponents.push(t)};va.prototype._sortSystems=function e(){this._systems.sort(function(e,t){return e._priority-t._priority})};Object.defineProperties(va.prototype,ma);var _a={ORIENTATION_PORTRAIT:1,ORIENTATION_LANDSCAPE:2,ORIENTATION_AUTO:3,BROWSER_TYPE_WECHAT:"wechat",BROWSER_TYPE_WECHAT_GAME:"wechatgame",BROWSER_TYPE_WECHAT_GAME_SUB:"wechatgamesub",BROWSER_TYPE_QQ_PLAY:"qqplay",BROWSER_TYPE_ANDROID:"androidbrowser",BROWSER_TYPE_IE:"ie",BROWSER_TYPE_QQ:"qqbrowser",BROWSER_TYPE_MOBILE_QQ:"mqqbrowser",BROWSER_TYPE_UC:"ucbrowser",BROWSER_TYPE_UCBS:"ucbs",BROWSER_TYPE_360:"360browser",BROWSER_TYPE_BAIDU_APP:"baiduboxapp",BROWSER_TYPE_BAIDU:"baidubrowser",BROWSER_TYPE_MAXTHON:"maxthon",BROWSER_TYPE_OPERA:"opera",BROWSER_TYPE_OUPENG:"oupeng",BROWSER_TYPE_MIUI:"miuibrowser",BROWSER_TYPE_FIREFOX:"firefox",BROWSER_TYPE_SAFARI:"safari",BROWSER_TYPE_CHROME:"chrome",BROWSER_TYPE_LIEBAO:"liebao",BROWSER_TYPE_QZONE:"qzone",BROWSER_TYPE_SOUGOU:"sogou",BROWSER_TYPE_UNKNOWN:"unknown",OS_UNKNOWN:"Unknown",OS_IOS:"iOS",OS_ANDROID:"Android",OS_WINDOWS:"Windows",OS_MARMALADE:"Marmalade",OS_LINUX:"Linux",OS_BADA:"Bada",OS_BLACKBERRY:"Blackberry",OS_OSX:"OS X",OS_WP8:"WP8",OS_WINRT:"WINRT"};var ga=function e(t){this._app=t};var ya=[];var xa=[];var ba=[];var wa=[];var Ea={registerLoader:function e(t,n){ya.push({id:t,def:n})},registerType:function e(t,n){ba.push({id:t,def:n})},registerClass:function e(t,n){xa.push({id:t,def:n})},registerSystem:function e(t,n,r,i){wa.push({id:t,system:n,component:r,priority:i})},_init:function e(t){for(var n=0;n<ya.length;++n){var r=ya[n];t._assetMng.registerLoader(r.id,r.def)}for(var i=0;i<ba.length;++i){var a=ba[i];t.registerType(a.id,a.def)}for(var o=0;o<xa.length;++o){var s=xa[o];t.registerClass(s.id,s.def)}for(var l=0;l<wa.length;++l){var u=wa[l];t.registerSystem(u.id,u.system,u.component,u.priority)}}};var Ta=["manifest","onDone","onProgress","onError"];var Sa=["type","src","stream","credentials","parser"];var Aa=["onData","onDone"];var Ma=-1;var Ra=0;var La=1;function Ca(e){throw new Error("resl: "+e)}function Oa(e,t,n){Object.keys(e).forEach(function(e){if(t.indexOf(e)<0){Ca('invalid parameter "'+e+'" in '+n)}})}function Ia(e,t){this.state=Ra;this.ready=false;this.progress=0;this.name=e;this.cancel=t}function Ua(n){if(typeof n!=="object"||!n){Ca("invalid or missing configuration")}Oa(n,Ta,"config");var o=n.manifest;if(typeof o!=="object"||!o){Ca("missing manifest")}function e(e){if(e in n){var t=n[e];if(typeof t!=="function"){Ca('invalid callback "'+e+'"')}return t}return null}var r=e("onDone");if(!r){Ca("missing onDone() callback")}var i=e("onProgress");var t=e("onError");var d={};var a=Ra;function s(t){var n=t.name;var e=t.stream;var r=t.type==="binary";var i=t.parser;var a=new XMLHttpRequest;var o=null;var s=new Ia(n,u);if(e){a.onreadystatechange=l}else{a.onreadystatechange=function(){if(a.readyState===4){l()}}}if(r){a.responseType="arraybuffer"}function l(){if(a.readyState<2||s.state===La||s.state===Ma){return}if(a.status!==200){return v('error loading resource "'+t.name+'"')}if(a.readyState>2&&s.state===Ra){var e;if(t.type==="binary"){e=a.response}else{e=a.responseText}if(i.data){try{o=i.data(e)}catch(e){return v(e)}}else{o=e}}if(a.readyState>3&&s.state===Ra){if(i.done){try{o=i.done()}catch(e){return v(e)}}s.state=La}d[n]=o;s.progress=.75*s.progress+.25;s.ready=t.stream&&!!o||s.state===La;m()}function u(){if(s.state===La||s.state===Ma){return}a.onreadystatechange=null;a.abort();s.state=Ma}if(t.credentials){a.withCredentials=true}a.open("GET",t.src,true);a.send();return s}function l(e,t){var n=e.name;var r=e.parser;var i=new Ia(n,p);var a=t;function o(){if(i.state===Ra){if(r.data){try{a=r.data(t)}catch(e){return v(e)}}else{a=t}}}function s(e){o();d[n]=a;if(e.lengthComputable){i.progress=Math.max(i.progress,e.loaded/e.total)}else{i.progress=.75*i.progress+.25}m(n)}function l(){o();if(i.state===Ra){if(r.done){try{a=r.done()}catch(e){return v(e)}}i.state=La}i.progress=1;i.ready=true;d[n]=a;f();m("finish "+n)}function u(){v('error loading asset "'+n+'"')}if(e.stream){t.addEventListener("progress",s)}if(e.type==="image"){t.addEventListener("load",l)}else{var h=false;var c=false;t.addEventListener("loadedmetadata",function(){c=true;if(h){l()}});t.addEventListener("canplay",function(){h=true;if(c){l()}})}t.addEventListener("error",u);function f(){if(e.stream){t.removeEventListener("progress",s)}if(e.type==="image"){t.addEventListener("load",l)}else{t.addEventListener("canplay",l)}t.removeEventListener("error",u)}function p(){if(i.state===La||i.state===Ma){return}i.state=Ma;f();t.src=""}if(e.credentials){t.crossOrigin="use-credentials"}else{t.crossOrigin="anonymous"}t.src=e.src;return i}var u={text:s,binary:function(e){return s(e)},image:function(e){return l(e,document.createElement("img"))},video:function(e){return l(e,document.createElement("video"))},audio:function(e){return l(e,document.createElement("audio"))}};var h=Object.keys(o).map(function(i){var a=o[i];if(typeof a==="string"){a={src:a}}else if(typeof a!=="object"||!a){Ca('invalid asset definition "'+i+'"')}Oa(a,Sa,'asset "'+i+'"');function e(e,t,n){var r=n;if(e in a){r=a[e]}if(t.indexOf(r)<0){Ca("invalid "+e+' "'+r+'" for asset "'+i+'", possible values: '+t)}return r}function t(e,t,n){var r=n;if(e in a){r=a[e]}else if(t){Ca("missing "+e+' for asset "'+i+'"')}if(typeof r!=="string"){Ca("invalid "+e+' for asset "'+i+'", must be a string')}return r}function n(e,t){if(e in a.parser){var n=a.parser[e];if(typeof n!=="function"){Ca("invalid parser callback "+e+' for asset "'+e+'"')}return n}else{return t}}var r={};if("parser"in a){if(typeof a.parser==="function"){r={data:a.parser}}else if(typeof a.parser==="object"&&a.parser){Oa(a.parser,Aa,'parser for asset "'+i+'"');if(!("onData"in a.parser)){Ca('missing onData callback for parser in asset "'+i+'"')}r={data:n("onData"),done:n("onDone")}}else{Ca('invalid parser for asset "'+i+'"')}}return{name:i,type:e("type",Object.keys(u),"text"),stream:!!a.stream,credentials:!!a.credentials,src:t("src",true,""),parser:r}}).map(function(e){return u[e.type](e)});function v(e){if(a===Ma||a===La){return}a=Ma;h.forEach(function(e){e.cancel()});if(t){if(typeof e==="string"){t(new Error("resl: "+e))}else{t(e)}}else{console.error("resl error:",e)}}function m(e){if(a===Ma||a===La){return}var t=0;var n=0;h.forEach(function(e){if(e.ready){n+=1}t+=e.progress});if(n===h.length){a=La;r(d)}else{if(i){i(t/h.length,e)}}}if(h.length===0){setTimeout(function(){m("done")},1)}}var Pa=-1;var Ba=function e(){++Pa;this._uuid="internal-"+Pa;this._name="";this._loaded=false};var Da={uuid:{configurable:true},name:{configurable:true}};Da.uuid.get=function(){return this._uuid};Da.name.get=function(){return this._name};Ba.prototype.subAsset=function e(){return null};Ba.prototype.unload=function e(){this._loaded=false};Ba.prototype.reload=function e(){};Ba.prototype.clone=function e(){};Object.defineProperties(Ba.prototype,Da);var Fa=function(i){function e(){i.call(this);this._subMeshes=null;this._skinning=null;this._minPos=null;this._maxPos=null}if(i)e.__proto__=i;e.prototype=Object.create(i&&i.prototype);e.prototype.constructor=e;var t={skinning:{configurable:true},subMeshCount:{configurable:true}};e.prototype.unload=function e(){var t=this;if(!this._loaded){return}this._subMeshes[0]._vertexBuffer.destroy();for(var n=0;n<this._subMeshes.length;++n){var r=t._subMeshes[n];r._indexBuffer.destroy()}this._subMeshes=null;i.prototype.unload.call(this)};t.skinning.get=function(){return this._skinning};t.subMeshCount.get=function(){return this._subMeshes.length};e.prototype.getSubMesh=function e(t){return this._subMeshes[t]};Object.defineProperties(e.prototype,t);return e}(Ba);var za=function(t){function e(e){t.call(this);this._device=e;this._texture=null}if(t)e.__proto__=t;e.prototype=Object.create(t&&t.prototype);e.prototype.constructor=e;return e}(Ba);var Na={linear:Ae.FILTER_LINEAR,nearest:Ae.FILTER_NEAREST};var ka={repeat:Ae.WRAP_REPEAT,clamp:Ae.WRAP_CLAMP,mirror:Ae.WRAP_MIRROR};var Va={"rgb-dxt1":Ae.TEXTURE_FMT_RGB_DXT1,"rgba-dxt1":Ae.TEXTURE_FMT_RGBA_DXT1,"rgba-dxt3":Ae.TEXTURE_FMT_RGBA_DXT3,"rgba-dxt5":Ae.TEXTURE_FMT_RGBA_DXT5,"rgb-etc1":Ae.TEXTURE_FMT_RGB_ETC1,"rgb-pvrtc-2bppv1":Ae.TEXTURE_FMT_RGB_PVRTC_2BPPV1,"rgba-pvrtc-2bppv1":Ae.TEXTURE_FMT_RGBA_PVRTC_2BPPV1,"rgb-pvrtc-4bppv1":Ae.TEXTURE_FMT_RGB_PVRTC_4BPPV1,"rgba-pvrtc-4bppv1":Ae.TEXTURE_FMT_RGBA_PVRTC_4BPPV1,a8:Ae.TEXTURE_FMT_A8,l8:Ae.TEXTURE_FMT_L8,"l8-a8":Ae.TEXTURE_FMT_L8_A8,"r5-g6-b5":Ae.TEXTURE_FMT_R5_G6_B5,"r5-g5-b5-a1":Ae.TEXTURE_FMT_R5_G5_B5_A1,"r4-g4-b4-a4":Ae.TEXTURE_FMT_R4_G4_B4_A4,rgb8:Ae.TEXTURE_FMT_RGB8,rgba8:Ae.TEXTURE_FMT_RGBA8,rgb16f:Ae.TEXTURE_FMT_RGB16F,rgba16f:Ae.TEXTURE_FMT_RGBA16F,rgb32f:Ae.TEXTURE_FMT_RGB32F,rgba32f:Ae.TEXTURE_FMT_RGBA32F,r32f:Ae.TEXTURE_FMT_R32F,"111110f":Ae.TEXTURE_FMT_111110F,srgb:Ae.TEXTURE_FMT_SRGB,srgba:Ae.TEXTURE_FMT_SRGBA,d16:Ae.TEXTURE_FMT_D16,d32:Ae.TEXTURE_FMT_D32,d24s8:Ae.TEXTURE_FMT_D24S8};var Wa={images:[],mipmap:true,width:2,height:2,format:Ae.TEXTURE_FMT_RGBA8,anisotropy:1,wrapS:Ae.WRAP_REPEAT,wrapT:Ae.WRAP_REPEAT,minFilter:Ae.FILTER_LINEAR,magFilter:Ae.FILTER_LINEAR,mipFilter:Ae.FILTER_LINEAR,premultiplyAlpha:false};function Ga(e,t){if(t._writable){e.images=[t._data]}else{e.images=t._images}e.mipmap=t._mipmap;e.width=t._width;e.height=t._height;e.format=Va[t._format];e.anisotropy=t._anisotropy;e.wrapS=ka[t._wrapS];e.wrapT=ka[t._wrapT];e.minFilter=Na[t._minFilter];e.magFilter=Na[t._magFilter];e.mipFilter=Na[t._mipFilter];e.premultiplyAlpha=t._premultiplyAlpha}function Ha(e){if(e._format==="a8"){return new Uint8Array(e._width*e._height)}else if(e._format==="rgb8"){return new Uint8Array(e._width*e._height*3)}else if(e._format==="rgba8"){return new Uint8Array(e._width*e._height*4)}else if(e._format==="rgba32f"){return new Float32Array(e._width*e._height*4)}return null}var ja=function(i){function e(e,t,n,r){if(t===void 0)t=2;if(n===void 0)n=2;if(r===void 0)r="rgba8";i.call(this,e);this._writable=false;this._data=null;this._images=[];this._mipmap=true;this._width=t;this._height=n;this._format=r;this._anisotropy=1;this._wrapS="repeat";this._wrapT="repeat";this._minFilter="linear";this._magFilter="linear";this._mipFilter="linear";this._premultiplyAlpha=false}if(i)e.__proto__=i;e.prototype=Object.create(i&&i.prototype);e.prototype.constructor=e;var t={width:{configurable:true},height:{configurable:true},format:{configurable:true},data:{configurable:true},writable:{configurable:true},mipmap:{configurable:true},anisotropy:{configurable:true},wrapS:{configurable:true},wrapT:{configurable:true},minFilter:{configurable:true},magFilter:{configurable:true},mipFilter:{configurable:true},premultiplyAlpha:{configurable:true}};e.prototype.unload=function e(){if(!this._loaded){return}this._texture.destroy();i.prototype.unload.call(this)};e.prototype.setImage=function e(t,n){if(n instanceof HTMLCanvasElement||n instanceof HTMLImageElement||n instanceof HTMLVideoElement){this._images[t]=n;if(t===0){this.resize(n.width,n.height)}}};e.prototype.setImages=function e(t){this._images=t;this.resize(t[0].width,t[0].height)};e.prototype.resize=function e(t,n){this._width=t;this._height=n;if(this._writable){this._data=Ha(this)}};t.width.get=function(){return this._width};t.height.get=function(){return this._height};t.format.get=function(){return this._format};t.data.get=function(){return this._data};t.writable.set=function(e){this._writable=e;if(this._writable){this._data=Ha(this)}else{this._data=null}};t.writable.get=function(){return this._writable};t.mipmap.set=function(e){this._mipmap=e};t.mipmap.get=function(){return this._mipmap};t.anisotropy.set=function(e){this._anisotropy=e};t.anisotropy.get=function(){return this._anisotropy};t.wrapS.set=function(e){this._wrapS=e};t.wrapS.get=function(){return this._wrapS};t.wrapT.set=function(e){this._wrapT=e};t.wrapT.get=function(){return this._wrapT};t.minFilter.set=function(e){this._minFilter=e};t.minFilter.get=function(){return this._minFilter};t.magFilter.set=function(e){this._magFilter=e};t.magFilter.get=function(){return this._magFilter};t.mipFilter.set=function(e){this._mipFilter=e};t.mipFilter.get=function(){return this._mipFilter};t.premultiplyAlpha.set=function(e){this._premultiplyAlpha=e};t.premultiplyAlpha.get=function(){return this._premultiplyAlpha};e.prototype.commit=function e(){Ga(Wa,this);if(!this._texture){this._texture=new Ae.Texture2D(this._device,Wa)}else{this._texture.update(Wa)}this._images=[]};Object.defineProperties(e.prototype,t);return e}(za);function qa(e,t){var n=e.length;if(n===0){t(null)}var r=0;for(var i=0;i<e.length;++i){var a=e[i];a(function(e){if(e){t(e)}else if(++r===n){t(null)}})}}var Xa={parallel:qa};function Ya(e,t){for(var n=0;n<t.length;n++){var r=t[n];var i=e.entities[r.entity];var a=r.property.split(".");if(a.length===1){i[r.property]=r.value;continue}var o=null;for(var s=0;s<i.components.length;s++){var l=a[0];var u=i.components[s];if(u.type===l){o=u;break}}if(o===null){console.warn("Failed to apply modification for entity "+i.name+": component "+a[0]+" not found.");continue}var h=a[1];var c=h.match(/(.*)\[(\d+)\]/);if(c){var f=c[1];var p=parseInt(c[2]);o.properties[f][p]=r.value}else{if(a[1]==="enabled"){o[a[1]]=r.value}else{o.properties[a[1]]=r.value}}}return e}function Ka(e,t,n){var r=e.getClass(n.type);if(!r){var i=new ta;i._app=e;i._system=null;i._entity=t;i.__events__=[];if(n.enabled!==undefined){i._enabled=n.enabled}console.error("component type "+n.type+" not found.");return i}var a=new r;a._app=e;a._system=e._getSystem(a);a._entity=t;a.__events__=[];if(n.enabled!==undefined){a._enabled=n.enabled}return a}function Za(e,t,n){var r=e.createEntity(t.name,n);if(t.enabled!==undefined){r._active=t.enabled}if(!t.components){return r}r._comps=new Array(t.components.length);for(var i=0;i<t.components.length;++i){var a=t.components[i];r._comps[i]=Ka(e,r,a)}return r}function Qa(e,t,n,r){if(n){t=JSON.parse(JSON.stringify(t));t=Ya(t,n)}var i=t.entities;var a=new Array(t.entities.length);for(var o=0;o<i.length;++o){var s=i[o];if(s.prefab){console.warn("nested prefab have not implemented.")}else{a[o]=Za(e,s,r)}}$a(e,a,i);return a[0]}function Ja(t,e,n){var i={};var a=e.preloads;var o=[];var r=function(e){var r=a[e];o.push(function(n){t.assets.load(r,function(e,t){if(e){console.error(e);n();return}i[r]=t;n()})})};for(var s=0;s<a.length;++s)r(s);Xa.parallel(o,function(e){n(e,i)})}function $a(e,t,n){for(var r=0;r<n.length;++r){var i=t[r];var a=n[r];if(!i){continue}if(a.translation){Lt.set(i.lpos,a.translation[0],a.translation[1],a.translation[2])}else{Lt.set(i.lpos,0,0,0)}if(a.rotation){It.set(i.lrot,a.rotation[0],a.rotation[1],a.rotation[2],a.rotation[3])}else{It.set(i.lrot,0,0,0,1)}if(a.scale){Lt.set(i.lscale,a.scale[0],a.scale[1],a.scale[2])}else{Lt.set(i.lscale,1,1,1)}if(a.children){for(var o=0;o<a.children.length;++o){var s=a.children[o];i.append(t[s])}}if(a.components){for(var l=0;l<a.components.length;++l){var u=i._comps[l];var h=a.components[l];e._finalizeComp(u,h.properties,t)}}}}var eo={createComponent:Ka,createEntity:Za,createPrefab:Qa,preloadAssets:Ja,finalize:$a};function to(l,u,h){eo.preloadAssets(l,u,function(){var e=u.entities;var t=new Array(u.entities.length);var n=new aa;for(var r=0;r<e.length;++r){var i=e[r];if(i.prefab){var a=l.assets.get(i.prefab);if(!a){console.error("Failed to load prefab "+i.prefab);continue}t[r]=a.instantiate(i.modifications,n)}else{t[r]=eo.createEntity(l,i,n)}console.log(i.name+" loaded")}eo.finalize(l,t,u.entities);for(var o=0;o<u.children.length;++o){var s=u.children[o];n.append(t[s])}if(h){h(null,n)}})}function no(e,t){var n=t.jointIndices.length;var r;if(n>1024){throw"To many joints(more than 1024)."}else if(n>256){r=64}else if(n>64){r=32}else if(n>16){r=16}else if(n>4){r=8}else{r=4}var i=new ja(e.device,r,r,"rgba32f");i.minFilter="nearest";i.magFilter="nearest";i.wrapS="clamp";i.wrapT="clamp";i.mipmap=false;i.writable=true;i.commit();return i}function ro(e,t){var n=Ni.createIA(e.device,t);var r=new Fa;r._subMeshes=[n];r._minPos=t.minPos;r._maxPos=t.maxPos;return r}var io={createJointsTexture:no,createMesh:ro,parseLevel:to,walk:kr.walk,flat:kr.flat,find:kr.find,Layers:Tr};function ao(){var e=Object.create(null);e.__tmp__=undefined;delete e.__tmp__;return e}function oo(n,r){return function(e,t){if(e){if(r){r(e)}return}if(r){if(n){t=t.subAsset(n);if(!t){r(new Error("subasset "+n+" not found."));return}}r(null,t)}}}var so=function(e){function t(){e.call(this)}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.run=function e(n,r,t){var i=this;n.loadUrls(t.type,t.urls,function(e,t){delete n._loadings[r];if(e){i.emit("loaded",e);return}t._uuid=r;t._loaded=true;n.add(r,t);i.emit("loaded",null,t)})};return t}($i);var lo=function e(t){this._app=t;this._loaders=ao();this._assetInfos=ao();this._assets=ao();this._loadings=ao();this._levelInfos=ao()};lo.prototype.registerLoader=function e(t,n){this._loaders[t]=n};lo.prototype.registerAsset=function e(t,n){if(this._assetInfos[t]){console.warn("asset "+t+" already registerred.");return}this._assetInfos[t]=n};lo.prototype.registerLevel=function e(t,n){if(this._levelInfos[t]){console.warn("level "+t+" is already registerred.");return}this._levelInfos[t]=n};lo.prototype.loadLevel=function e(t,n){if(!this._levelInfos[t]){console.error("Cannot load scene "+t);n&&n(new Error("loadFail"),null)}else{var r=this._app;Ua({manifest:{sceneJson:{type:"text",parser:JSON.parse,src:this._levelInfos[t]}},onDone:function e(t){io.parseLevel(r,t.sceneJson,function(e,t){n&&n(e,t)})},onError:function e(t){n&&n(t,null)}})}};lo.prototype.add=function e(t,n){if(this._assets[t]){console.warn("Failed to add asset "+t+", already exists.");return}this._assets[t]=n};lo.prototype.get=function e(t){var n=t.indexOf("@");if(n===-1){return this._assets[t]}var r=t.substring(0,n);t=t.substring(n+1);var i=this._assets[t];if(i&&r){return i.subAsset(r)}return null};lo.prototype.load=function e(t,n){var r=t.indexOf("@");var i;if(r!==-1){i=t.substring(0,r);t=t.substring(r+1)}var a=this._assets[t];if(a){if(n){if(i){a=a.subAsset(i);if(!a){n(new Error("subasset "+i+" not found."));return}}n(null,a)}return}var o=this._loadings[t];var s=oo(i,n);if(o){o.once("loaded",s);return}var l=this._assetInfos[t];if(!l){if(n){n(new Error("asset info "+t+" not found, please add it first."))}return}o=new so(this);this._loadings[t]=o;o.once("loaded",oo(i,n));o.run(this,t,l)};lo.prototype.loadUrls=function e(t,n,r){var i=this._loaders[t];if(!i){if(r){r(new Error("can not find loader for asset type "+t+", please register it first."))}return}i(this._app,n,r)};var uo=10;var ho=10;var co=Lt.new(0,0,-1);var fo=Lt.new(1,0,0);var po=Lt.new(0,1,0);var vo=Ot.create();var mo=Lt.zero();var _o=Lt.zero();var go=Lt.new(0,1,0);var yo=Lt.zero();var xo=Lt.zero();var bo=function e(t){this._input=t;this._node=new Cr("debug-camera");Lt.set(this._node.lpos,10,10,10);this._node.lookAt(Lt.new(0,0,0));this._df=0;this._dr=0;this._panX=0;this._panY=0;this._panZ=0;this._rotX=0;this._rotY=0;this._curRot=It.create();this._destRot=It.create();this._curEye=Lt.zero();this._destEye=Lt.zero();this._node.getWorldRot(this._curRot);this._destRot=It.clone(this._curRot);this._node.getWorldPos(this._curEye);this._destEye=Lt.clone(this._curEye)};bo.prototype.reset=function e(){this._df=0;this._dr=0;this._du=0;this._panX=0;this._panY=0;this._panZ=0;this._rotX=0;this._rotY=0;this._node.getWorldRot(this._curRot);this._destRot=It.clone(this._curRot);this._node.getWorldPos(this._curEye);this._destEye=Lt.clone(this._curEye)};bo.prototype.tick=function e(t){var n=this._input;this._handleMouseAndKeyboard();if(n.hasTouch){this._handleTouches()}this._lerp(t)};bo.prototype._handleMouseAndKeyboard=function e(){var t=this._input;this._df=0;this._dr=0;this._du=0;this._panX=0;this._panY=0;this._panZ=0;this._rotX=0;this._rotY=0;if(t.mousepress("left")&&t.mousepress("right")){var n=t.mouseDeltaX;var r=t.mouseDeltaY;this._panX=n;this._panY=-r}else if(t.mousepress("left")){var i=t.mouseDeltaX;var a=t.mouseDeltaY;this._rotY=-i*.002;this._panZ=-a}else if(t.mousepress("right")){var o=t.mouseDeltaX;var s=t.mouseDeltaY;this._rotY=-o*.002;this._rotX=-s*.002}if(t.keypress("w")){this._df+=1}if(t.keypress("s")){this._df-=1}if(t.keypress("a")){this._dr-=1}if(t.keypress("d")){this._dr+=1}if(t.keypress("q")){this._du-=1}if(t.keypress("e")){this._du+=1}if(t.mouseScrollY){this._df-=t.mouseScrollY*.05}};bo.prototype._handleTouches=function e(){var t=this._input;this._df=0;this._dr=0;this._panX=0;this._panY=0;this._panZ=0;this._rotX=0;this._rotY=0;if(t.touchCount===1){var n=t.getTouchInfo(0);var r=n.dx;var i=n.dy;if(n.prevX===0&&n.prevY===0){r=0;i=0}this._rotY=-r*.002;this._rotX=i*.002}else if(t.touchCount===2){var a=t.getTouchInfo(0);var o=t.getTouchInfo(1);var s=Math.sqrt((a.x-o.x)*(a.x-o.x)+(a.y-o.y)*(a.y-o.y));var l=Math.sqrt((a.prevX-o.prevX)*(a.prevX-o.prevX)+(a.prevY-o.prevY)*(a.prevY-o.prevY));var u=Math.abs(s-l);if((a.dx!=0||a.dy!=0)&&(o.dx!=0||o.dy!=0)&&u<100){if(s>l){this._df+=u}else{this._df-=u}}if(o.phase===2||a.phase===2){t.touchCount=2}}else if(t.touchCount===3){var h=t.getTouchInfo(0);var c=h.dx;var f=h.dy;if(c<100&&f<100){this._rotY=-c*.002;this._panZ=-f}}};bo.prototype._lerp=function e(t){var n=this._panX;var r=this._panY;var i=this._panZ;var a=this._destEye;var o=this._destRot;It.rotateX(o,o,this._rotX);It.rotateAround(o,o,po,this._rotY);It.slerp(this._curRot,this._curRot,o,t*uo);Ot.fromQuat(vo,this._curRot);Lt.transformMat3(mo,co,vo);Lt.transformMat3(_o,fo,vo);if(this._df!==0){Lt.scaleAndAdd(a,a,mo,this._df*t*ho)}if(this._dr!==0){Lt.scaleAndAdd(a,a,_o,this._dr*t*ho)}if(this._du!==0){Lt.scaleAndAdd(a,a,go,this._du*t*ho)}if(i!==0){Lt.copy(yo,mo);yo.y=0;Lt.normalize(yo,yo);Lt.scaleAndAdd(a,a,yo,i*t*ho)}if(n!==0){Lt.copy(xo,_o);xo.y=0;Lt.normalize(xo,xo);Lt.scaleAndAdd(a,a,xo,n*t*ho)}if(r!==0){Lt.scaleAndAdd(a,a,po,r*t*ho)}Lt.lerp(this._curEye,this._curEye,a,t*uo);this._node.setWorldPos(this._curEye);this._node.setWorldRot(this._curRot)};function wo(e){var t=[[0,1],[1,2],[2,0]];var n=[];var r={};for(var i=0;i<e.length;i+=3){for(var a=0;a<3;++a){var o=e[i+t[a][0]];var s=e[i+t[a][1]];var l=o>s?s<<16|o:o<<16|s;if(r[l]===undefined){r[l]=0;n.push(o,s)}}}return n}function Eo(e,t,n){if(n===void 0)n=1;var r=new Array(2*e.length);for(var i=0;i<e.length/3;++i){var a=3*i;var o=6*i;r[o+0]=e[a+0];r[o+1]=e[a+1];r[o+2]=e[a+2];r[o+3]=e[a+0]+t[a+0]*n;r[o+4]=e[a+1]+t[a+1]*n;r[o+5]=e[a+2]+t[a+2]*n}return r}var To=Lt.zero();var So=Lt.zero();var Ao=Lt.zero();var Mo=Lt.zero();var Ro=Lt.zero();var Lo=Lt.zero();var Co=Lt.zero();var Oo=Lt.zero();var Io=Lt.zero();var Uo=Lt.zero();var Po=Lt.zero();var Bo=Lt.zero();function Do(e,t,n,r){if(e===void 0)e=2;if(t===void 0)t=2;if(n===void 0)n=2;if(r===void 0)r={};var i=r.widthSegments!==undefined?r.widthSegments:1;var a=r.heightSegments!==undefined?r.heightSegments:1;var o=r.lengthSegments!==undefined?r.lengthSegments:1;var v=r.invWinding!==undefined?r.invWinding:false;var s=e*.5;var l=t*.5;var u=n*.5;var m=[Lt.set(Ro,-s,-l,u),Lt.set(Lo,s,-l,u),Lt.set(Co,s,l,u),Lt.set(Oo,-s,l,u),Lt.set(Io,s,-l,-u),Lt.set(Uo,-s,-l,-u),Lt.set(Po,-s,l,-u),Lt.set(Bo,s,l,-u)];var _=[[2,3,1],[4,5,7],[7,6,2],[1,0,4],[1,4,2],[5,0,6]];var g=[[0,0,1],[0,0,-1],[0,1,0],[0,-1,0],[1,0,0],[-1,0,0]];var y=[];var x=[];var b=[];var w=[];var h=Lt.new(-s,-l,-u);var c=Lt.new(s,l,u);function f(e,t,n){var r,i;var a,o;var s=y.length/3;var l=_[e];var u=g[e];for(o=0;o<=n;o++){for(a=0;a<=t;a++){r=a/t;i=o/n;Lt.lerp(To,m[l[0]],m[l[1]],r);Lt.lerp(So,m[l[0]],m[l[2]],i);Lt.sub(Ao,So,m[l[0]]);Lt.add(Mo,To,Ao);y.push(Mo.x,Mo.y,Mo.z);x.push(u[0],u[1],u[2]);b.push(r,i);if(a<t&&o<n){var h=t+1;var c=a+o*h;var f=a+(o+1)*h;var p=a+1+(o+1)*h;var d=a+1+o*h;if(v){w.push(s+c,s+f,s+d);w.push(s+d,s+f,s+p)}else{w.push(s+c,s+d,s+f);w.push(s+f,s+d,s+p)}}}}}f(0,i,a);f(4,o,a);f(1,i,a);f(5,o,a);f(3,i,o);f(2,i,o);return{positions:y,normals:x,uvs:b,indices:w,minPos:h,maxPos:c}}var Fo=Lt.zero();var zo=Lt.zero();function No(_,g,y,e){if(_===void 0)_=.5;if(g===void 0)g=.5;if(y===void 0)y=2;if(e===void 0)e={};var x=y*.5;var b=e.radialSegments||8;var w=e.heightSegments||1;var t=e.capped!==undefined?e.capped:true;var E=e.arc||2*Math.PI;var n=0;if(!t){if(_>0){n++}if(g>0){n++}}var r=(b+1)*(w+1);if(t){r+=(b+1)*n+b*n}var i=b*w*2*3;if(t){i+=b*n*3}var T=new Array(i);var S=new Array(r*3);var A=new Array(r*3);var M=new Array(r*2);var a=Math.max(_,g);var o=Lt.new(-a,-x,-a);var s=Lt.new(a,x,a);var R=0;var L=0;l();if(t){if(g>0){u(false)}if(_>0){u(true)}}return{positions:S,normals:A,uvs:M,indices:T,minPos:o,maxPos:s};function l(){var e=[];var t=(_-g)/y;for(var n=0;n<=w;n++){var r=[];var i=n/w;var a=i*(_-g)+g;for(var o=0;o<=b;++o){var s=o/b;var l=s*E;var u=Math.sin(l);var h=Math.cos(l);S[3*R]=a*u;S[3*R+1]=i*y-x;S[3*R+2]=a*h;Lt.normalize(Fo,Lt.set(zo,u,-t,h));A[3*R]=Fo.x;A[3*R+1]=Fo.y;A[3*R+2]=Fo.z;M[2*R]=(1-s)*2%1;M[2*R+1]=i;r.push(R);++R}e.push(r)}for(var c=0;c<w;++c){for(var f=0;f<b;++f){var p=e[c][f];var d=e[c+1][f];var v=e[c+1][f+1];var m=e[c][f+1];T[L]=p;++L;T[L]=m;++L;T[L]=d;++L;T[L]=m;++L;T[L]=v;++L;T[L]=d;++L}}}function u(e){var t,n;var r=e?_:g;var i=e?1:-1;t=R;for(var a=1;a<=b;++a){S[3*R]=0;S[3*R+1]=x*i;S[3*R+2]=0;A[3*R]=0;A[3*R+1]=i;A[3*R+2]=0;M[2*R]=.5;M[2*R+1]=.5;++R}n=R;for(var o=0;o<=b;++o){var s=o/b;var l=s*E;var u=Math.cos(l);var h=Math.sin(l);S[3*R]=r*h;S[3*R+1]=x*i;S[3*R+2]=r*u;A[3*R]=0;A[3*R+1]=i;A[3*R+2]=0;M[2*R]=.5-h*.5*i;M[2*R+1]=.5+u*.5;++R}for(var c=0;c<b;++c){var f=t+c;var p=n+c;if(e){T[L]=p+1;++L;T[L]=f;++L;T[L]=p;++L}else{T[L]=f;++L;T[L]=p+1;++L;T[L]=p;++L}}}}function ko(e,t,n){if(e===void 0)e=.5;if(t===void 0)t=1;if(n===void 0)n={};return No(0,e,t,n)}var Vo=Lt.zero();var Wo=Lt.zero();var Go=Lt.zero();var Ho=Lt.zero();var jo=Lt.zero();var qo=Lt.zero();var Xo=Lt.zero();function Yo(e,t,n){if(n===void 0)n={};var r=n.widthSegments!==undefined?n.widthSegments:5;var i=n.lengthSegments!==undefined?n.lengthSegments:5;var a=e*.5;var o=t*.5;var s=[];var l=[];var u=[];var h=[];var c=Lt.new(-a,0,-o);var f=Lt.new(a,0,o);Lt.set(jo,-a,0,o);Lt.set(qo,a,0,o);Lt.set(Xo,-a,0,-o);for(var p=0;p<=i;p++){for(var d=0;d<=r;d++){var v=d/r;var m=p/i;Lt.lerp(Vo,jo,qo,v);Lt.lerp(Wo,jo,Xo,m);Lt.sub(Go,Wo,jo);Lt.add(Ho,Vo,Go);s.push(Ho.x,Ho.y,Ho.z);l.push(0,1,0);u.push(-v,-m);if(d<r&&p<i){var _=r+1;var g=d+p*_;var y=d+(p+1)*_;var x=d+1+(p+1)*_;var b=d+1+p*_;h.push(g,b,y);h.push(b,x,y)}}}return{positions:s,normals:l,uvs:u,indices:h,minPos:c,maxPos:f}}var Ko=[-.5,-.5,0,-.5,.5,0,.5,.5,0,.5,-.5,0];var Zo=[0,0,1,0,0,1,0,0,1,0,0,1];var Qo=[0,0,0,1,1,1,1,0];var Jo=[0,3,1,3,2,1];var $o=Lt.new(-.5,-.5,0);var es=Lt.new(.5,.5,0);function ts(){return{positions:Ko,indices:Jo,normals:Zo,uvs:Qo,minPos:$o,maxPos:es}}function ns(e,t){if(e===void 0)e=1;if(t===void 0)t={};var n=t.segments!==undefined?t.segments:16;var r=[];var i=[];var a=[];var o=[];var s=Lt.new(-e,-e,-e);var l=Lt.new(e,e,e);for(var u=0;u<=n;++u){var h=u*Math.PI/n;var c=Math.sin(h);var f=-Math.cos(h);for(var p=0;p<=n;++p){var d=p*2*Math.PI/n-Math.PI/2;var v=Math.sin(d);var m=Math.cos(d);var _=v*c;var g=f;var y=m*c;var x=p/n;var b=u/n;r.push(_*e,g*e,y*e);i.push(_,g,y);a.push(x,b);if(u<n&&p<n){var w=n+1;var E=w*u+p;var T=w*(u+1)+p;var S=w*(u+1)+p+1;var A=w*u+p+1;o.push(E,A,T);o.push(A,S,T)}}}return{positions:r,indices:o,normals:i,uvs:a,minPos:s,maxPos:l}}function rs(e,t,n){if(e===void 0)e=.5;if(t===void 0)t=.2;if(n===void 0)n={};var r=n.radialSegments||30;var i=n.tubularSegments||20;var a=n.arc||2*Math.PI;var o=[];var s=[];var l=[];var u=[];var h=Lt.new(-e-t,-t,-e-t);var c=Lt.new(e+t,t,e+t);for(var f=0;f<=r;f++){for(var p=0;p<=i;p++){var d=p/i;var v=f/r;var m=d*a;var _=v*Math.PI*2;var g=(e+t*Math.cos(_))*Math.sin(m);var y=t*Math.sin(_);var x=(e+t*Math.cos(_))*Math.cos(m);var b=Math.sin(m)*Math.cos(_);var w=Math.sin(_);var E=Math.cos(m)*Math.cos(_);o.push(g,y,x);s.push(b,w,E);l.push(d,v);if(p<i&&f<r){var T=i+1;var S=T*f+p;var A=T*(f+1)+p;var M=T*(f+1)+p+1;var R=T*f+p+1;u.push(S,R,A);u.push(R,M,A)}}}return{positions:o,normals:s,uvs:l,indices:u,minPos:h,maxPos:c}}var is=Lt.zero();var as=Lt.zero();function os(g,y,e,t){if(g===void 0)g=.5;if(y===void 0)y=.5;if(e===void 0)e=2;if(t===void 0)t={};var _=e-g-y;var x=t.sides||16;var b=t.heightSegments||10;var w=y/e;var E=_/e;var T=g/e;var S=Math.floor(b*w);var A=Math.floor(b*T);var M=Math.floor(b*E);var R=_+y-e/2;var L=y-e/2;var C=y-e/2;var O=t.arc||2*Math.PI;var I=[];var U=[];var P=[];var B=[];var n=Math.max(g,y);var r=Lt.new(-n,-e/2,-n);var i=Lt.new(n,e/2,n);var D=0;var F=[];o();a();s();return{positions:I,normals:U,uvs:P,indices:B,minPos:r,maxPos:i};function a(){var e=(g-y)/_;for(var t=0;t<=M;t++){var n=[];var r=t/M;var i=r*(g-y)+y;for(var a=0;a<=x;++a){var o=a/x;var s=r*E+w;var l=o*O-O/4;var u=Math.sin(l);var h=Math.cos(l);I.push(i*u);I.push(r*_+L);I.push(i*h);Lt.normalize(is,Lt.set(as,u,-e,h));U.push(is.x);U.push(is.y);U.push(is.z);P.push(-o,s);n.push(D);++D}F.push(n)}for(var c=0;c<M;++c){for(var f=0;f<x;++f){var p=F[c][f];var d=F[c+1][f];var v=F[c+1][f+1];var m=F[c][f+1];B.push(p);B.push(m);B.push(d);B.push(m);B.push(v);B.push(d)}}}function o(){for(var e=0;e<=S;++e){var t=e*Math.PI/S/2;var n=Math.sin(t);var r=-Math.cos(t);for(var i=0;i<=x;++i){var a=i*2*Math.PI/x-Math.PI/2;var o=Math.sin(a);var s=Math.cos(a);var l=o*n;var u=r;var h=s*n;var c=i/x;var f=e/b;I.push(l*y,u*y+C,h*y);U.push(l,u,h);P.push(-c,f);if(e<S&&i<x){var p=x+1;var d=p*e+i;var v=p*(e+1)+i;var m=p*(e+1)+i+1;var _=p*e+i+1;B.push(d,_,v);B.push(_,m,v)}++D}}}function s(){for(var e=0;e<=A;++e){var t=e*Math.PI/A/2+Math.PI/2;var n=Math.sin(t);var r=-Math.cos(t);for(var i=0;i<=x;++i){var a=i*2*Math.PI/x-Math.PI/2;var o=Math.sin(a);var s=Math.cos(a);var l=o*n;var u=r;var h=s*n;var c=i/x;var f=e/b+(1-T);I.push(l*g,u*g+R,h*g);U.push(l,u,h);P.push(-c,f);if(e<A&&i<x){var p=x+1;var d=p*e+i+F[M][x]+1;var v=p*(e+1)+i+F[M][x]+1;var m=p*(e+1)+i+1+F[M][x]+1;var _=p*e+i+1+F[M][x]+1;B.push(d,_,v);B.push(_,m,v)}}}}}var ss=Object.freeze({box:Do,cone:ko,cylinder:No,plane:Yo,quad:ts,sphere:ns,torus:rs,capsule:os,wireframe:wo,normals:Eo});var ls=Lt.new(1,0,0);var us=Lt.new(0,1,0);var hs=Lt.new(0,0,1);var cs=Lt.zero();var fs=Lt.zero();var ps=Dt.create();var ds=function e(t){this._app=t;this._view2D=new Ni.View;this._view2D._clearFlags=0;this._view2D._cullingByID=true;this._view2D._stages=["opaque"];this._lines=new cr(function(){return{start:Lt.zero(),end:Lt.zero(),color:Dt.create(),duration:0,depthTest:false,timer:0,is2D:false,_prev:null,_next:null}},2e3);this._rects=new cr(function(){return{x:0,y:0,w:1,h:1,color:Dt.create(),duration:0,timer:0,_prev:null,_next:null}},2e3);this._axesList=new cr(function(){return{pos:Lt.zero(),up:Lt.zero(),right:Lt.zero(),forward:Lt.zero(),duration:0,depthTest:false,timer:0,is2D:false,_prev:null,_next:null}},2e3);var n=new Ni.Pass("wireframe");n.setDepth(true,true);var r=new Ni.Technique(["opaque"],[{name:"color",type:Ni.PARAM_COLOR3}],[n]);var i=new Ni.Effect([r],{},[]);i.setProperty("color",Dt.new(1,1,1));this._primitives=new cr(function(){return{model:function(){var e=new Ni.Model;var t=new Cr;e.setNode(t);e.setEffect(i);return e}(),duration:0,depthTest:false,timer:0,_prev:null,_next:null}},2e3);var a=new Ni.Pass("line");a.setDepth(true,true);var o=new Ni.Technique(["opaque"],[],[a]);var s=new Ni.Effect([o],{},[]);var l=new Ni.LineBatchModel;l.setNode(new Cr("debug-lines"));l.setEffect(s);var u=new Ni.LineBatchModel;u.setNode(new Cr("debug-lines-2d"));u.setEffect(s);var h=ns(1,{segments:20});h.uvs=null;h.indices=wo(h.indices);this._sphereIA=Ni.createIA(t.device,h);this._sphereIA._primitiveType=Ae.PT_LINES;this._lineBatchModel=l;this._lineBatchModel2D=u};ds.prototype.start=function e(){this._app.scene.addView(this._view2D);this._app.scene.addModel(this._lineBatchModel);this._app.scene.addModel(this._lineBatchModel2D)};ds.prototype.stop=function e(){var t=this;this._app.scene.removeView(this._view2D);this._app.scene.removeModel(this._lineBatchModel);this._app.scene.removeModel(this._lineBatchModel2D);this._primitives.forEach(function(e){e.model.setInputAssembler(null);t._app.scene.removeModel(e.model);t._primitives.remove(e)})};ds.prototype.tick=function e(){var t=this;var n=this._app.deltaTime;var r=this._app._canvas.width;var i=this._app._canvas.height;Bt.ortho(this._view2D._matProj,0,r,0,i,-100,100);Bt.copy(this._view2D._matViewProj,this._view2D._matProj);Bt.invert(this._view2D._matInvViewProj,this._view2D._matProj);this._view2D._rect.x=this._view2D._rect.y=0;this._view2D._rect.w=r;this._view2D._rect.h=i;this._lineBatchModel.clear();this._lineBatchModel2D.clear();this._lineBatchModel2D._viewID=this._view2D._id;this._lines.forEach(function(e){if(e.timer>e.duration){t._lines.remove(e);return}if(e.is2D){t._lineBatchModel2D.addLine(e.start,e.end,e.color)}else if(e.depthTest){t._lineBatchModel.addLine(e.start,e.end,e.color)}else{console.warn("We have not support it yet")}e.timer+=n});this._rects.forEach(function(e){if(e.timer>e.duration){t._rects.remove(e);return}t._lineBatchModel2D.addLine(Lt.set(cs,e.x,e.y,0),Lt.set(fs,e.x,e.y+e.h,0),e.color);t._lineBatchModel2D.addLine(Lt.set(cs,e.x,e.y+e.h,0),Lt.set(fs,e.x+e.w,e.y+e.h,0),e.color);t._lineBatchModel2D.addLine(Lt.set(cs,e.x+e.w,e.y+e.h,0),Lt.set(fs,e.x+e.w,e.y,0),e.color);t._lineBatchModel2D.addLine(Lt.set(cs,e.x+e.w,e.y,0),Lt.set(fs,e.x,e.y,0),e.color);e.timer+=n});this._axesList.forEach(function(e){if(e.timer>e.duration){t._axesList.remove(e);return}if(e.is2D){t._lineBatchModel2D.addLine(e.pos,e.up,Dt.set(ps,1,0,0));t._lineBatchModel2D.addLine(e.pos,e.right,Dt.set(ps,0,1,0));t._lineBatchModel2D.addLine(e.pos,e.forward,Dt.set(ps,0,0,1))}else if(e.depthTest){t._lineBatchModel.addLine(e.pos,e.up,Dt.set(ps,1,0,0));t._lineBatchModel.addLine(e.pos,e.right,Dt.set(ps,0,1,0));t._lineBatchModel.addLine(e.pos,e.forward,Dt.set(ps,0,0,1))}else{console.warn("We have not support it yet")}e.timer+=n});this._primitives.forEach(function(e){if(e.timer>e.duration){e.model.setInputAssembler(null);t._app.scene.removeModel(e.model);t._primitives.remove(e);return}e.timer+=n})};ds.prototype.addLine=function e(t,n,r,i,a,o){if(i===void 0)i=0;if(a===void 0)a=true;if(o===void 0)o=false;var s=this._lines.add();Lt.copy(s.start,t);Lt.copy(s.end,n);Dt.copy(s.color,r);s.duration=i;s.depthTest=a;s.timer=0;s.is2D=o;if(o){s.start.z=0;s.end.z=0}};ds.prototype.addRect2D=function e(t,n,r,i,a,o){if(o===void 0)o=0;var s=this._rects.add();s.x=t;s.y=n;s.w=r;s.h=i;Dt.copy(s.color,a);s.duration=o;s.timer=0};ds.prototype.addAxes=function e(t,n,r,i,a,o){if(i===void 0)i=0;if(a===void 0)a=true;if(o===void 0)o=false;var s=this._axesList.add();Lt.copy(s.pos,t);Lt.transformQuat(cs,ls,n);Lt.scaleAndAdd(cs,t,cs,r),Lt.copy(s.right,cs);Lt.transformQuat(cs,us,n);Lt.scaleAndAdd(cs,t,cs,r),Lt.copy(s.up,cs);Lt.transformQuat(cs,hs,n);Lt.scaleAndAdd(cs,t,cs,r),Lt.copy(s.forward,cs);s.duration=i;s.depthTest=a;s.timer=0;s.is2D=o};ds.prototype.addSphere=function e(t,n,r,i,a){if(i===void 0)i=0;if(a===void 0)a=true;var o=this._primitives.add();o.model.setInputAssembler(this._sphereIA);Lt.copy(o.model._node.lpos,t);Lt.set(o.model._node.lscale,n,n,n);o.duration=i;o.depthTest=a;o.timer=0;this._app.scene.addModel(o.model)};function vs(e,t,n,r){var i=[];var a=t*.5;var o=n*.5;var s=t/r;var l=n/r;for(var u=-a;u<=a;u+=s){i.push(u,0,-o);i.push(u,0,o)}for(var h=-o;h<=o;h+=l){i.push(-a,0,h);i.push(a,0,h)}var c=Ni.createIA(e.device,{positions:i});c._primitiveType=Ae.PT_LINES;var f=new Ni.Pass("simple");f.setDepth(true,true);var p=new Ni.Technique(["opaque"],[{name:"color",type:Ni.PARAM_COLOR4}],[f]);var d=new Ni.Effect([p],{},[{name:"USE_TEXTURE",value:false},{name:"USE_COLOR",value:true}]);d.define("USE_COLOR",true);d.setProperty("color",Ft.new(.4,.4,.4,1));var v=new Ni.Model;v.setInputAssembler(c);v.setEffect(d);v.setNode(new Cr("debug-grid"));return v}var ms=function e(t){this._state="sleep";this._app=t;this._drawMng=new ds(t);this._debugInput=new Hi(t.view,{lock:Hi.LOCK_WHEN_PRESSED,invertY:true,enabled:false});this._orbit=new bo(this._debugInput);this._camera=new Ni.Camera;this._camera.setColor(.3,.3,.3,1);this._camera.setNode(this._orbit._node);this._camera.setStages(["opaque","transparent"]);this._grid=vs(t,100,100,100)};ms.prototype.start=function e(){if(this._state!=="sleep"){return}this._state="enter"};ms.prototype.stop=function e(){if(this._state==="sleep"){return}this._state="fade2normal"};ms.prototype.tick=function e(){if(this._state==="sleep"){return}var t="_"+this._state;var n=this[t];if(!n){console.warn("Unknown state "+this._state);return}this[t]()};ms.prototype.postTick=function e(){this._drawMng.tick()};ms.prototype.drawLine=function e(t,n,r,i,a){if(this._state!=="debug"){return}this._drawMng.addLine(t,n,r,i,a,false)};ms.prototype.drawLine2D=function e(t,n,r,i){if(this._state!=="debug"){return}this._drawMng.addLine(t,n,r,i,false,true)};ms.prototype.drawRect=function e(t,n,r,i,a,o){if(this._state!=="debug"){return}this._drawMng.addRect2D(t,n,r,i,a,o)};ms.prototype.drawAxes=function e(t,n,r,i,a){if(this._state!=="debug"){return}this._drawMng.addAxes(t,n,r,i,a,false)};ms.prototype.drawAxes2D=function e(t,n,r,i){if(this._state!=="debug"){return}this._drawMng.addAxes(t,n,r,i,false,true)};ms.prototype.drawSphere=function e(t,n,r,i,a){if(this._state!=="debug"){return}this._drawMng.addSphere(t,n,r,i,a)};ms.prototype._enter=function e(){var t=null;io.walk(this._app.activeLevel,function(e){t=e.getComp("Camera");if(t){return false}return true});if(!t){return}this._app.input.enabled=false;this._debugInput.enabled=true;Lt.copy(this._orbit._node.lpos,t._entity.lpos);It.copy(this._orbit._node.lrot,t._entity.lrot);Lt.copy(this._orbit._node.lscale,t._entity.lscale);this._orbit.reset();this._app.scene.setDebugCamera(this._camera);this._app.scene.addModel(this._grid);this._drawMng.start();this._state="fade2debug"};ms.prototype._fade2debug=function e(){this._state="debug"};ms.prototype._debug=function e(){var t=this._app.deltaTime;this._orbit.tick(t);this._debugInput.reset()};ms.prototype._fade2normal=function e(){this._state="exit"};ms.prototype._exit=function e(){this._debugInput.enabled=false;this._app.input.enabled=true;this._app.scene.removeModel(this._grid);this._app.scene.setDebugCamera(null);this._drawMng.stop();this._state="sleep"};function _s(e){return e.map(function(e){return Object.assign({},e)})}var gs=function(t){function e(){t.call(this);this._props={};this._effectInst=null;this._effect=null}if(t)e.__proto__=t;e.prototype=Object.create(t&&t.prototype);e.prototype.constructor=e;var n={effect:{configurable:true},effectInst:{configurable:true}};e.prototype._updateEffectInst=function e(){var t=this;var n=this._effect.techniques.length;var r=new Array(n);var i={};for(var a=0;a<n;++a){var o=t._effect.techniques[a];for(var s=0;s<o.params.length;++s){var l=o.params[s];switch(l.type){case Ni.PARAM_FLOAT:i[l.name]=l.value;break;case Ni.PARAM_FLOAT2:i[l.name]=Rt.new(l.value[0],l.value[1]);break;case Ni.PARAM_FLOAT3:i[l.name]=Lt.new(l.value[0],l.value[1],l.value[2]);break;case Ni.PARAM_FLOAT4:i[l.name]=Ct.new(l.value[0],l.value[1],l.value[2],l.value[3]);break;case Ni.PARAM_COLOR3:i[l.name]=Dt.new(l.value[0],l.value[1],l.value[2]);break;case Ni.PARAM_COLOR4:i[l.name]=Ft.new(l.value[0],l.value[1],l.value[2],l.value[3]);break;case Ni.PARAM_TEXTURE_2D:case Ni.PARAM_TEXTURE_CUBE:i[l.name]=null;break;default:console.warn("unsupport param type in effect json.")}}var u=o.passes.length;var h=new Array(u);for(var c=0;c<u;++c){var f=o.passes[c];h[c]=new Ni.Pass(f.program);if(f.depthTest!==undefined&&f.depthWrite!==undefined){h[c].setDepth(f.depthTest,f.depthWrite)}if(f.cullMode!==undefined){h[c].setCullMode(f.cullMode)}if(f.blend===true){h[c].setBlend(f.blendEq,f.blendSrc,f.blendDst,f.blendAlphaEq,f.blendSrcAlpha,f.blendDstAlpha)}}r[a]=new Ni.Technique(o.stages,o.params,h,o.layer)}for(var p in i){t._props[p]=i[p]}var d=_s(this._effect.defines);var v=_s(this._effect.dependencies);if(this._effectInst){this._effectInst.clear();this._effectInst._techniques=r;this._effectInst._properties=i;this._effectInst._defines=d;this._effectInst._dependencies=v}else{this._effectInst=new Ni.Effect(r,i,d,v)}};n.effect.get=function(){return this._effect};n.effect.set=function(e){if(this._effect!==e){this._effect=e;this._updateEffectInst()}};n.effectInst.get=function(){return this._effectInst};e.prototype.copy=function e(t){var n=this;if(this._effect!==t._effect){this._effect=t._effect;this._updateEffectInst()}this._effectInst._defines=_s(t._effectInst._defines);this._effectInst._dependencies=_s(t._effectInst._dependencies);for(var r in t._props){n.setProperty(r,t._props[r])}};e.prototype.setProperty=function e(t,n){this._props[t]=n;if(n instanceof za){this._effectInst.setProperty(t,n._texture)}else{this._effectInst.setProperty(t,n)}};e.prototype.define=function e(t,n){this._effectInst.define(t,n)};e.prototype.unload=function e(){if(!this._loaded){return}t.prototype.unload.call(this)};Object.defineProperties(e.prototype,n);return e}(Ba);var ys={images:[],mipmap:true,width:2,height:2,format:Ae.TEXTURE_FMT_RGBA8,anisotropy:1,wrapS:Ae.WRAP_REPEAT,wrapT:Ae.WRAP_REPEAT,minFilter:Ae.FILTER_LINEAR,magFilter:Ae.FILTER_LINEAR,mipFilter:Ae.FILTER_LINEAR};function xs(e,t){e.images=t._images;e.mipmap=t._mipmap;e.width=t._width;e.height=t._height;e.format=Va[t._format];e.anisotropy=t._anisotropy;e.wrapS=ka[t._wrapS];e.wrapT=ka[t._wrapT];e.minFilter=Na[t._minFilter];e.magFilter=Na[t._magFilter];e.mipFilter=Na[t._mipFilter]}var bs=function(i){function e(e,t,n,r){if(t===void 0)t=2;if(n===void 0)n=2;if(r===void 0)r="rgba8";i.call(this,e);this._images=[];this._mipmap=true;this._width=t;this._height=n;this._format=r;this._anisotropy=1;this._wrapS="repeat";this._wrapT="repeat";this._minFilter="linear";this._magFilter="linear";this._mipFilter="linear"}if(i)e.__proto__=i;e.prototype=Object.create(i&&i.prototype);e.prototype.constructor=e;var t={width:{configurable:true},height:{configurable:true},mipmap:{configurable:true},anisotropy:{configurable:true},wrapS:{configurable:true},wrapT:{configurable:true},minFilter:{configurable:true},magFilter:{configurable:true},mipFilter:{configurable:true}};e.prototype.unload=function e(){if(!this._loaded){return}this._texture.destroy();i.prototype.unload.call(this)};e.prototype.setImages=function e(t){this._images=t;this.resize(t[0][0].width,t[0][0].height)};e.prototype.resize=function e(t,n){this._width=t;this._height=n};t.width.get=function(){return this._width};t.height.get=function(){return this._height};t.mipmap.set=function(e){this._mipmap=e};t.mipmap.get=function(){return this._mipmap};t.anisotropy.set=function(e){this._anisotropy=e};t.anisotropy.get=function(){return this._anisotropy};t.wrapS.set=function(e){this._wrapS=e};t.wrapS.get=function(){return this._wrapS};t.wrapT.set=function(e){this._wrapT=e};t.wrapT.get=function(){return this._wrapT};t.minFilter.set=function(e){this._minFilter=e};t.minFilter.get=function(){return this._minFilter};t.magFilter.set=function(e){this._magFilter=e};t.magFilter.get=function(){return this._magFilter};t.mipFilter.set=function(e){this._mipFilter=e};t.mipFilter.get=function(){return this._mipFilter};e.prototype.commit=function e(){xs(ys,this);if(!this._texture){this._texture=new Ae.TextureCube(this._device,ys)}else{this._texture.update(ys)}this._images=[]};Object.defineProperties(e.prototype,t);return e}(za);var ws=function(t){function e(){t.call(this);this._techniques=[];this._properties={};this._defines=[];this._dependencies=[]}if(t)e.__proto__=t;e.prototype=Object.create(t&&t.prototype);e.prototype.constructor=e;var n={techniques:{configurable:true},properties:{configurable:true},defines:{configurable:true},dependencies:{configurable:true}};n.techniques.set=function(e){this._techniques=e};n.techniques.get=function(){return this._techniques};n.properties.set=function(e){this._properties=e};n.properties.get=function(){return this._properties};n.defines.set=function(e){this._defines=e};n.defines.get=function(){return this._defines};n.dependencies.set=function(e){this._dependencies=e};n.dependencies.get=function(){return this._dependencies};e.prototype.unload=function e(){if(!this._loaded){return}t.prototype.unload.call(this)};Object.defineProperties(e.prototype,n);return e}(Ba);var Es=Lt.zero();var Ts=Lt.zero();var Ss=Bt.create();var As=Bt.create();var Ms=function(n){function e(){var e=this;n.call(this);this._texture=null;this._x=0;this._y=0;this._width=64;this._height=64;this._rotated=false;this._left=0;this._right=0;this._top=0;this._bottom=0;this._uvs=new Array(16);for(var t=0;t<16;++t){e._uvs[t]=Lt.zero()}}if(n)e.__proto__=n;e.prototype=Object.create(n&&n.prototype);e.prototype.constructor=e;var t={texture:{configurable:true},x:{configurable:true},y:{configurable:true},width:{configurable:true},height:{configurable:true},rotated:{configurable:true},left:{configurable:true},right:{configurable:true},top:{configurable:true},bottom:{configurable:true},uvs:{configurable:true}};t.texture.get=function(){return this._texture};t.texture.set=function(e){this._texture=e};t.x.get=function(){return this._x};t.x.set=function(e){this._x=e};t.y.get=function(){return this._y};t.y.set=function(e){this._y=e};t.width.get=function(){return this._width};t.width.set=function(e){this._width=e};t.height.get=function(){return this._height};t.height.set=function(e){this._height=e};t.rotated.get=function(){return this._rotated};t.rotated.set=function(e){this._rotated=e};t.left.get=function(){return this._left};t.left.set=function(e){this._left=e};t.right.get=function(){return this._right};t.right.set=function(e){this._right=e};t.top.get=function(){return this._top};t.top.set=function(e){this._top=e};t.bottom.get=function(){return this._bottom};t.bottom.set=function(e){this._bottom=e};t.uvs.get=function(){return this._uvs};e.prototype.commit=function e(){var t=this;var n=this._texture.width;var r=this._texture.height;if(this._rotated){Lt.set(Ts,this._width,this._height,1);Bt.fromScaling(As,Ts);Bt.fromZRotation(Ss,-Math.PI/2);Bt.multiply(As,Ss,As);Lt.set(Es,this._x,r-this._y,0);Bt.fromTranslation(Ss,Es);Bt.multiply(As,Ss,As);Lt.set(Ts,1/n,1/r,1);Bt.fromScaling(Ss,Ts);Bt.multiply(As,Ss,As)}else{Lt.set(Ts,this._width,this._height,1);Bt.fromScaling(As,Ts);Lt.set(Es,this._x,r-(this._y+this._height),0);Bt.fromTranslation(Ss,Es);Bt.multiply(As,Ss,As);Lt.set(Ts,1/n,1/r,1);Bt.fromScaling(Ss,Ts);Bt.multiply(As,Ss,As)}var i=this._uvs;i[0].x=i[4].x=i[8].x=i[12].x=0;i[1].x=i[5].x=i[9].x=i[13].x=this._left/this._width;i[2].x=i[6].x=i[10].x=i[14].x=1-this._right/this._width;i[3].x=i[7].x=i[11].x=i[15].x=1;i[0].y=i[1].y=i[2].y=i[3].y=0;i[4].y=i[5].y=i[6].y=i[7].y=this._bottom/this._height;i[8].y=i[9].y=i[10].y=i[11].y=1-this._top/this._height;i[12].y=i[13].y=i[14].y=i[15].y=1;for(var a=0;a<this._uvs.length;++a){Lt.transformMat4(t._uvs[a],t._uvs[a],As)}};Object.defineProperties(e.prototype,t);return e}(Ba);var Rs=[{name:"font",techniques:[{stages:["ui"],params:[{name:"mainTexture",type:13,value:null}],passes:[{program:"sprite",depthTest:true,depthWrite:false,blend:true,blendEq:32774,blendSrc:1,blendDst:771,blendAlphaEq:32774,blendSrcAlpha:1,blendDstAlpha:771}],layer:0}],properties:{},defines:[],dependencies:undefined},{name:"grid",techniques:[{stages:["opaque"],params:[{name:"tiling",type:5,value:[1,1]},{name:"baseColorWhite",type:8,value:[1,1,1]},{name:"baseColorBlack",type:8,value:[0,0,0]},{name:"basePattern",type:13,value:null},{name:"basePatternTiling",type:5,value:[1,1]},{name:"basePatternOffset",type:5,value:[0,0]},{name:"subPatternColor",type:9,value:[1,1,1,1]},{name:"subPattern",type:13,value:null},{name:"subPatternTiling",type:5,value:[1,1]},{name:"subPatternOffset",type:5,value:[0,0]},{name:"subPatternColor2",type:9,value:[1,1,1,1]},{name:"subPattern2",type:13,value:null},{name:"subPattern2Tiling",type:5,value:[1,1]},{name:"subPattern2Offset",type:5,value:[0,0]}],passes:[{program:"grid"}],layer:0}],properties:{},defines:[{name:"USE_WORLD_POS",value:false}],dependencies:undefined},{name:"line",techniques:[{stages:["opaque"],params:[],passes:[{program:"line",depthTest:true,depthWrite:true}],layer:0}],properties:{},defines:[],dependencies:undefined},{name:"matcap",techniques:[{stages:["opaque"],params:[{name:"mainTex",type:13,value:null},{name:"matcapTex",type:13,value:null},{name:"colorFactor",type:4,value:.5},{name:"color",type:9,value:[1,1,1,1]}],passes:[{program:"matcap",depthTest:true,depthWrite:true}],layer:0}],properties:{},defines:[{name:"USE_MAIN_TEX",value:false},{name:"USE_SKINNING",value:false}],dependencies:undefined},{name:"particle-add-multiply",techniques:[{stages:["transparent"],params:[{name:"mainTexture",type:13,value:null},{name:"mainTiling",type:5,value:[1,1]},{name:"mainOffset",type:5,value:[0,0]},{name:"tintColor",type:9,value:[.5,.5,.5,.5]},{name:"frameTile",type:5,value:[1,1]},{name:"velocityScale",type:4,value:0},{name:"lengthScale",type:4,value:0}],passes:[{program:"particle-add-multiply",cullMode:0,depthTest:true,depthWrite:false,blend:true,blendEq:32774,blendSrc:1,blendDst:771,blendAlphaEq:32774,blendSrcAlpha:1,blendDstAlpha:771}],layer:0}],properties:{},defines:[{name:"USE_SOFT_PARTICLE",value:false},{name:"USE_BILLBOARD",value:false},{name:"USE_STRETCHED_BILLBOARD",value:false},{name:"USE_HORIZONTAL_BILLBOARD",value:false},{name:"USE_VERTICAL_BILLBOARD",value:false},{name:"USE_WORLD_SPACE",value:false}],dependencies:undefined},{name:"particle-add-smooth",techniques:[{stages:["transparent"],params:[{name:"mainTexture",type:13,value:null},{name:"mainTiling",type:5,value:[1,1]},{name:"mainOffset",type:5,value:[0,0]},{name:"frameTile",type:5,value:[1,1]},{name:"velocityScale",type:4,value:0},{name:"lengthScale",type:4,value:0}],passes:[{program:"particle-add-smooth",cullMode:0,depthTest:true,depthWrite:false,blend:true,blendEq:32774,blendSrc:1,blendDst:769,blendAlphaEq:32774,blendSrcAlpha:1,blendDstAlpha:769}],layer:0}],properties:{},defines:[{name:"USE_SOFT_PARTICLE",value:false},{name:"USE_BILLBOARD",value:false},{name:"USE_STRETCHED_BILLBOARD",value:false},{name:"USE_HORIZONTAL_BILLBOARD",value:false},{name:"USE_VERTICAL_BILLBOARD",value:false},{name:"USE_WORLD_SPACE",value:false}],dependencies:undefined},{name:"particle-add",techniques:[{stages:["transparent"],params:[{name:"mainTexture",type:13,value:null},{name:"mainTiling",type:5,value:[1,1]},{name:"mainOffset",type:5,value:[0,0]},{name:"tintColor",type:9,value:[.5,.5,.5,.5]},{name:"frameTile",type:5,value:[1,1]},{name:"velocityScale",type:4,value:0},{name:"lengthScale",type:4,value:0}],passes:[{program:"particle-add",cullMode:0,depthTest:true,depthWrite:false,blend:true,blendEq:32774,blendSrc:770,blendDst:1,blendAlphaEq:32774,blendSrcAlpha:770,blendDstAlpha:1}],layer:0}],properties:{},defines:[{name:"USE_SOFT_PARTICLE",value:false},{name:"USE_BILLBOARD",value:false},{name:"USE_STRETCHED_BILLBOARD",value:false},{name:"USE_HORIZONTAL_BILLBOARD",value:false},{name:"USE_VERTICAL_BILLBOARD",value:false},{name:"USE_WORLD_SPACE",value:false}],dependencies:undefined},{name:"particle-alpha-blend",techniques:[{stages:["transparent"],params:[{name:"mainTexture",type:13,value:null},{name:"mainTiling",type:5,value:[1,1]},{name:"mainOffset",type:5,value:[0,0]},{name:"tintColor",type:9,value:[.5,.5,.5,.5]},{name:"frameTile",type:5,value:[1,1]},{name:"velocityScale",type:4,value:0},{name:"lengthScale",type:4,value:0}],passes:[{program:"particle-alpha-blend",cullMode:0,depthTest:true,depthWrite:false,blend:true,blendEq:32774,blendSrc:770,blendDst:771,blendAlphaEq:32774,blendSrcAlpha:770,blendDstAlpha:771}],layer:0}],properties:{},defines:[{name:"USE_SOFT_PARTICLE",value:false},{name:"USE_BILLBOARD",value:false},{name:"USE_STRETCHED_BILLBOARD",value:false},{name:"USE_HORIZONTAL_BILLBOARD",value:false},{name:"USE_VERTICAL_BILLBOARD",value:false},{name:"USE_WORLD_SPACE",value:false}],dependencies:undefined},{name:"particle-premultiply-blend",techniques:[{stages:["transparent"],params:[{name:"mainTexture",type:13,value:null},{name:"mainTiling",type:5,value:[1,1]},{name:"mainOffset",type:5,value:[0,0]},{name:"frameTile",type:5,value:[1,1]},{name:"velocityScale",type:4,value:0},{name:"lengthScale",type:4,value:0}],passes:[{program:"particle-premultiply-blend",cullMode:0,depthTest:true,depthWrite:false,blend:true,blendEq:32774,blendSrc:1,blendDst:771,blendAlphaEq:32774,blendSrcAlpha:1,blendDstAlpha:771}],layer:0}],properties:{},defines:[{name:"USE_SOFT_PARTICLE",value:false},{name:"USE_BILLBOARD",value:false},{name:"USE_STRETCHED_BILLBOARD",value:false},{name:"USE_HORIZONTAL_BILLBOARD",value:false},{name:"USE_VERTICAL_BILLBOARD",value:false},{name:"USE_WORLD_SPACE",value:false}],dependencies:undefined},{name:"pbr-transparent",techniques:[{stages:["transparent"],params:[{name:"albedo",type:9,value:[1,1,1,1]},{name:"mainTiling",type:5,value:[1,1]},{name:"mainOffset",type:5,value:[0,0]},{name:"albedo_texture",type:13,value:null},{name:"metallic",type:4,value:1},{name:"metallic_texture",type:13,value:null},{name:"roughness",type:4,value:.5},{name:"roughness_texture",type:13,value:null},{name:"ao",type:4,value:.2},{name:"ao_texture",type:13,value:null},{name:"emissive",type:8,value:[0,0,0]},{name:"emissive_texture",type:13,value:null},{name:"normal_texture",type:13,value:null},{name:"diffuseEnvTexture",type:14,value:null},{name:"specularEnvTexture",type:14,value:null},{name:"brdfLUT",type:13,value:null},{name:"maxReflectionLod",type:4,value:9},{name:"alphaTestThreshold",type:4,value:0}],passes:[{program:"pbr",cullMode:1029,depthTest:true,depthWrite:false,blend:true,blendEq:32774,blendSrc:770,blendDst:771,blendAlphaEq:32774,blendSrcAlpha:1,blendDstAlpha:771}],layer:0},{stages:["shadowcast"],params:[],passes:[{program:"shadow-depth",cullMode:1029,blendMode:0,depthTest:true,depthWrite:true}],layer:0}],properties:{},defines:[{name:"USE_NORMAL_TEXTURE",value:false},{name:"USE_ALBEDO_TEXTURE",value:false},{name:"USE_MRA_TEXTURE",value:false},{name:"USE_METALLIC_TEXTURE",value:false},{name:"USE_ROUGHNESS_TEXTURE",value:false},{name:"USE_AO_TEXTURE",value:false},{name:"USE_EMISSIVE",value:false},{name:"USE_EMISSIVE_TEXTURE",value:false},{name:"USE_IBL",value:false},{name:"USE_TEX_LOD",value:false},{name:"USE_ALPHA_TEST",value:false},{name:"USE_SHADOW_MAP",value:false},{name:"USE_SKINNING",value:false},{name:"NUM_DIR_LIGHTS",value:0},{name:"NUM_POINT_LIGHTS",value:0},{name:"NUM_SPOT_LIGHTS",value:0},{name:"NUM_SHADOW_LIGHTS",value:0}],dependencies:[{define:"USE_NORMAL_TEXTURE",extension:"OES_standard_derivatives"},{define:"USE_TEX_LOD",extension:"EXT_shader_texture_lod"}]},{name:"pbr",techniques:[{stages:["opaque"],params:[{name:"albedo",type:9,value:[1,1,1,1]},{name:"mainTiling",type:5,value:[1,1]},{name:"mainOffset",type:5,value:[0,0]},{name:"albedo_texture",type:13,value:null},{name:"metallic",type:4,value:1},{name:"metallic_texture",type:13,value:null},{name:"roughness",type:4,value:.5},{name:"roughness_texture",type:13,value:null},{name:"ao",type:4,value:.2},{name:"ao_texture",type:13,value:null},{name:"emissive",type:8,value:[0,0,0]},{name:"emissive_texture",type:13,value:null},{name:"normal_texture",type:13,value:null},{name:"diffuseEnvTexture",type:14,value:null},{name:"specularEnvTexture",type:14,value:null},{name:"brdfLUT",type:13,value:null},{name:"maxReflectionLod",type:4,value:9},{name:"alphaTestThreshold",type:4,value:0}],passes:[{program:"pbr",cullMode:1029,depthTest:true,depthWrite:true}],layer:0},{stages:["shadowcast"],params:[],passes:[{program:"shadow-depth",cullMode:1029,blendMode:0,depthTest:true,depthWrite:true}],layer:0}],properties:{},defines:[{name:"USE_NORMAL_TEXTURE",value:false},{name:"USE_ALBEDO_TEXTURE",value:false},{name:"USE_MRA_TEXTURE",value:false},{name:"USE_METALLIC_TEXTURE",value:false},{name:"USE_ROUGHNESS_TEXTURE",value:false},{name:"USE_AO_TEXTURE",value:false},{name:"USE_EMISSIVE",value:false},{name:"USE_EMISSIVE_TEXTURE",value:false},{name:"USE_IBL",value:false},{name:"USE_TEX_LOD",value:false},{name:"USE_ALPHA_TEST",value:false},{name:"USE_SHADOW_MAP",value:false},{name:"USE_SKINNING",value:false},{name:"NUM_DIR_LIGHTS",value:0},{name:"NUM_POINT_LIGHTS",value:0},{name:"NUM_SPOT_LIGHTS",value:0},{name:"NUM_SHADOW_LIGHTS",value:0},{name:"USE_RGBE_HDR_IBL_SPECULAR",value:false},{name:"USE_RGBE_HDR_IBL_DIFFUSE",value:false}],dependencies:[{define:"USE_NORMAL_TEXTURE",extension:"OES_standard_derivatives"},{define:"USE_TEX_LOD",extension:"EXT_shader_texture_lod"}]},{name:"phong-transparent",techniques:[{stages:["transparent"],params:[{name:"diffuseColor",type:9,value:[.8,.8,.8,1]},{name:"mainTiling",type:5,value:[1,1]},{name:"mainOffset",type:5,value:[0,0]},{name:"diffuse_texture",type:13,value:null},{name:"specularColor",type:8,value:[0,0,0]},{name:"specular_texture",type:13,value:null},{name:"emissiveColor",type:8,value:[0,0,0]},{name:"emissive_texture",type:13,value:null},{name:"glossiness",type:4,value:10},{name:"normal_texture",type:13,value:null},{name:"alphaTestThreshold",type:4,value:0}],passes:[{program:"phong",cullMode:1029,depthTest:true,depthWrite:false,blend:true,blendEq:32774,blendSrc:770,blendDst:771,blendAlphaEq:32774,blendSrcAlpha:1,blendDstAlpha:771}],layer:0},{stages:["shadowcast"],params:[],passes:[{program:"shadow-depth",cullMode:1029,depthTest:true,depthWrite:true}],layer:0}],properties:{},defines:[{name:"USE_NORMAL_TEXTURE",value:false},{name:"USE_DIFFUSE_TEXTURE",value:false},{name:"USE_SPECULAR",value:false},{name:"USE_SPECULAR_TEXTURE",value:false},{name:"USE_EMISSIVE",value:false},{name:"USE_EMISSIVE_TEXTURE",value:false},{name:"USE_ALPHA_TEST",value:false},{name:"USE_SKINNING",value:false},{name:"USE_SHADOW_MAP",value:false},{name:"NUM_DIR_LIGHTS",value:0},{name:"NUM_POINT_LIGHTS",value:0},{name:"NUM_SPOT_LIGHTS",value:0},{name:"NUM_SHADOW_LIGHTS",value:0}],dependencies:[{define:"USE_NORMAL_TEXTURE",extension:"OES_standard_derivatives"}]},{name:"phong",techniques:[{stages:["opaque"],params:[{name:"diffuseColor",type:9,value:[.8,.8,.8,1]},{name:"mainTiling",type:5,value:[1,1]},{name:"mainOffset",type:5,value:[0,0]},{name:"diffuse_texture",type:13,value:null},{name:"specularColor",type:8,value:[0,0,0]},{name:"specular_texture",type:13,value:null},{name:"emissiveColor",type:8,value:[0,0,0]},{name:"emissive_texture",type:13,value:null},{name:"glossiness",type:4,value:10},{name:"normal_texture",type:13,value:null},{name:"alphaTestThreshold",type:4,value:0}],passes:[{program:"phong",cullMode:1029,depthTest:true,depthWrite:true}],layer:0},{stages:["shadowcast"],params:[],passes:[{program:"shadow-depth",cullMode:1029,depthTest:true,depthWrite:true}],layer:0}],properties:{},defines:[{name:"USE_NORMAL_TEXTURE",value:false},{name:"USE_DIFFUSE_TEXTURE",value:false},{name:"USE_SPECULAR",value:false},{name:"USE_SPECULAR_TEXTURE",value:false},{name:"USE_EMISSIVE",value:false},{name:"USE_EMISSIVE_TEXTURE",value:false},{name:"USE_ALPHA_TEST",value:false},{name:"USE_SKINNING",value:false},{name:"USE_SHADOW_MAP",value:false},{name:"NUM_DIR_LIGHTS",value:0},{name:"NUM_POINT_LIGHTS",value:0},{name:"NUM_SPOT_LIGHTS",value:0},{name:"NUM_SHADOW_LIGHTS",value:0}],dependencies:[{define:"USE_NORMAL_TEXTURE",extension:"OES_standard_derivatives"}]},{name:"simple",techniques:[{stages:["opaque"],params:[{name:"color",type:9,value:[.4,.4,.4,1]}],passes:[{program:"simple",depthTest:true,depthWrite:true}],layer:0}],properties:{},defines:[{name:"USE_TEXTURE",value:false},{name:"USE_COLOR",value:false}],dependencies:undefined},{name:"skybox",techniques:[{stages:["opaque"],params:[{name:"cubeMap",type:14,value:null}],passes:[{program:"skybox",cullMode:0}],layer:-1}],properties:{},defines:[{name:"USE_RGBE_HDR",value:false}],dependencies:undefined},{name:"sprite",techniques:[{stages:["ui"],params:[{name:"mainTexture",type:13,value:null}],passes:[{program:"sprite",depthTest:true,depthWrite:false,blend:true,blendEq:32774,blendSrc:770,blendDst:771,blendAlphaEq:32774,blendSrcAlpha:1,blendDstAlpha:771}],layer:0}],properties:{},defines:[],dependencies:undefined},{name:"unlit-transparent",techniques:[{stages:["transparent"],params:[{name:"color",type:9,value:[1,1,1,1]},{name:"mainTiling",type:5,value:[1,1]},{name:"mainOffset",type:5,value:[0,0]},{name:"mainTexture",type:13,value:null}],passes:[{program:"unlit",cullMode:1029,depthTest:true,depthWrite:true,blend:true,blendEq:32774,blendSrc:770,blendDst:771,blendAlphaEq:32774,blendSrcAlpha:1,blendDstAlpha:771}],layer:0}],properties:{},defines:[{name:"USE_TEXTURE",value:false},{name:"USE_COLOR",value:false},{name:"USE_SKINNING",value:false}],dependencies:undefined},{name:"unlit",techniques:[{stages:["opaque"],params:[{name:"color",type:9,value:[1,1,1,1]},{name:"mainTiling",type:5,value:[1,1]},{name:"mainOffset",type:5,value:[0,0]},{name:"mainTexture",type:13,value:null}],passes:[{program:"unlit",cullMode:1029,depthTest:true,depthWrite:true}],layer:0}],properties:{},defines:[{name:"USE_TEXTURE",value:false},{name:"USE_COLOR",value:false},{name:"USE_SKINNING",value:false}],dependencies:undefined},{name:"wireframe",techniques:[{stages:["opaque"],params:[{name:"color",type:8,value:[1,1,1]}],passes:[{program:"wireframe",depthTest:true,depthWrite:true}],layer:0}],properties:{},defines:[],dependencies:undefined}];function Ls(e){var t;var n=document.createElement("canvas");var r=n.getContext("2d");n.width=n.height=128;r.fillStyle="#ddd";r.fillRect(0,0,128,128);r.fillStyle="#555";r.fillRect(0,0,64,64);r.fillStyle="#555";r.fillRect(64,64,64,64);var i=new ja(e);i.mipmap=true;i.wrapS="repeat";i.wrapT="repeat";i.setImage(0,n);i.commit();i._uuid="default-texture";i._loaded=true;var a=new bs(e);a.setImages([[n,n,n,n,n,n]]);a.commit();a._uuid="default-texture-cube";a._loaded=true;n.width=n.height=2;r.fillStyle="#000";r.fillRect(0,0,2,2);var o=new ja(e);o.mipmap=false;o.wrapS="repeat";o.wrapT="repeat";o.minFilter="nearest";o.magFilter="nearest";o.setImage(0,n);o.commit();o._uuid="black-texture";o._loaded=true;n.width=n.height=2;r.fillStyle="#fff";r.fillRect(0,0,2,2);var s=new ja(e);s.mipmap=false;s.wrapS="repeat";s.wrapT="repeat";s.minFilter="nearest";s.magFilter="nearest";s.setImage(0,n);s.commit();s._uuid="white-texture";s._loaded=true;var l=new Ms;l._texture=s;l.width=s.width;l.height=s.height;l.commit();l._uuid="default-sprite";l._loaded=true;var u=new Fa;u._subMeshes=new Array(1);var h=Do(1,1,1,{widthSegments:1,heightSegments:1,lengthSegments:1});u._subMeshes[0]=Ni.createIA(e,h);u._uuid="builtin-cube";u._loaded=true;u._minPos=Lt.clone(h.minPos);u._maxPos=Lt.clone(h.maxPos);var c=new Fa;c._subMeshes=new Array(1);var f=ns(.5,{segments:64});c._subMeshes[0]=Ni.createIA(e,f);c._uuid="builtin-sphere";c._loaded=true;c._minPos=Lt.clone(f.minPos);c._maxPos=Lt.clone(f.maxPos);var p=new Fa;p._subMeshes=new Array(1);var d=No(.5,.5,2,{radialSegments:20,capped:true});p._subMeshes[0]=Ni.createIA(e,d);p._uuid="builtin-cylinder";p._loaded=true;p._minPos=Lt.clone(d.minPos);p._maxPos=Lt.clone(d.maxPos);var v=new Fa;v._subMeshes=new Array(1);var m=Yo(10,10,{uSegments:10,vSegments:10});v._subMeshes[0]=Ni.createIA(e,m);v._uuid="builtin-plane";v._loaded=true;v._minPos=Lt.clone(m.minPos);v._maxPos=Lt.clone(m.maxPos);var _=new Fa;_._subMeshes=new Array(1);var g=os(.5,.5,2,{heightSegments:30,sides:20});_._subMeshes[0]=Ni.createIA(e,g);_._uuid="builtin-capsule";_._loaded=true;_._minPos=Lt.clone(g.minPos);_._maxPos=Lt.clone(g.maxPos);var y={};for(var x=0;x<Rs.length;++x){var b=Rs[x];var w=new ws;w._name=b.name;w._uuid="builtin-effect-"+b.name;w._loaded=true;w.techniques=b.techniques;w.properties=b.properties;w.defines=b.defines;w.dependencies=b.dependencies?b.dependencies:[];y[w._uuid]=w}var E={};["sprite","font"].forEach(function(e){var t=new gs;t.effect=y["builtin-effect-"+e];t._uuid="builtin-material-"+e;t._loaded=true;E[t._uuid]=t});return Object.assign((t={},t[i._uuid]=i,t[a._uuid]=a,t[o._uuid]=o,t[s._uuid]=s,t[l._uuid]=l,t[u._uuid]=u,t[c._uuid]=c,t[p._uuid]=p,t[v._uuid]=v,t[_._uuid]=_,t),y,E)}var Cs={int:{default:0,parse:function e(t,n,r){var i=n;if(typeof n==="string"){i=parseInt(n)}if(r.min!==undefined){i=Math.max(r.min,i)}if(r.max!==undefined){i=Math.min(r.max,i)}return i}},number:{default:0,parse:function e(t,n,r){var i=n;if(typeof n==="string"){i=parseFloat(n)}if(r.min!==undefined){i=Math.max(r.min,i)}if(r.max!==undefined){i=Math.min(r.max,i)}return i}},string:{default:"",parse:function e(t,n){return n}},boolean:{default:true,parse:function e(t,n){return!!n}},object:{default:null,parse:function e(t,n){return n}},enums:{default:"",parse:function e(t,n,r){if(r.options.indexOf(n)===-1){console.log("Invalid option: "+n);if(r.default!==undefined){return r.default}return""}return n}},color3:{default:[1,1,1],parse:function e(t,n){if(Array.isArray(n)){return Dt.new(n[0],n[1],n[2])}return n}},color4:{default:[1,1,1,1],parse:function e(t,n){if(Array.isArray(n)){return Ft.new(n[0],n[1],n[2],n[3])}return n}},vec2:{default:[0,0],parse:function e(t,n){if(Array.isArray(n)){return Rt.new(n[0],n[1])}return n}},vec3:{default:[0,0,0],parse:function e(t,n){if(Array.isArray(n)){return Lt.new(n[0],n[1],n[2])}return n}},vec4:{default:[0,0,0,0],parse:function e(t,n){if(Array.isArray(n)){return Ct.new(n[0],n[1],n[2],n[3])}return n}},quat:{default:[0,0,0,1],parse:function e(t,n){if(Array.isArray(n)){return It.new(n[0],n[1],n[2],n[3])}return n}},mat3:{default:[1,0,0,0,1,0,0,0,1],parse:function e(t,n){if(Array.isArray(n)){return Ot.new(n[0],n[1],n[2],n[3],n[4],n[5],n[6],n[7],n[8])}return n}},mat4:{default:[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],parse:function e(t,n){if(Array.isArray(n)){return Bt.new(n[0],n[1],n[2],n[3],n[4],n[5],n[6],n[7],n[8],n[9],n[10],n[11],n[12],n[13],n[14],n[15])}return n}},asset:{default:null,parse:function e(t,n){if(typeof n==="string"){return t.assets.get(n)}return n}},rect:{default:[0,0,1,1],parse:function e(t,n){if(Array.isArray(n)){return n}return[n.x,n.y,n.w,n.h]}},entity:{default:null,parse:function e(t,n,r,i){if(typeof n==="string"){var a=n.match(/e(\d+)/);if(a){var o=parseInt(a[1]);return i[o]}}return n}},component:{default:null,parse:function e(t,n,r,i){if(typeof n==="string"){var a=n.match(/e(\d+)c(\d+)/);if(a){var o=parseInt(a[0]);var s=parseInt(a[1]);var l=i[o];var u=l._comps[s];return u}}return n}}};function Os(e,t){var n=0;var r=e.length-1;var i;while(n<=r){i=n+r>>1;var a=e[i];if(a<t){n=i+1}else if(a>t){r=i-1}else{return i}}return n}var Is=function(e){function t(){e.call(this);this._framesList=null;this._length=0}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;var n={length:{configurable:true}};n.length.get=function(){return this._length};t.prototype.sample=function e(t,n){var r=this;He(n,0,this._length);for(var i=0;i<this._framesList.length;++i){var a=r._framesList[i];if(a.times.length===1){for(var o=0;o<a.joints.length;++o){var s=a.joints[o];var l=t._joints[s.id];if(s.translations){Lt.copy(l.lpos,s.translations[0])}if(s.rotations){It.copy(l.lrot,s.rotations[0])}if(s.scales){Lt.copy(l.lscale,s.scales[0])}}}else{var u=Os(a.times,n);if(u===0){for(var h=0;h<a.joints.length;++h){var c=a.joints[h];var f=t._joints[c.id];if(c.translations){Lt.copy(f.lpos,c.translations[0])}if(c.rotations){It.copy(f.lrot,c.rotations[0])}if(c.scales){Lt.copy(f.lscale,c.scales[0])}}return}var p=Math.max(u-1,0);var d=Math.min(u,a.times.length);var v=(n-a.times[p])/(a.times[d]-a.times[p]);for(var m=0;m<a.joints.length;++m){var _=a.joints[m];var g=t._joints[_.id];if(_.translations){var y=_.translations[p];var x=_.translations[d];Lt.lerp(g.lpos,y,x,v)}if(_.rotations){var b=_.rotations[p];var w=_.rotations[d];It.slerp(g.lrot,b,w,v)}if(_.scales){var E=_.scales[p];var T=_.scales[d];Lt.lerp(g.lscale,E,T,v)}}}}t.updateMatrices()};Object.defineProperties(t.prototype,n);return t}(Ba);var Us=function e(){this._root=null;this._joints=null;this._matrices=null};Us.prototype.setRoot=function e(t){var n=this;this._root=t;this._joints=kr.flat(this._root);this._matrices=new Array(this._joints.length);for(var r=0;r<this._joints.length;++r){n._matrices[r]=Bt.create()}this.updateMatrices()};Us.prototype.blend=function e(t,n,r){var i=this;for(var a=0;a<this._joints.length;++a){var o=i._joints[a];var s=t._joints[a];var l=n._joints[a];Lt.lerp(o.lpos,s.lpos,l.lpos,r);Lt.lerp(o.lscale,s.lscale,l.lscale,r);It.slerp(o.lrot,s.lrot,l.lrot,r)}};Us.prototype.updateMatrices=function e(){var t=this;for(var n=0;n<this._joints.length;++n){t._joints[n].getWorldMatrix(t._matrices[n])}};Us.prototype.getWorldMatrix=function e(t){return this._matrices[t]};Us.prototype.clone=function e(){var t=new Us;t.setRoot(kr.deepClone(this._root));return t};var Ps=function(e){function t(){e.call(this);this._nodes=null}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.instantiate=function e(){var t=Hs.createNodes(this._nodes);var n=new Us;n.setRoot(t[0]);return n};return t}(Ba);var Bs={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16};var Ds={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5124:Int32Array,5125:Uint32Array,5126:Float32Array};function Fs(e,t,n){var r=e.accessors[n];var i=e.bufferViews[r.bufferView];var a=Bs[r.type];var o=Ds[r.componentType];var s=new o(t,i.byteOffset+r.byteOffset,r.count*a);return s}function zs(e){var t=new Array(e.length);for(var n=0;n<e.length;++n){var r=e[n];var i=new Cr(r.name);if(r.translation){Lt.set(i.lpos,r.translation[0],r.translation[1],r.translation[2])}if(r.rotation){It.set(i.lrot,r.rotation[0],r.rotation[1],r.rotation[2],r.rotation[3])}if(r.scale){Lt.set(i.lscale,r.scale[0],r.scale[1],r.scale[2])}t[n]=i}for(var a=0;a<e.length;++a){var o=e[a];var s=t[a];if(o.children){for(var l=0;l<o.children.length;++l){var u=o.children[l];s.append(t[u])}}}return t}function Ns(e,t){var n=new Array(t.length);for(var r=0;r<t.length;++r){var i=t[r];var a=e.createEntity(i.name);if(i.translation){Lt.set(a.lpos,i.translation[0],i.translation[1],i.translation[2])}if(i.rotation){It.set(a.lrot,i.rotation[0],i.rotation[1],i.rotation[2],i.rotation[3])}if(i.scale){Lt.set(a.lscale,i.scale[0],i.scale[1],i.scale[2])}n[r]=a}for(var o=0;o<t.length;++o){var s=t[o];var l=n[o];if(s.children){for(var u=0;u<s.children.length;++u){var h=s.children[u];l.append(n[h])}}}return n}function ks(e,t,n,r){if(r>=t.meshes.length){return null}var i=t.meshes[r];var a=t.accessors;var o=i.primitives[0].attributes;var s=null;var l=new Fa;l._name=i.name;l._subMeshes=new Array(i.primitives.length);var u=[];var h=0;if(o.POSITION!==undefined){var c=a[o.POSITION];u.push({name:Ae.ATTR_POSITION,type:c.componentType,num:Bs[c.type]});h=c.count;s=t.bufferViews[c.bufferView];l._minPos=Lt.new(c.min[0],c.min[1],c.min[2]);l._maxPos=Lt.new(c.max[0],c.max[1],c.max[2])}if(o.NORMAL!==undefined){var f=a[o.NORMAL];u.push({name:Ae.ATTR_NORMAL,type:f.componentType,num:Bs[f.type]})}if(o.TANGENT!==undefined){var p=a[o.TANGENT];u.push({name:Ae.ATTR_TANGENT,type:p.componentType,num:Bs[p.type]})}if(o.COLOR_0!==undefined){var d=a[o.COLOR_0];u.push({name:Ae.ATTR_COLOR0,type:d.componentType,num:Bs[d.type]})}if(o.TEXCOORD_0!==undefined){var v=a[o.TEXCOORD_0];u.push({name:Ae.ATTR_UV0,type:v.componentType,num:Bs[v.type]})}if(o.TEXCOORD_1!==undefined){var m=a[o.TEXCOORD_1];u.push({name:Ae.ATTR_UV1,type:m.componentType,num:Bs[m.type]})}if(o.TEXCOORD_2!==undefined){var _=a[o.TEXCOORD_2];u.push({name:Ae.ATTR_UV2,type:_.componentType,num:Bs[_.type]})}if(o.TEXCOORD_3!==undefined){var g=a[o.TEXCOORD_3];u.push({name:Ae.ATTR_UV3,type:g.componentType,num:Bs[g.type]})}if(o.JOINTS_0!==undefined){var y=a[o.JOINTS_0];u.push({name:Ae.ATTR_JOINTS,type:y.componentType,num:Bs[y.type]})}if(o.WEIGHTS_0!==undefined){var x=a[o.WEIGHTS_0];u.push({name:Ae.ATTR_WEIGHTS,type:x.componentType,num:Bs[x.type]})}var b=new Uint8Array(n,s.byteOffset,s.byteLength);var w=new Ae.VertexBuffer(e.device,new Ae.VertexFormat(u),Ae.USAGE_STATIC,b,h);for(var E=0;E<i.primitives.length;++E){var T=i.primitives[E];var S=null;if(T.indices!==undefined){var A=a[T.indices];var M=t.bufferViews[A.bufferView];var R=new Uint8Array(n,M.byteOffset,M.byteLength);S=new Ae.IndexBuffer(e.device,A.componentType,Ae.USAGE_STATIC,R,A.count)}l._subMeshes[E]=new Ni.InputAssembler(w,S)}if(t.skins){for(var L=0;L<t.skins.length;++L){if(t.skins[L].name===i.name){l._skinning=Vs(t,n,L)}}}return l}function Vs(e,t,n){if(n>=e.skins.length){return null}var r=e.skins[n];var i=e.accessors[r.inverseBindMatrices];var a=e.bufferViews[i.bufferView];var o=new Float32Array(t,a.byteOffset+i.byteOffset,i.count*16);var s=new Array(i.count);for(var l=0;l<i.count;++l){s[l]=Bt.new(o[16*l+0],o[16*l+1],o[16*l+2],o[16*l+3],o[16*l+4],o[16*l+5],o[16*l+6],o[16*l+7],o[16*l+8],o[16*l+9],o[16*l+10],o[16*l+11],o[16*l+12],o[16*l+13],o[16*l+14],o[16*l+15])}return{jointIndices:r.joints,bindposes:s}}function Ws(e,t,n){if(n>=e.animations.length){return null}var r=e.animations[n];var i=[];var a=-1;for(var o=0;o<r.channels.length;++o){var s=r.channels[o];var l=e.accessors[s.input];var u=void 0;for(var h=0;h<i.length;++h){if(i[h].name===l.name){u=i[h];break}}if(!u){var c=Fs(e,t,s.input);var f=new Array(c.length);for(var p=0;p<c.length;++p){var d=c[p];f[p]=d;if(a<d){a=d}}u={name:l.name,times:f,joints:[]};i.push(u)}var v=void 0;for(var m=0;m<u.joints.length;++m){if(u.joints[m].id===s.node){v=u.joints[m];break}}if(!v){v={id:s.node};u.joints.push(v)}var _=Fs(e,t,s.output);if(s.path==="translation"){var g=_.length/3;v.translations=new Array(g);for(var y=0;y<g;++y){v.translations[y]=Lt.new(_[3*y+0],_[3*y+1],_[3*y+2])}}else if(s.path==="rotation"){var x=_.length/4;v.rotations=new Array(x);for(var b=0;b<x;++b){v.rotations[b]=It.new(_[4*b+0],_[4*b+1],_[4*b+2],_[4*b+3])}}else if(s.path==="scale"){var w=_.length/3;v.scales=new Array(w);for(var E=0;E<w;++E){v.scales[E]=Lt.new(_[3*E+0],_[3*E+1],_[3*E+2])}}}var T=new Is;T._name=r.name;T._framesList=i;T._length=a;return T}function Gs(e){var t=new Ps;t._name=e.joints[0].name;t._nodes=e.joints;return t}var Hs={createArray:Fs,createNodes:zs,createEntities:Ns,createMesh:ks,createSkinning:Vs,createAnimationClip:Ws,createJoints:Gs};function js(a,e,o){Ua({manifest:{mesh:{type:"text",parser:JSON.parse,src:e.mesh},bin:{type:"binary",src:e.bin}},onDone:function e(t){var n=t.mesh;var r=t.bin;if(!n.meshes.length){o(new Error("No mesh in the gltf."));return}var i=Hs.createMesh(a,n,r,0);o(null,i)}})}function qs(c,e,f){Ua({manifest:{json:{type:"text",parser:JSON.parse,src:e.json}},onDone:function e(t){var n=t.json;var r=new gs;var i=n.properties;if(n.type==="unlit"){r.effect=c.assets.get("builtin-effect-unlit");if(i.color){r.setProperty("color",Ft.new(i.color[0],i.color[1],i.color[2],i.color[3]))}if(i.mainTiling){r.setProperty("mainTiling",Rt.new(i.mainTiling[0],i.mainTiling[1]))}if(i.mainOffset){r.setProperty("mainOffset",Rt.new(i.mainOffset[0],i.mainOffset[1]))}var a=[];if(i.mainTexture){a.push(function(n){c.assets.load(i.mainTexture,function(e,t){r.setProperty("mainTexture",t);r.define("USE_TEXTURE",true);n()})})}Xa.parallel(a,function(e){if(e){console.error(e)}f(null,r)})}else if(n.type==="phong"){r.effect=c.assets.get("builtin-effect-phong");if(i.diffuseColor){r.setProperty("diffuseColor",Ft.new(i.diffuseColor[0],i.diffuseColor[1],i.diffuseColor[2],i.diffuseColor[3]))}if(i.mainTiling){r.setProperty("mainTiling",Rt.new(i.mainTiling[0],i.mainTiling[1]))}if(i.mainOffset){r.setProperty("mainOffset",Rt.new(i.mainOffset[0],i.mainOffset[1]))}r.define("USE_SPECULAR",i.USE_SPECULAR);if(i.specularColor){r.setProperty("specularColor",Ft.new(i.specularColor[0],i.specularColor[1],i.specularColor[2],i.specularColor[3]))}r.define("USE_EMISSIVE",i.USE_EMISSIVE);if(i.emissiveColor){r.setProperty("emissiveColor",Dt.new(i.emissiveColor[0],i.emissiveColor[1],i.emissiveColor[2]))}if(i.glossiness){r.setProperty("glossiness",i.glossiness)}var o=[];r.define("USE_DIFFUSE_TEXTURE",i.USE_DIFFUSE_TEXTURE);if(i.diffuse_texture){o.push(function(n){c.assets.load(i.diffuse_texture,function(e,t){r.setProperty("diffuse_texture",t);n()})})}r.define("USE_SPECULAR_TEXTURE",i.USE_SPECULAR_TEXTURE);if(i.specular_texture){o.push(function(n){c.assets.load(i.specular_texture,function(e,t){r.setProperty("specular_texture",t);n()})})}r.define("USE_EMISSIVE_TEXTURE",i.USE_EMISSIVE_TEXTURE);if(i.emissive_texture){o.push(function(n){c.assets.load(i.emissive_texture,function(e,t){r.setProperty("emissive_texture",t);n()})})}r.define("USE_NORMAL_TEXTURE",i.USE_NORMAL_TEXTURE);if(i.normal_texture){o.push(function(n){c.assets.load(i.normal_texture,function(e,t){r.setProperty("normal_texture",t);n()})})}Xa.parallel(o,function(e){if(e){console.error(e)}f(null,r)})}else if(n.type==="grid"){r.effect=c.assets.get("builtin-effect-grid");r.define("USE_WORLD_POS",i.useWorldPos);r.setProperty("tiling",Rt.new(i.tilingX,i.tilingY));r.setProperty("baseColorBlack",Ft.new(i.baseColorBlack[0],i.baseColorBlack[1],i.baseColorBlack[2],i.baseColorBlack[3]));r.setProperty("baseColorWhite",Ft.new(i.baseColorWhite[0],i.baseColorWhite[1],i.baseColorWhite[2],i.baseColorWhite[3]));r.setProperty("subPatternColor",Ft.new(i.subPatternColor[0],i.subPatternColor[1],i.subPatternColor[2],i.subPatternColor[3]));r.setProperty("subPatternColor2",Ft.new(i.subPatternColor2[0],i.subPatternColor2[1],i.subPatternColor2[2],i.subPatternColor2[3]));r.setProperty("basePatternTiling",Rt.new(i.basePatternTiling[0],i.basePatternTiling[1]));r.setProperty("basePatternOffset",Rt.new(i.basePatternOffset[0],i.basePatternOffset[1]));r.setProperty("subPatternTiling",Rt.new(i.subPatternTiling[0],i.subPatternTiling[1]));r.setProperty("subPatternOffset",Rt.new(i.subPatternOffset[0],i.subPatternOffset[1]));r.setProperty("subPattern2Tiling",Rt.new(i.subPattern2Tiling[0],i.subPattern2Tiling[1]));r.setProperty("subPattern2Offset",Rt.new(i.subPattern2Offset[0],i.subPattern2Offset[1]));c.assets.load("black-texture",function(e,t){r.setProperty("basePattern",t);r.setProperty("subPattern",t);r.setProperty("subPattern2",t)});var s=[];if(i.basePattern){s.push(function(n){c.assets.load(i.basePattern,function(e,t){r.setProperty("basePattern",t);n()})})}if(i.subPattern){s.push(function(n){c.assets.load(i.subPattern,function(e,t){r.setProperty("subPattern",t);n()})})}if(i.subPattern2){s.push(function(n){c.assets.load(i.subPattern2,function(e,t){r.setProperty("subPattern2",t);n()})})}Xa.parallel(s,function(e){if(e){console.error(e)}f(null,r)})}else if(n.type==="matcap"){r.effect=c.assets.get("builtin-effect-matcap");if(i.colorFactor){r.setProperty("colorFactor",i.colorFactor)}if(i.color){r.setProperty("color",Ft.new(i.color[0],i.color[1],i.color[2],i.color[3]))}var l=[];if(i.mainTex){l.push(function(n){c.assets.load(i.mainTex,function(e,t){r.setProperty("mainTex",t);r.define("USE_MAIN_TEX",true);n()})})}if(i.matcapTex){l.push(function(n){c.assets.load(i.matcapTex,function(e,t){r.setProperty("matcapTex",t);n()})})}Xa.parallel(l,function(e){if(e){console.error(e)}f(null,r)})}else if(n.type==="pbr"){r.effect=c.assets.get("builtin-effect-pbr");r.setProperty("albedo",Ft.new(i.albedo[0],i.albedo[1],i.albedo[2],i.albedo[3]));if(i.mainTiling){r.setProperty("mainTiling",Rt.new(i.mainTiling[0],i.mainTiling[1]))}if(i.mainOffset){r.setProperty("mainOffset",Rt.new(i.mainOffset[0],i.mainOffset[1]))}if(i.metallic){r.setProperty("metallic",i.metallic)}if(i.roughness){r.setProperty("roughness",i.roughness)}if(i.ao){r.setProperty("ao",i.ao)}r.define("USE_EMISSIVE",i.USE_EMISSIVE);if(i.emissive){r.setProperty("emissive",Dt.new(i.emissive[0],i.emissive[1],i.emissive[2]))}var u=[];r.define("USE_ALBEDO_TEXTURE",i.USE_ALBEDO_TEXTURE);if(i.albedo_texture){u.push(function(n){c.assets.load(i.albedo_texture,function(e,t){r.setProperty("albedo_texture",t);n()})})}r.define("USE_METALLIC_TEXTURE",i.USE_METALLIC_TEXTURE);if(i.metallic_texture){u.push(function(n){c.assets.load(i.metallic_texture,function(e,t){r.setProperty("metallic_texture",t);n()})})}r.define("USE_ROUGHNESS_TEXTURE",i.USE_ROUGHNESS_TEXTURE);if(i.roughness_texture){u.push(function(n){c.assets.load(i.roughness_texture,function(e,t){r.setProperty("roughness_texture",t);n()})})}r.define("USE_NORMAL_TEXTURE",i.USE_NORMAL_TEXTURE);if(i.normal_texture){u.push(function(n){c.assets.load(i.normal_texture,function(e,t){r.setProperty("normal_texture",t);n()})})}r.define("USE_AO_TEXTURE",i.USE_AO_TEXTURE);if(i.ao_texture){u.push(function(n){c.assets.load(i.ao_texture,function(e,t){r.setProperty("ao_texture",t);n()})})}r.define("USE_EMISSIVE_TEXTURE",i.USE_EMISSIVE_TEXTURE);if(i.emissive_texture){u.push(function(n){c.assets.load(i.emissive_texture,function(e,t){r.setProperty("emissive_texture",t);n()})})}Xa.parallel(u,function(e){if(e){console.error(e)}f(null,r)})}else if(n.type.startsWith("particle")){r.effect=c.assets.get("builtin-effect-"+n.type);if(i.tintColor){r.setProperty("tintColor",Ft.new(i.tintColor[0],i.tintColor[1],i.tintColor[2],i.tintColor[3]))}if(i.mainTiling){r.setProperty("mainTiling",Rt.new(i.mainTiling[0],i.mainTiling[1]))}if(i.mainOffset){r.setProperty("mainOffset",Rt.new(i.mainOffset[0],i.mainOffset[1]))}var h=[];if(i.mainTexture){h.push(function(n){c.assets.load(i.mainTexture,function(e,t){r.setProperty("mainTexture",t);n()})})}Xa.parallel(h,function(e){if(e){console.error(e)}f(null,r)})}else{console.error("unsupported material loading")}}})}var Xs=function(r){function e(e){r.call(this,e);this._sprites={}}if(r)e.__proto__=r;e.prototype=Object.create(r&&r.prototype);e.prototype.constructor=e;var t={sprites:{configurable:true}};t.sprites.get=function(){return this._sprites};e.prototype.unload=function e(){var t=this;if(!this._loaded){return}for(var n in t._sprites){t._sprites[n].unload()}r.prototype.unload.call(this)};e.prototype.subAsset=function e(t){var n=this._sprites[t];return n||null};Object.defineProperties(e.prototype,t);return e}(ja);function Ys(e,t,n){var r=new ja(e);if(n){r.mipmap=n.mipmap;r.anisotropy=n.anisotropy;r.minFilter=n.minFilter;r.magFilter=n.magFilter;r.mipFilter=n.mipFilter;r.wrapS=n.wrapS;r.wrapT=n.wrapT}r.setImages(t);r.commit();return r}function Ks(e,t,n){var r=new bs(e);if(n){r.mipmap=n.mipmap;r.anisotropy=n.anisotropy;r.minFilter=n.minFilter;r.magFilter=n.magFilter;r.mipFilter=n.mipFilter;r.wrapS=n.wrapS;r.wrapT=n.wrapT}r.setImages(t);r.commit();return r}function Zs(e,t,n){var r=new Xs(e);if(n){r.mipmap=n.mipmap;r.anisotropy=n.anisotropy;r.minFilter=n.minFilter;r.magFilter=n.magFilter;r.mipFilter=n.mipFilter;r.wrapS=n.wrapS;r.wrapT=n.wrapT}r.setImages(t);r.commit();if(n&&n.sprites){for(var i in n.sprites){var a=n.sprites[i];var o=new Ms;o._name=i;o._rotated=a.rotated;o._x=a.x;o._y=a.y;o._width=a.width;o._height=a.height;o._left=a.left||0;o._right=a.right||0;o._top=a.top||0;o._bottom=a.bottom||0;o._texture=r;o.commit();r._sprites[i]=o}}return r}function Qs(l,e,u){var t={};var h=0;for(var n in e){if(n.indexOf("image")===0){var r=parseInt(n.split("@")[1]);if(r>h){h=r}t[n]={type:"image",src:e[n]}}}h+=1;if(e.json){t.json={type:"text",parser:JSON.parse,src:e.json}}Ua({manifest:t,onDone:function e(t){var n=t.json;var r=[];var i;var a=n?n.type:"2d";if(a==="2d"||a==="sprite"){for(var o=0;o<h;++o){if(o===0){r.push(t.image)}else{r.push(t["image@"+o])}}if(a==="2d"){i=Ys(l.device,r,n)}else if(a==="sprite"){i=Zs(l.device,r,n)}}else if(a==="cube"){for(var s=0;s<h;++s){if(s===0){r.push([t.imagePosX,t.imageNegX,t.imagePosY,t.imageNegY,t.imagePosZ,t.imageNegZ])}else{r.push([t["imagePosX@"+s],t["imageNegX@"+s],t["imagePosY@"+s],t["imageNegY@"+s],t["imagePosZ@"+s],t["imageNegZ@"+s]])}}i=Ks(l.device,r,n)}u(null,i)}})}var Js=function(t){function e(){t.call(this);this._app=null;this._json=null;this._assets=null}if(t)e.__proto__=t;e.prototype=Object.create(t&&t.prototype);e.prototype.constructor=e;e.prototype.unload=function e(){if(!this._loaded){return}t.prototype.unload.call(this)};e.prototype.instantiate=function e(t,n){if(n===void 0)n=null;return eo.createPrefab(this._app,this._json,t,n)};return e}(Ba);function $s(i,e,a){Ua({manifest:{json:{type:"text",parser:JSON.parse,src:e.json}},onDone:function e(r){eo.preloadAssets(i,r.json,function(e,t){var n=new Js;n._app=i;n._json=r.json;n._assets=t;if(e){a(e);return}a(null,n)})}})}var el=function(e){function t(){e.call(this);this._nodes=null;this._meshes=null;this._joints=null}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.subAsset=function e(t){var n=parseInt(t.substring(1));if(t[0]==="m"){return this._meshes[n]}if(t==="joints"){return this._joints}return null};return t}(Ba);function tl(o,e,s){Ua({manifest:{gltf:{type:"text",parser:JSON.parse,src:e.gltf},bin:{type:"binary",src:e.bin}},onDone:function e(t){var n=t.gltf;var r=t.bin;var i=new el;i._nodes=n.nodes;if(n.meshes){i._meshes=new Array(n.meshes.length);for(var a=0;a<n.meshes.length;++a){i._meshes[a]=Hs.createMesh(o,n,r,a)}}if(n.joints){i._joints=Hs.createJoints(n)}s(null,i)}})}function nl(e,t,a){Ua({manifest:{anim:{type:"text",parser:JSON.parse,src:t.anim},bin:{type:"binary",src:t.bin}},onDone:function e(t){var n=t.anim;var r=t.bin;if(!n.animations.length){a(new Error("No animation in the gltf."));return}var i=Hs.createAnimationClip(n,r,0);a(null,i)}})}var rl={WEB_AUDIO:0,DOM_AUDIO:1};var il=function(e){function t(){e.call(this);this.__initEventEmitter();this._audio=null;this.loadMode=rl.WEB_AUDIO}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;var n={nativeAsset:{configurable:true}};n.nativeAsset.get=function(){return this._audio};n.nativeAsset.set=function(e){this._audio=e;if(e){this._loaded=true}};Object.defineProperties(t.prototype,n);return t}(Ba);$i.mixin(il);Object.assign(il,rl);var al=null;function ol(e,t,n){al=e.system("audio");if(al.__audioSupport.format.length===0){return new Error("no audio file format available.")}var r=al.getIDByURL(t.bin);if(r){al._getClipByID(r).once("load",function(){n(null,al._getClipByID(r))});return}var i=null;if(!al.__audioSupport.WEB_AUDIO){i=sl}else{i=ll}t.url=t.bin;i(t,n)}function sl(t,n){var e=document.createElement("audio");e.src=t.url;var r=function(){clearTimeout(i);e.removeEventListener("canplaythrough",o,false);e.removeEventListener("error",s,false);if(al.__audioSupport.USE_LOADER_EVENT){e.removeEventListener(al.__audioSupport.USE_LOADER_EVENT,o,false)}};var i=setTimeout(function(){if(e.readyState===0){s()}else{o()}},8e3);var a=new il;a.url=t.url;al.addClip(t.url,a);var o=function(){r();a.nativeAsset=e;a.loadMode=il.DOM_AUDIO;a.emit("load");n(null,a)};var s=function(){r();var e="load audio failure - "+t.url;console.log(e);al.removeClip(t.url);n(e)};e.addEventListener("canplaythrough",o,false);e.addEventListener("error",s,false);if(al.__audioSupport.USE_LOADER_EVENT){e.addEventListener(al.__audioSupport.USE_LOADER_EVENT,o,false)}}function ll(e,t){if(!al.__audioSupport.context){t(new Error("audio context not found."))}var n=ul();n.open("GET",e.url,true);n.responseType="arraybuffer";var r=new il;r.url=e.url;al.addClip(e.url,r);n.onload=function(){al.__audioSupport.context["decodeAudioData"](n.response,function(e){r.nativeAsset=e;r.emit("load");t(null,r)},function(){al.removeClip(e.url);t("decode error",null)})};n.onerror=function(){al.removeClip(e.url);t("request error",null)};n.send()}function ul(){return window.XMLHttpRequest?new window.XMLHttpRequest:new window.ActiveXObject("MSXML2.XMLHTTP")}var hl=function(e){function t(){e.call(this);this._size=32;this._type="unknow";this._glyphs={};this._lineHeight=32;this._useKerning=false}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;var n={size:{configurable:true},lineHeight:{configurable:true},type:{configurable:true}};n.size.get=function(){return this._size};n.lineHeight.get=function(){return this._lineHeight};n.type.get=function(){return this._type};Object.defineProperties(t.prototype,n);return t}(Ba);var cl=function(e){function t(){e.call(this);this._texture=null;this._face="";this._defaultGlyph={char:" ",x:0,y:0,width:16,height:16,xoffset:0,yoffset:0,xadvance:16,uvs:[Rt.new(0,0),Rt.new(0,0),Rt.new(0,0),Rt.new(0,0)]};this._type="bitmap"}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;var n={texture:{configurable:true},face:{configurable:true}};n.texture.get=function(){return this._texture};n.face.get=function(){return this._face};Object.defineProperties(t.prototype,n);return t}(hl);function fl(n,e,f){Ua({manifest:{json:{type:"text",parser:JSON.parse,src:e.json}},onDone:function e(t){var h=t.json;var c=new cl;n.assets.load(h.texture,function(e,t){if(e){console.error(e);f(e,null);return}var n=t._texture._width;var r=t._texture._height;c._texture=t;c._face=h.face;c._size=h.size;c._lineHeight=h.lineHeight;for(var i in h.chars){var a=h.chars[i];var o=a.x/n;var s=(a.x+a.width)/n;var l=1-(a.y+a.height)/r;var u=1-a.y/r;c._glyphs[i]={char:String.fromCharCode(i),x:a.x,y:a.y,width:a.width,height:a.height,xoffset:a.xoffset,yoffset:a.yoffset,xadvance:a.xadvance};c._glyphs[i].uvs=[Rt.new(o,l),Rt.new(s,l),Rt.new(o,u),Rt.new(s,u)]}f(null,c)})}})}var pl=0;var dl=-3;function vl(){this.table=new Uint16Array(16);this.trans=new Uint16Array(288)}function ml(e,t){this.source=e;this.sourceIndex=0;this.tag=0;this.bitcount=0;this.dest=t;this.destLen=0;this.ltree=new vl;this.dtree=new vl}var _l=new vl;var gl=new vl;var yl=new Uint8Array(30);var xl=new Uint16Array(30);var bl=new Uint8Array(30);var wl=new Uint16Array(30);var El=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]);var Tl=new vl;var Sl=new Uint8Array(288+32);function Al(e,t,n,r){var i,a;for(i=0;i<n;++i){e[i]=0}for(i=0;i<30-n;++i){e[i+n]=i/n|0}for(a=r,i=0;i<30;++i){t[i]=a;a+=1<<e[i]}}function Ml(e,t){var n;for(n=0;n<7;++n){e.table[n]=0}e.table[7]=24;e.table[8]=152;e.table[9]=112;for(n=0;n<24;++n){e.trans[n]=256+n}for(n=0;n<144;++n){e.trans[24+n]=n}for(n=0;n<8;++n){e.trans[24+144+n]=280+n}for(n=0;n<112;++n){e.trans[24+144+8+n]=144+n}for(n=0;n<5;++n){t.table[n]=0}t.table[5]=32;for(n=0;n<32;++n){t.trans[n]=n}}var Rl=new Uint16Array(16);function Ll(e,t,n,r){var i,a;for(i=0;i<16;++i){e.table[i]=0}for(i=0;i<r;++i){e.table[t[n+i]]++}e.table[0]=0;for(a=0,i=0;i<16;++i){Rl[i]=a;a+=e.table[i]}for(i=0;i<r;++i){if(t[n+i]){e.trans[Rl[t[n+i]]++]=i}}}function Cl(e){if(!e.bitcount--){e.tag=e.source[e.sourceIndex++];e.bitcount=7}var t=e.tag&1;e.tag>>>=1;return t}function Ol(e,t,n){if(!t){return n}while(e.bitcount<24){e.tag|=e.source[e.sourceIndex++]<<e.bitcount;e.bitcount+=8}var r=e.tag&65535>>>16-t;e.tag>>>=t;e.bitcount-=t;return r+n}function Il(e,t){while(e.bitcount<24){e.tag|=e.source[e.sourceIndex++]<<e.bitcount;e.bitcount+=8}var n=0,r=0,i=0;var a=e.tag;do{r=2*r+(a&1);a>>>=1;++i;n+=t.table[i];r-=t.table[i]}while(r>=0);e.tag=a;e.bitcount-=i;return t.trans[n+r]}function Ul(e,t,n){var r,i,a;var o,s,l;r=Ol(e,5,257);i=Ol(e,5,1);a=Ol(e,4,4);for(o=0;o<19;++o){Sl[o]=0}for(o=0;o<a;++o){var u=Ol(e,3,0);Sl[El[o]]=u}Ll(Tl,Sl,0,19);for(s=0;s<r+i;){var h=Il(e,Tl);switch(h){case 16:var c=Sl[s-1];for(l=Ol(e,2,3);l;--l){Sl[s++]=c}break;case 17:for(l=Ol(e,3,3);l;--l){Sl[s++]=0}break;case 18:for(l=Ol(e,7,11);l;--l){Sl[s++]=0}break;default:Sl[s++]=h;break}}Ll(t,Sl,0,r);Ll(n,Sl,r,i)}function Pl(e,t,n){while(1){var r=Il(e,t);if(r===256){return pl}if(r<256){e.dest[e.destLen++]=r}else{var i,a,o;var s;r-=257;i=Ol(e,yl[r],xl[r]);a=Il(e,n);o=e.destLen-Ol(e,bl[a],wl[a]);for(s=o;s<o+i;++s){e.dest[e.destLen++]=e.dest[s]}}}}function Bl(e){var t,n;var r;while(e.bitcount>8){e.sourceIndex--;e.bitcount-=8}t=e.source[e.sourceIndex+1];t=256*t+e.source[e.sourceIndex];n=e.source[e.sourceIndex+3];n=256*n+e.source[e.sourceIndex+2];if(t!==(~n&65535)){return dl}e.sourceIndex+=4;for(r=t;r;--r){e.dest[e.destLen++]=e.source[e.sourceIndex++]}e.bitcount=0;return pl}function Dl(e,t){var n=new ml(e,t);var r,i,a;do{r=Cl(n);i=Ol(n,2,0);switch(i){case 0:a=Bl(n);break;case 1:a=Pl(n,_l,gl);break;case 2:Ul(n,n.ltree,n.dtree);a=Pl(n,n.ltree,n.dtree);break;default:a=dl}if(a!==pl){throw new Error("Data error")}}while(!r);if(n.destLen<n.dest.length){if(typeof n.dest.slice==="function"){return n.dest.slice(0,n.destLen)}else{return n.dest.subarray(0,n.destLen)}}return n.dest}Ml(_l,gl);Al(yl,xl,4,3);Al(bl,wl,2,1);yl[28]=0;xl[28]=258;var Fl=Dl;function zl(e,t,n,r,i){return Math.pow(1-i,3)*e+3*Math.pow(1-i,2)*i*t+3*(1-i)*Math.pow(i,2)*n+Math.pow(i,3)*r}function Nl(){this.x1=Number.NaN;this.y1=Number.NaN;this.x2=Number.NaN;this.y2=Number.NaN}Nl.prototype.isEmpty=function(){return isNaN(this.x1)||isNaN(this.y1)||isNaN(this.x2)||isNaN(this.y2)};Nl.prototype.addPoint=function(e,t){if(typeof e==="number"){if(isNaN(this.x1)||isNaN(this.x2)){this.x1=e;this.x2=e}if(e<this.x1){this.x1=e}if(e>this.x2){this.x2=e}}if(typeof t==="number"){if(isNaN(this.y1)||isNaN(this.y2)){this.y1=t;this.y2=t}if(t<this.y1){this.y1=t}if(t>this.y2){this.y2=t}}};Nl.prototype.addX=function(e){this.addPoint(e,null)};Nl.prototype.addY=function(e){this.addPoint(null,e)};Nl.prototype.addBezier=function(e,t,n,r,i,a,o,s){var l=this;var u=[e,t];var h=[n,r];var c=[i,a];var f=[o,s];this.addPoint(e,t);this.addPoint(o,s);for(var p=0;p<=1;p++){var d=6*u[p]-12*h[p]+6*c[p];var v=-3*u[p]+9*h[p]-9*c[p]+3*f[p];var m=3*h[p]-3*u[p];if(v===0){if(d===0){continue}var _=-m/d;if(0<_&&_<1){if(p===0){l.addX(zl(u[p],h[p],c[p],f[p],_))}if(p===1){l.addY(zl(u[p],h[p],c[p],f[p],_))}}continue}var g=Math.pow(d,2)-4*m*v;if(g<0){continue}var y=(-d+Math.sqrt(g))/(2*v);if(0<y&&y<1){if(p===0){l.addX(zl(u[p],h[p],c[p],f[p],y))}if(p===1){l.addY(zl(u[p],h[p],c[p],f[p],y))}}var x=(-d-Math.sqrt(g))/(2*v);if(0<x&&x<1){if(p===0){l.addX(zl(u[p],h[p],c[p],f[p],x))}if(p===1){l.addY(zl(u[p],h[p],c[p],f[p],x))}}}};Nl.prototype.addQuad=function(e,t,n,r,i,a){var o=e+2/3*(n-e);var s=t+2/3*(r-t);var l=o+1/3*(i-e);var u=s+1/3*(a-t);this.addBezier(e,t,o,s,l,u,i,a)};function kl(){this.commands=[];this.fill="black";this.stroke=null;this.strokeWidth=1}kl.prototype.moveTo=function(e,t){this.commands.push({type:"M",x:e,y:t})};kl.prototype.lineTo=function(e,t){this.commands.push({type:"L",x:e,y:t})};kl.prototype.curveTo=kl.prototype.bezierCurveTo=function(e,t,n,r,i,a){this.commands.push({type:"C",x1:e,y1:t,x2:n,y2:r,x:i,y:a})};kl.prototype.quadTo=kl.prototype.quadraticCurveTo=function(e,t,n,r){this.commands.push({type:"Q",x1:e,y1:t,x:n,y:r})};kl.prototype.close=kl.prototype.closePath=function(){this.commands.push({type:"Z"})};kl.prototype.extend=function(e){if(e.commands){e=e.commands}else if(e instanceof Nl){var t=e;this.moveTo(t.x1,t.y1);this.lineTo(t.x2,t.y1);this.lineTo(t.x2,t.y2);this.lineTo(t.x1,t.y2);this.close();return}Array.prototype.push.apply(this.commands,e)};kl.prototype.getBoundingBox=function(){var e=this;var t=new Nl;var n=0;var r=0;var i=0;var a=0;for(var o=0;o<this.commands.length;o++){var s=e.commands[o];switch(s.type){case"M":t.addPoint(s.x,s.y);n=i=s.x;r=a=s.y;break;case"L":t.addPoint(s.x,s.y);i=s.x;a=s.y;break;case"Q":t.addQuad(i,a,s.x1,s.y1,s.x,s.y);i=s.x;a=s.y;break;case"C":t.addBezier(i,a,s.x1,s.y1,s.x2,s.y2,s.x,s.y);i=s.x;a=s.y;break;case"Z":i=n;a=r;break;default:throw new Error("Unexpected path command "+s.type)}}if(t.isEmpty()){t.addPoint(0,0)}return t};kl.prototype.draw=function(e){var t=this;e.beginPath();for(var n=0;n<this.commands.length;n+=1){var r=t.commands[n];if(r.type==="M"){e.moveTo(r.x,r.y)}else if(r.type==="L"){e.lineTo(r.x,r.y)}else if(r.type==="C"){e.bezierCurveTo(r.x1,r.y1,r.x2,r.y2,r.x,r.y)}else if(r.type==="Q"){e.quadraticCurveTo(r.x1,r.y1,r.x,r.y)}else if(r.type==="Z"){e.closePath()}}if(this.fill){e.fillStyle=this.fill;e.fill()}if(this.stroke){e.strokeStyle=this.stroke;e.lineWidth=this.strokeWidth;e.stroke()}};kl.prototype.toPathData=function(t){var e=this;t=t!==undefined?t:2;function i(e){if(Math.round(e)===e){return""+Math.round(e)}else{return e.toFixed(t)}}function n(){var e=arguments;var t="";for(var n=0;n<arguments.length;n+=1){var r=e[n];if(r>=0&&n>0){t+=" "}t+=i(r)}return t}var r="";for(var a=0;a<this.commands.length;a+=1){var o=e.commands[a];if(o.type==="M"){r+="M"+n(o.x,o.y)}else if(o.type==="L"){r+="L"+n(o.x,o.y)}else if(o.type==="C"){r+="C"+n(o.x1,o.y1,o.x2,o.y2,o.x,o.y)}else if(o.type==="Q"){r+="Q"+n(o.x1,o.y1,o.x,o.y)}else if(o.type==="Z"){r+="Z"}}return r};kl.prototype.toSVG=function(e){var t='<path d="';t+=this.toPathData(e);t+='"';if(this.fill&&this.fill!=="black"){if(this.fill===null){t+=' fill="none"'}else{t+=' fill="'+this.fill+'"'}}if(this.stroke){t+=' stroke="'+this.stroke+'" stroke-width="'+this.strokeWidth+'"'}t+="/>";return t};kl.prototype.toDOMElement=function(e){var t=this.toPathData(e);var n=document.createElementNS("http://www.w3.org/2000/svg","path");n.setAttribute("d",t);return n};function Vl(e){throw new Error(e)}function Wl(e,t){if(!e){Vl(t)}}var Gl={fail:Vl,argument:Wl,assert:Wl};var Hl=32768;var jl=2147483648;var ql={};var Xl={};var Yl={};function Kl(e){return function(){return e}}Xl.BYTE=function(e){Gl.argument(e>=0&&e<=255,"Byte value should be between 0 and 255.");return[e]};Yl.BYTE=Kl(1);Xl.CHAR=function(e){return[e.charCodeAt(0)]};Yl.CHAR=Kl(1);Xl.CHARARRAY=function(e){var t=[];for(var n=0;n<e.length;n+=1){t[n]=e.charCodeAt(n)}return t};Yl.CHARARRAY=function(e){return e.length};Xl.USHORT=function(e){return[e>>8&255,e&255]};Yl.USHORT=Kl(2);Xl.SHORT=function(e){if(e>=Hl){e=-(2*Hl-e)}return[e>>8&255,e&255]};Yl.SHORT=Kl(2);Xl.UINT24=function(e){return[e>>16&255,e>>8&255,e&255]};Yl.UINT24=Kl(3);Xl.ULONG=function(e){return[e>>24&255,e>>16&255,e>>8&255,e&255]};Yl.ULONG=Kl(4);Xl.LONG=function(e){if(e>=jl){e=-(2*jl-e)}return[e>>24&255,e>>16&255,e>>8&255,e&255]};Yl.LONG=Kl(4);Xl.FIXED=Xl.ULONG;Yl.FIXED=Yl.ULONG;Xl.FWORD=Xl.SHORT;Yl.FWORD=Yl.SHORT;Xl.UFWORD=Xl.USHORT;Yl.UFWORD=Yl.USHORT;Xl.LONGDATETIME=function(e){return[0,0,0,0,e>>24&255,e>>16&255,e>>8&255,e&255]};Yl.LONGDATETIME=Kl(8);Xl.TAG=function(e){Gl.argument(e.length===4,"Tag should be exactly 4 ASCII characters.");return[e.charCodeAt(0),e.charCodeAt(1),e.charCodeAt(2),e.charCodeAt(3)]};Yl.TAG=Kl(4);Xl.Card8=Xl.BYTE;Yl.Card8=Yl.BYTE;Xl.Card16=Xl.USHORT;Yl.Card16=Yl.USHORT;Xl.OffSize=Xl.BYTE;Yl.OffSize=Yl.BYTE;Xl.SID=Xl.USHORT;Yl.SID=Yl.USHORT;Xl.NUMBER=function(e){if(e>=-107&&e<=107){return[e+139]}else if(e>=108&&e<=1131){e=e-108;return[(e>>8)+247,e&255]}else if(e>=-1131&&e<=-108){e=-e-108;return[(e>>8)+251,e&255]}else if(e>=-32768&&e<=32767){return Xl.NUMBER16(e)}else{return Xl.NUMBER32(e)}};Yl.NUMBER=function(e){return Xl.NUMBER(e).length};Xl.NUMBER16=function(e){return[28,e>>8&255,e&255]};Yl.NUMBER16=Kl(3);Xl.NUMBER32=function(e){return[29,e>>24&255,e>>16&255,e>>8&255,e&255]};Yl.NUMBER32=Kl(5);Xl.REAL=function(e){var t=e.toString();var n=/\.(\d*?)(?:9{5,20}|0{5,20})\d{0,2}(?:e(.+)|$)/.exec(t);if(n){var r=parseFloat("1e"+((n[2]?+n[2]:0)+n[1].length));t=(Math.round(e*r)/r).toString()}var i="";for(var a=0,o=t.length;a<o;a+=1){var s=t[a];if(s==="e"){i+=t[++a]==="-"?"c":"b"}else if(s==="."){i+="a"}else if(s==="-"){i+="e"}else{i+=s}}i+=i.length&1?"f":"ff";var l=[30];for(var u=0,h=i.length;u<h;u+=2){l.push(parseInt(i.substr(u,2),16))}return l};Yl.REAL=function(e){return Xl.REAL(e).length};Xl.NAME=Xl.CHARARRAY;Yl.NAME=Yl.CHARARRAY;Xl.STRING=Xl.CHARARRAY;Yl.STRING=Yl.CHARARRAY;ql.UTF8=function(e,t,n){var r=[];var i=n;for(var a=0;a<i;a++,t+=1){r[a]=e.getUint8(t)}return String.fromCharCode.apply(null,r)};ql.UTF16=function(e,t,n){var r=[];var i=n/2;for(var a=0;a<i;a++,t+=2){r[a]=e.getUint16(t)}return String.fromCharCode.apply(null,r)};Xl.UTF16=function(e){var t=[];for(var n=0;n<e.length;n+=1){var r=e.charCodeAt(n);t[t.length]=r>>8&255;t[t.length]=r&255}return t};Yl.UTF16=function(e){return e.length*2};var Zl={"x-mac-croatian":"ÄÅÇÉÑÖÜáàâäãåçéèêëíìîïñóòôöõúùûü†°¢£§•¶ß®Š™´¨≠ŽØ∞±≤≥∆µ∂∑∏š∫ªºΩžø"+"¿¡¬√ƒ≈Ć«Č… ÀÃÕŒœĐ—“”‘’÷◊©⁄€‹›Æ»–·‚„‰ÂćÁčÈÍÎÏÌÓÔđÒÚÛÙıˆ˜¯πË˚¸Êæˇ","x-mac-cyrillic":"АБВГДЕЖЗИЙКЛМНОПРСТУФХЦЧШЩЪЫЬЭЮЯ†°Ґ£§•¶І®©™Ђђ≠Ѓѓ∞±≤≥іµґЈЄєЇїЉљЊњ"+"јЅ¬√ƒ≈∆«»… ЋћЌќѕ–—“”‘’÷„ЎўЏџ№Ёёяабвгдежзийклмнопрстуфхцчшщъыьэю","x-mac-gaelic":"ÄÅÇÉÑÖÜáàâäãåçéèêëíìîïñóòôöõúùûü†°¢£§•¶ß®©™´¨≠ÆØḂ±≤≥ḃĊċḊḋḞḟĠġṀæø"+"ṁṖṗɼƒſṠ«»… ÀÃÕŒœ–—“”‘’ṡẛÿŸṪ€‹›Ŷŷṫ·Ỳỳ⁊ÂÊÁËÈÍÎÏÌÓÔ♣ÒÚÛÙıÝýŴŵẄẅẀẁẂẃ","x-mac-greek":"Ä¹²É³ÖÜ΅àâä΄¨çéèêë£™îï•½‰ôö¦€ùûü†ΓΔΘΛΞΠß®©ΣΪ§≠°·Α±≤≥¥ΒΕΖΗΙΚΜΦΫΨΩ"+"άΝ¬ΟΡ≈Τ«»… ΥΧΆΈœ–―“”‘’÷ΉΊΌΎέήίόΏύαβψδεφγηιξκλμνοπώρστθωςχυζϊϋΐΰ­","x-mac-icelandic":"ÄÅÇÉÑÖÜáàâäãåçéèêëíìîïñóòôöõúùûüÝ°¢£§•¶ß®©™´¨≠ÆØ∞±≤≥¥µ∂∑∏π∫ªºΩæø"+"¿¡¬√ƒ≈∆«»… ÀÃÕŒœ–—“”‘’÷◊ÿŸ⁄€ÐðÞþý·‚„‰ÂÊÁËÈÍÎÏÌÓÔÒÚÛÙıˆ˜¯˘˙˚¸˝˛ˇ","x-mac-inuit":"ᐃᐄᐅᐆᐊᐋᐱᐲᐳᐴᐸᐹᑉᑎᑏᑐᑑᑕᑖᑦᑭᑮᑯᑰᑲᑳᒃᒋᒌᒍᒎᒐᒑ°ᒡᒥᒦ•¶ᒧ®©™ᒨᒪᒫᒻᓂᓃᓄᓅᓇᓈᓐᓯᓰᓱᓲᓴᓵᔅᓕᓖᓗ"+"ᓘᓚᓛᓪᔨᔩᔪᔫᔭ… ᔮᔾᕕᕖᕗ–—“”‘’ᕘᕙᕚᕝᕆᕇᕈᕉᕋᕌᕐᕿᖀᖁᖂᖃᖄᖅᖏᖐᖑᖒᖓᖔᖕᙱᙲᙳᙴᙵᙶᖖᖠᖡᖢᖣᖤᖥᖦᕼŁł","x-mac-ce":"ÄĀāÉĄÖÜáąČäčĆćéŹźĎíďĒēĖóėôöõúĚěü†°Ę£§•¶ß®©™ę¨≠ģĮįĪ≤≥īĶ∂∑łĻļĽľĹĺŅ"+"ņŃ¬√ńŇ∆«»… ňŐÕőŌ–—“”‘’÷◊ōŔŕŘ‹›řŖŗŠ‚„šŚśÁŤťÍŽžŪÓÔūŮÚůŰűŲųÝýķŻŁżĢˇ",macintosh:"ÄÅÇÉÑÖÜáàâäãåçéèêëíìîïñóòôöõúùûü†°¢£§•¶ß®©™´¨≠ÆØ∞±≤≥¥µ∂∑∏π∫ªºΩæø"+"¿¡¬√ƒ≈∆«»… ÀÃÕŒœ–—“”‘’÷◊ÿŸ⁄€‹›ﬁﬂ‡·‚„‰ÂÊÁËÈÍÎÏÌÓÔÒÚÛÙıˆ˜¯˘˙˚¸˝˛ˇ","x-mac-romanian":"ÄÅÇÉÑÖÜáàâäãåçéèêëíìîïñóòôöõúùûü†°¢£§•¶ß®©™´¨≠ĂȘ∞±≤≥¥µ∂∑∏π∫ªºΩăș"+"¿¡¬√ƒ≈∆«»… ÀÃÕŒœ–—“”‘’÷◊ÿŸ⁄€‹›Țț‡·‚„‰ÂÊÁËÈÍÎÏÌÓÔÒÚÛÙıˆ˜¯˘˙˚¸˝˛ˇ","x-mac-turkish":"ÄÅÇÉÑÖÜáàâäãåçéèêëíìîïñóòôöõúùûü†°¢£§•¶ß®©™´¨≠ÆØ∞±≤≥¥µ∂∑∏π∫ªºΩæø"+"¿¡¬√ƒ≈∆«»… ÀÃÕŒœ–—“”‘’÷◊ÿŸĞğİıŞş‡·‚„‰ÂÊÁËÈÍÎÏÌÓÔÒÚÛÙˆ˜¯˘˙˚¸˝˛ˇ"};ql.MACSTRING=function(e,t,n,r){var i=Zl[r];if(i===undefined){return undefined}var a="";for(var o=0;o<n;o++){var s=e.getUint8(t+o);if(s<=127){a+=String.fromCharCode(s)}else{a+=i[s&127]}}return a};var Ql=typeof WeakMap==="function"&&new WeakMap;var Jl;var $l=function(e){if(!Jl){Jl={};for(var t in Zl){Jl[t]=new String(t)}}var n=Jl[e];if(n===undefined){return undefined}if(Ql){var r=Ql.get(n);if(r!==undefined){return r}}var i=Zl[e];if(i===undefined){return undefined}var a={};for(var o=0;o<i.length;o++){a[i.charCodeAt(o)]=o+128}if(Ql){Ql.set(n,a)}return a};Xl.MACSTRING=function(e,t){var n=$l(t);if(n===undefined){return undefined}var r=[];for(var i=0;i<e.length;i++){var a=e.charCodeAt(i);if(a>=128){a=n[a];if(a===undefined){return undefined}}r[i]=a}return r};Yl.MACSTRING=function(e,t){var n=Xl.MACSTRING(e,t);if(n!==undefined){return n.length}else{return 0}};function eu(e){return e>=-128&&e<=127}function tu(e,t,n){var r=0;var i=e.length;while(t<i&&r<64&&e[t]===0){++t;++r}n.push(128|r-1);return t}function nu(e,t,n){var r=0;var i=e.length;var a=t;while(a<i&&r<64){var o=e[a];if(!eu(o)){break}if(o===0&&a+1<i&&e[a+1]===0){break}++a;++r}n.push(r-1);for(var s=t;s<a;++s){n.push(e[s]+256&255)}return a}function ru(e,t,n){var r=0;var i=e.length;var a=t;while(a<i&&r<64){var o=e[a];if(o===0){break}if(eu(o)&&a+1<i&&eu(e[a+1])){break}++a;++r}n.push(64|r-1);for(var s=t;s<a;++s){var l=e[s];n.push(l+65536>>8&255,l+256&255)}return a}Xl.VARDELTAS=function(e){var t=0;var n=[];while(t<e.length){var r=e[t];if(r===0){t=tu(e,t,n)}else if(r>=-128&&r<=127){t=nu(e,t,n)}else{t=ru(e,t,n)}}return n};Xl.INDEX=function(e){var t=1;var n=[t];var r=[];for(var i=0;i<e.length;i+=1){var a=Xl.OBJECT(e[i]);Array.prototype.push.apply(r,a);t+=a.length;n.push(t)}if(r.length===0){return[0,0]}var o=[];var s=1+Math.floor(Math.log(t)/Math.log(2))/8|0;var l=[undefined,Xl.BYTE,Xl.USHORT,Xl.UINT24,Xl.ULONG][s];for(var u=0;u<n.length;u+=1){var h=l(n[u]);Array.prototype.push.apply(o,h)}return Array.prototype.concat(Xl.Card16(e.length),Xl.OffSize(s),o,r)};Yl.INDEX=function(e){return Xl.INDEX(e).length};Xl.DICT=function(e){var t=[];var n=Object.keys(e);var r=n.length;for(var i=0;i<r;i+=1){var a=parseInt(n[i],0);var o=e[a];t=t.concat(Xl.OPERAND(o.value,o.type));t=t.concat(Xl.OPERATOR(a))}return t};Yl.DICT=function(e){return Xl.DICT(e).length};Xl.OPERATOR=function(e){if(e<1200){return[e]}else{return[12,e-1200]}};Xl.OPERAND=function(e,t){var n=[];if(Array.isArray(t)){for(var r=0;r<t.length;r+=1){Gl.argument(e.length===t.length,"Not enough arguments given for type"+t);n=n.concat(Xl.OPERAND(e[r],t[r]))}}else{if(t==="SID"){n=n.concat(Xl.NUMBER(e))}else if(t==="offset"){n=n.concat(Xl.NUMBER32(e))}else if(t==="number"){n=n.concat(Xl.NUMBER(e))}else if(t==="real"){n=n.concat(Xl.REAL(e))}else{throw new Error("Unknown operand type "+t)}}return n};Xl.OP=Xl.BYTE;Yl.OP=Yl.BYTE;var iu=typeof WeakMap==="function"&&new WeakMap;Xl.CHARSTRING=function(e){if(iu){var t=iu.get(e);if(t!==undefined){return t}}var n=[];var r=e.length;for(var i=0;i<r;i+=1){var a=e[i];n=n.concat(Xl[a.type](a.value))}if(iu){iu.set(e,n)}return n};Yl.CHARSTRING=function(e){return Xl.CHARSTRING(e).length};Xl.OBJECT=function(e){var t=Xl[e.type];Gl.argument(t!==undefined,"No encoding function for type "+e.type);return t(e.value)};Yl.OBJECT=function(e){var t=Yl[e.type];Gl.argument(t!==undefined,"No sizeOf function for type "+e.type);return t(e.value)};Xl.TABLE=function(e){var t=[];var n=e.fields.length;var r=[];var i=[];for(var a=0;a<n;a+=1){var o=e.fields[a];var s=Xl[o.type];Gl.argument(s!==undefined,"No encoding function for field type "+o.type+" ("+o.name+")");var l=e[o.name];if(l===undefined){l=o.value}var u=s(l);if(o.type==="TABLE"){i.push(t.length);t=t.concat([0,0]);r.push(u)}else{t=t.concat(u)}}for(var h=0;h<r.length;h+=1){var c=i[h];var f=t.length;Gl.argument(f<65536,"Table "+e.tableName+" too big.");t[c]=f>>8;t[c+1]=f&255;t=t.concat(r[h])}return t};Yl.TABLE=function(e){var t=0;var n=e.fields.length;for(var r=0;r<n;r+=1){var i=e.fields[r];var a=Yl[i.type];Gl.argument(a!==undefined,"No sizeOf function for field type "+i.type+" ("+i.name+")");var o=e[i.name];if(o===undefined){o=i.value}t+=a(o);if(i.type==="TABLE"){t+=2}}return t};Xl.RECORD=Xl.TABLE;Yl.RECORD=Yl.TABLE;Xl.LITERAL=function(e){return e};Yl.LITERAL=function(e){return e.length};function au(e,t,n){var r=this;for(var i=0;i<t.length;i+=1){var a=t[i];r[a.name]=a.value}this.tableName=e;this.fields=t;if(n){var o=Object.keys(n);for(var s=0;s<o.length;s+=1){var l=o[s];var u=n[l];if(r[l]!==undefined){r[l]=u}}}}au.prototype.encode=function(){return Xl.TABLE(this)};au.prototype.sizeOf=function(){return Yl.TABLE(this)};function ou(e,t,n){if(n===undefined){n=t.length}var r=new Array(t.length+1);r[0]={name:e+"Count",type:"USHORT",value:n};for(var i=0;i<t.length;i++){r[i+1]={name:e+i,type:"USHORT",value:t[i]}}return r}function su(e,t,n){var r=t.length;var i=new Array(r+1);i[0]={name:e+"Count",type:"USHORT",value:r};for(var a=0;a<r;a++){i[a+1]={name:e+a,type:"TABLE",value:n(t[a],a)}}return i}function lu(e,t,n){var r=t.length;var i=[];i[0]={name:e+"Count",type:"USHORT",value:r};for(var a=0;a<r;a++){i=i.concat(n(t[a],a))}return i}function uu(e){if(e.format===1){au.call(this,"coverageTable",[{name:"coverageFormat",type:"USHORT",value:1}].concat(ou("glyph",e.glyphs)))}else{Gl.assert(false,"Can't create coverage table format 2 yet.")}}uu.prototype=Object.create(au.prototype);uu.prototype.constructor=uu;function hu(e){au.call(this,"scriptListTable",lu("scriptRecord",e,function(e,t){var n=e.script;var r=n.defaultLangSys;Gl.assert(!!r,"Unable to write GSUB: script "+e.tag+" has no default language system.");return[{name:"scriptTag"+t,type:"TAG",value:e.tag},{name:"script"+t,type:"TABLE",value:new au("scriptTable",[{name:"defaultLangSys",type:"TABLE",value:new au("defaultLangSys",[{name:"lookupOrder",type:"USHORT",value:0},{name:"reqFeatureIndex",type:"USHORT",value:r.reqFeatureIndex}].concat(ou("featureIndex",r.featureIndexes)))}].concat(lu("langSys",n.langSysRecords,function(e,t){var n=e.langSys;return[{name:"langSysTag"+t,type:"TAG",value:e.tag},{name:"langSys"+t,type:"TABLE",value:new au("langSys",[{name:"lookupOrder",type:"USHORT",value:0},{name:"reqFeatureIndex",type:"USHORT",value:n.reqFeatureIndex}].concat(ou("featureIndex",n.featureIndexes)))}]})))}]}))}hu.prototype=Object.create(au.prototype);hu.prototype.constructor=hu;function cu(e){au.call(this,"featureListTable",lu("featureRecord",e,function(e,t){var n=e.feature;return[{name:"featureTag"+t,type:"TAG",value:e.tag},{name:"feature"+t,type:"TABLE",value:new au("featureTable",[{name:"featureParams",type:"USHORT",value:n.featureParams}].concat(ou("lookupListIndex",n.lookupListIndexes)))}]}))}cu.prototype=Object.create(au.prototype);cu.prototype.constructor=cu;function fu(e,n){au.call(this,"lookupListTable",su("lookup",e,function(e){var t=n[e.lookupType];Gl.assert(!!t,"Unable to write GSUB lookup type "+e.lookupType+" tables.");return new au("lookupTable",[{name:"lookupType",type:"USHORT",value:e.lookupType},{name:"lookupFlag",type:"USHORT",value:e.lookupFlag}].concat(su("subtable",e.subtables,t)))}))}fu.prototype=Object.create(au.prototype);fu.prototype.constructor=fu;var pu={Table:au,Record:au,Coverage:uu,ScriptList:hu,FeatureList:cu,LookupList:fu,ushortList:ou,tableList:su,recordList:lu};function du(e,t){return e.getUint8(t)}function vu(e,t){return e.getUint16(t,false)}function mu(e,t){return e.getInt16(t,false)}function _u(e,t){return e.getUint32(t,false)}function gu(e,t){var n=e.getInt16(t,false);var r=e.getUint16(t+2,false);return n+r/65535}function yu(e,t){var n="";for(var r=t;r<t+4;r+=1){n+=String.fromCharCode(e.getInt8(r))}return n}function xu(e,t,n){var r=0;for(var i=0;i<n;i+=1){r<<=8;r+=e.getUint8(t+i)}return r}function bu(e,t,n){var r=[];for(var i=t;i<n;i+=1){r.push(e.getUint8(i))}return r}function wu(e){var t="";for(var n=0;n<e.length;n+=1){t+=String.fromCharCode(e[n])}return t}var Eu={byte:1,uShort:2,short:2,uLong:4,fixed:4,longDateTime:8,tag:4};function Tu(e,t){this.data=e;this.offset=t;this.relativeOffset=0}Tu.prototype.parseByte=function(){var e=this.data.getUint8(this.offset+this.relativeOffset);this.relativeOffset+=1;return e};Tu.prototype.parseChar=function(){var e=this.data.getInt8(this.offset+this.relativeOffset);this.relativeOffset+=1;return e};Tu.prototype.parseCard8=Tu.prototype.parseByte;Tu.prototype.parseUShort=function(){var e=this.data.getUint16(this.offset+this.relativeOffset);this.relativeOffset+=2;return e};Tu.prototype.parseCard16=Tu.prototype.parseUShort;Tu.prototype.parseSID=Tu.prototype.parseUShort;Tu.prototype.parseOffset16=Tu.prototype.parseUShort;Tu.prototype.parseShort=function(){var e=this.data.getInt16(this.offset+this.relativeOffset);this.relativeOffset+=2;return e};Tu.prototype.parseF2Dot14=function(){var e=this.data.getInt16(this.offset+this.relativeOffset)/16384;this.relativeOffset+=2;return e};Tu.prototype.parseULong=function(){var e=_u(this.data,this.offset+this.relativeOffset);this.relativeOffset+=4;return e};Tu.prototype.parseFixed=function(){var e=gu(this.data,this.offset+this.relativeOffset);this.relativeOffset+=4;return e};Tu.prototype.parseString=function(e){var t=this.data;var n=this.offset+this.relativeOffset;var r="";this.relativeOffset+=e;for(var i=0;i<e;i++){r+=String.fromCharCode(t.getUint8(n+i))}return r};Tu.prototype.parseTag=function(){return this.parseString(4)};Tu.prototype.parseLongDateTime=function(){var e=_u(this.data,this.offset+this.relativeOffset+4);e-=2082844800;this.relativeOffset+=8;return e};Tu.prototype.parseVersion=function(){var e=vu(this.data,this.offset+this.relativeOffset);var t=vu(this.data,this.offset+this.relativeOffset+2);this.relativeOffset+=4;return e+t/4096/10};Tu.prototype.skip=function(e,t){if(t===undefined){t=1}this.relativeOffset+=Eu[e]*t};Tu.prototype.parseOffset16List=Tu.prototype.parseUShortList=function(e){if(e===undefined){e=this.parseUShort()}var t=new Array(e);var n=this.data;var r=this.offset+this.relativeOffset;for(var i=0;i<e;i++){t[i]=n.getUint16(r);r+=2}this.relativeOffset+=e*2;return t};Tu.prototype.parseShortList=function(e){var t=new Array(e);var n=this.data;var r=this.offset+this.relativeOffset;for(var i=0;i<e;i++){t[i]=n.getInt16(r);r+=2}this.relativeOffset+=e*2;return t};Tu.prototype.parseByteList=function(e){var t=new Array(e);var n=this.data;var r=this.offset+this.relativeOffset;for(var i=0;i<e;i++){t[i]=n.getUint8(r++)}this.relativeOffset+=e;return t};Tu.prototype.parseList=function(e,t){var n=this;if(!t){t=e;e=this.parseUShort()}var r=new Array(e);for(var i=0;i<e;i++){r[i]=t.call(n)}return r};Tu.prototype.parseRecordList=function(e,t){var n=this;if(!t){t=e;e=this.parseUShort()}var r=new Array(e);var i=Object.keys(t);for(var a=0;a<e;a++){var o={};for(var s=0;s<i.length;s++){var l=i[s];var u=t[l];o[l]=u.call(n)}r[a]=o}return r};Tu.prototype.parseStruct=function(e){var t=this;if(typeof e==="function"){return e.call(this)}else{var n=Object.keys(e);var r={};for(var i=0;i<n.length;i++){var a=n[i];var o=e[a];r[a]=o.call(t)}return r}};Tu.prototype.parsePointer=function(e){var t=this.parseOffset16();if(t>0){return new Tu(this.data,this.offset+t).parseStruct(e)}return undefined};Tu.prototype.parseListOfLists=function(e){var t=this;var n=this.parseOffset16List();var r=n.length;var i=this.relativeOffset;var a=new Array(r);for(var o=0;o<r;o++){var s=n[o];if(s===0){a[o]=undefined;continue}t.relativeOffset=s;if(e){var l=t.parseOffset16List();var u=new Array(l.length);for(var h=0;h<l.length;h++){t.relativeOffset=s+l[h];u[h]=e.call(t)}a[o]=u}else{a[o]=t.parseUShortList()}}this.relativeOffset=i;return a};Tu.prototype.parseCoverage=function(){var e=this;var t=this.offset+this.relativeOffset;var n=this.parseUShort();var r=this.parseUShort();if(n===1){return{format:1,glyphs:this.parseUShortList(r)}}else if(n===2){var i=new Array(r);for(var a=0;a<r;a++){i[a]={start:e.parseUShort(),end:e.parseUShort(),index:e.parseUShort()}}return{format:2,ranges:i}}throw new Error("0x"+t.toString(16)+": Coverage format must be 1 or 2.")};Tu.prototype.parseClassDef=function(){var e=this.offset+this.relativeOffset;var t=this.parseUShort();if(t===1){return{format:1,startGlyph:this.parseUShort(),classes:this.parseUShortList()}}else if(t===2){return{format:2,ranges:this.parseRecordList({start:Tu.uShort,end:Tu.uShort,classId:Tu.uShort})}}throw new Error("0x"+e.toString(16)+": ClassDef format must be 1 or 2.")};Tu.list=function(e,t){return function(){return this.parseList(e,t)}};Tu.recordList=function(e,t){return function(){return this.parseRecordList(e,t)}};Tu.pointer=function(e){return function(){return this.parsePointer(e)}};Tu.tag=Tu.prototype.parseTag;Tu.byte=Tu.prototype.parseByte;Tu.uShort=Tu.offset16=Tu.prototype.parseUShort;Tu.uShortList=Tu.prototype.parseUShortList;Tu.struct=Tu.prototype.parseStruct;Tu.coverage=Tu.prototype.parseCoverage;Tu.classDef=Tu.prototype.parseClassDef;var Su={reserved:Tu.uShort,reqFeatureIndex:Tu.uShort,featureIndexes:Tu.uShortList};Tu.prototype.parseScriptList=function(){return this.parsePointer(Tu.recordList({tag:Tu.tag,script:Tu.pointer({defaultLangSys:Tu.pointer(Su),langSysRecords:Tu.recordList({tag:Tu.tag,langSys:Tu.pointer(Su)})})}))};Tu.prototype.parseFeatureList=function(){return this.parsePointer(Tu.recordList({tag:Tu.tag,feature:Tu.pointer({featureParams:Tu.offset16,lookupListIndexes:Tu.uShortList})}))};Tu.prototype.parseLookupList=function(r){return this.parsePointer(Tu.list(Tu.pointer(function(){var e=this.parseUShort();Gl.argument(1<=e&&e<=8,"GSUB lookup type "+e+" unknown.");var t=this.parseUShort();var n=t&16;return{lookupType:e,lookupFlag:t,subtables:this.parseList(Tu.pointer(r[e])),markFilteringSet:n?this.parseUShort():undefined}})))};var Au={getByte:du,getCard8:du,getUShort:vu,getCard16:vu,getShort:mu,getULong:_u,getFixed:gu,getTag:yu,getOffset:xu,getBytes:bu,bytesToString:wu,Parser:Tu};function Mu(e,t){t.parseUShort();e.length=t.parseULong();e.language=t.parseULong();var n;e.groupCount=n=t.parseULong();e.glyphIndexMap={};for(var r=0;r<n;r+=1){var i=t.parseULong();var a=t.parseULong();var o=t.parseULong();for(var s=i;s<=a;s+=1){e.glyphIndexMap[s]=o;o++}}}function Ru(e,t,n,r,i){e.length=t.parseUShort();e.language=t.parseUShort();var a;e.segCount=a=t.parseUShort()>>1;t.skip("uShort",3);e.glyphIndexMap={};var o=new Au.Parser(n,r+i+14);var s=new Au.Parser(n,r+i+16+a*2);var l=new Au.Parser(n,r+i+16+a*4);var u=new Au.Parser(n,r+i+16+a*6);var h=r+i+16+a*8;for(var c=0;c<a-1;c+=1){var f=void 0;var p=o.parseUShort();var d=s.parseUShort();var v=l.parseShort();var m=u.parseUShort();for(var _=d;_<=p;_+=1){if(m!==0){h=u.offset+u.relativeOffset-2;h+=m;h+=(_-d)*2;f=Au.getUShort(n,h);if(f!==0){f=f+v&65535}}else{f=_+v&65535}e.glyphIndexMap[_]=f}}}function Lu(e,t){var n={};n.version=Au.getUShort(e,t);Gl.argument(n.version===0,"cmap table version should be 0.");n.numTables=Au.getUShort(e,t+2);var r=-1;for(var i=n.numTables-1;i>=0;i-=1){var a=Au.getUShort(e,t+4+i*8);var o=Au.getUShort(e,t+4+i*8+2);if(a===3&&(o===0||o===1||o===10)){r=Au.getULong(e,t+4+i*8+4);break}}if(r===-1){throw new Error("No valid cmap sub-tables found.")}var s=new Au.Parser(e,t+r);n.format=s.parseUShort();if(n.format===12){Mu(n,s)}else if(n.format===4){Ru(n,s,e,t,r)}else{throw new Error("Only format 4 and 12 cmap tables are supported (found format "+n.format+").")}return n}function Cu(e,t,n){e.segments.push({end:t,start:t,delta:-(t-n),offset:0})}function Ou(e){e.segments.push({end:65535,start:65535,delta:1,offset:0})}function Iu(e){var t=new pu.Table("cmap",[{name:"version",type:"USHORT",value:0},{name:"numTables",type:"USHORT",value:1},{name:"platformID",type:"USHORT",value:3},{name:"encodingID",type:"USHORT",value:1},{name:"offset",type:"ULONG",value:12},{name:"format",type:"USHORT",value:4},{name:"length",type:"USHORT",value:0},{name:"language",type:"USHORT",value:0},{name:"segCountX2",type:"USHORT",value:0},{name:"searchRange",type:"USHORT",value:0},{name:"entrySelector",type:"USHORT",value:0},{name:"rangeShift",type:"USHORT",value:0}]);t.segments=[];for(var n=0;n<e.length;n+=1){var r=e.get(n);for(var i=0;i<r.unicodes.length;i+=1){Cu(t,r.unicodes[i],n)}t.segments=t.segments.sort(function(e,t){return e.start-t.start})}Ou(t);var a;a=t.segments.length;t.segCountX2=a*2;t.searchRange=Math.pow(2,Math.floor(Math.log(a)/Math.log(2)))*2;t.entrySelector=Math.log(t.searchRange/2)/Math.log(2);t.rangeShift=t.segCountX2-t.searchRange;var o=[];var s=[];var l=[];var u=[];var h=[];for(var c=0;c<a;c+=1){var f=t.segments[c];o=o.concat({name:"end_"+c,type:"USHORT",value:f.end});s=s.concat({name:"start_"+c,type:"USHORT",value:f.start});l=l.concat({name:"idDelta_"+c,type:"SHORT",value:f.delta});u=u.concat({name:"idRangeOffset_"+c,type:"USHORT",value:f.offset});if(f.glyphId!==undefined){h=h.concat({name:"glyph_"+c,type:"USHORT",value:f.glyphId})}}t.fields=t.fields.concat(o);t.fields.push({name:"reservedPad",type:"USHORT",value:0});t.fields=t.fields.concat(s);t.fields=t.fields.concat(l);t.fields=t.fields.concat(u);t.fields=t.fields.concat(h);t.length=14+o.length*2+2+s.length*2+l.length*2+u.length*2+h.length*2;return t}var Uu={parse:Lu,make:Iu};var Pu=[".notdef","space","exclam","quotedbl","numbersign","dollar","percent","ampersand","quoteright","parenleft","parenright","asterisk","plus","comma","hyphen","period","slash","zero","one","two","three","four","five","six","seven","eight","nine","colon","semicolon","less","equal","greater","question","at","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","bracketleft","backslash","bracketright","asciicircum","underscore","quoteleft","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","braceleft","bar","braceright","asciitilde","exclamdown","cent","sterling","fraction","yen","florin","section","currency","quotesingle","quotedblleft","guillemotleft","guilsinglleft","guilsinglright","fi","fl","endash","dagger","daggerdbl","periodcentered","paragraph","bullet","quotesinglbase","quotedblbase","quotedblright","guillemotright","ellipsis","perthousand","questiondown","grave","acute","circumflex","tilde","macron","breve","dotaccent","dieresis","ring","cedilla","hungarumlaut","ogonek","caron","emdash","AE","ordfeminine","Lslash","Oslash","OE","ordmasculine","ae","dotlessi","lslash","oslash","oe","germandbls","onesuperior","logicalnot","mu","trademark","Eth","onehalf","plusminus","Thorn","onequarter","divide","brokenbar","degree","thorn","threequarters","twosuperior","registered","minus","eth","multiply","threesuperior","copyright","Aacute","Acircumflex","Adieresis","Agrave","Aring","Atilde","Ccedilla","Eacute","Ecircumflex","Edieresis","Egrave","Iacute","Icircumflex","Idieresis","Igrave","Ntilde","Oacute","Ocircumflex","Odieresis","Ograve","Otilde","Scaron","Uacute","Ucircumflex","Udieresis","Ugrave","Yacute","Ydieresis","Zcaron","aacute","acircumflex","adieresis","agrave","aring","atilde","ccedilla","eacute","ecircumflex","edieresis","egrave","iacute","icircumflex","idieresis","igrave","ntilde","oacute","ocircumflex","odieresis","ograve","otilde","scaron","uacute","ucircumflex","udieresis","ugrave","yacute","ydieresis","zcaron","exclamsmall","Hungarumlautsmall","dollaroldstyle","dollarsuperior","ampersandsmall","Acutesmall","parenleftsuperior","parenrightsuperior","266 ff","onedotenleader","zerooldstyle","oneoldstyle","twooldstyle","threeoldstyle","fouroldstyle","fiveoldstyle","sixoldstyle","sevenoldstyle","eightoldstyle","nineoldstyle","commasuperior","threequartersemdash","periodsuperior","questionsmall","asuperior","bsuperior","centsuperior","dsuperior","esuperior","isuperior","lsuperior","msuperior","nsuperior","osuperior","rsuperior","ssuperior","tsuperior","ff","ffi","ffl","parenleftinferior","parenrightinferior","Circumflexsmall","hyphensuperior","Gravesmall","Asmall","Bsmall","Csmall","Dsmall","Esmall","Fsmall","Gsmall","Hsmall","Ismall","Jsmall","Ksmall","Lsmall","Msmall","Nsmall","Osmall","Psmall","Qsmall","Rsmall","Ssmall","Tsmall","Usmall","Vsmall","Wsmall","Xsmall","Ysmall","Zsmall","colonmonetary","onefitted","rupiah","Tildesmall","exclamdownsmall","centoldstyle","Lslashsmall","Scaronsmall","Zcaronsmall","Dieresissmall","Brevesmall","Caronsmall","Dotaccentsmall","Macronsmall","figuredash","hypheninferior","Ogoneksmall","Ringsmall","Cedillasmall","questiondownsmall","oneeighth","threeeighths","fiveeighths","seveneighths","onethird","twothirds","zerosuperior","foursuperior","fivesuperior","sixsuperior","sevensuperior","eightsuperior","ninesuperior","zeroinferior","oneinferior","twoinferior","threeinferior","fourinferior","fiveinferior","sixinferior","seveninferior","eightinferior","nineinferior","centinferior","dollarinferior","periodinferior","commainferior","Agravesmall","Aacutesmall","Acircumflexsmall","Atildesmall","Adieresissmall","Aringsmall","AEsmall","Ccedillasmall","Egravesmall","Eacutesmall","Ecircumflexsmall","Edieresissmall","Igravesmall","Iacutesmall","Icircumflexsmall","Idieresissmall","Ethsmall","Ntildesmall","Ogravesmall","Oacutesmall","Ocircumflexsmall","Otildesmall","Odieresissmall","OEsmall","Oslashsmall","Ugravesmall","Uacutesmall","Ucircumflexsmall","Udieresissmall","Yacutesmall","Thornsmall","Ydieresissmall","001.000","001.001","001.002","001.003","Black","Bold","Book","Light","Medium","Regular","Roman","Semibold"];var Bu=["","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","space","exclam","quotedbl","numbersign","dollar","percent","ampersand","quoteright","parenleft","parenright","asterisk","plus","comma","hyphen","period","slash","zero","one","two","three","four","five","six","seven","eight","nine","colon","semicolon","less","equal","greater","question","at","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","bracketleft","backslash","bracketright","asciicircum","underscore","quoteleft","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","braceleft","bar","braceright","asciitilde","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","exclamdown","cent","sterling","fraction","yen","florin","section","currency","quotesingle","quotedblleft","guillemotleft","guilsinglleft","guilsinglright","fi","fl","","endash","dagger","daggerdbl","periodcentered","","paragraph","bullet","quotesinglbase","quotedblbase","quotedblright","guillemotright","ellipsis","perthousand","","questiondown","","grave","acute","circumflex","tilde","macron","breve","dotaccent","dieresis","","ring","cedilla","","hungarumlaut","ogonek","caron","emdash","","","","","","","","","","","","","","","","","AE","","ordfeminine","","","","","Lslash","Oslash","OE","ordmasculine","","","","","","ae","","","","dotlessi","","","lslash","oslash","oe","germandbls"];var Du=["","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","space","exclamsmall","Hungarumlautsmall","","dollaroldstyle","dollarsuperior","ampersandsmall","Acutesmall","parenleftsuperior","parenrightsuperior","twodotenleader","onedotenleader","comma","hyphen","period","fraction","zerooldstyle","oneoldstyle","twooldstyle","threeoldstyle","fouroldstyle","fiveoldstyle","sixoldstyle","sevenoldstyle","eightoldstyle","nineoldstyle","colon","semicolon","commasuperior","threequartersemdash","periodsuperior","questionsmall","","asuperior","bsuperior","centsuperior","dsuperior","esuperior","","","isuperior","","","lsuperior","msuperior","nsuperior","osuperior","","","rsuperior","ssuperior","tsuperior","","ff","fi","fl","ffi","ffl","parenleftinferior","","parenrightinferior","Circumflexsmall","hyphensuperior","Gravesmall","Asmall","Bsmall","Csmall","Dsmall","Esmall","Fsmall","Gsmall","Hsmall","Ismall","Jsmall","Ksmall","Lsmall","Msmall","Nsmall","Osmall","Psmall","Qsmall","Rsmall","Ssmall","Tsmall","Usmall","Vsmall","Wsmall","Xsmall","Ysmall","Zsmall","colonmonetary","onefitted","rupiah","Tildesmall","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","exclamdownsmall","centoldstyle","Lslashsmall","","","Scaronsmall","Zcaronsmall","Dieresissmall","Brevesmall","Caronsmall","","Dotaccentsmall","","","Macronsmall","","","figuredash","hypheninferior","","","Ogoneksmall","Ringsmall","Cedillasmall","","","","onequarter","onehalf","threequarters","questiondownsmall","oneeighth","threeeighths","fiveeighths","seveneighths","onethird","twothirds","","","zerosuperior","onesuperior","twosuperior","threesuperior","foursuperior","fivesuperior","sixsuperior","sevensuperior","eightsuperior","ninesuperior","zeroinferior","oneinferior","twoinferior","threeinferior","fourinferior","fiveinferior","sixinferior","seveninferior","eightinferior","nineinferior","centinferior","dollarinferior","periodinferior","commainferior","Agravesmall","Aacutesmall","Acircumflexsmall","Atildesmall","Adieresissmall","Aringsmall","AEsmall","Ccedillasmall","Egravesmall","Eacutesmall","Ecircumflexsmall","Edieresissmall","Igravesmall","Iacutesmall","Icircumflexsmall","Idieresissmall","Ethsmall","Ntildesmall","Ogravesmall","Oacutesmall","Ocircumflexsmall","Otildesmall","Odieresissmall","OEsmall","Oslashsmall","Ugravesmall","Uacutesmall","Ucircumflexsmall","Udieresissmall","Yacutesmall","Thornsmall","Ydieresissmall"];var Fu=[".notdef",".null","nonmarkingreturn","space","exclam","quotedbl","numbersign","dollar","percent","ampersand","quotesingle","parenleft","parenright","asterisk","plus","comma","hyphen","period","slash","zero","one","two","three","four","five","six","seven","eight","nine","colon","semicolon","less","equal","greater","question","at","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","bracketleft","backslash","bracketright","asciicircum","underscore","grave","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","braceleft","bar","braceright","asciitilde","Adieresis","Aring","Ccedilla","Eacute","Ntilde","Odieresis","Udieresis","aacute","agrave","acircumflex","adieresis","atilde","aring","ccedilla","eacute","egrave","ecircumflex","edieresis","iacute","igrave","icircumflex","idieresis","ntilde","oacute","ograve","ocircumflex","odieresis","otilde","uacute","ugrave","ucircumflex","udieresis","dagger","degree","cent","sterling","section","bullet","paragraph","germandbls","registered","copyright","trademark","acute","dieresis","notequal","AE","Oslash","infinity","plusminus","lessequal","greaterequal","yen","mu","partialdiff","summation","product","pi","integral","ordfeminine","ordmasculine","Omega","ae","oslash","questiondown","exclamdown","logicalnot","radical","florin","approxequal","Delta","guillemotleft","guillemotright","ellipsis","nonbreakingspace","Agrave","Atilde","Otilde","OE","oe","endash","emdash","quotedblleft","quotedblright","quoteleft","quoteright","divide","lozenge","ydieresis","Ydieresis","fraction","currency","guilsinglleft","guilsinglright","fi","fl","daggerdbl","periodcentered","quotesinglbase","quotedblbase","perthousand","Acircumflex","Ecircumflex","Aacute","Edieresis","Egrave","Iacute","Icircumflex","Idieresis","Igrave","Oacute","Ocircumflex","apple","Ograve","Uacute","Ucircumflex","Ugrave","dotlessi","circumflex","tilde","macron","breve","dotaccent","ring","cedilla","hungarumlaut","ogonek","caron","Lslash","lslash","Scaron","scaron","Zcaron","zcaron","brokenbar","Eth","eth","Yacute","yacute","Thorn","thorn","minus","multiply","onesuperior","twosuperior","threesuperior","onehalf","onequarter","threequarters","franc","Gbreve","gbreve","Idotaccent","Scedilla","scedilla","Cacute","cacute","Ccaron","ccaron","dcroat"];function zu(e){this.font=e}zu.prototype.charToGlyphIndex=function(e){var t=e.charCodeAt(0);var n=this.font.glyphs;if(n){for(var r=0;r<n.length;r+=1){var i=n.get(r);for(var a=0;a<i.unicodes.length;a+=1){if(i.unicodes[a]===t){return r}}}}return null};function Nu(e){this.cmap=e}Nu.prototype.charToGlyphIndex=function(e){return this.cmap.glyphIndexMap[e.charCodeAt(0)]||0};function ku(e,t){this.encoding=e;this.charset=t}ku.prototype.charToGlyphIndex=function(e){var t=e.charCodeAt(0);var n=this.encoding[t];return this.charset.indexOf(n)};function Vu(e){var t=this;switch(e.version){case 1:this.names=Fu.slice();break;case 2:this.names=new Array(e.numberOfGlyphs);for(var n=0;n<e.numberOfGlyphs;n++){if(e.glyphNameIndex[n]<Fu.length){t.names[n]=Fu[e.glyphNameIndex[n]]}else{t.names[n]=e.names[e.glyphNameIndex[n]-Fu.length]}}break;case 2.5:this.names=new Array(e.numberOfGlyphs);for(var r=0;r<e.numberOfGlyphs;r++){t.names[r]=Fu[r+e.glyphNameIndex[r]]}break;case 3:this.names=[];break;default:this.names=[];break}}Vu.prototype.nameToGlyphIndex=function(e){return this.names.indexOf(e)};Vu.prototype.glyphIndexToName=function(e){return this.names[e]};function Wu(e){var t;var n=e.tables.cmap.glyphIndexMap;var r=Object.keys(n);for(var i=0;i<r.length;i+=1){var a=r[i];var o=n[a];t=e.glyphs.get(o);t.addUnicode(parseInt(a))}for(var s=0;s<e.glyphs.length;s+=1){t=e.glyphs.get(s);if(e.cffEncoding){if(e.isCIDFont){t.name="gid"+s}else{t.name=e.cffEncoding.charset[s]}}else if(e.glyphNames.names){t.name=e.glyphNames.glyphIndexToName(s)}}}function Gu(e,t,n,r,i){e.beginPath();e.moveTo(t,n);e.lineTo(r,i);e.stroke()}var Hu={line:Gu};function ju(e,t,n,r,i){var a;if((t&r)>0){a=e.parseByte();if((t&i)===0){a=-a}a=n+a}else{if((t&i)>0){a=n}else{a=n+e.parseShort()}}return a}function qu(e,t,n){var r=new Au.Parser(t,n);e.numberOfContours=r.parseShort();e._xMin=r.parseShort();e._yMin=r.parseShort();e._xMax=r.parseShort();e._yMax=r.parseShort();var i;var a;if(e.numberOfContours>0){var o=e.endPointIndices=[];for(var s=0;s<e.numberOfContours;s+=1){o.push(r.parseUShort())}e.instructionLength=r.parseUShort();e.instructions=[];for(var l=0;l<e.instructionLength;l+=1){e.instructions.push(r.parseByte())}var u=o[o.length-1]+1;i=[];for(var h=0;h<u;h+=1){a=r.parseByte();i.push(a);if((a&8)>0){var c=r.parseByte();for(var f=0;f<c;f+=1){i.push(a);h+=1}}}Gl.argument(i.length===u,"Bad flags.");if(o.length>0){var p=[];var d;if(u>0){for(var v=0;v<u;v+=1){a=i[v];d={};d.onCurve=!!(a&1);d.lastPointOfContour=o.indexOf(v)>=0;p.push(d)}var m=0;for(var _=0;_<u;_+=1){a=i[_];d=p[_];d.x=ju(r,a,m,2,16);m=d.x}var g=0;for(var y=0;y<u;y+=1){a=i[y];d=p[y];d.y=ju(r,a,g,4,32);g=d.y}}e.points=p}else{e.points=[]}}else if(e.numberOfContours===0){e.points=[]}else{e.isComposite=true;e.points=[];e.components=[];var x=true;while(x){i=r.parseUShort();var b={glyphIndex:r.parseUShort(),xScale:1,scale01:0,scale10:0,yScale:1,dx:0,dy:0};if((i&1)>0){if((i&2)>0){b.dx=r.parseShort();b.dy=r.parseShort()}else{b.matchedPoints=[r.parseUShort(),r.parseUShort()]}}else{if((i&2)>0){b.dx=r.parseChar();b.dy=r.parseChar()}else{b.matchedPoints=[r.parseByte(),r.parseByte()]}}if((i&8)>0){b.xScale=b.yScale=r.parseF2Dot14()}else if((i&64)>0){b.xScale=r.parseF2Dot14();b.yScale=r.parseF2Dot14()}else if((i&128)>0){b.xScale=r.parseF2Dot14();b.scale01=r.parseF2Dot14();b.scale10=r.parseF2Dot14();b.yScale=r.parseF2Dot14()}e.components.push(b);x=!!(i&32)}if(i&256){e.instructionLength=r.parseUShort();e.instructions=[];for(var w=0;w<e.instructionLength;w+=1){e.instructions.push(r.parseByte())}}}}function Xu(e,t){var n=[];for(var r=0;r<e.length;r+=1){var i=e[r];var a={x:t.xScale*i.x+t.scale01*i.y+t.dx,y:t.scale10*i.x+t.yScale*i.y+t.dy,onCurve:i.onCurve,lastPointOfContour:i.lastPointOfContour};n.push(a)}return n}function Yu(e){var t=[];var n=[];for(var r=0;r<e.length;r+=1){var i=e[r];n.push(i);if(i.lastPointOfContour){t.push(n);n=[]}}Gl.argument(n.length===0,"There are still points left in the current contour.");return t}function Ku(e){var t=new kl;if(!e){return t}var n=Yu(e);for(var r=0;r<n.length;++r){var i=n[r];var a=null;var o=i[i.length-1];var s=i[0];if(o.onCurve){t.moveTo(o.x,o.y)}else{if(s.onCurve){t.moveTo(s.x,s.y)}else{var l={x:(o.x+s.x)*.5,y:(o.y+s.y)*.5};t.moveTo(l.x,l.y)}}for(var u=0;u<i.length;++u){a=o;o=s;s=i[(u+1)%i.length];if(o.onCurve){t.lineTo(o.x,o.y)}else{var h=a;var c=s;if(!a.onCurve){h={x:(o.x+a.x)*.5,y:(o.y+a.y)*.5};t.lineTo(h.x,h.y)}if(!s.onCurve){c={x:(o.x+s.x)*.5,y:(o.y+s.y)*.5}}t.lineTo(h.x,h.y);t.quadraticCurveTo(o.x,o.y,c.x,c.y)}}t.closePath()}return t}function Zu(e,t){if(t.isComposite){for(var n=0;n<t.components.length;n+=1){var r=t.components[n];var i=e.get(r.glyphIndex);i.getPath();if(i.points){var a=void 0;if(r.matchedPoints===undefined){a=Xu(i.points,r)}else{if(r.matchedPoints[0]>t.points.length-1||r.matchedPoints[1]>i.points.length-1){throw Error("Matched points out of range in "+t.name)}var o=t.points[r.matchedPoints[0]];var s=i.points[r.matchedPoints[1]];var l={xScale:r.xScale,scale01:r.scale01,scale10:r.scale10,yScale:r.yScale,dx:0,dy:0};s=Xu([s],l)[0];l.dx=o.x-s.x;l.dy=o.y-s.y;a=Xu(i.points,l)}t.points=t.points.concat(a)}}}return Ku(t.points)}function Qu(e,t,n,r){var i=new oh.GlyphSet(r);for(var a=0;a<n.length-1;a+=1){var o=n[a];var s=n[a+1];if(o!==s){i.push(a,oh.ttfGlyphLoader(r,a,qu,e,t+o,Zu))}else{i.push(a,oh.glyphLoader(r,a))}}return i}var Ju={getPath:Ku,parse:Qu};function $u(e,t){var n=t||{commands:[]};return{configurable:true,get:function(){if(typeof n==="function"){n=n()}return n},set:function(e){n=e}}}function eh(e){this.bindConstructorValues(e)}eh.prototype.bindConstructorValues=function(e){this.index=e.index||0;this.name=e.name||null;this.unicode=e.unicode||undefined;this.unicodes=e.unicodes||e.unicode!==undefined?[e.unicode]:[];if(e.xMin){this.xMin=e.xMin}if(e.yMin){this.yMin=e.yMin}if(e.xMax){this.xMax=e.xMax}if(e.yMax){this.yMax=e.yMax}if(e.advanceWidth){this.advanceWidth=e.advanceWidth}Object.defineProperty(this,"path",$u(this,e.path))};eh.prototype.addUnicode=function(e){if(this.unicodes.length===0){this.unicode=e}this.unicodes.push(e)};eh.prototype.getBoundingBox=function(){return this.path.getBoundingBox()};eh.prototype.getPath=function(e,t,n,r,i){e=e!==undefined?e:0;t=t!==undefined?t:0;n=n!==undefined?n:72;var a;var o;if(!r){r={}}var s=r.xScale;var l=r.yScale;if(r.hinting&&i&&i.hinting){o=this.path&&i.hinting.exec(this,n)}if(o){a=Ju.getPath(o).commands;e=Math.round(e);t=Math.round(t);s=l=1}else{a=this.path.commands;var u=1/this.path.unitsPerEm*n;if(s===undefined){s=u}if(l===undefined){l=u}}var h=new kl;for(var c=0;c<a.length;c+=1){var f=a[c];if(f.type==="M"){h.moveTo(e+f.x*s,t+-f.y*l)}else if(f.type==="L"){h.lineTo(e+f.x*s,t+-f.y*l)}else if(f.type==="Q"){h.quadraticCurveTo(e+f.x1*s,t+-f.y1*l,e+f.x*s,t+-f.y*l)}else if(f.type==="C"){h.curveTo(e+f.x1*s,t+-f.y1*l,e+f.x2*s,t+-f.y2*l,e+f.x*s,t+-f.y*l)}else if(f.type==="Z"){h.closePath()}}return h};eh.prototype.getContours=function(){var e=this;if(this.points===undefined){return[]}var t=[];var n=[];for(var r=0;r<this.points.length;r+=1){var i=e.points[r];n.push(i);if(i.lastPointOfContour){t.push(n);n=[]}}Gl.argument(n.length===0,"There are still points left in the current contour.");return t};eh.prototype.getMetrics=function(){var e=this.path.commands;var t=[];var n=[];for(var r=0;r<e.length;r+=1){var i=e[r];if(i.type!=="Z"){t.push(i.x);n.push(i.y)}if(i.type==="Q"||i.type==="C"){t.push(i.x1);n.push(i.y1)}if(i.type==="C"){t.push(i.x2);n.push(i.y2)}}var a={xMin:Math.min.apply(null,t),yMin:Math.min.apply(null,n),xMax:Math.max.apply(null,t),yMax:Math.max.apply(null,n),leftSideBearing:this.leftSideBearing};if(!isFinite(a.xMin)){a.xMin=0}if(!isFinite(a.xMax)){a.xMax=this.advanceWidth}if(!isFinite(a.yMin)){a.yMin=0}if(!isFinite(a.yMax)){a.yMax=0}a.rightSideBearing=this.advanceWidth-a.leftSideBearing-(a.xMax-a.xMin);return a};eh.prototype.draw=function(e,t,n,r,i){this.getPath(t,n,r,i).draw(e)};eh.prototype.drawPoints=function(o,e,t,n){function r(e,t,n,r){var i=Math.PI*2;o.beginPath();for(var a=0;a<e.length;a+=1){o.moveTo(t+e[a].x*r,n+e[a].y*r);o.arc(t+e[a].x*r,n+e[a].y*r,2,0,i,false)}o.closePath();o.fill()}e=e!==undefined?e:0;t=t!==undefined?t:0;n=n!==undefined?n:24;var i=1/this.path.unitsPerEm*n;var a=[];var s=[];var l=this.path;for(var u=0;u<l.commands.length;u+=1){var h=l.commands[u];if(h.x!==undefined){a.push({x:h.x,y:-h.y})}if(h.x1!==undefined){s.push({x:h.x1,y:-h.y1})}if(h.x2!==undefined){s.push({x:h.x2,y:-h.y2})}}o.fillStyle="blue";r(a,e,t,i);o.fillStyle="red";r(s,e,t,i)};eh.prototype.drawMetrics=function(e,t,n,r){var i;t=t!==undefined?t:0;n=n!==undefined?n:0;r=r!==undefined?r:24;i=1/this.path.unitsPerEm*r;e.lineWidth=1;e.strokeStyle="black";Hu.line(e,t,-1e4,t,1e4);Hu.line(e,-1e4,n,1e4,n);var a=this.xMin||0;var o=this.yMin||0;var s=this.xMax||0;var l=this.yMax||0;var u=this.advanceWidth||0;e.strokeStyle="blue";Hu.line(e,t+a*i,-1e4,t+a*i,1e4);Hu.line(e,t+s*i,-1e4,t+s*i,1e4);Hu.line(e,-1e4,n+-o*i,1e4,n+-o*i);Hu.line(e,-1e4,n+-l*i,1e4,n+-l*i);e.strokeStyle="green";Hu.line(e,t+u*i,-1e4,t+u*i,1e4)};function th(t,e,n){Object.defineProperty(t,e,{get:function(){t.path;return t[n]},set:function(e){t[n]=e},enumerable:true,configurable:true})}function nh(e,t){var n=this;this.font=e;this.glyphs={};if(Array.isArray(t)){for(var r=0;r<t.length;r++){n.glyphs[r]=t[r]}}this.length=t&&t.length||0}nh.prototype.get=function(e){if(typeof this.glyphs[e]==="function"){this.glyphs[e]=this.glyphs[e]()}return this.glyphs[e]};nh.prototype.push=function(e,t){this.glyphs[e]=t;this.length++};function rh(e,t){return new eh({index:t,font:e})}function ih(n,e,r,i,a,o){return function(){var t=new eh({index:e,font:n});t.path=function(){r(t,i,a);var e=o(n.glyphs,t);e.unitsPerEm=n.unitsPerEm;return e};th(t,"xMin","_xMin");th(t,"xMax","_xMax");th(t,"yMin","_yMin");th(t,"yMax","_yMax");return t}}function ah(n,e,r,i){return function(){var t=new eh({index:e,font:n});t.path=function(){var e=r(n,t,i);e.unitsPerEm=n.unitsPerEm;return e};return t}}var oh={GlyphSet:nh,glyphLoader:rh,ttfGlyphLoader:ih,cffGlyphLoader:ah};function sh(e,t){if(e===t){return true}else if(Array.isArray(e)&&Array.isArray(t)){if(e.length!==t.length){return false}for(var n=0;n<e.length;n+=1){if(!sh(e[n],t[n])){return false}}return true}else{return false}}function lh(e){var t;if(e.length<1240){t=107}else if(e.length<33900){t=1131}else{t=32768}return t}function uh(e,t,n){var r=[];var i=[];var a=Au.getCard16(e,t);var o;var s;if(a!==0){var l=Au.getByte(e,t+2);o=t+(a+1)*l+2;var u=t+3;for(var h=0;h<a+1;h+=1){r.push(Au.getOffset(e,u,l));u+=l}s=o+r[a]}else{s=t+2}for(var c=0;c<r.length-1;c+=1){var f=Au.getBytes(e,o+r[c],o+r[c+1]);if(n){f=n(f)}i.push(f)}return{objects:i,startOffset:t,endOffset:s}}function hh(e){var t="";var n=15;var r=["0","1","2","3","4","5","6","7","8","9",".","E","E-",null,"-"];while(true){var i=e.parseByte();var a=i>>4;var o=i&15;if(a===n){break}t+=r[a];if(o===n){break}t+=r[o]}return parseFloat(t)}function ch(e,t){var n;var r;var i;var a;if(t===28){n=e.parseByte();r=e.parseByte();return n<<8|r}if(t===29){n=e.parseByte();r=e.parseByte();i=e.parseByte();a=e.parseByte();return n<<24|r<<16|i<<8|a}if(t===30){return hh(e)}if(t>=32&&t<=246){return t-139}if(t>=247&&t<=250){n=e.parseByte();return(t-247)*256+n+108}if(t>=251&&t<=254){n=e.parseByte();return-(t-251)*256-n-108}throw new Error("Invalid b0 "+t)}function fh(e){var t={};for(var n=0;n<e.length;n+=1){var r=e[n][0];var i=e[n][1];var a=void 0;if(i.length===1){a=i[0]}else{a=i}if(t.hasOwnProperty(r)&&!isNaN(t[r])){throw new Error("Object "+t+" already has key "+r)}t[r]=a}return t}function ph(e,t,n){t=t!==undefined?t:0;var r=new Au.Parser(e,t);var i=[];var a=[];n=n!==undefined?n:e.length;while(r.relativeOffset<n){var o=r.parseByte();if(o<=21){if(o===12){o=1200+r.parseByte()}i.push([o,a]);a=[]}else{a.push(ch(r,o))}}return fh(i)}function dh(e,t){if(t<=390){t=Pu[t]}else{t=e[t-391]}return t}function vh(e,t,n){var r={};var i;for(var a=0;a<t.length;a+=1){var o=t[a];if(Array.isArray(o.type)){var s=[];s.length=o.type.length;for(var l=0;l<o.type.length;l++){i=e[o.op]!==undefined?e[o.op][l]:undefined;if(i===undefined){i=o.value!==undefined&&o.value[l]!==undefined?o.value[l]:null}if(o.type[l]==="SID"){i=dh(n,i)}s[l]=i}r[o.name]=s}else{i=e[o.op];if(i===undefined){i=o.value!==undefined?o.value:null}if(o.type==="SID"){i=dh(n,i)}r[o.name]=i}}return r}function mh(e,t){var n={};n.formatMajor=Au.getCard8(e,t);n.formatMinor=Au.getCard8(e,t+1);n.size=Au.getCard8(e,t+2);n.offsetSize=Au.getCard8(e,t+3);n.startOffset=t;n.endOffset=t+4;return n}var _h=[{name:"version",op:0,type:"SID"},{name:"notice",op:1,type:"SID"},{name:"copyright",op:1200,type:"SID"},{name:"fullName",op:2,type:"SID"},{name:"familyName",op:3,type:"SID"},{name:"weight",op:4,type:"SID"},{name:"isFixedPitch",op:1201,type:"number",value:0},{name:"italicAngle",op:1202,type:"number",value:0},{name:"underlinePosition",op:1203,type:"number",value:-100},{name:"underlineThickness",op:1204,type:"number",value:50},{name:"paintType",op:1205,type:"number",value:0},{name:"charstringType",op:1206,type:"number",value:2},{name:"fontMatrix",op:1207,type:["real","real","real","real","real","real"],value:[.001,0,0,.001,0,0]},{name:"uniqueId",op:13,type:"number"},{name:"fontBBox",op:5,type:["number","number","number","number"],value:[0,0,0,0]},{name:"strokeWidth",op:1208,type:"number",value:0},{name:"xuid",op:14,type:[],value:null},{name:"charset",op:15,type:"offset",value:0},{name:"encoding",op:16,type:"offset",value:0},{name:"charStrings",op:17,type:"offset",value:0},{name:"private",op:18,type:["number","offset"],value:[0,0]},{name:"ros",op:1230,type:["SID","SID","number"]},{name:"cidFontVersion",op:1231,type:"number",value:0},{name:"cidFontRevision",op:1232,type:"number",value:0},{name:"cidFontType",op:1233,type:"number",value:0},{name:"cidCount",op:1234,type:"number",value:8720},{name:"uidBase",op:1235,type:"number"},{name:"fdArray",op:1236,type:"offset"},{name:"fdSelect",op:1237,type:"offset"},{name:"fontName",op:1238,type:"SID"}];var gh=[{name:"subrs",op:19,type:"offset",value:0},{name:"defaultWidthX",op:20,type:"number",value:0},{name:"nominalWidthX",op:21,type:"number",value:0}];function yh(e,t){var n=ph(e,0,e.byteLength);return vh(n,_h,t)}function xh(e,t,n,r){var i=ph(e,t,n);return vh(i,gh,r)}function bh(e,t,n,r){var i=[];for(var a=0;a<n.length;a+=1){var o=new DataView(new Uint8Array(n[a]).buffer);var s=yh(o,r);s._subrs=[];s._subrsBias=0;var l=s.private[0];var u=s.private[1];if(l!==0&&u!==0){var h=xh(e,u+t,l,r);s._defaultWidthX=h.defaultWidthX;s._nominalWidthX=h.nominalWidthX;if(h.subrs!==0){var c=u+h.subrs;var f=uh(e,c+t);s._subrs=f.objects;s._subrsBias=lh(s._subrs)}s._privateDict=h}i.push(s)}return i}function wh(e,t,n,r){var i;var a;var o=new Au.Parser(e,t);n-=1;var s=[".notdef"];var l=o.parseCard8();if(l===0){for(var u=0;u<n;u+=1){i=o.parseSID();s.push(dh(r,i))}}else if(l===1){while(s.length<=n){i=o.parseSID();a=o.parseCard8();for(var h=0;h<=a;h+=1){s.push(dh(r,i));i+=1}}}else if(l===2){while(s.length<=n){i=o.parseSID();a=o.parseCard16();for(var c=0;c<=a;c+=1){s.push(dh(r,i));i+=1}}}else{throw new Error("Unknown charset format "+l)}return s}function Eh(e,t,n){var r;var i={};var a=new Au.Parser(e,t);var o=a.parseCard8();if(o===0){var s=a.parseCard8();for(var l=0;l<s;l+=1){r=a.parseCard8();i[r]=l}}else if(o===1){var u=a.parseCard8();r=1;for(var h=0;h<u;h+=1){var c=a.parseCard8();var f=a.parseCard8();for(var p=c;p<=c+f;p+=1){i[p]=r;r+=1}}}else{throw new Error("Unknown encoding format "+o)}return new ku(i,n)}function Th(v,m,e){var _;var g;var y;var x;var b=new kl;var w=[];var E=0;var T=false;var S=false;var A=0;var M=0;var R;var L;var t;var C;if(v.isCIDFont){var n=v.tables.cff.topDict._fdSelect[m.index];var r=v.tables.cff.topDict._fdArray[n];R=r._subrs;L=r._subrsBias;t=r._defaultWidthX;C=r._nominalWidthX}else{R=v.tables.cff.topDict._subrs;L=v.tables.cff.topDict._subrsBias;t=v.tables.cff.topDict._defaultWidthX;C=v.tables.cff.topDict._nominalWidthX}var O=t;function I(e,t){if(S){b.closePath()}b.moveTo(e,t);S=true}function U(){var e;e=w.length%2!==0;if(e&&!T){O=w.shift()+C}E+=w.length>>1;w.length=0;T=true}function P(e){var t;var n;var r;var i;var a;var o;var s;var l;var u;var h;var c;var f;var p=0;while(p<e.length){var d=e[p];p+=1;switch(d){case 1:U();break;case 3:U();break;case 4:if(w.length>1&&!T){O=w.shift()+C;T=true}M+=w.pop();I(A,M);break;case 5:while(w.length>0){A+=w.shift();M+=w.shift();b.lineTo(A,M)}break;case 6:while(w.length>0){A+=w.shift();b.lineTo(A,M);if(w.length===0){break}M+=w.shift();b.lineTo(A,M)}break;case 7:while(w.length>0){M+=w.shift();b.lineTo(A,M);if(w.length===0){break}A+=w.shift();b.lineTo(A,M)}break;case 8:while(w.length>0){_=A+w.shift();g=M+w.shift();y=_+w.shift();x=g+w.shift();A=y+w.shift();M=x+w.shift();b.curveTo(_,g,y,x,A,M)}break;case 10:a=w.pop()+L;o=R[a];if(o){P(o)}break;case 11:return;case 12:d=e[p];p+=1;switch(d){case 35:_=A+w.shift();g=M+w.shift();y=_+w.shift();x=g+w.shift();s=y+w.shift();l=x+w.shift();u=s+w.shift();h=l+w.shift();c=u+w.shift();f=h+w.shift();A=c+w.shift();M=f+w.shift();w.shift();b.curveTo(_,g,y,x,s,l);b.curveTo(u,h,c,f,A,M);break;case 34:_=A+w.shift();g=M;y=_+w.shift();x=g+w.shift();s=y+w.shift();l=x;u=s+w.shift();h=x;c=u+w.shift();f=M;A=c+w.shift();b.curveTo(_,g,y,x,s,l);b.curveTo(u,h,c,f,A,M);break;case 36:_=A+w.shift();g=M+w.shift();y=_+w.shift();x=g+w.shift();s=y+w.shift();l=x;u=s+w.shift();h=x;c=u+w.shift();f=h+w.shift();A=c+w.shift();b.curveTo(_,g,y,x,s,l);b.curveTo(u,h,c,f,A,M);break;case 37:_=A+w.shift();g=M+w.shift();y=_+w.shift();x=g+w.shift();s=y+w.shift();l=x+w.shift();u=s+w.shift();h=l+w.shift();c=u+w.shift();f=h+w.shift();if(Math.abs(c-A)>Math.abs(f-M)){A=c+w.shift()}else{M=f+w.shift()}b.curveTo(_,g,y,x,s,l);b.curveTo(u,h,c,f,A,M);break;default:console.log("Glyph "+m.index+": unknown operator "+1200+d);w.length=0}break;case 14:if(w.length>0&&!T){O=w.shift()+C;T=true}if(S){b.closePath();S=false}break;case 18:U();break;case 19:case 20:U();p+=E+7>>3;break;case 21:if(w.length>2&&!T){O=w.shift()+C;T=true}M+=w.pop();A+=w.pop();I(A,M);break;case 22:if(w.length>1&&!T){O=w.shift()+C;T=true}A+=w.pop();I(A,M);break;case 23:U();break;case 24:while(w.length>2){_=A+w.shift();g=M+w.shift();y=_+w.shift();x=g+w.shift();A=y+w.shift();M=x+w.shift();b.curveTo(_,g,y,x,A,M)}A+=w.shift();M+=w.shift();b.lineTo(A,M);break;case 25:while(w.length>6){A+=w.shift();M+=w.shift();b.lineTo(A,M)}_=A+w.shift();g=M+w.shift();y=_+w.shift();x=g+w.shift();A=y+w.shift();M=x+w.shift();b.curveTo(_,g,y,x,A,M);break;case 26:if(w.length%2){A+=w.shift()}while(w.length>0){_=A;g=M+w.shift();y=_+w.shift();x=g+w.shift();A=y;M=x+w.shift();b.curveTo(_,g,y,x,A,M)}break;case 27:if(w.length%2){M+=w.shift()}while(w.length>0){_=A+w.shift();g=M;y=_+w.shift();x=g+w.shift();A=y+w.shift();M=x;b.curveTo(_,g,y,x,A,M)}break;case 28:t=e[p];n=e[p+1];w.push((t<<24|n<<16)>>16);p+=2;break;case 29:a=w.pop()+v.gsubrsBias;o=v.gsubrs[a];if(o){P(o)}break;case 30:while(w.length>0){_=A;g=M+w.shift();y=_+w.shift();x=g+w.shift();A=y+w.shift();M=x+(w.length===1?w.shift():0);b.curveTo(_,g,y,x,A,M);if(w.length===0){break}_=A+w.shift();g=M;y=_+w.shift();x=g+w.shift();M=x+w.shift();A=y+(w.length===1?w.shift():0);b.curveTo(_,g,y,x,A,M)}break;case 31:while(w.length>0){_=A+w.shift();g=M;y=_+w.shift();x=g+w.shift();M=x+w.shift();A=y+(w.length===1?w.shift():0);b.curveTo(_,g,y,x,A,M);if(w.length===0){break}_=A;g=M+w.shift();y=_+w.shift();x=g+w.shift();A=y+w.shift();M=x+(w.length===1?w.shift():0);b.curveTo(_,g,y,x,A,M)}break;default:if(d<32){console.log("Glyph "+m.index+": unknown operator "+d)}else if(d<247){w.push(d-139)}else if(d<251){t=e[p];p+=1;w.push((d-247)*256+t+108)}else if(d<255){t=e[p];p+=1;w.push(-(d-251)*256-t-108)}else{t=e[p];n=e[p+1];r=e[p+2];i=e[p+3];p+=4;w.push((t<<24|n<<16|r<<8|i)/65536)}}}}P(e);m.advanceWidth=O;return b}function Sh(e,t,n,r){var i=[];var a;var o=new Au.Parser(e,t);var s=o.parseCard8();if(s===0){for(var l=0;l<n;l++){a=o.parseCard8();if(a>=r){throw new Error("CFF table CID Font FDSelect has bad FD index value "+a+" (FD count "+r+")")}i.push(a)}}else if(s===3){var u=o.parseCard16();var h=o.parseCard16();if(h!==0){throw new Error("CFF Table CID Font FDSelect format 3 range has bad initial GID "+h)}var c;for(var f=0;f<u;f++){a=o.parseCard8();c=o.parseCard16();if(a>=r){throw new Error("CFF table CID Font FDSelect has bad FD index value "+a+" (FD count "+r+")")}if(c>n){throw new Error("CFF Table CID Font FDSelect format 3 range has bad GID "+c)}for(;h<c;h++){i.push(a)}h=c}if(c!==n){throw new Error("CFF Table CID Font FDSelect format 3 range has bad final GID "+c)}}else{throw new Error("CFF Table CID Font FDSelect table has unsupported format "+s)}return i}function Ah(e,t,n){n.tables.cff={};var r=mh(e,t);var i=uh(e,r.endOffset,Au.bytesToString);var a=uh(e,i.endOffset);var o=uh(e,a.endOffset,Au.bytesToString);var s=uh(e,o.endOffset);n.gsubrs=s.objects;n.gsubrsBias=lh(n.gsubrs);var l=bh(e,t,a.objects,o.objects);if(l.length!==1){throw new Error("CFF table has too many fonts in 'FontSet' - count of fonts NameIndex.length = "+l.length)}var u=l[0];n.tables.cff.topDict=u;if(u._privateDict){n.defaultWidthX=u._privateDict.defaultWidthX;n.nominalWidthX=u._privateDict.nominalWidthX}if(u.ros[0]!==undefined&&u.ros[1]!==undefined){n.isCIDFont=true}if(n.isCIDFont){var h=u.fdArray;var c=u.fdSelect;if(h===0||c===0){throw new Error("Font is marked as a CID font, but FDArray and/or FDSelect information is missing")}h+=t;var f=uh(e,h);var p=bh(e,t,f.objects,o.objects);u._fdArray=p;c+=t;u._fdSelect=Sh(e,c,n.numGlyphs,p.length)}var d=t+u.private[1];var v=xh(e,d,u.private[0],o.objects);n.defaultWidthX=v.defaultWidthX;n.nominalWidthX=v.nominalWidthX;if(v.subrs!==0){var m=d+v.subrs;var _=uh(e,m);n.subrs=_.objects;n.subrsBias=lh(n.subrs)}else{n.subrs=[];n.subrsBias=0}var g=uh(e,t+u.charStrings);n.nGlyphs=g.objects.length;var y=wh(e,t+u.charset,n.nGlyphs,o.objects);if(u.encoding===0){n.cffEncoding=new ku(Bu,y)}else if(u.encoding===1){n.cffEncoding=new ku(Du,y)}else{n.cffEncoding=Eh(e,t+u.encoding,y)}n.encoding=n.encoding||n.cffEncoding;n.glyphs=new oh.GlyphSet(n);for(var x=0;x<n.nGlyphs;x+=1){var b=g.objects[x];n.glyphs.push(x,oh.cffGlyphLoader(n,x,Th,b))}}function Mh(e,t){var n;var r=Pu.indexOf(e);if(r>=0){n=r}r=t.indexOf(e);if(r>=0){n=r+Pu.length}else{n=Pu.length+t.length;t.push(e)}return n}function Rh(){return new pu.Record("Header",[{name:"major",type:"Card8",value:1},{name:"minor",type:"Card8",value:0},{name:"hdrSize",type:"Card8",value:4},{name:"major",type:"Card8",value:1}])}function Lh(e){var t=new pu.Record("Name INDEX",[{name:"names",type:"INDEX",value:[]}]);t.names=[];for(var n=0;n<e.length;n+=1){t.names.push({name:"name_"+n,type:"NAME",value:e[n]})}return t}function Ch(e,t,n){var r={};for(var i=0;i<e.length;i+=1){var a=e[i];var o=t[a.name];if(o!==undefined&&!sh(o,a.value)){if(a.type==="SID"){o=Mh(o,n)}r[a.op]={name:a.name,type:a.type,value:o}}}return r}function Oh(e,t){var n=new pu.Record("Top DICT",[{name:"dict",type:"DICT",value:{}}]);n.dict=Ch(_h,e,t);return n}function Ih(e){var t=new pu.Record("Top DICT INDEX",[{name:"topDicts",type:"INDEX",value:[]}]);t.topDicts=[{name:"topDict_0",type:"TABLE",value:e}];return t}function Uh(e){var t=new pu.Record("String INDEX",[{name:"strings",type:"INDEX",value:[]}]);t.strings=[];for(var n=0;n<e.length;n+=1){t.strings.push({name:"string_"+n,type:"STRING",value:e[n]})}return t}function Ph(){return new pu.Record("Global Subr INDEX",[{name:"subrs",type:"INDEX",value:[]}])}function Bh(e,t){var n=new pu.Record("Charsets",[{name:"format",type:"Card8",value:0}]);for(var r=0;r<e.length;r+=1){var i=e[r];var a=Mh(i,t);n.fields.push({name:"glyph_"+r,type:"SID",value:a})}return n}function Dh(e){var t=[];var n=e.path;t.push({name:"width",type:"NUMBER",value:e.advanceWidth});var r=0;var i=0;for(var a=0;a<n.commands.length;a+=1){var o=void 0;var s=void 0;var l=n.commands[a];if(l.type==="Q"){var u=1/3;var h=2/3;l={type:"C",x:l.x,y:l.y,x1:u*r+h*l.x1,y1:u*i+h*l.y1,x2:u*l.x+h*l.x1,y2:u*l.y+h*l.y1}}if(l.type==="M"){o=Math.round(l.x-r);s=Math.round(l.y-i);t.push({name:"dx",type:"NUMBER",value:o});t.push({name:"dy",type:"NUMBER",value:s});t.push({name:"rmoveto",type:"OP",value:21});r=Math.round(l.x);i=Math.round(l.y)}else if(l.type==="L"){o=Math.round(l.x-r);s=Math.round(l.y-i);t.push({name:"dx",type:"NUMBER",value:o});t.push({name:"dy",type:"NUMBER",value:s});t.push({name:"rlineto",type:"OP",value:5});r=Math.round(l.x);i=Math.round(l.y)}else if(l.type==="C"){var c=Math.round(l.x1-r);var f=Math.round(l.y1-i);var p=Math.round(l.x2-l.x1);var d=Math.round(l.y2-l.y1);o=Math.round(l.x-l.x2);s=Math.round(l.y-l.y2);t.push({name:"dx1",type:"NUMBER",value:c});t.push({name:"dy1",type:"NUMBER",value:f});t.push({name:"dx2",type:"NUMBER",value:p});t.push({name:"dy2",type:"NUMBER",value:d});t.push({name:"dx",type:"NUMBER",value:o});t.push({name:"dy",type:"NUMBER",value:s});t.push({name:"rrcurveto",type:"OP",value:8});r=Math.round(l.x);i=Math.round(l.y)}}t.push({name:"endchar",type:"OP",value:14});return t}function Fh(e){var t=new pu.Record("CharStrings INDEX",[{name:"charStrings",type:"INDEX",value:[]}]);for(var n=0;n<e.length;n+=1){var r=e.get(n);var i=Dh(r);t.charStrings.push({name:r.name,type:"CHARSTRING",value:i})}return t}function zh(e,t){var n=new pu.Record("Private DICT",[{name:"dict",type:"DICT",value:{}}]);n.dict=Ch(gh,e,t);return n}function Nh(e,t){var n=new pu.Table("CFF ",[{name:"header",type:"RECORD"},{name:"nameIndex",type:"RECORD"},{name:"topDictIndex",type:"RECORD"},{name:"stringIndex",type:"RECORD"},{name:"globalSubrIndex",type:"RECORD"},{name:"charsets",type:"RECORD"},{name:"charStringsIndex",type:"RECORD"},{name:"privateDict",type:"RECORD"}]);var r=1/t.unitsPerEm;var i={version:t.version,fullName:t.fullName,familyName:t.familyName,weight:t.weightName,fontBBox:t.fontBBox||[0,0,0,0],fontMatrix:[r,0,0,r,0,0],charset:999,encoding:0,charStrings:999,private:[0,999]};var a={};var o=[];var s;for(var l=1;l<e.length;l+=1){s=e.get(l);o.push(s.name)}var u=[];n.header=Rh();n.nameIndex=Lh([t.postScriptName]);var h=Oh(i,u);n.topDictIndex=Ih(h);n.globalSubrIndex=Ph();n.charsets=Bh(o,u);n.charStringsIndex=Fh(e);n.privateDict=zh(a,u);n.stringIndex=Uh(u);var c=n.header.sizeOf()+n.nameIndex.sizeOf()+n.topDictIndex.sizeOf()+n.stringIndex.sizeOf()+n.globalSubrIndex.sizeOf();i.charset=c;i.encoding=0;i.charStrings=i.charset+n.charsets.sizeOf();i.private[1]=i.charStrings+n.charStringsIndex.sizeOf();h=Oh(i,u);n.topDictIndex=Ih(h);return n}var kh={parse:Ah,make:Nh};function Vh(e,t){var n={};var r=new Au.Parser(e,t);n.version=r.parseVersion();n.fontRevision=Math.round(r.parseFixed()*1e3)/1e3;n.checkSumAdjustment=r.parseULong();n.magicNumber=r.parseULong();Gl.argument(n.magicNumber===1594834165,"Font header has wrong magic number.");n.flags=r.parseUShort();n.unitsPerEm=r.parseUShort();n.created=r.parseLongDateTime();n.modified=r.parseLongDateTime();n.xMin=r.parseShort();n.yMin=r.parseShort();n.xMax=r.parseShort();n.yMax=r.parseShort();n.macStyle=r.parseUShort();n.lowestRecPPEM=r.parseUShort();n.fontDirectionHint=r.parseShort();n.indexToLocFormat=r.parseShort();n.glyphDataFormat=r.parseShort();return n}function Wh(e){var t=Math.round((new Date).getTime()/1e3)+2082844800;var n=t;if(e.createdTimestamp){n=e.createdTimestamp+2082844800}return new pu.Table("head",[{name:"version",type:"FIXED",value:65536},{name:"fontRevision",type:"FIXED",value:65536},{name:"checkSumAdjustment",type:"ULONG",value:0},{name:"magicNumber",type:"ULONG",value:1594834165},{name:"flags",type:"USHORT",value:0},{name:"unitsPerEm",type:"USHORT",value:1e3},{name:"created",type:"LONGDATETIME",value:n},{name:"modified",type:"LONGDATETIME",value:t},{name:"xMin",type:"SHORT",value:0},{name:"yMin",type:"SHORT",value:0},{name:"xMax",type:"SHORT",value:0},{name:"yMax",type:"SHORT",value:0},{name:"macStyle",type:"USHORT",value:0},{name:"lowestRecPPEM",type:"USHORT",value:0},{name:"fontDirectionHint",type:"SHORT",value:2},{name:"indexToLocFormat",type:"SHORT",value:0},{name:"glyphDataFormat",type:"SHORT",value:0}],e)}var Gh={parse:Vh,make:Wh};function Hh(e,t){var n={};var r=new Au.Parser(e,t);n.version=r.parseVersion();n.ascender=r.parseShort();n.descender=r.parseShort();n.lineGap=r.parseShort();n.advanceWidthMax=r.parseUShort();n.minLeftSideBearing=r.parseShort();n.minRightSideBearing=r.parseShort();n.xMaxExtent=r.parseShort();n.caretSlopeRise=r.parseShort();n.caretSlopeRun=r.parseShort();n.caretOffset=r.parseShort();r.relativeOffset+=8;n.metricDataFormat=r.parseShort();n.numberOfHMetrics=r.parseUShort();return n}function jh(e){return new pu.Table("hhea",[{name:"version",type:"FIXED",value:65536},{name:"ascender",type:"FWORD",value:0},{name:"descender",type:"FWORD",value:0},{name:"lineGap",type:"FWORD",value:0},{name:"advanceWidthMax",type:"UFWORD",value:0},{name:"minLeftSideBearing",type:"FWORD",value:0},{name:"minRightSideBearing",type:"FWORD",value:0},{name:"xMaxExtent",type:"FWORD",value:0},{name:"caretSlopeRise",type:"SHORT",value:1},{name:"caretSlopeRun",type:"SHORT",value:0},{name:"caretOffset",type:"SHORT",value:0},{name:"reserved1",type:"SHORT",value:0},{name:"reserved2",type:"SHORT",value:0},{name:"reserved3",type:"SHORT",value:0},{name:"reserved4",type:"SHORT",value:0},{name:"metricDataFormat",type:"SHORT",value:0},{name:"numberOfHMetrics",type:"USHORT",value:0}],e)}var qh={parse:Hh,make:jh};function Xh(e,t,n,r,i){var a;var o;var s=new Au.Parser(e,t);for(var l=0;l<r;l+=1){if(l<n){a=s.parseUShort();o=s.parseShort()}var u=i.get(l);u.advanceWidth=a;u.leftSideBearing=o}}function Yh(e){var t=new pu.Table("hmtx",[]);for(var n=0;n<e.length;n+=1){var r=e.get(n);var i=r.advanceWidth||0;var a=r.leftSideBearing||0;t.fields.push({name:"advanceWidth_"+n,type:"USHORT",value:i});t.fields.push({name:"leftSideBearing_"+n,type:"SHORT",value:a})}return t}var Kh={parse:Xh,make:Yh};function Zh(e){var t=new pu.Table("ltag",[{name:"version",type:"ULONG",value:1},{name:"flags",type:"ULONG",value:0},{name:"numTags",type:"ULONG",value:e.length}]);var n="";var r=12+e.length*4;for(var i=0;i<e.length;++i){var a=n.indexOf(e[i]);if(a<0){a=n.length;n+=e[i]}t.fields.push({name:"offset "+i,type:"USHORT",value:r+a});t.fields.push({name:"length "+i,type:"USHORT",value:e[i].length})}t.fields.push({name:"stringPool",type:"CHARARRAY",value:n});return t}function Qh(e,t){var n=new Au.Parser(e,t);var r=n.parseULong();Gl.argument(r===1,"Unsupported ltag table version.");n.skip("uLong",1);var i=n.parseULong();var a=[];for(var o=0;o<i;o++){var s="";var l=t+n.parseUShort();var u=n.parseUShort();for(var h=l;h<l+u;++h){s+=String.fromCharCode(e.getInt8(h))}a.push(s)}return a}var Jh={make:Zh,parse:Qh};function $h(e,t){var n={};var r=new Au.Parser(e,t);n.version=r.parseVersion();n.numGlyphs=r.parseUShort();if(n.version===1){n.maxPoints=r.parseUShort();n.maxContours=r.parseUShort();n.maxCompositePoints=r.parseUShort();n.maxCompositeContours=r.parseUShort();n.maxZones=r.parseUShort();n.maxTwilightPoints=r.parseUShort();n.maxStorage=r.parseUShort();n.maxFunctionDefs=r.parseUShort();n.maxInstructionDefs=r.parseUShort();n.maxStackElements=r.parseUShort();n.maxSizeOfInstructions=r.parseUShort();n.maxComponentElements=r.parseUShort();n.maxComponentDepth=r.parseUShort()}return n}function ec(e){return new pu.Table("maxp",[{name:"version",type:"FIXED",value:20480},{name:"numGlyphs",type:"USHORT",value:e}])}var tc={parse:$h,make:ec};var nc=["copyright","fontFamily","fontSubfamily","uniqueID","fullName","version","postScriptName","trademark","manufacturer","designer","description","manufacturerURL","designerURL","license","licenseURL","reserved","preferredFamily","preferredSubfamily","compatibleFullName","sampleText","postScriptFindFontName","wwsFamily","wwsSubfamily"];var rc={0:"en",1:"fr",2:"de",3:"it",4:"nl",5:"sv",6:"es",7:"da",8:"pt",9:"no",10:"he",11:"ja",12:"ar",13:"fi",14:"el",15:"is",16:"mt",17:"tr",18:"hr",19:"zh-Hant",20:"ur",21:"hi",22:"th",23:"ko",24:"lt",25:"pl",26:"hu",27:"es",28:"lv",29:"se",30:"fo",31:"fa",32:"ru",33:"zh",34:"nl-BE",35:"ga",36:"sq",37:"ro",38:"cz",39:"sk",40:"si",41:"yi",42:"sr",43:"mk",44:"bg",45:"uk",46:"be",47:"uz",48:"kk",49:"az-Cyrl",50:"az-Arab",51:"hy",52:"ka",53:"mo",54:"ky",55:"tg",56:"tk",57:"mn-CN",58:"mn",59:"ps",60:"ks",61:"ku",62:"sd",63:"bo",64:"ne",65:"sa",66:"mr",67:"bn",68:"as",69:"gu",70:"pa",71:"or",72:"ml",73:"kn",74:"ta",75:"te",76:"si",77:"my",78:"km",79:"lo",80:"vi",81:"id",82:"tl",83:"ms",84:"ms-Arab",85:"am",86:"ti",87:"om",88:"so",89:"sw",90:"rw",91:"rn",92:"ny",93:"mg",94:"eo",128:"cy",129:"eu",130:"ca",131:"la",132:"qu",133:"gn",134:"ay",135:"tt",136:"ug",137:"dz",138:"jv",139:"su",140:"gl",141:"af",142:"br",143:"iu",144:"gd",145:"gv",146:"ga",147:"to",148:"el-polyton",149:"kl",150:"az",151:"nn"};var ic={0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:5,11:1,12:4,13:0,14:6,15:0,16:0,17:0,18:0,19:2,20:4,21:9,22:21,23:3,24:29,25:29,26:29,27:29,28:29,29:0,30:0,31:4,32:7,33:25,34:0,35:0,36:0,37:0,38:29,39:29,40:0,41:5,42:7,43:7,44:7,45:7,46:7,47:7,48:7,49:7,50:4,51:24,52:23,53:7,54:7,55:7,56:7,57:27,58:7,59:4,60:4,61:4,62:4,63:26,64:9,65:9,66:9,67:13,68:13,69:11,70:10,71:12,72:17,73:16,74:14,75:15,76:18,77:19,78:20,79:22,80:30,81:0,82:0,83:0,84:4,85:28,86:28,87:28,88:0,89:0,90:0,91:0,92:0,93:0,94:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:7,136:4,137:26,138:0,139:0,140:0,141:0,142:0,143:28,144:0,145:0,146:0,147:0,148:6,149:0,150:0,151:0};var ac={1078:"af",1052:"sq",1156:"gsw",1118:"am",5121:"ar-DZ",15361:"ar-BH",3073:"ar",2049:"ar-IQ",11265:"ar-JO",13313:"ar-KW",12289:"ar-LB",4097:"ar-LY",6145:"ary",8193:"ar-OM",16385:"ar-QA",1025:"ar-SA",10241:"ar-SY",7169:"aeb",14337:"ar-AE",9217:"ar-YE",1067:"hy",1101:"as",2092:"az-Cyrl",1068:"az",1133:"ba",1069:"eu",1059:"be",2117:"bn",1093:"bn-IN",8218:"bs-Cyrl",5146:"bs",1150:"br",1026:"bg",1027:"ca",3076:"zh-HK",5124:"zh-MO",2052:"zh",4100:"zh-SG",1028:"zh-TW",1155:"co",1050:"hr",4122:"hr-BA",1029:"cs",1030:"da",1164:"prs",1125:"dv",2067:"nl-BE",1043:"nl",3081:"en-AU",10249:"en-BZ",4105:"en-CA",9225:"en-029",16393:"en-IN",6153:"en-IE",8201:"en-JM",17417:"en-MY",5129:"en-NZ",13321:"en-PH",18441:"en-SG",7177:"en-ZA",11273:"en-TT",2057:"en-GB",1033:"en",12297:"en-ZW",1061:"et",1080:"fo",1124:"fil",1035:"fi",2060:"fr-BE",3084:"fr-CA",1036:"fr",5132:"fr-LU",6156:"fr-MC",4108:"fr-CH",1122:"fy",1110:"gl",1079:"ka",3079:"de-AT",1031:"de",5127:"de-LI",4103:"de-LU",2055:"de-CH",1032:"el",1135:"kl",1095:"gu",1128:"ha",1037:"he",1081:"hi",1038:"hu",1039:"is",1136:"ig",1057:"id",1117:"iu",2141:"iu-Latn",2108:"ga",1076:"xh",1077:"zu",1040:"it",2064:"it-CH",1041:"ja",1099:"kn",1087:"kk",1107:"km",1158:"quc",1159:"rw",1089:"sw",1111:"kok",1042:"ko",1088:"ky",1108:"lo",1062:"lv",1063:"lt",2094:"dsb",1134:"lb",1071:"mk",2110:"ms-BN",1086:"ms",1100:"ml",1082:"mt",1153:"mi",1146:"arn",1102:"mr",1148:"moh",1104:"mn",2128:"mn-CN",1121:"ne",1044:"nb",2068:"nn",1154:"oc",1096:"or",1123:"ps",1045:"pl",1046:"pt",2070:"pt-PT",1094:"pa",1131:"qu-BO",2155:"qu-EC",3179:"qu",1048:"ro",1047:"rm",1049:"ru",9275:"smn",4155:"smj-NO",5179:"smj",3131:"se-FI",1083:"se",2107:"se-SE",8251:"sms",6203:"sma-NO",7227:"sms",1103:"sa",7194:"sr-Cyrl-BA",3098:"sr",6170:"sr-Latn-BA",2074:"sr-Latn",1132:"nso",1074:"tn",1115:"si",1051:"sk",1060:"sl",11274:"es-AR",16394:"es-BO",13322:"es-CL",9226:"es-CO",5130:"es-CR",7178:"es-DO",12298:"es-EC",17418:"es-SV",4106:"es-GT",18442:"es-HN",2058:"es-MX",19466:"es-NI",6154:"es-PA",15370:"es-PY",10250:"es-PE",20490:"es-PR",3082:"es",1034:"es",21514:"es-US",14346:"es-UY",8202:"es-VE",2077:"sv-FI",1053:"sv",1114:"syr",1064:"tg",2143:"tzm",1097:"ta",1092:"tt",1098:"te",1054:"th",1105:"bo",1055:"tr",1090:"tk",1152:"ug",1058:"uk",1070:"hsb",1056:"ur",2115:"uz-Cyrl",1091:"uz",1066:"vi",1106:"cy",1160:"wo",1157:"sah",1144:"ii",1130:"yo"};function oc(e,t,n){switch(e){case 0:if(t===65535){return"und"}else if(n){return n[t]}break;case 1:return rc[t];case 3:return ac[t]}return undefined}var sc="utf-16";var lc={0:"macintosh",1:"x-mac-japanese",2:"x-mac-chinesetrad",3:"x-mac-korean",6:"x-mac-greek",7:"x-mac-cyrillic",9:"x-mac-devanagai",10:"x-mac-gurmukhi",11:"x-mac-gujarati",12:"x-mac-oriya",13:"x-mac-bengali",14:"x-mac-tamil",15:"x-mac-telugu",16:"x-mac-kannada",17:"x-mac-malayalam",18:"x-mac-sinhalese",19:"x-mac-burmese",20:"x-mac-khmer",21:"x-mac-thai",22:"x-mac-lao",23:"x-mac-georgian",24:"x-mac-armenian",25:"x-mac-chinesesimp",26:"x-mac-tibetan",27:"x-mac-mongolian",28:"x-mac-ethiopic",29:"x-mac-ce",30:"x-mac-vietnamese",31:"x-mac-extarabic"};var uc={15:"x-mac-icelandic",17:"x-mac-turkish",18:"x-mac-croatian",24:"x-mac-ce",25:"x-mac-ce",26:"x-mac-ce",27:"x-mac-ce",28:"x-mac-ce",30:"x-mac-icelandic",37:"x-mac-romanian",38:"x-mac-ce",39:"x-mac-ce",40:"x-mac-ce",143:"x-mac-inuit",146:"x-mac-gaelic"};function hc(e,t,n){switch(e){case 0:return sc;case 1:return uc[n]||lc[t];case 3:if(t===1||t===10){return sc}break}return undefined}function cc(e,t,n){var r={};var i=new Au.Parser(e,t);var a=i.parseUShort();var o=i.parseUShort();var s=i.offset+i.parseUShort();for(var l=0;l<o;l++){var u=i.parseUShort();var h=i.parseUShort();var c=i.parseUShort();var f=i.parseUShort();var p=nc[f]||f;var d=i.parseUShort();var v=i.parseUShort();var m=oc(u,c,n);var _=hc(u,h,c);if(_!==undefined&&m!==undefined){var g=void 0;if(_===sc){g=ql.UTF16(e,s+v,d)}else{g=ql.MACSTRING(e,s+v,d,_)}if(g){var y=r[p];if(y===undefined){y=r[p]={}}y[m]=g}}}var x=0;if(a===1){x=i.parseUShort()}return r}function fc(e){var t={};for(var n in e){t[e[n]]=parseInt(n)}return t}function pc(e,t,n,r,i,a){return new pu.Record("NameRecord",[{name:"platformID",type:"USHORT",value:e},{name:"encodingID",type:"USHORT",value:t},{name:"languageID",type:"USHORT",value:n},{name:"nameID",type:"USHORT",value:r},{name:"length",type:"USHORT",value:i},{name:"offset",type:"USHORT",value:a}])}function dc(e,t){var n=e.length;var r=t.length-n+1;e:for(var i=0;i<r;i++){for(;i<r;i++){for(var a=0;a<n;a++){if(t[i+a]!==e[a]){continue e}}return i}}return-1}function vc(e,t){var n=dc(e,t);if(n<0){n=t.length;var r=0;var i=e.length;for(;r<i;++r){t.push(e[r])}}return n}function mc(e,t){var n;var r=[];var i={};var a=fc(nc);for(var o in e){var s=a[o];if(s===undefined){s=o}n=parseInt(s);if(isNaN(n)){throw new Error('Name table entry "'+o+'" does not exist, see nameTableNames for complete list.')}i[n]=e[o];r.push(n)}var l=fc(rc);var u=fc(ac);var h=[];var c=[];for(var f=0;f<r.length;f++){n=r[f];var p=i[n];for(var d in p){var v=p[d];var m=1;var _=l[d];var g=ic[_];var y=hc(m,g,_);var x=Xl.MACSTRING(v,y);if(x===undefined){m=0;_=t.indexOf(d);if(_<0){_=t.length;t.push(d)}g=4;x=Xl.UTF16(v)}var b=vc(x,c);h.push(pc(m,g,_,n,x.length,b));var w=u[d];if(w!==undefined){var E=Xl.UTF16(v);var T=vc(E,c);h.push(pc(3,1,w,n,E.length,T))}}}h.sort(function(e,t){return e.platformID-t.platformID||e.encodingID-t.encodingID||e.languageID-t.languageID||e.nameID-t.nameID});var S=new pu.Table("name",[{name:"format",type:"USHORT",value:0},{name:"count",type:"USHORT",value:h.length},{name:"stringOffset",type:"USHORT",value:6+h.length*12}]);for(var A=0;A<h.length;A++){S.fields.push({name:"record_"+A,type:"RECORD",value:h[A]})}S.fields.push({name:"strings",type:"LITERAL",value:c});return S}var _c={parse:cc,make:mc};var gc=[{begin:0,end:127},{begin:128,end:255},{begin:256,end:383},{begin:384,end:591},{begin:592,end:687},{begin:688,end:767},{begin:768,end:879},{begin:880,end:1023},{begin:11392,end:11519},{begin:1024,end:1279},{begin:1328,end:1423},{begin:1424,end:1535},{begin:42240,end:42559},{begin:1536,end:1791},{begin:1984,end:2047},{begin:2304,end:2431},{begin:2432,end:2559},{begin:2560,end:2687},{begin:2688,end:2815},{begin:2816,end:2943},{begin:2944,end:3071},{begin:3072,end:3199},{begin:3200,end:3327},{begin:3328,end:3455},{begin:3584,end:3711},{begin:3712,end:3839},{begin:4256,end:4351},{begin:6912,end:7039},{begin:4352,end:4607},{begin:7680,end:7935},{begin:7936,end:8191},{begin:8192,end:8303},{begin:8304,end:8351},{begin:8352,end:8399},{begin:8400,end:8447},{begin:8448,end:8527},{begin:8528,end:8591},{begin:8592,end:8703},{begin:8704,end:8959},{begin:8960,end:9215},{begin:9216,end:9279},{begin:9280,end:9311},{begin:9312,end:9471},{begin:9472,end:9599},{begin:9600,end:9631},{begin:9632,end:9727},{begin:9728,end:9983},{begin:9984,end:10175},{begin:12288,end:12351},{begin:12352,end:12447},{begin:12448,end:12543},{begin:12544,end:12591},{begin:12592,end:12687},{begin:43072,end:43135},{begin:12800,end:13055},{begin:13056,end:13311},{begin:44032,end:55215},{begin:55296,end:57343},{begin:67840,end:67871},{begin:19968,end:40959},{begin:57344,end:63743},{begin:12736,end:12783},{begin:64256,end:64335},{begin:64336,end:65023},{begin:65056,end:65071},{begin:65040,end:65055},{begin:65104,end:65135},{begin:65136,end:65279},{begin:65280,end:65519},{begin:65520,end:65535},{begin:3840,end:4095},{begin:1792,end:1871},{begin:1920,end:1983},{begin:3456,end:3583},{begin:4096,end:4255},{begin:4608,end:4991},{begin:5024,end:5119},{begin:5120,end:5759},{begin:5760,end:5791},{begin:5792,end:5887},{begin:6016,end:6143},{begin:6144,end:6319},{begin:10240,end:10495},{begin:40960,end:42127},{begin:5888,end:5919},{begin:66304,end:66351},{begin:66352,end:66383},{begin:66560,end:66639},{begin:118784,end:119039},{begin:119808,end:120831},{begin:1044480,end:1048573},{begin:65024,end:65039},{begin:917504,end:917631},{begin:6400,end:6479},{begin:6480,end:6527},{begin:6528,end:6623},{begin:6656,end:6687},{begin:11264,end:11359},{begin:11568,end:11647},{begin:19904,end:19967},{begin:43008,end:43055},{begin:65536,end:65663},{begin:65856,end:65935},{begin:66432,end:66463},{begin:66464,end:66527},{begin:66640,end:66687},{begin:66688,end:66735},{begin:67584,end:67647},{begin:68096,end:68191},{begin:119552,end:119647},{begin:73728,end:74751},{begin:119648,end:119679},{begin:7040,end:7103},{begin:7168,end:7247},{begin:7248,end:7295},{begin:43136,end:43231},{begin:43264,end:43311},{begin:43312,end:43359},{begin:43520,end:43615},{begin:65936,end:65999},{begin:66e3,end:66047},{begin:66208,end:66271},{begin:127024,end:127135}];function yc(e){for(var t=0;t<gc.length;t+=1){var n=gc[t];if(e>=n.begin&&e<n.end){return t}}return-1}function xc(e,t){var n={};var r=new Au.Parser(e,t);n.version=r.parseUShort();n.xAvgCharWidth=r.parseShort();n.usWeightClass=r.parseUShort();n.usWidthClass=r.parseUShort();n.fsType=r.parseUShort();n.ySubscriptXSize=r.parseShort();n.ySubscriptYSize=r.parseShort();n.ySubscriptXOffset=r.parseShort();n.ySubscriptYOffset=r.parseShort();n.ySuperscriptXSize=r.parseShort();n.ySuperscriptYSize=r.parseShort();n.ySuperscriptXOffset=r.parseShort();n.ySuperscriptYOffset=r.parseShort();n.yStrikeoutSize=r.parseShort();n.yStrikeoutPosition=r.parseShort();n.sFamilyClass=r.parseShort();n.panose=[];for(var i=0;i<10;i++){n.panose[i]=r.parseByte()}n.ulUnicodeRange1=r.parseULong();n.ulUnicodeRange2=r.parseULong();n.ulUnicodeRange3=r.parseULong();n.ulUnicodeRange4=r.parseULong();n.achVendID=String.fromCharCode(r.parseByte(),r.parseByte(),r.parseByte(),r.parseByte());n.fsSelection=r.parseUShort();n.usFirstCharIndex=r.parseUShort();n.usLastCharIndex=r.parseUShort();n.sTypoAscender=r.parseShort();n.sTypoDescender=r.parseShort();n.sTypoLineGap=r.parseShort();n.usWinAscent=r.parseUShort();n.usWinDescent=r.parseUShort();if(n.version>=1){n.ulCodePageRange1=r.parseULong();n.ulCodePageRange2=r.parseULong()}if(n.version>=2){n.sxHeight=r.parseShort();n.sCapHeight=r.parseShort();n.usDefaultChar=r.parseUShort();n.usBreakChar=r.parseUShort();n.usMaxContent=r.parseUShort()}return n}function bc(e){return new pu.Table("OS/2",[{name:"version",type:"USHORT",value:3},{name:"xAvgCharWidth",type:"SHORT",value:0},{name:"usWeightClass",type:"USHORT",value:0},{name:"usWidthClass",type:"USHORT",value:0},{name:"fsType",type:"USHORT",value:0},{name:"ySubscriptXSize",type:"SHORT",value:650},{name:"ySubscriptYSize",type:"SHORT",value:699},{name:"ySubscriptXOffset",type:"SHORT",value:0},{name:"ySubscriptYOffset",type:"SHORT",value:140},{name:"ySuperscriptXSize",type:"SHORT",value:650},{name:"ySuperscriptYSize",type:"SHORT",value:699},{name:"ySuperscriptXOffset",type:"SHORT",value:0},{name:"ySuperscriptYOffset",type:"SHORT",value:479},{name:"yStrikeoutSize",type:"SHORT",value:49},{name:"yStrikeoutPosition",type:"SHORT",value:258},{name:"sFamilyClass",type:"SHORT",value:0},{name:"bFamilyType",type:"BYTE",value:0},{name:"bSerifStyle",type:"BYTE",value:0},{name:"bWeight",type:"BYTE",value:0},{name:"bProportion",type:"BYTE",value:0},{name:"bContrast",type:"BYTE",value:0},{name:"bStrokeVariation",type:"BYTE",value:0},{name:"bArmStyle",type:"BYTE",value:0},{name:"bLetterform",type:"BYTE",value:0},{name:"bMidline",type:"BYTE",value:0},{name:"bXHeight",type:"BYTE",value:0},{name:"ulUnicodeRange1",type:"ULONG",value:0},{name:"ulUnicodeRange2",type:"ULONG",value:0},{name:"ulUnicodeRange3",type:"ULONG",value:0},{name:"ulUnicodeRange4",type:"ULONG",value:0},{name:"achVendID",type:"CHARARRAY",value:"XXXX"},{name:"fsSelection",type:"USHORT",value:0},{name:"usFirstCharIndex",type:"USHORT",value:0},{name:"usLastCharIndex",type:"USHORT",value:0},{name:"sTypoAscender",type:"SHORT",value:0},{name:"sTypoDescender",type:"SHORT",value:0},{name:"sTypoLineGap",type:"SHORT",value:0},{name:"usWinAscent",type:"USHORT",value:0},{name:"usWinDescent",type:"USHORT",value:0},{name:"ulCodePageRange1",type:"ULONG",value:0},{name:"ulCodePageRange2",type:"ULONG",value:0},{name:"sxHeight",type:"SHORT",value:0},{name:"sCapHeight",type:"SHORT",value:0},{name:"usDefaultChar",type:"USHORT",value:0},{name:"usBreakChar",type:"USHORT",value:0},{name:"usMaxContext",type:"USHORT",value:0}],e)}var wc={parse:xc,make:bc,unicodeRanges:gc,getUnicodeRange:yc};function Ec(e,t){var n={};var r=new Au.Parser(e,t);n.version=r.parseVersion();n.italicAngle=r.parseFixed();n.underlinePosition=r.parseShort();n.underlineThickness=r.parseShort();n.isFixedPitch=r.parseULong();n.minMemType42=r.parseULong();n.maxMemType42=r.parseULong();n.minMemType1=r.parseULong();n.maxMemType1=r.parseULong();switch(n.version){case 1:n.names=Fu.slice();break;case 2:n.numberOfGlyphs=r.parseUShort();n.glyphNameIndex=new Array(n.numberOfGlyphs);for(var i=0;i<n.numberOfGlyphs;i++){n.glyphNameIndex[i]=r.parseUShort()}n.names=[];for(var a=0;a<n.numberOfGlyphs;a++){if(n.glyphNameIndex[a]>=Fu.length){var o=r.parseChar();n.names.push(r.parseString(o))}}break;case 2.5:n.numberOfGlyphs=r.parseUShort();n.offset=new Array(n.numberOfGlyphs);for(var s=0;s<n.numberOfGlyphs;s++){n.offset[s]=r.parseChar()}break}return n}function Tc(){return new pu.Table("post",[{name:"version",type:"FIXED",value:196608},{name:"italicAngle",type:"FIXED",value:0},{name:"underlinePosition",type:"FWORD",value:0},{name:"underlineThickness",type:"FWORD",value:0},{name:"isFixedPitch",type:"ULONG",value:0},{name:"minMemType42",type:"ULONG",value:0},{name:"maxMemType42",type:"ULONG",value:0},{name:"minMemType1",type:"ULONG",value:0},{name:"maxMemType1",type:"ULONG",value:0}])}var Sc={parse:Ec,make:Tc};var Ac=new Array(9);Ac[1]=function e(){var t=this.offset+this.relativeOffset;var n=this.parseUShort();if(n===1){return{substFormat:1,coverage:this.parsePointer(Tu.coverage),deltaGlyphId:this.parseUShort()}}else if(n===2){return{substFormat:2,coverage:this.parsePointer(Tu.coverage),substitute:this.parseOffset16List()}}Gl.assert(false,"0x"+t.toString(16)+": lookup type 1 format must be 1 or 2.")};Ac[2]=function e(){var t=this.parseUShort();Gl.argument(t===1,"GSUB Multiple Substitution Subtable identifier-format must be 1");return{substFormat:t,coverage:this.parsePointer(Tu.coverage),sequences:this.parseListOfLists()}};Ac[3]=function e(){var t=this.parseUShort();Gl.argument(t===1,"GSUB Alternate Substitution Subtable identifier-format must be 1");return{substFormat:t,coverage:this.parsePointer(Tu.coverage),alternateSets:this.parseListOfLists()}};Ac[4]=function e(){var t=this.parseUShort();Gl.argument(t===1,"GSUB ligature table identifier-format must be 1");return{substFormat:t,coverage:this.parsePointer(Tu.coverage),ligatureSets:this.parseListOfLists(function(){return{ligGlyph:this.parseUShort(),components:this.parseUShortList(this.parseUShort()-1)}})}};var Mc={sequenceIndex:Tu.uShort,lookupListIndex:Tu.uShort};Ac[5]=function e(){var t=this.offset+this.relativeOffset;var n=this.parseUShort();if(n===1){return{substFormat:n,coverage:this.parsePointer(Tu.coverage),ruleSets:this.parseListOfLists(function(){var e=this.parseUShort();var t=this.parseUShort();return{input:this.parseUShortList(e-1),lookupRecords:this.parseRecordList(t,Mc)}})}}else if(n===2){return{substFormat:n,coverage:this.parsePointer(Tu.coverage),classDef:this.parsePointer(Tu.classDef),classSets:this.parseListOfLists(function(){var e=this.parseUShort();var t=this.parseUShort();return{classes:this.parseUShortList(e-1),lookupRecords:this.parseRecordList(t,Mc)}})}}else if(n===3){var r=this.parseUShort();var i=this.parseUShort();return{substFormat:n,coverages:this.parseList(r,Tu.pointer(Tu.coverage)),lookupRecords:this.parseRecordList(i,Mc)}}Gl.assert(false,"0x"+t.toString(16)+": lookup type 5 format must be 1, 2 or 3.")};Ac[6]=function e(){var t=this.offset+this.relativeOffset;var n=this.parseUShort();if(n===1){return{substFormat:1,coverage:this.parsePointer(Tu.coverage),chainRuleSets:this.parseListOfLists(function(){return{backtrack:this.parseUShortList(),input:this.parseUShortList(this.parseShort()-1),lookahead:this.parseUShortList(),lookupRecords:this.parseRecordList(Mc)}})}}else if(n===2){return{substFormat:2,coverage:this.parsePointer(Tu.coverage),backtrackClassDef:this.parsePointer(Tu.classDef),inputClassDef:this.parsePointer(Tu.classDef),lookaheadClassDef:this.parsePointer(Tu.classDef),chainClassSet:this.parseListOfLists(function(){return{backtrack:this.parseUShortList(),input:this.parseUShortList(this.parseShort()-1),lookahead:this.parseUShortList(),lookupRecords:this.parseRecordList(Mc)}})}}else if(n===3){return{substFormat:3,backtrackCoverage:this.parseList(Tu.pointer(Tu.coverage)),inputCoverage:this.parseList(Tu.pointer(Tu.coverage)),lookaheadCoverage:this.parseList(Tu.pointer(Tu.coverage)),lookupRecords:this.parseRecordList(Mc)}}Gl.assert(false,"0x"+t.toString(16)+": lookup type 6 format must be 1, 2 or 3.")};Ac[7]=function e(){var t=this.parseUShort();Gl.argument(t===1,"GSUB Extension Substitution subtable identifier-format must be 1");var n=this.parseUShort();var r=new Tu(this.data,this.offset+this.parseULong());return{substFormat:1,lookupType:n,extension:Ac[n].call(r)}};Ac[8]=function e(){var t=this.parseUShort();Gl.argument(t===1,"GSUB Reverse Chaining Contextual Single Substitution Subtable identifier-format must be 1");return{substFormat:t,coverage:this.parsePointer(Tu.coverage),backtrackCoverage:this.parseList(Tu.pointer(Tu.coverage)),lookaheadCoverage:this.parseList(Tu.pointer(Tu.coverage)),substitutes:this.parseUShortList()}};function Rc(e,t){t=t||0;var n=new Tu(e,t);var r=n.parseVersion();Gl.argument(r===1,"Unsupported GSUB table version.");return{version:r,scripts:n.parseScriptList(),features:n.parseFeatureList(),lookups:n.parseLookupList(Ac)}}var Lc=new Array(9);Lc[1]=function e(t){if(t.substFormat===1){return new pu.Table("substitutionTable",[{name:"substFormat",type:"USHORT",value:1},{name:"coverage",type:"TABLE",value:new pu.Coverage(t.coverage)},{name:"deltaGlyphID",type:"USHORT",value:t.deltaGlyphId}])}else{return new pu.Table("substitutionTable",[{name:"substFormat",type:"USHORT",value:2},{name:"coverage",type:"TABLE",value:new pu.Coverage(t.coverage)}].concat(pu.ushortList("substitute",t.substitute)))}Gl.fail("Lookup type 1 substFormat must be 1 or 2.")};Lc[3]=function e(t){Gl.assert(t.substFormat===1,"Lookup type 3 substFormat must be 1.");return new pu.Table("substitutionTable",[{name:"substFormat",type:"USHORT",value:1},{name:"coverage",type:"TABLE",value:new pu.Coverage(t.coverage)}].concat(pu.tableList("altSet",t.alternateSets,function(e){return new pu.Table("alternateSetTable",pu.ushortList("alternate",e))})))};Lc[4]=function e(t){Gl.assert(t.substFormat===1,"Lookup type 4 substFormat must be 1.");return new pu.Table("substitutionTable",[{name:"substFormat",type:"USHORT",value:1},{name:"coverage",type:"TABLE",value:new pu.Coverage(t.coverage)}].concat(pu.tableList("ligSet",t.ligatureSets,function(e){return new pu.Table("ligatureSetTable",pu.tableList("ligature",e,function(e){return new pu.Table("ligatureTable",[{name:"ligGlyph",type:"USHORT",value:e.ligGlyph}].concat(pu.ushortList("component",e.components,e.components.length+1)))}))})))};function Cc(e){return new pu.Table("GSUB",[{name:"version",type:"ULONG",value:65536},{name:"scripts",type:"TABLE",value:new pu.ScriptList(e.scripts)},{name:"features",type:"TABLE",value:new pu.FeatureList(e.features)},{name:"lookups",type:"TABLE",value:new pu.LookupList(e.lookups,Lc)}])}var Oc={parse:Rc,make:Cc};function Ic(e,t){var n=new Au.Parser(e,t);var r=n.parseULong();Gl.argument(r===1,"Unsupported META table version.");n.parseULong();n.parseULong();var i=n.parseULong();var a={};for(var o=0;o<i;o++){var s=n.parseTag();var l=n.parseULong();var u=n.parseULong();var h=ql.UTF8(e,t+l,u);a[s]=h}return a}function Uc(e){var t=Object.keys(e).length;var n="";var r=16+t*12;var i=new pu.Table("meta",[{name:"version",type:"ULONG",value:1},{name:"flags",type:"ULONG",value:0},{name:"offset",type:"ULONG",value:r},{name:"numTags",type:"ULONG",value:t}]);for(var a in e){var o=n.length;n+=e[a];i.fields.push({name:"tag "+a,type:"TAG",value:a});i.fields.push({name:"offset "+a,type:"ULONG",value:r+o});i.fields.push({name:"length "+a,type:"ULONG",value:e[a].length})}i.fields.push({name:"stringPool",type:"CHARARRAY",value:n});return i}var Pc={parse:Ic,make:Uc};function Bc(e){return Math.log(e)/Math.log(2)|0}function Dc(e){while(e.length%4!==0){e.push(0)}var t=0;for(var n=0;n<e.length;n+=4){t+=(e[n]<<24)+(e[n+1]<<16)+(e[n+2]<<8)+e[n+3]}t%=Math.pow(2,32);return t}function Fc(e,t,n,r){return new pu.Record("Table Record",[{name:"tag",type:"TAG",value:e!==undefined?e:""},{name:"checkSum",type:"ULONG",value:t!==undefined?t:0},{name:"offset",type:"ULONG",value:n!==undefined?n:0},{name:"length",type:"ULONG",value:r!==undefined?r:0}])}function zc(e){var t=new pu.Table("sfnt",[{name:"version",type:"TAG",value:"OTTO"},{name:"numTables",type:"USHORT",value:0},{name:"searchRange",type:"USHORT",value:0},{name:"entrySelector",type:"USHORT",value:0},{name:"rangeShift",type:"USHORT",value:0}]);t.tables=e;t.numTables=e.length;var n=Math.pow(2,Bc(t.numTables));t.searchRange=16*n;t.entrySelector=Bc(n);t.rangeShift=t.numTables*16-t.searchRange;var r=[];var i=[];var a=t.sizeOf()+Fc().sizeOf()*t.numTables;while(a%4!==0){a+=1;i.push({name:"padding",type:"BYTE",value:0})}for(var o=0;o<e.length;o+=1){var s=e[o];Gl.argument(s.tableName.length===4,"Table name"+s.tableName+" is invalid.");var l=s.sizeOf();var u=Fc(s.tableName,Dc(s.encode()),a,l);r.push({name:u.tag+" Table Record",type:"RECORD",value:u});i.push({name:s.tableName+" table",type:"RECORD",value:s});a+=l;Gl.argument(!isNaN(a),"Something went wrong calculating the offset.");while(a%4!==0){a+=1;i.push({name:"padding",type:"BYTE",value:0})}}r.sort(function(e,t){if(e.value.tag>t.value.tag){return 1}else{return-1}});t.fields=t.fields.concat(r);t.fields=t.fields.concat(i);return t}function Nc(e,t,n){for(var r=0;r<t.length;r+=1){var i=e.charToGlyphIndex(t[r]);if(i>0){var a=e.glyphs.get(i);return a.getMetrics()}}return n}function kc(e){var t=0;for(var n=0;n<e.length;n+=1){t+=e[n]}return t/e.length}function Vc(e){var t=[];var n=[];var r=[];var i=[];var a=[];var o=[];var s=[];var l;var u=0;var h=0;var c=0;var f=0;var p=0;for(var d=0;d<e.glyphs.length;d+=1){var v=e.glyphs.get(d);var m=v.unicode|0;if(isNaN(v.advanceWidth)){throw new Error("Glyph "+v.name+" ("+d+"): advanceWidth is not a number.")}if(l>m||l===undefined){if(m>0){l=m}}if(u<m){u=m}var _=wc.getUnicodeRange(m);if(_<32){h|=1<<_}else if(_<64){c|=1<<_-32}else if(_<96){f|=1<<_-64}else if(_<123){p|=1<<_-96}else{throw new Error("Unicode ranges bits > 123 are reserved for internal usage")}if(v.name===".notdef"){continue}var g=v.getMetrics();t.push(g.xMin);n.push(g.yMin);r.push(g.xMax);i.push(g.yMax);o.push(g.leftSideBearing);s.push(g.rightSideBearing);a.push(v.advanceWidth)}var y={xMin:Math.min.apply(null,t),yMin:Math.min.apply(null,n),xMax:Math.max.apply(null,r),yMax:Math.max.apply(null,i),advanceWidthMax:Math.max.apply(null,a),advanceWidthAvg:kc(a),minLeftSideBearing:Math.min.apply(null,o),maxLeftSideBearing:Math.max.apply(null,o),minRightSideBearing:Math.min.apply(null,s)};y.ascender=e.ascender;y.descender=e.descender;var x=Gh.make({flags:3,unitsPerEm:e.unitsPerEm,xMin:y.xMin,yMin:y.yMin,xMax:y.xMax,yMax:y.yMax,lowestRecPPEM:3,createdTimestamp:e.createdTimestamp});var b=qh.make({ascender:y.ascender,descender:y.descender,advanceWidthMax:y.advanceWidthMax,minLeftSideBearing:y.minLeftSideBearing,minRightSideBearing:y.minRightSideBearing,xMaxExtent:y.maxLeftSideBearing+(y.xMax-y.xMin),numberOfHMetrics:e.glyphs.length});var w=tc.make(e.glyphs.length);var E=wc.make({xAvgCharWidth:Math.round(y.advanceWidthAvg),usWeightClass:e.tables.os2.usWeightClass,usWidthClass:e.tables.os2.usWidthClass,usFirstCharIndex:l,usLastCharIndex:u,ulUnicodeRange1:h,ulUnicodeRange2:c,ulUnicodeRange3:f,ulUnicodeRange4:p,fsSelection:e.tables.os2.fsSelection,sTypoAscender:y.ascender,sTypoDescender:y.descender,sTypoLineGap:0,usWinAscent:y.yMax,usWinDescent:Math.abs(y.yMin),ulCodePageRange1:1,sxHeight:Nc(e,"xyvw",{yMax:Math.round(y.ascender/2)}).yMax,sCapHeight:Nc(e,"HIKLEFJMNTZBDPRAGOQSUVWXY",y).yMax,usDefaultChar:e.hasChar(" ")?32:0,usBreakChar:e.hasChar(" ")?32:0});var T=Kh.make(e.glyphs);var S=Uu.make(e.glyphs);var A=e.getEnglishName("fontFamily");var M=e.getEnglishName("fontSubfamily");var R=A+" "+M;var L=e.getEnglishName("postScriptName");if(!L){L=A.replace(/\s/g,"")+"-"+M}var C={};for(var O in e.names){C[O]=e.names[O]}if(!C.uniqueID){C.uniqueID={en:e.getEnglishName("manufacturer")+":"+R}}if(!C.postScriptName){C.postScriptName={en:L}}if(!C.preferredFamily){C.preferredFamily=e.names.fontFamily}if(!C.preferredSubfamily){C.preferredSubfamily=e.names.fontSubfamily}var I=[];var U=_c.make(C,I);var P=I.length>0?Jh.make(I):undefined;var B=Sc.make();var D=kh.make(e.glyphs,{version:e.getEnglishName("version"),fullName:R,familyName:A,weightName:M,postScriptName:L,unitsPerEm:e.unitsPerEm,fontBBox:[0,y.yMin,y.ascender,y.advanceWidthMax]});var F=e.metas&&Object.keys(e.metas).length>0?Pc.make(e.metas):undefined;var z=[x,b,w,E,U,S,B,D,T];if(P){z.push(P)}if(e.tables.gsub){z.push(Oc.make(e.tables.gsub))}if(F){z.push(F)}var N=zc(z);var k=N.encode();var V=Dc(k);var W=N.fields;var G=false;for(var H=0;H<W.length;H+=1){if(W[H].name==="head table"){W[H].value.checkSumAdjustment=2981146554-V;G=true;break}}if(!G){throw new Error("Could not find head table with checkSum to adjust.")}return N}var Wc={make:zc,fontToTable:Vc,computeCheckSum:Dc};function Gc(e,t){var n=0;var r=e.length-1;while(n<=r){var i=n+r>>>1;var a=e[i].tag;if(a===t){return i}else if(a<t){n=i+1}else{r=i-1}}return-n-1}function Hc(e,t){var n=0;var r=e.length-1;while(n<=r){var i=n+r>>>1;var a=e[i];if(a===t){return i}else if(a<t){n=i+1}else{r=i-1}}return-n-1}function jc(e,t){this.font=e;this.tableName=t}jc.prototype={searchTag:Gc,binSearch:Hc,getTable:function(e){var t=this.font.tables[this.tableName];if(!t&&e){t=this.font.tables[this.tableName]=this.createDefaultTable()}return t},getScriptNames:function(){var e=this.getTable();if(!e){return[]}return e.scripts.map(function(e){return e.tag})},getDefaultScriptName:function(){var e=this.getTable();if(!e){return}var t=false;for(var n=0;n<e.scripts.length;n++){var r=e.scripts[n].tag;if(r==="DFLT"){return r}if(r==="latn"){t=true}}if(t){return"latn"}},getScriptTable:function(e,t){var n=this.getTable(t);if(n){e=e||"DFLT";var r=n.scripts;var i=Gc(n.scripts,e);if(i>=0){return r[i].script}else if(t){var a={tag:e,script:{defaultLangSys:{reserved:0,reqFeatureIndex:65535,featureIndexes:[]},langSysRecords:[]}};r.splice(-1-i,0,a);return a.script}}},getLangSysTable:function(e,t,n){var r=this.getScriptTable(e,n);if(r){if(!t||t==="dflt"||t==="DFLT"){return r.defaultLangSys}var i=Gc(r.langSysRecords,t);if(i>=0){return r.langSysRecords[i].langSys}else if(n){var a={tag:t,langSys:{reserved:0,reqFeatureIndex:65535,featureIndexes:[]}};r.langSysRecords.splice(-1-i,0,a);return a.langSys}}},getFeatureTable:function(e,t,n,r){var i=this.getLangSysTable(e,t,r);if(i){var a;var o=i.featureIndexes;var s=this.font.tables[this.tableName].features;for(var l=0;l<o.length;l++){a=s[o[l]];if(a.tag===n){return a.feature}}if(r){var u=s.length;Gl.assert(u===0||n>=s[u-1].tag,"Features must be added in alphabetical order.");a={tag:n,feature:{params:0,lookupListIndexes:[]}};s.push(a);o.push(u);return a.feature}}},getLookupTables:function(e,t,n,r,i){var a=this.getFeatureTable(e,t,n,i);var o=[];if(a){var s;var l=a.lookupListIndexes;var u=this.font.tables[this.tableName].lookups;for(var h=0;h<l.length;h++){s=u[l[h]];if(s.lookupType===r){o.push(s)}}if(o.length===0&&i){s={lookupType:r,lookupFlag:0,subtables:[],markFilteringSet:undefined};var c=u.length;u.push(s);l.push(c);return[s]}}return o},expandCoverage:function(e){if(e.format===1){return e.glyphs}else{var t=[];var n=e.ranges;for(var r=0;r<n.length;r++){var i=n[r];var a=i.start;var o=i.end;for(var s=a;s<=o;s++){t.push(s)}}return t}}};function qc(e){jc.call(this,e,"gsub")}function Xc(e,t){var n=e.length;if(n!==t.length){return false}for(var r=0;r<n;r++){if(e[r]!==t[r]){return false}}return true}function Yc(e,t,n){var r=e.subtables;for(var i=0;i<r.length;i++){var a=r[i];if(a.substFormat===t){return a}}if(n){r.push(n);return n}return undefined}qc.prototype=jc.prototype;qc.prototype.createDefaultTable=function(){return{version:1,scripts:[{tag:"DFLT",script:{defaultLangSys:{reserved:0,reqFeatureIndex:65535,featureIndexes:[]},langSysRecords:[]}}],features:[],lookups:[]}};qc.prototype.getSingle=function(e,t,n){var r=this;var i=[];var a=this.getLookupTables(t,n,e,1);for(var o=0;o<a.length;o++){var s=a[o].subtables;for(var l=0;l<s.length;l++){var u=s[l];var h=r.expandCoverage(u.coverage);var c=void 0;if(u.substFormat===1){var f=u.deltaGlyphId;for(c=0;c<h.length;c++){var p=h[c];i.push({sub:p,by:p+f})}}else{var d=u.substitute;for(c=0;c<h.length;c++){i.push({sub:h[c],by:d[c]})}}}}return i};qc.prototype.getAlternates=function(e,t,n){var r=this;var i=[];var a=this.getLookupTables(t,n,e,3);for(var o=0;o<a.length;o++){var s=a[o].subtables;for(var l=0;l<s.length;l++){var u=s[l];var h=r.expandCoverage(u.coverage);var c=u.alternateSets;for(var f=0;f<h.length;f++){i.push({sub:h[f],by:c[f]})}}}return i};qc.prototype.getLigatures=function(e,t,n){var r=this;var i=[];var a=this.getLookupTables(t,n,e,4);for(var o=0;o<a.length;o++){var s=a[o].subtables;for(var l=0;l<s.length;l++){var u=s[l];var h=r.expandCoverage(u.coverage);var c=u.ligatureSets;for(var f=0;f<h.length;f++){var p=h[f];var d=c[f];for(var v=0;v<d.length;v++){var m=d[v];i.push({sub:[p].concat(m.components),by:m.ligGlyph})}}}}return i};qc.prototype.addSingle=function(e,t,n,r){var i=this.getLookupTables(n,r,e,1,true)[0];var a=Yc(i,2,{substFormat:2,coverage:{format:1,glyphs:[]},substitute:[]});Gl.assert(a.coverage.format===1,"Ligature: unable to modify coverage table format "+a.coverage.format);var o=t.sub;var s=this.binSearch(a.coverage.glyphs,o);if(s<0){s=-1-s;a.coverage.glyphs.splice(s,0,o);a.substitute.splice(s,0,0)}a.substitute[s]=t.by};qc.prototype.addAlternate=function(e,t,n,r){var i=this.getLookupTables(n,r,e,3,true)[0];var a=Yc(i,1,{substFormat:1,coverage:{format:1,glyphs:[]},alternateSets:[]});Gl.assert(a.coverage.format===1,"Ligature: unable to modify coverage table format "+a.coverage.format);var o=t.sub;var s=this.binSearch(a.coverage.glyphs,o);if(s<0){s=-1-s;a.coverage.glyphs.splice(s,0,o);a.alternateSets.splice(s,0,0)}a.alternateSets[s]=t.by};qc.prototype.addLigature=function(e,t,n,r){var i=this.getLookupTables(n,r,e,4,true)[0];var a=i.subtables[0];if(!a){a={substFormat:1,coverage:{format:1,glyphs:[]},ligatureSets:[]};i.subtables[0]=a}Gl.assert(a.coverage.format===1,"Ligature: unable to modify coverage table format "+a.coverage.format);var o=t.sub[0];var s=t.sub.slice(1);var l={ligGlyph:t.by,components:s};var u=this.binSearch(a.coverage.glyphs,o);if(u>=0){var h=a.ligatureSets[u];for(var c=0;c<h.length;c++){if(Xc(h[c].components,s)){return}}h.push(l)}else{u=-1-u;a.coverage.glyphs.splice(u,0,o);a.ligatureSets.splice(u,0,[l])}};qc.prototype.getFeature=function(e,t,n){if(/ss\d\d/.test(e)){return this.getSingle(e,t,n)}switch(e){case"aalt":case"salt":return this.getSingle(e,t,n).concat(this.getAlternates(e,t,n));case"dlig":case"liga":case"rlig":return this.getLigatures(e,t,n)}return undefined};qc.prototype.add=function(e,t,n,r){if(/ss\d\d/.test(e)){return this.addSingle(e,t,n,r)}switch(e){case"aalt":case"salt":if(typeof t.by==="number"){return this.addSingle(e,t,n,r)}return this.addAlternate(e,t,n,r);case"dlig":case"liga":case"rlig":return this.addLigature(e,t,n,r)}return undefined};function Kc(){return typeof window!=="undefined"}function Zc(e){var t=new Buffer(e.byteLength);var n=new Uint8Array(e);for(var r=0;r<t.length;++r){t[r]=n[r]}return t}function Qc(e,t){if(!e){throw t}}var Jc;var $c;var ef;var tf;function nf(e){this.font=e;this._fpgmState=this._prepState=undefined;this._errorState=0}function rf(e){return e}function af(e){return Math.sign(e)*Math.round(Math.abs(e))}function of(e){return Math.sign(e)*Math.round(Math.abs(e*2))/2}function sf(e){return Math.sign(e)*(Math.round(Math.abs(e)+.5)-.5)}function lf(e){return Math.sign(e)*Math.ceil(Math.abs(e))}function uf(e){return Math.sign(e)*Math.floor(Math.abs(e))}var hf=function(e){var t=this.srPeriod;var n=this.srPhase;var r=this.srThreshold;var i=1;if(e<0){e=-e;i=-1}e+=r-n;e=Math.trunc(e/t)*t;e+=n;if(i>0&&e<0){return n}if(i<0&&e>0){return-n}return e*i};var cf={x:1,y:0,axis:"x",distance:function(e,t,n,r){return(n?e.xo:e.x)-(r?t.xo:t.x)},interpolate:function(e,t,n,r){var i;var a;var o;var s;var l;var u;var h;if(!r||r===this){i=e.xo-t.xo;a=e.xo-n.xo;l=t.x-t.xo;u=n.x-n.xo;o=Math.abs(i);s=Math.abs(a);h=o+s;if(h===0){e.x=e.xo+(l+u)/2;return}e.x=e.xo+(l*s+u*o)/h;return}i=r.distance(e,t,true,true);a=r.distance(e,n,true,true);l=r.distance(t,t,false,true);u=r.distance(n,n,false,true);o=Math.abs(i);s=Math.abs(a);h=o+s;if(h===0){cf.setRelative(e,e,(l+u)/2,r,true);return}cf.setRelative(e,e,(l*s+u*o)/h,r,true)},normalSlope:Number.NEGATIVE_INFINITY,setRelative:function(e,t,n,r,i){if(!r||r===this){e.x=(i?t.xo:t.x)+n;return}var a=i?t.xo:t.x;var o=i?t.yo:t.y;var s=a+n*r.x;var l=o+n*r.y;e.x=s+(e.y-l)/r.normalSlope},slope:0,touch:function(e){e.xTouched=true},touched:function(e){return e.xTouched},untouch:function(e){e.xTouched=false}};var ff={x:0,y:1,axis:"y",distance:function(e,t,n,r){return(n?e.yo:e.y)-(r?t.yo:t.y)},interpolate:function(e,t,n,r){var i;var a;var o;var s;var l;var u;var h;if(!r||r===this){i=e.yo-t.yo;a=e.yo-n.yo;l=t.y-t.yo;u=n.y-n.yo;o=Math.abs(i);s=Math.abs(a);h=o+s;if(h===0){e.y=e.yo+(l+u)/2;return}e.y=e.yo+(l*s+u*o)/h;return}i=r.distance(e,t,true,true);a=r.distance(e,n,true,true);l=r.distance(t,t,false,true);u=r.distance(n,n,false,true);o=Math.abs(i);s=Math.abs(a);h=o+s;if(h===0){ff.setRelative(e,e,(l+u)/2,r,true);return}ff.setRelative(e,e,(l*s+u*o)/h,r,true)},normalSlope:0,setRelative:function(e,t,n,r,i){if(!r||r===this){e.y=(i?t.yo:t.y)+n;return}var a=i?t.xo:t.x;var o=i?t.yo:t.y;var s=a+n*r.x;var l=o+n*r.y;e.y=l+r.normalSlope*(e.x-s)},slope:Number.POSITIVE_INFINITY,touch:function(e){e.yTouched=true},touched:function(e){return e.yTouched},untouch:function(e){e.yTouched=false}};Object.freeze(cf);Object.freeze(ff);function pf(e,t){this.x=e;this.y=t;this.axis=undefined;this.slope=t/e;this.normalSlope=-e/t;Object.freeze(this)}pf.prototype.distance=function(e,t,n,r){return this.x*cf.distance(e,t,n,r)+this.y*ff.distance(e,t,n,r)};pf.prototype.interpolate=function(e,t,n,r){var i;var a;var o;var s;var l;var u;var h;o=r.distance(e,t,true,true);s=r.distance(e,n,true,true);i=r.distance(t,t,false,true);a=r.distance(n,n,false,true);l=Math.abs(o);u=Math.abs(s);h=l+u;if(h===0){this.setRelative(e,e,(i+a)/2,r,true);return}this.setRelative(e,e,(i*u+a*l)/h,r,true)};pf.prototype.setRelative=function(e,t,n,r,i){r=r||this;var a=i?t.xo:t.x;var o=i?t.yo:t.y;var s=a+n*r.x;var l=o+n*r.y;var u=r.normalSlope;var h=this.slope;var c=e.x;var f=e.y;e.x=(h*c-u*s+l-f)/(h-u);e.y=h*(e.x-c)+f};pf.prototype.touch=function(e){e.xTouched=true;e.yTouched=true};function df(e,t){var n=Math.sqrt(e*e+t*t);e/=n;t/=n;if(e===1&&t===0){return cf}else if(e===0&&t===1){return ff}else{return new pf(e,t)}}function vf(e,t,n,r){this.x=this.xo=Math.round(e*64)/64;this.y=this.yo=Math.round(t*64)/64;this.lastPointOfContour=n;this.onCurve=r;this.prevPointOnContour=undefined;this.nextPointOnContour=undefined;this.xTouched=false;this.yTouched=false;Object.preventExtensions(this)}vf.prototype.nextTouched=function(e){var t=this.nextPointOnContour;while(!e.touched(t)&&t!==this){t=t.nextPointOnContour}return t};vf.prototype.prevTouched=function(e){var t=this.prevPointOnContour;while(!e.touched(t)&&t!==this){t=t.prevPointOnContour}return t};var mf=Object.freeze(new vf(0,0));var _f={cvCutIn:17/16,deltaBase:9,deltaShift:.125,loop:1,minDis:1,autoFlip:true};function gf(e,t){this.env=e;this.stack=[];this.prog=t;switch(e){case"glyf":this.zp0=this.zp1=this.zp2=1;this.rp0=this.rp1=this.rp2=0;case"prep":this.fv=this.pv=this.dpv=cf;this.round=af}}nf.prototype.exec=function(e,t){if(typeof t!=="number"){throw new Error("Point size is not a number!")}if(this._errorState>2){return}var n=this.font;var r=this._prepState;if(!r||r.ppem!==t){var i=this._fpgmState;if(!i){gf.prototype=_f;i=this._fpgmState=new gf("fpgm",n.tables.fpgm);i.funcs=[];i.font=n;if(exports.DEBUG){console.log("---EXEC FPGM---");i.step=-1}try{$c(i)}catch(e){console.log("Hinting error in FPGM:"+e);this._errorState=3;return}}gf.prototype=i;r=this._prepState=new gf("prep",n.tables.prep);r.ppem=t;var a=n.tables.cvt;if(a){var o=r.cvt=new Array(a.length);var s=t/n.unitsPerEm;for(var l=0;l<a.length;l++){o[l]=a[l]*s}}else{r.cvt=[]}if(exports.DEBUG){console.log("---EXEC PREP---");r.step=-1}try{$c(r)}catch(e){if(this._errorState<2){console.log("Hinting error in PREP:"+e)}this._errorState=2}}if(this._errorState>1){return}try{return ef(e,r)}catch(e){if(this._errorState<1){console.log("Hinting error:"+e);console.log("Note: further hinting errors are silenced")}this._errorState=1;return undefined}};ef=function(e,t){var n=t.ppem/t.font.unitsPerEm;var r=n;var i=e.components;var a;var o;var s;gf.prototype=t;if(!i){s=new gf("glyf",e.instructions);if(exports.DEBUG){console.log("---EXEC GLYPH---");s.step=-1}tf(e,s,n,r);o=s.gZone}else{var l=t.font;o=[];a=[];for(var u=0;u<i.length;u++){var h=i[u];var c=l.glyphs.get(h.glyphIndex);s=new gf("glyf",c.instructions);if(exports.DEBUG){console.log("---EXEC COMP "+u+"---");s.step=-1}tf(c,s,n,r);var f=Math.round(h.dx*n);var p=Math.round(h.dy*r);var d=s.gZone;var v=s.contours;for(var m=0;m<d.length;m++){var _=d[m];_.xTouched=_.yTouched=false;_.xo=_.x=_.x+f;_.yo=_.y=_.y+p}var g=o.length;o.push.apply(o,d);for(var y=0;y<v.length;y++){a.push(v[y]+g)}}if(e.instructions&&!s.inhibitGridFit){s=new gf("glyf",e.instructions);s.gZone=s.z0=s.z1=s.z2=o;s.contours=a;o.push(new vf(0,0),new vf(Math.round(e.advanceWidth*n),0));if(exports.DEBUG){console.log("---EXEC COMPOSITE---");s.step=-1}$c(s);o.length-=2}}return o};tf=function(e,t,n,r){var i=e.points||[];var a=i.length;var o=t.gZone=t.z0=t.z1=t.z2=[];var s=t.contours=[];var l;for(var u=0;u<a;u++){l=i[u];o[u]=new vf(l.x*n,l.y*r,l.lastPointOfContour,l.onCurve)}var h;var c;for(var f=0;f<a;f++){l=o[f];if(!h){h=l;s.push(f)}if(l.lastPointOfContour){l.nextPointOnContour=h;h.prevPointOnContour=l;h=undefined}else{c=o[f+1];l.nextPointOnContour=c;c.prevPointOnContour=l}}if(t.inhibitGridFit){return}o.push(new vf(0,0),new vf(Math.round(e.advanceWidth*n),0));$c(t);o.length-=2;if(exports.DEBUG){console.log("FINISHED GLYPH",t.stack);for(var p=0;p<a;p++){console.log(p,o[p].x,o[p].y)}}};$c=function(e){var t=e.prog;if(!t){return}var n=t.length;var r;for(e.ip=0;e.ip<n;e.ip++){if(exports.DEBUG){e.step++}r=Jc[t[e.ip]];if(!r){throw new Error("unknown instruction: 0x"+Number(t[e.ip]).toString(16))}r(e)}};function yf(e){var t=e.tZone=new Array(e.gZone.length);for(var n=0;n<t.length;n++){t[n]=new vf(0,0)}}function xf(e,t){var n=e.prog;var r=e.ip;var i=1;var a;do{a=n[++r];if(a===88){i++}else if(a===89){i--}else if(a===64){r+=n[r+1]+1}else if(a===65){r+=2*n[r+1]+1}else if(a>=176&&a<=183){r+=a-176+1}else if(a>=184&&a<=191){r+=(a-184+1)*2}else if(t&&i===1&&a===27){break}}while(i>0);e.ip=r}function bf(e,t){if(exports.DEBUG){console.log(t.step,"SVTCA["+e.axis+"]")}t.fv=t.pv=t.dpv=e}function wf(e,t){if(exports.DEBUG){console.log(t.step,"SPVTCA["+e.axis+"]")}t.pv=t.dpv=e}function Ef(e,t){if(exports.DEBUG){console.log(t.step,"SFVTCA["+e.axis+"]")}t.fv=e}function Tf(e,t){var n=t.stack;var r=n.pop();var i=n.pop();var a=t.z2[r];var o=t.z1[i];if(exports.DEBUG){console.log("SPVTL["+e+"]",r,i)}var s;var l;if(!e){s=o.x-a.x;l=o.y-a.y}else{s=a.y-o.y;l=o.x-a.x}t.pv=t.dpv=df(s,l)}function Sf(e,t){var n=t.stack;var r=n.pop();var i=n.pop();var a=t.z2[r];var o=t.z1[i];if(exports.DEBUG){console.log("SFVTL["+e+"]",r,i)}var s;var l;if(!e){s=o.x-a.x;l=o.y-a.y}else{s=a.y-o.y;l=o.x-a.x}t.fv=df(s,l)}function Af(e){var t=e.stack;var n=t.pop();var r=t.pop();if(exports.DEBUG){console.log(e.step,"SPVFS[]",n,r)}e.pv=e.dpv=df(r,n)}function Mf(e){var t=e.stack;var n=t.pop();var r=t.pop();if(exports.DEBUG){console.log(e.step,"SPVFS[]",n,r)}e.fv=df(r,n)}function Rf(e){var t=e.stack;var n=e.pv;if(exports.DEBUG){console.log(e.step,"GPV[]")}t.push(n.x*16384);t.push(n.y*16384)}function Lf(e){var t=e.stack;var n=e.fv;if(exports.DEBUG){console.log(e.step,"GFV[]")}t.push(n.x*16384);t.push(n.y*16384)}function Cf(e){e.fv=e.pv;if(exports.DEBUG){console.log(e.step,"SFVTPV[]")}}function Of(e){var t=e.stack;var n=t.pop();var r=t.pop();var i=t.pop();var a=t.pop();var o=t.pop();var s=e.z0;var l=e.z1;var u=s[n];var h=s[r];var c=l[i];var f=l[a];var p=e.z2[o];if(exports.DEBUG){console.log("ISECT[], ",n,r,i,a,o)}var d=u.x;var v=u.y;var m=h.x;var _=h.y;var g=c.x;var y=c.y;var x=f.x;var b=f.y;var w=(d-m)*(y-b)-(v-_)*(g-x);var E=d*_-v*m;var T=g*b-y*x;p.x=(E*(g-x)-T*(d-m))/w;p.y=(E*(y-b)-T*(v-_))/w}function If(e){e.rp0=e.stack.pop();if(exports.DEBUG){console.log(e.step,"SRP0[]",e.rp0)}}function Uf(e){e.rp1=e.stack.pop();if(exports.DEBUG){console.log(e.step,"SRP1[]",e.rp1)}}function Pf(e){e.rp2=e.stack.pop();if(exports.DEBUG){console.log(e.step,"SRP2[]",e.rp2)}}function Bf(e){var t=e.stack.pop();if(exports.DEBUG){console.log(e.step,"SZP0[]",t)}e.zp0=t;switch(t){case 0:if(!e.tZone){yf(e)}e.z0=e.tZone;break;case 1:e.z0=e.gZone;break;default:throw new Error("Invalid zone pointer")}}function Df(e){var t=e.stack.pop();if(exports.DEBUG){console.log(e.step,"SZP1[]",t)}e.zp1=t;switch(t){case 0:if(!e.tZone){yf(e)}e.z1=e.tZone;break;case 1:e.z1=e.gZone;break;default:throw new Error("Invalid zone pointer")}}function Ff(e){var t=e.stack.pop();if(exports.DEBUG){console.log(e.step,"SZP2[]",t)}e.zp2=t;switch(t){case 0:if(!e.tZone){yf(e)}e.z2=e.tZone;break;case 1:e.z2=e.gZone;break;default:throw new Error("Invalid zone pointer")}}function zf(e){var t=e.stack.pop();if(exports.DEBUG){console.log(e.step,"SZPS[]",t)}e.zp0=e.zp1=e.zp2=t;switch(t){case 0:if(!e.tZone){yf(e)}e.z0=e.z1=e.z2=e.tZone;break;case 1:e.z0=e.z1=e.z2=e.gZone;break;default:throw new Error("Invalid zone pointer")}}function Nf(e){e.loop=e.stack.pop();if(exports.DEBUG){console.log(e.step,"SLOOP[]",e.loop)}}function kf(e){if(exports.DEBUG){console.log(e.step,"RTG[]")}e.round=af}function Vf(e){if(exports.DEBUG){console.log(e.step,"RTHG[]")}e.round=sf}function Wf(e){var t=e.stack.pop();if(exports.DEBUG){console.log(e.step,"SMD[]",t)}e.minDis=t/64}function Gf(e){if(exports.DEBUG){console.log(e.step,"ELSE[]")}xf(e,false)}function Hf(e){var t=e.stack.pop();if(exports.DEBUG){console.log(e.step,"JMPR[]",t)}e.ip+=t-1}function jf(e){var t=e.stack.pop();if(exports.DEBUG){console.log(e.step,"SCVTCI[]",t)}e.cvCutIn=t/64}function qf(e){var t=e.stack;if(exports.DEBUG){console.log(e.step,"DUP[]")}t.push(t[t.length-1])}function Xf(e){if(exports.DEBUG){console.log(e.step,"POP[]")}e.stack.pop()}function Yf(e){if(exports.DEBUG){console.log(e.step,"CLEAR[]")}e.stack.length=0}function Kf(e){var t=e.stack;var n=t.pop();var r=t.pop();if(exports.DEBUG){console.log(e.step,"SWAP[]")}t.push(n);t.push(r)}function Zf(e){var t=e.stack;if(exports.DEBUG){console.log(e.step,"DEPTH[]")}t.push(t.length)}function Qf(e){var t=e.stack;var n=t.pop();var r=t.pop();if(exports.DEBUG){console.log(e.step,"LOOPCALL[]",n,r)}var i=e.ip;var a=e.prog;e.prog=e.funcs[n];for(var o=0;o<r;o++){$c(e);if(exports.DEBUG){console.log(++e.step,o+1<r?"next loopcall":"done loopcall",o)}}e.ip=i;e.prog=a}function Jf(e){var t=e.stack.pop();if(exports.DEBUG){console.log(e.step,"CALL[]",t)}var n=e.ip;var r=e.prog;e.prog=e.funcs[t];$c(e);e.ip=n;e.prog=r;if(exports.DEBUG){console.log(++e.step,"returning from",t)}}function $f(e){var t=e.stack;var n=t.pop();if(exports.DEBUG){console.log(e.step,"CINDEX[]",n)}t.push(t[t.length-n])}function ep(e){var t=e.stack;var n=t.pop();if(exports.DEBUG){console.log(e.step,"MINDEX[]",n)}t.push(t.splice(t.length-n,1)[0])}function tp(e){if(e.env!=="fpgm"){throw new Error("FDEF not allowed here")}var t=e.stack;var n=e.prog;var r=e.ip;var i=t.pop();var a=r;if(exports.DEBUG){console.log(e.step,"FDEF[]",i)}while(n[++r]!==45){}e.ip=r;e.funcs[i]=n.slice(a+1,r)}function np(e,t){var n=t.stack.pop();var r=t.z0[n];var i=t.fv;var a=t.pv;if(exports.DEBUG){console.log(t.step,"MDAP["+e+"]",n)}var o=a.distance(r,mf);if(e){o=t.round(o)}i.setRelative(r,mf,o,a);i.touch(r);t.rp0=t.rp1=n}function rp(e,t){var n=t.z2;var r=n.length-2;var i;var a;var o;if(exports.DEBUG){console.log(t.step,"IUP["+e.axis+"]")}for(var s=0;s<r;s++){i=n[s];if(e.touched(i)){continue}a=i.prevTouched(e);if(a===i){continue}o=i.nextTouched(e);if(a===o){e.setRelative(i,i,e.distance(a,a,false,true),e,true)}e.interpolate(i,a,o,e)}}function ip(e,t){var n=t.stack;var r=e?t.rp1:t.rp2;var i=(e?t.z0:t.z1)[r];var a=t.fv;var o=t.pv;var s=t.loop;var l=t.z2;while(s--){var u=n.pop();var h=l[u];var c=o.distance(i,i,false,true);a.setRelative(h,h,c,o);a.touch(h);if(exports.DEBUG){console.log(t.step,(t.loop>1?"loop "+(t.loop-s)+": ":"")+"SHP["+(e?"rp1":"rp2")+"]",u)}}t.loop=1}function ap(e,t){var n=t.stack;var r=e?t.rp1:t.rp2;var i=(e?t.z0:t.z1)[r];var a=t.fv;var o=t.pv;var s=n.pop();var l=t.z2[t.contours[s]];var u=l;if(exports.DEBUG){console.log(t.step,"SHC["+e+"]",s)}var h=o.distance(i,i,false,true);do{if(u!==i){a.setRelative(u,u,h,o)}u=u.nextPointOnContour}while(u!==l)}function op(e,t){var n=t.stack;var r=e?t.rp1:t.rp2;var i=(e?t.z0:t.z1)[r];var a=t.fv;var o=t.pv;var s=n.pop();if(exports.DEBUG){console.log(t.step,"SHZ["+e+"]",s)}var l;switch(s){case 0:l=t.tZone;break;case 1:l=t.gZone;break;default:throw new Error("Invalid zone")}var u;var h=o.distance(i,i,false,true);var c=l.length-2;for(var f=0;f<c;f++){u=l[f];if(u!==i){a.setRelative(u,u,h,o)}}}function sp(e){var t=e.stack;var n=e.loop;var r=e.fv;var i=t.pop()/64;var a=e.z2;while(n--){var o=t.pop();var s=a[o];if(exports.DEBUG){console.log(e.step,(e.loop>1?"loop "+(e.loop-n)+": ":"")+"SHPIX[]",o,i)}r.setRelative(s,s,i);r.touch(s)}e.loop=1}function lp(e){var t=e.stack;var n=e.rp1;var r=e.rp2;var i=e.loop;var a=e.z0[n];var o=e.z1[r];var s=e.fv;var l=e.dpv;var u=e.z2;while(i--){var h=t.pop();var c=u[h];if(exports.DEBUG){console.log(e.step,(e.loop>1?"loop "+(e.loop-i)+": ":"")+"IP[]",h,n,"<->",r)}s.interpolate(c,a,o,l);s.touch(c)}e.loop=1}function up(e,t){var n=t.stack;var r=n.pop()/64;var i=n.pop();var a=t.z1[i];var o=t.z0[t.rp0];var s=t.fv;var l=t.pv;s.setRelative(a,o,r,l);s.touch(a);if(exports.DEBUG){console.log(t.step,"MSIRP["+e+"]",r,i)}t.rp1=t.rp0;t.rp2=i;if(e){t.rp0=i}}function hp(e){var t=e.stack;var n=e.rp0;var r=e.z0[n];var i=e.loop;var a=e.fv;var o=e.pv;var s=e.z1;while(i--){var l=t.pop();var u=s[l];if(exports.DEBUG){console.log(e.step,(e.loop>1?"loop "+(e.loop-i)+": ":"")+"ALIGNRP[]",l)}a.setRelative(u,r,0,o);a.touch(u)}e.loop=1}function cp(e){if(exports.DEBUG){console.log(e.step,"RTDG[]")}e.round=of}function fp(e,t){var n=t.stack;var r=n.pop();var i=n.pop();var a=t.z0[i];var o=t.fv;var s=t.pv;var l=t.cvt[r];if(e){l=t.round(l)}if(exports.DEBUG){console.log(t.step,"MIAP["+e+"]",r,"(",l,")",i)}o.setRelative(a,mf,l,s);if(t.zp0===0){a.xo=a.x;a.yo=a.y}o.touch(a);t.rp0=t.rp1=i}function pp(e){var t=e.prog;var n=e.ip;var r=e.stack;var i=t[++n];if(exports.DEBUG){console.log(e.step,"NPUSHB[]",i)}for(var a=0;a<i;a++){r.push(t[++n])}e.ip=n}function dp(e){var t=e.ip;var n=e.prog;var r=e.stack;var i=n[++t];if(exports.DEBUG){console.log(e.step,"NPUSHW[]",i)}for(var a=0;a<i;a++){var o=n[++t]<<8|n[++t];if(o&32768){o=-((o^65535)+1)}r.push(o)}e.ip=t}function vp(e){var t=e.stack;var n=e.store;if(!n){n=e.store=[]}var r=t.pop();var i=t.pop();if(exports.DEBUG){console.log(e.step,"WS",r,i)}n[i]=r}function mp(e){var t=e.stack;var n=e.store;var r=t.pop();if(exports.DEBUG){console.log(e.step,"RS",r)}var i=n&&n[r]||0;t.push(i)}function _p(e){var t=e.stack;var n=t.pop();var r=t.pop();if(exports.DEBUG){console.log(e.step,"WCVTP",n,r)}e.cvt[r]=n/64}function gp(e){var t=e.stack;var n=t.pop();if(exports.DEBUG){console.log(e.step,"RCVT",n)}t.push(e.cvt[n]*64)}function yp(e,t){var n=t.stack;var r=n.pop();var i=t.z2[r];if(exports.DEBUG){console.log(t.step,"GC["+e+"]",r)}n.push(t.dpv.distance(i,mf,e,false)*64)}function xp(e,t){var n=t.stack;var r=n.pop();var i=n.pop();var a=t.z1[r];var o=t.z0[i];var s=t.dpv.distance(o,a,e,e);if(exports.DEBUG){console.log(t.step,"MD["+e+"]",r,i,"->",s)}t.stack.push(Math.round(s*64))}function bp(e){if(exports.DEBUG){console.log(e.step,"MPPEM[]")}e.stack.push(e.ppem)}function wp(e){if(exports.DEBUG){console.log(e.step,"FLIPON[]")}e.autoFlip=true}function Ep(e){var t=e.stack;var n=t.pop();var r=t.pop();if(exports.DEBUG){console.log(e.step,"LT[]",n,r)}t.push(r<n?1:0)}function Tp(e){var t=e.stack;var n=t.pop();var r=t.pop();if(exports.DEBUG){console.log(e.step,"LTEQ[]",n,r)}t.push(r<=n?1:0)}function Sp(e){var t=e.stack;var n=t.pop();var r=t.pop();if(exports.DEBUG){console.log(e.step,"GT[]",n,r)}t.push(r>n?1:0)}function Ap(e){var t=e.stack;var n=t.pop();var r=t.pop();if(exports.DEBUG){console.log(e.step,"GTEQ[]",n,r)}t.push(r>=n?1:0)}function Mp(e){var t=e.stack;var n=t.pop();var r=t.pop();if(exports.DEBUG){console.log(e.step,"EQ[]",n,r)}t.push(n===r?1:0)}function Rp(e){var t=e.stack;var n=t.pop();var r=t.pop();if(exports.DEBUG){console.log(e.step,"NEQ[]",n,r)}t.push(n!==r?1:0)}function Lp(e){var t=e.stack;var n=t.pop();if(exports.DEBUG){console.log(e.step,"ODD[]",n)}t.push(Math.trunc(n)%2?1:0)}function Cp(e){var t=e.stack;var n=t.pop();if(exports.DEBUG){console.log(e.step,"EVEN[]",n)}t.push(Math.trunc(n)%2?0:1)}function Op(e){var t=e.stack.pop();var n;if(exports.DEBUG){console.log(e.step,"IF[]",t)}if(!t){xf(e,true);if(exports.DEBUG){console.log(e.step,n===27?"ELSE[]":"EIF[]")}}}function Ip(e){if(exports.DEBUG){console.log(e.step,"EIF[]")}}function Up(e){var t=e.stack;var n=t.pop();var r=t.pop();if(exports.DEBUG){console.log(e.step,"AND[]",n,r)}t.push(n&&r?1:0)}function Pp(e){var t=e.stack;var n=t.pop();var r=t.pop();if(exports.DEBUG){console.log(e.step,"OR[]",n,r)}t.push(n||r?1:0)}function Bp(e){var t=e.stack;var n=t.pop();if(exports.DEBUG){console.log(e.step,"NOT[]",n)}t.push(n?0:1)}function Dp(e,t){var n=t.stack;var r=n.pop();var i=t.fv;var a=t.pv;var o=t.ppem;var s=t.deltaBase+(e-1)*16;var l=t.deltaShift;var u=t.z0;if(exports.DEBUG){console.log(t.step,"DELTAP["+e+"]",r,n)}for(var h=0;h<r;h++){var c=n.pop();var f=n.pop();var p=s+((f&240)>>4);if(p!==o){continue}var d=(f&15)-8;if(d>=0){d++}if(exports.DEBUG){console.log(t.step,"DELTAPFIX",c,"by",d*l)}var v=u[c];i.setRelative(v,v,d*l,a)}}function Fp(e){var t=e.stack;var n=t.pop();if(exports.DEBUG){console.log(e.step,"SDB[]",n)}e.deltaBase=n}function zp(e){var t=e.stack;var n=t.pop();if(exports.DEBUG){console.log(e.step,"SDS[]",n)}e.deltaShift=Math.pow(.5,n)}function Np(e){var t=e.stack;var n=t.pop();var r=t.pop();if(exports.DEBUG){console.log(e.step,"ADD[]",n,r)}t.push(r+n)}function kp(e){var t=e.stack;var n=t.pop();var r=t.pop();if(exports.DEBUG){console.log(e.step,"SUB[]",n,r)}t.push(r-n)}function Vp(e){var t=e.stack;var n=t.pop();var r=t.pop();if(exports.DEBUG){console.log(e.step,"DIV[]",n,r)}t.push(r*64/n)}function Wp(e){var t=e.stack;var n=t.pop();var r=t.pop();if(exports.DEBUG){console.log(e.step,"MUL[]",n,r)}t.push(r*n/64)}function Gp(e){var t=e.stack;var n=t.pop();if(exports.DEBUG){console.log(e.step,"ABS[]",n)}t.push(Math.abs(n))}function Hp(e){var t=e.stack;var n=t.pop();if(exports.DEBUG){console.log(e.step,"NEG[]",n)}t.push(-n)}function jp(e){var t=e.stack;var n=t.pop();if(exports.DEBUG){console.log(e.step,"FLOOR[]",n)}t.push(Math.floor(n/64)*64)}function qp(e){var t=e.stack;var n=t.pop();if(exports.DEBUG){console.log(e.step,"CEILING[]",n)}t.push(Math.ceil(n/64)*64)}function Xp(e,t){var n=t.stack;var r=n.pop();if(exports.DEBUG){console.log(t.step,"ROUND[]")}n.push(t.round(r/64)*64)}function Yp(e){var t=e.stack;var n=t.pop();var r=t.pop();if(exports.DEBUG){console.log(e.step,"WCVTF[]",n,r)}e.cvt[r]=n*e.ppem/e.font.unitsPerEm}function Kp(e,t){var n=t.stack;var r=n.pop();var i=t.ppem;var a=t.deltaBase+(e-1)*16;var o=t.deltaShift;if(exports.DEBUG){console.log(t.step,"DELTAC["+e+"]",r,n)}for(var s=0;s<r;s++){var l=n.pop();var u=n.pop();var h=a+((u&240)>>4);if(h!==i){continue}var c=(u&15)-8;if(c>=0){c++}var f=c*o;if(exports.DEBUG){console.log(t.step,"DELTACFIX",l,"by",f)}t.cvt[l]+=f}}function Zp(e){var t=e.stack.pop();if(exports.DEBUG){console.log(e.step,"SROUND[]",t)}e.round=hf;var n;switch(t&192){case 0:n=.5;break;case 64:n=1;break;case 128:n=2;break;default:throw new Error("invalid SROUND value")}e.srPeriod=n;switch(t&48){case 0:e.srPhase=0;break;case 16:e.srPhase=.25*n;break;case 32:e.srPhase=.5*n;break;case 48:e.srPhase=.75*n;break;default:throw new Error("invalid SROUND value")}t&=15;if(t===0){e.srThreshold=0}else{e.srThreshold=(t/8-.5)*n}}function Qp(e){var t=e.stack.pop();if(exports.DEBUG){console.log(e.step,"S45ROUND[]",t)}e.round=hf;var n;switch(t&192){case 0:n=Math.sqrt(2)/2;break;case 64:n=Math.sqrt(2);break;case 128:n=2*Math.sqrt(2);break;default:throw new Error("invalid S45ROUND value")}e.srPeriod=n;switch(t&48){case 0:e.srPhase=0;break;case 16:e.srPhase=.25*n;break;case 32:e.srPhase=.5*n;break;case 48:e.srPhase=.75*n;break;default:throw new Error("invalid S45ROUND value")}t&=15;if(t===0){e.srThreshold=0}else{e.srThreshold=(t/8-.5)*n}}function Jp(e){if(exports.DEBUG){console.log(e.step,"ROFF[]")}e.round=rf}function $p(e){if(exports.DEBUG){console.log(e.step,"RUTG[]")}e.round=lf}function ed(e){if(exports.DEBUG){console.log(e.step,"RDTG[]")}e.round=uf}function td(e){var t=e.stack.pop();if(exports.DEBUG){console.log(e.step,"SCANCTRL[]",t)}}function nd(e,t){var n=t.stack;var r=n.pop();var i=n.pop();var a=t.z2[r];var o=t.z1[i];if(exports.DEBUG){console.log("SDPVTL["+e+"]",r,i)}var s;var l;if(!e){s=o.x-a.x;l=o.y-a.y}else{s=a.y-o.y;l=o.x-a.x}t.dpv=df(s,l)}function rd(e){var t=e.stack;var n=t.pop();var r=0;if(exports.DEBUG){console.log(e.step,"GETINFO[]",n)}if(n&1){r=35}if(n&32){r|=4096}t.push(r)}function id(e){var t=e.stack;var n=t.pop();var r=t.pop();var i=t.pop();if(exports.DEBUG){console.log(e.step,"ROLL[]")}t.push(r);t.push(n);t.push(i)}function ad(e){var t=e.stack;var n=t.pop();var r=t.pop();if(exports.DEBUG){console.log(e.step,"MAX[]",n,r)}t.push(Math.max(r,n))}function od(e){var t=e.stack;var n=t.pop();var r=t.pop();if(exports.DEBUG){console.log(e.step,"MIN[]",n,r)}t.push(Math.min(r,n))}function sd(e){var t=e.stack.pop();if(exports.DEBUG){console.log(e.step,"SCANTYPE[]",t)}}function ld(e){var t=e.stack.pop();var n=e.stack.pop();if(exports.DEBUG){console.log(e.step,"INSTCTRL[]",t,n)}switch(t){case 1:e.inhibitGridFit=!!n;return;case 2:e.ignoreCvt=!!n;return;default:throw new Error("invalid INSTCTRL[] selector")}}function ud(e,t){var n=t.stack;var r=t.prog;var i=t.ip;if(exports.DEBUG){console.log(t.step,"PUSHB["+e+"]")}for(var a=0;a<e;a++){n.push(r[++i])}t.ip=i}function hd(e,t){var n=t.ip;var r=t.prog;var i=t.stack;if(exports.DEBUG){console.log(t.ip,"PUSHW["+e+"]")}for(var a=0;a<e;a++){var o=r[++n]<<8|r[++n];if(o&32768){o=-((o^65535)+1)}i.push(o)}t.ip=n}function cd(e,t,n,r,i,a){var o=a.stack;var s=e&&o.pop();var l=o.pop();var u=a.rp0;var h=a.z0[u];var c=a.z1[l];var f=a.minDis;var p=a.fv;var d=a.dpv;var v;var m;var _;var g;m=v=d.distance(c,h,true,true);_=m>=0?1:-1;m=Math.abs(m);if(e){g=a.cvt[s];if(r&&Math.abs(m-g)<a.cvCutIn){m=g}}if(n&&m<f){m=f}if(r){m=a.round(m)}p.setRelative(c,h,_*m,d);p.touch(c);if(exports.DEBUG){console.log(a.step,(e?"MIRP[":"MDRP[")+(t?"M":"m")+(n?">":"_")+(r?"R":"_")+(i===0?"Gr":i===1?"Bl":i===2?"Wh":"")+"]",e?s+"("+a.cvt[s]+","+g+")":"",l,"(d =",v,"->",_*m,")")}a.rp1=a.rp0;a.rp2=l;if(t){a.rp0=l}}Jc=[bf.bind(undefined,ff),bf.bind(undefined,cf),wf.bind(undefined,ff),wf.bind(undefined,cf),Ef.bind(undefined,ff),Ef.bind(undefined,cf),Tf.bind(undefined,0),Tf.bind(undefined,1),Sf.bind(undefined,0),Sf.bind(undefined,1),Af,Mf,Rf,Lf,Cf,Of,If,Uf,Pf,Bf,Df,Ff,zf,Nf,kf,Vf,Wf,Gf,Hf,jf,undefined,undefined,qf,Xf,Yf,Kf,Zf,$f,ep,undefined,undefined,undefined,Qf,Jf,tp,undefined,np.bind(undefined,0),np.bind(undefined,1),rp.bind(undefined,ff),rp.bind(undefined,cf),ip.bind(undefined,0),ip.bind(undefined,1),ap.bind(undefined,0),ap.bind(undefined,1),op.bind(undefined,0),op.bind(undefined,1),sp,lp,up.bind(undefined,0),up.bind(undefined,1),hp,cp,fp.bind(undefined,0),fp.bind(undefined,1),pp,dp,vp,mp,_p,gp,yp.bind(undefined,0),yp.bind(undefined,1),undefined,xp.bind(undefined,0),xp.bind(undefined,1),bp,undefined,wp,undefined,undefined,Ep,Tp,Sp,Ap,Mp,Rp,Lp,Cp,Op,Ip,Up,Pp,Bp,Dp.bind(undefined,1),Fp,zp,Np,kp,Vp,Wp,Gp,Hp,jp,qp,Xp.bind(undefined,0),Xp.bind(undefined,1),Xp.bind(undefined,2),Xp.bind(undefined,3),undefined,undefined,undefined,undefined,Yp,Dp.bind(undefined,2),Dp.bind(undefined,3),Kp.bind(undefined,1),Kp.bind(undefined,2),Kp.bind(undefined,3),Zp,Qp,undefined,undefined,Jp,undefined,$p,ed,Xf,Xf,undefined,undefined,undefined,undefined,undefined,td,nd.bind(undefined,0),nd.bind(undefined,1),rd,undefined,id,ad,od,sd,ld,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,ud.bind(undefined,1),ud.bind(undefined,2),ud.bind(undefined,3),ud.bind(undefined,4),ud.bind(undefined,5),ud.bind(undefined,6),ud.bind(undefined,7),ud.bind(undefined,8),hd.bind(undefined,1),hd.bind(undefined,2),hd.bind(undefined,3),hd.bind(undefined,4),hd.bind(undefined,5),hd.bind(undefined,6),hd.bind(undefined,7),hd.bind(undefined,8),cd.bind(undefined,0,0,0,0,0),cd.bind(undefined,0,0,0,0,1),cd.bind(undefined,0,0,0,0,2),cd.bind(undefined,0,0,0,0,3),cd.bind(undefined,0,0,0,1,0),cd.bind(undefined,0,0,0,1,1),cd.bind(undefined,0,0,0,1,2),cd.bind(undefined,0,0,0,1,3),cd.bind(undefined,0,0,1,0,0),cd.bind(undefined,0,0,1,0,1),cd.bind(undefined,0,0,1,0,2),cd.bind(undefined,0,0,1,0,3),cd.bind(undefined,0,0,1,1,0),cd.bind(undefined,0,0,1,1,1),cd.bind(undefined,0,0,1,1,2),cd.bind(undefined,0,0,1,1,3),cd.bind(undefined,0,1,0,0,0),cd.bind(undefined,0,1,0,0,1),cd.bind(undefined,0,1,0,0,2),cd.bind(undefined,0,1,0,0,3),cd.bind(undefined,0,1,0,1,0),cd.bind(undefined,0,1,0,1,1),cd.bind(undefined,0,1,0,1,2),cd.bind(undefined,0,1,0,1,3),cd.bind(undefined,0,1,1,0,0),cd.bind(undefined,0,1,1,0,1),cd.bind(undefined,0,1,1,0,2),cd.bind(undefined,0,1,1,0,3),cd.bind(undefined,0,1,1,1,0),cd.bind(undefined,0,1,1,1,1),cd.bind(undefined,0,1,1,1,2),cd.bind(undefined,0,1,1,1,3),cd.bind(undefined,1,0,0,0,0),cd.bind(undefined,1,0,0,0,1),cd.bind(undefined,1,0,0,0,2),cd.bind(undefined,1,0,0,0,3),cd.bind(undefined,1,0,0,1,0),cd.bind(undefined,1,0,0,1,1),cd.bind(undefined,1,0,0,1,2),cd.bind(undefined,1,0,0,1,3),cd.bind(undefined,1,0,1,0,0),cd.bind(undefined,1,0,1,0,1),cd.bind(undefined,1,0,1,0,2),cd.bind(undefined,1,0,1,0,3),cd.bind(undefined,1,0,1,1,0),cd.bind(undefined,1,0,1,1,1),cd.bind(undefined,1,0,1,1,2),cd.bind(undefined,1,0,1,1,3),cd.bind(undefined,1,1,0,0,0),cd.bind(undefined,1,1,0,0,1),cd.bind(undefined,1,1,0,0,2),cd.bind(undefined,1,1,0,0,3),cd.bind(undefined,1,1,0,1,0),cd.bind(undefined,1,1,0,1,1),cd.bind(undefined,1,1,0,1,2),cd.bind(undefined,1,1,0,1,3),cd.bind(undefined,1,1,1,0,0),cd.bind(undefined,1,1,1,0,1),cd.bind(undefined,1,1,1,0,2),cd.bind(undefined,1,1,1,0,3),cd.bind(undefined,1,1,1,1,0),cd.bind(undefined,1,1,1,1,1),cd.bind(undefined,1,1,1,1,2),cd.bind(undefined,1,1,1,1,3)];function fd(e){e=e||{};if(!e.empty){Qc(e.familyName,"When creating a new Font object, familyName is required.");Qc(e.styleName,"When creating a new Font object, styleName is required.");Qc(e.unitsPerEm,"When creating a new Font object, unitsPerEm is required.");Qc(e.ascender,"When creating a new Font object, ascender is required.");Qc(e.descender,"When creating a new Font object, descender is required.");Qc(e.descender<0,"Descender should be negative (e.g. -512).");this.names={fontFamily:{en:e.familyName||" "},fontSubfamily:{en:e.styleName||" "},fullName:{en:e.fullName||e.familyName+" "+e.styleName},postScriptName:{en:e.postScriptName||e.familyName+e.styleName},designer:{en:e.designer||" "},designerURL:{en:e.designerURL||" "},manufacturer:{en:e.manufacturer||" "},manufacturerURL:{en:e.manufacturerURL||" "},license:{en:e.license||" "},licenseURL:{en:e.licenseURL||" "},version:{en:e.version||"Version 0.1"},description:{en:e.description||" "},copyright:{en:e.copyright||" "},trademark:{en:e.trademark||" "}};this.unitsPerEm=e.unitsPerEm||1e3;this.ascender=e.ascender;this.descender=e.descender;this.createdTimestamp=e.createdTimestamp;this.tables={os2:{usWeightClass:e.weightClass||this.usWeightClasses.MEDIUM,usWidthClass:e.widthClass||this.usWidthClasses.MEDIUM,fsSelection:e.fsSelection||this.fsSelectionValues.REGULAR}}}this.supported=true;this.glyphs=new oh.GlyphSet(this,e.glyphs||[]);this.encoding=new zu(this);this.substitution=new qc(this);this.tables=this.tables||{};Object.defineProperty(this,"hinting",{get:function(){if(this._hinting){return this._hinting}if(this.outlinesFormat==="truetype"){return this._hinting=new nf(this)}}})}fd.prototype.hasChar=function(e){return this.encoding.charToGlyphIndex(e)!==null};fd.prototype.charToGlyphIndex=function(e){return this.encoding.charToGlyphIndex(e)};fd.prototype.charToGlyph=function(e){var t=this.charToGlyphIndex(e);var n=this.glyphs.get(t);if(!n){n=this.glyphs.get(0)}return n};fd.prototype.stringToGlyphs=function(e,t){var n=this;t=t||this.defaultRenderOptions;var r=[];for(var i=0;i<e.length;i+=1){var a=e[i];r.push(n.charToGlyphIndex(a))}var o=r.length;if(t.features){var s=t.script||this.substitution.getDefaultScriptName();var l=[];if(t.features.liga){l=l.concat(this.substitution.getFeature("liga",s,t.language))}if(t.features.rlig){l=l.concat(this.substitution.getFeature("rlig",s,t.language))}for(var u=0;u<o;u+=1){for(var h=0;h<l.length;h++){var c=l[h];var f=c.sub;var p=f.length;var d=0;while(d<p&&f[d]===r[u+d]){d++}if(d===p){r.splice(u,p,c.by);o=o-p+1}}}}var v=new Array(o);var m=this.glyphs.get(0);for(var _=0;_<o;_+=1){v[_]=n.glyphs.get(r[_])||m}return v};fd.prototype.nameToGlyphIndex=function(e){return this.glyphNames.nameToGlyphIndex(e)};fd.prototype.nameToGlyph=function(e){var t=this.nameToGlyphIndex(e);var n=this.glyphs.get(t);if(!n){n=this.glyphs.get(0)}return n};fd.prototype.glyphIndexToName=function(e){if(!this.glyphNames.glyphIndexToName){return""}return this.glyphNames.glyphIndexToName(e)};fd.prototype.getKerningValue=function(e,t){e=e.index||e;t=t.index||t;var n=this.getGposKerningValue;return n?n(e,t):this.kerningPairs[e+","+t]||0};fd.prototype.defaultRenderOptions={kerning:true,features:{liga:true,rlig:true}};fd.prototype.forEachGlyph=function(e,t,n,r,i,a){var o=this;t=t!==undefined?t:0;n=n!==undefined?n:0;r=r!==undefined?r:72;i=i||this.defaultRenderOptions;var s=1/this.unitsPerEm*r;var l=this.stringToGlyphs(e,i);for(var u=0;u<l.length;u+=1){var h=l[u];a.call(o,h,t,n,r,i);if(h.advanceWidth){t+=h.advanceWidth*s}if(i.kerning&&u<l.length-1){var c=o.getKerningValue(h,l[u+1]);t+=c*s}if(i.letterSpacing){t+=i.letterSpacing*r}else if(i.tracking){t+=i.tracking/1e3*r}}return t};fd.prototype.getPath=function(e,t,n,r,a){var o=new kl;this.forEachGlyph(e,t,n,r,a,function(e,t,n,r){var i=e.getPath(t,n,r,a,this);o.extend(i)});return o};fd.prototype.getPaths=function(e,t,n,r,a){var o=[];this.forEachGlyph(e,t,n,r,a,function(e,t,n,r){var i=e.getPath(t,n,r,a,this);o.push(i)});return o};fd.prototype.getAdvanceWidth=function(e,t,n){return this.forEachGlyph(e,0,0,t,n,function(){})};fd.prototype.draw=function(e,t,n,r,i,a){this.getPath(t,n,r,i,a).draw(e)};fd.prototype.drawPoints=function(i,e,t,n,r,a){this.forEachGlyph(e,t,n,r,a,function(e,t,n,r){e.drawPoints(i,t,n,r)})};fd.prototype.drawMetrics=function(i,e,t,n,r,a){this.forEachGlyph(e,t,n,r,a,function(e,t,n,r){e.drawMetrics(i,t,n,r)})};fd.prototype.getEnglishName=function(e){var t=this.names[e];if(t){return t.en}};fd.prototype.validate=function(){var n=[];var r=this;function i(e,t){if(!e){n.push(t)}}function e(e){var t=r.getEnglishName(e);i(t&&t.trim().length>0,"No English "+e+" specified.")}e("fontFamily");e("weightName");e("manufacturer");e("copyright");e("version");i(this.unitsPerEm>0,"No unitsPerEm specified.")};fd.prototype.toTables=function(){return Wc.fontToTable(this)};fd.prototype.toBuffer=function(){console.warn("Font.toBuffer is deprecated. Use Font.toArrayBuffer instead.");return this.toArrayBuffer()};fd.prototype.toArrayBuffer=function(){var e=this.toTables();var t=e.encode();var n=new ArrayBuffer(t.length);var r=new Uint8Array(n);for(var i=0;i<t.length;i++){r[i]=t[i]}return n};fd.prototype.download=function(t){var e=this.getEnglishName("fontFamily");var n=this.getEnglishName("fontSubfamily");t=t||e.replace(/\s/g,"")+"-"+n+".otf";var i=this.toArrayBuffer();if(Kc()){window.requestFileSystem=window.requestFileSystem||window.webkitRequestFileSystem;window.requestFileSystem(window.TEMPORARY,i.byteLength,function(e){e.root.getFile(t,{create:true},function(r){r.createWriter(function(e){var t=new DataView(i);var n=new Blob([t],{type:"font/opentype"});e.write(n);e.addEventListener("writeend",function(){location.href=r.toURL()},false)})})},function(e){throw new Error(e.name+": "+e.message)})}else{var r=require("fs");var a=Zc(i);r.writeFileSync(t,a)}};fd.prototype.fsSelectionValues={ITALIC:1,UNDERSCORE:2,NEGATIVE:4,OUTLINED:8,STRIKEOUT:16,BOLD:32,REGULAR:64,USER_TYPO_METRICS:128,WWS:256,OBLIQUE:512};fd.prototype.usWidthClasses={ULTRA_CONDENSED:1,EXTRA_CONDENSED:2,CONDENSED:3,SEMI_CONDENSED:4,MEDIUM:5,SEMI_EXPANDED:6,EXPANDED:7,EXTRA_EXPANDED:8,ULTRA_EXPANDED:9};fd.prototype.usWeightClasses={THIN:100,EXTRA_LIGHT:200,LIGHT:300,NORMAL:400,MEDIUM:500,SEMI_BOLD:600,BOLD:700,EXTRA_BOLD:800,BLACK:900};function pd(e,t){var n=JSON.stringify(e);var r=256;for(var i in t){var a=parseInt(i);if(!a||a<256){continue}if(JSON.stringify(t[i])===n){return a}if(r<=a){r=a+1}}t[r]=e;return r}function dd(e,t,n){var r=pd(t.name,n);return[{name:"tag_"+e,type:"TAG",value:t.tag},{name:"minValue_"+e,type:"FIXED",value:t.minValue<<16},{name:"defaultValue_"+e,type:"FIXED",value:t.defaultValue<<16},{name:"maxValue_"+e,type:"FIXED",value:t.maxValue<<16},{name:"flags_"+e,type:"USHORT",value:0},{name:"nameID_"+e,type:"USHORT",value:r}]}function vd(e,t,n){var r={};var i=new Au.Parser(e,t);r.tag=i.parseTag();r.minValue=i.parseFixed();r.defaultValue=i.parseFixed();r.maxValue=i.parseFixed();i.skip("uShort",1);r.name=n[i.parseUShort()]||{};return r}function md(e,t,n,r){var i=pd(t.name,r);var a=[{name:"nameID_"+e,type:"USHORT",value:i},{name:"flags_"+e,type:"USHORT",value:0}];for(var o=0;o<n.length;++o){var s=n[o].tag;a.push({name:"axis_"+e+" "+s,type:"FIXED",value:t.coordinates[s]<<16})}return a}function _d(e,t,n,r){var i={};var a=new Au.Parser(e,t);i.name=r[a.parseUShort()]||{};a.skip("uShort",1);i.coordinates={};for(var o=0;o<n.length;++o){i.coordinates[n[o].tag]=a.parseFixed()}return i}function gd(e,t){var n=new pu.Table("fvar",[{name:"version",type:"ULONG",value:65536},{name:"offsetToData",type:"USHORT",value:0},{name:"countSizePairs",type:"USHORT",value:2},{name:"axisCount",type:"USHORT",value:e.axes.length},{name:"axisSize",type:"USHORT",value:20},{name:"instanceCount",type:"USHORT",value:e.instances.length},{name:"instanceSize",type:"USHORT",value:4+e.axes.length*4}]);n.offsetToData=n.sizeOf();for(var r=0;r<e.axes.length;r++){n.fields=n.fields.concat(dd(r,e.axes[r],t))}for(var i=0;i<e.instances.length;i++){n.fields=n.fields.concat(md(i,e.instances[i],e.axes,t))}return n}function yd(e,t,n){var r=new Au.Parser(e,t);var i=r.parseULong();Gl.argument(i===65536,"Unsupported fvar table version.");var a=r.parseOffset16();r.skip("uShort",1);var o=r.parseUShort();var s=r.parseUShort();var l=r.parseUShort();var u=r.parseUShort();var h=[];for(var c=0;c<o;c++){h.push(vd(e,t+a+c*s,n))}var f=[];var p=t+a+o*s;for(var d=0;d<l;d++){f.push(_d(e,p+d*u,h,n))}return{axes:h,instances:f}}var xd={make:gd,parse:yd};function bd(e,t){var n=new Au.Parser(e,t);var r=n.parseUShort();var i=[];for(var a=0;a<r;a++){i[n.parseTag()]={offset:n.parseUShort()}}return i}function wd(e,t){var n=new Au.Parser(e,t);var r=n.parseUShort();var i=n.parseUShort();if(r===1){return n.parseUShortList(i)}else if(r===2){var a=[];for(;i--;){var o=n.parseUShort();var s=n.parseUShort();var l=n.parseUShort();for(var u=o;u<=s;u++){a[l++]=u}}return a}}function Ed(e,t){var n=new Au.Parser(e,t);var r=n.parseUShort();if(r===1){var i=n.parseUShort();var a=n.parseUShort();var o=n.parseUShortList(a);return function(e){return o[e-i]||0}}else if(r===2){var s=n.parseUShort();var l=[];var u=[];var h=[];for(var c=0;c<s;c++){l[c]=n.parseUShort();u[c]=n.parseUShort();h[c]=n.parseUShort()}return function(e){var t=0;var n=l.length-1;while(t<n){var r=t+n+1>>1;if(e<l[r]){n=r-1}else{t=r}}if(l[t]<=e&&e<=u[t]){return h[t]||0}return 0}}}function Td(e,t){var n=new Au.Parser(e,t);var r=n.parseUShort();var i=n.parseUShort();var a=wd(e,t+i);var o=n.parseUShort();var s=n.parseUShort();var l;var u;if(o!==4||s!==0){return}var h={};if(r===1){var c=n.parseUShort();var f=[];var p=n.parseOffset16List(c);for(var d=0;d<c;d++){var v=p[d];var m=h[v];if(!m){m={};n.relativeOffset=v;var _=n.parseUShort();for(;_--;){var g=n.parseUShort();if(o){l=n.parseShort()}if(s){u=n.parseShort()}m[g]=l}}f[a[d]]=m}return function(e,t){var n=f[e];if(n){return n[t]}}}else if(r===2){var y=n.parseUShort();var x=n.parseUShort();var b=n.parseUShort();var w=n.parseUShort();var E=Ed(e,t+y);var T=Ed(e,t+x);var S=[];for(var A=0;A<b;A++){var M=S[A]=[];for(var R=0;R<w;R++){if(o){l=n.parseShort()}if(s){u=n.parseShort()}M[R]=l}}var L={};for(var C=0;C<a.length;C++){L[a[C]]=1}return function(e,t){if(!L[e]){return}var n=E(e);var r=T(t);var i=S[n];if(i){return i[r]}}}}function Sd(e,t){var n=new Au.Parser(e,t);var r=n.parseUShort();var i=n.parseUShort();var a=i&16;var o=n.parseUShort();var s=n.parseOffset16List(o);var l={lookupType:r,lookupFlag:i,markFilteringSet:a?n.parseUShort():-1};if(r===2){var u=[];for(var h=0;h<o;h++){var c=Td(e,t+s[h]);if(c){u.push(c)}}l.getKerningValue=function(e,t){for(var n=u.length;n--;){var r=u[n](e,t);if(r!==undefined){return r}}return 0}}return l}function Ad(e,t,n){var r=new Au.Parser(e,t);var i=r.parseFixed();Gl.argument(i===1,"Unsupported GPOS table version.");bd(e,t+r.parseUShort());bd(e,t+r.parseUShort());var a=r.parseUShort();r.relativeOffset=a;var o=r.parseUShort();var s=r.parseOffset16List(o);var l=t+a;for(var u=0;u<o;u++){var h=Sd(e,l+s[u]);if(h.lookupType===2&&!n.getGposKerningValue){n.getGposKerningValue=h.getKerningValue}}}var Md={parse:Ad};function Rd(e){var t={};e.skip("uShort");var n=e.parseUShort();Gl.argument(n===0,"Unsupported kern sub-table version.");e.skip("uShort",2);var r=e.parseUShort();e.skip("uShort",3);for(var i=0;i<r;i+=1){var a=e.parseUShort();var o=e.parseUShort();var s=e.parseShort();t[a+","+o]=s}return t}function Ld(e){var t={};e.skip("uShort");var n=e.parseULong();if(n>1){console.warn("Only the first kern subtable is supported.")}e.skip("uLong");var r=e.parseUShort();var i=r&255;e.skip("uShort");if(i===0){var a=e.parseUShort();e.skip("uShort",3);for(var o=0;o<a;o+=1){var s=e.parseUShort();var l=e.parseUShort();var u=e.parseShort();t[s+","+l]=u}}return t}function Cd(e,t){var n=new Au.Parser(e,t);var r=n.parseUShort();if(r===0){return Rd(n)}else if(r===1){return Ld(n)}else{throw new Error("Unsupported kern table version ("+r+").")}}var Od={parse:Cd};function Id(e,t,n,r){var i=new Au.Parser(e,t);var a=r?i.parseUShort:i.parseULong;var o=[];for(var s=0;s<n+1;s+=1){var l=a.call(i);if(r){l*=2}o.push(l)}return o}var Ud={parse:Id};function Pd(e,t){var n=[];var r=12;for(var i=0;i<t;i+=1){var a=Au.getTag(e,r);var o=Au.getULong(e,r+4);var s=Au.getULong(e,r+8);var l=Au.getULong(e,r+12);n.push({tag:a,checksum:o,offset:s,length:l,compression:false});r+=16}return n}function Bd(e,t){var n=[];var r=44;for(var i=0;i<t;i+=1){var a=Au.getTag(e,r);var o=Au.getULong(e,r+4);var s=Au.getULong(e,r+8);var l=Au.getULong(e,r+12);var u=void 0;if(s<l){u="WOFF"}else{u=false}n.push({tag:a,offset:o,compression:u,compressedLength:s,length:l});r+=20}return n}function Dd(e,t){if(t.compression==="WOFF"){var n=new Uint8Array(e.buffer,t.offset+2,t.compressedLength-2);var r=new Uint8Array(t.length);Fl(n,r);if(r.byteLength!==t.length){throw new Error("Decompression error: "+t.tag+" decompressed length doesn't match recorded length")}var i=new DataView(r.buffer,0);return{data:i,offset:0}}else{return{data:e,offset:t.offset}}}function Fd(e){var t;var n;var r=new fd({empty:true});var i=new DataView(e,0);var a;var o=[];var s=Au.getTag(i,0);if(s===String.fromCharCode(0,1,0,0)||s==="true"||s==="typ1"){r.outlinesFormat="truetype";a=Au.getUShort(i,4);o=Pd(i,a)}else if(s==="OTTO"){r.outlinesFormat="cff";a=Au.getUShort(i,4);o=Pd(i,a)}else if(s==="wOFF"){var l=Au.getTag(i,4);if(l===String.fromCharCode(0,1,0,0)){r.outlinesFormat="truetype"}else if(l==="OTTO"){r.outlinesFormat="cff"}else{throw new Error("Unsupported OpenType flavor "+s)}a=Au.getUShort(i,12);o=Bd(i,a)}else{throw new Error("Unsupported OpenType signature "+s)}var u;var h;var c;var f;var p;var d;var v;var m;var _;var g;var y;for(var x=0;x<a;x+=1){var b=o[x];var w=void 0;switch(b.tag){case"cmap":w=Dd(i,b);r.tables.cmap=Uu.parse(w.data,w.offset);r.encoding=new Nu(r.tables.cmap);break;case"cvt ":w=Dd(i,b);y=new Au.Parser(w.data,w.offset);r.tables.cvt=y.parseShortList(b.length/2);break;case"fvar":h=b;break;case"fpgm":w=Dd(i,b);y=new Au.Parser(w.data,w.offset);r.tables.fpgm=y.parseByteList(b.length);break;case"head":w=Dd(i,b);r.tables.head=Gh.parse(w.data,w.offset);r.unitsPerEm=r.tables.head.unitsPerEm;t=r.tables.head.indexToLocFormat;break;case"hhea":w=Dd(i,b);r.tables.hhea=qh.parse(w.data,w.offset);r.ascender=r.tables.hhea.ascender;r.descender=r.tables.hhea.descender;r.numberOfHMetrics=r.tables.hhea.numberOfHMetrics;break;case"hmtx":d=b;break;case"ltag":w=Dd(i,b);n=Jh.parse(w.data,w.offset);break;case"maxp":w=Dd(i,b);r.tables.maxp=tc.parse(w.data,w.offset);r.numGlyphs=r.tables.maxp.numGlyphs;break;case"name":_=b;break;case"OS/2":w=Dd(i,b);r.tables.os2=wc.parse(w.data,w.offset);break;case"post":w=Dd(i,b);r.tables.post=Sc.parse(w.data,w.offset);r.glyphNames=new Vu(r.tables.post);break;case"prep":w=Dd(i,b);y=new Au.Parser(w.data,w.offset);r.tables.prep=y.parseByteList(b.length);break;case"glyf":c=b;break;case"loca":m=b;break;case"CFF ":u=b;break;case"kern":v=b;break;case"GPOS":f=b;break;case"GSUB":p=b;break;case"meta":g=b;break}}var E=Dd(i,_);r.tables.name=_c.parse(E.data,E.offset,n);r.names=r.tables.name;if(c&&m){var T=t===0;var S=Dd(i,m);var A=Ud.parse(S.data,S.offset,r.numGlyphs,T);var M=Dd(i,c);r.glyphs=Ju.parse(M.data,M.offset,A,r)}else if(u){var R=Dd(i,u);kh.parse(R.data,R.offset,r)}else{throw new Error("Font doesn't contain TrueType or CFF outlines.")}var L=Dd(i,d);Kh.parse(L.data,L.offset,r.numberOfHMetrics,r.numGlyphs,r.glyphs);Wu(r);if(v){var C=Dd(i,v);r.kerningPairs=Od.parse(C.data,C.offset)}else{r.kerningPairs={}}if(f){var O=Dd(i,f);Md.parse(O.data,O.offset,r)}if(p){var I=Dd(i,p);r.tables.gsub=Oc.parse(I.data,I.offset)}if(h){var U=Dd(i,h);r.tables.fvar=xd.parse(U.data,U.offset,r.names)}if(g){var P=Dd(i,g);r.tables.meta=Pc.parse(P.data,P.offset);r.metas=r.tables.meta}return r}function zd(e,t,n){n=n||{};this.w=e||64;this.h=t||64;this.autoResize=!!n.autoResize;this.shelves=[];this.freebins=[];this.stats={};this.bins={};this.maxId=0}zd.prototype.pack=function(e,t){var n=this;e=[].concat(e);t=t||{};var r=[],i,a,o,s;for(var l=0;l<e.length;l++){i=e[l].w||e[l].width;a=e[l].h||e[l].height;o=e[l].id;if(i&&a){s=n.packOne(i,a,o);if(!s){continue}if(t.inPlace){e[l].x=s.x;e[l].y=s.y;e[l].id=s.id}r.push(s)}}this.shrink();return r};zd.prototype.packOne=function(e,t,n){var r=this;var i={freebin:-1,shelf:-1,waste:Infinity},a=0,o,s,l,u;if(typeof n==="string"||typeof n==="number"){o=this.getBin(n);if(o){this.ref(o);return o}if(typeof n==="number"){this.maxId=Math.max(n,this.maxId)}}else{n=++this.maxId}for(u=0;u<this.freebins.length;u++){o=r.freebins[u];if(t===o.maxh&&e===o.maxw){return r.allocFreebin(u,e,t,n)}if(t>o.maxh||e>o.maxw){continue}if(t<=o.maxh&&e<=o.maxw){l=o.maxw*o.maxh-e*t;if(l<i.waste){i.waste=l;i.freebin=u}}}for(u=0;u<this.shelves.length;u++){s=r.shelves[u];a+=s.h;if(e>s.free){continue}if(t===s.h){return r.allocShelf(u,e,t,n)}if(t>s.h){continue}if(t<s.h){l=(s.h-t)*e;if(l<i.waste){i.freebin=-1;i.waste=l;i.shelf=u}}}if(i.freebin!==-1){return this.allocFreebin(i.freebin,e,t,n)}if(i.shelf!==-1){return this.allocShelf(i.shelf,e,t,n)}if(t<=this.h-a&&e<=this.w){s=new Nd(a,this.w,t);return this.allocShelf(this.shelves.push(s)-1,e,t,n)}if(this.autoResize){var h,c,f,p;h=c=this.h;f=p=this.w;if(f<=h||e>f){p=Math.max(e,f)*2}if(h<f||t>h){c=Math.max(t,h)*2}this.resize(p,c);return this.packOne(e,t,n)}return null};zd.prototype.allocFreebin=function(e,t,n,r){var i=this.freebins.splice(e,1)[0];i.id=r;i.w=t;i.h=n;i.refcount=0;this.bins[r]=i;this.ref(i);return i};zd.prototype.allocShelf=function(e,t,n,r){var i=this.shelves[e];var a=i.alloc(t,n,r);this.bins[r]=a;this.ref(a);return a};zd.prototype.shrink=function(){var e=this;if(this.shelves.length>0){var t=0;var n=0;for(var r=0;r<this.shelves.length;r++){var i=e.shelves[r];n+=i.h;t=Math.max(i.w-i.free,t)}this.resize(t,n)}};zd.prototype.getBin=function(e){return this.bins[e]};zd.prototype.ref=function(e){if(++e.refcount===1){var t=e.h;this.stats[t]=(this.stats[t]|0)+1}return e.refcount};zd.prototype.unref=function(e){if(e.refcount===0){return 0}if(--e.refcount===0){this.stats[e.h]--;delete this.bins[e.id];this.freebins.push(e)}return e.refcount};zd.prototype.clear=function(){this.shelves=[];this.freebins=[];this.stats={};this.bins={};this.maxId=0};zd.prototype.resize=function(e,t){var n=this;this.w=e;this.h=t;for(var r=0;r<this.shelves.length;r++){n.shelves[r].resize(e)}return true};function Nd(e,t,n){this.x=0;this.y=e;this.w=this.free=t;this.h=n}Nd.prototype.alloc=function(e,t,n){if(e>this.free||t>this.h){return null}var r=this.x;this.x+=e;this.free-=e;return new kd(n,r,this.y,e,t,e,this.h)};Nd.prototype.resize=function(e){this.free+=e-this.w;this.w=e;return true};function kd(e,t,n,r,i,a,o){this.id=e;this.x=t;this.y=n;this.w=r;this.h=i;this.maxw=a||r;this.maxh=o||i;this.refcount=0}var Vd=function(r){function e(e,t,n){if(t===void 0)t=1024;if(n===void 0)n=1024;r.call(this);this._font=null;this._padding=2;this._fontScale=1;this._textCache={};this._packer=new zd(t,n);this._packCanvas=document.createElement("canvas");this._packCanvas.width=t;this._packCanvas.height=n;this._fontAtlas=new ja(e,t,n);this._fontAtlas.mipmap=false;this._fontAtlas.premultiplyAlpha=true;this._defaultGlyph={id:32,x:0,y:0,width:16,height:16,xoffset:0,yoffset:0,xadvance:16,uvs:[Rt.new(0,0),Rt.new(0,0),Rt.new(0,0),Rt.new(0,0)]};this._type="opentype"}if(r)e.__proto__=r;e.prototype=Object.create(r&&r.prototype);e.prototype.constructor=e;var t={font:{configurable:true},texture:{configurable:true},size:{configurable:true},lineHeight:{configurable:true}};t.font.set=function(e){this._font=e;this._fontScale=this._size/this._font.unitsPerEm};t.font.get=function(){return this._font};t.texture.get=function(){return this._fontAtlas};t.size.set=function(e){if(this._size!==e){this._size=e;this.clear()}};t.lineHeight.set=function(e){if(this._lineHeight!==e){this._lineHeight=e;this.clear()}};e.prototype.addText=function e(t){if(this._textCache[t]===undefined){this._textCache[t]=t;this._addTextToFontAtlas(t)}};e.prototype.removeText=function e(t){if(this._textCache[t]===undefined){console.warn("can not remove text: '"+t+"' from font. not exists.")}else{this._removeTextFromFontAtlas(t);delete this._textCache[t]}};e.prototype.clear=function e(){this._packer.clear();var t=this._packCanvas.getContext("2d");t.clearRect(0,0,this._packCanvas.width,this._packCanvas.height);this._fontAtlas.setImages([this._packCanvas]);this._fontAtlas.commit()};e.prototype._addTextToFontAtlas=function e(t){var n=this;var r=this._packCanvas.getContext("2d");var i=false;for(var a=0;a<t.length;++a){var o=t[a];var s=t.charCodeAt(a);var l=n._font.charToGlyph(o);if(l.path.getBoundingBox===undefined){continue}var u=l.getBoundingBox();var h={id:s,x:0,y:0,width:0,height:0,xoffset:0,yoffset:0,xadvance:0};h.width=(u.x2-u.x1)*n._fontScale;h.height=(u.y2-u.y1)*n._fontScale;if(n._glyphs[s]!==undefined){n._packer.packOne(h.width,h.height,h.id)}else{i=true;h.xadvance=l.advanceWidth*n._fontScale;n._glyphs[s]=h;var c=n._packer.packOne(h.width+n._padding,h.height+n._padding,h.id);if(c!==null){h.xoffset=u.x1*n._fontScale;h.yoffset=n._size-u.y2*n._fontScale+n._font.descender*n._fontScale;var f=(c.x+n._padding/2)/n._packCanvas.width;var p=(c.x+n._padding/2+h.width)/n._packCanvas.width;var d=1-(c.y+n._padding/2+h.height)/n._packCanvas.height;var v=1-(c.y+n._padding/2)/n._packCanvas.height;h.uvs=[Rt.new(f,d),Rt.new(p,d),Rt.new(f,v),Rt.new(p,v)];var m=l.getPath(c.x-u.x1*n._fontScale+n._padding/2,c.y+u.y2*n._fontScale+n._padding/2,n._size,{xScale:n._fontScale,yScale:n._fontScale});m.fill="#FFFFFF";m.draw(r)}else{console.error("font glyph pack failed. font atlas size is not enough.")}}}if(i){this._fontAtlas.setImages([this._packCanvas]);this._fontAtlas.commit()}};e.prototype._removeTextFromFontAtlas=function e(t){var n=this;var r=this._packCanvas.getContext("2d");var i=false;for(var a=0;a<t.length;++a){var o=t.charCodeAt(a);if(n._glyphs[o]!==undefined){var s=n._packer.getBin(o);var l=n._packer.unref(s);if(l===0){delete n._glyphs[o];r.clearRect(s.x,s.y,s.w,s.h);i=true}}else{console.warn("try to remove a no exist glyph.")}}if(i){this._fontAtlas.setImages([this._packCanvas]);this._fontAtlas.commit()}};Object.defineProperties(e.prototype,t);return e}(hl);function Wd(o,e,s){var t={};t.bin={type:"binary",src:e.bin};if(e.json){t.json={type:"text",parser:JSON.parse,src:e.json}}Ua({manifest:t,onDone:function e(t){var n=t.bin;var r=t.json;var i=null;if(r&&r.width&&r.height){i=new Vd(o.device,r.width,r.height)}else{i=new Vd(o.device,512,512)}var a=Fd(n);i.font=a;i.size=r.size?r.size:32;i.lineHeight=r.lineHeight?r.lineHeight:32;s(null,i)}})}var Gd={float:Ni.PARAM_FLOAT,float2:Ni.PARAM_FLOAT2,float3:Ni.PARAM_FLOAT3,float4:Ni.PARAM_FLOAT4,color3:Ni.PARAM_COLOR3,color4:Ni.PARAM_COLOR4,texture2d:Ni.PARAM_TEXTURE_2D,textureCube:Ni.PARAM_TEXTURE_CUBE};var Hd={back:Ae.CULL_BACK,front:Ae.CULL_FRONT,add:Ae.BLEND_FUNC_ADD,subtract:Ae.BLEND_FUNC_SUBTRACT,reverseSubtract:Ae.BLEND_FUNC_REVERSE_SUBTRACT,zero:Ae.BLEND_ZERO,one:Ae.BLEND_ONE,srcColor:Ae.BLEND_SRC_COLOR,oneMinusSrcColor:Ae.BLEND_ONE_MINUS_SRC_COLOR,dstColor:Ae.BLEND_DST_COLOR,oneMinusDstColor:Ae.BLEND_ONE_MINUS_DST_COLOR,srcAlpha:Ae.BLEND_SRC_ALPHA,oneMinusSrcAlpha:Ae.BLEND_ONE_MINUS_SRC_ALPHA,dstAlpha:Ae.BLEND_DST_ALPHA,oneMinusDstAlpha:Ae.BLEND_ONE_MINUS_DST_ALPHA,constColor:Ae.BLEND_CONSTANT_COLOR,oneMinusConstColor:Ae.BLEND_ONE_MINUS_CONSTANT_COLOR,constAlpha:Ae.BLEND_CONSTANT_ALPHA,oneMinusConstAlpha:Ae.BLEND_ONE_MINUS_CONSTANT_ALPHA,srcAlphaSaturate:Ae.BLEND_SRC_ALPHA_SATURATE};Hd[true]=true;Hd[false]=false;function jd(e){var t=new ws;t._name=e.name;t._uuid="custom-effect-"+e.name;t._loaded=true;for(var n=0;n<e.techniques.length;++n){var r=e.techniques[n];for(var i=0;i<r.params.length;++i){var a=r.params[i];a.type=Gd[a.type]}for(var o=0;o<r.passes.length;++o){var s=r.passes[o];for(var l in s){if(l==="program"){continue}s[l]=Hd[s[l]]}}}t.techniques=e.techniques;t.properties=e.properties;t.defines=e.defines;t.dependencies=e.dependencies?e.dependencies:[];return t}function qd(e,t,i){Ua({manifest:{json:{type:"text",parser:JSON.parse,src:t.json}},onDone:function e(t){var n=t.json;var r=jd(n);i(null,r)}})}function Xd(e){return e.replace(/\/\/.*/g,"")}function Yd(e,r){var t=/#include +<([\w\d\-_.]+)>/gm;function n(e,t){var n=r[t];if(n===undefined){console.error("can not resolve #include <"+t+">")}return Yd(n)}return e.replace(t,n)}function Kd(e,t,n,r){t=Yd(Xd(t),r);n=Yd(Xd(n),r);var i=[];for(var a in e){var o={name:a};if(e[a]&&e[a].min!==undefined){o.min=e[a].min}if(e[a]&&e[a].max!==undefined){o.max=e[a].max}i.push(o)}return{vert:t,frag:n,defines:i}}function Zd(o,s){Ua({manifest:{json:{type:"text",parser:JSON.parse,src:s.json},vert:{type:"text",src:s.vert},frag:{type:"text",src:s.frag}},onDone:function e(t){var n=t.json;var r=t.vert;var i=t.frag;var a=Kd(n,r,i,o._forward._programLib._chunks);o._forward._programLib.define(s.name,a.vert,a.frag,a.defines)}})}var Qd=function(e){function t(){e.call(this);this._startedFlag=0}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.onInit=function e(){this._system.add(this)};t.prototype.onDestroy=function e(){this._system.remove(this)};t.prototype.awake=function e(){};t.prototype.start=function e(){};t.prototype.tick=function e(){};t.prototype.postTick=function e(){};t.prototype.end=function e(){};return t}(ta);var Jd=function(e){function t(){e.call(this);this._camera=new Ni.Camera}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.onInit=function e(){this._camera.setStages(["opaque","transparent"]);this._camera.setNode(this._entity);this.projection=this._projection;this.priority=this._priority;this.fov=this._fov;this.orthoHeight=this._orthoHeight;this.near=this._near;this.far=this._far;this.color=this._color;this.depth=this._depth;this.stencil=this._stencil;this.clearFlags=this._clearFlags;this.rect=this._rect};t.prototype.onEnable=function e(){this._app.scene.addCamera(this._camera)};t.prototype.onDisable=function e(){this._app.scene.removeCamera(this._camera)};return t}(ta);Jd.schema={projection:{type:"enums",default:"perspective",options:["ortho","perspective"],set:function e(t){this._projection=t;var n=Ni.PROJ_PERSPECTIVE;if(this._projection==="ortho"){n=Ni.PROJ_ORTHO}this._camera.setType(n)}},priority:{type:"number",default:0,set:function e(t){this._priority=t;this._camera.setPriority(t)}},fov:{type:"number",default:45,set:function e(t){this._fov=t;this._camera.setFov(Xe(t))}},orthoHeight:{type:"number",default:10,set:function e(t){this._orthoHeight=t;this._camera.setOrthoHeight(t)}},near:{type:"number",default:.01,set:function e(t){this._near=t;this._camera.setNear(t)}},far:{type:"number",default:1e3,set:function e(t){this._far=t;this._camera.setFar(t)}},color:{type:"color4",default:[.2,.3,.47,1],set:function e(t){this._color=t;this._camera.setColor(t.r,t.g,t.b,t.a)}},depth:{type:"number",default:1,set:function e(t){this._depth=t;this._camera.setDepth(t)}},stencil:{type:"number",default:0,set:function e(t){this._stencil=t;this._camera.setStencil(t)}},clearFlags:{type:"number",default:3,set:function e(t){this._clearFlags=t;this._camera.setClearFlags(t)}},rect:{type:"rect",default:[0,0,1,1],set:function e(t){this._rect=t;this._camera.setRect(t[0],t[1],t[2],t[3])}}};var $d=function(e){function t(){e.call(this);this._light=new Ni.Light}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.onInit=function e(){this._light.setNode(this._entity);this.type=this._type;this.color=this._color;this.intensity=this._intensity;this.range=this._range;this.spotAngle=this._spotAngle;this.spotExp=this._spotExp;this.shadowType=this._shadowType;this.shadowResolution=this._shadowResolution;this.shadowDarkness=this._shadowDarkness;this.shadowMinDepth=this._shadowMinDepth;this.shadowMaxDepth=this._shadowMaxDepth;this.shadowDepthScale=this._shadowDepthScale;this.shadowFrustumSize=this._shadowFrustumSize;this.shadowBias=this._shadowBias};t.prototype.onEnable=function e(){this._app.scene.addLight(this._light)};t.prototype.onDisable=function e(){this._app.scene.removeLight(this._light)};return t}(ta);$d.schema={type:{type:"enums",default:"directional",options:["directional","point","spot"],set:function e(t){this._type=t;var n=Ni.LIGHT_DIRECTIONAL;if(this._type==="point"){n=Ni.LIGHT_POINT}else if(this._type==="spot"){n=Ni.LIGHT_SPOT}this._light.setType(n)}},color:{type:"color3",default:[1,1,1],set:function e(t){this._color=t;this._light.setColor(t.r,t.g,t.b)}},intensity:{type:"number",default:1,set:function e(t){this._intensity=t;this._light.setIntensity(t)}},range:{type:"number",default:1,set:function e(t){this._range=t;this._light.setRange(t)}},spotAngle:{type:"number",default:60,set:function e(t){this._spotAngle=t;this._light.setSpotAngle(Xe(t))}},spotExp:{type:"number",default:1,set:function e(t){this._spotExp=t;this._light.setSpotExp(t)}},shadowType:{type:"enums",default:"none",options:["none","hard","soft"],set:function e(t){this._shadowType=t;var n=Ni.SHADOW_NONE;if(t==="hard"){n=Ni.SHADOW_HARD}else if(t==="soft"){n=Ni.SHADOW_SOFT}this._light.setShadowType(n)}},shadowResolution:{type:"number",default:1024,set:function e(t){this._shadowResolution=t;this._light.setShadowResolution(t)}},shadowDarkness:{type:"number",default:.5,set:function e(t){this._shadowDarkness=t;this._light.setShadowDarkness(t)}},shadowMinDepth:{type:"number",default:1,set:function e(t){this._shadowMinDepth=t;this._light.setShadowMinDepth(t)}},shadowMaxDepth:{type:"number",default:1e3,set:function e(t){this._shadowMaxDepth=t;this._light.setShadowMaxDepth(t)}},shadowDepthScale:{type:"number",default:250,set:function e(t){this._shadowDepthScale=t;this._light.setShadowDepthScale(t)}},shadowFrustumSize:{type:"number",default:50,set:function e(t){this._shadowFrustumSize=t;this._light.setShadowFrustumSize(t)}},shadowBias:{type:"number",default:5e-4,set:function e(t){this._shadowBias=t;this._light.setShadowBias(t)}}};var ev=function(e){function t(){e.apply(this,arguments)}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;var n={material:{configurable:true}};t.prototype.onInit=function e(){this._models=[];this.materials=this._materials;this.mesh=this._mesh;this.shadowCastingMode=this._shadowCastingMode;this.receiveShadows=this._receiveShadows};t.prototype.onEnable=function e(){var t=this;for(var n=0;n<this._models.length;++n){t._app.scene.addModel(t._models[n])}};t.prototype.onDisable=function e(){var t=this;for(var n=0;n<this._models.length;++n){t._app.scene.removeModel(t._models[n])}};t.prototype.getMaterial=function e(t){if(this._materials.length===0){return null}if(t<this._materials.length){return this._materials[t]}return this._materials[this._materials.length-1]};n.material.get=function(){return this.getMaterial(0)};n.material.set=function(e){if(this._materials.length===1&&this._materials[0]===e){return}this._materials[0]=e;if(this._models.length>0){this._models[0].setEffect(e.effectInst)}};t.prototype._updateModels=function e(){var t=this;var n=this._mesh?this._mesh.subMeshCount:0;var r=this._models;this._models=new Array(n);for(var i=0;i<n;++i){var a=new Ni.Model;a.createBoundingBox(t._mesh._minPos,t._mesh._maxPos);t._models[i]=a}this._updateModelParams();if(this.enabled){for(var o=0;o<r.length;++o){t._app.scene.removeModel(r[o])}for(var s=0;s<this._models.length;++s){t._app.scene.addModel(t._models[s])}}};t.prototype._updateModelParams=function e(){var t=this;for(var n=0;n<this._models.length;++n){var r=t._models[n];var i=t.getMaterial(n);var a=t._mesh.getSubMesh(n);r.setInputAssembler(a);r.setEffect(i?i.effectInst:null);r.setNode(t._entity)}};t.prototype._updateCastShadow=function e(){var t=this;if(this._shadowCastingMode==="off"){for(var n=0;n<this._models.length;++n){var r=t._models[n];r._castShadow=false}}else if(this._shadowCastingMode==="on"){for(var i=0;i<this._models.length;++i){var a=t._models[i];a._castShadow=true}}else{console.warn("ShadowCastingMode "+this._shadowCastingMode+" is not supported.")}};t.prototype._updateReceiveShadow=function e(){var t=this;for(var n=0;n<this._models.length;++n){var r=t._models[n];if(r._defines["USE_SHADOW_MAP"]!=undefined){r._effect.define("USE_SHADOW_MAP",t._receiveShadows)}}};Object.defineProperties(t.prototype,n);return t}(ta);ev.schema={materials:{type:"asset",default:[],array:true,set:function e(t){this._materials=t;this._updateModelParams()}},mesh:{type:"asset",default:null,set:function e(t){this._mesh=t;this._updateModels()}},shadowCastingMode:{type:"enums",default:"off",options:["off","on","twoSided","shadowsOnly"],set:function e(t){this._shadowCastingMode=t;this._updateCastShadow()}},receiveShadows:{type:"boolean",default:false,set:function e(t){this._receiveShadows=t;this._updateReceiveShadow()}}};var tv=Bt.create();var nv=function(r){function e(){r.apply(this,arguments)}if(r)e.__proto__=r;e.prototype=Object.create(r&&r.prototype);e.prototype.constructor=e;e.prototype.onInit=function e(){this._models=[];this._jointsTexture=null;this._jointsMatricesArray=null;this._refSkeleton=null;this._updateModels();this._updateCastShadow();this._updateReceiveShadow();var t=this._entity.parent;var n=t.getComp("Animation");if(n){this._refSkeleton=n.skeleton}else{console.warn("Can not find Animation component in root entity.")}this._system.add(this)};e.prototype.onDestroy=function e(){this._system.remove(this)};e.prototype._updateMatrices=function e(){var t=this;if(!this._mesh||!this._mesh.skinning){return}var n=this._mesh.skinning.jointIndices;var r=this._mesh.skinning.bindposes;for(var i=0;i<n.length;++i){var a=r[i];var o=n[i];var s=t._refSkeleton.getWorldMatrix(o);Bt.multiply(tv,s,a);t._setJointMatrix(i,tv)}this._commitJointsData()};e.prototype._updateModels=function e(){var t=this;if(this._mesh.skinning){this._reInitJointsData()}var n=this._mesh?this._mesh.subMeshCount:0;var r=this._models;this._models=new Array(n);for(var i=0;i<n;++i){var a=new Ni.SkinningModel;a.createBoundingBox(t._mesh._minPos,t._mesh._maxPos);t._models[i]=a}this._updateModelParams();if(this.enabled){this._entity.emit("skinning-model-changed",this,"mesh",r)}};e.prototype._updateModelParams=function e(){var t=this;r.prototype._updateModelParams.call(this);for(var n=0;n<this._models.length;++n){t._updateModelJointParam(t._models[n])}};e.prototype._reInitJointsData=function e(){if(this._jointsTexture){this._jointsTexture.unload();this._jointsTexture=null}else{this._jointsMatricesArray=null}if(this._app.device.allowFloatTexture()){this._jointsTexture=io.createJointsTexture(this._app,this._mesh.skinning)}else{this._jointsMatricesArray=new Float32Array(this._mesh.skinning.jointIndices.length*16)}};e.prototype._commitJointsData=function e(){var t=this._jointsTexture;if(t!=null){t.commit()}};e.prototype._updateModelJointParam=function e(t){var n=this._jointsTexture;if(n!=null){t.setJointsTexture(n._texture)}else{t.setJointsMatrixArray(this._jointsMatricesArray)}};e.prototype._setJointMatrix=function e(t,n){var r=null;var i=this._jointsTexture;if(i!=null){r=i.data}else{r=this._jointsMatricesArray}r[16*t+0]=n.m00;r[16*t+1]=n.m01;r[16*t+2]=n.m02;r[16*t+3]=n.m03;r[16*t+4]=n.m04;r[16*t+5]=n.m05;r[16*t+6]=n.m06;r[16*t+7]=n.m07;r[16*t+8]=n.m08;r[16*t+9]=n.m09;r[16*t+10]=n.m10;r[16*t+11]=n.m11;r[16*t+12]=n.m12;r[16*t+13]=n.m13;r[16*t+14]=n.m14;r[16*t+15]=n.m15};return e}(ev);var rv=function e(t){this.clip=t;this.blendMode="blend";this.wrapMode="loop";this.speed=1;this.time=0;this.weight=1};var iv=function e(){this._current=null;this._next=null;this._blendTime=0;this._blendDuration=.3;this._skeleton=null;this._skelFrom=null;this._skelTo=null};iv.prototype.setSkeleton=function e(t){this._skeleton=t;this._skelFrom=t.clone();this._skelTo=t.clone()};iv.prototype.crossFade=function e(t,n){if(this._current&&n>0){this._next=t;this._blendTime=0;this._blendDuration=n}else{this._current=t;this._next=null}};iv.prototype.tick=function e(t){if(this._current&&this._next){var n=this._getTime(this._current);var r=this._getTime(this._next);var i=this._blendTime/this._blendDuration;this._current.time+=t;this._next.time+=t;this._blendTime+=t;if(i>1){this._current=this._next;this._next=null;this._current.clip.sample(this._skeleton,r)}else{this._current.clip.sample(this._skelFrom,n);this._next.clip.sample(this._skelTo,r);this._skeleton.blend(this._skelFrom,this._skelTo,i);this._skeleton.updateMatrices()}return}if(this._current){var a=this._getTime(this._current);this._current.clip.sample(this._skeleton,a);this._current.time+=t}};iv.prototype._getTime=function e(t){var n=t.time;var r=t.clip.length;if(t.wrapMode==="once"){if(n>r){n=0}}else if(t.wrapMode==="loop"){n%=r}else if(t.wrapMode==="ping-pong"){var i=Math.floor(n/r);if(i%2===1){n=r-n%r}}return n};var av=function(e){function t(){e.apply(this,arguments)}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;var n={skeleton:{configurable:true}};t.prototype.onInit=function e(){this._name2states={};this._animCtrl=new iv;this.clips=this._clips;this.joints=this._joints;this._system.add(this)};t.prototype.onDestroy=function e(){this._system.remove(this)};n.skeleton.get=function(){return this._skeleton};t.prototype.addClip=function e(t,n){if(this._name2states[t]){console.warn("Failed to add clip "+t+", the name already exsits.");return}this._clips.push(n);this._name2states[t]=new rv(n)};t.prototype.getState=function e(t){return this._name2states[t]};t.prototype.play=function e(t,n){if(n===void 0)n=.3;if(!this._name2states[t]){console.warn("Failed to play animation "+t+", not found.");return}var r=this._name2states[t];r.time=0;this._animCtrl.crossFade(r,n)};t.prototype._updateSkeleton=function e(){this.joints=this._joints};Object.defineProperties(t.prototype,n);return t}(ta);av.schema={clips:{type:"asset",default:[],array:true,set:function e(t){var n=this;this._clips=t;for(var r=0;r<this._clips.length;++r){var i=n._clips[r];if(n._name2states[i.name]){console.warn("Failed to add clip "+i.name+", the name already exsits.");continue}n._name2states[i.name]=new rv(i)}}},joints:{type:"asset",default:null,set:function e(t){this._joints=t;if(this._joints){this._skeleton=this._joints.instantiate();this._animCtrl.setSkeleton(this._skeleton)}else{this._skeleton=null}}}};var ov=false;var sv=false;var lv=false;var uv=[];var hv={};hv.State={ERROR:-1,INITIALZING:0,PLAYING:1,PAUSED:2};var cv=function(e){function t(){e.call(this);this._element=null;this._nextTime=0;this._state=hv.State.INITIALZING}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;var n={currentTime:{configurable:true},duration:{configurable:true},state:{configurable:true},paused:{configurable:true}};t.prototype.onInit=function e(){this._system.add(this);this.clip=this._clip;this.loop=this._loop;this.volume=this._volume;this.playOnAwake=this._playOnAwake};t.prototype.onDestroy=function e(){this._system.remove(this)};t.prototype.play=function e(){this._state=hv.State.PLAYING;if(!this._element){return}this._bindEnded();this._element.play();if(!(sv||ov)&&this._clip&&this._clip.loadMode===il.DOM_AUDIO&&this._element.paused){uv.push({instance:this,offset:0,audio:this._element})}if(lv){return}lv=true;window.addEventListener("touchstart",function(){var e=uv.pop();while(e){e.audio.play(e.offset);e=uv.pop()}})};t.prototype.pause=function e(){if(!this._element){return}this._unbindEnded();this._element.pause();this._state=hv.State.PAUSED};t.prototype.resume=function e(){if(!this._element||this._state===hv.State.PLAYING){return}this._bindEnded();this._element.play();this._state=hv.State.PLAYING};t.prototype.stop=function e(){var t=this;if(!this._element){return}try{this._element.currentTime=0}catch(e){console.log(e)}this._element.pause();for(var n=0;n<uv.length;n++){if(uv[n].instance===t){uv.splice(n,1);break}}this._unbindEnded();this._state=hv.State.PAUSED};n.currentTime.set=function(t){if(this._element){this._nextTime=0}else{this._nextTime=t;return}this._unbindEnded();if(!(sv||ov)){this._bindEnded(function(){this._bindEnded()}.bind(this))}try{this._element.currentTime=t}catch(e){var n=this._element;if(n.addEventListener){var r=function(){n.removeEventListener("loadedmetadata",r);n.currentTime=t};n.addEventListener("loadedmetadata",r)}}};n.currentTime.get=function(){return this._element?this._element.currentTime:0};n.duration.get=function(){return this._element?this._element.duration:0};n.state.get=function(){if(!ov){var e=this._element;if(e&&hv.State.PLAYING===this._state&&e.paused){this._state=hv.State.PAUSED}}return this._state};n.paused.get=function(){return this._element?this._element.paused:true};t.prototype._bindEnded=function e(t){t=t||this._onended;if(this._clip&&this._clip.loadMode===il.DOM_AUDIO){this._element.addEventListener("ended",t)}else{this._element.onended=t}};t.prototype._unbindEnded=function e(){if(this._clip&&this._clip.loadMode===il.DOM_AUDIO){this._element.removeEventListener("ended",this._onended)}else{this._element.onended=null}};t.prototype._onLoaded=function e(){var t=this._clip.nativeAsset;if(this._clip.loadMode===il.DOM_AUDIO||sv||ov){this._element=t}else{this._element=new fv(t,this)}this.volume=this._volume;this.loop=this._loop;if(this._nextTime!==0){this.setCurrentTime(this._nextTime)}if(this._state===hv.State.PLAYING||this._playOnAwake){this.play()}else{this._state=hv.State.INITIALZING}};Object.defineProperties(t.prototype,n);return t}(ta);cv.schema={clip:{type:"asset",default:null,set:function e(t){if(t){this._clip=t;if(t._loaded){this._onLoaded()}else{t.once("load",function(){if(t===this._clip){this._onLoaded()}}.bind(this))}}else{this._clip=null;this._element=null;this._state=hv.State.INITIALZING}return t}},loop:{type:"boolean",default:false,set:function e(t){this._loop=t;if(this._element){this._element.loop=t}}},playOnAwake:{type:"boolean",default:true,set:function e(t){this._playOnAwake=t;if(t){this._state=hv.State.PLAYING}}},volume:{type:"number",default:1,set:function e(t){this._volume=t;if(this._element){this._element.volume=t}}}};var fv=function(e,t){this._audio=t;this._context=this._audio._system.__audioSupport.context;this._buffer=e;this._gainObj=this._context["createGain"]();this._volume=1;if(this._gainObj["gain"].setTargetAtTime){this._gainObj["gain"].setTargetAtTime(this._volume,this._context.currentTime,.01)}else{this._gainObj["gain"].value=this._volume}this._gainObj["connect"](this._context["destination"]);this._loop=false;this._startTime=-1;this._currentSource=null;this.playedLength=0;this._currextTimer=null;this._endCallback=function(){if(this.onended){this.onended(this)}}.bind(this)};(function(e){e.play=function(e){if(this._currentSource&&!this.paused){this._currentSource.onended=null;this._currentSource.stop(0);this.playedLength=0}var t=this._context["createBufferSource"]();t.buffer=this._buffer;t["connect"](this._gainObj);t.loop=this._loop;this._startTime=this._context.currentTime;e=e||this.playedLength;if(e){this._startTime-=e}var n=this._buffer.duration;var r=e;var i;if(this._loop){if(t.start){t.start(0,r)}else if(t["notoGrainOn"]){t["noteGrainOn"](0,r)}else{t["noteOn"](0,r)}}else{i=n-e;if(t.start){t.start(0,r,i)}else if(t["notoGrainOn"]){t["noteGrainOn"](0,r,i)}else{t["noteOn"](0,r,i)}}this._currentSource=t;t.onended=this._endCallback;if((!t.context.state||t.context.state==="suspended")&&this._context.currentTime===0){var a=this;clearTimeout(this._currextTimer);this._currextTimer=setTimeout(function(){if(!(sv||ov)&&a._context.currentTime===0){uv.push({instance:a._audio,offset:e,audio:a})}},10)}};e.pause=function(){clearTimeout(this._currextTimer);if(this.paused){return}this.playedLength=this._context.currentTime-this._startTime;this.playedLength%=this._buffer.duration;var e=this._currentSource;this._currentSource=null;this._startTime=-1;if(e){e.stop(0)}};e.__defineGetter__("paused",function(){if(this._currentSource&&this._currentSource.loop){return false}if(this._startTime===-1){return true}return this._context.currentTime-this._startTime>this._buffer.duration});e.__defineGetter__("loop",function(){return this._loop});e.__defineSetter__("loop",function(e){if(this._currentSource){this._currentSource.loop=e}return this._loop=e});e.__defineGetter__("volume",function(){return this._volume});e.__defineSetter__("volume",function(e){this._volume=e;if(this._gainObj["gain"].setTargetAtTime){this._gainObj["gain"].setTargetAtTime(this._volume,this._context.currentTime,.01)}else{this._volume["gain"].value=e}if(this._audio._system.os===this._audio._system.OS_IOS&&!this.paused&&this._currentSource){this._currentSource.onended=null;this.pause();this.play()}return e});e.__defineGetter__("currentTime",function(){if(this.paused){return this.playedLength}this.playedLength=this._context.currentTime-this._startTime;this.playedLength%=this._buffer.duration;return this.playedLength});e.__defineSetter__("currentTime",function(e){if(!this.paused){this.pause();this.playedLength=e;this.play()}else{this.playedLength=e}return e});e.__defineGetter__("duration",function(){return this._buffer.duration})})(fv.prototype);var pv=function(e){function t(){e.call(this)}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.onInit=function e(){this._system.add(this);this.type=this._type;this.isTrigger=this._isTrigger;this.center=this._center;this.size=this._size;this.radius=this._radius;this.mass=this._mass;this.drag=this._drag;this.angularDrag=this._angularDrag;this.isKinematic=this._isKinematic;this.freezeRotation=this._freezeRotation};t.prototype.onDestroy=function e(){this._system.remove(this)};return t}(ta);pv.schema={type:{type:"string",default:"box"},isTrigger:{type:"boolean",default:false,set:function e(t){this._isTrigger=t;this.body.setIsTrigger(t)}},center:{type:"vec3",default:[0,0,0],set:function e(t){this._center=t;this.body.setCenter(t)}},size:{type:"vec3",default:[2,2,2],set:function e(t){this._size=t;this.body.setSize(t)}},radius:{type:"number",default:1,set:function e(t){this._radius=t;this.body.setRadius(t)}},mass:{type:"number",default:0,set:function e(t){this._mass=t;this.body.setMass(t)}},drag:{type:"number",default:0,set:function e(t){this._drag=t;this.body.setDrag(t)}},angularDrag:{type:"number",default:.05,set:function e(t){this._drag=t;this.body.setAngularDrag(t)}},isKinematic:{type:"boolean",default:false,set:function e(t){this._isKinematic=t;this.body.setIsKinematic(t)}},freezeRotation:{type:"boolean",default:false,set:function e(t){this._freezeRotation=t;this.body.setFreezeRotation(t)}}};var dv=function(e){function t(){e.call(this);this._model=new Ni.Model;this._attachedCamera=null;this.material=this._material;this.cubeMap=this._cubeMap}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.onInit=function e(){this._model.setNode(this._entity);var t=Ni.createIA(this._app.device,Do(2,2,2,{widthSegments:1,heightSegments:1,lengthSegments:1}));this._model.setInputAssembler(t);if(this._material===null){this._material=new gs;this._material.effect=this._app.assets.get("builtin-effect-skybox")}this._updateMaterialParams();this._model.setEffect(this._material.effectInst)};t.prototype.onEnable=function e(){if(this._entity!=null){var t=this._entity.getComp("Camera");if(t!=null&&t._clearFlags&Ni.CLEAR_SKYBOX){this._attachedCamera=t._camera;this._attachedCamera._clearModel=this._model}}};t.prototype.onDisable=function e(){if(this._attachedCamera!=null){this._attachedCamera._clearModel=null;this._attachedCamera=null}};t.prototype._updateMaterialParams=function e(){if(this._material===null||this._material===undefined){return}if(this._cubeMap!==null&&this._cubeMap!==undefined){this._material.setProperty("cubeMap",this._cubeMap)}};return t}(ta);dv.schema={material:{type:"asset",default:null,set:function e(t){this._material=t;if(!this._material){return}this._updateMaterialParams();this._model.setEffect(t.effectInst)}},cubeMap:{type:"asset",default:null,set:function e(t){this._cubeMap=t;this._updateMaterialParams()}}};var vv=function e(t){this.particleSystem=t;this.position=Lt.new(0,0,0);this.velocity=Lt.new(0,0,0);this.animatedVelocity=Lt.new(0,0,0);this.ultimateVelocity=Lt.new(0,0,0);this.angularVelocity=Lt.new(0,0,0);this.axisOfRotation=Lt.new(0,0,0);this.rotation=Lt.new(0,0,0);this.startSize=Lt.new(0,0,0);this.size=Lt.zero();this.startColor=Ft.new(1,1,1,1);this.color=Ft.create();this.randomSeed=0;this.remainingLifetime=0;this.startLifetime=0;this.emitAccumulator0=0;this.emitAccumulator1=0;this.frameIndex=0};var mv=function e(){};mv.schema={color:{type:"color3",default:[1,1,1]},time:{type:"number",default:0}};var _v=function e(){};_v.schema={alpha:{type:"number",default:1},time:{type:"number",default:0}};var gv=function e(){this._rgb=Dt.new(1,1,1);this._rgba=Ft.new(1,1,1,1)};gv.prototype.setKeys=function e(t,n){this._colorKeys=t;this._alphaKeys=n};gv.prototype.sortKeys=function e(){if(this._colorKeys.length>1){this._colorKeys.sort(function(e,t){return e.time-t.time})}if(this._alphaKeys.length>1){this._alphaKeys.sort(function(e,t){return e.time-t.time})}};gv.prototype.getRGB=function e(t){var n=this;if(this._colorKeys.length>1){t=nt(t,1);for(var r=1;r<this._colorKeys.length;++r){var i=n._colorKeys[r-1].time;var a=n._colorKeys[r].time;if(t>=i&&t<a){if(n._mode==="fixed"){return n._colorKeys[r].color}var o=(t-i)/(a-i);Dt.lerp(n._rgb,n._colorKeys[r-1].color,n._colorKeys[r].color,o);return n._rgb}}console.warn("something went wrong. can not get gradient color.")}else if(this._colorKeys.length===1){return this._colorKeys[0].color}else{return Dt.set(this._rgb,1,1,1)}};gv.prototype.getAlpha=function e(t){var n=this;if(this._alphaKeys.length>1){t=nt(t,1);for(var r=1;r<this._alphaKeys.length;++r){var i=n._alphaKeys[r-1].time;var a=n._alphaKeys[r].time;if(t>=i&&t<a){if(n._mode==="fixed"){return n._alphaKeys[r].alpha}var o=(t-i)/(a-i);return n._alphaKeys[r-1].alpha*(1-o)+n._alphaKeys[r].alpha*o}}console.warn("something went wrong. can not get gradient alpha.")}else if(this._alphaKeys.length===1){return this._alphaKeys[0].alpha}else{return 1}};gv.prototype.evaluate=function e(t){var n=this.getRGB(t);Ft.set(this._rgba,n.r,n.g,n.b,this.getAlpha(t));return this._rgba};gv.prototype.randomColor=function e(){var t=this._colorKeys[Math.trunc(Math.random()*this._colorKeys.length)];var n=this._alphaKeys[Math.trunc(Math.random()*this._alphaKeys.length)];Ft.set(this._rgba,t.r,t.g,t.b,n);return this._rgba};gv.schema={colorKeys:{type:"ColorKey",default:[],array:true},alphaKeys:{type:"AlphaKey",default:[],array:true},mode:{type:"enums",default:"blend",options:["blend","fixed"]}};var yv=function e(){};yv.prototype.evaluate=function e(t,n){switch(this._mode){case"constant":return this._constant;case"curve":return this._curve.evaluate(t)*this._multiplier;case"twoCurves":return qe(this._curveMin.evaluate(t),this._curveMax.evaluate(t),n)*this._multiplier;case"twoConstants":return qe(this._constantMin,this._constantMax,n)}};yv.schema={mode:{type:"enums",default:"constant",options:["constant","curve","twoCurves","twoConstants"]},curve:{type:"AnimationCurve",default:null},curveMin:{type:"AnimationCurve",default:null},curveMax:{type:"AnimationCurve",default:null},constant:{type:"number",default:0},constantMin:{type:"number",default:0},constantMax:{type:"number",default:0},multiplier:{type:"number",default:1}};var xv=function e(){};xv.prototype.evaluate=function e(t,n){switch(this._mode){case"color":return this._color;case"twoColors":return Ft.set(this._color,qe(this._colorMin.r,this._colorMax.r,n),qe(this._colorMin.g,this._colorMax.g,n),qe(this._colorMin.b,this._colorMax.b,n),qe(this._colorMin.a,this._colorMax.a,n));case"randomColor":return this._gradient.randomColor();case"gradient":return this._gradient.evaluate(t);case"twoGradients":this._colorMin=this._gradientMin.evaluate(t);this._colorMax=this._gradientMax.evaluate(t);return Ft.set(this._color,qe(this._colorMin.r,this._colorMax.r,n),qe(this._colorMin.g,this._colorMax.g,n),qe(this._colorMin.b,this._colorMax.b,n),qe(this._colorMin.a,this._colorMax.a,n))}};xv.schema={mode:{type:"enums",default:"color",options:["color","gradient","twoColors","twoGradients","randomColor"]},color:{type:"color4",default:[1,1,1,1]},colorMin:{type:"color4",default:[1,1,1,1]},colorMax:{type:"color4",default:[1,1,1,1]},gradient:{type:"Gradient",default:null},gradientMin:{type:"Gradient",default:null},gradientMax:{type:"Gradient",default:null}};var bv=Lt.zero();var wv=Rt.zero();var Ev=Ct.zero();var Tv={position:{name:Ae.ATTR_POSITION,type:Ae.ATTR_TYPE_FLOAT32,num:3},uv:{name:Ae.ATTR_UV,type:Ae.ATTR_TYPE_FLOAT32,num:3},uv0:{name:Ae.ATTR_UV0,type:Ae.ATTR_TYPE_FLOAT32,num:2},color:{name:Ae.ATTR_COLOR,type:Ae.ATTR_TYPE_FLOAT32,num:4},normal:{name:Ae.ATTR_NORMAL,type:Ae.ATTR_TYPE_FLOAT32,num:3},tangent:{name:Ae.ATTR_TANGENT,type:Ae.ATTR_TYPE_FLOAT32,num:3},custom1:{name:Ae.ATTR_UV1,type:Ae.ATTR_TYPE_FLOAT32,num:2},custom2:{name:Ae.ATTR_UV2,type:Ae.ATTR_TYPE_FLOAT32,num:2}};var Sv=[0,0,1,0,0,1,1,1];var Av=function e(){this._model=null;this._vertAttrs=[];this._vertAttrs=[{name:Ae.ATTR_POSITION,type:Ae.ATTR_TYPE_FLOAT32,num:3,index:Ae.ATTR_INDEX_POSITION},{name:Ae.ATTR_UV,type:Ae.ATTR_TYPE_FLOAT32,num:3,index:Ae.ATTR_INDEX_UV},{name:Ae.ATTR_UV0,type:Ae.ATTR_TYPE_FLOAT32,num:2,index:Ae.ATTR_INDEX_UV0},{name:Ae.ATTR_COLOR,type:Ae.ATTR_TYPE_FLOAT32,num:4,index:Ae.ATTR_INDEX_COLOR}];this.frameTile=Rt.new(1,1);this.attrs=new Array(5)};Av.prototype.setVertexAtrributes=function e(t){var n=this;for(var r=0;r<t.length;++r){var i=Tv[t[r]];if(i!==undefined){n._vertAttrs.push(i)}else{console.error("vertex attribute name wrong.")}}this._model.setVertexAttributes(this._vertAttrs)};Av.prototype.onInit=function e(t){this.particleSystem=t;if(this._material===null||this._material===undefined){this._material=new gs;this._material.effect=t._app.assets.get("builtin-effect-particle-premultiply-blend")}this._updateMaterialParams();this._updateModel()};Av.prototype._updateMaterialParams=function e(){if(!this.particleSystem){return}if(this.particleSystem._simulationSpace==="world"){this._material.define("USE_WORLD_SPACE",true)}else{this._material.define("USE_WORLD_SPACE",false)}if(this._renderMode==="billboard"){this._material.define("USE_BILLBOARD",true);this._material.define("USE_STRETCHED_BILLBOARD",false);this._material.define("USE_HORIZONTAL_BILLBOARD",false);this._material.define("USE_VERTICAL_BILLBOARD",false)}else if(this._renderMode==="stretchedBillboard"){this._material.define("USE_BILLBOARD",false);this._material.define("USE_STRETCHED_BILLBOARD",true);this._material.define("USE_HORIZONTAL_BILLBOARD",false);this._material.define("USE_VERTICAL_BILLBOARD",false);this._material.setProperty("velocityScale",this._velocityScale);this._material.setProperty("lengthScale",this._lengthScale)}else if(this._renderMode==="horizontalBillboard"){this._material.define("USE_BILLBOARD",false);this._material.define("USE_STRETCHED_BILLBOARD",false);this._material.define("USE_HORIZONTAL_BILLBOARD",true);this._material.define("USE_VERTICAL_BILLBOARD",false)}else if(this._renderMode==="verticalBillboard"){this._material.define("USE_BILLBOARD",false);this._material.define("USE_STRETCHED_BILLBOARD",false);this._material.define("USE_HORIZONTAL_BILLBOARD",false);this._material.define("USE_VERTICAL_BILLBOARD",true)}else{console.warn("particle system renderMode "+this._renderMode+" not support.")}if(this.particleSystem.textureAnimationModule.enable){this._material.setProperty("frameTile",Rt.set(this.frameTile,this.particleSystem.textureAnimationModule.numTilesX,this.particleSystem.textureAnimationModule.numTilesY))}else{this._material.setProperty("frameTile",this.frameTile)}};Av.prototype._updateModel=function e(){if(!this.particleSystem){return}if(this._model===null){this._model=new Ni.ParticleBatchModel(this.particleSystem._app.device,this.particleSystem._capacity,this._vertAttrs);this._model.setNode(this.particleSystem._entity)}this._model.setEffect(this._material?this._material.effectInst:null);if(this._renderMode==="stretchedBillboard"){this._model.enableStretchedBillboard()}else{this._model.disableStretchedBillboard()}};Av.prototype._updateRenderData=function e(){var t=this;var n=0;var r=this._renderMode=="stretchedBillboard";for(var i=0;i<this.particleSystem._particles.length;++i){var a=t.particleSystem._particles.data[i];var o=0;if(t.particleSystem._textureAnimationModule.enable){o=a.frameIndex}n=i*4;var s=0;for(var l=0;l<4;++l){s=0;t.attrs[s++]=a.position;bv.x=Sv[2*l];bv.y=Sv[2*l+1];bv.z=o;t.attrs[s++]=bv;wv.x=a.size.x;wv.y=a.rotation.x;t.attrs[s++]=wv;Ev.x=a.color.r;Ev.y=a.color.g;Ev.z=a.color.b;Ev.w=a.color.a;t.attrs[s++]=Ev;if(r){t.attrs[s++]=a.ultimateVelocity}t._model.addParticleVertexData(n++,t.attrs)}}this._model.updateIA(this.particleSystem._particles.length*6)};Av.schema={material:{type:"asset",default:null,set:function e(t){if(this._material===t){return}this._material=t;this._updateMaterialParams();this._updateModel()},parse:function e(t,n){if(typeof n==="string"){var r=new gs;r.copy(t.assets.get(n));return r}return n}},renderMode:{type:"enums",default:"billboard",options:["billboard","stretchedBillboard","horizontalBillboard","verticalBillboard","mesh"],set:function e(t){if(this._renderMode===t){return}this._renderMode=t;this._updateMaterialParams();this._updateModel()}},velocityScale:{type:"number",default:1,set:function e(t){this._velocityScale=t;this._updateMaterialParams();this._updateModel()}},lengthScale:{type:"number",default:.4,set:function e(t){this._lengthScale=t;this._updateMaterialParams();this._updateModel()}}};var Mv=function e(){};Mv.prototype.animate=function e(t){if(!this._separateAxes){Lt.scale(t.size,t.startSize,this._size.evaluate(1-t.remainingLifetime/t.startLifetime,t.randomSeed))}};Mv.schema={enable:{type:"boolean",default:false},separateAxes:{type:"boolean",default:false},size:{type:"CurveRange",default:null},x:{type:"CurveRange",default:null},y:{type:"CurveRange",default:null},z:{type:"CurveRange",default:null}};var Rv=function e(){};Rv.prototype.animate=function e(t){if(this._enable){Ft.multiply(t.color,t.startColor,this._color.evaluate(1-t.remainingLifetime/t.startLifetime,t.randomSeed))}};Rv.schema={enable:{type:"boolean",default:false},color:{type:"GradientRange",default:null}};var Lv=Lt.new(0,0,-1);function Cv(e,t,n,r){if(t!==e){if(e==="world"){Bt.getRotation(r,n)}else{Bt.invert(n,n);Bt.getRotation(r,n)}return true}else{It.identity(r);return false}}function Ov(e,t){Rt.set(e,Math.cos(t),Math.sin(t))}function Iv(e){var t=Ze(-1,1);var n=Ze(0,2*Math.PI);var r=Math.sqrt(1-t*t);var i=r*Math.cos(n);var a=r*Math.sin(n);Lt.set(e,i,a,t)}function Uv(e,t,n){Iv(e);Lt.scale(e,e,t+(n-t)*Ke())}function Pv(e,t,n,r){Ov(e,r);Lt.scale(e,e,t+(n-t)*Ke())}function Bv(e,t){Lt.set(e,Ze(-t.x,t.x),Ze(-t.y,t.y),Ze(-t.z,t.z))}function Dv(e){for(var t=0;t<e.length;t++){var n=t+Qe(0,e.length-t);var r=e[n];e[n]=e[t];e[t]=r}}function Fv(){var e=Ze(-1,1);e===0?e++:e;return lt(e)}var zv=function e(){this.rotation=It.create()};zv.prototype.update=function e(t,n){this.needTransform=Cv(t,this._space,n,this.rotation)};zv.prototype.animate=function e(t){var n=1-t.remainingLifetime/t.startLifetime;var r=Lt.new(this._x.evaluate(n,t.randomSeed),this._y.evaluate(n,t.randomSeed),this._z.evaluate(n,t.randomSeed));if(this.needTransform){Lt.transformQuat(r,r,this.rotation)}Lt.add(t.animatedVelocity,t.animatedVelocity,r);Lt.add(t.ultimateVelocity,t.velocity,t.animatedVelocity);Lt.scale(t.ultimateVelocity,t.ultimateVelocity,this._speedModifier.evaluate(1-t.remainingLifetime/t.startLifetime,t.randomSeed))};zv.schema={enable:{type:"boolean",default:false},x:{type:"CurveRange",default:null},y:{type:"CurveRange",default:null},z:{type:"CurveRange",default:null},speedModifier:{type:"CurveRange",default:null},space:{type:"enums",options:["local","world"],default:"local"}};var Nv=function e(){this.rotation=It.create()};Nv.prototype.update=function e(t,n){this.needTransform=Cv(t,this._space,n,this.rotation)};Nv.prototype.animate=function e(t,n){var r=1-t.remainingLifetime/t.startLifetime;var i=Lt.new(this._x.evaluate(r,t.randomSeed),this._y.evaluate(r,t.randomSeed),this._z.evaluate(r,t.randomSeed));if(this.needTransform){Lt.transformQuat(i,i,this.rotation)}Lt.scaleAndAdd(t.velocity,t.velocity,i,n)};Nv.schema={enable:{type:"boolean",default:false},x:{type:"CurveRange",default:null},y:{type:"CurveRange",default:null},z:{type:"CurveRange",default:null},space:{type:"enums",default:"local",options:["local","world"]},randomized:{type:"boolean",default:false}};var kv=function e(){};kv.prototype.animate=function e(t){var n=1-t.remainingLifetime/t.startLifetime;var r=Lt.zero();if(this._separateAxes){Lt.set(r,Vv(t.ultimateVelocity.x,this._limitX.evaluate(n,t.randomSeed),this._dampen),Vv(t.ultimateVelocity.y,this._limitY.evaluate(n,t.randomSeed),this._dampen),Vv(t.ultimateVelocity.z,this._limitZ.evaluate(n,t.randomSeed),this._dampen))}else{Lt.normalize(r,t.ultimateVelocity);Lt.scale(r,r,Vv(Lt.magnitude(t.ultimateVelocity),this._limit.evaluate(n,t.randomSeed),this._dampen))}Lt.copy(t.ultimateVelocity,r)};function Vv(e,t,n){var r=Math.sign(e);var i=Math.abs(e);if(i>t){i=qe(i,t,n)}return i*r}kv.schema={enable:{type:"boolean",default:false},limitX:{type:"CurveRange",default:null},limitY:{type:"CurveRange",default:null},limitZ:{type:"CurveRange",default:null},limit:{type:"CurveRange",default:null},dampen:{type:"number",default:0},separateAxes:{type:"boolean",default:false},space:{type:"enums",default:"local",options:["local","world"]},drag:{type:"CurveRange",default:null},multiplyDragByParticleSize:{type:"boolean",default:false},multiplyDragByParticleVelocity:{type:"boolean",default:false}};var Wv=function e(){};Wv.prototype.animate=function e(t,n){var r=1-t.remainingLifetime/t.startLifetime;if(!this._separateAxes){t.rotation.x+=this._z.evaluate(r,t.randomSeed)*n}else{}};Wv.schema={enable:{type:"boolean",default:false},separateAxes:{type:"boolean",default:false,set:function e(t){if(!t){this._separateAxes=t}else{console.error("rotation overtime separateAxes is not supported!")}}},x:{type:"CurveRange",default:null},y:{type:"CurveRange",default:null},z:{type:"CurveRange",default:null}};var Gv=function e(){};Gv.prototype.onInit=function e(t){this.ps=t};Gv.prototype.animate=function e(t){var n=1-t.remainingLifetime/t.startLifetime;var r=this._startFrame.evaluate(n,t.randomSeed)/(this._numTilesX*this._numTilesY);if(this._animation=="wholeSheet"){t.frameIndex=nt(this._cycleCount*(this._frameOverTime.evaluate(n,t.randomSeed)+r),1)}else if(this._animation=="singleRow"){var i=1/this._numTilesY;if(this._randomRow){var a=nt(this._cycleCount*(this._frameOverTime.evaluate(n,t.randomSeed)+r),1);var o=Math.floor(Math.random()*this._numTilesY);var s=o*i;var l=s+i;t.frameIndex=qe(s,l,a)}else{var u=this._rowIndex*i;var h=u+i;t.frameIndex=qe(u,h,nt(this._cycleCount*(this._frameOverTime.evaluate(n,t.randomSeed)+r),1))}}};Gv.schema={enable:{type:"boolean",default:false,set:function e(t){this._enable=t;this.ps.renderer._updateMaterialParams()}},mode:{type:"enums",options:["grid","sprites"],default:"grid",set:function e(t){if(t==="sprites"){console.error("particle texture animation's sprites is not supported!");return}}},numTilesX:{type:"number",default:0},numTilesY:{type:"number",default:0},animation:{type:"enums",options:["wholeSheet","singleRow"],default:"wholeSheet"},frameOverTime:{type:"CurveRange",default:null},startFrame:{type:"CurveRange",default:null},cycleCount:{type:"number",default:0},flipU:{type:"number",default:0,set:function e(t){console.error("particle texture animation's flipU is not supported!")}},flipV:{type:"number",default:0,set:function e(t){console.error("particle texture animation's flipV is not supported!")}},uvChannelMask:{type:"number",default:-1,set:function e(t){console.error("particle texture animation's uvChannelMask is not supported!")}},randomRow:{type:"boolean",default:false},rowIndex:{type:"number",default:0}};var Hv=Lt.zero();var jv=new Array;var qv=Lt.new(.5,.5,.5);var Xv=function e(){this.mat=Bt.create();this.quat=It.create()};Xv.prototype.onInit=function e(t){this.constructMat();this.particleSystem=t;this.lastTime=t._time;this.totalAngle=0};Xv.prototype.constructMat=function e(){It.fromEuler(this.quat,this._rotation.x,this._rotation.y,this._rotation.z);Bt.fromRTS(this.mat,this.quat,this._position,this._scale)};Xv.prototype.emit=function e(t){switch(this._shapeType){case"box":Qv(this._emitFrom,this._boxThickness,t.position,t.velocity);break;case"circle":Jv(this._radius,this._radiusThickness,this.generateArcAngle(),t.position,t.velocity);break;case"cone":Zv(this._emitFrom,this._radius,this._radiusThickness,this.generateArcAngle(),this._angle,this._length,t.position,t.velocity);break;case"sphere":Yv(this._emitFrom,this._radius,this._radiusThickness,t.position,t.velocity);break;case"hemisphere":Kv(this._emitFrom,this._radius,this._radiusThickness,t.position,t.velocity);break;default:console.warn(this._shapeType+" shapeType is not supported by ShapeModule.")}if(this._randomPositionAmount>0){t.position.x+=Ze(-this._randomPositionAmount,this._randomPositionAmount);t.position.y+=Ze(-this._randomPositionAmount,this._randomPositionAmount);t.position.z+=Ze(-this._randomPositionAmount,this._randomPositionAmount)}Lt.transformQuat(t.velocity,t.velocity,this.quat);Lt.transformMat4(t.position,t.position,this.mat);if(this._sphericalDirectionAmount>0){var n=Lt.normalize(Hv,t.position);Lt.lerp(t.velocity,t.velocity,n,this._sphericalDirectionAmount)}this.lastTime=this.particleSystem._time};Xv.prototype.generateArcAngle=function e(){if(this._arcMode==="random"){return Ze(0,this._arc)}var t=this.totalAngle+2*Math.PI*this._arcSpeed.evaluate(this.particleSystem._time)*(this.particleSystem._time-this.lastTime);this.totalAngle=t;if(this._arcSpread!==0){t=Math.floor(t/(this._arc*this._arcSpread))*this._arc*this._arcSpread}switch(this._arcMode){case"loop":return nt(t,this._arc);case"pingPong":return rt(t,this._arc)}};function Yv(e,t,n,r,i){switch(e){case"volume":Uv(r,t*(1-n),t);Lt.copy(i,r);Lt.normalize(i,i);break;case"shell":Iv(r);Lt.scale(r,t);Lt.copy(i,r);break;default:console.warn(e+" is not supported for sphere emitter.")}}function Kv(e,t,n,r,i){switch(e){case"volume":Uv(r,t*(1-n),t);if(r.z>0){r.z*=-1}Lt.copy(i,r);Lt.normalize(i,i);break;case"shell":Iv(r);Lt.scale(r,t);if(r.z<0){r.z*=-1}Lt.copy(i,r);break;default:console.warn(e+" is not supported for hemisphere emitter.")}}function Zv(e,t,n,r,i,a,o,s){switch(e){case"base":Pv(o,t*(1-n),t,r);Rt.scale(s,o,Math.sin(i));s.z=-Math.cos(i)*t;o.z=0;break;case"shell":Ov(o,r);Rt.scale(s,o,Math.sin(i));s.z=-Math.cos(i);Rt.scale(o,o,t);o.z=0;break;case"volume":Pv(o,t*(1-n),t,r);Rt.scale(s,o,Math.sin(i));s.z=-Math.cos(i)*t;Lt.normalize(s,s);o.z=0;Lt.add(o,o,Lt.scale(Hv,s,a*Ke()/-s.z));break;default:console.warn(e+" is not supported for cone emitter.")}}function Qv(e,t,n,r){switch(e){case"volume":Bv(n,qv);break;case"shell":jv.splice(0,jv.length);jv.push(Ze(-.5,.5));jv.push(Ze(-.5,.5));jv.push(Fv()*.5);Dv(jv);$v(jv,t);Lt.set(n,jv[0],jv[1],jv[2]);break;case"edge":jv.splice(0,jv.length);jv.push(Ze(-.5,.5));jv.push(Fv()*.5);jv.push(Fv()*.5);Dv(jv);$v(jv,t);Lt.set(n,jv[0],jv[1],jv[2]);break;default:console.warn(e+" is not supported for box emitter.")}Lt.copy(r,Lv)}function Jv(e,t,n,r,i){Pv(r,e*(1-t),e,n);Lt.normalize(i,r)}function $v(e,t){if(t.x>0){e[0]+=.5*Ze(-t.x,t.x);e[0]=He(e[0],-.5,.5)}if(t.y>0){e[1]+=.5*Ze(-t.y,t.y);e[1]=He(e[0],-.5,.5)}if(t.z>0){e[2]+=.5*Ze(-t.z,t.z);e[2]=He(e[0],-.5,.5)}}Xv.schema={enable:{type:"boolean",default:false},shapeType:{type:"enums",options:["box","circle","cone","sphere","hemisphere"],default:"box"},emitFrom:{type:"enums",options:["base","edge","shell","volume"],default:"base"},position:{type:"vec3",default:[0,0,0],set:function e(t){this._position=t;this.constructMat()}},rotation:{type:"vec3",default:[0,0,0],set:function e(t){this._rotation=t;this.constructMat()}},scale:{type:"vec3",default:[1,1,1],set:function e(t){this._scale=t;this.constructMat()}},alignToDirection:{type:"boolean",default:false},randomDirectionAmount:{type:"number",default:0},sphericalDirectionAmount:{type:"number",default:0},randomPositionAmount:{type:"number",default:0},radius:{type:"number",default:0},radiusThickness:{type:"number",default:1},arc:{type:"number",default:0},arcMode:{type:"enums",options:["random","loop","pingPong"],default:"random"},arcSpread:{type:"number",default:0},arcSpeed:{type:"CurveRange",default:null},angle:{type:"number",default:0},length:{type:"number",default:0},boxThickness:{type:"vec3",default:[0,0,0]}};var em=function e(){this._remainingCount=1;this._curTime=0};em.prototype.update=function e(t,n){if(t._loop&&this._remainingCount===0){this._remainingCount=this._repeatCount;this._curTime=this._time}if(this._remainingCount>0){var r=nt(t._time-t._startDelay.evaluate(),t._duration)-n;r=r>0?r:0;var i=nt(t.time-t._startDelay.evaluate(),t._duration);if(this._curTime>=r&&this._curTime<i){t.emit(this._count.evaluate(this._curTime/t._duration));this._curTime+=this._repeatInterval;--this._remainingCount}}};em.schema={time:{type:"number",default:0,set:function e(t){this._time=t;this._curTime=t}},minCount:{type:"int",default:30},maxCount:{type:"int",default:30},repeatCount:{type:"number",default:1,set:function e(t){this._repeatCount=t;this._remainingCount=t}},repeatInterval:{type:"number",default:1},count:{type:"CurveRange",default:null}};Ea.registerClass("Burst",em);Ea.registerClass("ColorKey",mv);Ea.registerClass("AlphaKey",_v);Ea.registerClass("Gradient",gv);Ea.registerClass("GradientRange",xv);Ea.registerClass("CurveRange",yv);Ea.registerClass("SizeOvertimeModule",Mv);Ea.registerClass("ColorOverLifetimeModule",Rv);Ea.registerClass("ParticleSystemRenderer",Av);Ea.registerClass("VelocityOvertimeModule",zv);Ea.registerClass("ForceOvertimeModule",Nv);Ea.registerClass("LimitVelocityOvertimeModule",kv);Ea.registerClass("RotationOvertimeModule",Wv);Ea.registerClass("TextureAnimationModule",Gv);Ea.registerClass("ShapeModule",Xv);var tm=Bt.create();var nm=function(e){function t(){e.call(this);this._isPlaying=false;this._isPaused=false;this._isStopped=true;this._isEmitting=false;this._time=0;this._emitRateTimeCounter=0;this._emitRateDistanceCounter=0;this._oldWPos=Lt.zero();this._curWPos=Lt.zero();this._customData1=Rt.zero();this._customData2=Rt.zero();this._subEmitters=[]}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;var n={isPlaying:{configurable:true},isPaused:{configurable:true},isStopped:{configurable:true},isEmitting:{configurable:true},time:{configurable:true}};t.prototype.onInit=function e(){var t=this;this._particles=new pr(function(){return new vv(t)},this._capacity);this._renderer.onInit(this);this._shapeModule.onInit(this);this._textureAnimationModule.onInit(this);this._entity.getWorldPos(this._oldWPos);Lt.copy(this._curWPos,this._oldWPos);this._system.add(this)};t.prototype.onDestroy=function e(){this._renderer._model.destroy();this._system.remove(this)};t.prototype.onEnable=function e(){this._app.scene.addModel(this._renderer._model);if(this._playOnAwake){this.play()}};t.prototype.onDisable=function e(){this._app.scene.removeModel(this._renderer._model)};t.prototype.play=function e(){if(this._isPaused){this._isPaused=false}if(this._isStopped){this._isStopped=false}this._time=0;this._emitRateTimeCounter=0;this._emitRateDistanceCounter=0;this._isPlaying=true;if(this._prewarm){this._prewarmSystem()}};t.prototype.pause=function e(){if(this._isStopped){console.warn("pause(): particle system is already stopped.");return}if(this._isPlaying){this._isPlaying=false}this._isPaused=true};t.prototype.stop=function e(){if(this._isPlaying){this._isPlaying=false}if(this._isPaused){this._isPaused=false}this.clear();this._time=0;this._emitRateTimeCounter=0;this._emitRateDistanceCounter=0;this._isStopped=true};t.prototype.clear=function e(){this._particles.reset();this._renderer._model.clear()};t.prototype.emit=function e(t,n){var r=this;if(n===void 0)n=null;for(var i=0;i<t;++i){if(r._particles.length>=r._capacity){return}var a=r._particles.add();var o=Je(Qe(0,ot));if(r._shapeModule.enable){r._shapeModule.emit(a)}else{Lt.set(a.position,0,0,0);Lt.copy(a.velocity,Lv)}Lt.scale(a.velocity,a.velocity,r._startSpeed.evaluate(r._time/r._duration,o));switch(r._simulationSpace){case"local":break;case"world":{r._entity.getWorldMatrix(tm);Lt.transformMat4(a.position,a.position,tm);var s=It.create();r._entity.getWorldRot(s);Lt.transformQuat(a.velocity,a.velocity,s)}break;case"custom":break}Lt.set(a.rotation,r._startRotation.evaluate(r._time/r._duration,o),0,0);Lt.set(a.startSize,r._startSize.evaluate(r._time/r._duration,o),0,0);Lt.copy(a.size,a.startSize);Ft.copy(a.startColor,r._startColor.evaluate(r._time/r._duration,o));Ft.copy(a.color,a.startColor);a.startLifetime=r._startLifetime.evaluate(r._time/r._duration,o);a.remainingLifetime=a.startLifetime;a.randomSeed=Je(Qe(0,ot))}};t.prototype._updateParticles=function e(t){var n=this;this._entity.getWorldMatrix(tm);if(this._velocityOvertimeModule.enable){this._velocityOvertimeModule.update(this._simulationSpace,tm)}if(this._forceOvertimeModule.enable){this._forceOvertimeModule.update(this._simulationSpace,tm)}for(var r=0;r<this._particles.length;++r){var i=n._particles.data[r];i.remainingLifetime-=t;Lt.set(i.animatedVelocity,0,0,0);if(i.remainingLifetime<0){n._particles.remove(r);--r;continue}i.velocity.y-=n._gravityModifier.evaluate(1-i.remainingLifetime/i.startLifetime,i.randomSeed)*9.8*t;if(n._sizeOvertimeModule.enable){n._sizeOvertimeModule.animate(i)}if(n._colorOverLifetimeModule.enable){n._colorOverLifetimeModule.animate(i)}if(n._forceOvertimeModule.enable){n._forceOvertimeModule.animate(i,t)}if(n._velocityOvertimeModule.enable){n._velocityOvertimeModule.animate(i)}else{Lt.copy(i.ultimateVelocity,i.velocity)}if(n._limitVelocityOvertimeModule.enable){n._limitVelocityOvertimeModule.animate(i)}if(n._rotationOvertimeModule.enable){n._rotationOvertimeModule.animate(i,t)}if(n._textureAnimationModule.enable){n._textureAnimationModule.animate(i)}Lt.scaleAndAdd(i.position,i.position,i.ultimateVelocity,t)}};t.prototype._prewarmSystem=function e(){var t=this;this._startDelay.mode="constant";this._startDelay.constant=0;var n=1;var r=this._duration/n;for(var i=0;i<r;++i){t._time+=n;t._emit(n);t._updateParticles(n)}};t.prototype._emit=function e(t){var n=this;var r=this._startDelay.evaluate();if(this._time>r){if(!this._isStopped){this._isEmitting=true}if(this._time>this._duration+r){if(!this._loop){this._isEmitting=false;this._isStopped=true}}this._emitRateTimeCounter+=this._rateOverTime.evaluate(this._time/this._duration,1)*t;if(this._emitRateTimeCounter>1&&this._isEmitting){var i=Math.floor(this._emitRateTimeCounter);this._emitRateTimeCounter-=i;this.emit(i)}this._entity.getWorldPos(this._curWPos);var a=Lt.distance(this._curWPos,this._oldWPos);Lt.copy(this._oldWPos,this._curWPos);this._emitRateDistanceCounter+=a*this._rateOverDistance.evaluate(this._time/this._duration,1);if(this._emitRateDistanceCounter>1&&this._isEmitting){var o=Math.floor(this._emitRateDistanceCounter);this._emitRateDistanceCounter-=o;this.emit(o)}for(var s=0;s<this._bursts.length;++s){n._bursts[s].update(n,t)}}};t.prototype.tick=function e(t){var n=t*this._simulationSpeed;if(this._isPlaying){this._time+=n;this._emit(n);this._updateParticles(n);this.renderer._updateRenderData()}};t.prototype.addSubEmitter=function e(t){this._subEmitters.push(t)};t.prototype.removeSubEmitter=function e(t){this._subEmitters.remove(t)};t.prototype.addBurst=function e(t){this._bursts.push(t)};t.prototype.removeBurst=function e(t){this._bursts.remove(t)};t.prototype.getParticleCount=function e(){return this._particles.length};t.prototype.setCustomData1=function e(t,n){Rt.set(this._customData1,t,n)};t.prototype.setCustomData2=function e(t,n){Rt.set(this._customData2,t,n)};n.isPlaying.get=function(){return this._isPlaying};n.isPaused.get=function(){return this._isPaused};n.isStopped.get=function(){return this._isStopped};n.isEmitting.get=function(){return this._isEmitting};n.time.get=function(){return this._time};Object.defineProperties(t.prototype,n);return t}(ta);nm.schema={capacity:{type:"int",default:2e3},startColor:{type:"GradientRange",default:{mode:"color",color:[1,1,1,1]}},startSize:{type:"CurveRange",default:{mode:"constant",constant:1}},startSpeed:{type:"CurveRange",default:{mode:"constant",constant:5}},startRotation:{type:"CurveRange",default:{mode:"constant",constant:0}},startDelay:{type:"CurveRange",default:{mode:"constant",constant:0}},startLifetime:{type:"CurveRange",default:{mode:"constant",constant:5}},duration:{type:"number",default:5},loop:{type:"boolean",default:true},prewarm:{type:"boolean",default:false,set:function e(t){if(t===true&&this._loop===false){}this._prewarm=t}},simulationSpace:{type:"enums",default:"local",options:["local","world","custom"],set:function e(t){if(t==="world"){this._renderer._material.define("USE_WORLD_SPACE",true)}else{this._renderer._material.define("USE_WORLD_SPACE",false)}this._simulationSpace=t}},simulationSpeed:{type:"number",default:1},playOnAwake:{type:"boolean",default:false},gravityModifier:{type:"CurveRange",default:{mode:"constant",constant:0}},rateOverTime:{type:"CurveRange",default:{mode:"constant",constant:10}},rateOverDistance:{type:"CurveRange",default:{mode:"constant",constant:10}},bursts:{type:"Burst",default:[],array:true},colorOverLifetimeModule:{type:"ColorOverLifetimeModule",default:null},shapeModule:{type:"ShapeModule",default:null},renderer:{type:"ParticleSystemRenderer",default:null},sizeOvertimeModule:{type:"SizeOvertimeModule",default:null},velocityOvertimeModule:{type:"VelocityOvertimeModule",default:null},forceOvertimeModule:{type:"ForceOvertimeModule",default:null},limitVelocityOvertimeModule:{type:"LimitVelocityOvertimeModule",default:null},rotationOvertimeModule:{type:"RotationOvertimeModule",default:null},textureAnimationModule:{type:"TextureAnimationModule",default:null}};var rm=function(e){function t(){e.call(this);this._widget=null}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;var n={widget:{configurable:true}};t.prototype.onInit=function e(){this._system.add(this)};t.prototype.onDestroy=function e(){this._system.remove(this);this._widget=null};n.widget.get=function(){if(!this._widget){this._widget=this._entity.getComp("Widget")}return this._widget};Object.defineProperties(t.prototype,n);return t}(ta);var im=function(e){function t(){e.call(this);this._view=new Ni.View}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.onInit=function e(){this._view._clearFlags=Ni.CLEAR_DEPTH|Ni.CLEAR_STENCIL;this._view._cullingByID=true;this._view._stages=["ui"];this._view._stencil=0;this._view._priority=this._priority};t.prototype.onEnable=function e(){this.widget._system.addScreen(this)};t.prototype.onDisable=function e(){this.widget._system.removeScreen(this)};return t}(rm);im.schema={priority:{type:"number",default:0,set:function e(t){this._priority=t;this._view._priority=t}},width:{type:"number",default:960,set:function e(t){this._width=t}},height:{type:"number",default:640,set:function e(t){this._height=t}},scaleFactor:{type:"number",default:1,set:function e(t){this._scaleFactor=t;Lt.set(this._entity.lscale,this._scaleFactor,this._scaleFactor,this._scaleFactor)}}};var am=function(e){function t(){e.apply(this,arguments)}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.tick=function e(){var t=this._entity&&this._entity.getComp("Screen");if(!t){return}var n=this._app._canvas;var r=[n.width/t.width,n.height/t.height];if(this._adaptionMode==="match-width-or-height"){var i=Math.log2(r[0]);var a=Math.log2(r[1]);var o=qe(i,a,this._match);this._scaleFactor=Math.pow(2,o)}else if(this._adaptionMode==="expand"){this._scaleFactor=Math.min(r[0],r[1])}else if(this._adaptionMode==="shrink"){this._scaleFactor=Math.max(r[0],r[1])}t.scaleFactor=this._scaleFactor};return t}(rm);am.schema={adaptionMode:{type:"enums",default:"none",options:["none","match-width-or-height","expand","shrink"],set:function e(t){if(this._adaptionMode===t){return}this._adaptionMode=t}},match:{type:"number",default:0},scaleFactor:{type:"number",default:1,set:function e(t){if(this._scaleFactor===t){return}if(this._adaptionMode!=="none"){return}this._scaleFactor=t}}};var om=Bt.create();var sm=function(e){function t(){e.call(this);this._rect={x:0,y:0,w:0,h:0}}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype._onRectChanged=function e(){this.dispatch("Widget.onRectChanged")};t.prototype.setAnchors=function e(t,n,r,i){this._anchorLeft=t;this._anchorRight=r;this._anchorBottom=n;this._anchorTop=i};t.prototype.setOffset=function e(t,n){this._offsetX=t;this._offsetY=n};t.prototype.setSize=function e(t,n){this._sizeX=t;this._sizeY=n};t.prototype.setPivot=function e(t,n){this._pivotX=t;this._pivotY=n};t.prototype.getLeft=function e(){return this._offsetX-this._sizeX*this._pivotX};t.prototype.getRight=function e(){return-(this._offsetX+this._sizeX*(1-this._pivotX))};t.prototype.getBottom=function e(){return this._offsetY-this._sizeY*this._pivotY};t.prototype.getTop=function e(){return-(this._offsetY+this._sizeY*(1-this._pivotY))};t.prototype.setLeft=function e(t){var n=t-(this._offsetX-this._sizeX*this._pivotX);this._sizeX-=n;this._offsetX+=n*(1-this._pivotX)};t.prototype.setRight=function e(t){var n=-t-(this._offsetX+this._sizeX*(1-this._pivotX));this._sizeX+=n;this._offsetX+=n*this._pivotX};t.prototype.setBottom=function e(t){var n=t-(this._offsetY-this._sizeY*this._pivotY);this._sizeY-=n;this._offsetY+=n*(1-this._pivotY)};t.prototype.setTop=function e(t){var n=-t-(this._offsetY+this._sizeY*(1-this._pivotY));this._sizeY+=n;this._offsetY+=n*this._pivotY};t.prototype.calculate=function e(t,n,r,i){var a=t+r*this._anchorLeft;var o=n+i*this._anchorBottom;var s=t+r*this._anchorRight;var l=n+i*this._anchorTop;var u=0;var h=0;var c=0;var f=0;c=s-a+this._sizeX;f=l-o+this._sizeY;u=a+this._offsetX-this._sizeX*this._pivotX;h=o+this._offsetY-this._sizeY*this._pivotY;var p=u+c*this._pivotX;var d=h+f*this._pivotY;Lt.set(this._entity.lpos,p,d,this._entity.lpos.z);u=u-p;h=h-d;if(u!==this._rect.x||h!==this._rect.y||c!==this._rect.w||f!==this._rect.h){this._onRectChanged()}this._rect.x=u;this._rect.y=h;this._rect.w=c;this._rect.h=f};t.prototype.getWorldCorners=function e(t,n,r,i){this._entity.getWorldMatrix(om);var a=this._rect.x;var o=this._rect.y;var s=this._rect.w;var l=this._rect.h;Lt.set(t,a,o+l,0);Lt.transformMat4(t,t,om);Lt.set(n,a,o,0);Lt.transformMat4(n,n,om);Lt.set(r,a+s,o,0);Lt.transformMat4(r,r,om);Lt.set(i,a+s,o+l,0);Lt.transformMat4(i,i,om)};return t}(ta);sm.schema={focusable:{type:"boolean",default:false},pivotX:{type:"number",default:.5},pivotY:{type:"number",default:.5},anchorLeft:{type:"number",default:.5},anchorBottom:{type:"number",default:.5},anchorRight:{type:"number",default:.5},anchorTop:{type:"number",default:.5},offsetX:{type:"number",default:0},offsetY:{type:"number",default:0},sizeX:{type:"number",default:100},sizeY:{type:"number",default:100}};var lm=[0,0,0,0];var um=[0,0,0,0];var hm=Bt.create();var cm=[0,1,2,3,2,1];var fm=[0,1,4,5,4,1,1,2,5,6,5,2,2,3,6,7,6,3,4,5,8,9,8,5,5,6,9,10,9,6,6,7,10,11,10,7,8,9,12,13,12,9,9,10,13,14,13,10,10,11,14,15,14,11];var pm=[0,1,2,0,3,4,0,5,6,0,7,8,0,9,10];function dm(e,t){var n=4;var r=null;if(e==="simple"){n=4;r=cm}else if(e==="sliced"){n=16;r=fm}else if(e==="filled"){if(t==="radial"){n=11}else{n=4;r=cm}}var i=new Array(n);var a=new Array(n);var o=new Array(n);var s=Ft.create();for(var l=0;l<n;++l){a[l]=Lt.zero();i[l]=Lt.zero();o[l]=Lt.zero()}return{wposList:a,lposList:i,uvs:o,color:s,indices:r}}function vm(e,t,n,r,i,a){Lt.set(e.lposList[0],n,r,0);Lt.set(e.lposList[1],n+i,r,0);Lt.set(e.lposList[2],n,r+a,0);Lt.set(e.lposList[3],n+i,r+a,0);Lt.copy(e.uvs[0],t.uvs[0]);Lt.copy(e.uvs[1],t.uvs[3]);Lt.copy(e.uvs[2],t.uvs[12]);Lt.copy(e.uvs[3],t.uvs[15]);return e}function mm(e,t,n,r,i,a){var o=1;var s=1;if(t._left+t._right>i){o=i/(t._left+t._right)}if(t._bottom+t._top>a){s=a/(t._bottom+t._top)}lm[0]=n;lm[1]=n+t._left*o;lm[2]=n+i-t._right*o;lm[3]=n+i;um[0]=r;um[1]=r+t._bottom*s;um[2]=r+a-t._top*s;um[3]=r+a;for(var l=0;l<4;++l){for(var u=0;u<4;++u){Lt.set(e.lposList[l*4+u],lm[u],um[l],0)}}for(var h=0;h<16;++h){Lt.copy(e.uvs[h],t.uvs[h])}return e}function _m(e,t,n,r,i,a,o,s){o=o<0?0:o;o=o>1?1:o;s=s<0?0:s;var l=s+o>1?1:s+o;Lt.set(e.lposList[0],i*o+n,r,0);Lt.set(e.lposList[1],i*l+n,r,0);Lt.set(e.lposList[2],i*o+n,r+a,0);Lt.set(e.lposList[3],i*l+n,r+a,0);Lt.lerp(e.uvs[0],t.uvs[0],t.uvs[3],o);Lt.lerp(e.uvs[1],t.uvs[0],t.uvs[3],l);Lt.lerp(e.uvs[2],t.uvs[12],t.uvs[15],o);Lt.lerp(e.uvs[3],t.uvs[12],t.uvs[15],l);return e}function gm(e,t,n,r,i,a,o,s){o=o<0?0:o;o=o>1?1:o;s=s<0?0:s;var l=s+o>1?1:s+o;Lt.set(e.lposList[0],n,r+a*o,0);Lt.set(e.lposList[1],i+n,r+a*o,0);Lt.set(e.lposList[2],n,r+a*l,0);Lt.set(e.lposList[3],i+n,r+a*l,0);Lt.lerp(e.uvs[0],t.uvs[0],t.uvs[12],o);Lt.lerp(e.uvs[1],t.uvs[3],t.uvs[15],o);Lt.lerp(e.uvs[2],t.uvs[0],t.uvs[12],l);Lt.lerp(e.uvs[3],t.uvs[3],t.uvs[15],l);return e}function ym(e,t){var n,r;n=t.x-e.x;r=t.y-e.y;if(n===0&&r===0){return NaN}else if(n===0){if(r>0){return Math.PI*.5}else{return Math.PI*1.5}}else{var i=Math.atan(r/n);if(n<0){i+=Math.PI}return i}}function xm(e,t,n,r,i){var a=e.left;var o=e.right;var s=e.top;var l=e.bottom;var u=Math.sin(n);var h=Math.cos(n);var c,f;if(Math.cos(n)!==0){c=u/h;if((a-t.x)*h>0){var p=t.y+c*(a-t.x);r[3].x=a;r[3].y=p;Lt.lerp(i[3],e.uvbl,e.uvtl,(p-e.bottom)/(e.top-e.bottom))}if((o-t.x)*h>0){var d=t.y+c*(o-t.x);r[1].x=o;r[1].y=d;Lt.lerp(i[1],e.uvbr,e.uvtr,(d-e.bottom)/(e.top-e.bottom))}}if(Math.sin(n)!==0){f=h/u;if((s-t.y)*u>0){var v=t.x+f*(s-t.y);r[2].x=v;r[2].y=s;Lt.lerp(i[2],e.uvtl,e.uvtr,(v-e.left)/(e.right-e.left))}if((l-t.y)*u>0){var m=t.x+f*(l-t.y);r[0].x=m;r[0].y=l;Lt.lerp(i[0],e.uvbl,e.uvbr,(m-e.left)/(e.right-e.left))}}}var bm=function(){var y=[Lt.zero(),Lt.zero(),Lt.zero(),Lt.zero()];var x=[Lt.zero(),Lt.zero(),Lt.zero(),Lt.zero()];var b=[Lt.zero(),Lt.zero(),Lt.zero(),Lt.zero()];var w=[Lt.zero(),Lt.zero(),Lt.zero(),Lt.zero()];var E=Lt.zero();var T=Lt.zero();var S=[Lt.zero(),Lt.zero(),Lt.zero(),Lt.zero()];var A=[0,0,0,0];var M=Lt.zero();var R=Lt.zero();var L={left:0,right:100,bottom:0,top:100,uvbl:Lt.new(0,0,0),uvbr:Lt.new(1,0,0),uvtl:Lt.new(0,1,0),uvtr:Lt.new(1,1,0)};var C=new Array(4);return function(e,t,n,r,i,a,o,s,l,u){Lt.sub(M,t.uvs[3],t.uvs[0]);Lt.sub(R,t.uvs[12],t.uvs[0]);C[0]=t.uvs[0];C[1]=t.uvs[3];C[2]=t.uvs[15];C[3]=t.uvs[12];if(s>=1){vm(e,t,n,r,i,a);e.indices=cm;return e}e.indices=pm;s=s<0?0:s;while(o>=1){o=o-1}while(o<0){o=o+1}o=o*Math.PI*2;s=s*Math.PI*2;var h=o+s;E.x=l<0?0:l;E.y=u<0?0:u;E.x=l>1?1:l;E.y=u>1?1:u;Lt.copy(T,t.uvs[0]);T.x+=M.x*l;T.y+=M.y*l;T.x+=R.x*u;T.y+=R.y*u;E.x=E.x*i;E.y=E.y*a;S[0].x=0;S[0].y=0;S[1].x=i;S[1].y=0;S[2].x=i;S[2].y=a;S[3].x=0;S[3].y=a;for(var c=0;c<4;++c){A[c]=ym(E,S[c])}L.left=0;L.bottom=0;L.right=i;L.top=a;L.uvbl=t.uvs[0];L.uvbr=t.uvs[3];L.uvtl=t.uvs[12];L.uvtr=t.uvs[15];xm(L,E,o,y,b);xm(L,E,h,x,w);var f=1;Lt.copy(e.lposList[0],E);Lt.copy(e.uvs[0],T);for(var p=0;p<4;++p){var d=A[p];var v=A[(p+1)%4];if(v<d){v+=Math.PI*2}d-=Math.PI*2;v-=Math.PI*2;for(var m=0;m<3;++m){if(d>=h){}else if(d>=o){if(v>=h){Lt.copy(e.lposList[f],S[p]);Lt.copy(e.lposList[f+1],x[p]);Lt.copy(e.uvs[f],C[p]);Lt.copy(e.uvs[f+1],w[p]);f+=2}else{Lt.copy(e.lposList[f],S[p]);Lt.copy(e.lposList[f+1],S[(p+1)%4]);Lt.copy(e.uvs[f],C[p]);Lt.copy(e.uvs[f+1],C[(p+1)%4]);f+=2}}else{if(v<=o){}else if(v<=h){Lt.copy(e.lposList[f],y[p]);Lt.copy(e.lposList[f+1],S[(p+1)%4]);Lt.copy(e.uvs[f],b[p]);Lt.copy(e.uvs[f+1],C[(p+1)%4]);f+=2}else{Lt.copy(e.lposList[f],y[p]);Lt.copy(e.lposList[f+1],x[p]);Lt.copy(e.uvs[f],b[p]);Lt.copy(e.uvs[f+1],w[p]);f+=2}}d+=Math.PI*2;v+=Math.PI*2}}for(var _=0;_<f;++_){e.lposList[_].x+=n;e.lposList[_].y+=r}for(var g=f;g<e.lposList.length;++g){Lt.copy(e.lposList[g],e.lposList[0])}return e}}();var wm=function(e){function t(){e.apply(this,arguments)}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.onInit=function e(){var t=this;this._cachedVertexData=dm(this._type,this._fillType);this._vertexDataDirty=true;if(this._material===null){this._material=this._app.assets.get("builtin-material-sprite")}this._entity.on("Widget.onRectChanged",function(){t._onRectChanged()})};t.prototype.onDestroy=function e(){var t=this;this._entity.off("Widget.onRectChanged",function(){t._onRectChanged()})};t.prototype._onRectChanged=function e(){this._vertexDataDirty=true};t.prototype.calcVertexData=function e(t,n,r,i){var a=this;if(this._vertexDataDirty){this._vertexDataDirty=false;var o=this._sprite;if(o===null){o=this._app.assets.get("default-sprite")}Ft.copy(this._cachedVertexData.color,this._color);if(this._type==="simple"){vm(this._cachedVertexData,o,t,n,r,i)}else if(this._type=="sliced"){mm(this._cachedVertexData,o,t,n,r,i)}else if(this._type==="filled"){if(this._fillType==="radial"){bm(this._cachedVertexData,o,t,n,r,i,this._fillStart,this._fillRange,this._fillCenter.x,this._fillCenter.y)}else if(this._fillType==="vertical"){gm(this._cachedVertexData,o,t,n,r,i,this._fillStart,this._fillRange)}else{_m(this._cachedVertexData,o,t,n,r,i,this._fillStart,this._fillRange)}}}this._entity.getWorldMatrix(hm);for(var s=0;s<this._cachedVertexData.lposList.length;++s){var l=a._cachedVertexData.lposList[s];var u=a._cachedVertexData.wposList[s];Lt.transformMat4(u,l,hm)}return this._cachedVertexData};return t}(rm);wm.schema={material:{type:"asset",default:null,set:function e(t){if(t===this._material){return}this._material=t}},type:{type:"enums",default:"simple",options:["simple","sliced","filled"],set:function e(t){if(t===this._type){return}this._type=t;this._cachedVertexData=dm(this._type,this._fillType);this._vertexDataDirty=true}},fillType:{type:"enums",default:"horizontal",options:["horizontal","vertical","radial"],set:function e(t){if(t===this._fillType){return}this._fillType=t;if(this._type==="filled"){this._cachedVertexData=dm(this._type,this._fillType);this._vertexDataDirty=true}}},fillStart:{type:"number",default:.2,set:function e(t){if(t===this._fillStart){return}this._fillStart=t;if(this._type==="filled"){this._vertexDataDirty=true}}},fillRange:{type:"number",default:.8,set:function e(t){if(t===this._fillRange){return}this._fillRange=t;if(this._type==="filled"){this._vertexDataDirty=true}}},fillCenter:{type:"vec2",default:[.5,.5],set:function e(t){if(Rt.equals(this._fillCenter,t)){return}this._fillCenter=t;if(this._type==="filled"&&this._fillType==="radial"){this._vertexDataDirty=true}}},sprite:{type:"asset",default:null,set:function e(t){if(t===this._sprite){return}this._sprite=t;this._vertexDataDirty=true}},color:{type:"color4",default:[1,1,1,1],set:function e(t){if(Ft.equals(this._color,t)){return}Ft.copy(this._color,t);this._vertexDataDirty=true}}};var Em=Bt.create();var Tm=document.createElement("canvas");Tm.width=Tm.height=1;function Sm(e){var t=4*e;var n=6*e;var r=new Array(n);var i=new Array(t);var a=new Array(t);var o=new Array(t);var s=Ft.new();for(var l=0;l<t;++l){a[l]=Lt.zero();i[l]=Lt.zero();o[l]=Rt.zero()}for(var u=0;u<e;++u){r[6*u+0]=4*u+0;r[6*u+1]=4*u+1;r[6*u+2]=4*u+2;r[6*u+3]=4*u+3;r[6*u+4]=4*u+2;r[6*u+5]=4*u+1}return{wposList:a,lposList:i,uvs:o,color:s,indices:r}}function Am(e,t,n){var r=0;if(e._font===null){r=t.measureText(n).width}else{var i=e._fontSize/e._font._size;for(var a=0;a<n.length;++a){var o=n.charCodeAt(a);var s=e._font._glyphs[o]||e._font._defaultGlyph;r+=s.xadvance*i}}return r}function Mm(e,t,n){var r=[];var i=t.split(e._regWordSep);var a=0;var o=0;var s=0;var l=Tm.getContext("2d");if(e._font===null){var u=e._italic?"italic":"";var h=e._bold?"bold":"";var c=u+" "+h+" "+e._fontSize+"px "+e._fontFamily;l.font=c}for(var f=0;f+1<i.length;){var p=Am(e,l,i[f]);var d=Am(e,l,i[f+1]);if(s+p+d<n){if(f!==0&&s===0){s+=d;a=a+i[f].length;o+=i[f].length+i[f+1].length;f+=2}else{s+=p+d;o+=i[f].length+i[f+1].length;f+=2}}else if(s===0){r.push({start:a+i[f].length,end:a+i[f].length+i[f+1].length,width:d});a=a+i[f].length+i[f+1].length;o=a;s=0;f+=2}else{r.push({start:a,end:o,width:s});a=o;s=0}}if(s>0){r.push({start:a,end:o,width:s})}return r}function Rm(i,e,t,a,n){function r(e){var t=e.text.slice(e.start,e.end);var n=d.measureText(t).width;var r=(a-n)*i._alignH;s.fillText(t,r,e.y)}var o=i._cachedVertexData;Lt.set(o.lposList[0],e,t,0);Lt.set(o.lposList[1],e+a,t,0);Lt.set(o.lposList[2],e,t+n,0);Lt.set(o.lposList[3],e+a,t+n,0);Rt.set(o.uvs[0],0,0);Rt.set(o.uvs[1],1,0);Rt.set(o.uvs[2],0,1);Rt.set(o.uvs[3],1,1);i._fontCanvas.width=a;i._fontCanvas.height=n;var s=i._fontCanvas.getContext("2d");s.clearRect(0,0,a,n);s.fillStyle="#FFFFFF";var l=i._italic?"italic":"";var u=i._bold?"bold":"";var h=l+" "+u+" "+i._fontSize+"px "+i._fontFamily;s.font=h;var c=i._lineHeight*i._fontSize*-.15;var f=c;var p=i._text.split("\n");var d=Tm.getContext("2d");d.font=h;var v=[];if(i._wrap){for(var m=0;m<p.length;++m){var _=Mm(i,p[m],a);if(_.length===0){f+=i._lineHeight*i._fontSize;v.push({text:"",start:0,end:0,y:f})}else{for(var g=0;g<_.length;++g){f+=i._lineHeight*i._fontSize;v.push({text:p[m],start:_[g].start,end:_[g].end,y:f})}}}}else{for(var y=0;y<p.length;++y){f+=i._lineHeight*i._fontSize;v.push({text:p[y],start:0,end:p[y].length,y:f})}}var x=v[v.length-1].y-c;for(var b=0;b<v.length;++b){v[b].y+=(n-x)*i._alignV;r(v[b])}i._fontTexture.setImages([i._fontCanvas]);i._fontTexture.commit()}function Lm(v,e,t,m,n){var _=0;var r=v._text.split("\n");var g=v._font;var y=v._fontSize/g._size;var x=v._cachedVertexData;var b=0;var w=0;function i(e,t,n){var r=0;for(var i=0;i<n-t;++i){var a=e.charCodeAt(i+t);var o=g._glyphs[a]||g._defaultGlyph;var s=r+o.xoffset*y;var l=r+(o.width+o.xoffset)*y;var u=_-(o.height+o.yoffset)*y;var h=_-o.yoffset*y;var c=w+i;Lt.set(x.lposList[4*c+0],s,u,0);Lt.set(x.lposList[4*c+1],l,u,0);Lt.set(x.lposList[4*c+2],s,h,0);Lt.set(x.lposList[4*c+3],l,h,0);Rt.copy(x.uvs[4*c+0],o.uvs[0]);Rt.copy(x.uvs[4*c+1],o.uvs[1]);Rt.copy(x.uvs[4*c+2],o.uvs[2]);Rt.copy(x.uvs[4*c+3],o.uvs[3]);r+=o.xadvance*y}if(r<m){for(var f=0;f<n-t;++f){var p=(m-r)*v._alignH;var d=w+f;x.lposList[4*d+0].x+=p;x.lposList[4*d+1].x+=p;x.lposList[4*d+2].x+=p;x.lposList[4*d+3].x+=p}}w+=n-t;++b;_-=v._lineHeight*g._lineHeight*y}if(v._wrap){for(var a=0;a<r.length;++a){var o=Mm(v,r[a],m);if(o.length===0&&v._text.length!==0){i(" ",0,1)}else{for(var s=0;s<o.length;++s){i(r[a],o[s].start,o[s].end)}}}}else{for(var l=0;l<r.length;++l){i(r[l],0,r[l].length)}}var u=b*v._lineHeight*g._lineHeight*y;var h=u<n?(n-u)*-v._alignV:0;var c=t+n+h;for(var f=0;f<w;++f){x.lposList[4*f+0].x+=e;x.lposList[4*f+1].x+=e;x.lposList[4*f+2].x+=e;x.lposList[4*f+3].x+=e;x.lposList[4*f+0].y+=c;x.lposList[4*f+1].y+=c;x.lposList[4*f+2].y+=c;x.lposList[4*f+3].y+=c}return w}var Cm=function(e){function t(){e.apply(this,arguments)}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.onInit=function e(){var t=this;this._alignH=0;this._alignV=0;this._regWordSep=new RegExp(this._wordSep);this._fontCanvas=document.createElement("canvas");if(this._material===null){this._material=this._app.assets.get("builtin-material-font")}if(this._font===null&&this._fontTexture===null){this._fontTexture=new ja(this._app.device);this._fontTexture.mipmap=false;this._fontTexture.wrapS="clamp";this._fontTexture.wrapT="clamp";this._fontTexture.premultiplyAlpha=true}this._updateFont();this._updateAlignHV();this._entity.on("Widget.onRectChanged",function(){t._onRectChanged()})};t.prototype.onDestroy=function e(){var t=this;this._entity.off("Widget.onRectChanged",function(){t._onRectChanged()})};t.prototype._onRectChanged=function e(){this._vertexDataDirty=true};t.prototype._updateFont=function e(){if(this._font===null){this._cachedVertexData=Sm(1);this._vertexDataDirty=true;return}if(this._font.type==="opentype"){this._font.addText(this._text)}else if(this._font.type==="bitmap"){this._material=this._app.assets.get("builtin-material-sprite")}this._cachedVertexData=Sm(this._text.length);this._vertexDataDirty=true};t.prototype._updateAlignHV=function e(){if(this._align==="top-left"){this._alignH=0;this._alignV=0}else if(this._align==="top-center"){this._alignH=.5;this._alignV=0}else if(this._align==="top-right"){this._alignH=1;this._alignV=0}else if(this._align==="middle-left"){this._alignH=0;this._alignV=.5}else if(this._align==="middle-center"){this._alignH=.5;this._alignV=.5}else if(this._align==="middle-right"){this._alignH=1;this._alignV=.5}else if(this._align==="bottom-left"){this._alignH=0;this._alignV=1}else if(this._align==="bottom-center"){this._alignH=.5;this._alignV=1}else if(this._align==="bottom-right"){this._alignH=1;this._alignV=1}};t.prototype.calcVertexData=function e(t,n,r,i){var a=this;if(this._vertexDataDirty){this._vertexDataDirty=false;Ft.copy(this._cachedVertexData.color,this._color);if(this._font===null){Rm(this,t,n,r,i)}else{Lm(this,t,n,r,i)}}this._entity.getWorldMatrix(Em);for(var o=0;o<this._cachedVertexData.lposList.length;++o){var s=a._cachedVertexData.lposList[o];var l=a._cachedVertexData.wposList[o];Lt.transformMat4(l,s,Em)}return this._cachedVertexData};return t}(rm);Cm.schema={material:{type:"asset",default:null,set:function e(t){if(t===this._material){return}this._material=t}},font:{type:"asset",default:null,set:function e(t){if(t===this._font){return}this._font=t;this._updateFont()}},text:{type:"string",default:"",set:function e(t){if(this._text===t){return}this._text=t;this._updateFont()}},align:{type:"enums",default:"top-left",options:["top-left","top-center","top-right","middle-left","middle-center","middle-right","bottom-left","bottom-center","bottom-right"],set:function e(t){if(this._align===t){return}this._align=t;this._vertexDataDirty=true;this._updateAlignHV()}},wrap:{type:"boolean",default:true,set:function e(t){if(this._wrap===t){return}this._wrap=t;this._vertexDataDirty=true}},fontSize:{type:"int",default:32,set:function e(t){if(this._fontSize===t){return}this._fontSize=t;this._vertexDataDirty=true}},lineHeight:{type:"number",default:1,set:function e(t){if(this._lineHeight===t){return}this._lineHeight=t;this._vertexDataDirty=true}},color:{type:"color4",default:[1,1,1,1],set:function e(t){if(Ft.equals(this._color,t)){return}this._color=t;this._vertexDataDirty=true}},wordSep:{type:"string",default:/([a-zA-Z0-9ÄÖÜäöüßéèçàùêâîôûа-яА-ЯЁё]+|\S)/,set:function e(t){if(this._wordSep===t){return}this._wordSep=t;this._regWordSep=new RegExp(t)}},fontFamily:{type:"string",default:"Arial",set:function e(t){if(this._fontFamily===t){return}this._fontFamily=t;this._vertexDataDirty=true}},italic:{type:"boolean",default:false,set:function e(t){if(this._italic===t){return}this._italic=t;this._vertexDataDirty=true}},bold:{type:"boolean",default:false,set:function e(t){if(this._bold===t){return}this._bold=t;this._vertexDataDirty=true}},fontTexture:{type:"asset",default:null}};var Om=Bt.create();function Im(){var e=4;var t=[0,1,2,3,2,1];var n=new Array(e);var r=new Array(e);var i=new Array(e);var a=Ft.new(1,1,1,1);i[0]=Rt.new(0,0);i[1]=Rt.new(1,0);i[2]=Rt.new(0,1);i[3]=Rt.new(1,1);for(var o=0;o<e;++o){r[o]=Lt.zero();n[o]=Lt.zero()}return{wposList:r,lposList:n,uvs:i,color:a,indices:t}}var Um=function(e){function t(){e.apply(this,arguments)}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.onInit=function e(){var t=this;this._cachedVertexData=Im();this._vertexDataDirty=true;if(this._material===null){this._material=this._app.assets.get("builtin-material-sprite")}this._entity.on("Widget.onRectChanged",function(){t._vertexDataDirty=true})};t.prototype.onDestroy=function e(){var t=this;this._entity.off("Widget.onRectChanged",function(){t._onRectChanged()})};t.prototype._onRectChanged=function e(){this._vertexDataDirty=true};t.prototype.calcVertexData=function e(t,n,r,i){var a=this;if(this._vertexDataDirty){this._vertexDataDirty=false;Lt.set(this._cachedVertexData.lposList[0],t,n,0);Lt.set(this._cachedVertexData.lposList[1],t+r,n,0);Lt.set(this._cachedVertexData.lposList[2],t,n+i,0);Lt.set(this._cachedVertexData.lposList[3],t+r,n+i,0)}this._entity.getWorldMatrix(Om);for(var o=0;o<this._cachedVertexData.lposList.length;++o){var s=a._cachedVertexData.lposList[o];var l=a._cachedVertexData.wposList[o];Lt.transformMat4(l,s,Om)}return this._cachedVertexData};return t}(rm);Um.schema={material:{type:"asset",default:null,set:function e(t){if(t===this._material){return}this._material=t}},sprite:{type:"asset",default:null,set:function e(t){if(t!==this._sprite){return}this._sprite=t}}};var Pm=function(e){function t(){e.call(this);this._uiElements=new lr(200)}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.add=function e(t){this._uiElements.push(t)};t.prototype.remove=function e(t){this._uiElements.fastRemove(this._uiElements.indexOf(t))};t.prototype.tick=function e(){var t=this;for(var n=0;n<this._uiElements.length;++n){var r=t._uiElements.data[n];if(r&&r.tick){r.tick()}}};t.prototype.postTick=function e(){var t=this;for(var n=0;n<this._uiElements.length;++n){var r=t._uiElements.data[n];if(r&&r.postTick){r.postTick()}}};return t}(oa);var Bm=function(t){function e(){t.call(this);this._highlighting=false;this._pressing=false;this._widget=null;this._bgImage=null;this._state="none";this._fingerId=-1}if(t)e.__proto__=t;e.prototype=Object.create(t&&t.prototype);e.prototype.constructor=e;e.prototype.onInit=function e(){t.prototype.onInit.call(this);this._widget=this._entity.getComp("Widget");this._widget.focusable=true;this._bgImage=this._background&&this._background.getComp("Image");if(!this._bgImage){this._bgImage=this._entity.getComp("Image")}};e.prototype.onDestroy=function e(){this._widget.focusable=false;t.prototype.onDestroy.call(this)};e.prototype._updateState=function e(){var t="normal";if(this._pressing){t="pressed"}else if(this._highlighting){t="highlight"}if(this._state===t){return}var n=this._state;this._state=t;this.dispatch("transition",{detail:{oldState:n,newState:this._state}});if(this._bgImage===null){return}if(this._transition==="none"){return}if(this._transition==="color"){this._bgImage.color=this._transitionColors[t]}else if(this._transition==="sprite"){this._bgImage.sprite=this._transitionSprites[t]}else{console.warn("Button transition animation is not implemented")}};e.prototype._onMouseEnter=function e(t){if(this.enabled===false){return}var n=this._widget.system;this._highlighting=true;if(n.focusedEntity===this._entity&&t.buttons&1!==0){this._pressing=true}this._updateState()};e.prototype._onMouseLeave=function e(t){if(this.enabled===false){return}var n=this._widget.system;this._pressing=false;if(n.focusedEntity&&n.focusedEntity===this._entity){this._highlighting=true}else{this._highlighting=false}this._updateState()};e.prototype._onMouseDown=function e(t){if(this.enabled===false){return}var n=this._widget.system;if(t.button==="left"){t.stop();if(n.focusedEntity!==this._entity){return}this._pressing=true;this._updateState()}};e.prototype._onMouseUp=function e(t){if(this.enabled===false){return}if(t.button==="left"){t.stop();this._pressing=false;this._updateState();this.dispatch("clicked")}};e.prototype._onFocus=function e(){if(this.enabled===false){return}this._highlighting=true;this._updateState()};e.prototype._onBlur=function e(){if(this.enabled===false){return}this._fingerId=-1;this._highlighting=false;this._updateState()};e.prototype._onTouchEnter=function e(t){if(this.enabled===false){return}if(this._fingerId===t.id){t.stop();this._pressing=true;this._updateState()}};e.prototype._onTouchLeave=function e(t){if(this.enabled===false){return}t.stop();this._pressing=false;this._updateState()};e.prototype._onTouchStart=function e(t){if(this.enabled===false){return}t.stop();this._fingerId=t.id;this._pressing=true;this._updateState()};e.prototype._onTouchEnd=function e(t){if(this.enabled===false){return}t.stop();this._fingerId=-1;this._pressing=false;this._updateState();this.dispatch("clicked")};return e}(rm);Bm.events={mouseenter:"_onMouseEnter",mouseleave:"_onMouseLeave",mousedown:"_onMouseDown",mouseup:"_onMouseUp",focus:"_onFocus",blur:"_onBlur",touchenter:"_onTouchEnter",touchleave:"_onTouchLeave",touchstart:"_onTouchStart",touchend:"_onTouchEnd"};Bm.schema={transitionColors:{type:"object",default:{normal:Ft.create(),highlight:Ft.create(),pressed:Ft.create(),disabled:Ft.create()}},transitionSprites:{type:"object",parse:function e(t,n,r,i){if(n){var a={normal:null,highlight:null,pressed:null,disabled:null};if(n.normal&&typeof n.normal==="string"){a.normal=t.assets.get(n.normal)}if(n.highlight&&typeof n.highlight==="string"){a.highlight=t.assets.get(n.highlight)}if(n.pressed&&typeof n.pressed==="string"){a.pressed=t.assets.get(n.pressed)}if(n.disabled&&typeof n.disabled==="string"){a.disabled=t.assets.get(n.disabled)}return a}},default:{normal:null,highlight:null,pressed:null,disabled:null}},background:{type:"entity",default:null,set:function e(t){if(!(t instanceof ra)){return}this._background=t;if(this._background){this._bgImage=this._background.getComp("Image")}}},transition:{type:"enums",default:"none",options:["none","color","sprite"]}};var Dm=function(t){function e(){t.call(this);this._state="none";this._highlighting=false;this._pressing=false;this._widget=null;this._bgImage=null;this._toggleGroupComp=null;this._checkerImage=null;this._fingerId=-1}if(t)e.__proto__=t;e.prototype=Object.create(t&&t.prototype);e.prototype.constructor=e;e.prototype.onInit=function e(){t.prototype.onInit.call(this);this._widget=this._entity.getComp("Widget");this._widget.focusable=true;this._bgImage=this._background&&this._background.getComp("Image");if(!this._bgImage){this._bgImage=this._entity.getComp("Image")}this._toggleGroupComp=this._toggleGroup&&this._toggleGroup.getComp("ToggleGroup");if(this._toggleGroupComp){this._toggleGroupComp._addItem(this)}this._checkerImage=this._checker&&this._checker.getComp("Image");if(this._checkerImage){this._checkerImage.enabled=this._checked}};e.prototype.onDestroy=function e(){this._widget.focusable=false;t.prototype.onDestroy.call(this)};e.prototype._updateState=function e(){var t="normal";if(this._pressing){t="pressed"}else if(this._highlighting){t="highlight"}if(this._state===t){return}var n=this._state;this._state=t;this.dispatch("transition",{detail:{oldState:n,newState:this._state}});if(this._bgImage===null){return}if(this._transition==="none"){return}if(this._transition==="color"){this._bgImage.color=this._transitionColors[t]}else if(this._transition==="sprite"){this._bgImage.sprite=this._transitionSprites[t]}else{console.warn("Button transition animation is not implemented")}};e.prototype._onMouseEnter=function e(t){if(this.enabled===false){return}var n=this._widget.system;this._highlighting=true;if(n.focusedEntity===this._entity&&t.buttons&1!==0){this._pressing=true}this._updateState()};e.prototype._onMouseLeave=function e(t){if(this.enabled===false){return}var n=this._widget.system;this._pressing=false;if(n.focusedEntity&&n.focusedEntity===this._entity){this._highlighting=true}else{this._highlighting=false}this._updateState()};e.prototype._onMouseDown=function e(t){if(this.enabled===false){return}var n=this._widget.system;if(t.button==="left"){t.stop();if(n.focusedEntity!==this._entity){return}this._pressing=true;this._updateState()}};e.prototype._onMouseUp=function e(t){if(this.enabled===false){return}var n=this._widget.system;if(t.button==="left"){t.stop();if(n.focusedEntity!==this._entity){return}this.checked=!this.checked;this.dispatch("change");if(this._toggleGroupComp){this._toggleGroupComp._updateCheck(this)}this._pressing=false;this._updateState()}};e.prototype._onFocus=function e(){if(this.enabled===false){return}this._highlighting=true;this._updateState()};e.prototype._onBlur=function e(){if(this.enabled===false){return}this._fingerId=-1;this._highlighting=false;this._updateState()};e.prototype._onTouchEnter=function e(t){if(this.enabled===false){return}if(this._fingerId===t.id){t.stop();this._pressing=true;this._updateState()}};e.prototype._onTouchLeave=function e(t){if(this.enabled===false){return}t.stop();this._pressing=false;this._updateState()};e.prototype._onTouchStart=function e(t){if(this.enabled===false){return}t.stop();this._fingerId=t.id;this._pressing=true;this._updateState()};e.prototype._onTouchEnd=function e(t){if(this.enabled===false){return}t.stop();this._fingerId=-1;this._pressing=false;this._updateState();this.checked=!this.checked;this.dispatch("change");if(this._toggleGroupComp){this._toggleGroupComp._updateCheck(this)}};return e}(rm);Dm.events={mouseenter:"_onMouseEnter",mouseleave:"_onMouseLeave",mousedown:"_onMouseDown",mouseup:"_onMouseUp",focus:"_onFocus",blur:"_onBlur",touchenter:"_onTouchEnter",touchleave:"_onTouchLeave",touchstart:"_onTouchStart",touchend:"_onTouchEnd"};Dm.schema={checker:{type:"entity",default:null,set:function e(t){if(!(t instanceof ra)){return}if(this._checker===t){return}this._checker=t;if(this._checker){this._checkerImage=this._checker.getComp("Image");this._checkerImage.enabled=this._checked}}},checked:{type:"boolean",default:true,set:function e(t){if(this._checked===t){return}this._checked=t;if(this._checkerImage){this._checkerImage.enabled=this._checked}}},toggleGroup:{type:"entity",default:null,set:function e(t){if(!(t instanceof ra)){return}if(this._toggleGroup===t){return}this._toggleGroup=t;if(this._toggleGroupComp){this._toggleGroupComp._removeItem(this);this._toggleGroupComp=null}if(this._toggleGroup){this._toggleGroupComp=this._toggleGroup.getComp("ToggleGroup");if(this._toggleGroupComp){this._toggleGroupComp._addItem(this)}}}},transitionColors:{type:"object",default:{normal:Ft.create(),highlight:Ft.create(),pressed:Ft.create(),disabled:Ft.create()}},transitionSprites:{type:"object",parse:function e(t,n,r,i){if(n){var a={normal:null,highlight:null,pressed:null,disabled:null};if(n.normal&&typeof n.normal==="string"){a.normal=t.assets.get(n.normal)}if(n.highlight&&typeof n.highlight==="string"){a.highlight=t.assets.get(n.highlight)}if(n.pressed&&typeof n.pressed==="string"){a.pressed=t.assets.get(n.pressed)}if(n.disabled&&typeof n.disabled==="string"){a.disabled=t.assets.get(n.disabled)}return a}},default:{normal:null,highlight:null,pressed:null,disabled:null}},background:{type:"entity",default:null,set:function e(t){if(!(t instanceof ra)){return}if(this._background===t){return}this._background=t;if(this._background){this._bgImage=this._background.getComp("Image")}}},transition:{type:"enums",default:"none",options:["none","color","sprite"]}};var Fm=function(e){function t(){e.call(this);this._toggleItems=[];this._activeItem=null}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype._addItem=function e(t){if(this._toggleItems.indexOf(t)===-1){this._toggleItems.push(t);if(this._activeItem===null){if(t.checked){this._activeItem=t}}else{t.checked=false}}else{console.warn("toggle item already added into toggle groups")}};t.prototype._removeItem=function e(t){var n=this._toggleItems.indexOf(t);if(n===-1){console.warn("toggle item not exists in toggle groups")}else{if(this._activeItem===t){this._activeItem=null}this._toggleItems.splice(n,1)}};t.prototype._updateCheck=function e(t){var n=this._toggleItems.indexOf(t);if(n===-1){console.warn("toggle item not exists in toggle groups");return true}else{if(this._activeItem!==t){if(this._activeItem){this._activeItem.checked=false}this._activeItem=t}else{if(!this._allowSwitchOff){if(this._activeItem&&!this._activeItem.checked){this._activeItem.checked=true}}}}};return t}(rm);Fm.schema={allowSwitchOff:{type:"boolean",default:false}};var zm=function(r){function e(){var n=this;r.call(this);this._state="none";this._highlighting=false;this._pressing=false;this._widget=null;this._dragging=false;this._bgImage=null;this._calMinValue=0;this._calMaxValue=1;this._handleWidget=null;this._fillWidget=null;this._normalizedValue=0;this._fingerId=-1;this._onMouseEnter=function(e){if(n.enabled===false){return}var t=n._widget.system;n._highlighting=true;if(t.focusedEntity===n._entity&&e.buttons&1!==0){n._pressing=true}n._updateState()};this._onMouseLeave=function(e){if(n.enabled===false){return}var t=n._widget.system;n._pressing=false;if(t.focusedEntity&&t.focusedEntity===n._entity){n._highlighting=true}else{n._highlighting=false}n._updateState()};this._onMouseDown=function(e){if(n.enabled===false){return}var t=n._widget.system;if(e.button==="left"){e.stop();if(t.focusedEntity!==n._entity){return}n._pressing=true;n._updateState();if(!n._handle||e.target!==n._handle){n._updateDrag(Lt.new(e.mouseX,e.mouseY,0))}n._dragging=true}};this._onMouseMove=function(e){if(n.enabled===false){return}if(e.button===0){e.stop();if(n._dragging){n._updateDrag(Lt.new(e.mouseX,e.mouseY,0))}}};this._onMouseUp=function(e){if(n.enabled===false){return}if(e.button==="left"){e.stop();n._dragging=false;n._pressing=false;n._updateState()}};this._onTouchMove=function(e){if(n.enabled===false){return}e.stop();if(e.id===n._fingerId){if(n._dragging){n._updateDrag(Lt.new(e.x,e.y,0))}}};this._onTouchStart=function(e){if(n.enabled===false){return}e.stop();if(n._fingerId!==-1){return}n._fingerId=e.id;n._pressing=true;n._updateState();if(!n._handle||e.target!==n._handle){n._updateDrag(Lt.new(e.x,e.y,0))}n._dragging=true};this._onTouchEnd=function(e){if(n.enabled===false){return}e.stop();if(e.id!==n._fingerId){return}n._dragging=false;n._fingerId=-1;n._pressing=false;n._updateState()}}if(r)e.__proto__=r;e.prototype=Object.create(r&&r.prototype);e.prototype.constructor=e;e.prototype.onInit=function e(){r.prototype.onInit.call(this);this._widget=this._entity.getComp("Widget");this._widget.focusable=true;this._bgImage=this._background&&this._background.getComp("Image");if(!this._bgImage){this._bgImage=this._entity.getComp("Image")}this._fillWidget=this._fill&&this._fill.getComp("Widget");this._handleWidget=this._handle&&this._handle.getComp("Widget");this._calMinValue=this._minValue>this._maxValue?this._maxValue:this._minValue;this._calMaxValue=this._minValue>this._maxValue?this._minValue:this._maxValue;var t=0;if(this._value>0){t=(this._value-this._calMinValue)/(this._calMaxValue-this._calMinValue);t=Math.round(t*100)/100}this._normalizedValue=this._reverse?1-t:t;this._updateVisuals()};e.prototype.onDestroy=function e(){this._widget.focusable=false;r.prototype.onDestroy.call(this)};e.prototype._updateState=function e(){var t="normal";if(this._pressing){t="pressed"}else if(this._highlighting){t="highlight"}if(this._state===t){return}var n=this._state;this._state=t;this.dispatch("transition",{detail:{oldState:n,newState:this._state}});if(this._bgImage===null){return}if(this._transition==="none"){return}if(this._transition==="color"){this._bgImage.color=this._transitionColors[t]}else if(this._transition==="sprite"){this._bgImage.sprite=this._transitionSprites[t]}else{console.warn("Button transition animation is not implemented")}};e.prototype._set=function e(t){var n=He(t,this._calMinValue,this._calMaxValue);if(this._value!=n){this._value=n;this._updateVisuals();this._emitValueChangedEvents()}};e.prototype._updateDrag=function e(t){var n=this._handle?this._handleWidget:this._fillWidget;var r=n._entity.parent.getComp("Widget");if(r){var i=[Lt.zero(),Lt.zero(),Lt.zero(),Lt.zero()];r.getWorldCorners(i[0],i[1],i[2],i[3]);var a=i[1];var o=Lt.zero(),s=Lt.zero();var l=0,u=0;if(this._direction==="horizontal"){Lt.subtract(o,i[2],a);Lt.subtract(s,t,a);l=Lt.distance(i[2],a);this._normalizedValue=je(u/l)}else{Lt.subtract(o,i[0],a);Lt.subtract(s,t,a);l=Lt.distance(i[0],a)}u=Lt.dot(o,s)/l;this._normalizedValue=je(u/l);this._clampValue()}};e.prototype._updateVisuals=function e(){var t=[0,0];var n=[1,1];var r=this._direction==="horizontal"?0:1;if(this._fillWidget){var i=this._fill.getComp("Image");if(i){if(i.type==="filled"){i.filledStart=this._normalizedValue}else if(this._reverse){t[r]=this._normalizedValue}else{n[r]=this._normalizedValue}}this._fillWidget.setAnchors(t[0],t[1],n[0],n[1])}if(this._handleWidget){t=[0,0];n=[1,1];t[r]=this._normalizedValue;n[r]=this._normalizedValue;this._handleWidget.setAnchors(t[0],t[1],n[0],n[1])}};e.prototype._clampValue=function e(){this.value=(this._reverse?1-this._normalizedValue:this._normalizedValue)*(this._calMaxValue-this._calMinValue)};e.prototype._onFocus=function e(){if(this.enabled===false){return}this._highlighting=true;this._updateState()};e.prototype._onBlur=function e(){if(this.enabled===false){return}this._fingerId=-1;this._highlighting=false;this._updateState()};e.prototype._onTouchEnter=function e(t){if(this.enabled===false){return}if(this._fingerId!==-1&&this._fingerId===t.id){t.stop();this._pressing=true;this._updateState()}};e.prototype._onTouchLeave=function e(t){if(this.enabled===false){return}if(this._fingerId!==-1&&this._fingerId===t.id){t.stop();this._pressing=false;this._updateState()}};e.prototype._emitValueChangedEvents=function e(){this.dispatch("Slider.onValueChanged")};return e}(rm);zm.events={mouseenter:"_onMouseEnter",mouseleave:"_onMouseLeave",mousemove:"_onMouseMove",mousedown:"_onMouseDown",mouseup:"_onMouseUp",focus:"_onFocus",blur:"_onBlur",touchenter:"_onTouchEnter",touchleave:"_onTouchLeave",touchstart:"_onTouchStart",touchmove:"_onTouchMove",touchend:"_onTouchEnd"};zm.schema={handle:{type:"entity",default:null,set:function e(t){if(!(t instanceof ra)){return}if(this._handle===t){return}this._handle=t;if(this._handle){this._handleWidget=this._handle.getComp("Widget")}this._updateVisuals()}},fill:{type:"entity",default:null,set:function e(t){if(!(t instanceof ra)){return}if(this._fill===t){return}this._fill=t;if(this._fill){this._fillWidget=this._fill.getComp("Widget")}this._updateVisuals()}},direction:{type:"enums",default:"horizontal",options:["horizontal","vertical"]},reverse:{type:"boolean",default:false},minValue:{type:"number",default:0,set:function e(t){if(this._minValue===t){return}this._minValue=t;this._calMinValue=t;if(this._minValue>this._maxValue){this._calMinValue=this._maxValue;this._calMaxValue=this._minValue}}},maxValue:{type:"number",default:1,set:function e(t){if(this._maxValue===t){return}this._maxValue=t;this._calMaxValue=t;if(this._minValue>this._maxValue){this._calMinValue=this._maxValue;this._calMaxValue=this._minValue}}},value:{type:"number",default:0,set:function e(t){if(this._value===t){return}this._set(t,false)}},transitionColors:{type:"object",default:{normal:Ft.create(),highlight:Ft.create(),pressed:Ft.create(),disabled:Ft.create()}},transitionSprites:{type:"object",parse:function e(t,n,r,i){if(n){var a={normal:null,highlight:null,pressed:null,disabled:null};if(n.normal&&typeof n.normal==="string"){a.normal=t.assets.get(n.normal)}if(n.highlight&&typeof n.highlight==="string"){a.highlight=t.assets.get(n.highlight)}if(n.pressed&&typeof n.pressed==="string"){a.pressed=t.assets.get(n.pressed)}if(n.disabled&&typeof n.disabled==="string"){a.disabled=t.assets.get(n.disabled)}return a}},default:{normal:null,highlight:null,pressed:null,disabled:null}},background:{type:"entity",default:null,set:function e(t){if(!(t instanceof ra)){return}if(this._background===t){return}this._background=t;if(this._background){this._bgImage=this._background.getComp("Image")}}},transition:{type:"enums",default:"none",options:["none","color","sprite"]}};var Nm=function(t){function e(){var n=this;t.call(this);this._state="none";this._highlighting=false;this._pressing=false;this._widget=null;this._bgImage=null;this._textComp=null;this._placeHolderComp=null;this._activeDom=null;this._inputText="";this._placeHolderStr="";this._onMouseEnter=function(e){if(n.enabled===false){return}var t=n._widget.system;n._highlighting=true;if(t.focusedEntity===n._entity&&e.buttons&1!==0){n._pressing=true}n._updateState()};this._onMouseLeave=function(e){if(n.enabled===false){return}var t=n._widget.system;n._pressing=false;if(t.focusedEntity&&t.focusedEntity===n._entity){n._highlighting=true}else{n._highlighting=false}n._updateState()};this._onMouseDown=function(e){if(n.enabled===false){return}var t=n._widget.system;if(e.button==="left"){e.stop();if(t.focusedEntity!==n._entity){return}n._pressing=true;n._updateState();n._show()}};this._onMouseUp=function(e){if(n.enabled===false){return}if(e.button==="left"){e.stop();n._pressing=false;n._updateState()}};this._onTouchEnd=function(e){if(n.enabled===false){return}e.stop();n._pressing=false;n._updateState()}}if(t)e.__proto__=t;e.prototype=Object.create(t&&t.prototype);e.prototype.constructor=e;e.prototype.onInit=function e(){t.prototype.onInit.call(this);this._widget=this._entity.getComp("Widget");this._widget.focusable=true;this._bgImage=this._background&&this._background.getComp("Image");if(!this._bgImage){this._bgImage=this._entity.getComp("Image")}this._textComp=this._textEnt&&this._textEnt.getComp("Text");this._placeHolderComp=this._placeHolder&&this._placeHolder.getComp("Text");if(this._placeHolderComp){this._placeHolderStr=this._placeHolderComp.text}if(this._maxLength<=0){this._maxLength=ot}this._createDom(this._lineType==="single-line"?"input":"textarea")};e.prototype.onDestroy=function e(){this._widget.focusable=false;this._removeDom();t.prototype.onDestroy.call(this)};e.prototype._updateState=function e(){var t="normal";if(this._pressing){t="pressed"}else if(this._highlighting){t="highlight"}if(this._state===t){return}var n=this._state;this._state=t;this.dispatch("transition",{detail:{oldState:n,newState:this._state}});if(this._bgImage===null){return}if(this._transition==="none"){return}if(this._transition==="color"){this._bgImage.color=this._transitionColors[t]}else if(this._transition==="sprite"){this._bgImage.sprite=this._transitionSprites[t]}else{console.warn("Button transition animation is not implemented")}};e.prototype._createDom=function e(t){var n=this;this._removeDom();this._activeDom=document.createElement(t==="input"?"input":"textarea");var r=document.getElementById("view");r.appendChild(this._activeDom);this._activeDom.className="cocos3DEditBox";if(t==="input"){this._activeDom.type="text"}var i=this._activeDom.style;i.fontSize=this._fontSize+"px";i.color="#000000";i.border="0px";i.background="transparent";i.width="100%";i.height="100%";i.outline="medium";i.padding="0";i.textTransform="none";i.display="none";i.position="absolute";i.left="0px";i.bottom="0px";if(t==="textarea"){i.overflowY="scroll";i.resize="none"}this._activeDom.maxLength=this._maxLength;this._activeDom.addEventListener("input",function(){n._inputText=n._activeDom.value;n._emitValueChangedEvents()});this._activeDom.addEventListener("keypress",function(e){if(e.keyCode===13){if(n._returnKeyType==="new-line"&&n._lineType==="multi-line"){n._text+="\n"}else{if(n._returnKeyType==="submit"){n._emitSubmitEvents()}n._activeDom.blur()}}});this._activeDom.addEventListener("focus",function(){n._emitEditingBeginEvents()});this._activeDom.addEventListener("blur",function(){if(n._text!==n._inputText){n._dealText(n._inputText)}n._hidden();n._emitEditingEndEvents()})};e.prototype._removeDom=function e(){if(this._activeDom===null){return}var t=document.getElementById("view");if(t.contains(this._activeDom)){t.removeChild(this._activeDom)}this._activeDom=null};e.prototype._dealText=function e(t){var n=this;if(this._textComp===null){return}this._text="";if(this._lineType==="single-line"){t=t.replace("\n","")}var r=Math.min(t.length,this._maxLength);for(var i=0;i<r;++i){var a=n._checkChar(t[i],n._text.length,n._text);var o=!!a;if(o){n._text+=a}}this._inputText=this._text;if(this._contentType==="password"){this._text=this._text.replace(new RegExp(".+?","g"),"*")}this._switchState(this._text)};e.prototype._checkChar=function e(t,n,r){var i=false;if(this._contentType==="standard"){return t}if(this._contentType==="int-number"||this._contentType==="decimal-number"){i=new RegExp("[0-9]").test(t);if(i){return t}if(t==="-"){if(n===0){return t}}if(t==="."&&this._contentType==="decimal-number"&&this._text.indexOf(".")<0){return t}}else if(this._contentType==="alpha-number"){i=new RegExp("[0-9a-zA-Z]").test(t);if(i){return t}}else if(this._contentType==="caps-all"){return t.toUpperCase()}else if(this._contentType==="name"){i=new RegExp("[a-zA-Z]").test(t);if(i){i=new RegExp("[a-z]").test(t);if(i){if(n===0||r[n-1]===" "){return t.toUpperCase()}}else{if(n>0&&r[n-1]!==" "){return t.toLowerCase()}}return t}else{if(t===" "&&n>0){if(r[n-1]!==" "){return t}}}}else if(this._contentType==="email"){i=new RegExp("[0-9a-zA-Z]").test(t);if(i){return t}if(t==="@"&&this._text.indexOf("@")===-1){return t}var a="!#$%&'*+-/=?^_`{}|~";if(a.indexOf(t)!==-1){return t}if(t==="."){if(n>0&&r[n-1]!=="."){return t}}}else{return t}return""};e.prototype._show=function e(){if(this._activeDom===null){return}var t=this._textComp.entity.getComp("Widget");this._activeDom.style.width=t._rect.w+"px";this._activeDom.style.height=t._rect.h+"px";this._activeDom.style.display="";this._activeDom.focus();this._activeDom.value=this._text;this._textComp.text="";var n=this._textComp.align.indexOf("middle");if(n===-1){var r=this._textComp.align.split("-");this._textComp.align="middle-"+r[1]}this._updateMatrix();if(this._placeHolderComp){this._placeHolderComp.text="";n=this._placeHolderComp.align.indexOf("middle");if(n===-1){var i=this._placeHolderComp.align.split("-");this._placeHolderComp.align="middle-"+i[1]}}};e.prototype._updateMatrix=function e(){var t=this._textComp.entity.getComp("Widget");var n=[Lt.zero(),Lt.zero(),Lt.zero(),Lt.zero()];t.getWorldCorners(n[0],n[1],n[2],n[3]);var r=this._entity.getWorldRot(It.create());var i=-It.getAxisAngle(Lt.new(0,0,1),r);this._activeDom.style.transformOrigin="bottom left";var a={a:Math.cos(i),b:Math.sin(i),c:-Math.sin(i),d:Math.cos(i),tx:n[1].x,ty:-n[1].y};var o="matrix("+a.a+", "+a.b+", "+a.c+", "+a.d+", "+a.tx+", "+a.ty+")";this._activeDom.style.transform=o};e.prototype._hidden=function e(){this._activeDom.style.display="none";this._switchState(this._text)};e.prototype._switchState=function e(t){this._textComp.text=t;if(this._placeHolderComp){this._placeHolderComp.text=this._text.length<=0?this._placeHolderStr:""}};e.prototype._contentTypeChanged=function e(){this._activeDom.style.textTransform="none";if(this._contentType==="int-number"||this._contentType==="decimal-number"){this._activeDom.type="number"}else if(this._contentType==="email"){this._activeDom.type=="email"}else if(this._contentType==="password"){this._activeDom.type="password"}else if(this._contentType==="name"){this._activeDom.style.textTransform="capitalize"}else if(this._contentType==="caps-all"){this._activeDom.style.textTransform="uppercase"}else{this._activeDom.type="text"}};e.prototype._lineTypeChanged=function e(){this._createDom(this._lineType==="single-line"?"input":"textarea")};e.prototype.changedPlaceHolder=function e(t){if(this._placeHolderStr===t){return}this._placeHolderStr=t;if(this._text.length<=0){if(this._placeHolderComp){this._placeHolderComp.text=this._placeHolderStr}}};e.prototype._onFocus=function e(){if(this.enabled===false){return}this._highlighting=true;this._updateState()};e.prototype._onBlur=function e(){if(this._entity.enabledInHierarchy===false){return}this._fingerId=-1;this._highlighting=false;this._updateState();if(this._activeDom&&this._activeDom===document.activeElement){this._activeDom.blur()}};e.prototype._onTouchEnter=function e(t){if(this.enabled===false){return}if(this._fingerId===t.id){t.stop();this._pressing=true;this._updateState()}};e.prototype._onTouchLeave=function e(t){if(this.enabled===false){return}t.stop();this._pressing=false;this._updateState()};e.prototype._onTouchStart=function e(t){if(this.enabled===false){return}t.stop();this._fingerId=t.id;this._pressing=true;this._updateState();this._show()};e.prototype._emitEditingBeginEvents=function e(){this.dispatch("EditBox.onEditingBegin")};e.prototype._emitEditingEndEvents=function e(){this.dispatch("EditBox.onEditingEnd")};e.prototype._emitValueChangedEvents=function e(){this.dispatch("EditBox.onValueChanged")};e.prototype._emitSubmitEvents=function e(){this.dispatch("EditBox.onSubmit")};return e}(rm);Nm.events={mouseenter:"_onMouseEnter",mouseleave:"_onMouseLeave",mousedown:"_onMouseDown",mouseup:"_onMouseUp",focus:"_onFocus",blur:"_onBlur",touchenter:"_onTouchEnter",touchleave:"_onTouchLeave",touchstart:"_onTouchStart",touchend:"_onTouchEnd"};Nm.schema={textEnt:{type:"entity",default:null,set:function e(t){if(!(t instanceof ra)){return}if(this._textEnt===t){return}this._textEnt=t;if(!this._textEnt){console.warn("Text component cannot be null")}if(this._textEnt){this._textComp=this._textEnt.getComp("Text")}}},placeHolder:{type:"entity",default:null,set:function e(t){if(!(t instanceof ra)){return}if(this._placeHolder===t){return}this._placeHolder=t;if(this._placeHolder){this._placeHolderComp=this._placeHolder.getComp("Text");if(this._placeHolderComp){this._placeHolderStr=this._placeHolderComp.text}}}},text:{type:"string",default:"",set:function e(t){t=!t?"":t;if(this._text===t){return}this._dealText(t)}},contentType:{type:"enums",default:"standard",options:["standard","int-number","decimal-number","alpha-number","caps-all","name","email","password"],set:function e(t){if(this._contentType===t){return}this._contentType=t;this._contentTypeChanged()}},lineType:{type:"enums",default:"single-line",options:["single-line","multi-line"],set:function e(t){if(this._lineType===t){return}this._lineType=t;this._lineTypeChanged()}},returnKeyType:{type:"enums",default:"none",options:["none","submit","new-line"]},maxLength:{type:"number",default:ot,set:function e(t){if(this._maxLength===t){return}this._maxLength=t;if(this._maxLength<=0){this._maxLength=ot}}},fontSize:{type:"number",default:29},transitionColors:{type:"object",default:{normal:Ft.create(),highlight:Ft.create(),pressed:Ft.create(),disabled:Ft.create()}},transitionSprites:{type:"object",parse:function e(t,n,r,i){if(n){var a={normal:null,highlight:null,pressed:null,disabled:null};if(n.normal&&typeof n.normal==="string"){a.normal=t.assets.get(n.normal)}if(n.highlight&&typeof n.highlight==="string"){a.highlight=t.assets.get(n.highlight)}if(n.pressed&&typeof n.pressed==="string"){a.pressed=t.assets.get(n.pressed)}if(n.disabled&&typeof n.disabled==="string"){a.disabled=t.assets.get(n.disabled)}return a}},default:{normal:null,highlight:null,pressed:null,disabled:null}},background:{type:"entity",default:null,set:function e(t){if(!(t instanceof ra)){return}if(this._background===t){return}this._background=t;if(this._background){this._bgImage=this._background.getComp("Image")}}},transition:{type:"enums",default:"none",options:["none","color","sprite"],set:function e(t){if(this._transition!==t){this._transition=t}}}};var km=function(t){function e(){var n=this;t.call(this);this._state="none";this._highlighting=false;this._pressing=false;this._widget=null;this._dragging=false;this._handleWidget=null;this._startDistance=0;this._fingerId=-1;this._onMouseEnter=function(e){if(n.enabled===false){return}var t=n._widget.system;n._highlighting=true;if(t.focusedEntity===n._entity&&e.buttons&1!==0){n._pressing=true}n._updateState()};this._onMouseLeave=function(){if(n.enabled===false){return}var e=n._widget.system;n._pressing=false;if(e.focusedEntity&&e.focusedEntity===n._entity){n._highlighting=true}else{n._highlighting=false}n._updateState()};this._onMouseDown=function(e){if(n.enabled===false){return}var t=n._widget.system;if(e.button==="left"){e.stop();if(t.focusedEntity!==n._entity){return}n._pressing=true;n._updateState();if(e.target!==n._handle){if(!n._dragging){n._dragging=true;n._updateValue(Rt.new(e.mouseX,e.mouseY),true)}}else{n._dragging=true;n._startDistance=n._startOffset(Rt.new(e.mouseX,e.mouseY))}}};this._onMouseMove=function(e){if(n.enabled===false){return}if(e.button===0){e.stop();if(n._dragging){n._updateValue(Lt.new(e.mouseX,e.mouseY,0))}}};this._onMouseUp=function(e){if(n.enabled===false){return}if(e.button==="left"){e.stop();n._dragging=false;n._pressing=false;n._updateState()}};this._onTouchStart=function(e){if(n.enabled===false){return}e.stop();if(n._fingerId!==-1){return}n._fingerId=e.id;n._pressing=true;n._updateState();n._startPos=Lt.new(e.x,e.y,0);n._offsetValue=0;if(e.target!==n._handle){if(!n._dragging){n._dragging=true;n._clkBar(Lt.new(e.x,e.y,0),true)}}else{n._dragging=true;n._startDistance=n._startOffset(Rt.new(e.x,e.y))}};this._onTouchMove=function(e){if(n.enabled===false){return}e.stop();if(e.id===n._fingerId){if(n._dragging){n._updateValue(Lt.new(e.x,e.y,0))}}};this._onTouchEnd=function(e){if(n.enabled===false){return}e.stop();if(e.id!==n._fingerId){return}n._dragging=false;n._fingerId=-1;n._pressing=false;n._updateState()}}if(t)e.__proto__=t;e.prototype=Object.create(t&&t.prototype);e.prototype.constructor=e;e.prototype.onInit=function e(){this._widget=this._entity.getComp("Widget");this._widget.focusable=true;this._bgImage=this._background&&this._background.getComp("Image");if(!this._bgImage){this._bgImage=this._entity.getComp("Image")}this._handleWidget=this._handle&&this._handle.getComp("Widget");t.prototype.onInit.call(this)};e.prototype.onEnable=function e(){this._updateHandle()};e.prototype.onDestroy=function e(){this._widget.focusable=false;t.prototype.onDestroy.call(this)};e.prototype._updateState=function e(){var t="normal";if(this._pressing){t="pressed"}else if(this._highlighting){t="highlight"}if(this._state===t){return}var n=this._state;this._state=t;this.dispatch("transition",{detail:{oldState:n,newState:this._state}});if(this._background===null){return}if(this._transition==="none"){return}if(this._transition==="color"){this._background.color=this._transitionColors[t]}else if(this._transition==="sprite"){this._background.sprite=this._transitionSprites[t]}else{console.warn("Button transition animation is not implemented")}};e.prototype._set=function e(t){var n=this._value;if(t===n){return}this._value=je(t);this._emitValueChangedEvents()};e.prototype._updateValue=function e(t,n){if(n===void 0)n=false;if(!this._handle||!this._handle){return}var r=this._getCalculateWidget();var i=[Lt.zero(),Lt.zero(),Lt.zero(),Lt.zero()];r.getWorldCorners(i[0],i[1],i[2],i[3]);var a=Rt.new(i[1].x,i[1].y);var o=Rt.zero(),s=Rt.zero();var l=this._direction==="horizontal"?Rt.new(i[2].x,i[2].y):Rt.new(i[0].x,i[0].y);Rt.subtract(o,l,a);Rt.subtract(s,t,a);var u=[r._rect.w*this._size/2,r._rect.h*this._size/2];var h=Rt.dot(o,s)/(this._direction==="horizontal"?r._rect.w:r._rect.h);if(this._direction==="horizontal"){h-=u[0]+(n?0:this._startDistance);h=je(h/(r._rect.w*(1-this._size)))}else{h-=u[1]+(n?0:this._startDistance);h=je(h/(r._rect.h*(1-this._size)))}this.value=this._reverse?1-h:h};e.prototype._startOffset=function e(t){var n=[Lt.zero(),Lt.zero(),Lt.zero(),Lt.zero()];var r=this._getCalculateWidget();r.getWorldCorners(n[0],n[1],n[2],n[3]);var i=Lt.zero();if(this._direction==="horizontal"){Lt.subtract(i,n[2],n[1])}else{Lt.subtract(i,n[3],n[2])}var a=[Lt.zero(),Lt.zero(),Lt.zero(),Lt.zero()];this._handleWidget.getWorldCorners(a[0],a[1],a[2],a[3]);var o=Lt.zero(),s=Rt.zero();Lt.add(o,a[3],a[1]);Lt.divide(o,o,Lt.new(2,2,2));Rt.subtract(s,t,Rt.new(o.x,o.y));var l=Rt.dot(s,Rt.new(i.x,i.y))/(this._direction==="horizontal"?r._rect.w:r._rect.h);return l};e.prototype._updateHandle=function e(){if(!this._handle||!this._handleWidget){return}var t={0:0,1:0};var n={0:1,1:1};var r=this._value*(1-this._size);r=Math.round(parseFloat(r)*100)/100;var i=this._direction==="horizontal"?0:1;if(this._reverse){t[i]=1-r-this._size;n[i]=1-r}else{t[i]=r;n[i]=r+this._size}this._handleWidget.setAnchors(t[0],t[1],n[0],n[1])};e.prototype._getCalculateWidget=function e(){return this._handle&&this._handle.parent.getComp("Widget")};e.prototype._onFocus=function e(){if(this.enabled===false){return}this._highlighting=true;this._updateState()};e.prototype._onBlur=function e(){if(this.enabled===false){return}this._fingerId=-1;this._highlighting=false;this._updateState()};e.prototype._onTouchEnter=function e(t){if(this.enabled===false){return}if(this._fingerId!==-1&&this._fingerId===t.id){t.stop();this._pressing=true;this._updateState()}};e.prototype._onTouchLeave=function e(t){if(this.enabled===false){return}if(this._fingerId!==-1&&this._fingerId===t.id){t.stop();this._pressing=false;this._updateState()}};e.prototype._emitValueChangedEvents=function e(){this.dispatch("ScrollBar.onValueChanged")};return e}(rm);km.events={mouseenter:"_onMouseEnter",mouseleave:"_onMouseLeave",mousedown:"_onMouseDown",mousemove:"_onMouseMove",mouseup:"_onMouseUp",focus:"_onFocus",blur:"_onBlur",touchenter:"_onTouchEnter",touchleave:"_onTouchLeave",touchstart:"_onTouchStart",touchmove:"_onTouchMove",touchend:"_onTouchEnd"};km.schema={direction:{type:"enums",default:"horizontal",options:["horizontal","vertical"],set:function e(t){if(t===this._direction){return}this._direction=t}},size:{type:"number",default:0,set:function e(t){if(this._size===t){return}this._size=je(t);this._updateHandle()}},value:{type:"number",default:0,set:function e(t){if(this._value===t){return}this._set(t);this._updateHandle()}},reverse:{type:"boolean",default:false},handle:{type:"entity",default:null,set:function e(t){if(!(t instanceof ra)){return}if(this._handle===t){return}this._handle=t;if(this._handle){this._handleWidget=this._handle.getComp("Widget")}}},transitionColors:{type:"object",default:{normal:Ft.create(),highlight:Ft.create(),pressed:Ft.create(),disabled:Ft.create()}},transitionSprites:{type:"object",parse:function e(t,n,r,i){if(n){var a={normal:null,highlight:null,pressed:null,disabled:null};if(n.normal&&typeof n.normal==="string"){a.normal=t.assets.get(n.normal)}if(n.highlight&&typeof n.highlight==="string"){a.highlight=t.assets.get(n.highlight)}if(n.pressed&&typeof n.pressed==="string"){a.pressed=t.assets.get(n.pressed)}if(n.disabled&&typeof n.disabled==="string"){a.disabled=t.assets.get(n.disabled)}return a}},default:{normal:null,highlight:null,pressed:null,disabled:null}},background:{type:"entity",default:null,set:function e(t){if(!(t instanceof ra)){return}if(this._background===t){return}this._background=t;if(this._background){this._bgImage=this._background.getComp("Image")}}},transition:{type:"enums",default:"none",options:["none","color","sprite"]}};var Vm=function e(t,n){this._center=Lt.zero();Lt.copy(this._center,t);this._extents=Lt.zero();Lt.mul(this._extents,n,Lt.new(.5,.5,.5));this._size=Lt.zero();this._min=Lt.zero();this._max=Lt.zero()};var Wm={center:{configurable:true},size:{configurable:true},min:{configurable:true},max:{configurable:true}};Wm.center.set=function(e){this._center=e};Wm.center.get=function(){return this._center};Wm.size.set=function(e){Lt.mul(this._extents,e,Lt.new(.5,.5,.5))};Wm.size.get=function(){var e=Lt.zero();Lt.mul(e,this._extents,Lt.new(2,2,2));return e};Wm.min.set=function(e){this.setMinMax(e,this._max)};Wm.min.get=function(){var e=Lt.zero();Lt.subtract(e,this._center,this._extents);return e};Wm.max.set=function(e){this.setMinMax(this._min,e)};Wm.max.get=function(){var e=Lt.zero();Lt.add(e,this._center,this._extents);return e};Vm.prototype.setMinMax=function e(t,n){var r=Lt.zero();Lt.subtract(r,n,t);Lt.mul(r,r,Lt.new(.5,.5,.5));Lt.set(this._extents,r.x,r.y,r.z);Lt.add(this._center,t,this._extents)};Vm.prototype.encapsulate=function e(t){var n=Lt.zero(),r=Lt.zero();Lt.min(n,this.min,t);Lt.max(r,this.max,t);this.setMinMax(n,r)};Object.defineProperties(Vm.prototype,Wm);var Gm=function(t){function e(){var l=this;t.call(this);this._widget=null;this._viewBound=null;this._contentBound=null;this._contentWidget=null;this._viewPortWidget=null;this._hScrollBarComp=null;this._vScrollBarComp=null;this._dragging=false;this._velocity=Rt.zero();this._startPos=Rt.zero();this._startPoint=Rt.zero();this._fingerId=-1;this._correctInited=false;this._lastContentBound=null;this._lastViewBound=null;this._lastPosition=Rt.zero();this._onMouseDown=function(e){if(l.enabled===false){return}e.stop();l._dragging=true;l._startPos=Rt.new(l._contentWidget.offsetX,l._contentWidget.offsetY);l._startPoint=Rt.new(e.mouseX,e.mouseY)};this._onMouseUp=function(e){if(l.enabled===false){return}e.stop();l._dragging=false};this._onMouseMove=function(e){if(l.enabled===false){return}e.stop();if(l._dragging){l._onDrag(Rt.new(e.mouseX,e.mouseY))}};this._onTouchStart=function(e){if(l.enabled===false){return}e.stop();if(l._fingerId!==-1){return}l._fingerId=e.id;l._dragging=true;l._startPos=Rt.new(l._contentWidget.offsetX,l._contentWidget.offsetY);l._startPoint=Rt.new(e.x,e.y)};this._onTouchMove=function(e){if(l.enabled===false){return}e.stop();if(e.id===l._fingerId){if(l._dragging){l._onDrag(Rt.new(e.x,e.y))}}};this._onTouchEnd=function(e){if(l.enabled===false){return}e.stop();if(e.id!==l._fingerId){return}l._fingerId=-1;l._dragging=false};this._updateScrollView=function(e){if(e.component._dragging===false){return}l._updateBound();var t=e.component.reverse?1-e.component.value:e.component.value;if(e.component.direction==="horizontal"){var n=l._contentBound.size.x-l._viewBound.size.x;var r=n*t;var i=l._viewBound.min.x-l._contentBound.min.x;l._contentWidget.offsetX+=i-r}else{var a=l._contentBound.size.y-l._viewBound.size.y;var o=a*t;var s=l._viewBound.min.y-l._contentBound.min.y;l._contentWidget.offsetY+=s-o}l._updateBound()}}if(t)e.__proto__=t;e.prototype=Object.create(t&&t.prototype);e.prototype.constructor=e;e.prototype.onInit=function e(){t.prototype.onInit.call(this);this._widget=this._entity.getComp("Widget");this._viewPortWidget=this._viewPort&&this._viewPort.getComp("Widget");this._contentWidget=this._content&&this._content.getComp("Widget");if(this._vScrollBarComp){this._vScrollBar.off("ScrollBar.onValueChanged",this._updateScrollView)}this._vScrollBarComp=this._vScrollBar&&this._vScrollBar.getComp("ScrollBar");if(this._vScrollBarComp){this._vScrollBar._reverse=true;this._vScrollBar.on("ScrollBar.onValueChanged",this._updateScrollView)}if(this._hScrollBarComp){this._hScrollBar.off("ScrollBar.onValueChanged",this._updateScrollView)}this._hScrollBarComp=this._hScrollBar&&this._hScrollBar.getComp("ScrollBar");if(this._hScrollBarComp){this._hScrollBar.on("ScrollBar.onValueChanged",this._updateScrollView)}};e.prototype.onDestroy=function e(){this._vScrollBar._entity.off("ScrollBar.onValueChanged",this._updateScrollView);this._hScrollBar._entity.off("ScrollBar.onValueChanged",this._updateScrollView);t.prototype.onDestroy.call(this)};e.prototype.tick=function e(){if(this._viewPortWidget){if(this._viewPortWidget.anchorLeft!==0||this._viewPortWidget.anchorRight!==1||this._viewPortWidget.anchorBottom!==0||this._viewPortWidget.anchorTop!==1){this._viewPortWidget.setAnchors(0,0,1,1)}}if(this._correctInited===false){this._correctVisual()}};e.prototype._correctVisual=function e(){this._getBound();if(this._viewBound&&!Lt.equals(this._viewBound.size,Lt.zero())&&this._contentBound&&!Lt.equals(this._contentBound.size,Lt.zero())){this._correctInited=true;if(this._viewBound.size.x>=this._contentBound.size.x){if(this._hScrollBar&&this._hScrollBar.active){this._hScrollBar.active=false}if(this._viewPortWidget){this._viewPortWidget.offsetY=0;this._viewPortWidget.sizeY=0}}else{if(this._hScrollBar){if(this._hScrollBar.active===false){this._hScrollBar.active=true}var t=this._hScrollBar.getComp("Widget");if(this._viewPortWidget){this._viewPortWidget.offsetY=t._rect.h*(1-this._viewPortWidget.pivotY);this._viewPortWidget.sizeY=-t._rect.h}t.setAnchors(0,0,1,0);if(this._vScrollBar){if(this._vScrollBar.active){var n=this._vScrollBar.getComp("Widget");t.sizeX=-n._rect.w;t.offsetX=-n._rect.w*t.pivotX}else{t.sizeX=0;t.offsetX=0}}}}if(this._viewBound.size.y>=this._contentBound.size.y){if(this._vScrollBar&&this._vScrollBar.active){this._vScrollBar.active=false}if(this._viewPortWidget){this._viewPortWidget.offsetX=0;this._viewPortWidget.sizeX=0}}else{if(this._vScrollBar){if(this._vScrollBar.active===false){this._vScrollBar.active=true}var r=this._vScrollBar.getComp("Widget");if(this._viewPortWidget){this._viewPortWidget.offsetX=-r._rect.w*this._viewPortWidget.pivotX;this._viewPortWidget.sizeX=-r._rect.w}r.setAnchors(1,0,1,1);if(this._hScrollBar){if(this._hScrollBar.active){var i=this._hScrollBar.getComp("Widget");r.sizeY=-i._rect.h;r.offsetY=i._rect.h*(1-r.pivotY)}else{r.sizeY=0;r.offsetY=0}}}}}};e.prototype.postTick=function e(){this._lateUpdate()};e.prototype._onDrag=function e(t){if(!this._contentWidget){return}this._updateBound();var n=Rt.zero(),r=Rt.zero();Rt.subtract(n,t,this._startPoint);Rt.add(r,n,this._startPos);Rt.subtract(n,r,Rt.new(this._contentWidget.offsetX,this._contentWidget.offsetY));var i=this._calculateOffset(n);Rt.add(r,r,i);var a=[r.x,r.y];if(this._movementType=="elastic"){var o=this._viewBound.size;if(i.x!==0){a[0]-=(1-1/(Math.abs(i.x)*.5/o.x+1))*o.x*this._sign(i.x)}if(i.y!==0){a[1]-=(1-1/(Math.abs(i.y)*.5/o.y+1))*o.y*this._sign(i.y)}}this._setContentOffset(Rt.new(a[0],a[1]))};e.prototype._sign=function e(t){if(t>=0){return 1}return-1};e.prototype._getBound=function e(){if(!this._contentWidget){return new Vm(Lt.zero(),Lt.zero())}var t=[Lt.zero(),Lt.zero(),Lt.zero(),Lt.zero()];this._viewPortWidget.getWorldCorners(t[0],t[1],t[2],t[3]);var n=Lt.zero();Lt.add(n,t[0],t[2]);Lt.divide(n,n,Lt.new(2,2,2));var r=this._viewPortWidget._rect;this._viewBound=new Vm(n,Lt.new(r.w,r.h,0));var i=[Lt.zero(),Lt.zero(),Lt.zero(),Lt.zero()];this._contentWidget.getWorldCorners(i[0],i[1],i[2],i[3]);var a=Lt.new(34e37,34e37,34e37);var o=Lt.new(-34e37,-34e37,-34e37);for(var s=0;s<4;s++){Lt.min(a,a,i[s]);Lt.max(o,o,i[s])}this._contentBound=new Vm(a,Lt.zero());this._contentBound.encapsulate(o)};e.prototype._adjustBound=function e(t,n){var r=[t.x,t.y];var i=[n.x,n.y];var a=Lt.zero();Lt.subtract(a,this._viewBound.size,this._contentBound.size);if(a.x>0){i[0]-=a.x*(this._contentWidget.pivotX-.5);r[0]=this._viewBound.size.x}if(a.y>0){i[1]-=a.y*(this._contentWidget.pivotY-.5);r[1]=this._viewBound.size.y}t=Lt.new(r[0],r[1],0);n=Lt.new(i[0],i[1],0)};e.prototype._updateBound=function e(){this._getBound();if(!this._contentWidget){return}this._adjustBound(this._contentBound.size,this._contentBound.center);if(this._movementType==="clamp"){var t=[0,0];if(this._viewBound.max.x>this._contentBound.max.y){t[0]=Math.min(this._viewBound.max.x-this._contentBound.max.x,this._viewBound.min.x-this._contentBound.min.x)}else if(this._viewBound.min.x<this._contentBound.min.x){t[0]=Math.max(this._viewBound.max.x-this._contentBound.max.x,this._viewBound.min.x-this._contentBound.min.x)}if(this._viewBound.max.y>this._contentBound.max.y){t[1]=Math.min(this._viewBound.max.y-this._contentBound.max.y,this._viewBound.min.y-this._contentBound.min.y)}else if(this._viewBound.min.y<this._contentBound.min.y){t[1]=Math.max(this._viewBound.max.y-this._contentBound.max.y,this._viewBound.min.y-this._contentBound.min.y)}if(!Rt.equals(Rt.new(t[0],t[1]),Rt.zero())){var n=[];n[0]=this._contentWidget.offsetX+t[0];n[1]=this._contentWidget.offsetY+t[1];if(!this._horizontal){n[0]=this._contentWidget.offsetX}if(!this._vertical){n[1]=this._contentWidget.offsetX}this._setContentOffset(Rt.new(n[0],n[1]))}}};e.prototype._calculateOffset=function e(t){var n=[0,0];if(this._movementType==="unrestricted"){return Rt.zero()}else{var r=[this._contentBound.min.x,this._contentBound.min.y];var i=[this._contentBound.max.x,this._contentBound.max.y];if(this._horizontal){r[0]+=t.x;i[0]+=t.x;if(r[0]>this._viewBound.min.x){n[0]=this._viewBound.min.x-r[0]}else if(i[0]<this._viewBound.max.x){n[0]=this._viewBound.max.x-i[0]}}if(this._vertical){r[1]+=t.y;i[1]+=t.y;if(r[1]>this._viewBound.min.y){n[1]=this._viewBound.min.y-r[1]}else if(i[1]<this._viewBound.max.y){n[1]=this._viewBound.max.y-i[1]}}}return Rt.new(n[0],n[1])};e.prototype._lateUpdate=function e(){var t=this;if(!this._contentWidget){return}this._getBound();var n=this._calculateOffset(Rt.zero());var r=!Rt.equals(n,Rt.zero());var i=!Rt.equals(this._velocity,Rt.zero());if(!this._dragging&&(r||i)){var a=[this._contentWidget.offsetX,this._contentWidget.offsetY];var o=[n.x,n.y];var s=[this._velocity.x,this._velocity.y];for(var l=0;l<2;l++){if(t._movementType==="elastic"&&o[l]!==0){var u=t._smoothBack(a[l],a[l]+o[l],s[l]);a[l]=u.value;s[l]=u.velocity;if(Math.abs(s[l])<1){s[l]=0}}else if(t._inertia){s[l]=s[l]*Math.pow(t._brake,t._app.deltaTime);if(Math.abs(s[l])<1){s[l]=0}a[l]+=s[l]*t._app.deltaTime}else{s[l]=0}}this._velocity=Rt.new(s[0],s[1]);if(!Rt.equals(this._velocity,Rt.zero())){if(this._movementType==="clamped"){var h=Rt.zero();Rt.subtract(h,Rt.new(a[0],a[1]),Rt.new(this._contentWidget.offsetX,this._contentWidget.offsetY));n=this._calculateOffset(h);a[0]+=n.x;a[1]+=n.y}this._setContentOffset(Rt.new(a[0],a[1]))}else if(!Rt.equals(n,Rt.zero())){this._setContentOffset(Rt.new(a[0]+n.x,a[1]+n.y))}}var c=Rt.new(this._contentWidget.offsetX,this._contentWidget.offsetY);if(this._dragging&&this._inertia){var f=Rt.zero();Rt.subtract(f,c,this._lastPosition);Rt.divide(f,f,Rt.new(this._app.deltaTime,this._app.deltaTime));Rt.lerp(this._velocity,this._velocity,f,this._app.deltaTime*10)}if(this._lastPosition.x-c.x>.01||this._lastPosition.y-c.y>.01||!this._isSameBound(this._viewBound,this._lastViewBound)||!this._isSameBound(this._contentBound,this._lastContentBound)){this._updateScrollBar();this._emitValueChangedEvents();this._updatePrevData()}};e.prototype._isSameBound=function e(t,n){if(t&&n){if(!Lt.equals(t.center,n.center)||!Lt.equals(t.size,n.size)){return false}return true}return false};e.prototype._smoothBack=function e(t,n,r){var i=this._app.deltaTime;this._elasticityDuration=Math.max(1e-4,this._elasticityDuration);var a=2/this._elasticityDuration;var o=a*i;var s=1/(1+o+.48*Math.pow(o,2)+.235*Math.pow(o,3));var l=t-n;var u=n;var h=ot*this._elasticityDuration;l=He(l,-h,h);n=t-l;var c=(r+a*l)*i;r=(r-a*c)*s;var f=n+(l+c)*s;if(u-t>0===f>u){f=u;r=(f-u)/i}return{value:f,velocity:r}};e.prototype._setContentOffset=function e(t){var n=[t.x,t.y];if(!this._contentWidget){return}if(!this._horizontal){n[0]=this._contentWidget.offsetX}if(!this._vertical){n[1]=this._contentWidget.offsetY}if(!Rt.equals(t,Rt.new(this._contentWidget.offsetX,this._contentWidget.offsetY))){this._contentWidget.setOffset(n[0],n[1]);this._updateBound()}};e.prototype._updatePrevData=function e(){Rt.set(this._lastPosition,this._contentWidget.offsetX,this._contentWidget.offsetY);this._lastContentBound=this._contentBound;this._lastViewBound=this._viewBound};e.prototype._updateScrollBar=function e(){var t=this._calculateOffset(Rt.zero());if(this._hScrollBarComp&&this._hScrollBar.active&&this._hScrollBarComp.handle){this._hScrollBarComp.size=je(this._viewBound.size.x/(this._contentBound.size.x+Math.abs(t.x)));if(this._contentBound.size.x<=this._viewBound.size.x){this._hScrollBarComp.value=this._viewBound.min.x<=this._contentBound.min.x?0:1}else{var n=(this._viewBound.min.x-this._contentBound.min.x)/(this._contentBound.size.x-this._viewBound.size.x);this._hScrollBarComp.value=this._hScrollBarComp.reverse?1-je(n,0,1):je(n,0,1)}}if(this._vScrollBarComp&&this._vScrollBar.active&&this._vScrollBarComp.handle){this._vScrollBarComp.size=je(this._viewBound.size.y/(this._contentBound.size.y+Math.abs(t.y)));if(this._contentBound.size.y<=this._viewBound.size.y){this._vScrollBarComp.value=this._viewBound.min.x<=this._contentBound.min.x?0:1}else{var r=(this._viewBound.min.y-this._contentBound.min.y)/(this._contentBound.size.y-this._viewBound.size.y);this._vScrollBarComp.value=this._vScrollBarComp.reverse?1-je(r,0,1):je(r,0,1)}}};e.prototype._emitValueChangedEvents=function e(){this.dispatch("ScrollView.onValueChanged")};return e}(rm);Gm.events={mousedown:"_onMouseDown",mousemove:"_onMouseMove",mouseup:"_onMouseUp",touchstart:"_onTouchStart",touchmove:"_onTouchMove",touchend:"_onTouchEnd"};Gm.schema={horizontal:{type:"boolean",default:true},vertical:{type:"boolean",default:true},viewPort:{type:"entity",default:null,set:function e(t){if(!(t instanceof ra)){return}if(this._viewPort===t){return}this._viewPort=t;if(!this._viewPort){console.warn("ViewPort cannot be null")}if(this._viewPort){this._viewPortWidget=this._viewPort.getComp("Widget")}}},content:{type:"entity",default:null,set:function e(t){if(!(t instanceof ra)){return}if(this._content===t){return}this._content=t;if(!this._content){console.warn("Content cannot be null");return}if(this._content){this._contentWidget=this._content.getComp("Widget")}}},movementType:{type:"enums",default:"clamped",options:["unrestricted","elastic","clamped"]},elasticityDuration:{type:"number",default:.1},inertia:{type:"boolean",default:true},brake:{type:"number",default:.135},vScrollBar:{type:"entity",default:null,set:function e(t){if(!(t instanceof ra)){return}if(this._vScrollBar===t){return}if(this._vScrollBarComp){this._vScrollBar.off("ScrollBar.onValueChanged",this._updateScrollView)}this._vScrollBar=t;if(this._vScrollBar){this._vScrollBar.on("ScrollBar.onValueChanged",this._updateScrollView);this._vScrollBarComp=this._vScrollBar.getComp("ScrollBar");this._vScrollBarComp.reverse=true;this._correctVisual()}}},hScrollBar:{type:"entity",default:null,set:function e(t){if(!(t instanceof ra)){return}if(this._hScrollBar===t){return}if(this._hScrollBarComp){this._hScrollBar.off("ScrollBar.onValueChanged",this._updateScrollView)}this._hScrollBar=t;if(this._hScrollBar){this._hScrollBar.on("ScrollBar.onValueChanged",this._updateScrollView);this._hScrollBarComp=this._hScrollBar.getComp("ScrollBar");this._correctVisual()}}}};var Hm=function(n){function e(){n.call(this);this._childManager=[];this._childAlignEnum=0;this._cornerEnum=0;this._lastSize=Rt.zero();this._dirty=false}if(n)e.__proto__=n;e.prototype=Object.create(n&&n.prototype);e.prototype.constructor=e;e.prototype.onInit=function e(){n.prototype.onInit.call(this);this._widget=this._entity.getComp("Widget");var t=["upper-left","upper-center","upper-right","middle-left","middle-center","middle-right","lower-left","lower-center","lower-right"];this._childAlignEnum=t.indexOf(this._childAlign);if(this._childAlignEnum===-1){this._childAlignEnum=0}t=["upper-left","upper-right","lower-left","lower-right"];this._cornerEnum=t.indexOf(this._corner);if(this._cornerEnum===-1){this._cornerEnum=0}this._lastSize=Rt.new(this._widget._rect.w,this._widget._rect.h)};e.prototype.tick=function e(){var t=this;if(!Rt.equals(this._lastSize,Rt.new(this._widget._rect.w,this._widget._rect.h))){this._lastSize=Rt.new(this._widget._rect.w,this._widget._rect.h);this._dirty=true}if(!this._dirty){if(this._childManager.length!==this._entity.children.length){this._dirty=true}else{for(var n=0;n<this._entity.children.length;++n){var r=t._entity.children[n];if(r.enabled!==t._childManager[n].enabled){t._dirty=true;break}}}}if(this._dirty){this._calculate();this._dirty=false}};e.prototype.reset=function e(){this._setSpacing(0,0);this._setPadding(0,0,0,0);this._setCellSize(100,100);this._axisDirection="horizontal";var t=["upper-left","upper-right","lower-left","lower-right"];this._corner="upper-left";this._cornerEnum=t.indexOf(this._corner);t=["upper-left","upper-center","upper-right","middle-left","middle-center","middle-right","lower-left","lower-center","lower-right"];this._childAlign="upper-left";this._childAlignEnum=t.indexOf(this._childAlign);this._constraint="flexible";this._constraintCount=2;this._dirty=true};e.prototype._calculate=function e(){var t=this;if(!this._widget){return}this._childManager=[];var n=this._widget._rect.w,r=this._widget._rect.h;var i=this._entity.children.length;var a,o;if(this._constraint==="fixed-row"){a=He(this._constraintCount,1,i);o=Math.max(1,Math.ceil(i/(1*a)))}else if(this._constraint==="fixed-col"){o=He(this._constraintCount,1,i);a=Math.max(1,Math.ceil(i/(1*o)))}else{if(this._cellWidth+this._spacingX<=0){o=65535}else{o=Math.floor((n-this.getPaddingHorizontal()+this._spacingX)/(this._cellWidth+this._spacingX));o=Math.max(1,o)}if(this._cellHeight+this._spacingY<=0){a=65535}else{a=Math.floor((r-this.getPaddingVertical()+this._spacingY)/(this._cellHeight+this._spacingY));a=Math.max(1,a)}}var s,l,u;if(this._axisDirection==="horizontal"){u=o;s=He(o,1,i);l=He(a,1,Math.ceil(i/(1*u)))}else{u=a;l=He(a,1,i);s=He(o,1,Math.ceil(i/(1*u)))}var h=Rt.new(this._cellWidth*s+this._spacingX*(s-1),this._cellHeight*l+this._spacingY*(l-1));var c=Rt.new(this.getStartOffset("horizontal",h.x),this.getStartOffset("vertical",h.y));var f=this._cornerEnum%2,p=parseInt(this._cornerEnum/2);var d=0;for(var v=0;v<i;++v){var m=t._entity.children[v];if(m.enabled===false){continue}var _=m.getComp("Widget");_.setSize(t._cellWidth,t._cellHeight);_.setAnchors(0,1,0,1);var g=void 0,y=void 0;if(t._axisDirection==="horizontal"){g=d%u;y=parseInt(d/u)}else{g=parseInt(d/u);y=d%u}var x=void 0,b=void 0;if(f===1){g=s-g-1}if(p===1){y=l-y-1}x=c.x+(t._cellWidth+t._spacingX)*g+_.pivotX*t._cellWidth;b=c.y+(t._cellHeight+t._spacingY)*y+(1-_.pivotY)*t._cellHeight;_.setOffset(x,-b);t._childManager.push(m);d++}};e.prototype.getStartOffset=function e(t,n){var r=n+(t==="horizontal"?this.getPaddingHorizontal():this.getPaddingVertical());var i=(t==="horizontal"?this._widget._rect.w:this._widget._rect.h)-r;var a=t==="horizontal"?this._childAlignEnum%3*.5:parseInt(this._childAlignEnum/3)*.5;return(t==="horizontal"?this._paddingLeft:this._paddingTop)+i*a};e.prototype.getPaddingHorizontal=function e(){return this._paddingLeft+this._paddingRight};e.prototype.getPaddingVertical=function e(){return this._paddingTop+this._paddingBottom};e.prototype._setPadding=function e(t,n,r,i){this._paddingLeft=t;this._paddingRight=r;this._paddingBottom=n;this._paddingTop=i};e.prototype._setSpacing=function e(t,n){this._spacingX=t;this._spacingY=n};e.prototype._setCellSize=function e(t,n){this._cellWidth=t;this._cellHeight=n};e.prototype.getItems=function e(){return this._childManager};return e}(rm);Hm.schema={axisDirection:{type:"enums",default:"horizontal",options:["horizontal","vertical"],set:function e(t){if(this._axisDirection===t){return}this._axisDirection=t;this._dirty=true}},paddingLeft:{type:"number",default:0,set:function e(t){if(this._paddingLeft===t){return}this._paddingLeft=t;this._dirty=true}},paddingRight:{type:"number",default:0,set:function e(t){if(this._paddingRight===t){return}this._paddingRight=t;this._dirty=true}},paddingBottom:{type:"number",default:0,set:function e(t){if(this._paddingBottom===t){return}this._paddingBottom=t;this._dirty=true}},paddingTop:{type:"number",default:0,set:function e(t){if(this._paddingTop===t){return}this._paddingTop=t;this._dirty=true}},cellWidth:{type:"number",default:100,set:function e(t){if(this._cellWidth===t){return}this._cellWidth=t;this._dirty=true}},cellHeight:{type:"number",default:100,set:function e(t){if(this._cellHeight===t){return}this._cellHeight=t;this._dirty=true}},spacingX:{type:"number",default:0,set:function e(t){if(this._spacingX===t){return}this._spacingX=t;this._dirty=true}},spacingY:{type:"number",default:0,set:function e(t){if(this._spacingY===t){return}this._spacingY=t;this._dirty=true}},corner:{type:"enums",default:"upper-left",options:["upper-left","upper-right","lower-left","lower-right"],set:function e(t){if(this._corner===t){return}var n=["upper-left","upper-right","lower-left","lower-right"];this._cornerEnum=n.indexOf(t);if(this._cornerEnum!==-1){this._corner=t;this._dirty=true}else{this._cornerEnum=0}}},childAlign:{type:"enums",default:"upper-left",options:["upper-left","upper-center","upper-right","middle-left","middle-center","middle-right","lower-left","lower-center","lower-right"],set:function e(t){if(this._childAlign===t){return}var n=["upper-left","upper-center","upper-right","middle-left","middle-center","middle-right","lower-left","lower-center","lower-right"];this._childAlignEnum=n.indexOf(t);if(this._childAlignEnum!==-1){this._childAlign=t;this._dirty=true}else{this._childAlignEnum=0}}},constraint:{type:"enums",default:"flexible",options:["flexible","fixed-row","fixed-col"],set:function e(t){if(this._constraint===t){return}this._constraint=t;this._dirty=true}},constraintCount:{type:"int",default:2,set:function e(t){if(this._constraintCount===t){return}this._constraintCount=t;this._dirty=true}}};var jm=function(e){function t(){e.call(this);this._scripts=new lr(200)}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.add=function e(t){this._scripts.push(t);t.awake()};t.prototype.remove=function e(t){t.end();this._scripts.fastRemove(this._scripts.indexOf(t))};t.prototype.tick=function e(){var t=this;for(var n=0;n<this._scripts.length;++n){var r=t._scripts.data[n];if(r.destroyed||!r.enabled){continue}if(r._startedFlag===0){r._startedFlag=1;r.start();continue}r.tick()}};t.prototype.postTick=function e(){var t=this;for(var n=0;n<this._scripts.length;++n){var r=t._scripts.data[n];if(r._startedFlag===1){r._startedFlag=2;continue}if(r.destroyed||!r.enabled){continue}r.postTick()}};return t}(oa);var qm=function(e){function t(){e.call(this);this._comps=new lr(200)}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.add=function e(t){this._comps.push(t)};t.prototype.remove=function e(t){this._comps.fastRemove(this._comps.indexOf(t))};t.prototype.tick=function e(){var t=this;for(var n=0;n<this._comps.length;++n){var r=t._comps.data[n];if(r.enabled===false){continue}r._updateMatrices()}};return t}(oa);var Xm=function(e){function t(){e.call(this);this._anims=new lr(200)}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.add=function e(t){this._anims.push(t)};t.prototype.remove=function e(t){this._anims.fastRemove(this._anims.indexOf(t))};t.prototype.tick=function e(){var t=this;for(var n=0;n<this._anims.length;++n){var r=t._anims.data[n];r._animCtrl.tick(t._app.deltaTime)}};return t}(oa);var Ym=function(o){function e(){o.call(this);this.instanceID=0;this.id2audio={};this.url2id={};var e={};var t=false;var n=e.browserVersion;var r=!!(window.AudioContext||window.webkitAudioContext||window.mozAudioContext);var i={ONLY_ONE:false,WEB_AUDIO:r,DELAY_CREATE_CTX:false};if(e.os===e.OS_IOS){i.USE_LOADER_EVENT="loadedmetadata"}if(e.browserType===e.BROWSER_TYPE_FIREFOX){i.DELAY_CREATE_CTX=true;i.USE_LOADER_EVENT="canplay"}if(e.os===e.OS_ANDROID){if(e.browserType===e.BROWSER_TYPE_UC){i.ONE_SOURCE=true}}if(t){setTimeout(function(){console.log("browse type: "+e.browserType);console.log("browse version: "+n);console.log("MULTI_CHANNEL: "+i.MULTI_CHANNEL);console.log("WEB_AUDIO: "+i.WEB_AUDIO);console.log("AUTOPLAY: "+i.AUTOPLAY)},0)}try{if(i.WEB_AUDIO){i.context=new(window.AudioContext||window.webkitAudioContext||window.mozAudioContext);if(i.DELAY_CREATE_CTX){setTimeout(function(){i.context=new(window.AudioContext||window.webkitAudioContext||window.mozAudioContext)},0)}}}catch(e){i.WEB_AUDIO=false;console.log(e)}function a(){var e=[];var t=document.createElement("audio");if(t.canPlayType){var n=t.canPlayType('audio/ogg; codecs="vorbis"');if(n){e.push(".ogg")}var r=t.canPlayType("audio/mpeg");if(r){e.push(".mp3")}var i=t.canPlayType('audio/wav; codecs="1"');if(i){e.push(".wav")}var a=t.canPlayType("audio/mp4");if(a){e.push(".mp4")}var o=t.canPlayType("audio/x-m4a");if(o){e.push(".m4a")}}return e}i.format=a();this.__audioSupport=i;this._audios=new lr(200)}if(o)e.__proto__=o;e.prototype=Object.create(o&&o.prototype);e.prototype.constructor=e;e.prototype.add=function e(t){this._audios.push(t)};e.prototype.remove=function e(t){this._audios.fastRemove(this._audios.indexOf(t))};e.prototype.addClip=function e(t,n){this.instanceID++;this.url2id[t]=this.instanceID;this.id2audio[this.instanceID]=n;return this.instanceID};e.prototype.getIDByURL=function e(t){return this.url2id[t]};e.prototype.removeClip=function e(t){var n=null;if(!t){return}else if(typeof t==="string"){n=t}else{n=t.url}var r=this.url2id[n];delete this.url2id[n];var i=this.id2audio[r];if(i){i.stop();i.destroy();delete this.id2audio[r]}};e.prototype.setVolumeForAll=function e(t){var n=this;for(var r=0;r<this._audios.length;r++){n._audios.data[r].setVolume(t)}};e.prototype.pauseAll=function e(){var t=this;for(var n=0;n<this._audios.length;n++){t._audios.data[n].pause()}};e.prototype.stopAll=function e(){var t=this;for(var n=0;n<this._audios.length;n++){t._audios.data[n].stop()}};e.prototype.resumeAll=function e(){var t=this;for(var n=0;n<this._audios.length;n++){t._audios.data[n].resume()}};e.prototype._getClipByURL=function e(t){return this.id2audio[this.url2id[t]]};e.prototype._getClipByID=function e(t){return this.id2audio[t]};return e}(oa);var Km={box:kt.SHAPE_BOX,sphere:kt.SHAPE_SPHERE};var Zm=Lt.zero();var Qm=It.create();var Jm=Lt.zero();var $m=function e(t){this._entity=t._entity;this._system=t._system;this._world=t._system.world;this.shapeType=Km[t.type];this._shapeModelSpace=this.createShape(t);this.shape=this.createShape(t);this._system._fullSimulation=true;this.collisionFilterGroup=1;this.collisionFilterMask=1};$m.prototype.createShape=function e(t){switch(t.type){case"box":return _n.new(t.center.x,t.center.y,t.center.z,t.size.x*.5,t.size.y*.5,t.size.z*.5,1,0,0,0,1,0,0,0,1);case"sphere":return dn.new(t.center.x,t.center.y,t.center.z,t.radius);default:console.warn("Unsupported collider type - only boxes and spheres are supported");return _n.create()}};$m.prototype.setCollisionFilter=function e(t,n){this.collisionFilterGroup=t;this.collisionFilterMask=n};$m.prototype.updateTransform=function e(){this._entity._getWorldPRS(Zm,Qm,Jm);this.shape.setTransform(Zm,Qm,Jm,this._shapeModelSpace)};$m.prototype.intersect=function e(t){return ln.resolve(this.shapeType,t.shapeType,this.shape,t.shape)};$m.prototype.setCenter=function e(t){this._shapeModelSpace.center=t};$m.prototype.setSize=function e(t){if(this.shapeType!=kt.SHAPE_BOX){return}this._shapeModelSpace.halfExtents=t};$m.prototype.setRadius=function e(t){if(this.shapeType!=kt.SHAPE_SPHERE){return}this._shapeModelSpace.r=t};$m.prototype.setIsTrigger=function e(){};$m.prototype.setMass=function e(){};$m.prototype.setDrag=function e(){};$m.prototype.setAngularDrag=function e(){};$m.prototype.setIsKinematic=function e(){};$m.prototype.setFreezeRotation=function e(){};var e_={body:null,target:null};var t_=function e(){this._cols=new lr(200)};t_.prototype.add=function e(t){this._cols.push(t.body)};t_.prototype.remove=function e(t){this._cols.fastRemove(this._cols.indexOf(t))};t_.prototype.step=function e(){var t=this;for(var n=0;n<this._cols.length;++n){var r=t._cols.data[n];r.updateTransform()}for(var i=0;i<this._cols.length;++i){var a=t._cols.data[i];for(var o=i+1;o<this._cols.length;++o){var s=t._cols.data[o];if((a.collisionFilterGroup&s.collisionFilterMask)===0||(s.collisionFilterGroup&a.collisionFilterMask)===0){continue}if(a.intersect(s)){e_.body=a;e_.target=s;a._entity.emit("collide",e_);e_.body=s;e_.target=a;s._entity.emit("collide",e_)}}}};function n_(){throw new Error("Dynamic requires are not currently supported by rollup-plugin-commonjs")}function r_(e,t){return t={exports:{}},e(t,t.exports),t.exports}var i_=r_(function(t,e){!function(e){{t.exports=e()}}(function(){return function i(a,o,s){function l(n,e){if(!o[n]){if(!a[n]){var t=typeof n_=="function"&&n_;if(!e&&t){return t(n,!0)}if(u){return u(n,!0)}throw new Error("Cannot find module '"+n+"'")}var r=o[n]={exports:{}};a[n][0].call(r.exports,function(e){var t=a[n][1][e];return l(t?t:e)},r,r.exports,i,a,o,s)}return o[n].exports}var u=typeof n_=="function"&&n_;for(var e=0;e<s.length;e++){l(s[e])}return l}({1:[function(e,t,n){t.exports={name:"cannon",version:"0.6.2",description:"A lightweight 3D physics engine written in JavaScript.",homepage:"https://github.com/schteppe/cannon.js",author:"Stefan Hedman <schteppe@gmail.com> (http://steffe.se)",keywords:["cannon.js","cannon","physics","engine","3d"],main:"./build/cannon.js",engines:{node:"*"},repository:{type:"git",url:"https://github.com/schteppe/cannon.js.git"},bugs:{url:"https://github.com/schteppe/cannon.js/issues"},licenses:[{type:"MIT"}],devDependencies:{jshint:"latest","uglify-js":"latest",nodeunit:"^0.9.0",grunt:"~0.4.0","grunt-contrib-jshint":"~0.1.1","grunt-contrib-nodeunit":"^0.4.1","grunt-contrib-concat":"~0.1.3","grunt-contrib-uglify":"^0.5.1","grunt-browserify":"^2.1.4","grunt-contrib-yuidoc":"^0.5.2",browserify:"*"},dependencies:{}}},{}],2:[function(e,t,n){t.exports={version:e("../package.json").version,AABB:e("./collision/AABB"),ArrayCollisionMatrix:e("./collision/ArrayCollisionMatrix"),Body:e("./objects/Body"),Box:e("./shapes/Box"),Broadphase:e("./collision/Broadphase"),Constraint:e("./constraints/Constraint"),ContactEquation:e("./equations/ContactEquation"),Narrowphase:e("./world/Narrowphase"),ConeTwistConstraint:e("./constraints/ConeTwistConstraint"),ContactMaterial:e("./material/ContactMaterial"),ConvexPolyhedron:e("./shapes/ConvexPolyhedron"),Cylinder:e("./shapes/Cylinder"),DistanceConstraint:e("./constraints/DistanceConstraint"),Equation:e("./equations/Equation"),EventTarget:e("./utils/EventTarget"),FrictionEquation:e("./equations/FrictionEquation"),GSSolver:e("./solver/GSSolver"),GridBroadphase:e("./collision/GridBroadphase"),Heightfield:e("./shapes/Heightfield"),HingeConstraint:e("./constraints/HingeConstraint"),LockConstraint:e("./constraints/LockConstraint"),Mat3:e("./math/Mat3"),Material:e("./material/Material"),NaiveBroadphase:e("./collision/NaiveBroadphase"),ObjectCollisionMatrix:e("./collision/ObjectCollisionMatrix"),Pool:e("./utils/Pool"),Particle:e("./shapes/Particle"),Plane:e("./shapes/Plane"),PointToPointConstraint:e("./constraints/PointToPointConstraint"),Quaternion:e("./math/Quaternion"),Ray:e("./collision/Ray"),RaycastVehicle:e("./objects/RaycastVehicle"),RaycastResult:e("./collision/RaycastResult"),RigidVehicle:e("./objects/RigidVehicle"),RotationalEquation:e("./equations/RotationalEquation"),RotationalMotorEquation:e("./equations/RotationalMotorEquation"),SAPBroadphase:e("./collision/SAPBroadphase"),SPHSystem:e("./objects/SPHSystem"),Shape:e("./shapes/Shape"),Solver:e("./solver/Solver"),Sphere:e("./shapes/Sphere"),SplitSolver:e("./solver/SplitSolver"),Spring:e("./objects/Spring"),Trimesh:e("./shapes/Trimesh"),Vec3:e("./math/Vec3"),Vec3Pool:e("./utils/Vec3Pool"),World:e("./world/World")}},{"../package.json":1,"./collision/AABB":3,"./collision/ArrayCollisionMatrix":4,"./collision/Broadphase":5,"./collision/GridBroadphase":6,"./collision/NaiveBroadphase":7,"./collision/ObjectCollisionMatrix":8,"./collision/Ray":9,"./collision/RaycastResult":10,"./collision/SAPBroadphase":11,"./constraints/ConeTwistConstraint":12,"./constraints/Constraint":13,"./constraints/DistanceConstraint":14,"./constraints/HingeConstraint":15,"./constraints/LockConstraint":16,"./constraints/PointToPointConstraint":17,"./equations/ContactEquation":19,"./equations/Equation":20,"./equations/FrictionEquation":21,"./equations/RotationalEquation":22,"./equations/RotationalMotorEquation":23,"./material/ContactMaterial":24,"./material/Material":25,"./math/Mat3":27,"./math/Quaternion":28,"./math/Vec3":30,"./objects/Body":31,"./objects/RaycastVehicle":32,"./objects/RigidVehicle":33,"./objects/SPHSystem":34,"./objects/Spring":35,"./shapes/Box":37,"./shapes/ConvexPolyhedron":38,"./shapes/Cylinder":39,"./shapes/Heightfield":40,"./shapes/Particle":41,"./shapes/Plane":42,"./shapes/Shape":43,"./shapes/Sphere":44,"./shapes/Trimesh":45,"./solver/GSSolver":46,"./solver/Solver":47,"./solver/SplitSolver":48,"./utils/EventTarget":49,"./utils/Pool":51,"./utils/Vec3Pool":54,"./world/Narrowphase":55,"./world/World":56}],3:[function(e,t,n){var r=e("../math/Vec3");var i=e("../utils/Utils");t.exports=a;function a(e){e=e||{};this.lowerBound=new r;if(e.lowerBound){this.lowerBound.copy(e.lowerBound)}this.upperBound=new r;if(e.upperBound){this.upperBound.copy(e.upperBound)}}var u=new r;a.prototype.setFromPoints=function(e,t,n,r){var i=this.lowerBound,a=this.upperBound,o=n;i.copy(e[0]);if(o){o.vmult(i,i)}a.copy(i);for(var s=1;s<e.length;s++){var l=e[s];if(o){o.vmult(l,u);l=u}if(l.x>a.x){a.x=l.x}if(l.x<i.x){i.x=l.x}if(l.y>a.y){a.y=l.y}if(l.y<i.y){i.y=l.y}if(l.z>a.z){a.z=l.z}if(l.z<i.z){i.z=l.z}}if(t){t.vadd(i,i);t.vadd(a,a)}if(r){i.x-=r;i.y-=r;i.z-=r;a.x+=r;a.y+=r;a.z+=r}return this};a.prototype.copy=function(e){this.lowerBound.copy(e.lowerBound);this.upperBound.copy(e.upperBound);return this};a.prototype.clone=function(){return(new a).copy(this)};a.prototype.extend=function(e){var t=e.lowerBound.x;if(this.lowerBound.x>t){this.lowerBound.x=t}var n=e.upperBound.x;if(this.upperBound.x<n){this.upperBound.x=n}var t=e.lowerBound.y;if(this.lowerBound.y>t){this.lowerBound.y=t}var n=e.upperBound.y;if(this.upperBound.y<n){this.upperBound.y=n}var t=e.lowerBound.z;if(this.lowerBound.z>t){this.lowerBound.z=t}var n=e.upperBound.z;if(this.upperBound.z<n){this.upperBound.z=n}};a.prototype.overlaps=function(e){var t=this.lowerBound,n=this.upperBound,r=e.lowerBound,i=e.upperBound;return(r.x<=n.x&&n.x<=i.x||t.x<=i.x&&i.x<=n.x)&&(r.y<=n.y&&n.y<=i.y||t.y<=i.y&&i.y<=n.y)&&(r.z<=n.z&&n.z<=i.z||t.z<=i.z&&i.z<=n.z)};a.prototype.contains=function(e){var t=this.lowerBound,n=this.upperBound,r=e.lowerBound,i=e.upperBound;return t.x<=r.x&&n.x>=i.x&&(t.y<=r.y&&n.y>=i.y)&&(t.z<=r.z&&n.z>=i.z)};a.prototype.getCorners=function(e,t,n,r,i,a,o,s){var l=this.lowerBound,u=this.upperBound;e.copy(l);t.set(u.x,l.y,l.z);n.set(u.x,u.y,l.z);r.set(l.x,u.y,u.z);i.set(u.x,l.y,l.z);a.set(l.x,u.y,l.z);o.set(l.x,l.y,u.z);s.copy(u)};var p=[new r,new r,new r,new r,new r,new r,new r,new r];a.prototype.toLocalFrame=function(e,t){var n=p;var r=n[0];var i=n[1];var a=n[2];var o=n[3];var s=n[4];var l=n[5];var u=n[6];var h=n[7];this.getCorners(r,i,a,o,s,l,u,h);for(var c=0;c!==8;c++){var f=n[c];e.pointToLocal(f,f)}return t.setFromPoints(n)};a.prototype.toWorldFrame=function(e,t){var n=p;var r=n[0];var i=n[1];var a=n[2];var o=n[3];var s=n[4];var l=n[5];var u=n[6];var h=n[7];this.getCorners(r,i,a,o,s,l,u,h);for(var c=0;c!==8;c++){var f=n[c];e.pointToWorld(f,f)}return t.setFromPoints(n)}},{"../math/Vec3":30,"../utils/Utils":53}],4:[function(e,t,n){t.exports=r;function r(){this.matrix=[]}r.prototype.get=function(e,t){e=e.index;t=t.index;if(t>e){var n=t;t=e;e=n}return this.matrix[(e*(e+1)>>1)+t-1]};r.prototype.set=function(e,t,n){e=e.index;t=t.index;if(t>e){var r=t;t=e;e=r}this.matrix[(e*(e+1)>>1)+t-1]=n?1:0};r.prototype.reset=function(){var e=this;for(var t=0,n=this.matrix.length;t!==n;t++){e.matrix[t]=0}};r.prototype.setNumObjects=function(e){this.matrix.length=e*(e-1)>>1}},{}],5:[function(e,t,n){var r=e("../objects/Body");var i=e("../math/Vec3");var a=e("../math/Quaternion");var o=e("../shapes/Shape");var s=e("../shapes/Plane");t.exports=l;function l(){this.world=null;this.useBoundingBoxes=false;this.dirty=true}l.prototype.collisionPairs=function(e,t,n){throw new Error("collisionPairs not implemented for this BroadPhase class!")};var u=r.STATIC|r.KINEMATIC;l.prototype.needBroadphaseCollision=function(e,t){if((e.collisionFilterGroup&t.collisionFilterMask)===0||(t.collisionFilterGroup&e.collisionFilterMask)===0){return false}if(((e.type&u)!==0||e.sleepState===r.SLEEPING)&&((t.type&u)!==0||t.sleepState===r.SLEEPING)){return false}return true};l.prototype.intersectionTest=function(e,t,n,r){if(this.useBoundingBoxes){this.doBoundingBoxBroadphase(e,t,n,r)}else{this.doBoundingSphereBroadphase(e,t,n,r)}};var h=new i,c=new i,f=new a,p=new i;l.prototype.doBoundingSphereBroadphase=function(e,t,n,r){var i=h;t.position.vsub(e.position,i);var a=Math.pow(e.boundingRadius+t.boundingRadius,2);var o=i.norm2();if(o<a){n.push(e);r.push(t)}};l.prototype.doBoundingBoxBroadphase=function(e,t,n,r){if(e.aabbNeedsUpdate){e.computeAABB()}if(t.aabbNeedsUpdate){t.computeAABB()}if(e.aabb.overlaps(t.aabb)){n.push(e);r.push(t)}};var d={keys:[]},v=[],m=[];l.prototype.makePairsUnique=function(e,t){var n=d,r=v,i=m,a=e.length;for(var o=0;o!==a;o++){r[o]=e[o];i[o]=t[o]}e.length=0;t.length=0;for(var o=0;o!==a;o++){var s=r[o].id,l=i[o].id;var u=s<l?s+","+l:l+","+s;n[u]=o;n.keys.push(u)}for(var o=0;o!==n.keys.length;o++){var u=n.keys.pop(),h=n[u];e.push(r[h]);t.push(i[h]);delete n[u]}};l.prototype.setWorld=function(e){};var _=new i;l.boundingSphereCheck=function(e,t){var n=_;e.position.vsub(t.position,n);return Math.pow(e.shape.boundingSphereRadius+t.shape.boundingSphereRadius,2)>n.norm2()};l.prototype.aabbQuery=function(e,t,n){console.warn(".aabbQuery is not implemented in this Broadphase subclass.");return[]}},{"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Plane":42,"../shapes/Shape":43}],6:[function(e,t,n){t.exports=r;var l=e("./Broadphase");var u=e("../math/Vec3");var oe=e("../shapes/Shape");function r(e,t,n,r,i){var a=this;l.apply(this);this.nx=n||10;this.ny=r||10;this.nz=i||10;this.aabbMin=e||new u(100,100,100);this.aabbMax=t||new u(-100,-100,-100);var o=this.nx*this.ny*this.nz;if(o<=0){throw"GridBroadphase: Each dimension's n must be >0"}this.bins=[];this.binLengths=[];this.bins.length=o;this.binLengths.length=o;for(var s=0;s<o;s++){a.bins[s]=[];a.binLengths[s]=0}}r.prototype=new l;r.prototype.constructor=r;var se=new u;var i=new u;r.prototype.collisionPairs=function(e,t,n){var r=this;var i=e.numObjects(),a=e.bodies;var o=this.aabbMax,s=this.aabbMin,_=this.nx,g=this.ny,y=this.nz;var x=g*y;var b=y;var w=1;var l=o.x,u=o.y,h=o.z,E=s.x,T=s.y,S=s.z;var A=_/(l-E),M=g/(u-T),R=y/(h-S);var c=(l-E)/_,f=(u-T)/g,p=(h-S)/y;var d=Math.sqrt(c*c+f*f+p*p)*.5;var v=oe.types;var m=v.SPHERE,L=v.PLANE,C=v.BOX,O=v.COMPOUND,I=v.CONVEXPOLYHEDRON;var U=this.bins,P=this.binLengths,B=this.bins.length;for(var D=0;D!==B;D++){P[D]=0}var F=Math.ceil;var s=Math.min;var o=Math.max;function z(e,t,n,r,i,a,o){var s=(e-E)*A|0,l=(t-T)*M|0,u=(n-S)*R|0,h=F((r-E)*A),c=F((i-T)*M),f=F((a-S)*R);if(s<0){s=0}else if(s>=_){s=_-1}if(l<0){l=0}else if(l>=g){l=g-1}if(u<0){u=0}else if(u>=y){u=y-1}if(h<0){h=0}else if(h>=_){h=_-1}if(c<0){c=0}else if(c>=g){c=g-1}if(f<0){f=0}else if(f>=y){f=y-1}s*=x;l*=b;u*=w;h*=x;c*=b;f*=w;for(var p=s;p<=h;p+=x){for(var d=l;d<=c;d+=b){for(var v=u;v<=f;v+=w){var m=p+d+v;U[m][P[m]++]=o}}}}for(var D=0;D!==i;D++){var N=a[D];var k=N.shape;switch(k.type){case m:var V=N.position.x,W=N.position.y,G=N.position.z;var H=k.radius;z(V-H,W-H,G-H,V+H,W+H,G+H,N);break;case L:if(k.worldNormalNeedsUpdate){k.computeWorldNormal(N.quaternion)}var j=k.worldNormal;var q=E+c*.5-N.position.x,X=T+f*.5-N.position.y,Y=S+p*.5-N.position.z;var K=se;K.set(q,X,Y);for(var Z=0,Q=0;Z!==_;Z++,Q+=x,K.y=X,K.x+=c){for(var J=0,$=0;J!==g;J++,$+=b,K.z=Y,K.y+=f){for(var ee=0,te=0;ee!==y;ee++,te+=w,K.z+=p){if(K.dot(j)<d){var ne=Q+$+te;U[ne][P[ne]++]=N}}}}break;default:if(N.aabbNeedsUpdate){N.computeAABB()}z(N.aabb.lowerBound.x,N.aabb.lowerBound.y,N.aabb.lowerBound.z,N.aabb.upperBound.x,N.aabb.upperBound.y,N.aabb.upperBound.z,N);break}}for(var D=0;D!==B;D++){var re=P[D];if(re>1){var ie=U[D];for(var Z=0;Z!==re;Z++){var N=ie[Z];for(var J=0;J!==Z;J++){var ae=ie[J];if(r.needBroadphaseCollision(N,ae)){r.intersectionTest(N,ae,t,n)}}}}}this.makePairsUnique(t,n)}},{"../math/Vec3":30,"../shapes/Shape":43,"./Broadphase":5}],7:[function(e,t,n){t.exports=a;var r=e("./Broadphase");var i=e("./AABB");function a(){r.apply(this)}a.prototype=new r;a.prototype.constructor=a;a.prototype.collisionPairs=function(e,t,n){var r=this;var i=e.bodies,a=i.length,o,s,l,u;for(o=0;o!==a;o++){for(s=0;s!==o;s++){l=i[o];u=i[s];if(!r.needBroadphaseCollision(l,u)){continue}r.intersectionTest(l,u,t,n)}}};var o=new i;a.prototype.aabbQuery=function(e,t,n){n=n||[];for(var r=0;r<e.bodies.length;r++){var i=e.bodies[r];if(i.aabbNeedsUpdate){i.computeAABB()}if(i.aabb.overlaps(t)){n.push(i)}}return n}},{"./AABB":3,"./Broadphase":5}],8:[function(e,t,n){t.exports=r;function r(){this.matrix={}}r.prototype.get=function(e,t){e=e.id;t=t.id;if(t>e){var n=t;t=e;e=n}return e+"-"+t in this.matrix};r.prototype.set=function(e,t,n){e=e.id;t=t.id;if(t>e){var r=t;t=e;e=r}if(n){this.matrix[e+"-"+t]=true}else{delete this.matrix[e+"-"+t]}};r.prototype.reset=function(){this.matrix={}};r.prototype.setNumObjects=function(e){}},{}],9:[function(e,t,n){t.exports=y;var g=e("../math/Vec3");var r=e("../math/Quaternion");var C=e("../math/Transform");var i=e("../shapes/ConvexPolyhedron");var a=e("../shapes/Box");var o=e("../collision/RaycastResult");var s=e("../shapes/Shape");var l=e("../collision/AABB");function y(e,t){this.from=e?e.clone():new g;this.to=t?t.clone():new g;this._direction=new g;this.precision=1e-4;this.checkCollisionResponse=true;this.skipBackfaces=false;this.collisionFilterMask=-1;this.collisionFilterGroup=-1;this.mode=y.ANY;this.result=new o;this.hasHit=false;this.callback=function(e){}}y.prototype.constructor=y;y.CLOSEST=1;y.ANY=2;y.ALL=4;var u=new l;var h=[];y.prototype.intersectWorld=function(e,t){this.mode=t.mode||y.ANY;this.result=t.result||new o;this.skipBackfaces=!!t.skipBackfaces;this.collisionFilterMask=typeof t.collisionFilterMask!=="undefined"?t.collisionFilterMask:-1;this.collisionFilterGroup=typeof t.collisionFilterGroup!=="undefined"?t.collisionFilterGroup:-1;if(t.from){this.from.copy(t.from)}if(t.to){this.to.copy(t.to)}this.callback=t.callback||function(){};this.hasHit=false;this.result.reset();this._updateDirection();this.getAABB(u);h.length=0;e.broadphase.aabbQuery(e,u,h);this.intersectBodies(h);return this.hasHit};var c=new g,f=new g;y.pointInTriangle=O;function O(e,t,n,r){r.vsub(t,M);n.vsub(t,c);e.vsub(t,f);var i=M.dot(M);var a=M.dot(c);var o=M.dot(f);var s=c.dot(c);var l=c.dot(f);var u,h;return(u=s*o-a*l)>=0&&(h=i*l-a*o)>=0&&u+h<i*s-a*a}var p=new g;var d=new r;y.prototype.intersectBody=function(e,t){var n=this;if(t){this.result=t;this._updateDirection()}var r=this.checkCollisionResponse;if(r&&!e.collisionResponse){return}if((this.collisionFilterGroup&e.collisionFilterMask)===0||(e.collisionFilterGroup&this.collisionFilterMask)===0){return}var i=p;var a=d;for(var o=0,s=e.shapes.length;o<s;o++){var l=e.shapes[o];if(r&&!l.collisionResponse){continue}e.quaternion.mult(e.shapeOrientations[o],a);e.quaternion.vmult(e.shapeOffsets[o],i);i.vadd(e.position,i);n.intersectShape(l,a,i,e);if(n.result._shouldStop){break}}};y.prototype.intersectBodies=function(e,t){var n=this;if(t){this.result=t;this._updateDirection()}for(var r=0,i=e.length;!this.result._shouldStop&&r<i;r++){n.intersectBody(e[r])}};y.prototype._updateDirection=function(){this.to.vsub(this.from,this._direction);this._direction.normalize()};y.prototype.intersectShape=function(e,t,n,r){var i=this.from;var a=j(i,this._direction,n);if(a>e.boundingSphereRadius){return}var o=this[e.type];if(o){o.call(this,e,t,n,r)}};var v=new g;var m=new g;var I=new g;var U=new g;var P=new g;var B=new g;var _=new g;var x=new o;y.prototype.intersectBox=function(e,t,n,r){return this.intersectConvex(e.convexPolyhedronRepresentation,t,n,r)};y.prototype[s.types.BOX]=y.prototype.intersectBox;y.prototype.intersectPlane=function(e,t,n,r){var i=this.from;var a=this.to;var o=this._direction;var s=new g(0,0,1);t.vmult(s,s);var l=new g;i.vsub(n,l);var u=l.dot(s);a.vsub(n,l);var h=l.dot(s);if(u*h>0){return}if(i.distanceTo(a)<u){return}var c=s.dot(o);if(Math.abs(c)<this.precision){return}var f=new g;var p=new g;var d=new g;i.vsub(n,f);var v=-s.dot(f)/c;o.scale(v,p);i.vadd(p,d);this.reportIntersection(s,d,e,r,-1)};y.prototype[s.types.PLANE]=y.prototype.intersectPlane;y.prototype.getAABB=function(e){var t=this.to;var n=this.from;e.lowerBound.x=Math.min(t.x,n.x);e.lowerBound.y=Math.min(t.y,n.y);e.lowerBound.z=Math.min(t.z,n.z);e.upperBound.x=Math.max(t.x,n.x);e.upperBound.y=Math.max(t.y,n.y);e.upperBound.z=Math.max(t.z,n.z)};var b={faceList:[0]};y.prototype.intersectHeightfield=function(e,t,n,r){var i=this;var a=e.data,o=e.elementSize,s=new g;var l=new y(this.from,this.to);C.pointToLocalFrame(n,t,l.from,l.from);C.pointToLocalFrame(n,t,l.to,l.to);var u=[];var h=null;var c=null;var f=null;var p=null;var d=e.getIndexOfPosition(l.from.x,l.from.y,u,false);if(d){h=u[0];c=u[1];f=u[0];p=u[1]}d=e.getIndexOfPosition(l.to.x,l.to.y,u,false);if(d){if(h===null||u[0]<h){h=u[0]}if(f===null||u[0]>f){f=u[0]}if(c===null||u[1]<c){c=u[1]}if(p===null||u[1]>p){p=u[1]}}if(h===null){return}var v=[];e.getRectMinMax(h,c,f,p,v);for(var m=h;m<=f;m++){for(var _=c;_<=p;_++){if(i.result._shouldStop){return}e.getConvexTrianglePillar(m,_,false);C.pointToWorldFrame(n,t,e.pillarOffset,s);i.intersectConvex(e.pillarConvex,t,s,r,b);if(i.result._shouldStop){return}e.getConvexTrianglePillar(m,_,true);C.pointToWorldFrame(n,t,e.pillarOffset,s);i.intersectConvex(e.pillarConvex,t,s,r,b)}}};y.prototype[s.types.HEIGHTFIELD]=y.prototype.intersectHeightfield;var w=new g;var E=new g;y.prototype.intersectSphere=function(e,t,n,r){var i=this.from,a=this.to,o=e.radius;var s=Math.pow(a.x-i.x,2)+Math.pow(a.y-i.y,2)+Math.pow(a.z-i.z,2);var l=2*((a.x-i.x)*(i.x-n.x)+(a.y-i.y)*(i.y-n.y)+(a.z-i.z)*(i.z-n.z));var u=Math.pow(i.x-n.x,2)+Math.pow(i.y-n.y,2)+Math.pow(i.z-n.z,2)-Math.pow(o,2);var h=Math.pow(l,2)-4*s*u;var c=w;var f=E;if(h<0){return}else if(h===0){i.lerp(a,h,c);c.vsub(n,f);f.normalize();this.reportIntersection(f,c,e,r,-1)}else{var p=(-l-Math.sqrt(h))/(2*s);var d=(-l+Math.sqrt(h))/(2*s);if(p>=0&&p<=1){i.lerp(a,p,c);c.vsub(n,f);f.normalize();this.reportIntersection(f,c,e,r,-1)}if(this.result._shouldStop){return}if(d>=0&&d<=1){i.lerp(a,d,c);c.vsub(n,f);f.normalize();this.reportIntersection(f,c,e,r,-1)}}};y.prototype[s.types.SPHERE]=y.prototype.intersectSphere;var L=new g;var T=new g;var S=new g;var D=new g;y.prototype.intersectConvex=function e(t,n,r,i,a){var o=this;var s=L;var l=D;var u=a&&a.faceList||null;var h=t.faces,c=t.vertices,f=t.faceNormals;var p=this._direction;var d=this.from;var v=this.to;var m=d.distanceTo(v);var _=u?u.length:h.length;var g=this.result;for(var y=0;!g._shouldStop&&y<_;y++){var x=u?u[y]:y;var b=h[x];var w=f[x];var E=n;var T=r;l.copy(c[b[0]]);E.vmult(l,l);l.vadd(T,l);l.vsub(d,l);E.vmult(w,s);var S=p.dot(s);if(Math.abs(S)<o.precision){continue}var A=s.dot(l)/S;if(A<0){continue}p.mult(A,I);I.vadd(d,I);U.copy(c[b[0]]);E.vmult(U,U);T.vadd(U,U);for(var M=1;!g._shouldStop&&M<b.length-1;M++){P.copy(c[b[M]]);B.copy(c[b[M+1]]);E.vmult(P,P);E.vmult(B,B);T.vadd(P,P);T.vadd(B,B);var R=I.distanceTo(d);if(!(O(I,U,P,B)||O(I,P,U,B))||R>m){continue}o.reportIntersection(s,I,t,i,x)}}};y.prototype[s.types.CONVEXPOLYHEDRON]=y.prototype.intersectConvex;var F=new g;var z=new g;var N=new g;var k=new g;var V=new g;var W=new g;var A=new l;var G=[];var H=new C;y.prototype.intersectTrimesh=function e(t,n,r,i,a){var o=this;var s=F;var l=G;var u=H;var h=D;var c=z;var f=N;var p=k;var d=W;var v=V;var m=a&&a.faceList||null;var _=t.indices,g=t.vertices,y=t.faceNormals;var x=this.from;var b=this.to;var w=this._direction;u.position.copy(r);u.quaternion.copy(n);C.vectorToLocalFrame(r,n,w,c);C.pointToLocalFrame(r,n,x,f);C.pointToLocalFrame(r,n,b,p);var E=f.distanceSquared(p);t.tree.rayQuery(this,u,l);for(var T=0,S=l.length;!this.result._shouldStop&&T!==S;T++){var A=l[T];t.getNormal(A,s);t.getVertex(_[A*3],U);U.vsub(f,h);var M=c.dot(s);var R=s.dot(h)/M;if(R<0){continue}c.scale(R,I);I.vadd(f,I);t.getVertex(_[A*3+1],P);t.getVertex(_[A*3+2],B);var L=I.distanceSquared(f);if(!(O(I,P,U,B)||O(I,U,P,B))||L>E){continue}C.vectorToWorldFrame(n,s,v);C.pointToWorldFrame(r,n,I,d);o.reportIntersection(v,d,t,i,A)}l.length=0};y.prototype[s.types.TRIMESH]=y.prototype.intersectTrimesh;y.prototype.reportIntersection=function(e,t,n,r,i){var a=this.from;var o=this.to;var s=a.distanceTo(t);var l=this.result;if(this.skipBackfaces&&e.dot(this._direction)>0){return}l.hitFaceIndex=typeof i!=="undefined"?i:-1;switch(this.mode){case y.ALL:this.hasHit=true;l.set(a,o,e,t,n,r,s);l.hasHit=true;this.callback(l);break;case y.CLOSEST:if(s<l.distance||!l.hasHit){this.hasHit=true;l.hasHit=true;l.set(a,o,e,t,n,r,s)}break;case y.ANY:this.hasHit=true;l.hasHit=true;l.set(a,o,e,t,n,r,s);l._shouldStop=true;break}};var M=new g,R=new g;function j(e,t,n){n.vsub(e,M);var r=M.dot(t);t.mult(r,R);R.vadd(e,R);var i=n.distanceTo(R);return i}},{"../collision/AABB":3,"../collision/RaycastResult":10,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../shapes/Box":37,"../shapes/ConvexPolyhedron":38,"../shapes/Shape":43}],10:[function(e,t,n){var r=e("../math/Vec3");t.exports=i;function i(){this.rayFromWorld=new r;this.rayToWorld=new r;this.hitNormalWorld=new r;this.hitPointWorld=new r;this.hasHit=false;this.shape=null;this.body=null;this.hitFaceIndex=-1;this.distance=-1;this._shouldStop=false}i.prototype.reset=function(){this.rayFromWorld.setZero();this.rayToWorld.setZero();this.hitNormalWorld.setZero();this.hitPointWorld.setZero();this.hasHit=false;this.shape=null;this.body=null;this.hitFaceIndex=-1;this.distance=-1;this._shouldStop=false};i.prototype.abort=function(){this._shouldStop=true};i.prototype.set=function(e,t,n,r,i,a,o){this.rayFromWorld.copy(e);this.rayToWorld.copy(t);this.hitNormalWorld.copy(n);this.hitPointWorld.copy(r);this.shape=i;this.body=a;this.distance=o}},{"../math/Vec3":30}],11:[function(e,t,n){var r=e("../shapes/Shape");var i=e("../collision/Broadphase");t.exports=c;function c(e){i.apply(this);this.axisList=[];this.world=null;this.axisIndex=0;var n=this.axisList;this._addBodyHandler=function(e){n.push(e.body)};this._removeBodyHandler=function(e){var t=n.indexOf(e.body);if(t!==-1){n.splice(t,1)}};if(e){this.setWorld(e)}}c.prototype=new i;c.prototype.setWorld=function(e){var t=this;this.axisList.length=0;for(var n=0;n<e.bodies.length;n++){t.axisList.push(e.bodies[n])}e.removeEventListener("addBody",this._addBodyHandler);e.removeEventListener("removeBody",this._removeBodyHandler);e.addEventListener("addBody",this._addBodyHandler);e.addEventListener("removeBody",this._removeBodyHandler);this.world=e;this.dirty=true};c.insertionSortX=function(e){for(var t=1,n=e.length;t<n;t++){var r=e[t];for(var i=t-1;i>=0;i--){if(e[i].aabb.lowerBound.x<=r.aabb.lowerBound.x){break}e[i+1]=e[i]}e[i+1]=r}return e};c.insertionSortY=function(e){for(var t=1,n=e.length;t<n;t++){var r=e[t];for(var i=t-1;i>=0;i--){if(e[i].aabb.lowerBound.y<=r.aabb.lowerBound.y){break}e[i+1]=e[i]}e[i+1]=r}return e};c.insertionSortZ=function(e){for(var t=1,n=e.length;t<n;t++){var r=e[t];for(var i=t-1;i>=0;i--){if(e[i].aabb.lowerBound.z<=r.aabb.lowerBound.z){break}e[i+1]=e[i]}e[i+1]=r}return e};c.prototype.collisionPairs=function(e,t,n){var r=this;var i=this.axisList,a=i.length,o=this.axisIndex,s,l;if(this.dirty){this.sortList();this.dirty=false}for(s=0;s!==a;s++){var u=i[s];for(l=s+1;l<a;l++){var h=i[l];if(!r.needBroadphaseCollision(u,h)){continue}if(!c.checkBounds(u,h,o)){break}r.intersectionTest(u,h,t,n)}}};c.prototype.sortList=function(){var e=this.axisList;var t=this.axisIndex;var n=e.length;for(var r=0;r!==n;r++){var i=e[r];if(i.aabbNeedsUpdate){i.computeAABB()}}if(t===0){c.insertionSortX(e)}else if(t===1){c.insertionSortY(e)}else if(t===2){c.insertionSortZ(e)}};c.checkBounds=function(e,t,n){var r;var i;if(n===0){r=e.position.x;i=t.position.x}else if(n===1){r=e.position.y;i=t.position.y}else if(n===2){r=e.position.z;i=t.position.z}var a=e.boundingRadius,o=t.boundingRadius,s=r-a,l=r+a,u=i-o;return u<l};c.prototype.autoDetectAxis=function(){var e=0,t=0,n=0,r=0,i=0,a=0,o=this.axisList,s=o.length,l=1/s;for(var u=0;u!==s;u++){var h=o[u];var c=h.position.x;e+=c;t+=c*c;var f=h.position.y;n+=f;r+=f*f;var p=h.position.z;i+=p;a+=p*p}var d=t-e*e*l,v=r-n*n*l,m=a-i*i*l;if(d>v){if(d>m){this.axisIndex=0}else{this.axisIndex=2}}else if(v>m){this.axisIndex=1}else{this.axisIndex=2}};c.prototype.aabbQuery=function(e,t,n){n=n||[];if(this.dirty){this.sortList();this.dirty=false}var r=this.axisIndex,i="x";if(r===1){i="y"}if(r===2){i="z"}var a=this.axisList;var o=t.lowerBound[i];var s=t.upperBound[i];for(var l=0;l<a.length;l++){var u=a[l];if(u.aabbNeedsUpdate){u.computeAABB()}if(u.aabb.overlaps(t)){n.push(u)}}return n}},{"../collision/Broadphase":5,"../shapes/Shape":43}],12:[function(e,t,n){t.exports=a;var r=e("./Constraint");var l=e("./PointToPointConstraint");var u=e("../equations/ConeEquation");var h=e("../equations/RotationalEquation");var i=e("../equations/ContactEquation");var c=e("../math/Vec3");function a(e,t,n){n=n||{};var r=typeof n.maxForce!=="undefined"?n.maxForce:1e6;var i=n.pivotA?n.pivotA.clone():new c;var a=n.pivotB?n.pivotB.clone():new c;this.axisA=n.axisA?n.axisA.clone():new c;this.axisB=n.axisB?n.axisB.clone():new c;l.call(this,e,i,t,a,r);this.collideConnected=!!n.collideConnected;this.angle=typeof n.angle!=="undefined"?n.angle:0;var o=this.coneEquation=new u(e,t,n);var s=this.twistEquation=new h(e,t,n);this.twistAngle=typeof n.twistAngle!=="undefined"?n.twistAngle:0;o.maxForce=0;o.minForce=-r;s.maxForce=0;s.minForce=-r;this.equations.push(o,s)}a.prototype=new l;a.constructor=a;var o=new c;var s=new c;a.prototype.update=function(){var e=this.bodyA,t=this.bodyB,n=this.coneEquation,r=this.twistEquation;l.prototype.update.call(this);e.vectorToWorldFrame(this.axisA,n.axisA);t.vectorToWorldFrame(this.axisB,n.axisB);this.axisA.tangents(r.axisA,r.axisA);e.vectorToWorldFrame(r.axisA,r.axisA);this.axisB.tangents(r.axisB,r.axisB);t.vectorToWorldFrame(r.axisB,r.axisB);n.angle=this.angle;r.maxAngle=this.twistAngle}},{"../equations/ConeEquation":18,"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],13:[function(e,t,n){t.exports=i;var r=e("../utils/Utils");function i(e,t,n){n=r.defaults(n,{collideConnected:true,wakeUpBodies:true});this.equations=[];this.bodyA=e;this.bodyB=t;this.id=i.idCounter++;this.collideConnected=n.collideConnected;if(n.wakeUpBodies){if(e){e.wakeUp()}if(t){t.wakeUp()}}}i.prototype.update=function(){throw new Error("method update() not implmemented in this Constraint subclass!")};i.prototype.enable=function(){var e=this.equations;for(var t=0;t<e.length;t++){e[t].enabled=true}};i.prototype.disable=function(){var e=this.equations;for(var t=0;t<e.length;t++){e[t].enabled=false}};i.idCounter=0},{"../utils/Utils":53}],14:[function(e,t,n){t.exports=r;var a=e("./Constraint");var o=e("../equations/ContactEquation");function r(e,t,n,r){a.call(this,e,t);if(typeof n==="undefined"){n=e.position.distanceTo(t.position)}if(typeof r==="undefined"){r=1e6}this.distance=n;var i=this.distanceEquation=new o(e,t);this.equations.push(i);i.minForce=-r;i.maxForce=r}r.prototype=new a;r.prototype.update=function(){var e=this.bodyA;var t=this.bodyB;var n=this.distanceEquation;var r=this.distance*.5;var i=n.ni;t.position.vsub(e.position,i);i.normalize();i.mult(r,n.ri);i.mult(-r,n.rj)}},{"../equations/ContactEquation":19,"./Constraint":13}],15:[function(e,t,n){t.exports=a;var r=e("./Constraint");var c=e("./PointToPointConstraint");var f=e("../equations/RotationalEquation");var p=e("../equations/RotationalMotorEquation");var i=e("../equations/ContactEquation");var d=e("../math/Vec3");function a(e,t,n){n=n||{};var r=typeof n.maxForce!=="undefined"?n.maxForce:1e6;var i=n.pivotA?n.pivotA.clone():new d;var a=n.pivotB?n.pivotB.clone():new d;c.call(this,e,i,t,a,r);var o=this.axisA=n.axisA?n.axisA.clone():new d(1,0,0);o.normalize();var s=this.axisB=n.axisB?n.axisB.clone():new d(1,0,0);s.normalize();var l=this.rotationalEquation1=new f(e,t,n);var u=this.rotationalEquation2=new f(e,t,n);var h=this.motorEquation=new p(e,t,r);h.enabled=false;this.equations.push(l,u,h)}a.prototype=new c;a.constructor=a;a.prototype.enableMotor=function(){this.motorEquation.enabled=true};a.prototype.disableMotor=function(){this.motorEquation.enabled=false};a.prototype.setMotorSpeed=function(e){this.motorEquation.targetVelocity=e};a.prototype.setMotorMaxForce=function(e){this.motorEquation.maxForce=e;this.motorEquation.minForce=-e};var u=new d;var h=new d;a.prototype.update=function(){var e=this.bodyA,t=this.bodyB,n=this.motorEquation,r=this.rotationalEquation1,i=this.rotationalEquation2,a=u,o=h;var s=this.axisA;var l=this.axisB;c.prototype.update.call(this);e.quaternion.vmult(s,a);t.quaternion.vmult(l,o);a.tangents(r.axisA,i.axisA);r.axisB.copy(o);i.axisB.copy(o);if(this.motorEquation.enabled){e.quaternion.vmult(this.axisA,n.axisA);t.quaternion.vmult(this.axisB,n.axisB)}}},{"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../equations/RotationalMotorEquation":23,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],16:[function(e,t,n){t.exports=o;var r=e("./Constraint");var h=e("./PointToPointConstraint");var c=e("../equations/RotationalEquation");var i=e("../equations/RotationalMotorEquation");var a=e("../equations/ContactEquation");var f=e("../math/Vec3");function o(e,t,n){n=n||{};var r=typeof n.maxForce!=="undefined"?n.maxForce:1e6;var i=new f;var a=new f;var o=new f;e.position.vadd(t.position,o);o.scale(.5,o);t.pointToLocalFrame(o,a);e.pointToLocalFrame(o,i);h.call(this,e,i,t,a,r);var s=this.rotationalEquation1=new c(e,t,n);var l=this.rotationalEquation2=new c(e,t,n);var u=this.rotationalEquation3=new c(e,t,n);this.equations.push(s,l,u)}o.prototype=new h;o.constructor=o;var s=new f;var l=new f;o.prototype.update=function(){var e=this.bodyA,t=this.bodyB,n=this.motorEquation,r=this.rotationalEquation1,i=this.rotationalEquation2,a=this.rotationalEquation3;h.prototype.update.call(this);e.vectorToWorldFrame(f.UNIT_X,r.axisA);t.vectorToWorldFrame(f.UNIT_Y,r.axisB);e.vectorToWorldFrame(f.UNIT_Y,i.axisA);t.vectorToWorldFrame(f.UNIT_Z,i.axisB);e.vectorToWorldFrame(f.UNIT_Z,a.axisA);t.vectorToWorldFrame(f.UNIT_X,a.axisB)}},{"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../equations/RotationalMotorEquation":23,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],17:[function(e,t,n){t.exports=r;var l=e("./Constraint");var u=e("../equations/ContactEquation");var h=e("../math/Vec3");function r(e,t,n,r,i){l.call(this,e,n);i=typeof i!=="undefined"?i:1e6;this.pivotA=t?t.clone():new h;this.pivotB=r?r.clone():new h;var a=this.equationX=new u(e,n);var o=this.equationY=new u(e,n);var s=this.equationZ=new u(e,n);this.equations.push(a,o,s);a.minForce=o.minForce=s.minForce=-i;a.maxForce=o.maxForce=s.maxForce=i;a.ni.set(1,0,0);o.ni.set(0,1,0);s.ni.set(0,0,1)}r.prototype=new l;r.prototype.update=function(){var e=this.bodyA;var t=this.bodyB;var n=this.equationX;var r=this.equationY;var i=this.equationZ;e.quaternion.vmult(this.pivotA,n.ri);t.quaternion.vmult(this.pivotB,n.rj);r.ri.copy(n.ri);r.rj.copy(n.rj);i.ri.copy(n.ri);i.rj.copy(n.rj)}},{"../equations/ContactEquation":19,"../math/Vec3":30,"./Constraint":13}],18:[function(e,t,n){t.exports=o;var i=e("../math/Vec3");var r=e("../math/Mat3");var a=e("./Equation");function o(e,t,n){n=n||{};var r=typeof n.maxForce!=="undefined"?n.maxForce:1e6;a.call(this,e,t,-r,r);this.axisA=n.axisA?n.axisA.clone():new i(1,0,0);this.axisB=n.axisB?n.axisB.clone():new i(0,1,0);this.angle=typeof n.angle!=="undefined"?n.angle:0}o.prototype=new a;o.prototype.constructor=o;var p=new i;var d=new i;o.prototype.computeB=function(e){var t=this.a,n=this.b,r=this.axisA,i=this.axisB,a=p,o=d,s=this.jacobianElementA,l=this.jacobianElementB;r.cross(i,a);i.cross(r,o);s.rotational.copy(o);l.rotational.copy(a);var u=Math.cos(this.angle)-r.dot(i),h=this.computeGW(),c=this.computeGiMf();var f=-u*t-h*n-e*c;return f}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],19:[function(e,t,n){t.exports=o;var r=e("./Equation");var i=e("../math/Vec3");var a=e("../math/Mat3");function o(e,t,n){n=typeof n!=="undefined"?n:1e6;r.call(this,e,t,0,n);this.restitution=0;this.ri=new i;this.rj=new i;this.ni=new i}o.prototype=new r;o.prototype.constructor=o;var A=new i;var M=new i;var R=new i;o.prototype.computeB=function(e){var t=this.a,n=this.b,r=this.bi,i=this.bj,a=this.ri,o=this.rj,s=A,l=M,u=r.velocity,h=r.angularVelocity,c=r.force,f=r.torque,p=i.velocity,d=i.angularVelocity,v=i.force,m=i.torque,_=R,g=this.jacobianElementA,y=this.jacobianElementB,x=this.ni;a.cross(x,s);o.cross(x,l);x.negate(g.spatial);s.negate(g.rotational);y.spatial.copy(x);y.rotational.copy(l);_.copy(i.position);_.vadd(o,_);_.vsub(r.position,_);_.vsub(a,_);var b=x.dot(_);var w=this.restitution+1;var E=w*p.dot(x)-w*u.dot(x)+d.dot(l)-h.dot(s);var T=this.computeGiMf();var S=-b*t-E*n-e*T;return S};var s=new i;var l=new i;var u=new i;var h=new i;var c=new i;o.prototype.getImpactVelocityAlongNormal=function(){var e=s;var t=l;var n=u;var r=h;var i=c;this.bi.position.vadd(this.ri,n);this.bj.position.vadd(this.rj,r);this.bi.getVelocityAtWorldPoint(n,e);this.bj.getVelocityAtWorldPoint(r,t);e.vsub(t,i);return this.ni.dot(i)}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],20:[function(e,t,n){t.exports=a;var i=e("../math/JacobianElement"),r=e("../math/Vec3");function a(e,t,n,r){this.id=a.id++;this.minForce=typeof n==="undefined"?-1e6:n;this.maxForce=typeof r==="undefined"?1e6:r;this.bi=e;this.bj=t;this.a=0;this.b=0;this.eps=0;this.jacobianElementA=new i;this.jacobianElementB=new i;this.enabled=true;this.setSpookParams(1e7,4,1/60)}a.prototype.constructor=a;a.id=0;a.prototype.setSpookParams=function(e,t,n){var r=t,i=e,a=n;this.a=4/(a*(1+4*r));this.b=4*r/(1+4*r);this.eps=4/(a*a*i*(1+4*r))};a.prototype.computeB=function(e,t,n){var r=this.computeGW(),i=this.computeGq(),a=this.computeGiMf();return-i*e-r*t-a*n};a.prototype.computeGq=function(){var e=this.jacobianElementA,t=this.jacobianElementB,n=this.bi,r=this.bj,i=n.position,a=r.position;return e.spatial.dot(i)+t.spatial.dot(a)};var l=new r;a.prototype.computeGW=function(){var e=this.jacobianElementA,t=this.jacobianElementB,n=this.bi,r=this.bj,i=n.velocity,a=r.velocity,o=n.angularVelocity||l,s=r.angularVelocity||l;return e.multiplyVectors(i,o)+t.multiplyVectors(a,s)};a.prototype.computeGWlambda=function(){var e=this.jacobianElementA,t=this.jacobianElementB,n=this.bi,r=this.bj,i=n.vlambda,a=r.vlambda,o=n.wlambda||l,s=r.wlambda||l;return e.multiplyVectors(i,o)+t.multiplyVectors(a,s)};var h=new r,c=new r,f=new r,p=new r;a.prototype.computeGiMf=function(){var e=this.jacobianElementA,t=this.jacobianElementB,n=this.bi,r=this.bj,i=n.force,a=n.torque,o=r.force,s=r.torque,l=n.invMassSolve,u=r.invMassSolve;if(n.invInertiaWorldSolve){n.invInertiaWorldSolve.vmult(a,f)}else{f.set(0,0,0)}if(r.invInertiaWorldSolve){r.invInertiaWorldSolve.vmult(s,p)}else{p.set(0,0,0)}i.mult(l,h);o.mult(u,c);return e.multiplyVectors(h,f)+t.multiplyVectors(c,p)};var u=new r;a.prototype.computeGiMGt=function(){var e=this.jacobianElementA,t=this.jacobianElementB,n=this.bi,r=this.bj,i=n.invMassSolve,a=r.invMassSolve,o=n.invInertiaWorldSolve,s=r.invInertiaWorldSolve,l=i+a;if(o){o.vmult(e.rotational,u);l+=u.dot(e.rotational)}if(s){s.vmult(t.rotational,u);l+=u.dot(t.rotational)}return l};var o=new r,s=new r,d=new r,v=new r,m=new r,_=new r;a.prototype.addToWlambda=function(e){var t=this.jacobianElementA,n=this.jacobianElementB,r=this.bi,i=this.bj,a=o;t.spatial.mult(r.invMassSolve*e,a);r.vlambda.vadd(a,r.vlambda);n.spatial.mult(i.invMassSolve*e,a);i.vlambda.vadd(a,i.vlambda);if(r.invInertiaWorldSolve){r.invInertiaWorldSolve.vmult(t.rotational,a);a.mult(e,a);r.wlambda.vadd(a,r.wlambda)}if(i.invInertiaWorldSolve){i.invInertiaWorldSolve.vmult(n.rotational,a);a.mult(e,a);i.wlambda.vadd(a,i.wlambda)}};a.prototype.computeC=function(){return this.computeGiMGt()+this.eps}},{"../math/JacobianElement":26,"../math/Vec3":30}],21:[function(e,t,n){t.exports=o;var r=e("./Equation");var i=e("../math/Vec3");var a=e("../math/Mat3");function o(e,t,n){r.call(this,e,t,-n,n);this.ri=new i;this.rj=new i;this.t=new i}o.prototype=new r;o.prototype.constructor=o;var v=new i;var m=new i;o.prototype.computeB=function(e){var t=this.a,n=this.b,r=this.bi,i=this.bj,a=this.ri,o=this.rj,s=v,l=m,u=this.t;a.cross(u,s);o.cross(u,l);var h=this.jacobianElementA,c=this.jacobianElementB;u.negate(h.spatial);s.negate(h.rotational);c.spatial.copy(u);c.rotational.copy(l);var f=this.computeGW();var p=this.computeGiMf();var d=-f*n-e*p;return d}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],22:[function(e,t,n){t.exports=o;var i=e("../math/Vec3");var r=e("../math/Mat3");var a=e("./Equation");function o(e,t,n){n=n||{};var r=typeof n.maxForce!=="undefined"?n.maxForce:1e6;a.call(this,e,t,-r,r);this.axisA=n.axisA?n.axisA.clone():new i(1,0,0);this.axisB=n.axisB?n.axisB.clone():new i(0,1,0);this.maxAngle=Math.PI/2}o.prototype=new a;o.prototype.constructor=o;var p=new i;var d=new i;o.prototype.computeB=function(e){var t=this.a,n=this.b,r=this.axisA,i=this.axisB,a=p,o=d,s=this.jacobianElementA,l=this.jacobianElementB;r.cross(i,a);i.cross(r,o);s.rotational.copy(o);l.rotational.copy(a);var u=Math.cos(this.maxAngle)-r.dot(i),h=this.computeGW(),c=this.computeGiMf();var f=-u*t-h*n-e*c;return f}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],23:[function(e,t,n){t.exports=o;var r=e("../math/Vec3");var i=e("../math/Mat3");var a=e("./Equation");function o(e,t,n){n=typeof n!=="undefined"?n:1e6;a.call(this,e,t,-n,n);this.axisA=new r;this.axisB=new r;this.targetVelocity=0}o.prototype=new a;o.prototype.constructor=o;o.prototype.computeB=function(e){var t=this.a,n=this.b,r=this.bi,i=this.bj,a=this.axisA,o=this.axisB,s=this.jacobianElementA,l=this.jacobianElementB;s.rotational.copy(a);o.negate(l.rotational);var u=this.computeGW()-this.targetVelocity,h=this.computeGiMf();var c=-u*n-e*h;return c}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],24:[function(e,t,n){var r=e("../utils/Utils");t.exports=i;function i(e,t,n){n=r.defaults(n,{friction:.3,restitution:.3,contactEquationStiffness:1e7,contactEquationRelaxation:3,frictionEquationStiffness:1e7,frictionEquationRelaxation:3});this.id=i.idCounter++;this.materials=[e,t];this.friction=n.friction;this.restitution=n.restitution;this.contactEquationStiffness=n.contactEquationStiffness;this.contactEquationRelaxation=n.contactEquationRelaxation;this.frictionEquationStiffness=n.frictionEquationStiffness;this.frictionEquationRelaxation=n.frictionEquationRelaxation}i.idCounter=0},{"../utils/Utils":53}],25:[function(e,t,n){t.exports=r;function r(e){var t="";e=e||{};if(typeof e==="string"){t=e;e={}}else if(typeof e==="object"){t=""}this.name=t;this.id=r.idCounter++;this.friction=typeof e.friction!=="undefined"?e.friction:-1;this.restitution=typeof e.restitution!=="undefined"?e.restitution:-1}r.idCounter=0},{}],26:[function(e,t,n){t.exports=i;var r=e("./Vec3");function i(){this.spatial=new r;this.rotational=new r}i.prototype.multiplyElement=function(e){return e.spatial.dot(this.spatial)+e.rotational.dot(this.rotational)};i.prototype.multiplyVectors=function(e,t){return e.dot(this.spatial)+t.dot(this.rotational)}},{"./Vec3":30}],27:[function(e,t,n){t.exports=p;var d=e("./Vec3");function p(e){if(e){this.elements=e}else{this.elements=[0,0,0,0,0,0,0,0,0]}}p.prototype.identity=function(){var e=this.elements;e[0]=1;e[1]=0;e[2]=0;e[3]=0;e[4]=1;e[5]=0;e[6]=0;e[7]=0;e[8]=1};p.prototype.setZero=function(){var e=this.elements;e[0]=0;e[1]=0;e[2]=0;e[3]=0;e[4]=0;e[5]=0;e[6]=0;e[7]=0;e[8]=0};p.prototype.setTrace=function(e){var t=this.elements;t[0]=e.x;t[4]=e.y;t[8]=e.z};p.prototype.getTrace=function(e){var e=e||new d;var t=this.elements;e.x=t[0];e.y=t[4];e.z=t[8]};p.prototype.vmult=function(e,t){t=t||new d;var n=this.elements,r=e.x,i=e.y,a=e.z;t.x=n[0]*r+n[1]*i+n[2]*a;t.y=n[3]*r+n[4]*i+n[5]*a;t.z=n[6]*r+n[7]*i+n[8]*a;return t};p.prototype.smult=function(e){var t=this;for(var n=0;n<this.elements.length;n++){t.elements[n]*=e}};p.prototype.mmult=function(e,t){var n=this;var r=t||new p;for(var i=0;i<3;i++){for(var a=0;a<3;a++){var o=0;for(var s=0;s<3;s++){o+=e.elements[i+s*3]*n.elements[s+a*3]}r.elements[i+a*3]=o}}return r};p.prototype.scale=function(e,t){t=t||new p;var n=this.elements,r=t.elements;for(var i=0;i!==3;i++){r[3*i+0]=e.x*n[3*i+0];r[3*i+1]=e.y*n[3*i+1];r[3*i+2]=e.z*n[3*i+2]}return t};p.prototype.solve=function(e,t){var n=this;t=t||new d;var r=3;var i=4;var a=[];for(var o=0;o<r*i;o++){a.push(0)}var o,s;for(o=0;o<3;o++){for(s=0;s<3;s++){a[o+i*s]=n.elements[o+3*s]}}a[3+4*0]=e.x;a[3+4*1]=e.y;a[3+4*2]=e.z;var l=3,u=l,h;var c=4;var f;do{o=u-l;if(a[o+i*o]===0){for(s=o+1;s<u;s++){if(a[o+i*s]!==0){h=c;do{f=c-h;a[f+i*o]+=a[f+i*s]}while(--h);break}}}if(a[o+i*o]!==0){for(s=o+1;s<u;s++){var p=a[o+i*s]/a[o+i*o];h=c;do{f=c-h;a[f+i*s]=f<=o?0:a[f+i*s]-a[f+i*o]*p}while(--h)}}}while(--l);t.z=a[2*i+3]/a[2*i+2];t.y=(a[1*i+3]-a[1*i+2]*t.z)/a[1*i+1];t.x=(a[0*i+3]-a[0*i+2]*t.z-a[0*i+1]*t.y)/a[0*i+0];if(isNaN(t.x)||isNaN(t.y)||isNaN(t.z)||t.x===Infinity||t.y===Infinity||t.z===Infinity){throw"Could not solve equation! Got x=["+t.toString()+"], b=["+e.toString()+"], A=["+this.toString()+"]"}return t};p.prototype.e=function(e,t,n){if(n===undefined){return this.elements[t+3*e]}else{this.elements[t+3*e]=n}};p.prototype.copy=function(e){var t=this;for(var n=0;n<e.elements.length;n++){t.elements[n]=e.elements[n]}return this};p.prototype.toString=function(){var e=this;var t="";var n=",";for(var r=0;r<9;r++){t+=e.elements[r]+n}return t};p.prototype.reverse=function(e){var t=this;e=e||new p;var n=3;var r=6;var i=[];for(var a=0;a<n*r;a++){i.push(0)}var a,o;for(a=0;a<3;a++){for(o=0;o<3;o++){i[a+r*o]=t.elements[a+3*o]}}i[3+6*0]=1;i[3+6*1]=0;i[3+6*2]=0;i[4+6*0]=0;i[4+6*1]=1;i[4+6*2]=0;i[5+6*0]=0;i[5+6*1]=0;i[5+6*2]=1;var s=3,l=s,u;var h=r;var c;do{a=l-s;if(i[a+r*a]===0){for(o=a+1;o<l;o++){if(i[a+r*o]!==0){u=h;do{c=h-u;i[c+r*a]+=i[c+r*o]}while(--u);break}}}if(i[a+r*a]!==0){for(o=a+1;o<l;o++){var f=i[a+r*o]/i[a+r*a];u=h;do{c=h-u;i[c+r*o]=c<=a?0:i[c+r*o]-i[c+r*a]*f}while(--u)}}}while(--s);a=2;do{o=a-1;do{var f=i[a+r*o]/i[a+r*a];u=r;do{c=r-u;i[c+r*o]=i[c+r*o]-i[c+r*a]*f}while(--u)}while(o--)}while(--a);a=2;do{var f=1/i[a+r*a];u=r;do{c=r-u;i[c+r*a]=i[c+r*a]*f}while(--u)}while(a--);a=2;do{o=2;do{c=i[n+o+r*a];if(isNaN(c)||c===Infinity){throw"Could not reverse! A=["+t.toString()+"]"}e.e(a,o,c)}while(o--)}while(a--);return e};p.prototype.setRotationFromQuaternion=function(e){var t=e.x,n=e.y,r=e.z,i=e.w,a=t+t,o=n+n,s=r+r,l=t*a,u=t*o,h=t*s,c=n*o,f=n*s,p=r*s,d=i*a,v=i*o,m=i*s,_=this.elements;_[3*0+0]=1-(c+p);_[3*0+1]=u-m;_[3*0+2]=h+v;_[3*1+0]=u+m;_[3*1+1]=1-(l+p);_[3*1+2]=f-d;_[3*2+0]=h-v;_[3*2+1]=f+d;_[3*2+2]=1-(l+c);return this};p.prototype.transpose=function(e){e=e||new p;var t=e.elements,n=this.elements;for(var r=0;r!==3;r++){for(var i=0;i!==3;i++){t[3*r+i]=n[3*i+r]}}return e}},{"./Vec3":30}],28:[function(e,t,n){t.exports=o;var p=e("./Vec3");function o(e,t,n,r){this.x=e!==undefined?e:0;this.y=t!==undefined?t:0;this.z=n!==undefined?n:0;this.w=r!==undefined?r:1}o.prototype.set=function(e,t,n,r){this.x=e;this.y=t;this.z=n;this.w=r};o.prototype.toString=function(){return this.x+","+this.y+","+this.z+","+this.w};o.prototype.toArray=function(){return[this.x,this.y,this.z,this.w]};o.prototype.setFromAxisAngle=function(e,t){var n=Math.sin(t*.5);this.x=e.x*n;this.y=e.y*n;this.z=e.z*n;this.w=Math.cos(t*.5)};o.prototype.toAxisAngle=function(e){e=e||new p;this.normalize();var t=2*Math.acos(this.w);var n=Math.sqrt(1-this.w*this.w);if(n<.001){e.x=this.x;e.y=this.y;e.z=this.z}else{e.x=this.x/n;e.y=this.y/n;e.z=this.z/n}return[e,t]};var a=new p,s=new p;o.prototype.setFromVectors=function(e,t){if(e.isAntiparallelTo(t)){var n=a;var r=s;e.tangents(n,r);this.setFromAxisAngle(n,Math.PI)}else{var i=e.cross(t);this.x=i.x;this.y=i.y;this.z=i.z;this.w=Math.sqrt(Math.pow(e.norm(),2)*Math.pow(t.norm(),2))+e.dot(t);this.normalize()}};var l=new p;var u=new p;var h=new p;o.prototype.mult=function(e,t){t=t||new o;var n=this.w,r=l,i=u,a=h;r.set(this.x,this.y,this.z);i.set(e.x,e.y,e.z);t.w=n*e.w-r.dot(i);r.cross(i,a);t.x=n*i.x+e.w*r.x+a.x;t.y=n*i.y+e.w*r.y+a.y;t.z=n*i.z+e.w*r.z+a.z;return t};o.prototype.inverse=function(e){var t=this.x,n=this.y,r=this.z,i=this.w;e=e||new o;this.conjugate(e);var a=1/(t*t+n*n+r*r+i*i);e.x*=a;e.y*=a;e.z*=a;e.w*=a;return e};o.prototype.conjugate=function(e){e=e||new o;e.x=-this.x;e.y=-this.y;e.z=-this.z;e.w=this.w;return e};o.prototype.normalize=function(){var e=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);if(e===0){this.x=0;this.y=0;this.z=0;this.w=0}else{e=1/e;this.x*=e;this.y*=e;this.z*=e;this.w*=e}};o.prototype.normalizeFast=function(){var e=(3-(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w))/2;if(e===0){this.x=0;this.y=0;this.z=0;this.w=0}else{this.x*=e;this.y*=e;this.z*=e;this.w*=e}};o.prototype.vmult=function(e,t){t=t||new p;var n=e.x,r=e.y,i=e.z;var a=this.x,o=this.y,s=this.z,l=this.w;var u=l*n+o*i-s*r,h=l*r+s*n-a*i,c=l*i+a*r-o*n,f=-a*n-o*r-s*i;t.x=u*l+f*-a+h*-s-c*-o;t.y=h*l+f*-o+c*-a-u*-s;t.z=c*l+f*-s+u*-o-h*-a;return t};o.prototype.copy=function(e){this.x=e.x;this.y=e.y;this.z=e.z;this.w=e.w;return this};o.prototype.toEuler=function(e,t){t=t||"YZX";var n,r,i;var a=this.x,o=this.y,s=this.z,l=this.w;switch(t){case"YZX":var u=a*o+s*l;if(u>.499){n=2*Math.atan2(a,l);r=Math.PI/2;i=0}if(u<-.499){n=-2*Math.atan2(a,l);r=-Math.PI/2;i=0}if(isNaN(n)){var h=a*a;var c=o*o;var f=s*s;n=Math.atan2(2*o*l-2*a*s,1-2*c-2*f);r=Math.asin(2*u);i=Math.atan2(2*a*l-2*o*s,1-2*h-2*f)}break;default:throw new Error("Euler order "+t+" not supported yet.")}e.y=n;e.z=r;e.x=i};o.prototype.setFromEuler=function(e,t,n,r){r=r||"XYZ";var i=Math.cos(e/2);var a=Math.cos(t/2);var o=Math.cos(n/2);var s=Math.sin(e/2);var l=Math.sin(t/2);var u=Math.sin(n/2);if(r==="XYZ"){this.x=s*a*o+i*l*u;this.y=i*l*o-s*a*u;this.z=i*a*u+s*l*o;this.w=i*a*o-s*l*u}else if(r==="YXZ"){this.x=s*a*o+i*l*u;this.y=i*l*o-s*a*u;this.z=i*a*u-s*l*o;this.w=i*a*o+s*l*u}else if(r==="ZXY"){this.x=s*a*o-i*l*u;this.y=i*l*o+s*a*u;this.z=i*a*u+s*l*o;this.w=i*a*o-s*l*u}else if(r==="ZYX"){this.x=s*a*o-i*l*u;this.y=i*l*o+s*a*u;this.z=i*a*u-s*l*o;this.w=i*a*o+s*l*u}else if(r==="YZX"){this.x=s*a*o+i*l*u;this.y=i*l*o+s*a*u;this.z=i*a*u-s*l*o;this.w=i*a*o-s*l*u}else if(r==="XZY"){this.x=s*a*o-i*l*u;this.y=i*l*o-s*a*u;this.z=i*a*u+s*l*o;this.w=i*a*o+s*l*u}return this};o.prototype.clone=function(){return new o(this.x,this.y,this.z,this.w)}},{"./Vec3":30}],29:[function(e,t,n){var i=e("./Vec3");var r=e("./Quaternion");t.exports=a;function a(e){e=e||{};this.position=new i;if(e.position){this.position.copy(e.position)}this.quaternion=new r;if(e.quaternion){this.quaternion.copy(e.quaternion)}}var o=new r;a.pointToLocalFrame=function(e,t,n,r){var r=r||new i;n.vsub(e,r);t.conjugate(o);o.vmult(r,r);return r};a.prototype.pointToLocal=function(e,t){return a.pointToLocalFrame(this.position,this.quaternion,e,t)};a.pointToWorldFrame=function(e,t,n,r){var r=r||new i;t.vmult(n,r);r.vadd(e,r);return r};a.prototype.pointToWorld=function(e,t){return a.pointToWorldFrame(this.position,this.quaternion,e,t)};a.prototype.vectorToWorldFrame=function(e,t){var t=t||new i;this.quaternion.vmult(e,t);return t};a.vectorToWorldFrame=function(e,t,n){e.vmult(t,n);return n};a.vectorToLocalFrame=function(e,t,n,r){var r=r||new i;t.w*=-1;t.vmult(n,r);t.w*=-1;return r}},{"./Quaternion":28,"./Vec3":30}],30:[function(e,t,n){t.exports=l;var r=e("./Mat3");function l(e,t,n){this.x=e||0;this.y=t||0;this.z=n||0}l.ZERO=new l(0,0,0);l.UNIT_X=new l(1,0,0);l.UNIT_Y=new l(0,1,0);l.UNIT_Z=new l(0,0,1);l.prototype.cross=function(e,t){var n=e.x,r=e.y,i=e.z,a=this.x,o=this.y,s=this.z;t=t||new l;t.x=o*i-s*r;t.y=s*n-a*i;t.z=a*r-o*n;return t};l.prototype.set=function(e,t,n){this.x=e;this.y=t;this.z=n;return this};l.prototype.setZero=function(){this.x=this.y=this.z=0};l.prototype.vadd=function(e,t){if(t){t.x=e.x+this.x;t.y=e.y+this.y;t.z=e.z+this.z}else{return new l(this.x+e.x,this.y+e.y,this.z+e.z)}};l.prototype.vsub=function(e,t){if(t){t.x=this.x-e.x;t.y=this.y-e.y;t.z=this.z-e.z}else{return new l(this.x-e.x,this.y-e.y,this.z-e.z)}};l.prototype.crossmat=function(){return new r([0,-this.z,this.y,this.z,0,-this.x,-this.y,this.x,0])};l.prototype.normalize=function(){var e=this.x,t=this.y,n=this.z;var r=Math.sqrt(e*e+t*t+n*n);if(r>0){var i=1/r;this.x*=i;this.y*=i;this.z*=i}else{this.x=0;this.y=0;this.z=0}return r};l.prototype.unit=function(e){e=e||new l;var t=this.x,n=this.y,r=this.z;var i=Math.sqrt(t*t+n*n+r*r);if(i>0){i=1/i;e.x=t*i;e.y=n*i;e.z=r*i}else{e.x=1;e.y=0;e.z=0}return e};l.prototype.norm=function(){var e=this.x,t=this.y,n=this.z;return Math.sqrt(e*e+t*t+n*n)};l.prototype.length=l.prototype.norm;l.prototype.norm2=function(){return this.dot(this)};l.prototype.lengthSquared=l.prototype.norm2;l.prototype.distanceTo=function(e){var t=this.x,n=this.y,r=this.z;var i=e.x,a=e.y,o=e.z;return Math.sqrt((i-t)*(i-t)+(a-n)*(a-n)+(o-r)*(o-r))};l.prototype.distanceSquared=function(e){var t=this.x,n=this.y,r=this.z;var i=e.x,a=e.y,o=e.z;return(i-t)*(i-t)+(a-n)*(a-n)+(o-r)*(o-r)};l.prototype.mult=function(e,t){t=t||new l;var n=this.x,r=this.y,i=this.z;t.x=e*n;t.y=e*r;t.z=e*i;return t};l.prototype.scale=l.prototype.mult;l.prototype.dot=function(e){return this.x*e.x+this.y*e.y+this.z*e.z};l.prototype.isZero=function(){return this.x===0&&this.y===0&&this.z===0};l.prototype.negate=function(e){e=e||new l;e.x=-this.x;e.y=-this.y;e.z=-this.z;return e};var o=new l;var s=new l;l.prototype.tangents=function(e,t){var n=this.norm();if(n>0){var r=o;var i=1/n;r.set(this.x*i,this.y*i,this.z*i);var a=s;if(Math.abs(r.x)<.9){a.set(1,0,0);r.cross(a,e)}else{a.set(0,1,0);r.cross(a,e)}r.cross(e,t)}else{e.set(1,0,0);t.set(0,1,0)}};l.prototype.toString=function(){return this.x+","+this.y+","+this.z};l.prototype.toArray=function(){return[this.x,this.y,this.z]};l.prototype.copy=function(e){this.x=e.x;this.y=e.y;this.z=e.z;return this};l.prototype.lerp=function(e,t,n){var r=this.x,i=this.y,a=this.z;n.x=r+(e.x-r)*t;n.y=i+(e.y-i)*t;n.z=a+(e.z-a)*t};l.prototype.almostEquals=function(e,t){if(t===undefined){t=1e-6}if(Math.abs(this.x-e.x)>t||Math.abs(this.y-e.y)>t||Math.abs(this.z-e.z)>t){return false}return true};l.prototype.almostZero=function(e){if(e===undefined){e=1e-6}if(Math.abs(this.x)>e||Math.abs(this.y)>e||Math.abs(this.z)>e){return false}return true};var i=new l;l.prototype.isAntiparallelTo=function(e,t){this.negate(i);return i.almostEquals(e,t)};l.prototype.clone=function(){return new l(this.x,this.y,this.z)}},{"./Mat3":27}],31:[function(e,t,n){t.exports=c;var r=e("../utils/EventTarget");var i=e("../shapes/Shape");var a=e("../math/Vec3");var o=e("../math/Mat3");var s=e("../math/Quaternion");var l=e("../material/Material");var u=e("../collision/AABB");var h=e("../shapes/Box");function c(e){e=e||{};r.apply(this);this.id=c.idCounter++;this.world=null;this.preStep=null;this.postStep=null;this.vlambda=new a;this.collisionFilterGroup=typeof e.collisionFilterGroup==="number"?e.collisionFilterGroup:1;this.collisionFilterMask=typeof e.collisionFilterMask==="number"?e.collisionFilterMask:1;this.collisionResponse=true;this.position=new a;if(e.position){this.position.copy(e.position)}this.previousPosition=new a;this.initPosition=new a;this.velocity=new a;if(e.velocity){this.velocity.copy(e.velocity)}this.initVelocity=new a;this.force=new a;var t=typeof e.mass==="number"?e.mass:0;this.mass=t;this.invMass=t>0?1/t:0;this.material=e.material||null;this.linearDamping=typeof e.linearDamping==="number"?e.linearDamping:.01;this.type=t<=0?c.STATIC:c.DYNAMIC;if(typeof e.type===typeof c.STATIC){this.type=e.type}this.allowSleep=typeof e.allowSleep!=="undefined"?e.allowSleep:true;this.sleepState=0;this.sleepSpeedLimit=typeof e.sleepSpeedLimit!=="undefined"?e.sleepSpeedLimit:.1;this.sleepTimeLimit=typeof e.sleepTimeLimit!=="undefined"?e.sleepTimeLimit:1;this.timeLastSleepy=0;this._wakeUpAfterNarrowphase=false;this.torque=new a;this.quaternion=new s;if(e.quaternion){this.quaternion.copy(e.quaternion)}this.initQuaternion=new s;this.angularVelocity=new a;if(e.angularVelocity){this.angularVelocity.copy(e.angularVelocity)}this.initAngularVelocity=new a;this.interpolatedPosition=new a;this.interpolatedQuaternion=new s;this.shapes=[];this.shapeOffsets=[];this.shapeOrientations=[];this.inertia=new a;this.invInertia=new a;this.invInertiaWorld=new o;this.invMassSolve=0;this.invInertiaSolve=new a;this.invInertiaWorldSolve=new o;this.fixedRotation=typeof e.fixedRotation!=="undefined"?e.fixedRotation:false;this.angularDamping=typeof e.angularDamping!=="undefined"?e.angularDamping:.01;this.aabb=new u;this.aabbNeedsUpdate=true;this.wlambda=new a;if(e.shape){this.addShape(e.shape)}this.updateMassProperties()}c.prototype=new r;c.prototype.constructor=c;c.DYNAMIC=1;c.STATIC=2;c.KINEMATIC=4;c.AWAKE=0;c.SLEEPY=1;c.SLEEPING=2;c.idCounter=0;c.prototype.wakeUp=function(){var e=this.sleepState;this.sleepState=0;if(e===c.SLEEPING){this.dispatchEvent({type:"wakeup"})}};c.prototype.sleep=function(){this.sleepState=c.SLEEPING;this.velocity.set(0,0,0);this.angularVelocity.set(0,0,0)};c.sleepyEvent={type:"sleepy"};c.sleepEvent={type:"sleep"};c.prototype.sleepTick=function(e){if(this.allowSleep){var t=this.sleepState;var n=this.velocity.norm2()+this.angularVelocity.norm2();var r=Math.pow(this.sleepSpeedLimit,2);if(t===c.AWAKE&&n<r){this.sleepState=c.SLEEPY;this.timeLastSleepy=e;this.dispatchEvent(c.sleepyEvent)}else if(t===c.SLEEPY&&n>r){this.wakeUp()}else if(t===c.SLEEPY&&e-this.timeLastSleepy>this.sleepTimeLimit){this.sleep();this.dispatchEvent(c.sleepEvent)}}};c.prototype.updateSolveMassProperties=function(){if(this.sleepState===c.SLEEPING||this.type===c.KINEMATIC){this.invMassSolve=0;this.invInertiaSolve.setZero();this.invInertiaWorldSolve.setZero()}else{this.invMassSolve=this.invMass;this.invInertiaSolve.copy(this.invInertia);this.invInertiaWorldSolve.copy(this.invInertiaWorld)}};c.prototype.pointToLocalFrame=function(e,t){var t=t||new a;e.vsub(this.position,t);this.quaternion.conjugate().vmult(t,t);return t};c.prototype.vectorToLocalFrame=function(e,t){var t=t||new a;this.quaternion.conjugate().vmult(e,t);return t};c.prototype.pointToWorldFrame=function(e,t){var t=t||new a;this.quaternion.vmult(e,t);t.vadd(this.position,t);return t};c.prototype.vectorToWorldFrame=function(e,t){var t=t||new a;this.quaternion.vmult(e,t);return t};var f=new a;var p=new s;c.prototype.addShape=function(e,t,n){var r=new a;var i=new s;if(t){r.copy(t)}if(n){i.copy(n)}this.shapes.push(e);this.shapeOffsets.push(r);this.shapeOrientations.push(i);this.updateMassProperties();this.updateBoundingRadius();this.aabbNeedsUpdate=true;return this};c.prototype.updateBoundingRadius=function(){var e=this.shapes,t=this.shapeOffsets,n=e.length,r=0;for(var i=0;i!==n;i++){var a=e[i];a.updateBoundingSphereRadius();var o=t[i].norm(),s=a.boundingSphereRadius;if(o+s>r){r=o+s}}this.boundingRadius=r};var d=new u;c.prototype.computeAABB=function(){var e=this;var t=this.shapes,n=this.shapeOffsets,r=this.shapeOrientations,i=t.length,a=f,o=p,s=this.quaternion,l=this.aabb,u=d;for(var h=0;h!==i;h++){var c=t[h];r[h].mult(s,o);o.vmult(n[h],a);a.vadd(e.position,a);c.calculateWorldAABB(a,o,u.lowerBound,u.upperBound);if(h===0){l.copy(u)}else{l.extend(u)}}this.aabbNeedsUpdate=false};var v=new o,m=new o,_=new o;c.prototype.updateInertiaWorld=function(e){var t=this.invInertia;if(t.x===t.y&&t.y===t.z&&!e){}else{var n=v,r=m;n.setRotationFromQuaternion(this.quaternion);n.transpose(r);n.scale(t,n);n.mmult(r,this.invInertiaWorld)}};var g=new a;var y=new a;c.prototype.applyForce=function(e,t){if(this.type!==c.DYNAMIC){return}var n=g;t.vsub(this.position,n);var r=y;n.cross(e,r);this.force.vadd(e,this.force);this.torque.vadd(r,this.torque)};var x=new a;var b=new a;c.prototype.applyLocalForce=function(e,t){if(this.type!==c.DYNAMIC){return}var n=x;var r=b;this.vectorToWorldFrame(e,n);this.pointToWorldFrame(t,r);this.applyForce(n,r)};var w=new a;var E=new a;var T=new a;c.prototype.applyImpulse=function(e,t){if(this.type!==c.DYNAMIC){return}var n=w;t.vsub(this.position,n);var r=E;r.copy(e);r.mult(this.invMass,r);this.velocity.vadd(r,this.velocity);var i=T;n.cross(e,i);this.invInertiaWorld.vmult(i,i);this.angularVelocity.vadd(i,this.angularVelocity)};var S=new a;var A=new a;c.prototype.applyLocalImpulse=function(e,t){if(this.type!==c.DYNAMIC){return}var n=S;var r=A;this.vectorToWorldFrame(e,n);this.pointToWorldFrame(t,r);this.applyImpulse(n,r)};var M=new a;c.prototype.updateMassProperties=function(){var e=M;this.invMass=this.mass>0?1/this.mass:0;var t=this.inertia;var n=this.fixedRotation;this.computeAABB();e.set((this.aabb.upperBound.x-this.aabb.lowerBound.x)/2,(this.aabb.upperBound.y-this.aabb.lowerBound.y)/2,(this.aabb.upperBound.z-this.aabb.lowerBound.z)/2);h.calculateInertia(e,this.mass,t);this.invInertia.set(t.x>0&&!n?1/t.x:0,t.y>0&&!n?1/t.y:0,t.z>0&&!n?1/t.z:0);this.updateInertiaWorld(true)};c.prototype.getVelocityAtWorldPoint=function(e,t){var n=new a;e.vsub(this.position,n);this.angularVelocity.cross(n,t);this.velocity.vadd(t,t);return t}},{"../collision/AABB":3,"../material/Material":25,"../math/Mat3":27,"../math/Quaternion":28,"../math/Vec3":30,"../shapes/Box":37,"../shapes/Shape":43,"../utils/EventTarget":49}],32:[function(e,t,n){var r=e("./Body");var O=e("../math/Vec3");var h=e("../math/Quaternion");var i=e("../collision/RaycastResult");var a=e("../collision/Ray");var o=e("../objects/WheelInfo");t.exports=s;function s(e){this.chassisBody=e.chassisBody;this.wheelInfos=[];this.sliding=false;this.world=null;this.indexRightAxis=typeof e.indexRightAxis!=="undefined"?e.indexRightAxis:1;this.indexForwardAxis=typeof e.indexForwardAxis!=="undefined"?e.indexForwardAxis:0;this.indexUpAxis=typeof e.indexUpAxis!=="undefined"?e.indexUpAxis:2}var l=new O;var u=new O;var c=new O;var f=new O;var p=new O;var d=new O;var v=new a;s.prototype.addWheel=function(e){e=e||{};var t=new o(e);var n=this.wheelInfos.length;this.wheelInfos.push(t);return n};s.prototype.setSteeringValue=function(e,t){var n=this.wheelInfos[t];n.steering=e};var m=new O;s.prototype.applyEngineForce=function(e,t){this.wheelInfos[t].engineForce=e};s.prototype.setBrake=function(e,t){this.wheelInfos[t].brake=e};s.prototype.addToWorld=function(e){var t=this.constraints;e.add(this.chassisBody);var n=this;this.preStepCallback=function(){n.updateVehicle(e.dt)};e.addEventListener("preStep",this.preStepCallback);this.world=e};s.prototype.getVehicleAxisWorld=function(e,t){t.set(e===0?1:0,e===1?1:0,e===2?1:0);this.chassisBody.vectorToWorldFrame(t,t)};s.prototype.updateVehicle=function(e){var t=this;var n=this.wheelInfos;var r=n.length;var i=this.chassisBody;for(var a=0;a<r;a++){t.updateWheelTransform(a)}this.currentVehicleSpeedKmHour=3.6*i.velocity.norm();var o=new O;this.getVehicleAxisWorld(this.indexForwardAxis,o);if(o.dot(i.velocity)<0){this.currentVehicleSpeedKmHour*=-1}for(var a=0;a<r;a++){t.castRay(n[a])}this.updateSuspension(e);var s=new O;var l=new O;for(var a=0;a<r;a++){var u=n[a];var h=u.suspensionForce;if(h>u.maxSuspensionForce){h=u.maxSuspensionForce}u.raycastResult.hitNormalWorld.scale(h*e,s);u.raycastResult.hitPointWorld.vsub(i.position,l);i.applyImpulse(s,u.raycastResult.hitPointWorld)}this.updateFriction(e);var c=new O;var f=new O;var p=new O;for(a=0;a<r;a++){var u=n[a];i.getVelocityAtWorldPoint(u.chassisConnectionPointWorld,p);var d=1;switch(t.indexUpAxis){case 1:d=-1;break}if(u.isInContact){t.getVehicleAxisWorld(t.indexForwardAxis,f);var v=f.dot(u.raycastResult.hitNormalWorld);u.raycastResult.hitNormalWorld.scale(v,c);f.vsub(c,f);var m=f.dot(p);u.deltaRotation=d*m*e/u.radius}if((u.sliding||!u.isInContact)&&u.engineForce!==0&&u.useCustomSlidingRotationalSpeed){u.deltaRotation=(u.engineForce>0?1:-1)*u.customSlidingRotationalSpeed*e}if(Math.abs(u.brake)>Math.abs(u.engineForce)){u.deltaRotation=0}u.rotation+=u.deltaRotation;u.deltaRotation*=.99}};s.prototype.updateSuspension=function(e){var t=this.chassisBody;var n=t.mass;var r=this.wheelInfos;var i=r.length;for(var a=0;a<i;a++){var o=r[a];if(o.isInContact){var s;var l=o.suspensionRestLength;var u=o.suspensionLength;var h=l-u;s=o.suspensionStiffness*h*o.clippedInvContactDotSuspension;var c=o.suspensionRelativeVelocity;var f;if(c<0){f=o.dampingCompression}else{f=o.dampingRelaxation}s-=f*c;o.suspensionForce=s*n;if(o.suspensionForce<0){o.suspensionForce=0}}else{o.suspensionForce=0}}};s.prototype.removeFromWorld=function(e){var t=this.constraints;e.remove(this.chassisBody);e.removeEventListener("preStep",this.preStepCallback);this.world=null};var _=new O;var g=new O;s.prototype.castRay=function(e){var t=_;var n=g;this.updateWheelTransformWorld(e);var r=this.chassisBody;var i=-1;var a=e.suspensionRestLength+e.radius;e.directionWorld.scale(a,t);var o=e.chassisConnectionPointWorld;o.vadd(t,n);var s=e.raycastResult;s.reset();var l=r.collisionResponse;r.collisionResponse=false;this.world.rayTest(o,n,s);r.collisionResponse=l;var u=s.body;e.raycastResult.groundObject=0;if(u){i=s.distance;e.raycastResult.hitNormalWorld=s.hitNormalWorld;e.isInContact=true;var h=s.distance;e.suspensionLength=h-e.radius;var c=e.suspensionRestLength-e.maxSuspensionTravel;var f=e.suspensionRestLength+e.maxSuspensionTravel;if(e.suspensionLength<c){e.suspensionLength=c}if(e.suspensionLength>f){e.suspensionLength=f;e.raycastResult.reset()}var p=e.raycastResult.hitNormalWorld.dot(e.directionWorld);var d=new O;r.getVelocityAtWorldPoint(e.raycastResult.hitPointWorld,d);var v=e.raycastResult.hitNormalWorld.dot(d);if(p>=-.1){e.suspensionRelativeVelocity=0;e.clippedInvContactDotSuspension=1/.1}else{var m=-1/p;e.suspensionRelativeVelocity=v*m;e.clippedInvContactDotSuspension=m}}else{e.suspensionLength=e.suspensionRestLength+0*e.maxSuspensionTravel;e.suspensionRelativeVelocity=0;e.directionWorld.scale(-1,e.raycastResult.hitNormalWorld);e.clippedInvContactDotSuspension=1}return i};s.prototype.updateWheelTransformWorld=function(e){e.isInContact=false;var t=this.chassisBody;t.pointToWorldFrame(e.chassisConnectionPointLocal,e.chassisConnectionPointWorld);t.vectorToWorldFrame(e.directionLocal,e.directionWorld);t.vectorToWorldFrame(e.axleLocal,e.axleWorld)};s.prototype.updateWheelTransform=function(e){var t=f;var n=p;var r=d;var i=this.wheelInfos[e];this.updateWheelTransformWorld(i);i.directionLocal.scale(-1,t);n.copy(i.axleLocal);t.cross(n,r);r.normalize();n.normalize();var a=i.steering;var o=new h;o.setFromAxisAngle(t,a);var s=new h;s.setFromAxisAngle(n,i.rotation);var l=i.worldTransform.quaternion;this.chassisBody.quaternion.mult(o,l);l.mult(s,l);l.normalize();var u=i.worldTransform.position;u.copy(i.directionWorld);u.scale(i.suspensionLength,u);u.vadd(i.chassisConnectionPointWorld,u)};var I=[new O(1,0,0),new O(0,1,0),new O(0,0,1)];s.prototype.getWheelTransformWorld=function(e){return this.wheelInfos[e].worldTransform};var U=new O;var P=[];var B=[];var D=1;s.prototype.updateFriction=function(e){var t=this;var n=U;var r=this.wheelInfos;var i=r.length;var a=this.chassisBody;var o=B;var s=P;for(var l=0;l<i;l++){var u=r[l];var h=u.raycastResult.body;u.sideImpulse=0;u.forwardImpulse=0;if(!o[l]){o[l]=new O}if(!s[l]){s[l]=new O}}for(var l=0;l<i;l++){var u=r[l];var h=u.raycastResult.body;if(h){var c=s[l];var f=t.getWheelTransformWorld(l);f.vectorToWorldFrame(I[t.indexRightAxis],c);var p=u.raycastResult.hitNormalWorld;var d=c.dot(p);p.scale(d,n);c.vsub(n,c);c.normalize();p.cross(c,o[l]);o[l].normalize();u.sideImpulse=z(a,u.raycastResult.hitPointWorld,h,u.raycastResult.hitPointWorld,c);u.sideImpulse*=D}}var v=1;var m=.5;this.sliding=false;for(var l=0;l<i;l++){var u=r[l];var h=u.raycastResult.body;var _=0;u.slipInfo=1;if(h){var g=0;var y=u.brake?u.brake:g;_=F(a,h,u.raycastResult.hitPointWorld,o[l],y);_+=u.engineForce*e;var x=y/_;u.slipInfo*=x}u.forwardImpulse=0;u.skidInfo=1;if(h){u.skidInfo=1;var b=u.suspensionForce*e*u.frictionSlip;var w=b;var E=b*w;u.forwardImpulse=_;var T=u.forwardImpulse*m;var S=u.sideImpulse*v;var A=T*T+S*S;u.sliding=false;if(A>E){t.sliding=true;u.sliding=true;var x=b/Math.sqrt(A);u.skidInfo*=x}}}if(this.sliding){for(var l=0;l<i;l++){var u=r[l];if(u.sideImpulse!==0){if(u.skidInfo<1){u.forwardImpulse*=u.skidInfo;u.sideImpulse*=u.skidInfo}}}}for(var l=0;l<i;l++){var u=r[l];var M=new O;M.copy(u.raycastResult.hitPointWorld);if(u.forwardImpulse!==0){var R=new O;o[l].scale(u.forwardImpulse,R);a.applyImpulse(R,M)}if(u.sideImpulse!==0){var h=u.raycastResult.body;var L=new O;L.copy(u.raycastResult.hitPointWorld);var C=new O;s[l].scale(u.sideImpulse,C);a.pointToLocalFrame(M,M);M["xyz"[t.indexUpAxis]]*=u.rollInfluence;a.pointToWorldFrame(M,M);a.applyImpulse(C,M);C.scale(-1,C);h.applyImpulse(C,L)}}};var y=new O;var x=new O;var b=new O;function F(e,t,n,r,i){var a=0;var o=n;var s=y;var l=x;var u=b;e.getVelocityAtWorldPoint(o,s);t.getVelocityAtWorldPoint(o,l);s.vsub(l,u);var h=r.dot(u);var c=A(e,n,r);var f=A(t,n,r);var p=1;var d=p/(c+f);a=-h*d;if(i<a){a=i}if(a<-i){a=-i}return a}var w=new O;var E=new O;var T=new O;var S=new O;function A(e,t,n){var r=w;var i=E;var a=T;var o=S;t.vsub(e.position,r);r.cross(n,i);e.invInertiaWorld.vmult(i,o);o.cross(r,a);return e.invMass+n.dot(a)}var M=new O;var R=new O;var L=new O;function z(e,t,n,r,i,a){var o=i.norm2();if(o>1.1){return 0}var s=M;var l=R;var u=L;e.getVelocityAtWorldPoint(t,s);n.getVelocityAtWorldPoint(r,l);s.vsub(l,u);var h=i.dot(u);var c=.2;var f=1/(e.invMass+n.invMass);var a=-c*h*f;return a}},{"../collision/Ray":9,"../collision/RaycastResult":10,"../math/Quaternion":28,"../math/Vec3":30,"../objects/WheelInfo":36,"./Body":31}],33:[function(e,t,n){var s=e("./Body");var l=e("../shapes/Sphere");var r=e("../shapes/Box");var u=e("../math/Vec3");var h=e("../constraints/HingeConstraint");t.exports=i;function i(e){this.wheelBodies=[];this.coordinateSystem=typeof e.coordinateSystem==="undefined"?new u(1,2,3):e.coordinateSystem.clone();this.chassisBody=e.chassisBody;if(!this.chassisBody){var t=new r(new u(5,2,.5));this.chassisBody=new s(1,t)}this.constraints=[];this.wheelAxes=[];this.wheelForces=[]}i.prototype.addWheel=function(e){e=e||{};var t=e.body;if(!t){t=new s(1,new l(1.2))}this.wheelBodies.push(t);this.wheelForces.push(0);var n=new u;var r=typeof e.position!=="undefined"?e.position.clone():new u;var i=new u;this.chassisBody.pointToWorldFrame(r,i);t.position.set(i.x,i.y,i.z);var a=typeof e.axis!=="undefined"?e.axis.clone():new u(0,1,0);this.wheelAxes.push(a);var o=new h(this.chassisBody,t,{pivotA:r,axisA:a,pivotB:u.ZERO,axisB:a,collideConnected:false});this.constraints.push(o);return this.wheelBodies.length-1};i.prototype.setSteeringValue=function(e,t){var n=this.wheelAxes[t];var r=Math.cos(e),i=Math.sin(e),a=n.x,o=n.y;this.constraints[t].axisA.set(r*a-i*o,i*a+r*o,0)};i.prototype.setMotorSpeed=function(e,t){var n=this.constraints[t];n.enableMotor();n.motorTargetVelocity=e};i.prototype.disableMotor=function(e){var t=this.constraints[e];t.disableMotor()};var a=new u;i.prototype.setWheelForce=function(e,t){this.wheelForces[t]=e};i.prototype.applyWheelForce=function(e,t){var n=this.wheelAxes[t];var r=this.wheelBodies[t];var i=r.torque;n.scale(e,a);r.vectorToWorldFrame(a,a);i.vadd(a,i)};i.prototype.addToWorld=function(e){var t=this.constraints;var n=this.wheelBodies.concat([this.chassisBody]);for(var r=0;r<n.length;r++){e.add(n[r])}for(var r=0;r<t.length;r++){e.addConstraint(t[r])}e.addEventListener("preStep",this._update.bind(this))};i.prototype._update=function(){var e=this;var t=this.wheelForces;for(var n=0;n<t.length;n++){e.applyWheelForce(t[n],n)}};i.prototype.removeFromWorld=function(e){var t=this.constraints;var n=this.wheelBodies.concat([this.chassisBody]);for(var r=0;r<n.length;r++){e.remove(n[r])}for(var r=0;r<t.length;r++){e.removeConstraint(t[r])}};var o=new u;i.prototype.getWheelSpeed=function(e){var t=this.wheelAxes[e];var n=this.wheelBodies[e];var r=n.angularVelocity;this.chassisBody.vectorToWorldFrame(t,o);return r.dot(o)}},{"../constraints/HingeConstraint":15,"../math/Vec3":30,"../shapes/Box":37,"../shapes/Sphere":44,"./Body":31}],34:[function(e,t,n){t.exports=u;var r=e("../shapes/Shape");var i=e("../math/Vec3");var a=e("../math/Quaternion");var o=e("../shapes/Particle");var s=e("../objects/Body");var l=e("../material/Material");function u(){this.particles=[];this.density=1;this.smoothingRadius=1;this.speedOfSound=1;this.viscosity=.01;this.eps=1e-6;this.pressures=[];this.densities=[];this.neighbors=[]}u.prototype.add=function(e){this.particles.push(e);if(this.neighbors.length<this.particles.length){this.neighbors.push([])}};u.prototype.remove=function(e){var t=this.particles.indexOf(e);if(t!==-1){this.particles.splice(t,1);if(this.neighbors.length>this.particles.length){this.neighbors.pop()}}};var h=new i;u.prototype.getNeighbors=function(e,t){var n=this;var r=this.particles.length,i=e.id,a=this.smoothingRadius*this.smoothingRadius,o=h;for(var s=0;s!==r;s++){var l=n.particles[s];l.position.vsub(e.position,o);if(i!==l.id&&o.norm2()<a){t.push(l)}}};var E=new i,T=new i,S=new i,A=new i,M=new i,R=new i;u.prototype.update=function(){var e=this;var t=this.particles.length,n=E,r=this.speedOfSound,i=this.eps;for(var a=0;a!==t;a++){var o=e.particles[a];var s=e.neighbors[a];s.length=0;e.getNeighbors(o,s);s.push(e.particles[a]);var l=s.length;var u=0;for(var h=0;h!==l;h++){o.position.vsub(s[h].position,n);var c=n.norm();var f=e.w(c);u+=s[h].mass*f}e.densities[a]=u;e.pressures[a]=r*r*(e.densities[a]-e.density)}var p=T;var d=S;var v=A;var m=M;var _=R;for(var a=0;a!==t;a++){var g=e.particles[a];p.set(0,0,0);d.set(0,0,0);var y;var x;var s=e.neighbors[a];var l=s.length;for(var h=0;h!==l;h++){var b=s[h];g.position.vsub(b.position,m);var w=m.norm();y=-b.mass*(e.pressures[a]/(e.densities[a]*e.densities[a]+i)+e.pressures[h]/(e.densities[h]*e.densities[h]+i));e.gradw(m,v);v.mult(y,v);p.vadd(v,p);b.velocity.vsub(g.velocity,_);_.mult(1/(1e-4+e.densities[a]*e.densities[h])*e.viscosity*b.mass,_);x=e.nablaw(w);_.mult(x,_);d.vadd(_,d)}d.mult(g.mass,d);p.mult(g.mass,p);g.force.vadd(d,g.force);g.force.vadd(p,g.force)}};u.prototype.w=function(e){var t=this.smoothingRadius;return 315/(64*Math.PI*Math.pow(t,9))*Math.pow(t*t-e*e,3)};u.prototype.gradw=function(e,t){var n=e.norm(),r=this.smoothingRadius;e.mult(945/(32*Math.PI*Math.pow(r,9))*Math.pow(r*r-n*n,2),t)};u.prototype.nablaw=function(e){var t=this.smoothingRadius;var n=945/(32*Math.PI*Math.pow(t,9))*(t*t-e*e)*(7*e*e-3*t*t);return n}},{"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Particle":41,"../shapes/Shape":43}],35:[function(e,t,n){var r=e("../math/Vec3");t.exports=i;function i(e,t,n){n=n||{};this.restLength=typeof n.restLength==="number"?n.restLength:1;this.stiffness=n.stiffness||100;this.damping=n.damping||1;this.bodyA=e;this.bodyB=t;this.localAnchorA=new r;this.localAnchorB=new r;if(n.localAnchorA){this.localAnchorA.copy(n.localAnchorA)}if(n.localAnchorB){this.localAnchorB.copy(n.localAnchorB)}if(n.worldAnchorA){this.setWorldAnchorA(n.worldAnchorA)}if(n.worldAnchorB){this.setWorldAnchorB(n.worldAnchorB)}}i.prototype.setWorldAnchorA=function(e){this.bodyA.pointToLocalFrame(e,this.localAnchorA)};i.prototype.setWorldAnchorB=function(e){this.bodyB.pointToLocalFrame(e,this.localAnchorB)};i.prototype.getWorldAnchorA=function(e){this.bodyA.pointToWorldFrame(this.localAnchorA,e)};i.prototype.getWorldAnchorB=function(e){this.bodyB.pointToWorldFrame(this.localAnchorB,e)};var _=new r,g=new r,y=new r,x=new r,b=new r,w=new r,E=new r,T=new r,S=new r,A=new r,M=new r;i.prototype.applyForce=function(){var e=this.stiffness,t=this.damping,n=this.restLength,r=this.bodyA,i=this.bodyB,a=_,o=g,s=y,l=x,u=M;var h=b,c=w,f=E,p=T,d=S,v=A;this.getWorldAnchorA(h);this.getWorldAnchorB(c);h.vsub(r.position,f);c.vsub(i.position,p);c.vsub(h,a);var m=a.norm();o.copy(a);o.normalize();i.velocity.vsub(r.velocity,s);i.angularVelocity.cross(p,u);s.vadd(u,s);r.angularVelocity.cross(f,u);s.vsub(u,s);o.mult(-e*(m-n)-t*s.dot(o),l);r.force.vsub(l,r.force);i.force.vadd(l,i.force);f.cross(l,d);p.cross(l,v);r.torque.vsub(d,r.torque);i.torque.vadd(v,i.torque)}},{"../math/Vec3":30}],36:[function(e,t,n){var r=e("../math/Vec3");var i=e("../math/Transform");var a=e("../collision/RaycastResult");var o=e("../utils/Utils");t.exports=s;function s(e){e=o.defaults(e,{chassisConnectionPointLocal:new r,chassisConnectionPointWorld:new r,directionLocal:new r,directionWorld:new r,axleLocal:new r,axleWorld:new r,suspensionRestLength:1,suspensionMaxLength:2,radius:1,suspensionStiffness:100,dampingCompression:10,dampingRelaxation:10,frictionSlip:1e4,steering:0,rotation:0,deltaRotation:0,rollInfluence:.01,maxSuspensionForce:Number.MAX_VALUE,isFrontWheel:true,clippedInvContactDotSuspension:1,suspensionRelativeVelocity:0,suspensionForce:0,skidInfo:0,suspensionLength:0,maxSuspensionTravel:1,useCustomSlidingRotationalSpeed:false,customSlidingRotationalSpeed:-.1});this.maxSuspensionTravel=e.maxSuspensionTravel;this.customSlidingRotationalSpeed=e.customSlidingRotationalSpeed;this.useCustomSlidingRotationalSpeed=e.useCustomSlidingRotationalSpeed;this.sliding=false;this.chassisConnectionPointLocal=e.chassisConnectionPointLocal.clone();this.chassisConnectionPointWorld=e.chassisConnectionPointWorld.clone();this.directionLocal=e.directionLocal.clone();this.directionWorld=e.directionWorld.clone();this.axleLocal=e.axleLocal.clone();this.axleWorld=e.axleWorld.clone();this.suspensionRestLength=e.suspensionRestLength;this.suspensionMaxLength=e.suspensionMaxLength;this.radius=e.radius;this.suspensionStiffness=e.suspensionStiffness;this.dampingCompression=e.dampingCompression;this.dampingRelaxation=e.dampingRelaxation;this.frictionSlip=e.frictionSlip;this.steering=0;this.rotation=0;this.deltaRotation=0;this.rollInfluence=e.rollInfluence;this.maxSuspensionForce=e.maxSuspensionForce;this.engineForce=0;this.brake=0;this.isFrontWheel=e.isFrontWheel;this.clippedInvContactDotSuspension=1;this.suspensionRelativeVelocity=0;this.suspensionForce=0;this.skidInfo=0;this.suspensionLength=0;this.sideImpulse=0;this.forwardImpulse=0;this.raycastResult=new a;this.worldTransform=new i;this.isInContact=false}var l=new r;var u=new r;var l=new r;s.prototype.updateWheel=function(e){var t=this.raycastResult;if(this.isInContact){var n=t.hitNormalWorld.dot(t.directionWorld);t.hitPointWorld.vsub(e.position,u);e.getVelocityAtWorldPoint(u,l);var r=t.hitNormalWorld.dot(l);if(n>=-.1){this.suspensionRelativeVelocity=0;this.clippedInvContactDotSuspension=1/.1}else{var i=-1/n;this.suspensionRelativeVelocity=r*i;this.clippedInvContactDotSuspension=i}}else{t.suspensionLength=this.suspensionRestLength;this.suspensionRelativeVelocity=0;t.directionWorld.scale(-1,t.hitNormalWorld);this.clippedInvContactDotSuspension=1}}},{"../collision/RaycastResult":10,"../math/Transform":29,"../math/Vec3":30,"../utils/Utils":53}],37:[function(e,t,n){t.exports=i;var r=e("./Shape");var l=e("../math/Vec3");var u=e("./ConvexPolyhedron");function i(e){r.call(this);this.type=r.types.BOX;this.halfExtents=e;this.convexPolyhedronRepresentation=null;this.updateConvexPolyhedronRepresentation();this.updateBoundingSphereRadius()}i.prototype=new r;i.prototype.constructor=i;i.prototype.updateConvexPolyhedronRepresentation=function(){var e=this.halfExtents.x;var t=this.halfExtents.y;var n=this.halfExtents.z;var r=l;var i=[new r(-e,-t,-n),new r(e,-t,-n),new r(e,t,-n),new r(-e,t,-n),new r(-e,-t,n),new r(e,-t,n),new r(e,t,n),new r(-e,t,n)];var a=[[3,2,1,0],[4,5,6,7],[5,4,0,1],[2,3,7,6],[0,4,7,3],[1,2,6,5]];var o=[new r(0,0,1),new r(0,1,0),new r(1,0,0)];var s=new u(i,a);this.convexPolyhedronRepresentation=s;s.material=this.material};i.prototype.calculateLocalInertia=function(e,t){t=t||new l;i.calculateInertia(this.halfExtents,e,t);return t};i.calculateInertia=function(e,t,n){var r=e;n.x=1/12*t*(2*r.y*2*r.y+2*r.z*2*r.z);n.y=1/12*t*(2*r.x*2*r.x+2*r.z*2*r.z);n.z=1/12*t*(2*r.y*2*r.y+2*r.x*2*r.x)};i.prototype.getSideNormals=function(e,t){var n=e;var r=this.halfExtents;n[0].set(r.x,0,0);n[1].set(0,r.y,0);n[2].set(0,0,r.z);n[3].set(-r.x,0,0);n[4].set(0,-r.y,0);n[5].set(0,0,-r.z);if(t!==undefined){for(var i=0;i!==n.length;i++){t.vmult(n[i],n[i])}}return n};i.prototype.volume=function(){return 8*this.halfExtents.x*this.halfExtents.y*this.halfExtents.z};i.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.halfExtents.norm()};var o=new l;var a=new l;i.prototype.forEachWorldCorner=function(e,t,n){var r=this.halfExtents;var i=[[r.x,r.y,r.z],[-r.x,r.y,r.z],[-r.x,-r.y,r.z],[-r.x,-r.y,-r.z],[r.x,-r.y,-r.z],[r.x,r.y,-r.z],[-r.x,r.y,-r.z],[r.x,-r.y,r.z]];for(var a=0;a<i.length;a++){o.set(i[a][0],i[a][1],i[a][2]);t.vmult(o,o);e.vadd(o,o);n(o.x,o.y,o.z)}};var h=[new l,new l,new l,new l,new l,new l,new l,new l];i.prototype.calculateWorldAABB=function(e,t,n,r){var i=this.halfExtents;h[0].set(i.x,i.y,i.z);h[1].set(-i.x,i.y,i.z);h[2].set(-i.x,-i.y,i.z);h[3].set(-i.x,-i.y,-i.z);h[4].set(i.x,-i.y,-i.z);h[5].set(i.x,i.y,-i.z);h[6].set(-i.x,i.y,-i.z);h[7].set(i.x,-i.y,i.z);var a=h[0];t.vmult(a,a);e.vadd(a,a);r.copy(a);n.copy(a);for(var o=1;o<8;o++){var a=h[o];t.vmult(a,a);e.vadd(a,a);var s=a.x;var l=a.y;var u=a.z;if(s>r.x){r.x=s}if(l>r.y){r.y=l}if(u>r.z){r.z=u}if(s<n.x){n.x=s}if(l<n.y){n.y=l}if(u<n.z){n.z=u}}}},{"../math/Vec3":30,"./ConvexPolyhedron":38,"./Shape":43}],38:[function(e,t,n){t.exports=d;var r=e("./Shape");var x=e("../math/Vec3");var i=e("../math/Quaternion");var m=e("../math/Transform");function d(e,t,n){r.call(this);this.type=r.types.CONVEXPOLYHEDRON;this.vertices=e||[];this.worldVertices=[];this.worldVerticesNeedsUpdate=true;this.faces=t||[];this.faceNormals=[];this.computeNormals();this.worldFaceNormalsNeedsUpdate=true;this.worldFaceNormals=[];this.uniqueEdges=[];this.uniqueAxes=n?n.slice():null;this.computeEdges();this.updateBoundingSphereRadius()}d.prototype=new r;d.prototype.constructor=d;var f=new x;d.prototype.computeEdges=function(){var e=this.faces;var t=this.vertices;var n=t.length;var r=this.uniqueEdges;r.length=0;var i=f;for(var a=0;a!==e.length;a++){var o=e[a];var s=o.length;for(var l=0;l!==s;l++){var u=(l+1)%s;t[o[l]].vsub(t[o[u]],i);i.normalize();var h=false;for(var c=0;c!==r.length;c++){if(r[c].almostEquals(i)||r[c].almostEquals(i)){h=true;break}}if(!h){r.push(i.clone())}}}};d.prototype.computeNormals=function(){var e=this;this.faceNormals.length=this.faces.length;for(var t=0;t<this.faces.length;t++){for(var n=0;n<this.faces[t].length;n++){if(!e.vertices[e.faces[t][n]]){throw new Error("Vertex "+e.faces[t][n]+" not found!")}}var r=e.faceNormals[t]||new x;e.getFaceNormal(t,r);r.negate(r);e.faceNormals[t]=r;var i=e.vertices[e.faces[t][0]];if(r.dot(i)<0){console.error(".faceNormals["+t+"] = Vec3("+r.toString()+") looks like it points into the shape? The vertices follow. Make sure they are ordered CCW around the normal, using the right hand rule.");for(var n=0;n<this.faces[t].length;n++){console.warn(".vertices["+e.faces[t][n]+"] = Vec3("+e.vertices[e.faces[t][n]].toString()+")")}}}};var a=new x;var o=new x;d.computeNormal=function(e,t,n,r){t.vsub(e,o);n.vsub(t,a);a.cross(o,r);if(!r.isZero()){r.normalize()}};d.prototype.getFaceNormal=function(e,t){var n=this.faces[e];var r=this.vertices[n[0]];var i=this.vertices[n[1]];var a=this.vertices[n[2]];return d.computeNormal(r,i,a,t)};var b=new x;d.prototype.clipAgainstHull=function(e,t,n,r,i,a,o,s,l){var u=b;var h=-1;var c=-Number.MAX_VALUE;for(var f=0;f<n.faces.length;f++){u.copy(n.faceNormals[f]);i.vmult(u,u);var p=u.dot(a);if(p>c){c=p;h=f}}var d=[];var v=n.faces[h];var m=v.length;for(var _=0;_<m;_++){var g=n.vertices[v[_]];var y=new x;y.copy(g);i.vmult(y,y);r.vadd(y,y);d.push(y)}if(h>=0){this.clipFaceAgainstHull(a,e,t,d,o,s,l)}};var T=new x,S=new x,A=new x,M=new x,R=new x,L=new x;d.prototype.findSeparatingAxis=function(e,t,n,r,i,a,o,s){var l=T,u=S,h=A,c=M,f=R,p=L;var d=Number.MAX_VALUE;var v=this;if(!v.uniqueAxes){var m=o?o.length:v.faces.length;for(var _=0;_<m;_++){var g=o?o[_]:_;l.copy(v.faceNormals[g]);n.vmult(l,l);var y=v.testSepAxis(l,e,t,n,r,i);if(y===false){return false}if(y<d){d=y;a.copy(l)}}}else{for(var _=0;_!==v.uniqueAxes.length;_++){n.vmult(v.uniqueAxes[_],l);var y=v.testSepAxis(l,e,t,n,r,i);if(y===false){return false}if(y<d){d=y;a.copy(l)}}}if(!e.uniqueAxes){var x=s?s.length:e.faces.length;for(var _=0;_<x;_++){var g=s?s[_]:_;u.copy(e.faceNormals[g]);i.vmult(u,u);var y=v.testSepAxis(u,e,t,n,r,i);if(y===false){return false}if(y<d){d=y;a.copy(u)}}}else{for(var _=0;_!==e.uniqueAxes.length;_++){i.vmult(e.uniqueAxes[_],u);var y=v.testSepAxis(u,e,t,n,r,i);if(y===false){return false}if(y<d){d=y;a.copy(u)}}}for(var b=0;b!==v.uniqueEdges.length;b++){n.vmult(v.uniqueEdges[b],c);for(var w=0;w!==e.uniqueEdges.length;w++){i.vmult(e.uniqueEdges[w],f);c.cross(f,p);if(!p.almostZero()){p.normalize();var E=v.testSepAxis(p,e,t,n,r,i);if(E===false){return false}if(E<d){d=E;a.copy(p)}}}}r.vsub(t,h);if(h.dot(a)>0){a.negate(a)}return true};var v=[],_=[];d.prototype.testSepAxis=function(e,t,n,r,i,a){var o=this;d.project(o,e,n,r,v);d.project(t,e,i,a,_);var s=v[0];var l=v[1];var u=_[0];var h=_[1];if(s<h||u<l){return false}var c=s-h;var f=u-l;var p=c<f?c:f;return p};var s=new x,l=new x;d.prototype.calculateLocalInertia=function(e,t){this.computeLocalAABB(s,l);var n=l.x-s.x,r=l.y-s.y,i=l.z-s.z;t.x=1/12*e*(2*r*2*r+2*i*2*i);t.y=1/12*e*(2*n*2*n+2*i*2*i);t.z=1/12*e*(2*r*2*r+2*n*2*n)};d.prototype.getPlaneConstantOfFace=function(e){var t=this.faces[e];var n=this.faceNormals[e];var r=this.vertices[t[0]];var i=-n.dot(r);return i};var N=new x,k=new x,V=new x,W=new x,G=new x,H=new x,j=new x,q=new x;d.prototype.clipFaceAgainstHull=function(e,t,n,r,i,a,o){var s=this;var l=N,u=k,h=V,c=W,f=G,p=H,d=j,v=q;var m=this;var _=[];var g=r;var y=_;var x=-1;var b=Number.MAX_VALUE;for(var w=0;w<m.faces.length;w++){l.copy(m.faceNormals[w]);n.vmult(l,l);var E=l.dot(e);if(E<b){b=E;x=w}}if(x<0){return}var T=m.faces[x];T.connectedFaces=[];for(var S=0;S<m.faces.length;S++){for(var A=0;A<m.faces[S].length;A++){if(T.indexOf(m.faces[S][A])!==-1&&S!==x&&T.connectedFaces.indexOf(S)===-1){T.connectedFaces.push(S)}}}var M=g.length;var R=T.length;for(var L=0;L<R;L++){var C=m.vertices[T[L]];var O=m.vertices[T[(L+1)%R]];C.vsub(O,u);h.copy(u);n.vmult(h,h);t.vadd(h,h);c.copy(s.faceNormals[x]);n.vmult(c,c);t.vadd(c,c);h.cross(c,f);f.negate(f);p.copy(C);n.vmult(p,p);t.vadd(p,p);var I=-p.dot(f);var U;{var P=T.connectedFaces[L];d.copy(s.faceNormals[P]);var B=s.getPlaneConstantOfFace(P);v.copy(d);n.vmult(v,v);var U=B-v.dot(t)}s.clipFaceAgainstPlane(g,y,v,U);while(g.length){g.shift()}while(y.length){g.push(y.shift())}}d.copy(this.faceNormals[x]);var B=this.getPlaneConstantOfFace(x);v.copy(d);n.vmult(v,v);var U=B-v.dot(t);for(var S=0;S<g.length;S++){var D=v.dot(g[S])+U;if(D<=i){console.log("clamped: depth="+D+" to minDist="+(i+""));D=i}if(D<=a){var F=g[S];if(D<=0){var z={point:F,normal:v,depth:D};o.push(z)}}}};d.prototype.clipFaceAgainstPlane=function(e,t,n,r){var i,a;var o=e.length;if(o<2){return t}var s=e[e.length-1],l=e[0];i=n.dot(s)+r;for(var u=0;u<o;u++){l=e[u];a=n.dot(l)+r;if(i<0){if(a<0){var h=new x;h.copy(l);t.push(h)}else{var h=new x;s.lerp(l,i/(i-a),h);t.push(h)}}else{if(a<0){var h=new x;s.lerp(l,i/(i-a),h);t.push(h);t.push(l)}}s=l;i=a}return t};d.prototype.computeWorldVertices=function(e,t){var n=this;var r=this.vertices.length;while(this.worldVertices.length<r){n.worldVertices.push(new x)}var i=this.vertices,a=this.worldVertices;for(var o=0;o!==r;o++){t.vmult(i[o],a[o]);e.vadd(a[o],a[o])}this.worldVerticesNeedsUpdate=false};var u=new x;d.prototype.computeLocalAABB=function(e,t){var n=this.vertices.length,r=this.vertices;e.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE);t.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(var i=0;i<n;i++){var a=r[i];if(a.x<e.x){e.x=a.x}else if(a.x>t.x){t.x=a.x}if(a.y<e.y){e.y=a.y}else if(a.y>t.y){t.y=a.y}if(a.z<e.z){e.z=a.z}else if(a.z>t.z){t.z=a.z}}};d.prototype.computeWorldFaceNormals=function(e){var t=this;var n=this.faceNormals.length;while(this.worldFaceNormals.length<n){t.worldFaceNormals.push(new x)}var r=this.faceNormals,i=this.worldFaceNormals;for(var a=0;a!==n;a++){e.vmult(r[a],i[a])}this.worldFaceNormalsNeedsUpdate=false};d.prototype.updateBoundingSphereRadius=function(){var e=0;var t=this.vertices;for(var n=0,r=t.length;n!==r;n++){var i=t[n].norm2();if(i>e){e=i}}this.boundingSphereRadius=Math.sqrt(e)};var g=new x;d.prototype.calculateWorldAABB=function(e,t,n,r){var i=this.vertices.length,a=this.vertices;var o,s,l,u,h,c;for(var f=0;f<i;f++){g.copy(a[f]);t.vmult(g,g);e.vadd(g,g);var p=g;if(p.x<o||o===undefined){o=p.x}else if(p.x>u||u===undefined){u=p.x}if(p.y<s||s===undefined){s=p.y}else if(p.y>h||h===undefined){h=p.y}if(p.z<l||l===undefined){l=p.z}else if(p.z>c||c===undefined){c=p.z}}n.set(o,s,l);r.set(u,h,c)};d.prototype.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3};d.prototype.getAveragePointLocal=function(e){e=e||new x;var t=this.vertices.length,n=this.vertices;for(var r=0;r<t;r++){e.vadd(n[r],e)}e.mult(1/t,e);return e};d.prototype.transformAllPoints=function(e,t){var n=this;var r=this.vertices.length,i=this.vertices;if(t){for(var a=0;a<r;a++){var o=i[a];t.vmult(o,o)}for(var a=0;a<this.faceNormals.length;a++){var o=n.faceNormals[a];t.vmult(o,o)}}if(e){for(var a=0;a<r;a++){var o=i[a];o.vadd(e,o)}}};var y=new x;var w=new x;var E=new x;d.prototype.pointIsInside=function(e){var t=this;var n=this.vertices.length,r=this.vertices,i=this.faces,a=this.faceNormals;var o=null;var s=this.faces.length;var l=y;this.getAveragePointLocal(l);for(var u=0;u<s;u++){var h=t.faces[u].length;var n=a[u];var c=r[i[u][0]];var f=w;e.vsub(c,f);var p=n.dot(f);var d=E;l.vsub(c,d);var v=n.dot(d);if(p<0&&v>0||p>0&&v<0){return false}else{}}return o?1:-1};var C=new x;var O=new x;var I=new x;d.project=function(e,t,n,r,i){var a=e.vertices.length,o=C,s=O,l=0,u=0,h=I,c=e.vertices;h.setZero();m.vectorToLocalFrame(n,r,t,s);m.pointToLocalFrame(n,r,h,h);var f=h.dot(s);u=l=c[0].dot(s);for(var p=1;p<a;p++){var d=c[p].dot(s);if(d>l){l=d}if(d<u){u=d}}u-=f;l-=f;if(u>l){var v=u;u=l;l=v}i[0]=l;i[1]=u}},{"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"./Shape":43}],39:[function(e,t,n){t.exports=i;var m=e("./Shape");var _=e("../math/Vec3");var r=e("../math/Quaternion");var g=e("./ConvexPolyhedron");function i(e,t,n,r){var i=r,a=[],o=[],s=[],l=[],u=[],h=Math.cos,c=Math.sin;a.push(new _(t*h(0),t*c(0),-n*.5));l.push(0);a.push(new _(e*h(0),e*c(0),n*.5));u.push(1);for(var f=0;f<i;f++){var p=2*Math.PI/i*(f+1);var d=2*Math.PI/i*(f+.5);if(f<i-1){a.push(new _(t*h(p),t*c(p),-n*.5));l.push(2*f+2);a.push(new _(e*h(p),e*c(p),n*.5));u.push(2*f+3);s.push([2*f+2,2*f+3,2*f+1,2*f])}else{s.push([0,1,2*f+1,2*f])}if(i%2===1||f<i/2){o.push(new _(h(d),c(d),0))}}s.push(u);o.push(new _(0,0,1));var v=[];for(var f=0;f<l.length;f++){v.push(l[l.length-f-1])}s.push(v);this.type=m.types.CONVEXPOLYHEDRON;g.call(this,a,s,o)}i.prototype=new g},{"../math/Quaternion":28,"../math/Vec3":30,"./ConvexPolyhedron":38,"./Shape":43}],40:[function(e,t,n){var r=e("./Shape");var c=e("./ConvexPolyhedron");var f=e("../math/Vec3");var i=e("../utils/Utils");t.exports=a;function a(e,t){t=i.defaults(t,{maxValue:null,minValue:null,elementSize:1});this.data=e;this.maxValue=t.maxValue;this.minValue=t.minValue;this.elementSize=t.elementSize;if(t.minValue===null){this.updateMinValue()}if(t.maxValue===null){this.updateMaxValue()}this.cacheEnabled=true;r.call(this);this.pillarConvex=new c;this.pillarOffset=new f;this.type=r.types.HEIGHTFIELD;this.updateBoundingSphereRadius();this._cachedPillars={}}a.prototype=new r;a.prototype.update=function(){this._cachedPillars={}};a.prototype.updateMinValue=function(){var e=this.data;var t=e[0][0];for(var n=0;n!==e.length;n++){for(var r=0;r!==e[n].length;r++){var i=e[n][r];if(i<t){t=i}}}this.minValue=t};a.prototype.updateMaxValue=function(){var e=this.data;var t=e[0][0];for(var n=0;n!==e.length;n++){for(var r=0;r!==e[n].length;r++){var i=e[n][r];if(i>t){t=i}}}this.maxValue=t};a.prototype.setHeightValueAtIndex=function(e,t,n){var r=this.data;r[e][t]=n;this.clearCachedConvexTrianglePillar(e,t,false);if(e>0){this.clearCachedConvexTrianglePillar(e-1,t,true);this.clearCachedConvexTrianglePillar(e-1,t,false)}if(t>0){this.clearCachedConvexTrianglePillar(e,t-1,true);this.clearCachedConvexTrianglePillar(e,t-1,false)}if(t>0&&e>0){this.clearCachedConvexTrianglePillar(e-1,t-1,true)}};a.prototype.getRectMinMax=function(e,t,n,r,i){i=i||[];var a=this.data,o=this.minValue;for(var s=e;s<=n;s++){for(var l=t;l<=r;l++){var u=a[s][l];if(u>o){o=u}}}i[0]=this.minValue;i[1]=o};a.prototype.getIndexOfPosition=function(e,t,n,r){var i=this.elementSize;var a=this.data;var o=Math.floor(e/i);var s=Math.floor(t/i);n[0]=o;n[1]=s;if(r){if(o<0){o=0}if(s<0){s=0}if(o>=a.length-1){o=a.length-1}if(s>=a[0].length-1){s=a[0].length-1}}if(o<0||s<0||o>=a.length-1||s>=a[0].length-1){return false}return true};a.prototype.getHeightAt=function(e,t,n){var r=[];this.getIndexOfPosition(e,t,r,n);var i=[];this.getRectMinMax(r[0],r[1]+1,r[0],r[1]+1,i);return(i[0]+i[1])/2};a.prototype.getCacheConvexTrianglePillarKey=function(e,t,n){return e+"_"+t+"_"+(n?1:0)};a.prototype.getCachedConvexTrianglePillar=function(e,t,n){return this._cachedPillars[this.getCacheConvexTrianglePillarKey(e,t,n)]};a.prototype.setCachedConvexTrianglePillar=function(e,t,n,r,i){this._cachedPillars[this.getCacheConvexTrianglePillarKey(e,t,n)]={convex:r,offset:i}};a.prototype.clearCachedConvexTrianglePillar=function(e,t,n){delete this._cachedPillars[this.getCacheConvexTrianglePillarKey(e,t,n)]};a.prototype.getConvexTrianglePillar=function(e,t,n){var r=this.pillarConvex;var i=this.pillarOffset;if(this.cacheEnabled){var a=this.getCachedConvexTrianglePillar(e,t,n);if(a){this.pillarConvex=a.convex;this.pillarOffset=a.offset;return}r=new c;i=new f;this.pillarConvex=r;this.pillarOffset=i}var a=this.data;var o=this.elementSize;var s=r.faces;r.vertices.length=6;for(var l=0;l<6;l++){if(!r.vertices[l]){r.vertices[l]=new f}}s.length=5;for(var l=0;l<5;l++){if(!s[l]){s[l]=[]}}var u=r.vertices;var h=(Math.min(a[e][t],a[e+1][t],a[e][t+1],a[e+1][t+1])-this.minValue)/2+this.minValue;if(!n){i.set((e+.25)*o,(t+.25)*o,h);u[0].set(-.25*o,-.25*o,a[e][t]-h);u[1].set(.75*o,-.25*o,a[e+1][t]-h);u[2].set(-.25*o,.75*o,a[e][t+1]-h);u[3].set(-.25*o,-.25*o,-h-1);u[4].set(.75*o,-.25*o,-h-1);u[5].set(-.25*o,.75*o,-h-1);s[0][0]=0;s[0][1]=1;s[0][2]=2;s[1][0]=5;s[1][1]=4;s[1][2]=3;s[2][0]=0;s[2][1]=2;s[2][2]=5;s[2][3]=3;s[3][0]=1;s[3][1]=0;s[3][2]=3;s[3][3]=4;s[4][0]=4;s[4][1]=5;s[4][2]=2;s[4][3]=1}else{i.set((e+.75)*o,(t+.75)*o,h);u[0].set(.25*o,.25*o,a[e+1][t+1]-h);u[1].set(-.75*o,.25*o,a[e][t+1]-h);u[2].set(.25*o,-.75*o,a[e+1][t]-h);u[3].set(.25*o,.25*o,-h-1);u[4].set(-.75*o,.25*o,-h-1);u[5].set(.25*o,-.75*o,-h-1);s[0][0]=0;s[0][1]=1;s[0][2]=2;s[1][0]=5;s[1][1]=4;s[1][2]=3;s[2][0]=2;s[2][1]=5;s[2][2]=3;s[2][3]=0;s[3][0]=3;s[3][1]=4;s[3][2]=1;s[3][3]=0;s[4][0]=1;s[4][1]=4;s[4][2]=5;s[4][3]=2}r.computeNormals();r.computeEdges();r.updateBoundingSphereRadius();this.setCachedConvexTrianglePillar(e,t,n,r,i)};a.prototype.calculateLocalInertia=function(e,t){t=t||new f;t.set(0,0,0);return t};a.prototype.volume=function(){return Number.MAX_VALUE};a.prototype.calculateWorldAABB=function(e,t,n,r){n.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);r.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)};a.prototype.updateBoundingSphereRadius=function(){var e=this.data,t=this.elementSize;this.boundingSphereRadius=new f(e.length*t,e[0].length*t,Math.max(Math.abs(this.maxValue),Math.abs(this.minValue))).norm()}},{"../math/Vec3":30,"../utils/Utils":53,"./ConvexPolyhedron":38,"./Shape":43}],41:[function(e,t,n){t.exports=a;var r=e("./Shape");var i=e("../math/Vec3");function a(){r.call(this);this.type=r.types.PARTICLE}a.prototype=new r;a.prototype.constructor=a;a.prototype.calculateLocalInertia=function(e,t){t=t||new i;t.set(0,0,0);return t};a.prototype.volume=function(){return 0};a.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=0};a.prototype.calculateWorldAABB=function(e,t,n,r){n.copy(e);r.copy(e)}},{"../math/Vec3":30,"./Shape":43}],42:[function(e,t,n){t.exports=a;var r=e("./Shape");var i=e("../math/Vec3");function a(){r.call(this);this.type=r.types.PLANE;this.worldNormal=new i;this.worldNormalNeedsUpdate=true;this.boundingSphereRadius=Number.MAX_VALUE}a.prototype=new r;a.prototype.constructor=a;a.prototype.computeWorldNormal=function(e){var t=this.worldNormal;t.set(0,0,1);e.vmult(t,t);this.worldNormalNeedsUpdate=false};a.prototype.calculateLocalInertia=function(e,t){t=t||new i;return t};a.prototype.volume=function(){return Number.MAX_VALUE};var o=new i;a.prototype.calculateWorldAABB=function(e,t,n,r){o.set(0,0,1);t.vmult(o,o);var i=Number.MAX_VALUE;n.set(-i,-i,-i);r.set(i,i,i);if(o.x===1){r.x=e.x}if(o.y===1){r.y=e.y}if(o.z===1){r.z=e.z}if(o.x===-1){n.x=e.x}if(o.y===-1){n.y=e.y}if(o.z===-1){n.z=e.z}};a.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=Number.MAX_VALUE}},{"../math/Vec3":30,"./Shape":43}],43:[function(e,t,n){t.exports=r;var r=e("./Shape");var i=e("../math/Vec3");var a=e("../math/Quaternion");var o=e("../material/Material");function r(){this.id=r.idCounter++;this.type=0;this.boundingSphereRadius=0;this.collisionResponse=true;this.material=null}r.prototype.constructor=r;r.prototype.updateBoundingSphereRadius=function(){throw"computeBoundingSphereRadius() not implemented for shape type "+this.type};r.prototype.volume=function(){throw"volume() not implemented for shape type "+this.type};r.prototype.calculateLocalInertia=function(e,t){throw"calculateLocalInertia() not implemented for shape type "+this.type};r.idCounter=0;r.types={SPHERE:1,PLANE:2,BOX:4,COMPOUND:8,CONVEXPOLYHEDRON:16,HEIGHTFIELD:32,PARTICLE:64,CYLINDER:128,TRIMESH:256}},{"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"./Shape":43}],44:[function(e,t,n){t.exports=a;var r=e("./Shape");var i=e("../math/Vec3");function a(e){r.call(this);this.radius=e!==undefined?Number(e):1;this.type=r.types.SPHERE;if(this.radius<0){throw new Error("The sphere radius cannot be negative.")}this.updateBoundingSphereRadius()}a.prototype=new r;a.prototype.constructor=a;a.prototype.calculateLocalInertia=function(e,t){t=t||new i;var n=2*e*this.radius*this.radius/5;t.x=n;t.y=n;t.z=n;return t};a.prototype.volume=function(){return 4*Math.PI*this.radius/3};a.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.radius};a.prototype.calculateWorldAABB=function(e,t,n,r){var i=this.radius;var a=["x","y","z"];for(var o=0;o<a.length;o++){var s=a[o];n[s]=e[s]-i;r[s]=e[s]+i}}},{"../math/Vec3":30,"./Shape":43}],45:[function(e,t,n){t.exports=g;var r=e("./Shape");var h=e("../math/Vec3");var i=e("../math/Quaternion");var a=e("../math/Transform");var c=e("../collision/AABB");var o=e("../utils/Octree");function g(e,t){r.call(this);this.type=r.types.TRIMESH;this.vertices=new Float32Array(e);this.indices=new Int16Array(t);this.normals=new Float32Array(t.length);this.aabb=new c;this.edges=null;this.scale=new h(1,1,1);this.tree=new o;this.updateEdges();this.updateNormals();this.updateAABB();this.updateBoundingSphereRadius();this.updateTree()}g.prototype=new r;g.prototype.constructor=g;var l=new h;g.prototype.updateTree=function(){var e=this;var t=this.tree;t.reset();t.aabb.copy(this.aabb);var n=this.scale;t.aabb.lowerBound.x*=1/n.x;t.aabb.lowerBound.y*=1/n.y;t.aabb.lowerBound.z*=1/n.z;t.aabb.upperBound.x*=1/n.x;t.aabb.upperBound.y*=1/n.y;t.aabb.upperBound.z*=1/n.z;var r=new c;var i=new h;var a=new h;var o=new h;var s=[i,a,o];for(var l=0;l<this.indices.length/3;l++){var u=l*3;e._getUnscaledVertex(e.indices[u],i);e._getUnscaledVertex(e.indices[u+1],a);e._getUnscaledVertex(e.indices[u+2],o);r.setFromPoints(s);t.insert(r,l)}t.removeEmptyNodes()};var u=new c;g.prototype.getTrianglesInAABB=function(e,t){u.copy(e);var n=this.scale;var r=n.x;var i=n.y;var a=n.z;var o=u.lowerBound;var s=u.upperBound;o.x/=r;o.y/=i;o.z/=a;s.x/=r;s.y/=i;s.z/=a;return this.tree.aabbQuery(u,t)};g.prototype.setScale=function(e){var t=this.scale.x===this.scale.y===this.scale.z;var n=e.x===e.y===e.z;if(!(t&&n)){this.updateNormals()}this.scale.copy(e);this.updateAABB();this.updateBoundingSphereRadius()};g.prototype.updateNormals=function(){var e=this;var t=l;var n=this.normals;for(var r=0;r<this.indices.length/3;r++){var i=r*3;var a=e.indices[i],o=e.indices[i+1],s=e.indices[i+2];e.getVertex(a,v);e.getVertex(o,m);e.getVertex(s,_);g.computeNormal(m,v,_,t);n[i]=t.x;n[i+1]=t.y;n[i+2]=t.z}};g.prototype.updateEdges=function(){var e=this;var r={};var t=function(e,t){var n=a<o?a+"_"+o:o+"_"+a;r[n]=true};for(var n=0;n<this.indices.length/3;n++){var i=n*3;var a=e.indices[i],o=e.indices[i+1],s=e.indices[i+2];t(a,o);t(o,s);t(s,a)}var l=Object.keys(r);this.edges=new Int16Array(l.length*2);for(var n=0;n<l.length;n++){var u=l[n].split("_");e.edges[2*n]=parseInt(u[0],10);e.edges[2*n+1]=parseInt(u[1],10)}};g.prototype.getEdgeVertex=function(e,t,n){var r=this.edges[e*2+(t?1:0)];this.getVertex(r,n)};var s=new h;var f=new h;g.prototype.getEdgeVector=function(e,t){var n=s;var r=f;this.getEdgeVertex(e,0,n);this.getEdgeVertex(e,1,r);r.vsub(n,t)};var p=new h;var d=new h;g.computeNormal=function(e,t,n,r){t.vsub(e,d);n.vsub(t,p);p.cross(d,r);if(!r.isZero()){r.normalize()}};var v=new h;var m=new h;var _=new h;g.prototype.getVertex=function(e,t){var n=this.scale;this._getUnscaledVertex(e,t);t.x*=n.x;t.y*=n.y;t.z*=n.z;return t};g.prototype._getUnscaledVertex=function(e,t){var n=e*3;var r=this.vertices;return t.set(r[n],r[n+1],r[n+2])};g.prototype.getWorldVertex=function(e,t,n,r){this.getVertex(e,r);a.pointToWorldFrame(t,n,r,r);return r};g.prototype.getTriangleVertices=function(e,t,n,r){var i=e*3;this.getVertex(this.indices[i],t);this.getVertex(this.indices[i+1],n);this.getVertex(this.indices[i+2],r)};g.prototype.getNormal=function(e,t){var n=e*3;return t.set(this.normals[n],this.normals[n+1],this.normals[n+2])};var y=new c;g.prototype.calculateLocalInertia=function(e,t){this.computeLocalAABB(y);var n=y.upperBound.x-y.lowerBound.x,r=y.upperBound.y-y.lowerBound.y,i=y.upperBound.z-y.lowerBound.z;return t.set(1/12*e*(2*r*2*r+2*i*2*i),1/12*e*(2*n*2*n+2*i*2*i),1/12*e*(2*r*2*r+2*n*2*n))};var x=new h;g.prototype.computeLocalAABB=function(e){var t=this;var n=e.lowerBound,r=e.upperBound,i=this.vertices.length,a=this.vertices,o=x;this.getVertex(0,o);n.copy(o);r.copy(o);for(var s=0;s!==i;s++){t.getVertex(s,o);if(o.x<n.x){n.x=o.x}else if(o.x>r.x){r.x=o.x}if(o.y<n.y){n.y=o.y}else if(o.y>r.y){r.y=o.y}if(o.z<n.z){n.z=o.z}else if(o.z>r.z){r.z=o.z}}};g.prototype.updateAABB=function(){this.computeLocalAABB(this.aabb)};g.prototype.updateBoundingSphereRadius=function(){var e=this;var t=0;var n=this.vertices;var r=new h;for(var i=0,a=n.length/3;i!==a;i++){e.getVertex(i,r);var o=r.norm2();if(o>t){t=o}}this.boundingSphereRadius=Math.sqrt(t)};var b=new h;var w=new a;var E=new c;g.prototype.calculateWorldAABB=function(e,t,n,r){var i=w;var a=E;i.position=e;i.quaternion=t;this.aabb.toWorldFrame(i,a);n.copy(a.lowerBound);r.copy(a.upperBound)};g.prototype.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3};g.createTorus=function(e,t,n,r,i){e=e||1;t=t||.5;n=n||8;r=r||6;i=i||Math.PI*2;var a=[];var o=[];for(var s=0;s<=n;s++){for(var l=0;l<=r;l++){var u=l/r*i;var h=s/n*Math.PI*2;var c=(e+t*Math.cos(h))*Math.cos(u);var f=(e+t*Math.cos(h))*Math.sin(u);var p=t*Math.sin(h);a.push(c,f,p)}}for(var s=1;s<=n;s++){for(var l=1;l<=r;l++){var d=(r+1)*s+l-1;var v=(r+1)*(s-1)+l-1;var m=(r+1)*(s-1)+l;var _=(r+1)*s+l;o.push(d,v,_);o.push(v,m,_)}}return new g(a,o)}},{"../collision/AABB":3,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../utils/Octree":50,"./Shape":43}],46:[function(e,t,n){t.exports=o;var r=e("../math/Vec3");var i=e("../math/Quaternion");var a=e("./Solver");function o(){a.call(this);this.iterations=10;this.tolerance=1e-7}o.prototype=new a;var R=[];var L=[];var C=[];o.prototype.solve=function(e,t){var n=0,r=this.iterations,i=this.tolerance*this.tolerance,a=this.equations,o=a.length,s=t.bodies,l=s.length,u=e,h,c,f,p,d,v,m;if(o!==0){for(var _=0;_!==l;_++){s[_].updateSolveMassProperties()}}var g=L,y=C,x=R;g.length=o;y.length=o;x.length=o;for(var _=0;_!==o;_++){var b=a[_];x[_]=0;y[_]=b.computeB(u);g[_]=1/b.computeC()}if(o!==0){for(var _=0;_!==l;_++){var w=s[_],E=w.vlambda,T=w.wlambda;E.set(0,0,0);if(T){T.set(0,0,0)}}for(n=0;n!==r;n++){d=0;for(var S=0;S!==o;S++){var b=a[S];c=y[S];f=g[S];m=x[S];v=b.computeGWlambda();p=f*(c-v-b.eps*m);if(m+p<b.minForce){p=b.minForce-m}else if(m+p>b.maxForce){p=b.maxForce-m}x[S]+=p;d+=p>0?p:-p;b.addToWlambda(p)}if(d*d<i){break}}for(var _=0;_!==l;_++){var w=s[_],A=w.velocity,M=w.angularVelocity;A.vadd(w.vlambda,A);if(M){M.vadd(w.wlambda,M)}}}return n}},{"../math/Quaternion":28,"../math/Vec3":30,"./Solver":47}],47:[function(e,t,n){t.exports=r;function r(){this.equations=[]}r.prototype.solve=function(e,t){return 0};r.prototype.addEquation=function(e){if(e.enabled){this.equations.push(e)}};r.prototype.removeEquation=function(e){var t=this.equations;var n=t.indexOf(e);if(n!==-1){t.splice(n,1)}};r.prototype.removeAllEquations=function(){this.equations.length=0}},{}],48:[function(e,t,n){t.exports=s;var r=e("../math/Vec3");var i=e("../math/Quaternion");var a=e("./Solver");var o=e("../objects/Body");function s(e){var t=this;a.call(this);this.iterations=10;this.tolerance=1e-7;this.subsolver=e;this.nodes=[];this.nodePool=[];while(this.nodePool.length<128){t.nodePool.push(t.createNode())}}s.prototype=new a;var E=[];var T=[];var S={bodies:[]};var l=o.STATIC;function A(e){var t=e.length;for(var n=0;n!==t;n++){var r=e[n];if(!r.visited&&!(r.body.type&l)){return r}}return false}var u=[];function M(e,t,n,r){u.push(e);e.visited=true;t(e,n,r);while(u.length){var i=u.pop();var a;while(a=A(i.children)){a.visited=true;t(a,n,r);u.push(a)}}}function R(e,t,n){t.push(e.body);var r=e.eqs.length;for(var i=0;i!==r;i++){var a=e.eqs[i];if(n.indexOf(a)===-1){n.push(a)}}}s.prototype.createNode=function(){return{body:null,children:[],eqs:[],visited:false}};s.prototype.solve=function(e,t){var n=this;var r=E,i=this.nodePool,a=t.bodies,o=this.equations,s=o.length,l=a.length,u=this.subsolver;while(i.length<l){i.push(n.createNode())}r.length=l;for(var h=0;h<l;h++){r[h]=i[h]}for(var h=0;h!==l;h++){var c=r[h];c.body=a[h];c.children.length=0;c.eqs.length=0;c.visited=false}for(var f=0;f!==s;f++){var p=o[f],h=a.indexOf(p.bi),d=a.indexOf(p.bj),v=r[h],m=r[d];v.children.push(m);v.eqs.push(p);m.children.push(v);m.eqs.push(p)}var _,g=0,y=T;u.tolerance=this.tolerance;u.iterations=this.iterations;var x=S;while(_=A(r)){y.length=0;x.bodies.length=0;M(_,R,x.bodies,y);var b=y.length;y=y.sort(L);for(var h=0;h!==b;h++){u.addEquation(y[h])}var w=u.solve(e,x);u.removeAllEquations();g++}return g};function L(e,t){return t.id-e.id}},{"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"./Solver":47}],49:[function(e,t,n){var r=function(){};t.exports=r;r.prototype={constructor:r,addEventListener:function(e,t){if(this._listeners===undefined){this._listeners={}}var n=this._listeners;if(n[e]===undefined){n[e]=[]}if(n[e].indexOf(t)===-1){n[e].push(t)}return this},hasEventListener:function(e,t){if(this._listeners===undefined){return false}var n=this._listeners;if(n[e]!==undefined&&n[e].indexOf(t)!==-1){return true}return false},removeEventListener:function(e,t){if(this._listeners===undefined){return this}var n=this._listeners;if(n[e]===undefined){return this}var r=n[e].indexOf(t);if(r!==-1){n[e].splice(r,1)}return this},dispatchEvent:function(e){var t=this;if(this._listeners===undefined){return this}var n=this._listeners;var r=n[e.type];if(r!==undefined){e.target=this;for(var i=0,a=r.length;i<a;i++){r[i].call(t,e)}}return this}}},{}],50:[function(e,t,n){var l=e("../collision/AABB");var u=e("../math/Vec3");t.exports=r;function h(e){e=e||{};this.root=e.root||null;this.aabb=e.aabb?e.aabb.clone():new l;this.data=[];this.children=[]}function r(e,t){t=t||{};t.root=null;t.aabb=e;h.call(this,t);this.maxDepth=typeof t.maxDepth!=="undefined"?t.maxDepth:8}r.prototype=new h;h.prototype.reset=function(e,t){this.children.length=this.data.length=0};h.prototype.insert=function(e,t,n){var r=this.data;n=n||0;if(!this.aabb.contains(e)){return false}var i=this.children;if(n<(this.maxDepth||this.root.maxDepth)){var a=false;if(!i.length){this.subdivide();a=true}for(var o=0;o!==8;o++){if(i[o].insert(e,t,n+1)){return true}}if(a){i.length=0}}r.push(t);return true};var c=new u;h.prototype.subdivide=function(){var e=this.aabb;var t=e.lowerBound;var n=e.upperBound;var r=this.children;r.push(new h({aabb:new l({lowerBound:new u(0,0,0)})}),new h({aabb:new l({lowerBound:new u(1,0,0)})}),new h({aabb:new l({lowerBound:new u(1,1,0)})}),new h({aabb:new l({lowerBound:new u(1,1,1)})}),new h({aabb:new l({lowerBound:new u(0,1,1)})}),new h({aabb:new l({lowerBound:new u(0,0,1)})}),new h({aabb:new l({lowerBound:new u(1,0,1)})}),new h({aabb:new l({lowerBound:new u(0,1,0)})}));n.vsub(t,c);c.scale(.5,c);var i=this.root||this;for(var a=0;a!==8;a++){var o=r[a];o.root=i;var s=o.aabb.lowerBound;s.x*=c.x;s.y*=c.y;s.z*=c.z;s.vadd(t,s);s.vadd(c,o.aabb.upperBound)}};h.prototype.aabbQuery=function(e,t){var n=this.data;var r=this.children;var i=[this];while(i.length){var a=i.pop();if(a.aabb.overlaps(e)){Array.prototype.push.apply(t,a.data)}Array.prototype.push.apply(i,a.children)}return t};var i=new l;h.prototype.rayQuery=function(e,t,n){e.getAABB(i);i.toLocalFrame(t,i);this.aabbQuery(i,n);return n};h.prototype.removeEmptyNodes=function(){var e=[this];while(e.length){var t=e.pop();for(var n=t.children.length-1;n>=0;n--){if(!t.children[n].data.length){t.children.splice(n,1)}}Array.prototype.push.apply(e,t.children)}}},{"../collision/AABB":3,"../math/Vec3":30}],51:[function(e,t,n){t.exports=r;function r(){this.objects=[];this.type=Object}r.prototype.release=function(){var e=arguments;var t=this;var n=arguments.length;for(var r=0;r!==n;r++){t.objects.push(e[r])}};r.prototype.get=function(){if(this.objects.length===0){return this.constructObject()}else{return this.objects.pop()}};r.prototype.constructObject=function(){throw new Error("constructObject() not implemented in this Pool subclass yet!")}},{}],52:[function(e,t,n){t.exports=r;function r(){this.data={keys:[]}}r.prototype.get=function(e,t){if(e>t){var n=t;t=e;e=n}return this.data[e+"-"+t]};r.prototype.set=function(e,t,n){if(e>t){var r=t;t=e;e=r}var i=e+"-"+t;if(!this.get(e,t)){this.data.keys.push(i)}this.data[i]=n};r.prototype.reset=function(){var e=this.data,t=e.keys;while(t.length>0){var n=t.pop();delete e[n]}}},{}],53:[function(e,t,n){function r(){}t.exports=r;r.defaults=function(e,t){e=e||{};for(var n in t){if(!(n in e)){e[n]=t[n]}}return e}},{}],54:[function(e,t,n){t.exports=a;var r=e("../math/Vec3");var i=e("./Pool");function a(){i.call(this);this.type=r}a.prototype=new i;a.prototype.constructObject=function(){return new r}},{"../math/Vec3":30,"./Pool":51}],55:[function(e,t,n){t.exports=u;var r=e("../collision/AABB");var i=e("../shapes/Shape");var U=e("../collision/Ray");var _=e("../math/Vec3");var P=e("../math/Transform");var a=e("../shapes/ConvexPolyhedron");var o=e("../math/Quaternion");var s=e("../solver/Solver");var l=e("../utils/Vec3Pool");var h=e("../equations/ContactEquation");var m=e("../equations/FrictionEquation");function u(e){this.contactPointPool=[];this.frictionEquationPool=[];this.result=[];this.frictionResult=[];this.v3pool=new l;this.world=e;this.currentContactMaterial=null;this.enableFrictionReduction=false}u.prototype.createContactEquation=function(e,t,n,r,i,a){var o;if(this.contactPointPool.length){o=this.contactPointPool.pop();o.bi=e;o.bj=t}else{o=new h(e,t)}o.enabled=e.collisionResponse&&t.collisionResponse&&n.collisionResponse&&r.collisionResponse;var s=this.currentContactMaterial;o.restitution=s.restitution;o.setSpookParams(s.contactEquationStiffness,s.contactEquationRelaxation,this.world.dt);var l=n.material||e.material;var u=r.material||t.material;if(l&&u&&l.restitution>=0&&u.restitution>=0){o.restitution=l.restitution*u.restitution}o.si=i||n;o.sj=a||r;return o};u.prototype.createFrictionEquationsFromContact=function(e,t){var n=e.bi;var r=e.bj;var i=e.si;var a=e.sj;var o=this.world;var s=this.currentContactMaterial;var l=s.friction;var u=i.material||n.material;var h=a.material||r.material;if(u&&h&&u.friction>=0&&h.friction>=0){l=u.friction*h.friction}if(l>0){var c=l*o.gravity.length();var f=n.invMass+r.invMass;if(f>0){f=1/f}var p=this.frictionEquationPool;var d=p.length?p.pop():new m(n,r,c*f);var v=p.length?p.pop():new m(n,r,c*f);d.bi=v.bi=n;d.bj=v.bj=r;d.minForce=v.minForce=-c*f;d.maxForce=v.maxForce=c*f;d.ri.copy(e.ri);d.rj.copy(e.rj);v.ri.copy(e.ri);v.rj.copy(e.rj);e.ni.tangents(d.t,v.t);d.setSpookParams(s.frictionEquationStiffness,s.frictionEquationRelaxation,o.dt);v.setSpookParams(s.frictionEquationStiffness,s.frictionEquationRelaxation,o.dt);d.enabled=v.enabled=e.enabled;t.push(d,v);return true}return false};var c=new _;var f=new _;var p=new _;u.prototype.createFrictionFromAverage=function(e){var t=this;var n=this.result[this.result.length-1];if(!this.createFrictionEquationsFromContact(n,this.frictionResult)||e===1){return}var r=this.frictionResult[this.frictionResult.length-2];var i=this.frictionResult[this.frictionResult.length-1];c.setZero();f.setZero();p.setZero();var a=n.bi;var o=n.bj;for(var s=0;s!==e;s++){n=t.result[t.result.length-1-s];if(n.bodyA!==a){c.vadd(n.ni,c);f.vadd(n.ri,f);p.vadd(n.rj,p)}else{c.vsub(n.ni,c);f.vadd(n.rj,f);p.vadd(n.ri,p)}}var l=1/e;f.scale(l,r.ri);p.scale(l,r.rj);i.ri.copy(r.ri);i.rj.copy(r.rj);c.normalize();c.tangents(r.t,i.t)};var E=new _;var T=new _;var S=new o;var A=new o;u.prototype.getContacts=function(e,t,n,r,i,a,o){var s=this;this.contactPointPool=i;this.frictionEquationPool=o;this.result=r;this.frictionResult=a;var l=S;var u=A;var h=E;var c=T;for(var f=0,p=e.length;f!==p;f++){var d=e[f],v=t[f];var m=null;if(d.material&&v.material){m=n.getContactMaterial(d.material,v.material)||null}for(var _=0;_<d.shapes.length;_++){d.quaternion.mult(d.shapeOrientations[_],l);d.quaternion.vmult(d.shapeOffsets[_],h);h.vadd(d.position,h);var g=d.shapes[_];for(var y=0;y<v.shapes.length;y++){v.quaternion.mult(v.shapeOrientations[y],u);v.quaternion.vmult(v.shapeOffsets[y],c);c.vadd(v.position,c);var x=v.shapes[y];if(h.distanceTo(c)>g.boundingSphereRadius+x.boundingSphereRadius){continue}var b=null;if(g.material&&x.material){b=n.getContactMaterial(g.material,x.material)||null}s.currentContactMaterial=b||m||n.defaultContactMaterial;var w=s[g.type|x.type];if(w){if(g.type<x.type){w.call(s,g,x,h,c,l,u,d,v,g,x)}else{w.call(s,x,g,c,h,u,l,v,d,g,x)}}}}}};u.prototype[i.types.BOX|i.types.BOX]=u.prototype.boxBox=function(e,t,n,r,i,a,o,s){e.convexPolyhedronRepresentation.material=e.material;t.convexPolyhedronRepresentation.material=t.material;e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse;t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse;this.convexConvex(e.convexPolyhedronRepresentation,t.convexPolyhedronRepresentation,n,r,i,a,o,s,e,t)};u.prototype[i.types.BOX|i.types.CONVEXPOLYHEDRON]=u.prototype.boxConvex=function(e,t,n,r,i,a,o,s){e.convexPolyhedronRepresentation.material=e.material;e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse;this.convexConvex(e.convexPolyhedronRepresentation,t,n,r,i,a,o,s,e,t)};u.prototype[i.types.BOX|i.types.PARTICLE]=u.prototype.boxParticle=function(e,t,n,r,i,a,o,s){e.convexPolyhedronRepresentation.material=e.material;e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse;this.convexParticle(e.convexPolyhedronRepresentation,t,n,r,i,a,o,s,e,t)};u.prototype[i.types.SPHERE]=u.prototype.sphereSphere=function(e,t,n,r,i,a,o,s){var l=this.createContactEquation(o,s,e,t);r.vsub(n,l.ni);l.ni.normalize();l.ri.copy(l.ni);l.rj.copy(l.ni);l.ri.mult(e.radius,l.ri);l.rj.mult(-t.radius,l.rj);l.ri.vadd(n,l.ri);l.ri.vsub(o.position,l.ri);l.rj.vadd(r,l.rj);l.rj.vsub(s.position,l.rj);this.result.push(l);this.createFrictionEquationsFromContact(l,this.frictionResult)};var g=new _;var y=new _;var x=new _;u.prototype[i.types.PLANE|i.types.TRIMESH]=u.prototype.planeTrimesh=function(e,t,n,r,i,a,o,s){var l=this;var u=new _;var h=g;h.set(0,0,1);i.vmult(h,h);for(var c=0;c<t.vertices.length/3;c++){t.getVertex(c,u);var f=new _;f.copy(u);P.pointToWorldFrame(r,a,f,u);var p=y;u.vsub(n,p);var d=h.dot(p);if(d<=0){var v=l.createContactEquation(o,s,e,t);v.ni.copy(h);var m=x;h.scale(p.dot(h),m);u.vsub(m,m);v.ri.copy(m);v.ri.vsub(o.position,v.ri);v.rj.copy(u);v.rj.vsub(s.position,v.rj);l.result.push(v);l.createFrictionEquationsFromContact(v,l.frictionResult)}}};var B=new _;var D=new _;var d=new _;var F=new _;var z=new _;var N=new _;var k=new _;var V=new _;var W=new _;var G=new _;var H=new _;var j=new _;var q=new _;var X=new _;var Y=new r;var K=[];u.prototype[i.types.SPHERE|i.types.TRIMESH]=u.prototype.sphereTrimesh=function(e,t,n,r,i,a,o,s){var l=this;var u=N;var h=k;var c=V;var f=W;var p=G;var d=H;var v=Y;var m=z;var _=D;var g=K;P.pointToLocalFrame(r,a,n,p);var y=e.radius;v.lowerBound.set(p.x-y,p.y-y,p.z-y);v.upperBound.set(p.x+y,p.y+y,p.z+y);t.getTrianglesInAABB(v,g);var x=F;var b=e.radius*e.radius;for(var w=0;w<g.length;w++){for(var E=0;E<3;E++){t.getVertex(t.indices[g[w]*3+E],x);x.vsub(p,_);if(_.norm2()<=b){m.copy(x);P.pointToWorldFrame(r,a,m,x);x.vsub(n,_);var T=l.createContactEquation(o,s,e,t);T.ni.copy(_);T.ni.normalize();T.ri.copy(T.ni);T.ri.scale(e.radius,T.ri);T.ri.vadd(n,T.ri);T.ri.vsub(o.position,T.ri);T.rj.copy(x);T.rj.vsub(s.position,T.rj);l.result.push(T);l.createFrictionEquationsFromContact(T,l.frictionResult)}}}for(var w=0;w<g.length;w++){for(var E=0;E<3;E++){t.getVertex(t.indices[g[w]*3+E],u);t.getVertex(t.indices[g[w]*3+(E+1)%3],h);h.vsub(u,c);p.vsub(h,d);var S=d.dot(c);p.vsub(u,d);var A=d.dot(c);if(A>0&&S<0){p.vsub(u,d);f.copy(c);f.normalize();A=d.dot(f);f.scale(A,d);d.vadd(u,d);var M=d.distanceTo(p);if(M<e.radius){var T=l.createContactEquation(o,s,e,t);d.vsub(p,T.ni);T.ni.normalize();T.ni.scale(e.radius,T.ri);P.pointToWorldFrame(r,a,d,d);d.vsub(s.position,T.rj);P.vectorToWorldFrame(a,T.ni,T.ni);P.vectorToWorldFrame(a,T.ri,T.ri);l.result.push(T);l.createFrictionEquationsFromContact(T,l.frictionResult)}}}}var R=j;var L=q;var C=X;var O=B;for(var w=0,I=g.length;w!==I;w++){t.getTriangleVertices(g[w],R,L,C);t.getNormal(g[w],O);p.vsub(R,d);var M=d.dot(O);O.scale(M,d);p.vsub(d,d);M=d.distanceTo(p);if(U.pointInTriangle(d,R,L,C)&&M<e.radius){var T=l.createContactEquation(o,s,e,t);d.vsub(p,T.ni);T.ni.normalize();T.ni.scale(e.radius,T.ri);P.pointToWorldFrame(r,a,d,d);d.vsub(s.position,T.rj);P.vectorToWorldFrame(a,T.ni,T.ni);P.vectorToWorldFrame(a,T.ri,T.ri);l.result.push(T);l.createFrictionEquationsFromContact(T,l.frictionResult)}}g.length=0};var v=new _;var b=new _;u.prototype[i.types.SPHERE|i.types.PLANE]=u.prototype.spherePlane=function(e,t,n,r,i,a,o,s){var l=this.createContactEquation(o,s,e,t);l.ni.set(0,0,1);a.vmult(l.ni,l.ni);l.ni.negate(l.ni);l.ni.normalize();l.ni.mult(e.radius,l.ri);n.vsub(r,v);l.ni.mult(l.ni.dot(v),b);v.vsub(b,l.rj);if(-v.dot(l.ni)<=e.radius){var u=l.ri;var h=l.rj;u.vadd(n,u);u.vsub(o.position,u);h.vadd(r,h);h.vsub(s.position,h);this.result.push(l);this.createFrictionEquationsFromContact(l,this.frictionResult)}};var w=new _;var M=new _;var R=new _;function Z(e,t,n){var r=null;var i=e.length;for(var a=0;a!==i;a++){var o=e[a];var s=w;e[(a+1)%i].vsub(o,s);var l=M;s.cross(t,l);var u=R;n.vsub(o,u);var h=l.dot(u);if(r===null||h>0&&r===true||h<=0&&r===false){if(r===null){r=h>0}continue}else{return false}}return true}var Q=new _;var J=new _;var $=new _;var ee=new _;var te=[new _,new _,new _,new _,new _,new _];var ne=new _;var re=new _;var ie=new _;var ae=new _;u.prototype[i.types.SPHERE|i.types.BOX]=u.prototype.sphereBox=function(e,t,n,r,i,a,o,s){var l=this;var u=this.v3pool;var h=te;n.vsub(r,Q);t.getSideNormals(h,a);var c=e.radius;var f=false;var p=re;var d=ie;var v=ae;var m=null;var _=0;var g=0;var y=0;var x=null;for(var b=0,w=h.length;b!==w&&f===false;b++){var E=J;E.copy(h[b]);var T=E.norm();E.normalize();var S=Q.dot(E);if(S<T+c&&S>0){var A=$;var M=ee;A.copy(h[(b+1)%3]);M.copy(h[(b+2)%3]);var R=A.norm();var L=M.norm();A.normalize();M.normalize();var C=Q.dot(A);var O=Q.dot(M);if(C<R&&C>-R&&O<L&&O>-L){var I=Math.abs(S-T-c);if(x===null||I<x){x=I;g=C;y=O;m=T;p.copy(E);d.copy(A);v.copy(M);_++}}}}if(_){f=true;var U=this.createContactEquation(o,s,e,t);p.mult(-c,U.ri);U.ni.copy(p);U.ni.negate(U.ni);p.mult(m,p);d.mult(g,d);p.vadd(d,p);v.mult(y,v);p.vadd(v,U.rj);U.ri.vadd(n,U.ri);U.ri.vsub(o.position,U.ri);U.rj.vadd(r,U.rj);U.rj.vsub(s.position,U.rj);this.result.push(U);this.createFrictionEquationsFromContact(U,this.frictionResult)}var P=u.get();var B=ne;for(var D=0;D!==2&&!f;D++){for(var F=0;F!==2&&!f;F++){for(var z=0;z!==2&&!f;z++){P.set(0,0,0);if(D){P.vadd(h[0],P)}else{P.vsub(h[0],P)}if(F){P.vadd(h[1],P)}else{P.vsub(h[1],P)}if(z){P.vadd(h[2],P)}else{P.vsub(h[2],P)}r.vadd(P,B);B.vsub(n,B);if(B.norm2()<c*c){f=true;var U=l.createContactEquation(o,s,e,t);U.ri.copy(B);U.ri.normalize();U.ni.copy(U.ri);U.ri.mult(c,U.ri);U.rj.copy(P);U.ri.vadd(n,U.ri);U.ri.vsub(o.position,U.ri);U.rj.vadd(r,U.rj);U.rj.vsub(s.position,U.rj);l.result.push(U);l.createFrictionEquationsFromContact(U,l.frictionResult)}}}}u.release(P);P=null;var N=u.get();var k=u.get();var U=u.get();var V=u.get();var I=u.get();var W=h.length;for(var D=0;D!==W&&!f;D++){for(var F=0;F!==W&&!f;F++){if(D%3!==F%3){h[F].cross(h[D],N);N.normalize();h[D].vadd(h[F],k);U.copy(n);U.vsub(k,U);U.vsub(r,U);var G=U.dot(N);N.mult(G,V);var z=0;while(z===D%3||z===F%3){z++}I.copy(n);I.vsub(V,I);I.vsub(k,I);I.vsub(r,I);var H=Math.abs(G);var j=I.norm();if(H<h[z].norm()&&j<c){f=true;var q=l.createContactEquation(o,s,e,t);k.vadd(V,q.rj);q.rj.copy(q.rj);I.negate(q.ni);q.ni.normalize();q.ri.copy(q.rj);q.ri.vadd(r,q.ri);q.ri.vsub(n,q.ri);q.ri.normalize();q.ri.mult(c,q.ri);q.ri.vadd(n,q.ri);q.ri.vsub(o.position,q.ri);q.rj.vadd(r,q.rj);q.rj.vsub(s.position,q.rj);l.result.push(q);l.createFrictionEquationsFromContact(q,l.frictionResult)}}}}u.release(N,k,U,V,I)};var oe=new _;var se=new _;var le=new _;var ue=new _;var he=new _;var ce=new _;var fe=new _;var pe=new _;var de=new _;var ve=new _;u.prototype[i.types.SPHERE|i.types.CONVEXPOLYHEDRON]=u.prototype.sphereConvex=function(e,t,n,r,i,a,o,s){var l=this;var u=this.v3pool;n.vsub(r,oe);var h=t.faceNormals;var c=t.faces;var f=t.vertices;var p=e.radius;for(var d=0;d!==f.length;d++){var v=f[d];var m=he;a.vmult(v,m);r.vadd(m,m);var _=ue;m.vsub(n,_);if(_.norm2()<p*p){y=true;var g=l.createContactEquation(o,s,e,t);g.ri.copy(_);g.ri.normalize();g.ni.copy(g.ri);g.ri.mult(p,g.ri);m.vsub(r,g.rj);g.ri.vadd(n,g.ri);g.ri.vsub(o.position,g.ri);g.rj.vadd(r,g.rj);g.rj.vsub(s.position,g.rj);l.result.push(g);l.createFrictionEquationsFromContact(g,l.frictionResult);return}}var y=false;for(var d=0,x=c.length;d!==x&&y===false;d++){var b=h[d];var w=c[d];var E=ce;a.vmult(b,E);var T=fe;a.vmult(f[w[0]],T);T.vadd(r,T);var S=pe;E.mult(-p,S);n.vadd(S,S);var A=de;S.vsub(T,A);var M=A.dot(E);var R=ve;n.vsub(T,R);if(M<0&&R.dot(E)>0){var L=[];for(var C=0,O=w.length;C!==O;C++){var I=u.get();a.vmult(f[w[C]],I);r.vadd(I,I);L.push(I)}if(Z(L,E,n)){y=true;var g=l.createContactEquation(o,s,e,t);E.mult(-p,g.ri);E.negate(g.ni);var U=u.get();E.mult(-M,U);var P=u.get();E.mult(-p,P);n.vsub(r,g.rj);g.rj.vadd(P,g.rj);g.rj.vadd(U,g.rj);g.rj.vadd(r,g.rj);g.rj.vsub(s.position,g.rj);g.ri.vadd(n,g.ri);g.ri.vsub(o.position,g.ri);u.release(U);u.release(P);l.result.push(g);l.createFrictionEquationsFromContact(g,l.frictionResult);for(var C=0,B=L.length;C!==B;C++){u.release(L[C])}return}else{for(var C=0;C!==w.length;C++){var D=u.get();var F=u.get();a.vmult(f[w[(C+1)%w.length]],D);a.vmult(f[w[(C+2)%w.length]],F);r.vadd(D,D);r.vadd(F,F);var z=se;F.vsub(D,z);var N=le;z.unit(N);var k=u.get();var V=u.get();n.vsub(D,V);var W=V.dot(N);N.mult(W,k);k.vadd(D,k);var G=u.get();k.vsub(n,G);if(W>0&&W*W<z.norm2()&&G.norm2()<p*p){var g=l.createContactEquation(o,s,e,t);k.vsub(r,g.rj);k.vsub(n,g.ni);g.ni.normalize();g.ni.mult(p,g.ri);g.rj.vadd(r,g.rj);g.rj.vsub(s.position,g.rj);g.ri.vadd(n,g.ri);g.ri.vsub(o.position,g.ri);l.result.push(g);l.createFrictionEquationsFromContact(g,l.frictionResult);for(var C=0,B=L.length;C!==B;C++){u.release(L[C])}u.release(D);u.release(F);u.release(k);u.release(G);u.release(V);return}u.release(D);u.release(F);u.release(k);u.release(G);u.release(V)}}for(var C=0,B=L.length;C!==B;C++){u.release(L[C])}}}};var L=new _;var C=new _;u.prototype[i.types.PLANE|i.types.BOX]=u.prototype.planeBox=function(e,t,n,r,i,a,o,s){t.convexPolyhedronRepresentation.material=t.material;t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse;this.planeConvex(e,t.convexPolyhedronRepresentation,n,r,i,a,o,s)};var O=new _;var I=new _;var me=new _;var _e=new _;u.prototype[i.types.PLANE|i.types.CONVEXPOLYHEDRON]=u.prototype.planeConvex=function(e,t,n,r,i,a,o,s){var l=this;var u=O,h=I;h.set(0,0,1);i.vmult(h,h);var c=0;var f=me;for(var p=0;p!==t.vertices.length;p++){u.copy(t.vertices[p]);a.vmult(u,u);r.vadd(u,u);u.vsub(n,f);var d=h.dot(f);if(d<=0){var v=l.createContactEquation(o,s,e,t);var m=_e;h.mult(h.dot(f),m);u.vsub(m,m);m.vsub(n,v.ri);v.ni.copy(h);u.vsub(r,v.rj);v.ri.vadd(n,v.ri);v.ri.vsub(o.position,v.ri);v.rj.vadd(r,v.rj);v.rj.vsub(s.position,v.rj);l.result.push(v);c++;if(!l.enableFrictionReduction){l.createFrictionEquationsFromContact(v,l.frictionResult)}}}if(this.enableFrictionReduction&&c){this.createFrictionFromAverage(c)}};var ge=new _;var ye=new _;u.prototype[i.types.CONVEXPOLYHEDRON]=u.prototype.convexConvex=function(e,t,n,r,i,a,o,s,l,u,h,c){var f=this;var p=ge;if(n.distanceTo(r)>e.boundingSphereRadius+t.boundingSphereRadius){return}if(e.findSeparatingAxis(t,n,i,r,a,p,h,c)){var d=[];var v=ye;e.clipAgainstHull(n,i,t,r,a,p,-100,100,d);var m=0;for(var _=0;_!==d.length;_++){var g=f.createContactEquation(o,s,e,t,l,u),y=g.ri,x=g.rj;p.negate(g.ni);d[_].normal.negate(v);v.mult(d[_].depth,v);d[_].point.vadd(v,y);x.copy(d[_].point);y.vsub(n,y);x.vsub(r,x);y.vadd(n,y);y.vsub(o.position,y);x.vadd(r,x);x.vsub(s.position,x);f.result.push(g);m++;if(!f.enableFrictionReduction){f.createFrictionEquationsFromContact(g,f.frictionResult)}}if(this.enableFrictionReduction&&m){this.createFrictionFromAverage(m)}}};var xe=new _;var be=new _;var we=new _;u.prototype[i.types.PLANE|i.types.PARTICLE]=u.prototype.planeParticle=function(e,t,n,r,i,a,o,s){var l=xe;l.set(0,0,1);o.quaternion.vmult(l,l);var u=be;r.vsub(o.position,u);var h=l.dot(u);if(h<=0){var c=this.createContactEquation(s,o,t,e);c.ni.copy(l);c.ni.negate(c.ni);c.ri.set(0,0,0);var f=we;l.mult(l.dot(r),f);r.vsub(f,f);c.rj.copy(f);this.result.push(c);this.createFrictionEquationsFromContact(c,this.frictionResult)}};var Ee=new _;u.prototype[i.types.PARTICLE|i.types.SPHERE]=u.prototype.sphereParticle=function(e,t,n,r,i,a,o,s){var l=Ee;l.set(0,0,1);r.vsub(n,l);var u=l.norm2();if(u<=e.radius*e.radius){var h=this.createContactEquation(s,o,t,e);l.normalize();h.rj.copy(l);h.rj.mult(e.radius,h.rj);h.ni.copy(l);h.ni.negate(h.ni);h.ri.set(0,0,0);this.result.push(h);this.createFrictionEquationsFromContact(h,this.frictionResult)}};var Te=new o;var Se=new _;var Ae=new _;var Me=new _;var Re=new _;var Le=new _;u.prototype[i.types.PARTICLE|i.types.CONVEXPOLYHEDRON]=u.prototype.convexParticle=function(e,t,n,r,i,a,o,s){var l=-1;var u=Me;var h=Le;var c=null;var f=Se;f.copy(r);f.vsub(n,f);i.conjugate(Te);Te.vmult(f,f);if(e.pointIsInside(f)){if(e.worldVerticesNeedsUpdate){e.computeWorldVertices(n,i)}if(e.worldFaceNormalsNeedsUpdate){e.computeWorldFaceNormals(i)}for(var p=0,d=e.faces.length;p!==d;p++){var v=[e.worldVertices[e.faces[p][0]]];var m=e.worldFaceNormals[p];r.vsub(v[0],Re);var _=-m.dot(Re);if(c===null||Math.abs(_)<Math.abs(c)){c=_;l=p;u.copy(m)}}if(l!==-1){var g=this.createContactEquation(s,o,t,e);u.mult(c,h);h.vadd(r,h);h.vsub(n,h);g.rj.copy(h);u.negate(g.ni);g.ri.set(0,0,0);var y=g.ri,x=g.rj;y.vadd(r,y);y.vsub(s.position,y);x.vadd(n,x);x.vsub(o.position,x);this.result.push(g);this.createFrictionEquationsFromContact(g,this.frictionResult)}else{console.warn("Point found inside convex, but did not find penetrating face!")}}};u.prototype[i.types.BOX|i.types.HEIGHTFIELD]=u.prototype.boxHeightfield=function(e,t,n,r,i,a,o,s){e.convexPolyhedronRepresentation.material=e.material;e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse;this.convexHeightfield(e.convexPolyhedronRepresentation,t,n,r,i,a,o,s)};var Ce=new _;var Oe=new _;var Ie=[0];u.prototype[i.types.CONVEXPOLYHEDRON|i.types.HEIGHTFIELD]=u.prototype.convexHeightfield=function(e,t,n,r,i,a,o,s){var l=this;var u=t.data,h=t.elementSize,c=e.boundingSphereRadius,f=Oe,p=Ie;var d=Ce;P.pointToLocalFrame(r,a,n,d);var v=Math.floor((d.x-c)/h)-1,m=Math.ceil((d.x+c)/h)+1,_=Math.floor((d.y-c)/h)-1,g=Math.ceil((d.y+c)/h)+1;if(m<0||g<0||v>u.length||_>u[0].length){return}if(v<0){v=0}if(m<0){m=0}if(_<0){_=0}if(g<0){g=0}if(v>=u.length){v=u.length-1}if(m>=u.length){m=u.length-1}if(g>=u[0].length){g=u[0].length-1}if(_>=u[0].length){_=u[0].length-1}var y=[];t.getRectMinMax(v,_,m,g,y);var x=y[0];var b=y[1];if(d.z-c>b||d.z+c<x){return}for(var w=v;w<m;w++){for(var E=_;E<g;E++){t.getConvexTrianglePillar(w,E,false);P.pointToWorldFrame(r,a,t.pillarOffset,f);if(n.distanceTo(f)<t.pillarConvex.boundingSphereRadius+e.boundingSphereRadius){l.convexConvex(e,t.pillarConvex,n,f,i,a,o,s,null,null,p,null)}t.getConvexTrianglePillar(w,E,true);P.pointToWorldFrame(r,a,t.pillarOffset,f);if(n.distanceTo(f)<t.pillarConvex.boundingSphereRadius+e.boundingSphereRadius){l.convexConvex(e,t.pillarConvex,n,f,i,a,o,s,null,null,p,null)}}}};var Ue=new _;var Pe=new _;u.prototype[i.types.SPHERE|i.types.HEIGHTFIELD]=u.prototype.sphereHeightfield=function(e,t,n,r,i,a,o,s){var l=this;var u=t.data,h=e.radius,c=t.elementSize,f=Pe;var p=Ue;P.pointToLocalFrame(r,a,n,p);var d=Math.floor((p.x-h)/c)-1,v=Math.ceil((p.x+h)/c)+1,m=Math.floor((p.y-h)/c)-1,_=Math.ceil((p.y+h)/c)+1;if(v<0||_<0||d>u.length||_>u[0].length){return}if(d<0){d=0}if(v<0){v=0}if(m<0){m=0}if(_<0){_=0}if(d>=u.length){d=u.length-1}if(v>=u.length){v=u.length-1}if(_>=u[0].length){_=u[0].length-1}if(m>=u[0].length){m=u[0].length-1}var g=[];t.getRectMinMax(d,m,v,_,g);var y=g[0];var x=g[1];if(p.z-h>x||p.z+h<y){return}var b=this.result;for(var w=d;w<v;w++){for(var E=m;E<_;E++){var T=b.length;t.getConvexTrianglePillar(w,E,false);P.pointToWorldFrame(r,a,t.pillarOffset,f);if(n.distanceTo(f)<t.pillarConvex.boundingSphereRadius+e.boundingSphereRadius){l.sphereConvex(e,t.pillarConvex,n,f,i,a,o,s)}t.getConvexTrianglePillar(w,E,true);P.pointToWorldFrame(r,a,t.pillarOffset,f);if(n.distanceTo(f)<t.pillarConvex.boundingSphereRadius+e.boundingSphereRadius){l.sphereConvex(e,t.pillarConvex,n,f,i,a,o,s)}var S=b.length-T;if(S>2){return}}}}},{"../collision/AABB":3,"../collision/Ray":9,"../equations/ContactEquation":19,"../equations/FrictionEquation":21,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../shapes/ConvexPolyhedron":38,"../shapes/Shape":43,"../solver/Solver":47,"../utils/Vec3Pool":54}],56:[function(e,t,n){t.exports=y;var ve=e("../shapes/Shape");var r=e("../math/Vec3");var i=e("../math/Quaternion");var a=e("../solver/GSSolver");var o=e("../utils/Vec3Pool");var s=e("../equations/ContactEquation");var l=e("../equations/FrictionEquation");var u=e("./Narrowphase");var h=e("../utils/EventTarget");var c=e("../collision/ArrayCollisionMatrix");var f=e("../material/Material");var p=e("../material/ContactMaterial");var me=e("../objects/Body");var d=e("../utils/TupleDictionary");var v=e("../collision/RaycastResult");var m=e("../collision/AABB");var _=e("../collision/Ray");var g=e("../collision/NaiveBroadphase");function y(){h.apply(this);this.dt=-1;this.allowSleep=false;this.contacts=[];this.frictionEquations=[];this.quatNormalizeSkip=0;this.quatNormalizeFast=false;this.time=0;this.stepnumber=0;this.default_dt=1/60;this.nextId=0;this.gravity=new r;this.broadphase=new g;this.bodies=[];this.solver=new a;this.constraints=[];this.narrowphase=new u(this);this.collisionMatrix=new c;this.collisionMatrixPrevious=new c;this.materials=[];this.contactmaterials=[];this.contactMaterialTable=new d;this.defaultMaterial=new f("default");this.defaultContactMaterial=new p(this.defaultMaterial,this.defaultMaterial,{friction:.3,restitution:0});this.doProfiling=false;this.profile={solve:0,makeContactConstraints:0,broadphase:0,integrate:0,narrowphase:0};this.subsystems=[];this.addBodyEvent={type:"addBody",body:null};this.removeBodyEvent={type:"removeBody",body:null}}y.prototype=new h;var x=new m;var b=new _;y.prototype.getContactMaterial=function(e,t){return this.contactMaterialTable.get(e.id,t.id)};y.prototype.numObjects=function(){return this.bodies.length};y.prototype.collisionMatrixTick=function(){var e=this.collisionMatrixPrevious;this.collisionMatrixPrevious=this.collisionMatrix;this.collisionMatrix=e;this.collisionMatrix.reset()};y.prototype.add=y.prototype.addBody=function(e){if(this.bodies.indexOf(e)!==-1){return}e.index=this.bodies.length;this.bodies.push(e);e.world=this;e.initPosition.copy(e.position);e.initVelocity.copy(e.velocity);e.timeLastSleepy=this.time;if(e instanceof me){e.initAngularVelocity.copy(e.angularVelocity);e.initQuaternion.copy(e.quaternion)}this.collisionMatrix.setNumObjects(this.bodies.length);this.addBodyEvent.body=e;this.dispatchEvent(this.addBodyEvent)};y.prototype.addConstraint=function(e){this.constraints.push(e)};y.prototype.removeConstraint=function(e){var t=this.constraints.indexOf(e);if(t!==-1){this.constraints.splice(t,1)}};y.prototype.rayTest=function(e,t,n){if(n instanceof v){this.raycastClosest(e,t,{skipBackfaces:true},n)}else{this.raycastAll(e,t,{skipBackfaces:true},n)}};y.prototype.raycastAll=function(e,t,n,r){n.mode=_.ALL;n.from=e;n.to=t;n.callback=r;return b.intersectWorld(this,n)};y.prototype.raycastAny=function(e,t,n,r){n.mode=_.ANY;n.from=e;n.to=t;n.result=r;return b.intersectWorld(this,n)};y.prototype.raycastClosest=function(e,t,n,r){n.mode=_.CLOSEST;n.from=e;n.to=t;n.result=r;return b.intersectWorld(this,n)};y.prototype.remove=function(e){e.world=null;var t=this.bodies.length-1,n=this.bodies,r=n.indexOf(e);if(r!==-1){n.splice(r,1);for(var i=0;i!==n.length;i++){n[i].index=i}this.collisionMatrix.setNumObjects(t);this.removeBodyEvent.body=e;this.dispatchEvent(this.removeBodyEvent)}};y.prototype.removeBody=y.prototype.remove;y.prototype.addMaterial=function(e){this.materials.push(e)};y.prototype.addContactMaterial=function(e){this.contactmaterials.push(e);this.contactMaterialTable.set(e.materials[0].id,e.materials[1].id,e)};if(typeof performance==="undefined"){performance={}}if(!performance.now){var w=Date.now();if(performance.timing&&performance.timing.navigationStart){w=performance.timing.navigationStart}performance.now=function(){return Date.now()-w}}var E=new r;y.prototype.step=function(e,t,n){var r=this;n=n||10;t=t||0;if(t===0){this.internalStep(e);this.time+=e}else{var i=Math.floor((this.time+t)/e)-Math.floor(this.time/e);i=Math.min(i,n);var a=performance.now();for(var o=0;o!==i;o++){r.internalStep(e);if(performance.now()-a>e*1e3){break}}this.time+=t;var s=this.time%e;var l=s/e;var u=E;var h=this.bodies;for(var c=0;c!==h.length;c++){var f=h[c];if(f.type!==me.STATIC&&f.sleepState!==me.SLEEPING){f.position.vsub(f.previousPosition,u);u.scale(l,u);f.position.vadd(u,f.interpolatedPosition)}else{f.interpolatedPosition.copy(f.position);f.interpolatedQuaternion.copy(f.quaternion)}}}};var _e={type:"postStep"},ge={type:"preStep"},ye={type:"collide",body:null,contact:null},xe=[],be=[],we=[],Ee=[],T=new r,S=new r,A=new r,M=new r,R=new r,L=new r,C=new r,O=new r,I=new r,U=new i,Te=new i,Se=new i,Ae=new r;y.prototype.internalStep=function(e){var t=this;this.dt=e;var n=this,r=this,i=this.contacts,a=we,o=Ee,s=this.numObjects(),l=this.bodies,u=this.solver,h=this.gravity,c=this.doProfiling,f=this.profile,p=me.DYNAMIC,d,v=this.constraints,m=be,_=h.norm(),g=h.x,y=h.y,x=h.z,b=0;if(c){d=performance.now()}for(b=0;b!==s;b++){var w=l[b];if(w.type&p){var E=w.force,T=w.mass;E.x+=T*g;E.y+=T*y;E.z+=T*x}}for(var b=0,S=this.subsystems.length;b!==S;b++){t.subsystems[b].update()}if(c){d=performance.now()}a.length=0;o.length=0;this.broadphase.collisionPairs(this,a,o);if(c){f.broadphase=performance.now()-d}var A=v.length;for(b=0;b!==A;b++){var M=v[b];if(!M.collideConnected){for(var R=a.length-1;R>=0;R-=1){if(M.bodyA===a[R]&&M.bodyB===o[R]||M.bodyB===a[R]&&M.bodyA===o[R]){a.splice(R,1);o.splice(R,1)}}}}this.collisionMatrixTick();if(c){d=performance.now()}var L=xe;var C=i.length;for(b=0;b!==C;b++){L.push(i[b])}i.length=0;var O=this.frictionEquations.length;for(b=0;b!==O;b++){m.push(t.frictionEquations[b])}this.frictionEquations.length=0;this.narrowphase.getContacts(a,o,this,i,L,this.frictionEquations,m);if(c){f.narrowphase=performance.now()-d}if(c){d=performance.now()}for(var b=0;b<this.frictionEquations.length;b++){u.addEquation(t.frictionEquations[b])}var I=i.length;for(var U=0;U!==I;U++){var M=i[U];var w=M.bi,P=M.bj,B=M.si,D=M.sj;var F;if(w.material&&P.material){F=t.getContactMaterial(w.material,P.material)||t.defaultContactMaterial}else{F=t.defaultContactMaterial}var z=F.friction;if(w.material&&P.material){if(w.material.friction>=0&&P.material.friction>=0){z=w.material.friction*P.material.friction}if(w.material.restitution>=0&&P.material.restitution>=0){M.restitution=w.material.restitution*P.material.restitution}}u.addEquation(M);if(w.allowSleep&&w.type===me.DYNAMIC&&w.sleepState===me.SLEEPING&&P.sleepState===me.AWAKE&&P.type!==me.STATIC){var N=P.velocity.norm2()+P.angularVelocity.norm2();var k=Math.pow(P.sleepSpeedLimit,2);if(N>=k*2){w._wakeUpAfterNarrowphase=true}}if(P.allowSleep&&P.type===me.DYNAMIC&&P.sleepState===me.SLEEPING&&w.sleepState===me.AWAKE&&w.type!==me.STATIC){var V=w.velocity.norm2()+w.angularVelocity.norm2();var W=Math.pow(w.sleepSpeedLimit,2);if(V>=W*2){P._wakeUpAfterNarrowphase=true}}t.collisionMatrix.set(w,P,true);if(!t.collisionMatrixPrevious.get(w,P)){ye.body=P;ye.contact=M;w.dispatchEvent(ye);ye.body=w;P.dispatchEvent(ye)}}if(c){f.makeContactConstraints=performance.now()-d;d=performance.now()}for(b=0;b!==s;b++){var w=l[b];if(w._wakeUpAfterNarrowphase){w.wakeUp();w._wakeUpAfterNarrowphase=false}}var A=v.length;for(b=0;b!==A;b++){var M=v[b];M.update();for(var R=0,G=M.equations.length;R!==G;R++){var H=M.equations[R];u.addEquation(H)}}u.solve(e,this);if(c){f.solve=performance.now()-d}u.removeAllEquations();var j=Math.pow;for(b=0;b!==s;b++){var w=l[b];if(w.type&p){var q=j(1-w.linearDamping,e);var X=w.velocity;X.mult(q,X);var Y=w.angularVelocity;if(Y){var K=j(1-w.angularDamping,e);Y.mult(K,Y)}}}this.dispatchEvent(ge);for(b=0;b!==s;b++){var w=l[b];if(w.preStep){w.preStep.call(w)}}if(c){d=performance.now()}var Z=Te;var Q=Se;var J=this.stepnumber;var $=me.DYNAMIC|me.KINEMATIC;var ee=J%(this.quatNormalizeSkip+1)===0;var te=this.quatNormalizeFast;var ne=e*.5;var re=ve.types.PLANE,ie=ve.types.CONVEXPOLYHEDRON;for(b=0;b!==s;b++){var ae=l[b],oe=ae.force,se=ae.torque;if(ae.type&$&&ae.sleepState!==me.SLEEPING){var le=ae.velocity,ue=ae.angularVelocity,he=ae.position,ce=ae.quaternion,fe=ae.invMass,pe=ae.invInertiaWorld;le.x+=oe.x*fe*e;le.y+=oe.y*fe*e;le.z+=oe.z*fe*e;if(ae.angularVelocity){pe.vmult(se,Ae);Ae.mult(e,Ae);Ae.vadd(ue,ue)}he.x+=le.x*e;he.y+=le.y*e;he.z+=le.z*e;if(ae.angularVelocity){Z.set(ue.x,ue.y,ue.z,0);Z.mult(ce,Q);ce.x+=ne*Q.x;ce.y+=ne*Q.y;ce.z+=ne*Q.z;ce.w+=ne*Q.w;if(ee){if(te){ce.normalizeFast()}else{ce.normalize()}}}if(ae.aabb){ae.aabbNeedsUpdate=true}if(ae.updateInertiaWorld){ae.updateInertiaWorld()}}}this.clearForces();this.broadphase.dirty=true;if(c){f.integrate=performance.now()-d}this.time+=e;this.stepnumber+=1;this.dispatchEvent(_e);for(b=0;b!==s;b++){var w=l[b];var de=w.postStep;if(de){de.call(w)}}if(this.allowSleep){for(b=0;b!==s;b++){l[b].sleepTick(t.time)}}};y.prototype.clearForces=function(){var e=this.bodies;var t=e.length;for(var n=0;n!==t;n++){var r=e[n],i=r.force,a=r.torque;r.force.set(0,0,0);r.torque.set(0,0,0)}}},{"../collision/AABB":3,"../collision/ArrayCollisionMatrix":4,"../collision/NaiveBroadphase":7,"../collision/Ray":9,"../collision/RaycastResult":10,"../equations/ContactEquation":19,"../equations/FrictionEquation":21,"../material/ContactMaterial":24,"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Shape":43,"../solver/GSSolver":46,"../utils/EventTarget":49,"../utils/TupleDictionary":52,"../utils/Vec3Pool":54,"./Narrowphase":55}]},{},[2])(2)})});var a_=Lt.zero();var o_=It.create();function s_(e){return Math.max(Math.max(e.x,e.y),e.z)}var l_=function(n){function e(e){var t=this;n.call(this,e);this._entity=e._entity;this._system=e._system;this._world=e._system.world;this._size=Lt.new(1,1,1);this._radius=1;this.shapeType=e.type;this.shape=this.createShape(e);this.addShape(this.shape,(new i_.Vec3).copy(e.center));this.addEventListener("collide",function(e){t._entity.emit("collide",e)});this.updateIn=this.updateIn.bind(this);this.updateOut=this.updateOut.bind(this);this.updateIn()}if(n)e.__proto__=n;e.prototype=Object.create(n&&n.prototype);e.prototype.constructor=e;e.prototype.createShape=function e(t){this._entity.getWorldScale(a_);switch(t.type){case"box":Lt.scale(a_,Lt.mul(a_,a_,t.size),.5);return new i_.Box(new i_.Vec3(a_.x,a_.y,a_.z));case"sphere":return new i_.Sphere(t.radius*s_(a_));default:console.warn("Unsupported collider type - only boxes and spheres are supported");return new i_.Box(new i_.Vec3(a_.x,a_.y,a_.z))}};e.prototype.setCollisionFilter=function e(t,n){this.collisionFilterGroup=t;this.collisionFilterMask=n};e.prototype.setMass=function e(t){this.mass=t;this.updateMassProperties();this._validateTypeAndMode()};e.prototype.setDrag=function e(t){this.linearDamping=t};e.prototype.setAngularDrag=function e(t){this.angularDamping=t};e.prototype.setIsKinematic=function e(t){this._isKinematic=t;this._validateTypeAndMode()};e.prototype.setFreezeRotation=function e(t){this.fixedRotation=t;this.updateMassProperties()};e.prototype.setIsTrigger=function e(t){if(t){this.setCollisionFilter(1<<31,1<<31);this.setUpdateMode(true,false)}else{this.setCollisionFilter(1,1);this._validateTypeAndMode()}};e.prototype.setCenter=function e(t){this.shapeOffsets[0].set(t.x,t.y,t.z);this.updateBoundingRadius()};e.prototype.setSize=function e(t){if(this.shapeType!="box"){return}if(!t){t=this._size}this._entity.getWorldScale(a_);Lt.scale(a_,Lt.mul(a_,a_,t),.5);this.shape.halfExtents.set(a_.x,a_.y,a_.z);this.shape.updateConvexPolyhedronRepresentation();this.shape.updateBoundingSphereRadius();this.updateBoundingRadius();this._size=t};e.prototype.setRadius=function e(t){if(this.shapeType!="sphere"){return}if(!t){t=this._radius}this._entity.getWorldScale(a_);this.shape.radius=t*s_(a_);this.shape.updateBoundingSphereRadius();this.updateBoundingRadius();this._radius=t};e.prototype.setUpdateMode=function e(t,n){if(t){this._world.addEventListener("preStep",this.updateIn)}else{this._world.removeEventListener("preStep",this.updateIn)}if(n){this._world.addEventListener("postStep",this.updateOut)}else{this._world.removeEventListener("postStep",this.updateOut)}};e.prototype._validateTypeAndMode=function e(){if(this._isKinematic){this.type=i_.Body.KINEMATIC}else{this.type=this.mass<=0?i_.Body.STATIC:i_.Body.DYNAMIC}if(this.type!==i_.Body.STATIC){this.setUpdateMode(false,true);this._system._fullSimulation=true}};e.prototype.manualUpdate=function e(t){if(t===void 0)t=true;this._entity._getWorldPosAndRot(a_,o_);this.position.copy(a_);if(t){this.quaternion.copy(o_)}this.setSize();this.setRadius()};e.prototype.updateIn=function e(){this._entity._getWorldPosAndRot(a_,o_);this.position.copy(a_);if(!this.fixedRotation){this.quaternion.copy(o_)}};e.prototype.updateOut=function e(){this._entity.setWorldPos(this.position);if(!this.fixedRotation){this._entity.setWorldRot(this.quaternion)}};return e}(i_.Body);var u_=function(e){function t(){e.call(this);this.gravity.set(0,-9.82,0)}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.setGravity=function e(t,n,r){this.gravity.set(t,n,r)};t.prototype.add=function e(t){this.addBody(t.body)};t.prototype.remove=function e(t){this.removeBody(t.body)};return t}(i_.World);var h_={ENGINE_BUILTIN:0,ENGINE_CANNON:1};var c_=function(e){function t(){e.call(this);this._fullSimulation=false;this._engine=h_.ENGINE_CANNON;this.fixedTimeStep=1/60}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;var n={engine:{configurable:true}};t.prototype.init=function e(){switch(this._engine){case h_.ENGINE_BUILTIN:this.ctorWorld=t_;this.ctorBody=$m;break;case h_.ENGINE_CANNON:this.ctorWorld=u_;this.ctorBody=l_;break}this.world=new this.ctorWorld};n.engine.set=function(e){this._engine=e;this.init()};t.prototype.add=function e(t){t.body=new this.ctorBody(t);this.world.add(t)};t.prototype.remove=function e(t){this.world.remove(t)};t.prototype.postTick=function e(){if(!this._fullSimulation){return}this.world.step(this.fixedTimeStep)};Object.defineProperties(t.prototype,n);return t}(oa);Object.assign(c_,h_);var f_=function(n){function e(e,t){n.call(this,e,t);this.reset()}if(n)e.__proto__=n;e.prototype=Object.create(n&&n.prototype);e.prototype.constructor=e;e.prototype.reset=function e(){this._stopped=false;this.target=null;this.bubbles=false;this.dx=0;this.dy=0;this.mouseX=0;this.mouseY=0;this.button=0;this.buttons=0};return e}(qi);var p_=function(n){function e(e,t){n.call(this,e,t);this.reset()}if(n)e.__proto__=n;e.prototype=Object.create(n&&n.prototype);e.prototype.constructor=e;e.prototype.reset=function e(){this._stopped=false;this.target=null;this.bubbles=false;this.key=""};return e}(qi);var d_=function(n){function e(e,t){n.call(this,e,t);this.reset()}if(n)e.__proto__=n;e.prototype=Object.create(n&&n.prototype);e.prototype.constructor=e;e.prototype.reset=function e(){this._stopped=false;this.target=null;this.bubbles=false;this.dx=0;this.dy=0;this.x=0;this.y=0};return e}(qi);var v_=function(n){function e(e,t){n.call(this,e,t);this.reset()}if(n)e.__proto__=n;e.prototype=Object.create(n&&n.prototype);e.prototype.constructor=e;e.prototype.reset=function e(){this._stopped=false;this.target=null;this.bubbles=false;this.relatedTarget=null};return e}(qi);var m_=8;function __(e,t,n,r,i,a,o,s,l){var u=e.effectInst.getTechnique("ui");for(var h=0;h<u.passes.length;++h){var c=u.passes[h];c.setStencilFront(t,n,r,i,a,o,s,l);c.setStencilBack(t,n,r,i,a,o,s,l)}}var g_=function e(t){this._app=t;this._screen=null;this._curMaterail=null;this._curTexture=null;this._curSpriteBatch=null;this._curStencilLevel=0;this._curUserKey=0;this._dummyNode=new Cr;this._materialPool=new pr(function(){return new gs},100);this._spriteBatchModelPool=new pr(function(){return new Ni.SpriteBatchModel},100)};g_.prototype.reset=function e(){var t=this;for(var n=0;n<this._spriteBatchModelPool.length;++n){var r=t._spriteBatchModelPool.data[n];r.clear();t._app.scene.removeModel(r)}this._materialPool.reset();this._spriteBatchModelPool.reset()};g_.prototype.resetScreen=function e(t){this._screen=t;this._curMaterail=null;this._curTexture=null;this._curSpriteBatch=null;this._curStencilLevel=0;this._curUserKey=0};g_.prototype._stencilWriteMask=function e(){return 1<<this._curStencilLevel-1};g_.prototype._stencilRef=function e(){var t=0;for(var n=0;n<this._curStencilLevel;++n){t+=1<<n}return t};g_.prototype._cloneMaterial=function e(t){var n=this._materialPool.add();n.copy(t);return n};g_.prototype._getSpriteBatchModel=function e(t,n){if(this._curSpriteBatch!==null&&this._curMaterail===t&&this._curTexture===n){return this._curSpriteBatch}var r=this._cloneMaterial(t);r.setProperty("mainTexture",n);if(this._curStencilLevel!==0){var i=this._stencilRef();__(r,true,Ae.DS_FUNC_EQUAL,i,i,Ae.STENCIL_OP_KEEP,Ae.STENCIL_OP_KEEP,Ae.STENCIL_OP_KEEP,0)}else{__(r,false,Ae.DS_FUNC_ALWAYS,0,0,Ae.STENCIL_OP_KEEP,Ae.STENCIL_OP_KEEP,Ae.STENCIL_OP_KEEP,0)}var a=this._spriteBatchModelPool.add();a.setNode(this._dummyNode);a.setEffect(r.effectInst);a._viewID=this._screen._view._id;a.setUserKey(this._curUserKey++);this._app.scene.addModel(a);this._curMaterail=t;this._curTexture=n;this._curSpriteBatch=a;return a};g_.prototype.addImage=function e(t){var n=t.widget._rect;var r=t.calcVertexData(n.x,n.y,n.w,n.h);var i=t.sprite;if(t.sprite===null){i=this._app.assets.get("default-sprite")}var a=this._getSpriteBatchModel(t.material,i.texture);a.addSprite(r.wposList,r.uvs,r.color,r.indices)};g_.prototype.addText=function e(t){var n=t.widget._rect;var r=t.calcVertexData(n.x,n.y,n.w,n.h);var i=t.font===null?t.fontTexture:t.font.texture;var a=this._getSpriteBatchModel(t.material,i);a.addSprite(r.wposList,r.uvs,r.color,r.indices)};g_.prototype.pushMask=function e(t){if(this._curStencilLevel+1>m_){console.error("Stencil level exceeed, we only support "+m_+" level in this device.");return}this._curStencilLevel++;var n=t.widget._rect;var r=t.calcVertexData(n.x,n.y,n.w,n.h);this._curSpriteBatch=null;var i=t.sprite;if(t.sprite===null){i=this._app.assets.get("default-sprite")}var a=this._cloneMaterial(t.material);a.setProperty("mainTexture",i.texture);var o=this._stencilRef();var s=this._stencilWriteMask();__(a,true,Ae.DS_FUNC_NEVER,o,s,Ae.STENCIL_OP_REPLACE,Ae.STENCIL_OP_KEEP,Ae.STENCIL_OP_KEEP,s);var l=this._spriteBatchModelPool.add();l.setNode(this._dummyNode);l.setEffect(a.effectInst);l._viewID=this._screen._view._id;l.setUserKey(this._curUserKey++);l.addSprite(r.wposList,r.uvs,r.color,r.indices);this._app.scene.addModel(l)};g_.prototype.popMask=function e(t){if(this._curStencilLevel-1<0){console.error("popMask being called more than once");return}this._curSpriteBatch=null;var n=t.widget._rect;var r=t.calcVertexData(n.x,n.y,n.w,n.h);var i=t.sprite;if(t.sprite===null){i=this._app.assets.get("default-sprite")}var a=this._cloneMaterial(t.material);a.setProperty("mainTexture",i.texture);var o=this._stencilWriteMask();__(a,true,Ae.DS_FUNC_NEVER,0,o,Ae.STENCIL_OP_REPLACE,Ae.STENCIL_OP_KEEP,Ae.STENCIL_OP_KEEP,o);var s=this._spriteBatchModelPool.add();s.setNode(this._dummyNode);s.setEffect(a.effectInst);s._viewID=this._screen._view._id;s.setUserKey(this._curUserKey++);s.addSprite(r.wposList,r.uvs,r.color,r.indices);this._app.scene.addModel(s);this._curStencilLevel--};var y_=new lr(100);var x_=["left","middle","right"];var b_=function(){var h=Lt.zero();var c=Lt.zero();var f=Lt.zero();var p=Lt.zero();var d=Lt.zero();var v=Lt.zero();return function(e,t,n,r){Lt.set(h,n,r,1);Lt.set(c,n,r,-1);for(var i=t.length-1;i>=0;--i){var a=t.data[i];var o=a.getComp("Widget");o.getWorldCorners(f,p,d,v);if(ln.line_quad(h,c,f,p,d,v)){var s=a.parent;var l=s.getComp("Widget");var u=false;while(l){if(s.getComp("Mask")){l.getWorldCorners(f,p,d,v);if(ln.line_quad(h,c,f,p,d,v)===false){u=true}}s=s.parent;l=s.getComp("Widget")}if(u){continue}return a}}return null}}();var w_=function(e){function t(){e.call(this);this._screens=[];this._screenRenderHelper=null;this._hoveringEntity=null;this._focusedEntity=null;this._capturingEntities=[];this._mouseEventPool=new pr(function(){return new f_("unknown")},8);this._keyboardEventPool=new pr(function(){return new p_("unknown")},8);this._touchEventPool=new pr(function(){return new d_("unknown")},8);this._focusEventPool=new pr(function(){return new v_("unknown")},8)}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;var n={hoveringEntity:{configurable:true},focusedEntity:{configurable:true}};n.hoveringEntity.get=function(){return this._hoveringEntity};n.focusedEntity.get=function(){return this._focusedEntity};t.prototype.init=function e(){this._screenRenderHelper=new g_(this._app)};t.prototype.addScreen=function e(t){this._screens.push(t);this._app.scene.addView(t._view)};t.prototype.removeScreen=function e(t){var n=this._screens.indexOf(t);if(n!==-1){this._screens.splice(n,1);this._app.scene.removeView(t._view)}};t.prototype.tick=function e(){var t=this;this._mouseEventPool.reset();this._keyboardEventPool.reset();this._touchEventPool.reset();this._focusEventPool.reset();this._screenRenderHelper.reset();y_.reset();for(var n=0;n<this._screens.length;++n){var r=t._screens[n];if(!r.enabled){continue}var i=false;var a=r._entity.parent;while(a){if(a.getComp("Screen")){i=true;break}a=a.parent}if(i){continue}y_.push(r._entity);kr.walkSibling(r._entity,function(e){if(e.active===true){y_.push(e);return true}else{return false}})}this._processInputs(y_);this._processLayout(y_);this._renderScreens()};t.prototype._processInputs=function e(t){var r=this;var n=this._app.input;var i=null;var a=null;if(n.hasTouch){for(var o=0;o<n.touchCount;++o){var s=n.getTouchInfo(o);a=b_(screen,t,s.x,s.y);i=r._capturingEntities[o]?r._capturingEntities[o]:a;if(i===null){continue}var l=r._touchEventPool.add();l.reset();l.id=s.id;l.dx=s.dx;l.dy=s.dy;l.x=s.x;l.y=s.y;l.target=i;if(s.phase==="start"){if(o===0){r._focus(i)}l.name="touchstart";l.bubbles=true;i.dispatch(l);r._capturingEntities[o]=i;if(o===0){r._hover(a,true)}}else if(s.phase==="pressing"){if(s.dx!==0||s.dy!==0){if(o===0){r._hover(a,true)}l.name="touchmove";l.bubbles=true;i.dispatch(l)}}else if(s.phase==="end"){if(o===0){r._hover(null,true)}l.name="touchend";l.bubbles=true;i.dispatch(l);r._capturingEntities[o]=null}else if(s.phase==="cancel"){if(o===0){r._hover(null,true)}l.name="touchcancel";l.bubbles=true;i.dispatch(l);r._capturingEntities[o]=null}}return}var u=n.hasMouseDown;var h=n.hasMouseUp;var c=n.mouseDeltaX!==0||n.mouseDeltaY!==0;if(c||u||h){a=b_(screen,t,n.mouseX,n.mouseY);i=this._capturingEntities[0]?this._capturingEntities[0]:a}if(u){this._focus(i);this._capturingEntities[0]=i}if(i){if(u){for(var f=0;f<x_.length;++f){var p=x_[f];if(n.mousedown(p)){var d=r._mouseEventPool.add();d.reset();d.name="mousedown";d.bubbles=true;d.dx=n.mouseDeltaX;d.dy=n.mouseDeltaY;d.mouseX=n.mouseX;d.mouseY=n.mouseY;d.target=i;d.button=p;d.buttons=n.mouseButtons;i.dispatch(d)}}}if(h){for(var v=0;v<x_.length;++v){var m=x_[v];if(n.mouseup(m)){var _=r._mouseEventPool.add();_.reset();_.name="mouseup";_.bubbles=true;_.dx=n.mouseDeltaX;_.dy=n.mouseDeltaY;_.mouseX=n.mouseX;_.mouseY=n.mouseY;_.target=i;_.button=m;_.buttons=n.mouseButtons;i.dispatch(_)}}this._capturingEntities[0]=null}}if(c){this._hover(a,false);if(i){var g=this._mouseEventPool.add();g.reset();g.name="mousemove";g.bubbles=true;g.dx=n.mouseDeltaX;g.dy=n.mouseDeltaY;g.mouseX=n.mouseX;g.mouseY=n.mouseY;g.target=i;g.button=0;g.buttons=n.mouseButtons;i.dispatch(g)}}if(this._focusedEntity){n._keys.forEach(function(e){if(e.state==="down"){var t=r._keyboardEventPool.add();t.reset();t.name="keydown";t.bubbles=true;t.key=e.key;t.target=r._focusedEntity;r._focusedEntity.dispatch(t)}if(e.state==="up"){var n=r._keyboardEventPool.add();n.reset();n.name="keyup";n.bubbles=true;n.key=e.key;n.target=r._focusedEntity;r._focusedEntity.dispatch(n)}})}};t.prototype._focus=function e(t){var n=t;if(n&&n._destroyed){n=null}var r=n?n.getComp("Widget"):null;while(r){if(r.focusable){break}n=n.parent;r=n.getComp("Widget")}if(this._focusedEntity===n){return}var i=this._focusedEntity;this._focusedEntity=n;if(i){var a=this._focusEventPool.add();a.reset();a.name="blur";a.bubbles=false;a.target=i;a.relatedTarget=n;i.dispatch(a)}if(n){var o=this._focusEventPool.add();o.reset();o.name="focus";o.bubbles=false;o.target=n;o.relatedTarget=i;n.dispatch(o)}};t.prototype._hover=function e(t,n){var r=this;if(this._hoveringEntity===t){return}var i=this._app.input;var a=this._hoveringEntity;this._hoveringEntity=t;var o=[];var s=[];var l=a;if(l&&l._destroyed){l=null}var u=l?l.getComp("Widget"):null;while(u){o.push(l);l=l.parent;u=l.getComp("Widget")}l=t;u=l?l.getComp("Widget"):null;while(u){s.push(l);l=l.parent;u=l.getComp("Widget")}var h=o.length;var c=s.length;var f=false;for(var p=0;p<o.length;++p){var d=o[p];for(var v=0;v<s.length;++v){var m=s[p];if(m===d){h=p;c=v;f=true}}if(f){break}}if(!n){for(var _=0;_<h;++_){var g=o[_];var y=r._mouseEventPool.add();y.reset();y.name="mouseleave";y.bubbles=false;y.dx=i.mouseDeltaX;y.dy=i.mouseDeltaY;y.mouseX=i.mouseX;y.mouseY=i.mouseY;y.target=g;y.button=0;y.buttons=i.mouseButtons;g.emit("mouseleave",y)}for(var x=c-1;x>=0;--x){var b=s[x];var w=r._mouseEventPool.add();w.reset();w.name="mouseenter";w.bubbles=false;w.dx=i.mouseDeltaX;w.dy=i.mouseDeltaY;w.mouseX=i.mouseX;w.mouseY=i.mouseY;w.target=b;w.button=0;w.buttons=i.mouseButtons;b.emit("mouseenter",w)}}else{var E=i.getTouchInfo(0);for(var T=0;T<h;++T){var S=o[T];var A=r._touchEventPool.add();A.reset();A.name="touchleave";A.bubbles=false;A.id=E.id;A.dx=E.dx;A.dy=E.dy;A.x=E.x;A.y=E.y;A.target=S;S.emit("touchleave",A)}for(var M=c-1;M>=0;--M){var R=s[M];var L=r._touchEventPool.add();L.reset();L.name="touchenter";L.bubbles=false;L.id=E.id;L.dx=E.dx;L.dy=E.dy;L.x=E.x;L.y=E.y;L.target=R;R.emit("touchenter",L)}}};t.prototype._processLayout=function e(t){var n=this;for(var r=0;r<t.length;++r){var i=t.data[r];var a=i.getComp("Widget");var o=i.parent;var s=o.getComp("Widget");var l=0,u=0;var h=0,c=0;if(s===null){var f=i.getComp("Screen");var p=f?f.scaleFactor:1;l=0;u=0;h=n._app._canvas.width/p;c=n._app._canvas.height/p;a.setOffset(0,0);a.setAnchors(0,0,0,0);a.setSize(h,c);a.setPivot(0,0)}else{l=s._rect.x;u=s._rect.y;h=s._rect.w;c=s._rect.h}a.calculate(l,u,h,c)}};t.prototype._renderScreens=function e(){var i=this;for(var t=0;t<this._screens.length;++t){var n=i._screens[t];if(!n.enabled){continue}var r=n._view;var a=i._app._canvas.width;var o=i._app._canvas.height;Bt.ortho(r._matProj,0,a,0,o,-100,100);Bt.copy(r._matViewProj,r._matProj);Bt.invert(r._matInvViewProj,r._matProj);r._rect.x=r._rect.y=0;r._rect.w=a;r._rect.h=o;i._screenRenderHelper.resetScreen(n);kr.walk2(n._entity,function(e){var t=e.getComp("Mask");if(t&&t.enabled){i._screenRenderHelper.pushMask(t)}var n=e.getComp("Image");if(n&&n.enabled){i._screenRenderHelper.addImage(n)}var r=e.getComp("Text");if(r&&r.enabled){i._screenRenderHelper.addText(r)}},function(e){var t=e.getComp("Mask");if(t&&t.enabled){i._screenRenderHelper.popMask(t)}})}};Object.defineProperties(t.prototype,n);return t}(oa);var E_=function(e){function t(){e.call(this);this._particleSystems=new lr(10)}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.add=function e(t){this._particleSystems.push(t)};t.prototype.remove=function e(t){this._particleSystems.fastRemove(this._particleSystems.indexOf(t))};t.prototype.tick=function e(){var t=this;for(var n=0;n<this._particleSystems.length;++n){var r=t._particleSystems.data[n];r.tick(t._app.deltaTime)}};return t}(oa);function T_(e){return e.replace(/\\/g,"/").replace(/[\/]+/g,"/").replace(/\/\?/g,"?").replace(/\/\#/g,"#").replace(/\:\//g,"://")}var S_={normalize:function e(t){return T_(t)},join:function e(){var t=[].slice.call(arguments,0).join("/");return T_(t)}};function A_(){var e={};e.isBrowser=n();e.supportWebGL=r();e.isMobile=a();var t=o();e.browserType=t.browserType;e.browserVersion=t.browserVersion;return e;function n(){return typeof window==="object"&&typeof document==="object"}function i(){if(n()){return document.createElement("canvas")}else{return null}}function r(){var e=i();if(e===null){return false}else{var t=["webgl","experimental-webgl"];var n=false;for(var r=0;r<t.length;++r){if(e.getContext(t[r])){return true}}return n}}function a(){if(!n()){return false}else{var e=window.navigator;var t=e.userAgent.toLowerCase();return/mobile|android|iphone|ipad/.test(t)}}function o(){if(typeof window==="object"){var e=window.navigator;var t=e.userAgent.toLowerCase();var n=/mqqbrowser|micromessenger|qq|sogou|qzone|liebao|maxthon|ucbs|360 aphone|360browser|baiduboxapp|baidubrowser|maxthon|mxbrowser|miuibrowser/i;var r=/qqbrowser|ucbrowser/i;var i=/chrome|safari|firefox|trident|opera|opr\/|oupeng/i;var a=/(mqqbrowser|micromessenger|qq|sogou|qzone|liebao|maxthon|uc|ucbs|360 aphone|360|baiduboxapp|baidu|maxthon|mxbrowser|miui)(mobile)?(browser)?\/?([\d.]+)/i;var o=/(qqbrowser|chrome|safari|firefox|trident|opera|opr\/|oupeng)(mobile)?(browser)?\/?([\d.]+)/i;var s=t.match(a);if(!s){s=t.match(o)}var l=s?s[4]:"";var u=n.exec(t);if(!u){u=r.exec(t)}if(!u){u=i.exec(t)}var h=u?u[0].toLowerCase():_a.BROWSER_TYPE_UNKNOWN;if(h==="micromessenger"){h=_a.BROWSER_TYPE_WECHAT}else if(h==="qq"&&t.match(/android.*applewebkit/i)){h=_a.BROWSER_TYPE_ANDROID}else if(h==="trident"){h=_a.BROWSER_TYPE_IE}else if(h==="360 aphone"){h=_a.BROWSER_TYPE_360}else if(h==="mxbrowser"){h=_a.BROWSER_TYPE_MAXTHON}else if(h==="opr/"){h=_a.BROWSER_TYPE_OPERA}else{h=_a.BROWSER_TYPE_UNKNOWN}return{browserType:h,browserVersion:l}}else{var c=_a.BROWSER_TYPE_UNKNOWN;var f="";return{browserType:c,browserVersion:f}}}}var M_=A_();var R_={isBrowser:M_.isBrowser,supportWebGL:M_.supportWebGL,isMobile:M_.isMobile,browserType:M_.browserType,browserVersion:M_.browserVersion};var L_=0;var C_=90;var O_=function e(t,n){var r=this;this._app=t;this._canvas=n;this._container=document.createElement("div");if(this._canvas.parentNode){this._canvas.parentNode.insertBefore(this._container,this._canvas)}this._container.setAttribute("id","cocos3dContainer");this._container.appendChild(this._canvas);this._container.style.height="100%";this._orientation=_a.ORIENTATION_AUTO;this._webOrientationRotate=L_;this._isRotate=false;this._resizeFunc=function(){r.resize()};window.addEventListener("resize",this._resizeFunc)};var I_={canvas:{configurable:true},canvasContainer:{configurable:true}};I_.canvas.get=function(){return this._canvas};I_.canvasContainer.get=function(){return this._container};O_.prototype.resize=function e(){var t=[0,0];var n=Rt.new(300,150);var r=this._container.parentElement.getBoundingClientRect();Rt.set(n,r.width,r.height);if(!n||n.x<=0||n.y<=0){return}var i=n.x;var a=n.y;var o=i>=a;var s=this._container.style;if(!R_.isMobile||o&&this._orientation&_a.ORIENTATION_LANDSCAPE||!o&&this._orientation&_a.ORIENTATION_PORTRAIT){t[0]=i;t[1]=a;s["-webkit-transform"]="rotate(0deg)";s.transform="rotate(0deg)";s.margin="0px";this._webOrientationRotate=L_}else{t[0]=a;t[1]=i;s["-webkit-transform"]="rotate(90deg)";s.transform="rotate(90deg)";s["-webkit-transform-origin"]="0px 0px 0px";s.transformOrigin="0px 0px 0px";var l=t[1];s.margin="0 0 0 "+l+"px";this._webOrientationRotate=C_}this._canvas.width=t[0];this._canvas.height=t[1];this._bcr=this._canvas.getBoundingClientRect()};O_.prototype.destroy=function e(){window.removeEventListener("resize",this._resizeFunc)};O_.prototype.setOrientation=function e(t){t=t&_a.ORIENTATION_AUTO;if(t&&this._orientation!==t){this._orientation=t;this.resize()}};O_.prototype._calcOffsetX=function e(t,n){var r=this._container.style.transform;var i=r&&r.match(/[\-|\d]\d{1,}/);if(i===null||i===undefined){i="0"}else{i=i.join("")}var a=t-this._bcr.left;if(i==="90"){a=n-this._bcr.top}else if(i==="-90"){a=this._bcr.height-(n-this._bcr.top)}else if(i==="180"){a=this._bcr.width-(t-this._bcr.left)}return a};O_.prototype._calcOffsetY=function e(t,n){var r=this._container.style.transform;var i=r&&r.match(/[\-|\d]\d{1,}/);if(i===null||i===undefined){i="0"}else{i=i.join("")}if(this._app._input._invertY){var a=this._bcr.height-(n-this._bcr.top);if(i==="90"){a=t-this._bcr.left}else if(i==="-90"){a=this._bcr.width-(t-this._bcr.left)}else if(i==="180"){a=n-this._bcr.top}return a}else{var o=n-this._bcr.top;if(i==="90"){o=this._bcr.width-(t-this._bcr.left)}else if(i==="-90"){o=t-this._bcr.width}else if(i==="180"){o=this._bcr.height-(n-this._bcr.top)}return o}};Object.defineProperties(O_.prototype,I_);Ea.registerLoader("mesh",js);Ea.registerLoader("material",qs);Ea.registerLoader("texture",Qs);Ea.registerLoader("prefab",$s);Ea.registerLoader("gltf",tl);Ea.registerLoader("animation",nl);Ea.registerLoader("audio",ol);Ea.registerLoader("bmfont",fl);Ea.registerLoader("otfont",Wd);Ea.registerLoader("effect",qd);Ea.registerLoader("program",Zd);for(var U_ in Cs){Ea.registerType(U_,Cs[U_])}Ea.registerClass("Script",Qd);Ea.registerClass("Camera",Jd);Ea.registerClass("Light",$d);Ea.registerClass("Model",ev);Ea.registerClass("SkinningModel",nv);Ea.registerClass("Animation",av);Ea.registerClass("AudioSource",cv);Ea.registerClass("Collider",pv);Ea.registerClass("Skybox",dv);Ea.registerClass("Screen",im);Ea.registerClass("ScreenScaler",am);Ea.registerClass("Widget",sm);Ea.registerClass("Mask",Um);Ea.registerClass("Image",wm);Ea.registerClass("Text",Cm);Ea.registerClass("UIElement",rm);Ea.registerClass("Button",Bm);Ea.registerClass("Toggle",Dm);Ea.registerClass("ToggleGroup",Fm);Ea.registerClass("Slider",zm);Ea.registerClass("EditBox",Nm);Ea.registerClass("ScrollBar",km);Ea.registerClass("ScrollView",Gm);Ea.registerClass("GridLayout",Hm);Ea.registerClass("ParticleSystem",nm);Ea.registerSystem("script",jm,"Script",0);Ea.registerSystem("skinning-model",qm,"SkinningModel",100);Ea.registerSystem("animation",Xm,"Animation",200);Ea.registerSystem("audio",Ym,"AudioSource",200);Ea.registerSystem("physics",c_,"Collider",200);Ea.registerSystem("widget",w_,"Widget",100);Ea.registerSystem("ui-element",Pm,"UIElement",101);Ea.registerSystem("particle-system",E_,"ParticleSystem",100);Ea.registerClass("Keyframe",yn);Ea.registerClass("AnimationCurve",wn);function P_(e){var t=e;return function(e){t._tickID=requestAnimationFrame(t._tick);if(e===undefined){e=0}t.deltaTime=(e-t._lasttime)/1e3;t.totalTime=e/1e3;t._lasttime=e;t._debugger.tick();t.emit("tick");t.tick();t._debugger.postTick();t._forward.render(t.scene);t._input.reset();t._scene.reset()}}var B_=function(o){function e(e,t){var n=this;if(t===void 0)t={};o.call(this,{poolSize:t.poolSize||100});this.__initEventEmitter();this._view=new O_(this,e);this._canvas=e;this._input=new Hi(this._view,{lock:false,invertY:true});this._device=new Ae.Device(e,t);var r=Ls(this._device);Ni.addStage("opaque");Ni.addStage("transparent");Ni.addStage("ui");Ni.addStage("shadowcast");this._forward=new Ni.ForwardRenderer(this._device,{defaultTexture:r["default-texture"]._texture,defaultTextureCube:r["default-texture-cube"]._texture});this._scene=new Ni.Scene;this._assetMng=new lo(this);this._debugger=new ms(this);this._configuration=new ga(this);for(var i in r){var a=r[i];n._assetMng.add(a._uuid,a)}Ea._init(this);this._sortSystems();this._tick=P_(this);this.deltaTime=0;this.totalTime=0;this._tickID=null;this._lasttime=0;this._activeCamera=null;this._view.resize()}if(o)e.__proto__=o;e.prototype=Object.create(o&&o.prototype);e.prototype.constructor=e;var t={device:{configurable:true},scene:{configurable:true},input:{configurable:true},assets:{configurable:true},debugger:{configurable:true},configuration:{configurable:true},view:{configurable:true}};t.device.get=function(){return this._device};t.scene.get=function(){return this._scene};t.input.get=function(){return this._input};t.assets.get=function(){return this._assetMng};t.debugger.get=function(){return this._debugger};t.configuration.get=function(){return this._configuration};t.view.get=function(){return this._view};e.prototype.run=function e(){if(!this._activeLevel){console.warn("There is no level to run, please load it first");return}this._tickID=requestAnimationFrame(this._tick)};e.prototype.resize=function e(){};e.prototype.destroy=function e(){this._canvas=null;this._view.destroy();this._view=null;this._input.destroy();this._activeLevel.destroy();this._activeLevel=null;if(this._tickID){cancelAnimationFrame(this._tickID)}};e.prototype.find=function e(t,n){if(!t){return null}n=n||this._activeLevel;return kr.find(n,t)};e.prototype.loadGameConfig=function e(t,n){var r=this;var i=n.assets;var a=n.scenes;var o=n.entry;for(var s in i){var l=i[s];for(var u in l.urls){l.urls[u]=S_.join(t,l.urls[u])}r.assets.registerAsset(s,l)}for(var h in a){r.assets.registerLevel(h,S_.join(t,a[h]))}};Object.defineProperties(e.prototype,t);return e}(va);$i.mixin(B_);var D_={registerLoader:Ea.registerLoader,registerClass:Ea.registerClass,registerSystem:Ea.registerSystem,Node:Cr,Asset:Ba,Mesh:Fa,Joints:Ps,Material:gs,Prefab:Js,AnimationClip:Is,AudioClip:il,Gltf:el,Texture:za,Texture2D:ja,TextureCube:bs,Sprite:Ms,App:B_,Level:aa,System:oa,Component:ta,ScriptComponent:Qd,CameraComponent:Jd,LightComponent:$d,ModelComponent:ev,SkinningModelComponent:nv,AnimationComponent:av,AudioSourceComponent:cv,SkyboxComponent:dv,ParticleSystemComponent:nm,ScreenComponent:im,ScreenScalerComponent:am,WidgetComponent:sm,ImageComponent:wm,TextComponent:Cm,MaskComponent:Um,UIElementComponent:rm,ButtonComponent:Bm,ToggleComponent:Dm,ToggleGroupComponent:Fm,SliderComponent:zm,EditBoxComponent:Nm,ScrollBarComponent:km,BoundComponent:Vm,ScrollViewComponent:Gm,GridLayoutComponent:Hm,math:Nt,geometry:En,memop:wr,primitives:ss,renderer:Ni,gfx:Ae,utils:io,resl:Ua,path:S_,input:Hi,async:Xa,sys:R_};Object.assign(D_,_a);return D_}();
//# sourceMappingURL=engine.min.js.map