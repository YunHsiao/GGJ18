var gameJam=function(){"use strict";var t=window.cc;var i=t.math;var e=i.vec2;var s=i.vec3;var o=i.quat;var r=i.clamp;var h=i.randomRange;var n=function(t){return!Math.abs(t.x)&&!Math.abs(t.y)&&!Math.abs(t.z)};var a=function(t,i){if(i===void 0)i=1;var e=t.x,s=t.z,o=i/Math.sqrt(e*e+s*s);t.x*=o;t.y=0;t.z*=o};var p=function(i){function p(){i.call(this);this.id_forward=s.new(0,0,1);this.id_right=s.new(1,0,0);this.forward=s.new(0,0,1);this.right=s.new(1,0,0);this.euler=s.new(0,0,0);this.posOff=s.zero();this.rotOff=e.zero();this.speed=1;this.lastTime=0;this.id_up=s.new(0,this.speed,0)}if(i)p.__proto__=i;p.prototype=Object.create(i&&i.prototype);p.prototype.constructor=p;p.prototype.start=function i(){this.pos=this._entity.lpos;this.spawn=s.clone(this._entity.lpos);this.rot=this._entity.lrot;this.input=this._app._input;this.input._lock=t.input.LOCK_ALWAYS;this.footsteps=this._entity.getCompsInChildren("AudioSource");this.enableCollision=true;this.col=this._entity.getComp("Collider");if(!this.col){return}this.col.collider.setUpdateMode({in:true,out:true});this.col.collider.setFixedRotation(true);this.canvas=this._app._device._gl.canvas};p.prototype.tick=function t(){if(this.ended||!this.input._pointerLocked&&!this.input.touchCount&&!this.input.hasKeyDown){return}if(this.pos.y<-25){s.copy(this.pos,this.spawn)}a(s.transformQuat(this.forward,this.id_forward,this.rot),this.speed);a(s.transformQuat(this.right,this.id_right,this.rot),this.speed);s.set(this.posOff,0,0,0);e.set(this.rotOff,0,0);if(this.input.touchCount){this.tickTouch()}if(this.input._pointerLocked){this.tickMouse()}if(this.input.hasKeyDown){this.tickKeyboard()}s.set(this.euler,r(this.euler.x+this.rotOff.x,-90,90),this.euler.y+this.rotOff.y,0);o.fromEuler(this.rot,this.euler.x,this.euler.y,this.euler.z);if(n(this.posOff)){return}s.add(this.pos,this.pos,this.posOff);if(this._app.totalTime-this.lastTime>.5&&this.footsteps.length){this.lastTime=this._app.totalTime;this.footsteps[Math.floor(h(0,this.footsteps.length-.5))].play()}};p.prototype.tickMouse=function t(){this.rotOff.x=-this.input.mouseDeltaY;this.rotOff.y=-this.input.mouseDeltaX};p.prototype.tickKeyboard=function t(){if(this.input.keypress("w")){s.sub(this.posOff,this.posOff,this.forward)}if(this.input.keypress("s")){s.add(this.posOff,this.posOff,this.forward)}if(this.input.keypress("a")){s.sub(this.posOff,this.posOff,this.right)}if(this.input.keypress("d")){s.add(this.posOff,this.posOff,this.right)}if(this.input.keypress("q")){s.sub(this.posOff,this.posOff,this.id_up)}if(this.input.keypress("e")){s.add(this.posOff,this.posOff,this.id_up)}if(this.input.keydown("f")&&this.col){this.toggleCollision()}};p.prototype.tickTouch=function i(){var e=this;for(var o=0;o<this.input.touchCount;o++){var h=e.input.getTouchInfo(o);if(h.x>e.canvas.width*.4){e.rotOff.x=h.dy;e.rotOff.y=-h.dx}else{if(h._phase===t.input.TOUCH_START){h.initX=h.x;h.initY=h.y}s.scale(e.forward,e.forward,r((h.y-h.initY)*.01,-1,1));s.scale(e.right,e.right,r((h.x-h.initX)*.01,-1,1));s.sub(e.posOff,e.posOff,e.forward);s.add(e.posOff,e.posOff,e.right)}}};p.prototype.toggleCollision=function t(){this.enableCollision=!this.enableCollision;this.col.collider.setUpdateMode({in:true,out:this.enableCollision})};p.prototype.game_over=function t(){this.ended=true;this._entity.getComp("AudioSource").stop()};return p}(t.ScriptComponent);var l=window.cc;var c=l.math;var u=c.quat;var f=c.vec3;var d=c.color4;var y=l.geometry;var m=y.box;var _=y.intersect;var v=function(t){function i(){t.call(this);this.v3=f.zero();this.qt=u.create();this.v3_2=f.zero()}if(t)i.__proto__=t;i.prototype=Object.create(t&&t.prototype);i.prototype.constructor=i;i.prototype.start=function t(){this.model=this._entity.getComp("Model")._models[0];this.model._node._getWorldPRS(this.v3,this.qt,this.v3_2);m.setTransform(this.model._boundingBox,this.v3,this.qt,this.v3_2,this.model._bbModelSpace);this.mst=this.monster.getComp("game.Monster");this.color_after_life=d.new(.882,0,0,1);this.count=0};i.prototype.tick=function t(){var i=this;if(this.ended){return}if(_.box_point(this.model._boundingBox,this.player.lpos)){for(var e=0;e<this._app.scene._models.length;e++){i._app.scene._models.data[e]._effect.setProperty("color",i.color_after_life)}this.player.getComp("game.FPCamera").speed=this.mst.speed;this.ended=true;this._entity.getComp("AudioSource").play();l.game.over=true;setTimeout(function(){this.mst.disappear();f.set(this.monster.lpos,this.player.lpos.x,this.player.lpos.y+this.mst.pursuitDist-1,this.player.lpos.z)}.bind(this),5e3)}};return i}(l.ScriptComponent);v.schema={player:{type:"entity",default:null},monster:{type:"entity",default:null}};var g=window.cc;var b=g.math;var w=b.color4;var C=function(t){function i(){t.call(this)}if(t)i.__proto__=t;i.prototype=Object.create(t&&t.prototype);i.prototype.constructor=i;i.prototype.start=function t(){this.c=w.create();this.t1=this.logo.getComp("Image");this.t2=this.intro1.getComp("Image");this.t3=this.intro2.getComp("Image");this.t1.color=w.set(this.c,this.t1.color.r,this.t1.color.g,this.t1.color.b,0);this.t2.color=w.set(this.c,this.t2.color.r,this.t2.color.g,this.t2.color.b,0);this.t3.color=w.set(this.c,this.t3.color.r,this.t3.color.g,this.t3.color.b,0);this.a=0};i.prototype.tick=function t(){if(this.ended){return}if(this._app._input.keyup("Enter")||this._app._input.touchCount){this._end()}if(this.t1.color.a<1){this.t1.color=w.set(this.c,this.t1.color.r,this.t1.color.g,this.t1.color.b,this.t1.color.a+.01)}else if(this.t2.color.a<1){if(this.a<1){this.a+=.01;return}this.t2.color=w.set(this.c,this.t2.color.r,this.t2.color.g,this.t2.color.b,this.t2.color.a+.01)}else if(this.t3.color.a<1){if(this.a<2){this.a+=.01;return}this.t3.color=w.set(this.c,this.t3.color.r,this.t3.color.g,this.t3.color.b,this.t3.color.a+.01)}else{if(this.a<3){this.a+=.01;return}this._end()}};i.prototype._end=function t(){g.game.loadScene("main");this.ended=true};return i}(g.ScriptComponent);C.schema={logo:{type:"entity",default:null},intro1:{type:"entity",default:null},intro2:{type:"entity",default:null}};var k=window.cc;var x=k.math;var O=x.quat;var M=x.vec3;var P=x.randomRange;var S=k.geometry;var z=S.box;var I=S.intersect;var T=function(t){function i(){t.call(this);this.v3=M.zero();this.qt=O.create();this.v3_2=M.zero()}if(t)i.__proto__=t;i.prototype=Object.create(t&&t.prototype);i.prototype.constructor=i;i.prototype.start=function t(){var i=this;this.model=this._entity.getComp("Model")._models[0];this.gameMaze=this.maze.getComp("game.Maze");this.children=this._entity.getCompsInChildren("Model");this.rot=[];for(var e=0;e<this.children.length;e++){i.rot.push(P(-Math.PI/180,Math.PI/180));var s=new k.Material;s.effect=i._app.assets.get("builtin-effect-unlit-transparent");s.setProperty("mainTexture",i.children[e].material.effectInst.getProperty("diffuse_texture"));s.define("USE_TEXTURE",true);i.children[e].material=s}this.audios=this._entity.getCompsInChildren("AudioSource");this.audio=this._entity.getComp("AudioSource");this.dir=M.zero();this.up=M.new(0,1,0);this.keyPoints=[];this.keyPoints.push(M.new(0,10,144));this.keyPoints.push(M.new(0,10,79));this.keyPoints.push(M.new(-176,10,58));this.keyPoints.push(M.new(-182,10,202));this.keyPoints.push(M.new(-99,10,200));this.keyPoints.push(M.new(-99,-10,145));this.keyPoints.push(M.new(-99,-10,40));this.keyPoints.push(M.new(-220,-10,34));this.keyPoints.push(M.new(-220,-10,100));this.keyPoints.push(M.new(-157,-10,100));this.keyPoints.push(M.new(-103,10,100));this.keyPoints.push(M.new(0,10,50));this.moveIdx=0;this.speed=.3;this.pursuitDist=100;this.time=0;this.heartBeatInterval=1.5};i.prototype.tick=function t(){var i=this;if(this.ended){return}this.time+=this._app.deltaTime;this._entity._getWorldPRS(this.v3,this.qt,this.v3_2);z.setTransform(this.model._boundingBox,this.v3,this.qt,this.v3_2,this.model._bbModelSpace);if(I.box_point(this.model._boundingBox,this.player.lpos)){if(k.game.over){this.over.getComp("AudioSource").play();setTimeout(function(){k.game.loadScene("limbo");this.audio.stop()}.bind(this),1500)}else{k.game.loadScene("limbo");for(var e=0;e<this.audios.length;e++){i.audios[e].play()}setTimeout(function(){this.audio.stop()}.bind(this),5e3)}this.ended=true;this.player.getComp("game.FPCamera").game_over()}M.sub(this.dir,this.player.lpos,this._entity.lpos);if(M.mag(this.dir)>this.pursuitDist){M.sub(this.dir,this.keyPoints[this.moveIdx],this._entity.lpos);this.time=this.heartBeatInterval}else{this.heartBeat(1-M.mag(this.dir)/this.pursuitDist)}M.scale(this.dir,M.normalize(this.dir,this.dir),this.speed);M.add(this._entity.lpos,this._entity.lpos,this.dir);if(this.lessThan(this._entity.lpos,this.keyPoints[this.moveIdx],this.speed)){this.moveIdx=(this.moveIdx+1)%this.keyPoints.length}M.normalize(this.dir,this.dir);O.fromViewUp(this._entity.lrot,this.dir,this.up);for(var s=0;s<this.children.length;s++){O.rotateZ(i.children[s]._entity.lrot,i.children[s]._entity.lrot,i.rot[s])}};i.prototype.heartBeat=function t(i){var e=i*.8+.2;this.audio.volume=e;if(this.time<this.heartBeatInterval*(1-i*.666)){return}this.time=0;this.audio.stop();this.audio.play();this.gameMaze.heartBeat(e)};i.prototype.lessThan=function t(i,e,s){return Math.abs(i.x-e.x)<s&&Math.abs(i.y-e.y)<s&&Math.abs(i.z-e.z)<s};i.prototype.disappear=function t(){var i=this;for(var e=0;e<this.children.length;e++){i.children[e].onDisable()}};return i}(k.ScriptComponent);T.schema={player:{type:"entity",default:null},over:{type:"entity",default:null},maze:{type:"entity",default:null}};var j=window.cc;var q=function(t){function i(){t.call(this)}if(t)i.__proto__=t;i.prototype=Object.create(t&&t.prototype);i.prototype.constructor=i;i.prototype.start=function t(){this.counter=0};i.prototype.tick=function t(){if(this.ended){return}if(this._app._input.keyup("Enter")){this._end()}if(this.counter<6){this.counter+=.01}else{this._end()}};i.prototype._end=function t(){j.game.loadScene("logo");this.ended=true};return i}(j.ScriptComponent);var B=window.cc;var D=function(t){function i(){t.call(this)}if(t)i.__proto__=t;i.prototype=Object.create(t&&t.prototype);i.prototype.constructor=i;i.prototype.start=function t(){this._entity.getComp("Model").onDisable()};i.prototype.tick=function t(){if(this.ended){return}if(B.game.over){this._entity.getComp("Model").onEnable();this.ended=true}};return i}(B.ScriptComponent);var L=window.cc;var A=L.math;var E=A.vec2;var R=A.vec3;var U=A.color4;var K=function(t,i){t.x=i.x>0?i.x:1;t.y=i.y>0?i.y:1;t.z=i.z>0?i.z:1;return t};var F=function(t){function i(){t.call(this)}if(t)i.__proto__=t;i.prototype=Object.create(t&&t.prototype);i.prototype.constructor=i;i.prototype.start=function t(){var i=this;this.models=this._entity.getCompsInChildren("Model");this.time=0;this.borderMax=.05;this.border=E.new(this.borderMax,this.borderMax);this.color=U.create();this.intensity=1;if(!this._app._forward._programLib.hasProgram("binary")){var e={name:"binary",json:"./materials/binary.json",vert:"./materials/binary.vert",frag:"./materials/binary.frag"};this._app.assets.loadUrls("program",e)}var s={json:"./materials/BinaryEffect.json"};this._app.assets.loadUrls("effect",s,function(t,e){for(var s=0;s<i.models.length;s++){var o=new L.Material;o.effect=e;o.define("USE_COLOR",true);o.setProperty("border",i.border);i.models[s].material=o}});var o=R.zero();var r=this._entity.getCompsInChildren("Collider");for(var h=0;h<r.length;h++){r[h].size=K(o,r[h].size)}};i.prototype.setProperty=function t(i,e){var s=this;for(var o=0;o<this.models.length;o++){s.models[o].material.setProperty(i,e)}};i.prototype.tick=function t(){if(!this.models){return}this.time+=this._app.deltaTime*5;var i=this.time>Math.PI?1:Math.abs(Math.cos(this.time)*this.intensity+1-this.intensity);E.set(this.border,this.borderMax*i,this.borderMax*i);U.set(this.color,1,i,i);this.setProperty("border",this.border);this.setProperty("color",this.color)};i.prototype.heartBeat=function t(i){this.time=0;this.intensity=i};return i}(L.ScriptComponent);var X=window.cc;var Y="./assets";var G={"game.FPCamera":p,"game.Portal":v,"game.Logo":C,"game.Monster":T,"game.Limbo":q,"game.Hidden":D,"game.Maze":F};var W=function(t){function i(i,e){t.call(this,i,e);this.scenes={}}if(t)i.__proto__=t;i.prototype=Object.create(t&&t.prototype);i.prototype.constructor=i;i.prototype.init=function t(){var i=this;this.resize();for(var e in G){i.registerClass(e,G[e])}this.system("physics").world.setGravity(0,-500,0);this.system("physics").world.defaultContactMaterial.contactEquationRelaxation=2.2;X.resl({manifest:{gameInfo:{type:"text",parser:JSON.parse,src:Y+"/game.json"}},onDone:function t(i){X.game.loadGameConfig(Y,i.gameInfo);X.game.loadScene("logo");X.game.loadScene("main",true);X.game.loadScene("limbo",true)}})};i.prototype.loadScene=function t(i,e){var s=this;if(this.scenes[i]&&!e){this.loadLevel(this.scenes[i])}this.assets.loadLevel(i,function(t,o){if(t){console.error(t)}else{s.scenes[i]=o;if(!e){s.loadLevel(o)}}})};return i}(X.App);var H={Game:W};return H}();
//# sourceMappingURL=gameJam.min.js.map